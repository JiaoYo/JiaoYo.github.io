import{_ as oe}from"./table-header-operation.vue_vue_type_script_setup_true_lang-DblglBez.js";import{d as V,q as O,v as J,s as Q,o as G,c as X,w as n,g as e,h as P,t as M,i as s,$ as b,M as se,A as re,an as Y,E as Z,B as j,D as ee,ad as ae,r as E,x as ie,b as ue,y as me,C as de,a2 as pe,ae as ce,af as fe,a4 as ge,av as _e,aq as ve,L as K,K as H,e as be,ag as B,ah as he}from"./index-7Q9xZuwa.js";import{u as ye,a as we}from"./table-G6_8Abm0.js";import{_ as xe}from"./round-search-BQOA9W6m.js";import{_ as De}from"./round-refresh-DJiiF7wv.js";import{_ as Ne}from"./FormItemGridItem-DYTXkfwP.js";import{_ as ke}from"./Grid-CRtcNhSF.js";import{u as Se}from"./usePageData-PYHx9xl8.js";import{a as Te,b as Ce,c as ze,d as Ie,e as Pe}from"./events-C20QxbUR.js";import{f as Ue,a as $e}from"./common-DPaMBBEl.js";import{_ as Ae}from"./Cascader-B05gdiL9.js";import{h as W}from"./permission-BYoerBbx.js";import{_ as Le}from"./Popconfirm-BEMrdOuM.js";import{_ as Re}from"./DataTable-n3fP4Loy.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-D8fMBsYv.js";import"./setting-outlined-V9qGIWHT.js";import"./export-oh2-I3ZA.js";import"./refresh-av0Mcmzj.js";import"./round-delete-BZFRn3Yp.js";import"./round-plus-Cy8c1zzO.js";import"./Upload-CwzIyBrH.js";import"./Progress-DAZ1S5w7.js";import"./Forward-BzUEeUAa.js";const Fe=V({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:O(["reset","search"],["update:model"]),setup(y,{emit:U}){const i=U,{formRef:S,restoreValidation:w}=J(),t=Q(y,"model");function x(p){t.value.fuzzy=p.replace(/\s/g,"")}function z(p){return!p.startsWith(" ")&&!p.endsWith(" ")}function $(){t.value.fuzzy=null,i("search")}async function T(){await w(),i("reset")}async function l(){var p,u,D,g;if(t.value.mintime&&t.value.maxtime&&t.value.maxtime-t.value.mintime<0)return(p=window.$message)==null||p.destroyAll(),(u=window.$message)==null||u.error("最小限定时间不得大于最大限定时间"),!1;if(t.value.minagg&&t.value.maxagg&&t.value.maxagg-t.value.minagg<0)return(D=window.$message)==null||D.destroyAll(),(g=window.$message)==null||g.error("最小聚合次数不得大于最大聚合次数"),!1;i("search")}return(p,u)=>{const D=re,g=Ne,N=Y,c=Z,A=De,I=j,F=xe,L=ke,C=ee,R=ae;return G(),X(R,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[e(C,{ref_key:"formRef",ref:S,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:se(l,["enter"])},{default:n(()=>[e(L,{responsive:"screen","item-responsive":""},{default:n(()=>[e(g,{span:"24 s:12 m:6",label:"策略名称",path:"fuzzy",class:"pr-24px"},{default:n(()=>[e(D,{clearable:"",value:t.value.fuzzy,"onUpdate:value":u[0]||(u[0]=f=>t.value.fuzzy=f),placeholder:"请输入策略名称",onInput:x,"allow-input":z,onClear:$},null,8,["value"])]),_:1}),e(g,{span:"24 s:12 m:7",label:"最大限定时间",class:"pr-24px"},{default:n(()=>[e(c,{wrap:!1,align:"center"},{default:n(()=>[e(N,{value:t.value.mintime,"onUpdate:value":u[1]||(u[1]=f=>t.value.mintime=f),min:0,placeholder:"最小限定时间"},null,8,["value"]),P(" — "),e(N,{value:t.value.maxtime,"onUpdate:value":u[2]||(u[2]=f=>t.value.maxtime=f),min:0,placeholder:"最大限定时间"},null,8,["value"])]),_:1})]),_:1}),e(g,{span:"24 s:12 m:7",label:"最大聚合次数",class:"pr-24px"},{default:n(()=>[e(c,{wrap:!1,align:"center"},{default:n(()=>[e(N,{value:t.value.minagg,"onUpdate:value":u[3]||(u[3]=f=>t.value.minagg=f),min:0,placeholder:"最小聚合次数"},null,8,["value"]),P(" — "),e(N,{value:t.value.maxagg,"onUpdate:value":u[4]||(u[4]=f=>t.value.maxagg=f),min:0,placeholder:"最大聚合次数"},null,8,["value"])]),_:1})]),_:1}),e(g,{span:"24 m:4",class:"pr-24px"},{default:n(()=>[e(c,{class:"w-full"},{default:n(()=>[e(I,{onClick:T},{icon:n(()=>[e(A,{class:"text-icon"})]),default:n(()=>[P(" "+M(s(b)("common.reset")),1)]),_:1}),e(I,{type:"primary",ghost:"",onClick:l},{icon:n(()=>[e(F,{class:"text-icon"})]),default:n(()=>[P(" "+M(s(b)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Be=V({name:"OperateDrawer",__name:"operate-drawer",props:O({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:O(["submitted"],["update:visible"]),setup(y,{emit:U}){const i=y,S=U,w=E({eventsTypeDataList:[]}),t=Q(y,"visible"),{formRef:x,validate:z,restoreValidation:$}=J();ie();const T=ue(()=>({add:"新增聚合策略",edit:"修改聚合策略"})[i.operateType]),l=E(p());function p(){return{etid:null,mrules:null,maxtime:86400,maxagg:2e4,forward:null,sysparam:0}}const u={etid:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},mrules:{type:"array",required:!0,trigger:["blur","change"],message:"不能为空"},maxtime:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},maxagg:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"}};async function D(){const{data:d,error:a}=await Ue();a||(w.eventsTypeDataList=d,g())}async function g(){const{data:d,error:a}=await $e();a||w.eventsTypeDataList.forEach(o=>{o.children=d.filter(r=>r.pid===o.id)})}const N=E({data:[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}]}),{pageData:c,getData:A,nextPage:I}=Se(Te),F=async d=>{const a=d.currentTarget;a.scrollTop+a.offsetHeight>=a.scrollHeight&&c.data.length<c.total&&I()};function L(){D(),A(),Object.assign(l,p()),i.operateType==="edit"&&i.rowData&&(i.rowData.mrules=i.rowData.mrules?i.rowData.mrules.split(",").map(Number):[],i.rowData.forward=i.rowData.forward?i.rowData.forward.split(",").map(Number):[],Object.assign(l,i.rowData))}function C(){t.value=!1}async function R(){var d,a,o,r,_,h;if(await z(),i.operateType==="add"){const{data:m,error:k}=await Ce([{etid:l.etid,mrules:(d=l.mrules)==null?void 0:d.join(","),maxtime:l.maxtime,maxagg:l.maxagg,forward:(a=l.forward)==null?void 0:a.join(",")}]);k||((o=window.$message)==null||o.success(b("common.addSuccess")),C(),S("submitted"))}else{const{data:m,error:k}=await ze([{id:i.rowData.id,etid:l.etid,mrules:(r=l.mrules)==null?void 0:r.join(","),maxtime:l.maxtime,maxagg:l.maxagg,forward:(_=l.forward)==null?void 0:_.join(",")}]);k||((h=window.$message)==null||h.success(b("common.updateSuccess")),C(),S("submitted"))}}const f=d=>d.ipaddr+":"+d.fport+" ("+(d.ftype==0?"syslog":"SNMP Trap")+")";return me(t,()=>{t.value&&(L(),$())}),(d,a)=>{const o=Ae,r=de,_=pe,h=Y,m=ee,k=j,te=Z,le=ce,ne=fe;return G(),X(ne,{show:t.value,"onUpdate:show":a[5]||(a[5]=v=>t.value=v),"display-directive":"show",width:450},{default:n(()=>[e(le,{title:T.value,"native-scrollbar":!1,closable:""},{footer:n(()=>[e(te,{size:16},{default:n(()=>[e(k,{onClick:C},{default:n(()=>[P(M(s(b)("common.cancel")),1)]),_:1}),e(k,{type:"primary",onClick:R},{default:n(()=>[P(M(s(b)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[e(m,{ref_key:"formRef",ref:x,model:l,rules:u},{default:n(()=>[e(r,{label:"策略名称",path:"etid"},{default:n(()=>[e(o,{value:l.etid,"onUpdate:value":a[0]||(a[0]=v=>l.etid=v),clearable:"","check-strategy":"child",placeholder:"请选择策略名称",options:w.eventsTypeDataList,"show-path":!1,filterable:"","value-field":"id","label-field":"pname"},null,8,["value","options"])]),_:1}),e(r,{label:"匹配规则",path:"mrules"},{default:n(()=>[e(_,{"max-tag-count":2,value:l.mrules,"onUpdate:value":a[1]||(a[1]=v=>l.mrules=v),multiple:"",placeholder:"请选择匹配规则",clearable:"",filterable:"",options:N.data,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),e(r,{label:"最大限定时间",path:"maxtime"},{default:n(()=>[e(h,{value:l.maxtime,"onUpdate:value":a[2]||(a[2]=v=>l.maxtime=v),clearable:"",min:0,placeholder:"请输入最大限定时间(秒)",style:{width:"100%"}},null,8,["value"])]),_:1}),e(r,{label:"最大聚合次数",path:"maxagg"},{default:n(()=>[e(h,{value:l.maxagg,"onUpdate:value":a[3]||(a[3]=v=>l.maxagg=v),clearable:"",min:0,placeholder:"请输入最大聚合次数",style:{width:"100%"}},null,8,["value"])]),_:1}),e(r,{label:"转发类型",path:"forward"},{default:n(()=>[e(_,{"max-tag-count":1,value:l.forward,"onUpdate:value":a[4]||(a[4]=v=>l.forward=v),multiple:"",placeholder:"请选择转发类型",clearable:"","render-label":f,filterable:"","value-field":"id","label-field":"ipaddr",options:s(c).data,"reset-menu-on-options-change":!1,onScroll:F},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),Me={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function q(y){return typeof y=="function"||Object.prototype.toString.call(y)==="[object Object]"&&!he(y)}const ua=V({name:"eventalarm_aggregatepolicy",__name:"index",setup(y){const U=ge(),i=[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}],{columns:S,columnChecks:w,data:t,getData:x,loading:z,mobilePagination:$,searchParams:T,resetSearchParams:l}=ye({apiFn:Ie,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,mintime:null,maxtime:null,minagg:null,maxagg:null,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48,fixed:"left"},{key:"pname",title:"策略名称",align:"center",width:160,ellipsis:{tooltip:!0}},{key:"maxtime",title:"最大限定时间(秒)",align:"center",width:180},{key:"maxagg",title:"最大聚合次数",align:"center",width:180},{key:"mrules",title:"匹配规则",align:"center",width:160,render:a=>{const r=(a.mrules?a.mrules.split(","):[]).map(_=>{const h=i.find(m=>m.value===parseInt(_));return h?h.label:""});return e("div",null,[e("span",null,[r.join(", ")])])}},{key:"sysparam",title:"系统内置",align:"center",width:240,render:a=>{a.sysparam==null&&(a.sysparam=0);const o={0:"success",1:"info"},r=b(_e[a.sysparam]);return e(ve,{size:"small",type:o[a.sysparam]},q(r)?r:{default:()=>[r]})}},{key:"operate",title:b("common.operate"),align:"center",width:160,fixed:"right",render:a=>{let o;return a.sysparam!=0&&e("div",{class:"flex-center gap-8px"},[K(e(j,{type:"info",ghost:!0,size:"small",onClick:()=>C(a.id)},q(o=b("common.edit"))?o:{default:()=>[o]}),[[H("no-auth"),"aggregate.policy.update"]]),e(Le,{onPositiveClick:()=>R(a.id)},{default:()=>b("common.confirmDelete"),trigger:()=>{let r;return K(e(j,{type:"error",ghost:!0,size:"small"},q(r=b("common.delete"))?r:{default:()=>[r]}),[[H("no-auth"),"aggregate.policy.delete"]])}})])}}]}),{drawerVisible:p,operateType:u,editingData:D,handleAdd:g,handleEdit:N,checkedRowKeys:c,onBatchDeleted:A,onDeleted:I,closeDrawer:F}=we(t,x);async function L(){console.log(c.value),f(c.value,a=>{A()})}function C(a){N(a)}function R(a){console.log(a),f([a],o=>{I()})}async function f(a,o){const{data:r,error:_}=await Pe(a);if(!_)o&&o(r);else return!1}async function d(){}return(a,o)=>{const r=oe,_=Re,h=ae;return G(),be("div",Me,[e(Fe,{model:s(T),"onUpdate:model":o[0]||(o[0]=m=>B(T)?T.value=m:null),onReset:s(l),onSearch:s(x)},null,8,["model","onReset","onSearch"]),e(h,{title:"聚合策略",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":n(()=>[e(r,{columns:s(w),"onUpdate:columns":o[1]||(o[1]=m=>B(w)?w.value=m:null),"disabled-delete":s(c).length===0,loading:s(z),onAdd:s(g),onDelete:L,onRefresh:s(x),"is-view-export-button":!0,onExportHandler:d,"is-view-add-button":s(W)("aggregate.policy.insert"),"is-view-delete-button":s(W)("aggregate.policy.delete")},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","is-view-delete-button"])]),default:n(()=>[e(_,{"checked-row-keys":s(c),"onUpdate:checkedRowKeys":o[2]||(o[2]=m=>B(c)?c.value=m:null),columns:s(S),data:s(t),size:"small","flex-height":!s(U).isMobile,"scroll-x":s(S).reduce((m,k)=>m+k.width,0),loading:s(z),remote:"","row-key":m=>m.id,pagination:s($),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),e(Be,{visible:s(p),"onUpdate:visible":o[3]||(o[3]=m=>B(p)?p.value=m:null),"operate-type":s(u),"row-data":s(D),onSubmitted:s(x)},null,8,["visible","operate-type","row-data","onSubmitted"])]),_:1})])}}});export{ua as default};
