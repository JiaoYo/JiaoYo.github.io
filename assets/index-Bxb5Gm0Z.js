import{_ as oe}from"./table-header-operation.vue_vue_type_script_setup_true_lang-B6_w-svJ.js";import{d as V,q as G,s as J,x as Q,o as q,c as X,w as n,g as e,h as I,t as B,i as l,$ as v,G as se,ap as Y,O as Z,K as re,B as E,P as ee,ad as ae,r as M,v as ie,b as ue,ae as me,L as de,a0 as ce,af as pe,ag as fe,a4 as ge,aA as _e,av as ve,F as K,E as H,e as be,ah as j,ai as he,aj as ye}from"./index-EW2EHvBZ.js";import{u as we,a as xe}from"./table-BM2Nndfm.js";import{_ as De}from"./round-search-BClnDkrh.js";import{_ as Ne}from"./round-refresh-CSNTDgt0.js";import{_ as ke}from"./lodash-Tk07mST8.js";import{_ as Se}from"./FormItemGridItem-ChlUwwC5.js";import{_ as Te}from"./Grid-BSYdqYIk.js";import{u as Ce}from"./usePageData-BrxLaPmr.js";import{a as ze,b as Ie,c as Pe,d as Ue,e as $e}from"./events-CW6Qv9Pf.js";import{f as Ae,a as Le}from"./common-DLtYHZpw.js";import{_ as Re}from"./Cascader-Dv80DP9S.js";import{h as W}from"./permission-Pt6453DZ.js";import{_ as Fe}from"./Popconfirm-TDUTgjWd.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-Be20msHI.js";import"./setting-outlined-BxtKhYfw.js";import"./export-CRAVcHUz.js";import"./refresh-DaAMQoyy.js";import"./round-delete-DbWWWZSj.js";import"./round-plus-CN_Via8e.js";import"./Upload-DoM6KtKf.js";import"./Progress-CQtr656V.js";const je=V({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:G(["reset","search"],["update:model"]),setup(y,{emit:P}){const u=P,{formRef:k,restoreValidation:w}=J(),t=Q(y,"model");function D(p){t.value.fuzzy=p.replace(/\s/g,"")}function C(p){return!p.startsWith(" ")&&!p.endsWith(" ")}function U(){t.value.fuzzy=null,u("search")}async function S(){await w(),u("reset")}async function o(){var p,m,f,b;if(t.value.mintime&&t.value.maxtime&&t.value.maxtime-t.value.mintime<0)return(p=window.$message)==null||p.destroyAll(),(m=window.$message)==null||m.error("最小限定时间不得大于最大限定时间"),!1;if(t.value.minagg&&t.value.maxagg&&t.value.maxagg-t.value.minagg<0)return(f=window.$message)==null||f.destroyAll(),(b=window.$message)==null||b.error("最小聚合次数不得大于最大聚合次数"),!1;u("search")}const x=ke.throttle(o,1e3,{trailing:!1});return(p,m)=>{const f=Y,b=Z,c=Se,$=re,A=Ne,L=E,R=De,T=Te,F=ee,z=ae;return q(),X(z,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[e(F,{ref_key:"formRef",ref:k,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:se(l(x),["enter"])},{default:n(()=>[e(T,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:n(()=>[e(c,{span:"24 s:24 m:12 l:10",label:"最大限定时间"},{default:n(()=>[e(b,{wrap:!1,align:"center",class:"w-100%"},{default:n(()=>[e(f,{value:t.value.mintime,"onUpdate:value":m[0]||(m[0]=r=>t.value.mintime=r),min:0,placeholder:"最小限定时间"},null,8,["value"]),I(" — "),e(f,{value:t.value.maxtime,"onUpdate:value":m[1]||(m[1]=r=>t.value.maxtime=r),min:0,placeholder:"最大限定时间"},null,8,["value"])]),_:1})]),_:1}),e(c,{span:"224 s:24 m:12 l:10",label:"最大聚合次数"},{default:n(()=>[e(b,{wrap:!1,align:"center"},{default:n(()=>[e(f,{value:t.value.minagg,"onUpdate:value":m[2]||(m[2]=r=>t.value.minagg=r),min:0,placeholder:"最小聚合次数"},null,8,["value"]),I(" — "),e(f,{value:t.value.maxagg,"onUpdate:value":m[3]||(m[3]=r=>t.value.maxagg=r),min:0,placeholder:"最大聚合次数"},null,8,["value"])]),_:1})]),_:1}),e(c,{span:"24 s:12 m:8 l:6",label:"策略名称",path:"fuzzy"},{default:n(()=>[e($,{clearable:"",value:t.value.fuzzy,"onUpdate:value":m[4]||(m[4]=r=>t.value.fuzzy=r),placeholder:"请输入策略名称",onInput:D,"allow-input":C,onClear:U},null,8,["value"])]),_:1}),e(c,{span:"24 s:12 m:8 l:6"},{default:n(()=>[e(b,{class:"w-full"},{default:n(()=>[e(L,{onClick:S},{icon:n(()=>[e(A,{class:"text-icon"})]),default:n(()=>[I(" "+B(l(v)("common.reset")),1)]),_:1}),e(L,{type:"primary",ghost:"",onClick:l(x)},{icon:n(()=>[e(R,{class:"text-icon"})]),default:n(()=>[I(" "+B(l(v)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),Be=V({name:"OperateDrawer",__name:"operate-drawer",props:G({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:G(["submitted"],["update:visible"]),setup(y,{emit:P}){const u=y,k=P,w=M({eventsTypeDataList:[]}),t=Q(y,"visible"),{formRef:D,validate:C,restoreValidation:U}=J();ie();const S=ue(()=>({add:"新增聚合策略",edit:"修改聚合策略"})[u.operateType]),o=M(x());function x(){return{etid:null,mrules:null,maxtime:86400,maxagg:2e4,forward:null,sysparam:0}}const p={etid:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},mrules:{type:"array",required:!0,trigger:["blur","change"],message:"不能为空"},maxtime:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},maxagg:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"}};async function m(){const{data:r,error:a}=await Ae();a||(w.eventsTypeDataList=r,f())}async function f(){const{data:r,error:a}=await Le();a||w.eventsTypeDataList.forEach(s=>{s.children=r.filter(i=>i.pid===s.id)})}const b=M({data:[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}]}),{pageData:c,getData:$,nextPage:A}=Ce(ze),L=async r=>{const a=r.currentTarget;a.scrollTop+a.offsetHeight>=a.scrollHeight&&c.data.length<c.total&&A()};function R(){m(),$(),Object.assign(o,x()),u.operateType==="edit"&&u.rowData&&(u.rowData.mrules=u.rowData.mrules?u.rowData.mrules.split(",").map(Number):[],u.rowData.forward=u.rowData.forward?u.rowData.forward.split(",").map(Number):[],Object.assign(o,u.rowData))}function T(){t.value=!1}async function F(){var r,a,s,i,g,h;if(await C(),u.operateType==="add"){const{data:d,error:N}=await Ie([{etid:o.etid,mrules:(r=o.mrules)==null?void 0:r.join(","),maxtime:o.maxtime,maxagg:o.maxagg,forward:(a=o.forward)==null?void 0:a.join(",")}]);N||((s=window.$message)==null||s.success(v("common.addSuccess")),T(),k("submitted"))}else{const{data:d,error:N}=await Pe([{id:u.rowData.id,etid:o.etid,mrules:(i=o.mrules)==null?void 0:i.join(","),maxtime:o.maxtime,maxagg:o.maxagg,forward:(g=o.forward)==null?void 0:g.join(",")}]);N||((h=window.$message)==null||h.success(v("common.updateSuccess")),T(),k("submitted"))}}const z=r=>r.ipaddr+":"+r.fport+" ("+(r.ftype==0?"syslog":"SNMP Trap")+")";return me(t,()=>{t.value&&(R(),U())}),(r,a)=>{const s=Re,i=de,g=ce,h=Y,d=ee,N=E,te=Z,le=pe,ne=fe;return q(),X(ne,{show:t.value,"onUpdate:show":a[5]||(a[5]=_=>t.value=_),"display-directive":"show",width:450},{default:n(()=>[e(le,{title:S.value,"native-scrollbar":!1,closable:""},{footer:n(()=>[e(te,{size:16},{default:n(()=>[e(N,{onClick:T},{default:n(()=>[I(B(l(v)("common.cancel")),1)]),_:1}),e(N,{type:"primary",onClick:F},{default:n(()=>[I(B(l(v)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[e(d,{ref_key:"formRef",ref:D,model:o,rules:p},{default:n(()=>[e(i,{label:"策略名称",path:"etid"},{default:n(()=>[e(s,{value:o.etid,"onUpdate:value":a[0]||(a[0]=_=>o.etid=_),clearable:"","check-strategy":"child",placeholder:"请选择策略名称",options:w.eventsTypeDataList,"show-path":!1,filterable:"","value-field":"id","label-field":"pname"},null,8,["value","options"])]),_:1}),e(i,{label:"匹配规则",path:"mrules"},{default:n(()=>[e(g,{"max-tag-count":2,value:o.mrules,"onUpdate:value":a[1]||(a[1]=_=>o.mrules=_),multiple:"",placeholder:"请选择匹配规则",clearable:"",filterable:"",options:b.data,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),e(i,{label:"最大限定时间",path:"maxtime"},{default:n(()=>[e(h,{value:o.maxtime,"onUpdate:value":a[2]||(a[2]=_=>o.maxtime=_),clearable:"",min:0,placeholder:"请输入最大限定时间(秒)",style:{width:"100%"}},null,8,["value"])]),_:1}),e(i,{label:"最大聚合次数",path:"maxagg"},{default:n(()=>[e(h,{value:o.maxagg,"onUpdate:value":a[3]||(a[3]=_=>o.maxagg=_),clearable:"",min:0,placeholder:"请输入最大聚合次数",style:{width:"100%"}},null,8,["value"])]),_:1}),e(i,{label:"转发类型",path:"forward"},{default:n(()=>[e(g,{"max-tag-count":1,value:o.forward,"onUpdate:value":a[4]||(a[4]=_=>o.forward=_),multiple:"",placeholder:"请选择转发类型",clearable:"","render-label":z,filterable:"","value-field":"id","label-field":"ipaddr",options:l(c).data,"reset-menu-on-options-change":!1,onScroll:L},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),Ee={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function O(y){return typeof y=="function"||Object.prototype.toString.call(y)==="[object Object]"&&!he(y)}const ua=V({name:"eventalarm_aggregatepolicy",__name:"index",setup(y){const P=ge(),u=[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}],{columns:k,columnChecks:w,data:t,getData:D,loading:C,mobilePagination:U,searchParams:S,resetSearchParams:o}=we({apiFn:Ue,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,mintime:null,maxtime:null,minagg:null,maxagg:null,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48,fixed:"left"},{key:"pname",title:"策略名称",align:"center",width:160,ellipsis:{tooltip:!0}},{key:"maxtime",title:"最大限定时间(秒)",align:"center",width:180},{key:"maxagg",title:"最大聚合次数",align:"center",width:180},{key:"mrules",title:"匹配规则",align:"center",width:160,render:a=>{const i=(a.mrules?a.mrules.split(","):[]).map(g=>{const h=u.find(d=>d.value===parseInt(g));return h?h.label:""});return e("div",null,[e("span",null,[i.join(", ")])])}},{key:"sysparam",title:"系统内置",align:"center",width:240,render:a=>{a.sysparam==null&&(a.sysparam=0);const s={0:"success",1:"info"},i=v(_e[a.sysparam]);return e(ve,{size:"small",type:s[a.sysparam]},O(i)?i:{default:()=>[i]})}},{key:"operate",title:v("common.operate"),align:"center",width:160,fixed:"right",render:a=>{let s;return a.sysparam!=0&&e("div",{class:"flex-center gap-8px"},[K(e(E,{type:"info",ghost:!0,size:"small",onClick:()=>T(a.id)},O(s=v("common.edit"))?s:{default:()=>[s]}),[[H("no-auth"),"aggregate.policy.update"]]),e(Fe,{onPositiveClick:()=>F(a.id)},{default:()=>v("common.confirmDelete"),trigger:()=>{let i;return K(e(E,{type:"error",ghost:!0,size:"small"},O(i=v("common.delete"))?i:{default:()=>[i]}),[[H("no-auth"),"aggregate.policy.delete"]])}})])}}]}),{drawerVisible:x,operateType:p,editingData:m,handleAdd:f,handleEdit:b,checkedRowKeys:c,onBatchDeleted:$,onDeleted:A,closeDrawer:L}=xe(t,D);async function R(){console.log(c.value),z(c.value,a=>{$()})}function T(a){b(a)}function F(a){console.log(a),z([a],s=>{A()})}async function z(a,s){const{data:i,error:g}=await $e(a);if(!g)s&&s(i);else return!1}async function r(){}return(a,s)=>{const i=oe,g=ye,h=ae;return q(),be("div",Ee,[e(je,{model:l(S),"onUpdate:model":s[0]||(s[0]=d=>j(S)?S.value=d:null),onReset:l(o),onSearch:l(D)},null,8,["model","onReset","onSearch"]),e(h,{title:"聚合策略",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":n(()=>[e(i,{columns:l(w),"onUpdate:columns":s[1]||(s[1]=d=>j(w)?w.value=d:null),"disabled-delete":l(c).length===0,loading:l(C),onAdd:l(f),onDelete:R,onRefresh:l(D),"is-view-export-button":!0,onExportHandler:r,"is-view-add-button":l(W)("aggregate.policy.insert"),"is-view-delete-button":l(W)("aggregate.policy.delete")},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","is-view-delete-button"])]),default:n(()=>[e(g,{"checked-row-keys":l(c),"onUpdate:checkedRowKeys":s[2]||(s[2]=d=>j(c)?c.value=d:null),columns:l(k),data:l(t),size:"small","flex-height":!l(P).isMobile,"scroll-x":l(k).reduce((d,N)=>d+N.width,0),loading:l(C),remote:"","row-key":d=>d.id,pagination:l(U),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),e(Be,{visible:l(x),"onUpdate:visible":s[3]||(s[3]=d=>j(x)?x.value=d:null),"operate-type":l(p),"row-data":l(m),onSubmitted:l(D)},null,8,["visible","operate-type","row-data","onSubmitted"])]),_:1})])}}});export{ua as default};
