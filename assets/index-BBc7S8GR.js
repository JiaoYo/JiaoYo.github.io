import{d as G,a3 as M,$ as w,g as s,E as x,D as T,B as d,h as f,v as A,y as F,z as X,x as J,dt as W,r as K,j as N,o as k,e as Z,w as o,c as b,i as t,f as H,t as V,be as Q,G as B,bf as Y,bg as ee,bh as te,aj as ne,ad as ae,Z as se,K as oe,N as U,O as ie,ar as le}from"./index-BmWuR77W.js";import{u as re}from"./table-BQ9aSFVz.js";import{f as ce}from"./reportForm-DI_pl2OI.js";import{d as ue,e as me,g as pe}from"./log-DM3Zgv7Y.js";import{f as ge}from"./scheduleTask-BrJQHIcc.js";import{_ as de}from"./Popconfirm-C7zOlF1t.js";import{_ as fe}from"./TimePicker-BxOd9-AY.js";import"./defineProperty-PfS0ZyjP.js";const _e={class:"min-h-500px flex-col-stretch gap-16px overflow-auto lt-sm:overflow-auto"},ye={class:"flex justify-center"},$e=G({name:"logretrieval_logbackup",__name:"index",setup(ke){const S=M(),{columns:$,columnChecks:we,data:I,getData:be,loading:D,mobilePagination:E,searchParams:he,resetSearchParams:ve}=re({apiFn:ue,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{key:"fname",title:"文件名称",align:"center",width:240},{key:"dbtime",title:"备份时间",align:"center",width:240},{key:"operate",title:w("common.operate"),align:"center",width:130,render:a=>s("div",{class:"flex-center gap-8px"},[x(s(d,{type:"primary",ghost:!0,size:"small",onClick:()=>O(a.fname)},{default:()=>[f("下载")]}),[[T("no-auth"),"sysmanger.logBackUps.download"]]),s(de,{onPositiveClick:()=>j(a.fname)},{default:()=>"确定恢复吗?",trigger:()=>s(d,{type:"info",ghost:!0,size:"small"},{default:()=>[f("恢复")]})})])}]});async function O(a){const n=A(),l=Date.now().toString(),c=F(`${n}${l}${"fname="+encodeURIComponent(a)}`);X({url:`${J}/logBackUps/download.do`,method:"post",params:{fname:a},responseType:"blob",headers:{token:W(),"X-Nonce":n,"X-Timestamp":l,"X-Signature":c}}).then(async r=>{var m,y;if(r.data.type=="application/json"){const g=await r.data.text();var u=JSON.parse(g);if(u.code==500)return(m=window.$message)==null?void 0:m.error(u.data)}if(r.data){const g=window.URL.createObjectURL(new Blob([r.data])),p=document.createElement("a");p.href=g,p.setAttribute("download",a),document.body.appendChild(p),p.click()}(y=window.$message)==null||y.success("下载成功")})}const j=async a=>{var c;const{data:n,error:l}=await me(a);l||(c=window.$message)==null||c.success("恢复成功")},h=()=>({id:"",beanName:"",params:"",cronExpression:"",status:1,remark:""});let e=K({taskInfo:h(),setting:{settingCycle:void 0,settingCycleValue:void 0,settingTime:void 0}});const z={setting:{settingCycle:{type:"number",required:!0,message:"请选择设置周期",trigger:"blur"},settingCycleValue:{type:"number",required:!1,message:"请选择设置周期值",trigger:"blur"},settingTime:{required:!0,message:"请选择设置时间",trigger:"blur"}}},v=N(null),_=N(!1),L=async()=>{_.value=!0;const{data:a,error:n}=await pe();if(!n){console.log(a);const l=ee(a.cronExpression);Object.assign(e.setting,l),e.taskInfo=a}},C=()=>{_.value=!1,e.taskInfo=h()},R=async()=>{var n,l,c,r;await((n=v.value)==null?void 0:n.validate());const a=te(e.setting.settingCycle==1?{dayOfWeek:e.setting.settingCycleValue,time:e.setting.settingTime}:null,e.setting.settingCycle==2?{dayOfMonth:e.setting.settingCycleValue,time:e.setting.settingTime}:null,e.setting.settingCycle==3?{time:e.setting.settingTime}:null);if((l=e.taskInfo)!=null&&l.id){const{data:u,error:m}=await ge({beanName:e.taskInfo.beanName,cronExpression:a,id:e.taskInfo.id,params:e.taskInfo.params,status:e.taskInfo.status,remark:e.taskInfo.remark});m||(r=window.$message)==null||r.success("设置成功")}else{const{data:u,error:m}=await ce({beanName:"LogBackUpsTask",cronExpression:a,params:JSON.stringify({cron:a}),remark:""});m||(c=window.$message)==null||c.success("设置成功")}C()};return(a,n)=>{const l=ne,c=ae,r=se,u=oe,m=U,y=fe,g=ie,p=U,P=le,q=T("no-auth");return k(),Z("div",_e,[s(c,{title:"日志备份",bordered:!1,size:"small",class:"sm:flex-1-hidden"},{"header-extra":o(()=>[x((k(),b(t(d),{type:"primary",ghost:"",onClick:L},{default:o(()=>[f("备份设置 ")]),_:1})),[[q,"sysmanger.logBackUps.task"]])]),default:o(()=>[s(l,{columns:t($),data:t(I),size:"small","flex-height":!t(S).isMobile,"scroll-x":962,loading:t(D),remote:"","row-key":i=>i.id,pagination:t(E),class:"sm:h-full"},null,8,["columns","data","flex-height","loading","row-key","pagination"])]),_:1}),s(P,{show:_.value,"onUpdate:show":n[5]||(n[5]=i=>_.value=i),title:"日志备份设置",preset:"card",class:"w-400px"},{footer:o(()=>[H("div",ye,[s(p,{justify:"end",size:16},{default:o(()=>[s(t(d),{onClick:C},{default:o(()=>[f(V(t(w)("common.cancel")),1)]),_:1}),s(t(d),{type:"primary",onClick:R},{default:o(()=>[f(V(t(w)("common.confirm")),1)]),_:1})]),_:1})])]),default:o(()=>[s(g,{ref_key:"formRef",ref:v,model:t(e),rules:z,"label-placement":"left","label-width":140,"require-mark-placement":"left"},{default:o(()=>[s(u,{label:"设置周期",path:"setting.settingCycle"},{default:o(()=>[s(m,{justify:"space-between"},{default:o(()=>[s(r,{value:t(e).setting.settingCycle,"onUpdate:value":[n[0]||(n[0]=i=>t(e).setting.settingCycle=i),n[1]||(n[1]=i=>t(e).setting.settingCycleValue=1)],options:[{label:"每周",value:1},{label:"每月",value:2},{label:"每日",value:3}],style:{width:"140px"}},null,8,["value"]),s(u,{label:"",path:"setting.settingCycleValue","show-feedback":!1},{default:o(()=>[t(e).setting.settingCycle==1?(k(),b(r,{key:0,value:t(e).setting.settingCycleValue,"onUpdate:value":n[2]||(n[2]=i=>t(e).setting.settingCycleValue=i),options:t(Q)(),style:{width:"140px"}},null,8,["value","options"])):B("",!0),t(e).setting.settingCycle==2?(k(),b(r,{key:1,value:t(e).setting.settingCycleValue,"onUpdate:value":n[3]||(n[3]=i=>t(e).setting.settingCycleValue=i),options:t(Y)(),style:{width:"140px"}},null,8,["value","options"])):B("",!0)]),_:1})]),_:1})]),_:1}),s(u,{label:"设置时间",path:"setting.settingTime"},{default:o(()=>[s(y,{"formatted-value":t(e).setting.settingTime,"onUpdate:formattedValue":n[4]||(n[4]=i=>t(e).setting.settingTime=i)},null,8,["formatted-value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])])}}});export{$e as default};
