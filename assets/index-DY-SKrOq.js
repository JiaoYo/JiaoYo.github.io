import{_ as $e}from"./table-header-operation.vue_vue_type_script_setup_true_lang-DSLF4GvF.js";import{d as Y,dN as Pe,j as I,aU as le,at as pe,b9 as me,dO as fe,dP as _e,a7 as ee,bO as Ue,aq as ie,c7 as je,r as xe,q as re,x as Te,s as Re,v as Ee,b as ze,ag as Ae,bh as ve,bg as ye,F as ae,o as $,c as Q,w as a,g as e,h as m,t as x,i as n,$ as z,G as F,e as ue,ao as he,Y as A,I as Le,f as E,aF as Be,y as Fe,bj as Ke,b0 as qe,L as Ce,M as ge,as as Ve,N as Ge,a1 as Je,Q as Ne,S as He,B as W,P as De,bi as Oe,au as Qe,H as We,af as de,a5 as Ye,aj as te,al as Xe}from"./index-BP7F9FxI.js";import{h as Ze,i as et,f as tt,j as at,k as nt,l as be,m as ot}from"./reportForm-DQzNdJM4.js";import{f as st,i as Se}from"./scheduleTask-7u1pMdMD.js";import{u as lt,a as it}from"./table-BZRWUD8G.js";import{T as ce,a as Me,S as Ie}from"./task-BURfBPJp.js";import{M as rt}from"./shield-question-outline-rounded-iXcnu2Bp.js";import{_ as ut}from"./TimePicker-X1-RQ4f7.js";import{_ as dt}from"./round-search-DyyzfEdI.js";import{_ as ct}from"./round-refresh-81nSFoBL.js";import{_ as pt}from"./lodash-BXGszeVa.js";import{_ as mt}from"./FormItemGridItem-C7_XHVbB.js";import{_ as ft}from"./Grid-Bo5eh9Zu.js";import{h as ke}from"./permission-DYmPksV5.js";import{_ as _t}from"./Popconfirm-Dg6vV92x.js";import{_ as vt,a as yt}from"./DescriptionsItem-D3DxFfOU.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-HgT7VkxX.js";import"./setting-outlined-D9DSfit9.js";import"./export-D1GS-u1R.js";import"./refresh-DvrXeenc.js";import"./round-delete-Ch_nGZvJ.js";import"./round-plus-BypMaIJk.js";import"./Upload-K8gDmy3J.js";import"./Progress-DwZ6AxQJ.js";import"./defineProperty-BrQ3povv.js";const ht=Y({name:"ModalEnvironment",props:Object.assign(Object.assign({},Pe),{internalKey:{type:String,required:!0},onInternalAfterLeave:{type:Function,required:!0}}),setup(_){const h=I(!0);function c(){const{onInternalAfterLeave:s,internalKey:p,onAfterLeave:t}=_;s&&s(p),t&&t()}function i(){const{onPositiveClick:s}=_;s?Promise.resolve(s()).then(p=>{p!==!1&&u()}):u()}function g(){const{onNegativeClick:s}=_;s?Promise.resolve(s()).then(p=>{p!==!1&&u()}):u()}function v(){const{onClose:s}=_;s?Promise.resolve(s()).then(p=>{p!==!1&&u()}):u()}function D(s){const{onMaskClick:p,maskClosable:t}=_;p&&(p(s),t&&u())}function O(){const{onEsc:s}=_;s&&s()}function u(){h.value=!1}function b(s){h.value=s}return{show:h,hide:u,handleUpdateShow:b,handleAfterLeave:c,handleCloseClick:v,handleNegativeClick:g,handlePositiveClick:i,handleMaskClick:D,handleEsc:O}},render(){const{handleUpdateShow:_,handleAfterLeave:h,handleMaskClick:c,handleEsc:i,show:g}=this;return le(pe,Object.assign({},this.$props,{show:g,onUpdateShow:_,onMaskClick:c,onEsc:i,onAfterLeave:h,internalAppear:!0,internalModal:!0}))}}),we=me("n-modal-provider"),gt=me("n-modal-api"),bt=me("n-modal-reactive-list"),kt={to:[String,Object]},wt=Y({name:"ModalProvider",props:kt,setup(){const _=fe(64),h=_e(),c=I([]),i={};function g(u={}){const b=je(),s=xe(Object.assign(Object.assign({},u),{key:b,destroy:()=>{var p;(p=i[`n-modal-${b}`])===null||p===void 0||p.hide()}}));return c.value.push(s),s}function v(u){const{value:b}=c;b.splice(b.findIndex(s=>s.key===u),1)}function D(){Object.values(i).forEach(u=>{u==null||u.hide()})}const O={create:g,destroyAll:D};return ee(gt,O),ee(we,{clickedRef:fe(64),clickedPositionRef:_e()}),ee(bt,c),ee(we,{clickedRef:_,clickedPositionRef:h}),Object.assign(Object.assign({},O),{modalList:c,modalInstRefs:i,handleAfterLeave:v})},render(){var _,h;return le(ie,null,[this.modalList.map(c=>{var i;return le(ht,Ue(c,["destroy"],{to:(i=c.to)!==null&&i!==void 0?i:this.to,ref:g=>{g===null?delete this.modalInstRefs[`n-modal-${c.key}`]:this.modalInstRefs[`n-modal-${c.key}`]=g},internalKey:c.key,onInternalAfterLeave:this.handleAfterLeave}))}),(h=(_=this.$slots).default)===null||h===void 0?void 0:h.call(_)])}}),xt=E("span",null,[m("报表统计的周期为： "),E("span",{class:"c-#1890ff"},"前一天"),m(" / "),E("span",{class:"c-#1890ff"},"上周周一至周日"),m(" / "),E("span",{class:"c-#1890ff"},"上个月"),m(" / "),E("span",{class:"c-#1890ff"},"上周周日至周六")],-1),Tt=Y({name:"TaskModal",__name:"task_modal",props:re({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:re(["submitted"],["update:visible"]),setup(_,{expose:h,emit:c}){const i=_,g=c,v=Te(_,"visible"),{formRef:D,validate:O,restoreValidation:u}=Re(),{defaultRequiredRule:b,patternRules:s}=Ee(),p=ze(()=>({add:"新增任务",edit:"编辑任务"})[i.operateType]),t=xe(P());function P(){return{id:void 0,rname:"",rtype:0,ttype:0,starttime:void 0,endtime:void 0,excute:1,stype:0,recipient:"",rdesc:"",tid:void 0}}const K={rname:b,starttime:b,cron:b,rtype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择实例"},ttype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择任务类型"},stype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择发送类型"},recipient:{required:!0,validator:Be,trigger:["input","change","blur","password-input"]}},N=I(""),q=async()=>{var R,w;const{data:y,error:l}=await Se((R=i.rowData)==null?void 0:R.tid);if(!l){const T=Oe(y==null?void 0:y.cronExpression);N.value=(w=JSON.parse(y==null?void 0:y.params))==null?void 0:w.uuid,t.starttime=T==null?void 0:T.settingTime}};function V(){Object.assign(t,P()),S.value=Fe(),i.operateType==="edit"&&i.rowData&&(i.rowData.starttime=i.rowData.starttime.substring(11,19),Object.assign(t,i.rowData),q())}function L(){v.value=!1}const S=I(""),U=async y=>{const{data:l,error:R}=await tt({beanName:"ReportTask",remark:S.value,cronExpression:y,params:JSON.stringify({rtype:t.rtype,ttype:t.ttype,uuid:S.value})});return R?!1:(await k(),!0)},k=async()=>{const{data:y,error:l}=await at({uuid:S.value});t.tid=y};async function G(){var l,R;await O();const y=Ke(t.ttype==1||t.ttype==3?{dayOfWeek:t.excute,time:t.starttime}:null,t.ttype==2?{dayOfMonth:t.excute,time:t.starttime}:null,t.ttype==0?{time:t.starttime}:null);if(i.operateType==="add"){if(!await U(y))return!1}else{const{data:w,error:T}=await st({id:t.tid,cronExpression:y,beanName:"ReportTask",status:1,params:JSON.stringify({rtype:t.rtype,ttype:t.ttype,uuid:N.value})});if(T)return!1}if(t.ttype==0&&delete t.excute,i.operateType==="add"){const{data:w,error:T}=await Ze({...t,starttime:qe(1,new Date)});T||((l=window.$message)==null||l.success(z("common.addSuccess")),L(),g("submitted"))}else{delete t.starttime;const{data:w,error:T}=await et({...t});T||((R=window.$message)==null||R.success(z("common.updateSuccess")),L(),g("submitted"))}}const X=y=>{t.excute=1};return Ae(v,()=>{v.value&&(V(),u())}),h({monthOption:ve,weekOption:ye}),(y,l)=>{const R=Ce,w=ge,T=Qe,J=Ve,f=Ge,r=Je,C=ut,j=ge,M=Ne,ne=He,Z=W,oe=De,se=pe,d=ae("no-space");return $(),Q(se,{show:v.value,"onUpdate:show":l[8]||(l[8]=o=>v.value=o),title:p.value,preset:"card",class:"w-600px"},{footer:a(()=>[e(oe,{justify:"end",size:16},{default:a(()=>[e(Z,{onClick:L},{default:a(()=>[m(x(n(z)("common.cancel")),1)]),_:1}),e(Z,{type:"primary",onClick:G},{default:a(()=>[m(x(n(z)("common.confirm")),1)]),_:1})]),_:1})]),default:a(()=>[e(ne,{class:"max-h-520px pr-20px"},{default:a(()=>[e(M,{ref_key:"formRef",ref:D,model:t,rules:K,"label-placement":"left","label-width":110,"require-mark-placement":"left"},{default:a(()=>[e(w,{label:"任务名称",path:"rname"},{default:a(()=>[F(e(R,{value:t.rname,"onUpdate:value":l[0]||(l[0]=o=>t.rname=o),placeholder:"请输入任务名称",clearable:""},null,8,["value"]),[[d]])]),_:1}),e(w,{label:"实例选择",path:"rtype"},{default:a(()=>[e(J,{value:t.rtype,"onUpdate:value":l[1]||(l[1]=o=>t.rtype=o),name:"radiogroup"},{default:a(()=>[($(!0),ue(ie,null,he(n(A)(n(ce)),(o,B)=>($(),Q(T,{key:B,value:o.value},{default:a(()=>[m(x(o.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),e(w,{label:"任务类型",path:"ttype"},{label:a(()=>[m(" 任务类型 "),e(f,{trigger:"hover",placement:"top-start"},{trigger:a(()=>[e(n(rt),{class:"text-xl cursor-pointer c-#7a7b78"})]),default:a(()=>[xt]),_:1})]),default:a(()=>[e(J,{value:t.ttype,"onUpdate:value":[l[2]||(l[2]=o=>t.ttype=o),X],name:"radiogroup"},{default:a(()=>[($(!0),ue(ie,null,he(n(A)(n(Me)),(o,B)=>($(),Q(T,{key:B,value:o.value},{default:a(()=>[m(x(o.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),[1,2,3].includes(t.ttype)?($(),Q(w,{key:0,label:t.ttype==2?"每月":"每周",path:"excute"},{default:a(()=>[e(r,{filterable:"",value:t.excute,"onUpdate:value":l[3]||(l[3]=o=>t.excute=o),placeholder:"请选择",options:t.ttype==2?n(ve)():n(ye)(),style:{width:"100%"}},null,8,["value","options"])]),_:1},8,["label"])):Le("",!0),e(j,{label:"执行时间",path:"starttime"},{default:a(()=>[e(C,{"formatted-value":t.starttime,"onUpdate:formattedValue":l[4]||(l[4]=o=>t.starttime=o),placeholder:"选择执行时间"},null,8,["formatted-value"])]),_:1}),e(w,{label:"收件人",path:"recipient"},{default:a(()=>[F(e(R,{value:t.recipient,"onUpdate:value":l[5]||(l[5]=o=>t.recipient=o),placeholder:"请输入收件人",clearable:""},null,8,["value"]),[[d]])]),_:1}),e(w,{label:"发送类型",path:"stype"},{default:a(()=>[e(r,{filterable:"",value:t.stype,"onUpdate:value":l[6]||(l[6]=o=>t.stype=o),placeholder:"请选择发送类型",options:n(A)(n(Ie)),style:{width:"100%"}},null,8,["value","options"])]),_:1}),e(w,{label:"任务描述",path:"rdesc"},{default:a(()=>[F(e(R,{type:"textarea",value:t.rdesc,"onUpdate:value":l[7]||(l[7]=o=>t.rdesc=o),placeholder:"请输入任务描述",clearable:""},null,8,["value"]),[[d]])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Rt=Y({name:"TaskSearch",__name:"task_search",props:{model:{required:!0},modelModifiers:{}},emits:re(["reset","search"],["update:model"]),setup(_,{emit:h}){const c=h,{formRef:i,restoreValidation:g}=Re(),v=Te(_,"model");function D(){v.value.fuzzy=void 0,c("search")}async function O(){await g(),c("reset")}async function u(){c("search")}const b=pt.debounce(u,1e3,{leading:!0,trailing:!1});return(s,p)=>{const t=Ce,P=mt,K=ct,N=W,q=dt,V=De,L=ft,S=Ne,U=de,k=ae("no-space");return $(),Q(U,{bordered:!1,size:"small",class:"card-wrapper"},{default:a(()=>[e(S,{ref_key:"formRef",ref:i,model:v.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:We(n(b),["enter"])},{default:a(()=>[e(L,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:a(()=>[e(P,{span:"24 s:12 m:10 l:6",label:"任务名称",path:"fuzzy"},{default:a(()=>[F(e(t,{value:v.value.fuzzy,"onUpdate:value":p[0]||(p[0]=G=>v.value.fuzzy=G),placeholder:"请输入任务名称关键字",clearable:"",onClear:D},null,8,["value"]),[[k]])]),_:1}),e(P,{span:"24 s:12 m:8 l:6"},{default:a(()=>[e(V,{class:"w-full"},{default:a(()=>[e(N,{onClick:O},{icon:a(()=>[e(K,{class:"text-icon"})]),default:a(()=>[m(" "+x(n(z)("common.reset")),1)]),_:1}),e(N,{type:"primary",ghost:"",onClick:n(b)},{icon:a(()=>[e(q,{class:"text-icon"})]),default:a(()=>[m(" "+x(n(z)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),Ct={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Nt=E("div",{style:{display:"flex","align-items":"center"}},[E("div",null,"报表任务")],-1),Zt=Y({name:"reportmanagement_reporttask",__name:"index",setup(_){const h=Ye(),{columns:c,columnChecks:i,data:g,getData:v,loading:D,mobilePagination:O,searchParams:u,resetSearchParams:b}=lt({apiFn:nt,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"rname",title:"任务名称",align:"center",width:160},{key:"rtype",title:"实例类型",align:"center",width:160,render:f=>{var r;return e("div",null,[(r=A(ce).find(C=>C.value===f.rtype))==null?void 0:r.label])}},{key:"starttime",title:"创建时间",align:"center",width:160},{key:"operate",title:z("common.operate"),align:"center",width:160,render:f=>e("div",{class:"flex-center gap-8px"},[e(wt,null,{default:()=>[e(W,{type:"info",ghost:!0,size:"small",onClick:()=>G(f.id)},{default:()=>[m("详情")]})]}),F(e(W,{type:"warning",ghost:!0,size:"small",onClick:()=>R(f.id)},{default:()=>[m("修改")]}),[[ae("no-auth"),"sys.report.task.update"]]),e(_t,{onPositiveClick:()=>w(f.id)},{default:()=>"确定要删除改数据吗？",trigger:()=>F(e(W,{type:"error",ghost:!0,size:"small"},{default:()=>[m("删除")]}),[[ae("no-auth"),"sys.report.task.delete"]])})])}]}),{drawerVisible:s,operateType:p,editingData:t,handleAdd:P,handleEdit:K,checkedRowKeys:N,onBatchDeleted:q,onDeleted:V,closeDrawer:L}=it(g,v),S=I(),U=I(!1),k=I({id:void 0,rname:"",rtype:0,ttype:0,starttime:void 0,endtime:void 0,excute:0,stype:0,recipient:"",rdesc:"",tid:void 0}),G=async f=>{U.value=!0;const{data:r,error:C}=await be(f);C||(k.value=r,y(r.tid+""))},X=I(""),y=async f=>{const{data:r,error:C}=await Se(f);if(!C){const j=Oe(r.cronExpression);X.value=j.settingTime}},l=I();async function R(f){const{data:r,error:C}=await be(f);C||(l.value=r),K(f)}function w(f){J(f,r=>{V()})}async function T(){J(N.value.join(","),f=>{q()})}async function J(f,r){const{data:C,error:j}=await ot(f);j||r&&r(C)}return(f,r)=>{const C=$e,j=Xe,M=vt,ne=yt,Z=de,oe=pe,se=de;return $(),ue("div",Ct,[e(Rt,{model:n(u),"onUpdate:model":r[0]||(r[0]=d=>te(u)?u.value=d:null),onReset:n(b),onSearch:n(v)},null,8,["model","onReset","onSearch"]),e(se,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:a(()=>[Nt]),"header-extra":a(()=>[e(C,{columns:n(i),"onUpdate:columns":r[1]||(r[1]=d=>te(i)?i.value=d:null),"disabled-delete":n(N).length===0,loading:n(D),onAdd:n(P),onRefresh:n(v),"is-view-add-button":n(ke)("sys.report.task.insert"),isViewDeleteButton:n(ke)("sys.report.task.delete"),onDelete:T},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","isViewDeleteButton"])]),default:a(()=>[e(j,{"checked-row-keys":n(N),"onUpdate:checkedRowKeys":r[2]||(r[2]=d=>te(N)?N.value=d:null),columns:n(c),data:n(g),size:"small","flex-height":!n(h).isMobile,"scroll-x":962,loading:n(D),remote:"","row-key":d=>d.id,pagination:n(O),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),e(Tt,{ref_key:"TaskModalRef",ref:S,visible:n(s),"onUpdate:visible":r[3]||(r[3]=d=>te(s)?s.value=d:null),"operate-type":n(p),"row-data":l.value,onSubmitted:n(v)},null,8,["visible","operate-type","row-data","onSubmitted"]),e(oe,{show:U.value,"onUpdate:show":r[4]||(r[4]=d=>U.value=d),preset:"card",class:"w-500px",title:"报表任务详情"},{default:a(()=>[e(Z,null,{default:a(()=>[e(ne,{"label-placement":"left",column:1,"label-style":{width:"100px",display:"inline-block",textAlign:"right",marginRight:"10px"}},{default:a(()=>[e(M,{label:"任务名称"},{default:a(()=>[m(x(k.value.rname),1)]),_:1}),e(M,{label:"实例"},{default:a(()=>{var d;return[m(x((d=n(A)(n(ce)).find(o=>o.value===k.value.rtype))==null?void 0:d.label),1)]}),_:1}),e(M,{label:"创建时间"},{default:a(()=>[m(x(k.value.starttime),1)]),_:1}),e(M,{label:"任务执行周期"},{default:a(()=>{var d,o,B;return[m(x((d=n(A)(n(Me)).find(H=>H.value===k.value.ttype))==null?void 0:d.label)+" "+x(k.value.ttype==1?(o=S.value.weekOption().find(H=>H.value==k.value.excute))==null?void 0:o.label:k.value.ttype==2?(B=S.value.monthOption().find(H=>H.value==k.value.excute))==null?void 0:B.label:"")+" "+x(X.value),1)]}),_:1}),e(M,{label:"发送类型"},{default:a(()=>{var d;return[m(x((d=n(A)(n(Ie)).find(o=>o.value===k.value.stype))==null?void 0:d.label),1)]}),_:1}),e(M,{label:"收件人"},{default:a(()=>[m(x(k.value.recipient),1)]),_:1}),e(M,{label:"描述"},{default:a(()=>[m(x(k.value.rdesc),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])]),_:1})])}}});export{Zt as default};
