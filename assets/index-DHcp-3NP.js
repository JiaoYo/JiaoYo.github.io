import{_ as je}from"./table-header-operation.vue_vue_type_script_setup_true_lang-BHdjnJGE.js";import{d as ne,q as oe,s as pe,v as ye,x as ve,b as ze,$ as o,r as he,j as C,y as be,L as z,o as E,c as X,w as r,g as a,h as T,t as B,i as t,N as ke,M,O as ie,V as ue,W as De,aV as S,G as de,A as ce,C as Pe,Y as Ne,D as fe,B as U,E as re,ab as Me,ac as Be,aa as Ue,dx as ge,f as Ve,F as xe,aM as qe,an as me,a0 as Fe,dy as Ie,e as Ae,ad as te,ae as Ge,dA as Ke,S as Ee}from"./index-hw7QOW1T.js";import{h as He,i as Je,j as Le,e as We,k as Ye,f as Qe,l as _e,m as Xe}from"./system-manage-CU2lsb5u.js";import{u as Ze,a as ea}from"./table-BKuYvkWU.js";import{U as aa}from"./common-B1p6TrTP.js";import{h as ta}from"./basic-config-DoQw_5LH.js";import{_ as sa}from"./DatePicker-B-U85sJF.js";import{_ as oa}from"./TimePicker-E1Gl7M0T.js";import{_ as na}from"./round-search-Wdn6cQPo.js";import{_ as ra}from"./round-refresh-CTnCderg.js";import{_ as la}from"./FormItemGridItem-BJtyHf3C.js";import{_ as ia}from"./Grid-Cw6tbggG.js";import{_ as ua}from"./Tree-D3sIMqGQ.js";import{h as we}from"./permission-BgxCDMSi.js";import{_ as da}from"./Popconfirm-BEEFAPPE.js";import{_ as ma}from"./DataTable-qeqEjtEf.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-Db4-USgA.js";import"./setting-outlined-6-9KjY3w.js";import"./round-delete-BKIC0WVe.js";import"./refresh-wIPyYUe8.js";import"./round-plus-DF4zpV2C.js";import"./Upload-BGvaNzBI.js";import"./Progress-76kDcVby.js";import"./Forward-iJK0D6Xc.js";import"./defineProperty-D1x1w6PM.js";const pa=ne({name:"UserOperateDrawer",__name:"user-operate-drawer",props:oe({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:oe(["submitted"],["update:visible"]),setup(h,{emit:b}){const l=h,D=b,v=pe(h,"visible"),{formRef:f,validate:P,restoreValidation:V}=ye(),{createConfirmPwdRule:x,defaultRequiredRule:H,formRules:k}=ve(),g=ze(()=>({add:o("page.manage.user.addUser"),edit:o("page.manage.user.editUser")})[l.operateType]),e=he(_());function _(){return{username:"",usertype:void 0,oripwd:"",password:"",confirmPassword:"",superadmin:1,starttime:void 0,endtime:void 0,effstarttime:void 0,effendtime:void 0,udesc:"",status:0}}const u=C(null);async function w(d,i){e.starttime=S(1,i[0]),e.endtime=S(1,i[1])}const q={username:H,usertype:{type:"number",required:!0,trigger:["blur","change"],message:o("page.manage.user.form.usertype")},password:k.pwd,confirmPassword:[{required:!0,message:o("form.confirmPwd.required")},{asyncValidator:(d,i)=>i.trim()!==""&&i!==e.password?Promise.reject(d.message):Promise.resolve(),message:o("form.confirmPwd.invalid"),trigger:"input"}],time:{required:!0,message:"请选择起止日期",asyncValidator:(d,i)=>{var N;return console.log(u.value,"asdasdasd"),((N=u.value)==null?void 0:N.length)>1?Promise.resolve():Promise.reject(d.message)},trigger:["blur","change"]},effstarttime:{type:"number",required:!0,message:o("page.manage.user.form.effstarttime"),trigger:["blur","change"]},effendtime:{type:"number",required:!0,message:o("page.manage.user.form.effendtime"),trigger:["blur","change"]}};function F(){if(Z(),u.value=null,Object.assign(e,_()),l.operateType==="edit"&&l.rowData){const d=JSON.parse(JSON.stringify(l.rowData));l.rowData.starttime=l.rowData.starttime?C(S(5,l.rowData.starttime)).value:void 0,l.rowData.endtime=l.rowData.endtime?C(S(5,l.rowData.endtime)).value:void 0,l.rowData.effstarttime=l.rowData.effstarttime&&d.starttime?C(S(5,d.starttime.substring(0,10)+" "+l.rowData.effstarttime)).value:void 0,l.rowData.effendtime=l.rowData.effendtime&&d.endtime?C(S(5,d.endtime.substring(0,10)+" "+l.rowData.effendtime)).value:void 0,u.value=l.rowData.starttime&&l.rowData.endtime?[new Date(l.rowData.starttime).getTime(),new Date(l.rowData.endtime).getTime()]:null,Object.assign(e,l.rowData)}}const I=C({}),Z=async()=>{const{data:d,error:i}=await ta();i||(I.value=d)};function A(){v.value=!1}async function J(){var $,p,K,L,W;if(await P(),e.effstarttime&&!e.effendtime)return($=window.$message)==null?void 0:$.error("有效结束时间不能为空");if(e.effendtime&&!e.effstarttime)return(p=window.$message)==null?void 0:p.error("有效开始时间不能为空");if(e.effstarttime&&e.effendtime&&e.effstarttime>e.effendtime)return(K=window.$message)==null?void 0:K.error("开始时间不能大于结束时间");let d=e.starttime?S(1,e.starttime):null,i=e.endtime?S(1,e.endtime):null,N=e.effstarttime?S(7,e.effstarttime):null,y=e.effendtime?S(7,e.effendtime):null,G=await de(e.password),R=await de(e.password);if(l.operateType==="add"){const{data:Y,error:O}=await He(e.username,e.usertype,G,d,i,N,y,e.status,e.superadmin,e.udesc);O||((L=window.$message)==null||L.success(o("common.addSuccess")),A(),D("submitted"))}else{const{data:Y,error:O}=await Je(l.rowData.id,e.username,e.usertype,R,G,d,i,N,y,e.status,e.superadmin,e.udesc);O||((W=window.$message)==null||W.success(o("common.updateSuccess")),A(),D("submitted"))}}return be(v,()=>{v.value&&(F(),V())}),(d,i)=>{const N=ce,y=Pe,G=Ne,R=sa,$=oa,p=fe,K=U,L=re,W=Me,Y=Be,O=z("no-space");return E(),X(Y,{show:v.value,"onUpdate:show":i[9]||(i[9]=j=>v.value=j),"display-directive":"show",width:500},{default:r(()=>[a(W,{title:g.value,"native-scrollbar":!1,closable:""},{footer:r(()=>[a(L,{size:16},{default:r(()=>[a(K,{onClick:A},{default:r(()=>[T(B(t(o)("common.cancel")),1)]),_:1}),a(K,{type:"primary",onClick:J},{default:r(()=>[T(B(t(o)("common.confirm")),1)]),_:1})]),_:1})]),default:r(()=>[a(p,{ref_key:"formRef",ref:f,model:e,rules:q,onKeyup:ke(J,["enter"])},{default:r(()=>{var j,ee,n;return[a(y,{label:t(o)("page.manage.user.username"),path:"username"},{default:r(()=>[M(a(N,{value:e.username,"onUpdate:value":i[0]||(i[0]=s=>e.username=s),disabled:l.operateType==="edit",placeholder:t(o)("page.manage.user.form.username")},null,8,["value","disabled","placeholder"]),[[O]])]),_:1},8,["label"]),l.operateType==="add"?(E(),X(y,{key:0,label:t(o)("page.login.common.password"),path:"password"},{default:r(()=>[a(N,{value:e.password,"onUpdate:value":i[1]||(i[1]=s=>e.password=s),type:"password","show-password-on":"click",minlength:6,maxlength:18,placeholder:t(o)("page.login.common.passwordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"])):ie("",!0),l.operateType==="add"?(E(),X(y,{key:1,label:t(o)("page.login.common.confirmPassword"),path:"confirmPassword"},{default:r(()=>[a(N,{value:e.confirmPassword,"onUpdate:value":i[2]||(i[2]=s=>e.confirmPassword=s),type:"password","show-password-on":"click",minlength:6,maxlength:18,placeholder:t(o)("page.login.common.confirmPasswordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"])):ie("",!0),l.operateType!=="edit"?(E(),X(y,{key:2,label:t(o)("page.manage.user.usertype"),path:"usertype"},{default:r(()=>[a(G,{filterable:"",value:e.usertype,"onUpdate:value":i[3]||(i[3]=s=>e.usertype=s),placeholder:t(o)("page.manage.user.form.usertype"),options:t(ue)(t(De)),style:{width:"100%"}},null,8,["value","placeholder","options"])]),_:1},8,["label"])):ie("",!0),a(y,{label:"起止日期",path:((j=I.value)==null?void 0:j.aceffective)==1?"time":""},{default:r(()=>[a(R,{value:u.value,"onUpdate:value":i[4]||(i[4]=s=>u.value=s),type:"datetimerange","value-format":"yyyy-MM-dd hh:mm:ss","onUpdate:formattedValue":w,style:{width:"100%"}},null,8,["value"])]),_:1},8,["path"]),a(y,{label:t(o)("page.manage.user.effstarttime"),path:((ee=I.value)==null?void 0:ee.aceffective)==1?"effstarttime":""},{default:r(()=>[a($,{value:e.effstarttime,"onUpdate:value":i[5]||(i[5]=s=>e.effstarttime=s),format:"HH:mm",style:{width:"100%"}},null,8,["value"])]),_:1},8,["label","path"]),a(y,{label:t(o)("page.manage.user.effendtime"),path:((n=I.value)==null?void 0:n.aceffective)==1?"effendtime":""},{default:r(()=>[a($,{value:e.effendtime,"onUpdate:value":i[6]||(i[6]=s=>e.effendtime=s),format:"HH:mm",style:{width:"100%"}},null,8,["value"])]),_:1},8,["label","path"]),a(y,{label:t(o)("page.manage.user.udesc"),path:"udesc"},{default:r(()=>[a(N,{value:e.udesc,"onUpdate:value":i[7]||(i[7]=s=>e.udesc=s),placeholder:t(o)("page.manage.user.form.udesc")},null,8,["value","placeholder"])]),_:1},8,["label"]),a(y,{label:t(o)("page.manage.user.status"),path:"status"},{default:r(()=>[a(G,{value:e.status,"onUpdate:value":i[8]||(i[8]=s=>e.status=s),placeholder:t(o)("page.manage.user.form.status"),options:t(ue)(t(aa)),style:{width:"100%"}},null,8,["value","placeholder","options"])]),_:1},8,["label"])]}),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),ca=ne({name:"UserSearch",__name:"user-search",props:{model:{required:!0},modelModifiers:{}},emits:oe(["reset","search"],["update:model"]),setup(h,{emit:b}){const l=b,{formRef:D,restoreValidation:v}=ye(),f=pe(h,"model");function P(){f.value.fuzzy="",l("search")}async function V(){await v(),l("reset")}async function x(){l("search")}return(H,k)=>{const g=Ne,e=la,_=ce,u=ra,w=U,q=na,F=re,I=ia,Z=fe,A=Ue,J=z("no-space");return E(),X(A,{bordered:!1,size:"small",class:"card-wrapper"},{default:r(()=>[a(Z,{ref_key:"formRef",ref:D,model:f.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:ke(x,["enter"])},{default:r(()=>[a(I,{responsive:"screen","item-responsive":""},{default:r(()=>[a(e,{span:"24 s:12 m:6",label:t(o)("page.manage.user.usertype"),path:"usertype",class:"pr-24px"},{default:r(()=>[a(g,{filterable:"",clearable:"",value:f.value.usertype,"onUpdate:value":[k[0]||(k[0]=d=>f.value.usertype=d),x],placeholder:t(o)("page.manage.user.form.usertype"),options:t(ue)(t(De))},null,8,["value","placeholder","options"])]),_:1},8,["label"]),a(e,{span:"24 s:12 m:6",label:t(o)("page.manage.user.username"),path:"username",class:"pr-24px"},{default:r(()=>[M(a(_,{clearable:"",value:f.value.fuzzy,"onUpdate:value":k[1]||(k[1]=d=>f.value.fuzzy=d),placeholder:t(o)("page.manage.user.form.username"),onClear:P},null,8,["value","placeholder"]),[[J]])]),_:1},8,["label"]),a(e,{span:"24 m:12",class:"pr-24px"},{default:r(()=>[a(F,{class:"w-full"},{default:r(()=>[a(w,{onClick:V},{icon:r(()=>[a(u,{class:"text-icon"})]),default:r(()=>[T(" "+B(t(o)("common.reset")),1)]),_:1}),a(w,{type:"primary",ghost:"",onClick:x},{icon:r(()=>[a(q,{class:"text-icon"})]),default:r(()=>[T(" "+B(t(o)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),fa=Ve("div",{class:"flex"},"设置用户角色",-1),ga=ne({name:"assignRoles",__name:"assign-roles",props:oe({rowObj:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:["update:visible"],setup(h){const b=h,l=pe(h,"visible");function D(){l.value=!1}const v=ge([]),f=async()=>{const{error:g,data:e}=await We();if(!g){const _=JSON.parse(JSON.stringify(e));v.value=_.list.map(u=>(u.rtype!=b.rowObj.usertype&&(u.disabled=!0),u.suffix=()=>qe(me,{text:!0,type:u.rtype==0?"success":u.rtype==1?"warning":"info",size:"small"},{default:()=>u.rtype==0?"管理员":u.rtype==1?"操作员":"审计员"}),u))}},P=ge([]);async function V(){if(b.rowObj.id){const{data:g,error:e}=await Ye(b.rowObj.id);e||(P.value=[g.roleId])}}const x=async(g,e,_)=>{var u;P.value=[(u=_.node)==null?void 0:u.id]};async function H(){var g,e,_;if(b.rowObj.id){const{data:u,error:w}=await Le(b.rowObj.id,P.value.join(","));w||((g=window.$message)==null||g.destroyAll(),(_=(e=window.$message)==null?void 0:e.success)==null||_.call(e,o("common.modifySuccess")),D())}}function k(){b.rowObj.id&&(f(),V())}return be(l,g=>{g&&k()}),(g,e)=>{const _=ua,u=U,w=re,q=xe;return E(),X(q,{show:l.value,"onUpdate:show":e[0]||(e[0]=F=>l.value=F),preset:"card",class:"w-480px"},{header:r(()=>[fa]),footer:r(()=>[a(w,{justify:"end"},{default:r(()=>[a(u,{size:"small",class:"mt-16px",onClick:D},{default:r(()=>[T(B(t(o)("common.cancel")),1)]),_:1}),a(u,{type:"primary",size:"small",class:"mt-16px",onClick:H},{default:r(()=>[T(B(t(o)("common.confirm")),1)]),_:1})]),_:1})]),default:r(()=>[a(_,{cascade:"","checked-keys":P.value,data:v.value,checkable:"","expand-on-click":"","virtual-scroll":"","block-line":"","label-field":"name","key-field":"id","children-field":"children","onUpdate:checkedKeys":x},null,8,["checked-keys","data"])]),_:1},8,["show"])}}}),_a={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function se(h){return typeof h=="function"||Object.prototype.toString.call(h)==="[object Object]"&&!Ge(h)}const Aa=ne({name:"manage_user",__name:"index",setup(h){const b=Fe(),{columns:l,columnChecks:D,data:v,getData:f,loading:P,mobilePagination:V,searchParams:x,resetSearchParams:H}=Ze({apiFn:Qe,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,usertype:null,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"username",title:o("page.manage.user.username"),align:"center",width:200},{key:"usertype",title:o("page.manage.user.usertype"),align:"center",width:140,render:n=>{n.usertype===void 0&&(n.usertype=0);const s={0:"primary",1:"primary",2:"primary"},c=o(Ie[n.usertype]);return a(me,{type:s[n.usertype]},se(c)?c:{default:()=>[c]})}},{key:"udesc",title:"用户描述",align:"center",width:180,ellipsis:!0},{key:"createdate",title:o("page.manage.user.createDate"),align:"center",width:180},{key:"status",title:o("page.manage.user.status"),align:"center",width:100,render:n=>{n.status===null&&(n.status=0);const s={0:"success",1:"error",2:"warning"},c=n.status==0?"正常":n.status==1?"异常":"锁定";return a(me,{type:s[n.status]},se(c)?c:{default:()=>[c]})}},{key:"operate",title:o("common.operate"),align:"center",width:400,fixed:"right",render:n=>{let s;return n.superadmin!=0?a("div",{class:"flex-center gap-8px"},[M(a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>i(n.id)},se(s=o("common.edit"))?s:{default:()=>[s]}),[[z("no-auth"),"sys:user:update"]]),M(a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>ee(n)},{default:()=>["分配角色"]}),[[z("no-auth"),"sys:user:updateRoleUser"]]),n.status==0&&M(a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>J(n.id)},{default:()=>["锁定"]}),[[z("no-auth"),"sys:user:update"]]),n.status==2&&M(a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>A(n.id)},{default:()=>["解锁"]}),[[z("no-auth"),"sys:user:update"]]),M(a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>L(n)},{default:()=>["修改密码"]}),[[z("no-auth"),"sys:user:update"]]),a(da,{onPositiveClick:()=>d(n.id)},{default:()=>o("common.confirmDelete"),trigger:()=>{let c;return M(a(U,{type:"error",ghost:!0,size:"small"},se(c=o("common.delete"))?c:{default:()=>[c]}),[[z("no-auth"),"sys:user:delete"]])}})]):a("span",{class:"c-#a4b0be"},[T("系统用户不允许操作")])}}]}),{drawerVisible:k,operateType:g,editingData:e,handleAdd:_,handleEdit:u,checkedRowKeys:w,onBatchDeleted:q,onDeleted:F,closeDrawer:I}=ea(v,f);async function Z(){console.log(w.value),Y(w.value,n=>{q()})}const A=async n=>{var s;await _e({id:n,status:0}),(s=window.$message)==null||s.success("解锁成功"),f()},J=async n=>{var s;await _e({id:n,status:2}),(s=window.$message)==null||s.success("锁定成功"),f()};function d(n){console.log(n),Y([n],s=>{F()})}function i(n){u(n)}const{createConfirmPwdRule:N,defaultRequiredRule:y,patternRules:G}=ve(),R=C(!1),$=C(),p=he({username:"",password:"",confirmPassword:"",id:null}),K={password:[y,G.password],confirmPassword:[{required:!0,message:o("form.confirmPwd.required")},{asyncValidator:(n,s)=>s.trim()!==""&&s!==p.password?Promise.reject(n.message):Promise.resolve(),message:o("form.confirmPwd.invalid"),trigger:"input"}]},L=n=>{R.value=!0,p.id=n.id,p.username=n.username,p.password="",p.confirmPassword=""},W=async()=>{var ae,Q;if(!p.id)return;await((ae=$.value)==null?void 0:ae.validate());const n=await de(p.password),{data:s,error:c}=await Ke(p.id,n);c||((Q=window.$message)==null||Q.success("修改成功"),R.value=!1)};async function Y(n,s){const c=await Xe(n);console.log("data",c),s&&s(c)}const O=C(),j=C(!1),ee=n=>{O.value=n,j.value=!0};return(n,s)=>{const c=je,ae=ma,Q=ce,le=Pe,Se=fe,Ce=Ee,Re=re,Te=xe,$e=Ue;return E(),Ae("div",_a,[a(ca,{model:t(x),"onUpdate:model":s[0]||(s[0]=m=>te(x)?x.value=m:null),onReset:t(H),onSearch:t(f)},null,8,["model","onReset","onSearch"]),a($e,{title:t(o)("page.manage.user.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":r(()=>[a(c,{columns:t(D),"onUpdate:columns":s[1]||(s[1]=m=>te(D)?D.value=m:null),"disabled-delete":t(w).length===0,loading:t(P),onAdd:t(_),onDelete:Z,onRefresh:t(f),"is-view-add-button":t(we)("sys:user:insert"),"is-view-delete-button":t(we)("sys:user:delete")},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","is-view-delete-button"])]),default:r(()=>[a(ae,{"checked-row-keys":t(w),"onUpdate:checkedRowKeys":s[2]||(s[2]=m=>te(w)?w.value=m:null),columns:t(l),data:t(v),size:"small","flex-height":!t(b).isMobile,"scroll-x":t(l).reduce((m,Oe)=>m+Oe.width,0),loading:t(P),remote:"","row-key":m=>m.id,pagination:t(V),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),a(pa,{visible:t(k),"onUpdate:visible":s[3]||(s[3]=m=>te(k)?k.value=m:null),"operate-type":t(g),"row-data":t(e),onSubmitted:t(f)},null,8,["visible","operate-type","row-data","onSubmitted"]),a(ga,{rowObj:O.value,visible:j.value,"onUpdate:visible":s[4]||(s[4]=m=>j.value=m)},null,8,["rowObj","visible"]),a(Te,{show:R.value,"onUpdate:show":s[9]||(s[9]=m=>R.value=m),title:t(o)("common.updatePassword"),preset:"card",class:"w-620px"},{footer:r(()=>[a(Re,{justify:"end",size:16},{default:r(()=>[a(t(U),{onClick:s[8]||(s[8]=m=>R.value=!1)},{default:r(()=>[T(B(t(o)("common.cancel")),1)]),_:1}),a(t(U),{type:"primary",onClick:W},{default:r(()=>[T(B(t(o)("common.confirm")),1)]),_:1})]),_:1})]),default:r(()=>[a(Ce,{class:"max-h-480px pr-20px"},{default:r(()=>[a(Se,{ref_key:"formRef",ref:$,model:p,rules:K,"label-placement":"left","label-width":100,"require-mark-placement":"left"},{default:r(()=>[a(le,{label:t(o)("page.manage.user.username"),path:"username"},{default:r(()=>[a(Q,{readonly:"",value:p.username,"onUpdate:value":s[5]||(s[5]=m=>p.username=m),placeholder:t(o)("page.manage.user.form.username")},null,8,["value","placeholder"])]),_:1},8,["label"]),a(le,{label:t(o)("page.login.common.password"),path:"password"},{default:r(()=>[a(Q,{type:"password","show-password-on":"click",clearable:"",value:p.password,"onUpdate:value":s[6]||(s[6]=m=>p.password=m),placeholder:t(o)("page.login.common.passwordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"]),a(le,{label:t(o)("page.login.common.confirmPassword"),path:"confirmPassword"},{default:r(()=>[a(Q,{type:"password","show-password-on":"click",clearable:"",value:p.confirmPassword,"onUpdate:value":s[7]||(s[7]=m=>p.confirmPassword=m),placeholder:t(o)("page.login.common.confirmPasswordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])]),_:1},8,["title"])])}}});export{Aa as default};
