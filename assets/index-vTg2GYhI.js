import{_ as ie}from"./round-search-7wOoFfG_.js";import{d as ee,r as w,a as U,a1 as te,i as ae,cz as ue,b as D,o as h,e as y,y as N,a5 as ne,a4 as le,g as B,t as W,c1 as ce,bl as de,V as ve,bp as me,ac as oe,L as pe,a8 as Q,d_ as fe,d$ as ye,f as p,w as _,c as O,h as f,av as he,N as ge,aa as Z,B as be,$ as ke,U as we}from"./index-Di8oPgLW.js";import{d as Fe}from"./home-BsRhNkn7.js";import{N as q}from"./RadioButton-oDiG68o0.js";import{N as G}from"./DatePicker-DiKwrnFI.js";const xe={class:"map-wrapper",style:{height:"100%",position:"relative"}},De={class:"map-legend"},Te={class:"legend-list"},Me=["onClick","onContextmenu"],Ce={key:0,class:"visibility-icon"},_e={key:1,class:"solo-icon"},$e={class:"legend-name"},Ee={class:"visibility-toggle"},Ae={key:0,class:"solo-notice"},Se=ee({__name:"historyMap",props:{trackData:{}},setup(J){const v=w(null);let $=null;const I=J,T=w([]),d=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],t=w({}),g=w(""),E=U(()=>{const e={};return Object.keys(T.value).forEach((r,n)=>{e[r]=d[n%d.length],t.value[r]===void 0&&(t.value[r]=!0)}),e});function M(e){if(g.value){L(e);return}t.value[e]=!t.value[e],i()}function L(e){g.value===e?j():(g.value=e,Object.keys(t.value).forEach(l=>{t.value[l]=l===e}),i())}function j(){g.value="",Object.keys(t.value).forEach(e=>{t.value[e]=!0}),i()}function z(){Object.keys(t.value).forEach(e=>{t.value[e]=!t.value[e]}),g.value="",i()}function R(){Object.keys(t.value).forEach(e=>{t.value[e]=!0}),g.value="",i()}function Y(){Object.keys(t.value).forEach(e=>{t.value[e]=!1}),g.value="",i()}const A=U(()=>{const e=[];return Object.values(T.value).forEach(l=>{e.push(...l)}),e.sort((l,r)=>new Date(l.dbtime).getTime()-new Date(r.dbtime).getTime())}),H=U(()=>{if(A.value.length===0)return[120.370086,30.305716];const e=A.value.map(u=>u.longitude),l=A.value.map(u=>u.latitude),r=(Math.min(...e)+Math.max(...e))/2,n=(Math.min(...l)+Math.max(...l))/2;return[r,n]});async function P(){const e="/map-sdk.json",{data:l}=await me.get(`${e}?_t=${Date.now()}`);return l}function V(e){return new Promise((l,r)=>{if(window.AMap)return l(window.AMap);const n=document.createElement("script");n.src=`https://webapi.amap.com/maps?v=2.0&key=${e}&plugin=AMap.PolylineEditor`,n.defer=!0,n.onload=()=>window.AMap?l(window.AMap):r(new Error("AMapåŠ è½½å¤±è´¥")),n.onerror=()=>r(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(n)})}const b=w({});function a(e,l){const r=l.lng-e.lng,n=l.lat-e.lat;return Math.atan2(n,r)*180/Math.PI}function o(e,l,r,n,u){const F=`
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                background: white; border-radius: 50%; width: 20px; height: 20px; 
                display: flex; align-items: center; justify-content: center; 
                font-size: 10px; font-weight: bold; color: ${n}; border: 2px solid ${n};">
      ${u}
    </div>
  `,c=document.createElement("div");return c.style.cssText=`
    position: relative;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  `,c.innerHTML=F,new e.Marker({position:[l.lng,l.lat],content:c,offset:new e.Pixel(-10,-10)})}function m(e,l,r,n){const u=document.createElement("div");return u.className="custom-marker",u.style.transform="translateX(-50%)",u.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${n}; box-shadow: 0 0 10px ${n}, 0 0 20px ${n};">
      <img src="https://pictures.linkqi.cn/work-project/image/cf69b543-f6b7-44e2-a3d0-a28f56fc9cb98962888825725658039.png?Avatar.png" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${n};">${r}</div>
  `,new e.Marker({position:[l.lng,l.lat],content:u})}function s(){v.value&&v.value.clearMap(),b.value={}}function i(){!window.AMap||!v.value||Object.keys(b.value).forEach(e=>{const l=t.value[e];(b.value[e]||[]).forEach(n=>{l?n.show():n.hide()})})}function S(e){s();const l={};Object.entries(T.value).forEach(([r,n])=>{l[r]=n.map(u=>({lng:u.longitude,lat:u.latitude,address:u.address,dbtime:u.dbtime,proname:u.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:u.duration||0}))}),Object.keys(l).forEach(r=>{const n=l[r],u=E.value[r];if(n.length===0)return;const F=[];if(n.length>1){const c=new e.Polyline({path:n.map(x=>[x.lng,x.lat]),strokeColor:u,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});c.setMap(v.value),F.push(c)}if(n.forEach((c,x)=>{const k=m(e,c,r,u);k.setMap(v.value),F.push(k),k.on("click",()=>{const K=`
          <div style="min-width:200px; padding: 8px;">
            <div style="font-weight: bold; margin-bottom: 8px; color: ${u};">${r}</div>
            <div><b>åœ°ç‚¹ï¼š</b> ${c.address}</div>
            <div><b>æ—¶é—´ï¼š</b> ${c.dbtime}</div>
            <div><b>é¡¹ç›®ï¼š</b> ${c.proname}</div>
            ${c.duration?`<div><b>å·¥æ—¶ï¼š</b> ${c.duration}å°æ—¶</div>`:""}
            <div style="margin-top: 6px; color: #666; font-size: 12px;">ç¬¬${x+1}ä¸ªè½¨è¿¹ç‚¹</div>
          </div>
        `;$.setContent(K),$.open(v.value,k.getPosition())}),k.on("dblclick",()=>{$.open(v.value,k.getPosition()),v.value.setCenter(k.getPosition())})}),n.length>1)for(let c=1;c<n.length;c++){const x=n[c-1],k=n[c],K=(x.lng+k.lng)/2,se=(x.lat+k.lat)/2,re=a(x,k),X=o(e,{lng:K,lat:se},re,u,c);X.setMap(v.value),F.push(X)}b.value[r]=F}),i()}async function C(){try{const e=await P(),l=await V(e.AMAP_SDK_KEY);v.value=new l.Map("amap-container",{viewMode:"2D",zoom:12,center:H.value,features:["bg","point"]}),$=new l.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),S(l)}catch(e){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",e)}}return te(()=>I.trackData??[],e=>{console.log(e,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),T.value=e,window.AMap&&v.value&&S(window.AMap)},{immediate:!0,deep:!0}),ae(()=>{C()}),ue(()=>{v.value&&v.value.destroy()}),(e,l)=>(h(),D("div",xe,[l[1]||(l[1]=y("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),y("div",De,[y("div",{class:"legend-header"},[l[0]||(l[0]=y("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),y("div",{class:"legend-actions"},[y("button",{class:"action-btn",onClick:R},"å…¨æ˜¾"),y("button",{class:"action-btn",onClick:Y},"å…¨éš"),y("button",{class:"action-btn",onClick:z},"åé€‰")])]),y("div",Te,[(h(!0),D(ne,null,le(E.value,(r,n)=>(h(),D("div",{key:n,class:de(["legend-item",{"legend-item-hidden":!t.value[n],"legend-item-solo":g.value===n}]),onClick:u=>M(n),onContextmenu:ce(u=>L(n),["prevent"])},[y("div",{class:"legend-color",style:ve({backgroundColor:r})},[t.value[n]?N("",!0):(h(),D("span",Ce,"ğŸ‘ï¸â€ğŸ—¨ï¸")),g.value===n?(h(),D("span",_e,"â­")):N("",!0)],4),y("span",$e,W(n),1),y("span",Ee,W(t.value[n]?"éšè—":"æ˜¾ç¤º"),1)],42,Me))),128))]),g.value?(h(),D("div",Ae,[B(" ä»…æ˜¾ç¤º: "+W(g.value)+" ",1),y("button",{class:"cancel-solo-btn",onClick:j},"å–æ¶ˆ")])):N("",!0)])]))}}),Oe=oe(Se,[["__scopeId","data-v-d2665196"]]),Be={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ne=ee({name:"trajectory_historytrajectory",__name:"index",setup(J){const v=pe();function $(a){const o=new Date(a.getFullYear(),0,1),m=Math.floor((a.getTime()-o.getTime())/(24*60*60*1e3));return Math.ceil((m+1)/7).toString().padStart(2,"0")}function I(a){return a.getFullYear().toString()}function T(){const a=new Date,o=I(a),m=$(a);return`${o}-${m}å‘¨`}const d=w("week"),t=w({dayTime:String(Q(0,null)),monthTime:String(Q(3,null)),weekTime:T(),startTime:null,endTime:null,dates:null}),g=w([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),E=w("table"),M=w({}),L=U(()=>Object.keys(M.value||{}).map(a=>({key:a,name:a}))),j=U(()=>{const a=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left"}];let o=[];switch(d.value){case"week":t.value.startTime&&t.value.endTime&&(o=ye(t.value.startTime,t.value.endTime).map(s=>z(s)));break;case"month":t.value.monthTime&&(o=fe(t.value.monthTime).map(s=>z(s)));break;case"day":default:t.value.dayTime&&(o=[z(t.value.dayTime)]);break}return[...a,...o]}),z=a=>({title:R(a),key:a,width:200,align:"center",render:o=>Y(o.name,a)}),R=a=>{const o=new Date(a),m=o.getMonth()+1,s=o.getDate(),i=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][o.getDay()];return`${m}/${s} å‘¨${i}`},Y=(a,o)=>{const s=(M.value[a]||[]).filter(i=>i.daytime===o);return s.length===0?p("div",{class:"text-gray-400 text-sm"},[B("æ— è®°å½•")]):p("div",{class:"text-left space-y-1"},[s.map((i,S)=>p("div",{key:S,class:"p-1 border-b border-gray-100 last:border-b-0"},[p("div",{class:"font-medium text-blue-600"},[i.proname]),p("div",{class:"text-xs text-gray-600"},[B("ğŸ“ "),i.address]),p("div",{class:"text-xs text-gray-500"},[B("ğŸ•’ "),i.dbtime]),p("div",{class:"text-xs text-green-600 font-bold"},[B("â±ï¸ "),i.duration?i.duration+"å°æ—¶":"æ— "])]))])},A=a=>{const o=a.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!o)return null;const m=Number(o[1]),s=Number(o[2]),i=new Date(m,0,1+(s-1)*7),S=i.getDay(),C=new Date(i);S<=4?C.setDate(i.getDate()-i.getDay()+1):C.setDate(i.getDate()+8-i.getDay());const e=new Date(C);e.setDate(C.getDate()+6);const l=r=>{const n=r.getFullYear(),u=String(r.getMonth()+1).padStart(2,"0"),F=String(r.getDate()).padStart(2,"0");return`${n}-${u}-${F}`};return{start:l(C),end:l(e)}},H=a=>{M.value={},d.value=a,V()},P=a=>{V(a),b()},V=a=>{switch(d.value){case"week":if(a){const o=A(a);o&&(t.value.startTime=o.start,t.value.endTime=o.end)}break;case"month":t.value.dates=a||t.value.monthTime;break;case"day":default:t.value.dates=a||t.value.dayTime;break}},b=async()=>{try{const a={};d.value==="week"?(a.startTime=t.value.startTime,a.endTime=t.value.endTime):d.value==="month"?a.dates=t.value.monthTime:a.dates=t.value.dayTime;const{data:o,error:m}=await Fe(a);m||(M.value=o)}catch(a){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",a)}};return te([d,()=>t.value.dates],()=>{if(d.value=="week"&&t.value.weekTime){const a=A(t.value.weekTime);a&&(t.value.startTime=a.start,t.value.endTime=a.end),b()}else(d.value=="month"&&t.value.monthTime||d.value=="day"&&t.value.dayTime)&&b()},{immediate:!0}),ae(()=>{t.value.weekTime=T(),b()}),(a,o)=>{const m=ie;return h(),D("div",Be,[p(f(we),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:_(()=>[p(f(ge),{align:"center"},{default:_(()=>[o[5]||(o[5]=y("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),p(f(Z),{value:d.value,"onUpdate:value":[o[0]||(o[0]=s=>d.value=s),H],size:"small"},{default:_(()=>[(h(!0),D(ne,null,le(g.value,s=>(h(),O(f(q),{key:s.value,value:s.value,label:s.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),d.value==="day"?(h(),O(f(G),{key:0,size:"small","formatted-value":t.value.dayTime,"onUpdate:formattedValue":[o[1]||(o[1]=s=>t.value.dayTime=s),P],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):N("",!0),d.value==="week"?(h(),O(f(G),{key:1,size:"small","formatted-value":t.value.weekTime,"onUpdate:formattedValue":[o[2]||(o[2]=s=>t.value.weekTime=s),P],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):N("",!0),d.value==="month"?(h(),O(f(G),{key:2,size:"small","formatted-value":t.value.monthTime,"onUpdate:formattedValue":[o[3]||(o[3]=s=>t.value.monthTime=s),P],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):N("",!0),p(f(be),{type:"primary",onClick:b,size:"small",class:"w-full sm:w-auto"},{icon:_(()=>[p(m,{class:"text-icon"})]),default:_(()=>[B(" "+W(f(ke)("common.search")),1)]),_:1}),p(f(Z),{size:"small",value:E.value,"onUpdate:value":o[4]||(o[4]=s=>E.value=s),name:"radiobuttongroup1"},{default:_(()=>[p(f(q),{value:"table",label:"è¡¨æ ¼"}),p(f(q),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[5]})]),default:_(()=>[E.value=="table"?(h(),O(f(he),{key:0,columns:j.value,data:L.value,size:"small","flex-height":!f(v).isMobile,"scroll-x":j.value.reduce((s,i)=>s+i.width,0),"max-height":f(v).isMobile?400:600,remote:"","row-key":s=>s.key,class:"sm:h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","max-height","row-key"])):(h(),O(Oe,{key:1,trackData:M.value},null,8,["trackData"]))]),_:1})])}}}),Ve=oe(Ne,[["__scopeId","data-v-76a48c0b"]]);export{Ve as default};
