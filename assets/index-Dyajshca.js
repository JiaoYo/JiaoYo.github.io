import{_ as da,a as ca,V as Ma,b as Ia,c as Oa,d as qa,e as Ra,f as Ha,g as Ja}from"./index-Bxx-_JhL.js";import{_ as pa}from"./round-plus-C1IOaOCW.js";import{aX as pe,R as fa,b as O,o as T,e as M,d as _t,z as kt,s as b,F as yt,aP as et,c as ke,G as W,f as s,I as lt,t as ne,w as p,g as P,h as S,B as z,ay as nt,a4 as xt,M as ga,N as Ut,H as ie,aA as Ot,J as Pe,az as ht,$ as te,aN as Ga,n as a,aG as tt,dm as Ka,W as va,av as ft,A as Gt,a as Kt,ax as Wt,at as Xt,au as je,K as ia,a5 as pt,aS as Je,cy as ma,aT as ya,aE as Xe,bg as ha,cZ as ba,cQ as _a,fc as ka,cC as Wa,aK as sa,i as xa,d4 as Xa,dq as Ya,D as ot,bp as Za,S as Qa,fd as el,aJ as tl,X as al,Y as ll,dy as nl,d0 as il,cE as oa,dB as sl,da as Tt,a2 as ol,a$ as ra,b3 as rl,aM as ul,a7 as qt,dD as dl,a3 as cl}from"./index-CYM7WsrU.js";import{u as Ge}from"./usePageData-DZmITRE8.js";import{h as We}from"./permission-CMBcp-KE.js";import{N as rt}from"./Popconfirm-C8JWPuCK.js";import{_ as bt}from"./DatePicker-kRu-lJ01.js";import{N as Rt}from"./Cascader-CshNhxHg.js";import{_ as pl,a as fl,A as gl}from"./index-CRUsD1CH.js";import{g as vl}from"./business-Djf4miNR.js";import{_ as ml}from"./Grid-XBh6Ijop.js";import{_ as yl}from"./FormItemGridItem-DU6pdzl5.js";function Wn(w){return pe({url:"/projectForm/getPage.do",method:"get",params:w})}function hl(w){return pe({url:"/projectForm/insert.do",method:"post",data:w})}function bl(w){return pe({url:"/projectForm/update.do",method:"put",data:w})}function Xn(w){return pe({url:"/projectForm/delete.do",method:"delete",params:{arrIds:w}})}function _l(w){return pe({url:"/projectForm/getById.do",method:"get",params:{id:w}})}function kl(w){return pe({url:"/projectForm/getIdByProId.do",method:"get",params:{proId:w}})}function xl(w){return pe({url:"/projectForm/getProjectPage.do",method:"get",params:w})}function Ht(w){return pe({url:"/projectFormContact/getPage.do",method:"get",params:w})}function Ll(w){return pe({url:"/projectFormContact/insert.do",method:"post",data:w})}function Sl(w){return pe({url:"/projectFormContact/update.do",method:"put",data:w})}function Dl(w){return pe({url:"/projectFormContact/delete.do",method:"delete",params:{arrIds:w}})}function Jt(w){return pe({url:"/projectFormEquipment/getPage.do",method:"get",params:w})}function La(w){return pe({url:"/projectFormEquipment/insert.do",method:"post",data:w})}function Cl(w){return pe({url:"/projectFormEquipment/update.do",method:"put",data:w})}function wl(w){return console.log(w),pe({url:"/projectFormEquipment/delete.do",method:"delete",params:{arrIds:w}})}function Fl(w){return pe({url:"/projectFormDebug/getPage.do",method:"get",params:w})}function Sa(w){return pe({url:"/projectFormDebug/insert.do",method:"post",data:w})}function $l(w){return pe({url:"/projectFormDebug/update.do",method:"put",data:w})}function Tl(w){return pe({url:"/projectFormDebug/delete.do",method:"delete",params:{arrIds:w}})}function Ul(w){return pe({url:"/projectFormFile/getPage.do",method:"get",params:w})}function zl(w){return pe({url:"/projectFormFile/insert.do",method:"post",data:w})}function jl(w){return pe({url:"/projectFormFile/update.do",method:"put",data:w})}function Pl(w){return pe({url:"/projectFormFile/delete.do",method:"delete",params:{arrIds:w}})}const Bl={class:"inline-block",viewBox:"0 0 24 24",width:"1em",height:"1em"};function Nl(w,$e){return T(),O("svg",Bl,$e[0]||($e[0]=[M("path",{fill:"currentColor",d:"M21 7v14H3V3h14zm-2 .85L16.15 5H5v14h14zM12 18q1.25 0 2.125-.875T15 15t-.875-2.125T12 12t-2.125.875T9 15t.875 2.125T12 18m-6-8h9V6H6zM5 7.85V19V5z"},null,-1)]))}const El=fa({name:"material-symbols-save-outline-sharp",render:Nl}),Vl={class:"inline-block",viewBox:"0 0 14 14",width:"1em",height:"1em"};function Al(w,$e){return T(),O("svg",Vl,$e[0]||($e[0]=[M("path",{fill:"currentColor","fill-rule":"evenodd",d:"M6.545.998a1 1 0 0 0 0 2h2.728a2.638 2.638 0 0 1 0 5.275H4.817V6.545a1 1 0 0 0-1.707-.707L.384 8.564a1 1 0 0 0-.22 1.09q.073.18.218.327l2.728 2.728a1 1 0 0 0 1.707-.707v-1.729h4.456a4.638 4.638 0 1 0 0-9.275z","clip-rule":"evenodd"},null,-1)]))}const Ml=fa({name:"streamline-return2-solid",render:Al}),Il={class:"flex items-center justify-between"},Ol={class:"flex items-center"},ql={style:{margin:"10px 0","font-weight":"bolder",width:"140px"}},Rl={key:0,class:"font-size-12px c-#ffa502 ml-10px"},Hl={key:0},Jl={style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},Gl={key:0},Kl={style:{display:"flex","justify-content":"space-between"}},Wl={key:3},Xl=["src"],Yl=_t({__name:"fileList",props:{pid:{},data:{},fileType:{},typename:{},operateType:{}},emits:["getData","myClick","submittedData","removeData"],setup(w,{emit:$e}){const ae=w,X=kt(),Le=$e,h=[{title:"文件别名",key:"name",align:"center",width:200,ellipsis:{tooltip:!0}},{title:"文件名称",key:"filename",align:"center",width:200,ellipsis:{tooltip:!0}},{title:"上传人",key:"creator",align:"center",width:100},{title:"上传时间",key:"dbtime",align:"center",width:200},{title:"操作",key:"actions",align:"center",width:180,render(r,c){return a(Pe,{justify:"center"},[r.id&&a(z,{type:"info",size:"small",ghost:!0,onClick:()=>{Ye(r)}},{default:()=>"查看"}),r.id&&a(z,{type:"info",size:"small",ghost:!0,onClick:()=>{Oe(r)}},{default:()=>"下载"}),r.id&&We("project:form:File:update")&&a(z,{type:"info",size:"small",ghost:!0,onClick:()=>{A(r)}},{default:()=>"编辑"}),We("project:form:File:delete")&&X.userInfo.usertype==0&&a(rt,{onPositiveClick:async()=>{var f;if(r.id){const{data:C,error:l}=await Ka(r.url),{data:u,error:v}=await Pl(r.id);v||((f=window.$message)==null||f.success("删除成功"),Le("getData"))}else Le("removeData",{index:c,fileType:ae.fileType})}},{default:()=>te("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>te("common.delete")})})])}}];async function Ce(r){var c;return r.file.file.size>100*1024*1024?((c=window.$message)==null||c.error("文件大小不能超过100M"),!1):!0}const Y=b(!1),E=b(null),ee=b({fileName:"",file:null,id:void 0}),Ve={fileName:[{required:!0,message:"请输入文件别名",trigger:["blur","change"]}]},m=b(0),Ke=()=>{Le("myClick"),q.value=[],Y.value=!0,m.value=0,ee.value.id=void 0,ee.value.fileName="",ee.value.file=null},Ae=async()=>{var r,c,f,C;try{if(await((r=E.value)==null?void 0:r.validate()),ee.value.id){const{data:l,error:u}=await jl([{id:ee.value.id,filename:ee.value.fileName}]);if(u)return(c=window.$message)==null?void 0:c.error("保存文件记录失败");(f=window.$message)==null||f.destroyAll(),(C=window.$message)==null||C.success("编辑成功"),Le("getData"),xe.value=!1;return}}catch{xe.value=!1}};async function Oe(r){if(r!=null&&r.url)try{const f=await(await fetch(r.url,{mode:"cors"})).blob(),C=URL.createObjectURL(f),l=document.createElement("a");l.href=C,l.download=r.filename,l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(C)}catch(c){console.error("下载失败:",c)}}const qe=()=>{console.log("渲染完成")},he=r=>{console.log(r,"渲染失败")},d=b(!1),oe=b(""),Z=b([]),J=b(""),Be=b("预览文件"),be=b(!1),we=b(0),Ye=r=>{var f,C;if(!(r!=null&&r.url))return;const c=(f=r.filename.split(".").pop())==null?void 0:f.toLowerCase();if(oe.value=r.url,Be.value=r.filename,["xls","xlsx"].includes(c))J.value="xls";else if(["doc","docx"].includes(c))J.value="doc";else if(["pdf"].includes(c))J.value="pdf";else if(["png","jpg","jpeg","gif","bmp"].includes(c)){J.value="img",Z.value=ae.data.map(u=>{var v;return["png","jpg","jpeg","gif","bmp"].includes((v=u.filename.split(".").pop())==null?void 0:v.toLowerCase())?u.url:""}).filter(u=>u!=="");const l=Z.value.findIndex(u=>u===r.url);we.value=l,be.value=!0;return}else if(["mp4"].includes(c))J.value="mp4";else{(C=window.$message)==null||C.warning("暂不支持该文件类型预览");return}d.value=!0},Fe=b(45),Se=()=>{Fe.value==45?Fe.value=350:Fe.value=45},xe=b(!1);function A(r){ee.value.id=r.id,ee.value.fileName=r.name,xe.value=!0}const Te=()=>{xe.value=!1};function Ne(r){return r.replace(/\.[^/.]+$/,"")}const ye=[{title:"文件名称",key:"filename",align:"center",render(r){if(!r.name){const c=async({file:C,onFinish:l,onError:u})=>{var v,F;try{r.status=!0;const D=await tt(C.file,C.name,"",U=>{r.progress=U});D&&(r.url=D,r.name=C.name,r.status=!1)}catch(D){console.error(D),(F=(v=window.$message)==null?void 0:v.error)==null||F.call(v,"文件上传出错"),r.status=!1}};async function f(C){var l;return C.file.file.size>100*1024*1024?((l=window.$message)==null||l.error("文件大小不能超过100M"),!1):!0}return a("div",{style:"display: flex; justify-content: center; align-items: center;"},[a(ht,{action:"#",showFileList:!1,customRequest:c,onBeforeUpload:f},{default:()=>a(z,{type:"info",size:"small",ghost:!0,loading:r.status},{default:()=>"上传文件"})}),r.progress?a(Ot,{type:"line",percentage:r.progress,indicatorPlacement:"inside",processing:!0}):null])}return a("div",{},r.name)}},{title:"文件别名",key:"filename",align:"center",render(r){return a(ie,{value:r.filename??Ne(r.name)??"",onUpdateValue:c=>{r.filename=c}})}},{title:"操作",key:"actions",align:"center",width:100,render(r){return a(Pe,{justify:"center"},[a(z,{type:"error",size:"small",ghost:!0,onClick:()=>{q.value=q.value.filter(c=>c!==r)}},{default:()=>"删除"})])}}],q=b([]),ve=b(0),Ue=b(!1),n=async()=>{var r,c,f,C,l,u,v,F;for(let D=0;D<q.value.length;D++){const U=q.value[D];if(!U.name||U.name.toString().trim()===""){(r=window.$message)==null||r.warning(`第 ${D+1} 个文件的文件名称不能为空`);return}if(!U.filename||U.filename.toString().trim()===""){(c=window.$message)==null||c.warning(`第 ${D+1} 个文件的文件别名不能为空`);return}}try{if(Ue.value=!0,ae.operateType==="edit"){const D=q.value.length;for(let V=0;V<D;V++){ve.value=V;const R=q.value[V];R.indexText=`${V+1}/${D}`,R.progress=0,R.status="uploading";try{R.url=await tt(R.file,R.name,"",de=>{R.progress=de}),R.progress=100,R.status="done"}catch{R.status="error",(C=(f=window.$message)==null?void 0:f.error)==null||C.call(f,`第 ${V+1} 个文件上传失败，请重试`);return}}const U=q.value.map(V=>({file:V.url,filename:V.filename,pid:ae.pid,sort:ae.fileType})),{error:x}=await zl(U);if(x){(u=(l=window.$message)==null?void 0:l.error)==null||u.call(l,"保存文件记录失败");return}Le("getData"),(v=window.$message)==null||v.destroyAll(),(F=window.$message)==null||F.success("上传成功"),Y.value=!1}else{const D=q.value.map(U=>({file:U.file,filename:U.name,name:U.filename,sort:ae.fileType}));Le("submittedData",{row:D,fileType:ae.fileType}),Y.value=!1}}finally{Ue.value=!1}},y=()=>{Y.value=!1};function _(r){r.fileList.forEach(c=>{c.filename||(c.filename=Ne(c.name))}),q.value=r.fileList}return(r,c)=>{const f=pa,C=da,l=ca,u=Ut,v=ga,F=xt,D=Ga,U=yt("no-auth");return T(),O(et,null,[M("div",Il,[M("div",Ol,[M("h2",ql,ne(ae.typename),1),lt((T(),ke(S(z),{size:"small",ghost:"",type:"primary",onClick:Ke},{icon:p(()=>[s(f,{class:"text-icon"})]),default:p(()=>[P(" 新增"+ne(ae.typename),1)]),_:1})),[[U,"project:form:File:insert"]]),ae.fileType==4?(T(),O("span",Rl,"照片数不少于6张")):W("",!0)]),ae.data.length>0?(T(),O("div",Hl,"共"+ne(ae.data.length)+"条",1)):W("",!0)]),ae.data.length>0?(T(),ke(S(nt),{key:0,columns:h,data:ae.data,size:"small","scroll-x":702,"row-key":x=>x.id,"max-height":Fe.value},null,8,["data","row-key","max-height"])):W("",!0),M("div",Jl,[Fe.value==45&&ae.data.length>1?(T(),O("span",{key:0,onClick:Se},[c[7]||(c[7]=P(" 更多 ")),s(C,{class:"font-size-20px"})])):W("",!0),Fe.value==350&&ae.data.length>1?(T(),O("span",{key:1,onClick:Se},[c[8]||(c[8]=P(" 收起 ")),s(l,{class:"font-size-20px"})])):W("",!0)]),s(F,{show:xe.value,"onUpdate:show":c[1]||(c[1]=x=>xe.value=x),title:(ee.value.id?"编辑":"新增")+ae.typename,preset:"card",class:"w-700px"},{default:p(()=>[s(v,{ref_key:"formRef",ref:E,model:ee.value,rules:Ve,"label-width":"auto",style:{width:"100%"}},{default:p(()=>[s(u,{label:"文件别名",path:"fileName"},{default:p(()=>[s(S(ie),{value:ee.value.fileName,"onUpdate:value":c[0]||(c[0]=x=>ee.value.fileName=x),placeholder:"请输入"},null,8,["value"])]),_:1}),m.value?(T(),ke(S(Ot),{key:0,type:"line",percentage:m.value,color:m.value==100?"#18a058":"#2080f0","indicator-placement":"inside",processing:""},null,8,["percentage","color"])):W("",!0),s(u,null,{default:p(()=>[s(S(Pe),{justify:"center",style:{width:"100%"}},{default:p(()=>[s(S(z),{type:"primary",onClick:Ae},{default:p(()=>c[9]||(c[9]=[P(ne("确认"))])),_:1,__:[9]}),s(S(z),{onClick:Te},{default:p(()=>c[10]||(c[10]=[P("取消")])),_:1,__:[10]})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),s(F,{show:Y.value,"onUpdate:show":c[3]||(c[3]=x=>Y.value=x),title:(ee.value.id?"编辑":"新增")+ae.typename,preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{footer:p(()=>[s(S(Pe),{justify:"end"},{default:p(()=>[s(S(z),{size:"small",class:"mt-16px",onClick:y},{default:p(()=>[P(ne(S(te)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",size:"small",class:"mt-16px",onClick:n},{default:p(()=>[P(ne(S(te)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(S(ht),{ref:"uploadRef",action:void 0,class:"mb-10px","file-list":q.value,"onUpdate:fileList":c[2]||(c[2]=x=>q.value=x),"auto-upload":!1,onBeforeUpload:Ce,multiple:!0,onChange:_,"show-file-list":!1},{default:p(()=>[s(S(z),{size:"small",ghost:"",type:"primary"},{default:p(()=>c[11]||(c[11]=[P("选择文件")])),_:1,__:[11]})]),_:1},8,["file-list"]),s(S(nt),{columns:ye,"paginate-single-page":!1,data:q.value,"max-height":350},null,8,["data"]),q.value[ve.value]&&Ue.value?(T(),O("div",Gl,[M("div",Kl,[M("span",null,ne(q.value[ve.value].filename||q.value[ve.value].name),1),M("span",null,ne(q.value[ve.value].indexText),1)]),s(S(Ot),{percentage:q.value[ve.value].progress,status:q.value[ve.value].status==="error"?"error":"success","show-indicator":""},null,8,["percentage","status"])])):W("",!0)]),_:1},8,["show","title"]),s(F,{show:d.value,"onUpdate:show":c[4]||(c[4]=x=>d.value=x),title:Be.value,preset:"card",style:{width:"80%"}},{default:p(()=>[J.value.includes("xls")?(T(),ke(S(Ma),{key:0,options:{xls:!0,minColLength:0,minRowLength:0,widthOffset:20,heightOffset:5},src:oe.value,style:{height:"80vh"},onRendered:qe,onError:he},null,8,["src"])):W("",!0),J.value.includes("doc")?(T(),ke(S(Ia),{key:1,src:oe.value,style:{height:"80vh"},onRendered:qe,onError:he},null,8,["src"])):W("",!0),J.value.includes("pdf")?(T(),ke(S(Oa),{key:2,src:oe.value,style:{height:"80vh"},onRendered:qe,onError:he},null,8,["src"])):W("",!0),J.value.includes("mp4")?(T(),O("div",Wl,[M("video",{src:oe.value,controls:"",style:{width:"100%",height:"80vh"}},null,8,Xl)])):W("",!0)]),_:1},8,["show","title"]),s(D,{show:be.value,"onUpdate:show":c[5]||(c[5]=x=>be.value=x),"src-list":Z.value,current:we.value,"onUpdate:current":c[6]||(c[6]=x=>we.value=x)},null,8,["show","src-list","current"])],64)}}}),ua=va(Yl,[["__scopeId","data-v-107f314e"]]),Zl=_t({name:"businessModal",__name:"businessModal",props:ft({pid:{},operateType:{},debuggedDevieceList:{},contactList:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:ft(["submitted","submittedData"],["update:visible"]),setup(w,{emit:$e}){const ae=$e;kt();const X=w;async function Le(){E(),qe(),Z(),Fe(),A.value=[],xe.value=!0,Se.value=!0,ye.value=[]}Gt();const h=Kt(()=>"新增待调试业务"),Ce=Wt(w,"visible");Xt(Ce,()=>{Ce.value&&Le()});const{pageData:Y,getData:E,nextPage:ee}=Ge(ma),Ve=async l=>{const u=l.currentTarget;u.scrollTop+u.offsetHeight>=u.scrollHeight&&Y.data.length<Y.total&&ee()},{pageData:m,getData:Ke,nextPage:Ae}=Ge(Ht),Oe=async l=>{const u=l.currentTarget;u.scrollTop+u.offsetHeight>=u.scrollHeight&&m.data.length<m.total&&(Ae(),m.data=m.data.map(v=>({...v,value:v.docker+"&id="+v.id})))},qe=async()=>{await Ke({pid:X.pid}),m.data=m.data.map(l=>({...l,value:l.docker+"&id="+l.id}))},{pageData:he,getData:d,nextPage:oe}=Ge(ya),Z=async()=>{await d({usertypes:"2,3"})},J=async l=>{const u=l.currentTarget;u.scrollTop+u.offsetHeight>=u.scrollHeight&&he.data.length<he.total&&oe()},{pageData:Be,getData:be,nextPage:we}=Ge(Jt),Ye=async l=>{const u=l.currentTarget,v=u.scrollTop;u.scrollTop+u.offsetHeight>=u.scrollHeight&&Y.data.length<Y.total&&(await we(),await Xe(),setTimeout(()=>{u.scrollTop=v}))},Fe=async()=>{X.pid&&await be({pid:X.pid})},Se=b(!0),xe=b(!0),A=b([]),Te=[{title:"权重",key:"dtype",width:180,align:"center",render(l,u){return l.setStatus?a(je,{value:l.dtype,filterable:!0,placeholder:"请选择权重",options:Y.data,labelField:"tname",valueField:"id",onUpdateValue(v){var F;A.value[u].dtype=Number(v)||0,A.value[u].debugname=((F=Y.data.find(D=>D.id==v))==null?void 0:F.tname)||""},onScroll(v){Ve(v)}}):a("div",{},l.tname)}},{title:"业务名称",key:"debugname",width:180,align:"center",render(l,u){return l.setStatus?a(ie,{value:l.debugname,placeholder:"请输入业务名称",onUpdateValue(v){A.value[u].debugname=v}}):a("div",{},l.debugname)}},{key:"eqmname",title:"调试设备",align:"center",width:150,render(l,u){return a(je,{value:l.eqmid,placeholder:"请选择调试设备",options:X.operateType=="edit"?Be.data:X.debuggedDevieceList,onscroll:Ye,labelField:"devname",valueField:X.operateType=="edit"?"id":"eqmid",clearable:!0,filterable:!0,onUpdateValue(v){A.value[u].eqmid=v}})}},{key:"dbcreater",width:140,align:"center",title:()=>a("div",{style:"display:flex;align-items:center;justify-content:center;gap:6px;"},[a("span",null,"调试人"),a(ia,{size:"small",checked:xe.value,label:"联动",style:"margin-left: 10px;font-size: 12px;",onUpdateChecked:l=>{xe.value=l}})]),render(l,u){return l.setStatus?a(je,{value:l.dbcreater,filterable:!0,placeholder:"请选择调试人",options:he.data,labelField:"username",valueField:"id",onUpdateValue(v){xe.value?A.value.forEach((F,D)=>{F.dbcreater=v||0}):A.value[u].dbcreater=v||0},onScroll(v){J(v)}}):a("div",{},l.dbusername)}},{key:"docker",width:140,align:"center",title:()=>a("div",{style:"display:flex;align-items:center;justify-content:center;gap:6px;"},[a("span",null,"对接方"),a(ia,{size:"small",checked:Se.value,label:"联动",style:"margin-left: 10px;font-size: 12px;",onUpdateChecked:l=>{Se.value=l}})]),render(l,u){var v;return l.setStatus?a(je,{value:l.docker,placeholder:"请输入或选择对接方",options:X.operateType=="edit"?m.data:X.contactList,onscroll:Oe,labelField:"docker",valueField:X.operateType=="edit"?"value":"docker",clearable:!0,filterable:!0,tag:!0,onClear(){l.dockcharge="",l.dockcontact=""},onUpdateValue(F){var D;if(Se.value)A.value.forEach((U,x)=>{var R;U.docker=F;let V={};if(X.operateType=="edit"){const[de,re]=(R=l.docker)==null?void 0:R.split("&id=");V=m.data.find(le=>le.docker===de&&le.id===Number(re))}else V=X.contactList.find(de=>de.docker==U.docker);console.log(X.contactList,U.docker,"sss"),V?(U.dockcharge=V.pname,U.dockcontact=V.pcontact):(U.dockcharge="",U.dockcontact="")});else{A.value[u].docker=F;let U={};if(X.operateType=="edit"){const[x,V]=(D=l.docker)==null?void 0:D.split("&id=");U=m.data.find(R=>R.docker===x&&R.id===Number(V))}else U=X.contactList.find(x=>x.docker==F);U?(l.dockcharge=U.pname,l.dockcontact=U.pcontact):(l.dockcharge="",l.dockcontact="")}}}):a("div",{},(v=l.docker)==null?void 0:v.split("&id=")[0])}},{title:"对接方负责人",key:"dockcharge",width:100,align:"center",render(l,u){return l.setStatus?a(ie,{value:l.dockcharge,placeholder:"请输入对接方负责人",onUpdateValue(v){A.value[u].dockcharge=v}}):a("div",{},l.dockcharge)}},{title:"联系方式",key:"dockcontact",width:120,align:"center",render(l,u){return l.setStatus?a(ie,{value:l.dockcontact,placeholder:"请输入联系方式",onUpdateValue(v){A.value[u].dockcontact=v}}):a("div",{},l.dockcontact)}},{title:"文件",key:"re1",width:100,align:"center",render(l,u){return l.setStatus?a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>_(l,u)},{default:()=>"上传文件"}):a(pt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const v=[{alias:l.re1,file:l.fl1},{alias:l.re2,file:l.fl2},{alias:l.re3,file:l.fl3},{alias:l.re4,file:l.fl4}].filter(F=>F.alias||F.file);return v.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件")])]),a("tbody",v.map(F=>{var D;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},F.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((D=F.file)==null?void 0:D.split("?")[1])||"-")])}))])])}})}},{title:"备注",key:"notes",width:200,align:"center",render(l,u){return l.setStatus?a(ie,{value:l.notes,placeholder:"请输入备注",onUpdateValue(v){A.value[u].notes=v}}):a("div",{},l.notes)}},{title:"计划开始时间",key:"starttime",width:200,align:"center",render(l,u){return l.setStatus?a(bt,{type:"date",clearable:!0,value:l.starttime,valueFormat:"yyyy-MM-dd",placeholder:"请选择",onUpdateValue(v){A.value[u].starttime=v}}):a("div",Je(0,l.starttime))}},{title:"计划结束时间",key:"endtime",width:200,align:"center",render:(l,u)=>l.setStatus?a(bt,{type:"date",clearable:!0,valueFormat:"yyyy-MM-dd",value:l.endtime,placeholder:"请选择",onUpdateValue(v){A.value[u].endtime=v}}):Je(0,l.endtime)},{key:"operate",title:te("common.operate"),align:"center",width:120,fixed:"right",render(l,u){return a("div",{class:"flex-center gap-8px"},[a(rt,{onPositiveClick:()=>{A.value.splice(u,1),ye.value.splice(u,1)}},{default:()=>te("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>te("common.delete")})})])}}];function Ne(){Ce.value=!1}const ye=b([]),q=l=>{A.value=[],l.forEach(u=>{var v;A.value.push({debugname:(v=Y.data.find(F=>F.id==u))==null?void 0:v.tname,docker:void 0,dockcharge:"",dockcontact:"",debugresult:0,status:0,notes:"",dbcreater:void 0,dtype:u,setStatus:!0,pid:X.pid,starttime:null,endtime:null})})},ve=b(!1);async function Ue(){var v,F,D,U,x,V,R,de;const l=["dtype","debugname","docker"],u=A.value.findIndex(re=>l.some(le=>!re[le]||re[le].toString().trim()===""));if(u!==-1){(F=(v=window.$message)==null?void 0:v.error)==null||F.call(v,`第 ${u+1} 行请完整填写必填项（权重、业务名称、对接方）`);return}try{if(ve.value=!0,X.operateType==="edit")for(const le of A.value){if(!Array.isArray(le.fileList)||le.fileList.length===0)continue;const Me=le.fileList.filter(k=>(k==null?void 0:k.file)&&typeof k.file=="object"),fe=Me.length;for(let k=0;k<fe;k++){const g=Me[k];g.indexText=`${k+1}/${fe}`,g.progress=0,g.status="uploading";try{g.url=await tt(g.file.file,g.file.name,""),g.progress=100,g.status="done"}catch{g.status="error",(U=(D=window.$message)==null?void 0:D.error)==null||U.call(D,"文件上传失败，请重试");return}}le.fileList.forEach((k,g)=>{const B=`re${g+1}`,j=`fl${g+1}`;le[B]=k.status==="done"&&k.name||"",le[j]=k.status==="done"&&k.url||""}),delete le.fileList}const re=A.value.map(le=>{var Me;return{...le,starttime:Je(0,le.starttime),endtime:Je(0,le.endtime),docker:(Me=le.docker)==null?void 0:Me.split("&id=")[0]}});if(X.operateType==="edit"){const{error:le}=await Sa(re);le||((V=(x=window.$message)==null?void 0:x.success)==null||V.call(x,"添加成功"),Ne(),ae("submitted"))}else ae("submittedData",re)}catch(re){console.error(re),(de=(R=window.$message)==null?void 0:R.error)==null||de.call(R,"提交失败，请稍后重试")}finally{ve.value=!1}}const n=b(!1),y=b(),_=(l,u)=>{n.value=!0,y.value=u,l.fileList&&l.fileList.length>0?c.value=l.fileList:c.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]},r=[{title:"",key:"",align:"center",width:80,render(l,u){return`附件${u+1}`}},{title:"文件名称",key:"filename",align:"center",render(l){var F;const u=async({file:D,onFinish:U,onError:x})=>{var V,R;try{l.name=D.name,l.file=D}catch(de){console.error(de),(R=(V=window.$message)==null?void 0:V.error)==null||R.call(V,"文件上传出错")}};async function v(D){var U;return D.file.file.size>100*1024*1024?((U=window.$message)==null||U.error("文件大小不能超过100M"),!1):!0}return a("div",{style:"display:flex;justify-content:center;align-items:center;"},[l.file||l.url?a("span",{},[a("span",{},((F=l.file)==null?void 0:F.name)||l.url.split("?")[1]||""),a("span",{style:"color:red;cursor:pointer;font-size:12px;margin-left:8px;",onClick:()=>{l.url="",l.file=null}},"删除")]):a(ht,{action:"#",showFileList:!1,customRequest:u,onBeforeUpload:v},{default:()=>a(z,{type:"info",size:"small",ghost:!0,loading:l.status},{default:()=>"上传文件"})})])}},{title:"文件别名",key:"name",align:"center",render(l){return a(ie,{value:l.name,clearable:!0,onUpdateValue:u=>{l.name=u}})}}],c=b([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]),f=async()=>{var u,v;let l=!0;if(c.value.forEach((F,D)=>{var V,R;const U=F.name||"",x=((V=F.url)==null?void 0:V.split("?")[1])||((R=F.file)==null?void 0:R.name);(U&&!x||!U&&x)&&(l=!1)}),!l){(v=(u=window.$message)==null?void 0:u.error)==null||v.call(u,"文件名称和文件地址必须同时存在，不能只填一个");return}A.value[y.value].fileList=c.value,l&&(n.value=!1,y.value=void 0)},C=()=>{n.value=!1};return(l,u)=>{const v=Ut,F=nt,D=xt,U=yt("loading");return T(),O(et,null,[s(D,{show:Ce.value,"onUpdate:show":u[1]||(u[1]=x=>Ce.value=x),title:h.value,preset:"card",class:"w-80% h-70vh","mask-closable":!1,draggable:!0},{footer:p(()=>[s(S(Pe),{justify:"end",size:16},{default:p(()=>[s(S(z),{onClick:Ne},{default:p(()=>[P(ne(S(te)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",onClick:Ue},{default:p(()=>[P(ne(S(te)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(v,{label:"权重","label-placement":"left"},{default:p(()=>[s(S(je),{filterable:"",multiple:"",value:ye.value,"onUpdate:value":[u[0]||(u[0]=x=>ye.value=x),q],tag:"",style:{width:"300px"},placeholder:"请选择权重","label-field":"tname","value-field":"id",options:S(Y).data,onScroll:Ve},null,8,["value","options"])]),_:1}),lt(s(F,{style:{width:"100%"},columns:Te,data:A.value,size:"small","row-key":x=>x.id,striped:"","scroll-x":Te.reduce((x,V)=>x+V.width,0),"max-height":350},null,8,["data","row-key","scroll-x"]),[[U,ve.value]])]),_:1},8,["show","title"]),s(D,{show:n.value,"onUpdate:show":u[2]||(u[2]=x=>n.value=x),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:p(()=>u[3]||(u[3]=[P(" 待调试业务文件列表 ")])),footer:p(()=>[s(S(Pe),{justify:"end"},{default:p(()=>[s(S(z),{size:"small",class:"mt-16px",onClick:C},{default:p(()=>[P(ne(S(te)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",size:"small",class:"mt-16px",onClick:f},{default:p(()=>[P(ne(S(te)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(F,{columns:r,"paginate-single-page":!1,data:c.value,"max-height":350},null,8,["data"])]),_:1},8,["show"])],64)}}}),Ql=_t({name:"deviceModal",__name:"deviceModal",props:ft({pid:{},proid:{},operateType:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:ft(["submitted","submittedData"],["update:visible"]),setup(w,{emit:$e}){const ae=$e;kt();const X=w;async function Le(){Y(),oe.value=[],Z.value=[]}const h=Wt(w,"visible");Xt(h,()=>{h.value&&Le()});const Ce=b([]),Y=async()=>{var _,r;const{data:n,error:y}=await ba({page:1,limit:100,id:X.proid});if(n){if(Ce.value=n==null?void 0:n.list.map(c=>({value:c.id,label:c.contractname,isLeaf:!1})),Ce.value.length==0)return(_=window.$message)==null?void 0:_.error("该项目没有绑定合同！");Ae((r=n==null?void 0:n.list[0])==null?void 0:r.id)}},E=b([]),ee=b(),{pageData:Ve,getData:m,nextPage:Ke}=Ge(_a),Ae=async n=>{await m({pids:n}),ee.value=[],E.value=Array.from(new Set([...E.value,...Ve.data])),ee.value=Ve.data.map(y=>({label:y.devname,value:y.id}))},Oe=async n=>{var y;await Ae(n.value),n.children=(y=ee.value)==null?void 0:y.map(_=>({label:_.label,value:_.value,isLeaf:!0})),await Xe(),setTimeout(()=>{const _=document.querySelectorAll(".n-cascader-submenu-wrapper .n-scrollbar");console.log(_[1]),_[1]&&(_[1].removeEventListener("scroll",xe),_[1].addEventListener("scroll",xe))},2e3)};function qe(n,y){const _=n.filter(c=>!y.includes(c)),r=y.filter(c=>!n.includes(c));return{toDelete:_,toAdd:r}}const he=b([]),d=async n=>{const{toDelete:y,toAdd:_}=qe(he.value,n);y.forEach(r=>{const c=Z.value.findIndex(f=>f.cid==r);c!=-1&&Z.value.splice(c,1)}),_.forEach(async r=>{var c,f,C,l,u,v,F,D,U,x,V,R,de,re,le,Me;Z.value.push({devname:((f=(c=E.value)==null?void 0:c.find(fe=>fe.id==r))==null?void 0:f.devname)||"",devmodel:((l=(C=E.value)==null?void 0:C.find(fe=>fe.id==r))==null?void 0:l.devmodel)||"",devnum:((v=(u=E.value)==null?void 0:u.find(fe=>fe.id==r))==null?void 0:v.devcount)||0,devmanu:((D=(F=E.value)==null?void 0:F.find(fe=>fe.id==r))==null?void 0:D.devmanu)||"",etype:((x=(U=E.value)==null?void 0:U.find(fe=>fe.id==r))==null?void 0:x.etype)||0,status:0,devunit:((R=(V=E.value)==null?void 0:V.find(fe=>fe.id==r))==null?void 0:R.devunit)||"",notes:((re=(de=E.value)==null?void 0:de.find(fe=>fe.id==r))==null?void 0:re.notes)||"",setStatus:!0,cid:r,pid:X.pid,install:1,connectionmode:"",devstatus:2,manucontact:"",manuinfo:"",devnumber:((Me=(le=E.value)==null?void 0:le.find(fe=>fe.id==r))==null?void 0:Me.devcount)||0})}),he.value=n},oe=b([]),Z=b([]),J=[{title:"绑定合同设备",key:"cid",width:300,align:"center",render(n,y){var _,r;return n.setStatus?a(Rt,{style:"width: 270px",value:n.cid,filterable:!0,placeholder:"请选择合同设备",options:Ce.value,checkStrategy:"child",showPath:!1,remote:!0,onLoad:Oe,onUpdateValue(c){var C;Z.value[y].cid=Number(c)||0;const f=(C=E.value)==null?void 0:C.find(l=>l.id==c);n.devname=(f==null?void 0:f.devname)||"",n.devnum=(f==null?void 0:f.devcount)||"",n.notes=(f==null?void 0:f.notes)||"",n.devnumber=(f==null?void 0:f.devcount)||0,n.etype=(f==null?void 0:f.devtype)||0,n.devmanu=(f==null?void 0:f.devmanu)||"",n.devmodel=((f==null?void 0:f.devmodel.length)>64?f==null?void 0:f.devname:f==null?void 0:f.devmodel)||"",n.devunit=(f==null?void 0:f.devunit)||""}}):a("div",{},n.devname2||((r=(_=ee.value)==null?void 0:_.find(c=>c.value==n.cid))==null?void 0:r.label))}},{title:"设备名称",key:"devname",width:200,align:"center",render(n,y){return n.setStatus?a(ie,{value:n.devname,placeholder:"请输入",onUpdateValue(_){Z.value[y].devname=_}}):a("div",{},n.devname)}},{title:"型号",key:"devmodel",width:220,align:"center",render(n,y){return a("div",{},n.devmodel)}},{title:"设备单位",key:"devunit",width:120,align:"center",render(n,y){return a("div",{},n.devunit)}},{title:"数量",key:"devnum",width:100,align:"center",render(n,y){return n.setStatus?a(ha,{value:n.devnum,placeholder:"请输入",max:n.devnumber,onUpdateValue(_){Z.value[y].devnum=_}}):a("div",{},n.devnum)}},{title:"是否为我司设备",key:"etype",width:260,align:"center",render(n,y){return a("div",{},n.etype==0?"是":"否")}},{title:"设备厂家",key:"devmanu",width:100,align:"center",render(n,y){return a("div",{},n.devmanu)}},{title:"厂家联系人",key:"manucontact",width:100,align:"center",render(n,y){return n.setStatus?a(ie,{value:n.manucontact,placeholder:"请输入",onUpdateValue(_){Z.value[y].manucontact=_}}):a("div",{},n.manucontact)}},{title:"厂家联系方式",key:"manuinfo",width:100,align:"center",render(n,y){return n.setStatus?a(ie,{value:n.manuinfo,placeholder:"请输入",onUpdateValue(_){Z.value[y].manuinfo=_}}):a("div",{},n.manuinfo)}},{title:"设备状态",key:"devstatus",width:120,align:"center",render(n,y){return n.setStatus&&n.id?a(je,{value:n.devstatus,filterable:!0,placeholder:"请选择",options:[{label:"设备无异常",value:0},{label:"异常",value:1},{label:"未知",value:2}],onUpdateValue(_){Z.value[y].devstatus=Number(_)||0}}):a("div",{},n.devstatus===0?"设备无异常":n.devstatus===1?"异常":"未知")}},{title:"接线方式",key:"connectionmode",width:100,align:"center",render(n,y){return n.setStatus?a(ie,{value:n.connectionmode,placeholder:"请输入",onUpdateValue(_){Z.value[y].connectionmode=_}}):a("div",{},n.connectionmode)}},{title:"是否安装就位",key:"install",width:120,align:"center",render(n,y){return n.setStatus&&n.id?a(je,{value:n.install,filterable:!0,placeholder:"请选择",options:[{label:"是",value:0},{label:"否",value:1}],onUpdateValue(_){Z.value[y].install=Number(_)||0}}):a("div",{},n.install===0?"是":"否")}},{title:"备注",key:"notes",width:200,align:"center",render(n,y){return a("div",{},n.notes)}},{title:"文件",key:"re1",width:160,align:"center",render(n,y){return n.setStatus?a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>Ne(n,y)},{default:()=>"上传文件"}):a(pt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const _=[{alias:n.re1,file:n.fl1},{alias:n.re2,file:n.fl2},{alias:n.re3,file:n.fl3},{alias:n.re4,file:n.fl4}].filter(r=>r.alias||r.file);return _.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件")])]),a("tbody",_.map(r=>{var c;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},r.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((c=r.file)==null?void 0:c.split("?")[1])||"-")])}))])])}})}},{title:"操作信息",key:"dbtime",width:180,align:"center",render(n,y){return a(pt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},n.dbtime?Je(1,n.dbtime):""),default:()=>a("div",{style:"padding: 10px;"},s("div",null,[s("div",null,[P("操作人："),n.username]),s("div",null,[P("操作时间："),n.dbtime]),s("div",null,[P("清点人："),n.dusername]),s("div",null,[P("清点时间："),n.ddbtime])]))})}},{key:"operate",title:te("common.operate"),align:"center",width:180,fixed:"right",render(n,y){return a("div",{class:"flex-center gap-8px"},[a(rt,{onPositiveClick:()=>{n.id||(Z.value.splice(y,1),oe.value.splice(y,1))}},{default:()=>te("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>te("common.delete")})})])}}];function Be(){h.value=!1}const be=b(!1);async function we(){var _,r,c,f,C,l,u,v;const n=["cid","devname","devnum"],y=Z.value.findIndex(F=>n.some(D=>!F[D]||F[D].toString().trim()===""));if(y!==-1){(r=(_=window.$message)==null?void 0:_.error)==null||r.call(_,`第 ${y+1} 行请完整填写必填项（合同设备、设备名称、数量）`);return}try{if(be.value=!0,X.operateType==="edit")for(const D of Z.value){if(!Array.isArray(D.fileList)||D.fileList.length===0)continue;const U=D.fileList.filter(x=>(x==null?void 0:x.file)&&typeof x.file=="object");for(const x of U){x.status="uploading";try{x.url=await tt(x.file.file,x.file.name,""),x.status="done"}catch{x.status="error",(f=(c=window.$message)==null?void 0:c.error)==null||f.call(c,"文件上传失败，请重试");return}}D.fileList.forEach((x,V)=>{const R=`re${V+1}`,de=`fl${V+1}`;D[R]=x.status==="done"&&x.name||"",D[de]=x.status==="done"&&x.url||""}),delete D.fileList}const F=Z.value.map(D=>({...D,eqmid:ka()}));if(X.operateType==="edit"){const{error:D}=await La(F);D||((l=(C=window.$message)==null?void 0:C.success)==null||l.call(C,"添加成功"),Be(),ae("submitted"))}else ae("submittedData",F)}catch(F){console.error(F),(v=(u=window.$message)==null?void 0:u.error)==null||v.call(u,"提交失败，请稍后重试")}finally{be.value=!1}}const Ye=async n=>{},Fe=b(!1),Se=b(!0),xe=async n=>{console.log(n);const y=n.target;y.scrollHeight-y.scrollTop-y.clientHeight<10&&!Fe.value&&Se.value&&(Fe.value=!0,Ke(),ee.value=Ve.data.map(r=>({label:r.devname,value:r.id})),Fe.value=!1)},A=b(!1),Te=b(),Ne=(n,y)=>{A.value=!0,Te.value=y,n.fileList&&n.fileList.length>0?q.value=n.fileList:q.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]},ye=[{title:"",key:"",align:"center",width:80,render(n,y){return`附件${y+1}`}},{title:"文件名称",key:"filename",align:"center",render(n){var r;const y=async({file:c,onFinish:f,onError:C})=>{var l,u;try{n.name=c.name,n.file=c}catch(v){console.error(v),(u=(l=window.$message)==null?void 0:l.error)==null||u.call(l,"文件上传出错")}};async function _(c){var f;return c.file.file.size>100*1024*1024?((f=window.$message)==null||f.error("文件大小不能超过100M"),!1):!0}return a("div",{style:"display:flex;justify-content:center;align-items:center;"},[n.file||n.url?a("span",{},[a("span",{},((r=n.file)==null?void 0:r.name)||n.url.split("?")[1]||""),a("span",{style:"color:red;cursor:pointer;font-size:12px;margin-left:8px;",onClick:()=>{n.url="",n.file=null}},"删除")]):a(ht,{action:"#",showFileList:!1,customRequest:y,onBeforeUpload:_},{default:()=>a(z,{type:"info",size:"small",ghost:!0,loading:n.status},{default:()=>"上传文件"})})])}},{title:"文件别名",key:"name",align:"center",render(n){return a(ie,{value:n.name,clearable:!0,onUpdateValue:y=>{n.name=y}})}}],q=b([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]),ve=async()=>{var y,_;let n=!0;if(q.value.forEach((r,c)=>{var l,u;const f=r.name||"",C=((l=r.url)==null?void 0:l.split("?")[1])||((u=r.file)==null?void 0:u.name);(f&&!C||!f&&C)&&(n=!1)}),!n){(_=(y=window.$message)==null?void 0:y.error)==null||_.call(y,"文件名称和文件地址必须同时存在，不能只填一个");return}Z.value[Te.value].fileList=q.value,n&&(A.value=!1,Te.value=void 0)},Ue=()=>{A.value=!1};return(n,y)=>{const _=Ut,r=nt,c=xt,f=yt("loading");return T(),O(et,null,[s(c,{show:h.value,"onUpdate:show":y[1]||(y[1]=C=>h.value=C),title:"新增待调试设备",preset:"card",class:"w-80% h-70vh","mask-closable":!1,draggable:!0},{footer:p(()=>[s(S(Pe),{justify:"end",size:16},{default:p(()=>[s(S(z),{onClick:Be},{default:p(()=>[P(ne(S(te)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",onClick:we},{default:p(()=>[P(ne(S(te)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(_,{label:"合同设备","label-placement":"left"},{default:p(()=>[s(S(Rt),{value:oe.value,"onUpdate:value":[y[0]||(y[0]=C=>oe.value=C),d],placeholder:"请选择合同设备",options:Ce.value,"check-strategy":"child","show-path":!1,labelKey:"label",remote:"",multiple:"",style:{width:"300px"},"on-load":Oe,"onUpdate:show":Ye},null,8,["value","options"])]),_:1}),lt(s(r,{style:{width:"100%"},columns:J,data:Z.value,size:"small","row-key":C=>C.id,striped:"","scroll-x":J.reduce((C,l)=>C+l.width,0),"max-height":350},null,8,["data","row-key","scroll-x"]),[[f,be.value]])]),_:1},8,["show"]),s(c,{show:A.value,"onUpdate:show":y[2]||(y[2]=C=>A.value=C),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:p(()=>y[3]||(y[3]=[P(" 待调试设备文件列表 ")])),footer:p(()=>[s(S(Pe),{justify:"end"},{default:p(()=>[s(S(z),{size:"small",class:"mt-16px",onClick:Ue},{default:p(()=>[P(ne(S(te)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",size:"small",class:"mt-16px",onClick:ve},{default:p(()=>[P(ne(S(te)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(r,{columns:ye,"paginate-single-page":!1,data:q.value,"max-height":350},null,8,["data"])]),_:1},8,["show"])],64)}}}),en={class:"w-100%"},tn={class:"flex"},an={class:"flex-col w-100%"},ln=2,nn=_t({__name:"prjDetail",props:ft({operateType:{}},{prjInfo:{default:()=>({id:void 0,proname:void 0,proaddr:"",prosite:"",longitude:120.373885,latitude:30.303899,proid:null,dtype:null,dispatch:"",status:0,plantime:null,region:null,provice:null})},prjInfoModifiers:{}}),emits:ft(["submit","changePrj"],["update:prjInfo"]),setup(w,{expose:$e,emit:ae}){const X=kt(),Le=w,h=Wt(w,"prjInfo"),Ce=ae,Y=b([]),{pageData:E,getData:ee,nextPage:Ve}=Ge(X.userInfo.usertype==1?xl:Wa),m=async k=>{const g=k.currentTarget,B=g.scrollTop;g.scrollTop+g.offsetHeight>=g.scrollHeight&&E.data.length<E.total&&(await Ve(),Y.value=E.data,await Xe(),setTimeout(()=>{g.scrollTop=B}))},Ke=sa.debounce(async k=>{await ee({page:1,fuzzy:k}),Y.value=E.data},300),Ae=b(!1),Oe=b(!1),qe=k=>{if(h.value.proid=null,Ae.value=!0,Oe.value=!1,!k){d();return}Ke(k)},he=async()=>{Ae.value&&!Oe.value&&(await ee({page:1}),Y.value=E.data,Ae.value=!1)},d=async()=>{await ee({page:1}),Y.value=E.data},oe=async k=>{await J(k),Z.value?h.value.proid=null:h.value.proid=k,Ce("changePrj")},Z=b(!1),J=async k=>{var j;Z.value=!1;const{data:g,error:B}=await kl(k);g&&(Z.value=!0,(j=window.$message)==null||j.warning("该项目已存在调试单，请勿重复添加"))},Be=b({id:void 0,proname:void 0,proaddr:"",prosite:"",longitude:120.373885,latitude:30.303899,proid:null,dtype:null,dispatch:"",status:0,plantime:null,region:null,provice:null});function be(k){return JSON.parse(JSON.stringify(el(k)))}Kt(()=>Be.value?JSON.stringify(h.value)!==JSON.stringify(Be.value):!1),xa(async()=>{await ee({page:1}),Y.value=E.data,xe(),Le.operateType=="edit"&&q(h.value.provice),Xe(()=>{Be.value=be(h.value)})});const we={status:{type:"number",required:!0,trigger:["blur","change"],message:"请选择提交状态"},dtype:{type:"number",required:!0,trigger:["blur","change"],message:"请选择调试类型"},proid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择项目"},prosite:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请输入项目地址"},proaddr:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请输入项目详细地址"},plantime:{type:"string",required:!0,trigger:["blur","change"],message:"请选择计划调试时间"},provice:{type:"number",required:!0,trigger:["blur","change"],message:"请选择省份"},region:{type:"number",required:!0,trigger:["blur","change"],message:"请选择城市"},dispatch:{type:"string",required:!0,trigger:["blur","change"],message:"请输入调度名称"}},{formRef:Ye,validate:Fe}=Gt(),Se=b([]),xe=async()=>{const{data:k,error:g}=await Xa();k&&(Se.value=k)},A=k=>{q(k),h.value.region=null,h.value.proaddr=""},Te=k=>{var B;const g=(B=ye.value.find(j=>j.id===k))==null?void 0:B.name;h.value.region&&h.value.prosite&&h.value.proaddr&&!y?(h.value.prosite="",h.value.proaddr=""):Ne(g)};function Ne(k){!k||!y||!n||y.getLocation(k,(g,B)=>{var j;if(g==="complete"&&((j=B.geocodes)!=null&&j.length)){const{location:Ee,formattedAddress:Re}=B.geocodes[0],it=Ee.lng,Ze=Ee.lat;n.setZoomAndCenter(14,[it,Ze]),C.longitude=it,C.latitude=Ze,h.value.latitude=C.latitude,h.value.longitude=C.longitude,de(f,{lng:it,lat:Ze}),h.value.proaddr=Re,h.value.prosite=Re,v.value=Re}})}const ye=b([]),q=async k=>{var j;if(!k)return(j=window.$message)==null?void 0:j.warning("请先选择省份");const{data:g,error:B}=await Ya({province:k});g&&(ye.value=g)},ve=b(!1),Ue=b();let n=null,y=null,_=null,r=null,c=null,f=null;const C=ot({longitude:0,latitude:0});let l;const u=b(!1),v=b(""),F=b([]);let D=0;async function U(){try{if(window._AMapSecurityConfig={securityJsCode:X.userInfo.sdksecret},!Ue.value)return;f=await gl.load({key:X.userInfo.sdkkey,version:"2.0",plugins:["AMap.Scale","AMap.PlaceSearch","AMap.AutoComplete","AMap.Geocoder","AMap.Geolocation"]}),n=new f.Map(Ue.value,{zoom:18,center:[h.value.longitude,h.value.latitude],viewMode:"3D",resizeEnable:!0}),y=new f.Geocoder,r=new f.PlaceSearch({city:"全国",pageSize:50}),c=new f.AutoComplete({city:"全国"}),de(f,{lng:h.value.longitude,lat:h.value.latitude}),n.on("click",k=>{const{lng:g,lat:B}=k.lnglat;l=2,C.latitude=B,C.longitude=g,de(f,{lng:g,lat:B})}),D=0,Xe(()=>{window.dispatchEvent(new Event("resize"))})}catch(k){console.error("地图加载失败：",k),D<ln?(D++,console.warn(`地图加载失败，正在第 ${D} 次重试...`),setTimeout(()=>{U()},1500)):console.error("地图加载失败，已达到最大重试次数，停止重试")}}const x=sa.debounce(async k=>{if(!u.value||!k.trim()){F.value=[];return}c.search(k,(g,B)=>{var j;console.log(B,"result"),g=="complete"&&B.info=="OK"&&((j=B==null?void 0:B.tips)!=null&&j.length)?F.value=B.tips.map(Ee=>({label:`${Ee.name}（${Ee.district||Ee.address||"无详细地址"}）`,value:`${Ee.location.lng}_${Ee.location.lat}`,raw:Ee})):F.value=[]})},300);Xt(v,k=>{x(k)});function V(k,g){if(console.log(k,g,"option"),!k)return;const[B,j]=k.split("_").map(Number);!B||!j||(n.setCenter([B,j]),l=1,de(f,{lng:B,lat:j}),C.longitude=B,C.latitude=j)}function R(){ve.value=!0,u.value=!1,l=void 0,Xe(async()=>{await U(),setTimeout(()=>{u.value=!0;const k=document.querySelector(".n-auto-complete input");k==null||k.blur(),console.log(h),h.value.region&&!h.value.prosite&&!h.value.prosite&&Te(h.value.region)},500)})}function de(k,g){_&&n.remove(_),_=new k.Marker({position:[g.lng,g.lat],map:n}),n.add(_),y.getAddress(g,async(B,j)=>{B==="complete"&&j.regeocode&&(console.log("result",j),console.log("formattedAddress",j.regeocode.formattedAddress),g.latitude=g.lat,g.longitude=g.lng,l==1?h.value.proaddr=j.regeocode.formattedAddress:l==2?(v.value=j.regeocode.formattedAddress,h.value.proaddr=j.regeocode.formattedAddress,h.value.provice=re(h.value.proaddr,Se.value),await q(h.value.provice),h.value.region=le(h.value.proaddr,ye.value)):(v.value=h.value.prosite||j.regeocode.formattedAddress,setTimeout(async()=>{h.value.provice=re(v.value,Se.value),await q(h.value.provice),h.value.region=le(v.value,ye.value)},300)))})}function re(k,g){let B=null;for(const j of g)if(k.includes(j.name)){B=j.id;break}return B}function le(k,g){let B=null;for(const j of g)if(k.includes(j.name)){B=j.id;break}return B}const Me=async()=>{h.value.latitude=C.latitude,h.value.longitude=C.longitude,h.value.prosite=v.value,ve.value=!1};function fe(){ve.value=!1}return $e({validate:Fe}),(k,g)=>{const B=je,j=yl,Ee=bt,Re=ie,it=pl,Ze=z,zt=Qa,jt=ml,Pt=ga,ut=Ut,gt=Pe,De=fl,Lt=xt;return T(),O(et,null,[s(Pt,{ref_key:"formRef",ref:Ye,model:h.value,rules:we,"label-placement":"left","label-width":"120"},{default:p(()=>[s(jt,{responsive:"screen","item-responsive":"","x-gap":"15"},{default:p(()=>[s(j,{span:"24 s:12 m:9",label:"项目名称",path:"proid"},{default:p(()=>[s(B,{filterable:"",clearable:"",value:h.value.proid,"onUpdate:value":[g[0]||(g[0]=I=>h.value.proid=I),oe],placeholder:"请选择项目","label-field":"proname","value-field":"id",disabled:Le.operateType=="edit",options:Y.value,onScroll:m,onClear:d,onSearch:qe,onBlur:he},null,8,["value","disabled","options"])]),_:1}),s(j,{span:"24 s:12 m:5",label:"计划调试时间",path:"plantime"},{default:p(()=>[s(Ee,{"formatted-value":h.value.plantime,"onUpdate:formattedValue":g[1]||(g[1]=I=>h.value.plantime=I),type:"date","value-format":"yyyy-MM-dd",style:{width:"100%"}},null,8,["formatted-value"])]),_:1}),s(j,{span:"24 s:12 m:5",label:"调试类型",path:"dtype"},{default:p(()=>[s(B,{filterable:"",value:h.value.dtype,"onUpdate:value":g[2]||(g[2]=I=>h.value.dtype=I),placeholder:"请选择调试类型",options:S(Za)(S(vl))},null,8,["value","options"])]),_:1}),s(j,{span:"24 s:12 m:5",label:"提交状态",path:"status"},{default:p(()=>[s(B,{filterable:"",disabled:"",value:h.value.status,"onUpdate:value":g[3]||(g[3]=I=>h.value.status=I),placeholder:"请选择提交状态",options:[{label:"未提交",value:0},{label:"已提交",value:1}]},null,8,["value"])]),_:1}),s(j,{span:"24 s:12 m:8",label:"省份",path:"provice"},{default:p(()=>[s(B,{filterable:"",value:h.value.provice,"onUpdate:value":[g[4]||(g[4]=I=>h.value.provice=I),A],placeholder:"请选择省份","label-field":"name","value-field":"id",options:Se.value},null,8,["value","options"])]),_:1}),s(j,{span:"24 s:12 m:8",label:"地区",path:"region"},{default:p(()=>[s(B,{filterable:"",value:h.value.region,"onUpdate:value":[g[5]||(g[5]=I=>h.value.region=I),Te],placeholder:"请选择地区","label-field":"name","value-field":"id",options:ye.value},null,8,["value","options"])]),_:1}),s(j,{span:"24 s:12 m:8",label:"调度名称",path:"dispatch"},{default:p(()=>[s(Re,{clearable:"",value:h.value.dispatch,"onUpdate:value":g[6]||(g[6]=I=>h.value.dispatch=I),placeholder:"请输入调度名称"},null,8,["value"])]),_:1}),s(j,{span:"24 s:12 m:12",label:"项目默认地点",path:"prosite"},{default:p(()=>[M("div",en,[M("div",tn,[s(zt,{onClick:g[8]||(g[8]=I=>R())},{default:p(()=>[s(Re,{value:h.value.prosite,"onUpdate:value":g[7]||(g[7]=I=>h.value.prosite=I),placeholder:"请选择项目地点"},null,8,["value"]),s(Ze,null,{icon:p(()=>[s(it,{class:"text-icon"})]),_:1})]),_:1})])])]),_:1}),s(j,{span:"24 s:12 m:12",label:"项目详细地址",path:"proaddr"},{default:p(()=>[s(Re,{type:"textarea",rows:1,clearable:"",value:h.value.proaddr,"onUpdate:value":g[9]||(g[9]=I=>h.value.proaddr=I),placeholder:"请输入项目详细地址"},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["model"]),s(Lt,{show:ve.value,"onUpdate:show":g[14]||(g[14]=I=>ve.value=I),title:"选择项目位置",preset:"card",class:"w-800px"},{footer:p(()=>[s(gt,{justify:"end",size:16},{default:p(()=>[s(Ze,{onClick:fe},{default:p(()=>[P(ne(k.$t("common.cancel")),1)]),_:1}),s(Ze,{type:"primary",onClick:Me},{default:p(()=>[P(ne(k.$t("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(gt,null,{default:p(()=>[s(ut,{label:"省份",path:"provice","label-placement":"left","label-width":"70"},{default:p(()=>[s(B,{filterable:"",value:h.value.provice,"onUpdate:value":[g[10]||(g[10]=I=>h.value.provice=I),A],placeholder:"请选择省份","label-field":"name","value-field":"id",options:Se.value},null,8,["value","options"])]),_:1}),s(ut,{label:"地区",path:"region","label-placement":"left","label-width":"70"},{default:p(()=>[s(B,{filterable:"",value:h.value.region,"onUpdate:value":[g[11]||(g[11]=I=>h.value.region=I),Te],placeholder:"请选择地区","label-field":"name","value-field":"id",options:ye.value},null,8,["value","options"])]),_:1})]),_:1}),u.value?(T(),ke(ut,{key:0,label:"项目地址","label-placement":"left"},{default:p(()=>[M("div",an,[s(De,{value:v.value,"onUpdate:value":[g[12]||(g[12]=I=>v.value=I),S(x)],options:F.value,style:{"margin-bottom":"7px"},placeholder:"请输入地点关键字",clearable:"",onSelect:V},null,8,["value","options","onUpdate:value"]),s(Re,{type:"textarea",rows:2,clearable:"",value:h.value.proaddr,"onUpdate:value":g[13]||(g[13]=I=>h.value.proaddr=I),placeholder:"请输入详细地址"},null,8,["value"])])]),_:1})):W("",!0),M("div",{ref_key:"domRef",ref:Ue,class:"h-full w-full",style:{width:"100%",height:"500px","margin-top":"10px"}},null,512)]),_:1},8,["show"])],64)}}}),sn={class:"flex justify-center items-center"},on={class:"font-size-22px font-bold"},rn={class:"position-absolute right-80px flex items-center gap-x-20px"},un={class:"flex-col-stretch"},dn={class:"timeline-wrapper"},cn={class:"timeline-layout"},pn={class:"timeline"},fn=["id"],gn={class:"timeline-icon"},vn=["onClick"],mn={class:"flex justify-between"},yn=["onClick"],hn={class:"timeline-rows"},bn={key:0,class:"timeline-content",style:{"padding-left":"80px",position:"relative"}},_n={class:"timeline-icon"},kn=["onClick"],xn=["onClick"],Ln=["id"],Sn={style:{display:"flex","align-items":"center",gap:"10px"}},Dn={key:0},Cn={key:1,style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},wn={style:{display:"flex","align-items":"center",gap:"10px"}},Fn={key:0},$n={key:1,style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},Tn={key:0,style:{height:"20px"}},Un={style:{display:"flex","align-items":"center",gap:"10px"}},zn={key:0},jn={key:1,style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},Pn={key:0,style:{height:"20px"}},Bn=_t({name:"projectmanagement_projectdebuggingformdetail",__name:"index",props:{operateType:{},rowData:{}},emits:["return","submit","returnandSub"],setup(w,{emit:$e}){const ae=kt(),X=tl(),Le=b(""),h=al(),Ce=ll(),Y=ot({debuggedBusinessList:[],developBusinessList:[],needsList:[]});Gt();const E=w,ee=$e,Ve=()=>{ee("return")},m=ot(Ke());function Ke(){return{id:void 0,proname:void 0,proaddr:"",prosite:"",longitude:120.373885,latitude:30.303899,proid:null,dtype:null,dispatch:"",status:0,plantime:null,region:null,provice:null}}async function Ae(){Object.assign(m,Ke()),R(),k(),d.value={projectDetail:{},contactList:[],debuggedBusinessList:[],fileList:[],debuggedDevieceList:[]},E.operateType==="edit"&&E.rowData&&(Object.assign(m,E.rowData),await Oe(m.proid),Te(),Re()),oe(),setTimeout(()=>{Ce.replace({path:h.path,query:{}})},100)}const Oe=async e=>{if(!e){d.value={projectDetail:{},contactList:[],debuggedBusinessList:[],fileList:[],debuggedDevieceList:[]};return}at.value=!0;try{const t=await Promise.allSettled([Vt(m.id),Pt(),be(m.id),I(m.id),f(m.id)]);oe(),t.forEach((o,i)=>{o.status==="fulfilled"?console.log(`任务 ${i} 成功:`,o):console.warn(`任务 ${i} 失败:`,o.reason)})}catch(t){console.error("意料之外的错误:",t)}finally{at.value=!1}},qe=async()=>{const{data:e,error:t}=await _l(m.id);t||Object.assign(m,e)},he=ot([{id:"phase1",title:"基本信息",show:!0,tables:[]},{id:"phase2",title:"实施信息",show:!0,tables:[]}]),d=b({projectDetail:{},contactList:[],fileList:[],debuggedDevieceList:[],debuggedBusinessList:[]}),oe=()=>{he[0].tables=[{id:1,name:"项目联系人",type:d.value.contactList.length>0?1:0},{id:2,name:"待调试设备",type:d.value.debuggedDevieceList.length>0?1:0},{id:3,name:"图纸",type:d.value.fileList.length>0?1:0}],he[1].tables=[{id:1,name:"待调试业务",type:d.value.debuggedBusinessList.length>0?1:0},{id:2,name:"文件",type:ze.value.length>0||Dt.value.length>0||Ct.value.length>0||wt.value.length>0||Ft.value.length>0?1:0}]},Z=()=>{J.pageSize==1?J.pageSize=20:J.pageSize=1,be(m.id)},J=ot({page:1,pageSize:1,showSizePicker:!0,fuzzy:"",itemCount:0,pageSizes:[10,20],prefix:()=>`共 ${J.itemCount} 条`,onChange:e=>{J.page=e,be(m.id)},onUpdatePageSize:e=>{J.pageSize=e,J.page=1,be(m.id)}}),Be=[{title:"对接方",key:"docker",align:"center",render(e,t){return e.setStatus?a(ie,{value:e.docker,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].docker=o}}):a("div",{},e.docker)}},{title:"姓名",key:"pname",align:"center",render(e,t){return e.setStatus?a(ie,{value:e.pname,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].pname=o}}):a("div",{},e.pname)}},{title:"联系方式",key:"pcontact",align:"center",render(e,t){return e.setStatus?a(ie,{value:e.pcontact,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].pcontact=o}}):a("div",{},e.pcontact)}},{title:"备注",key:"proposition",align:"center",render(e,t){return e.setStatus?a(ie,{value:e.proposition,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].proposition=o}}):a("div",{},e.proposition)}},{title:"操作人",key:"username",align:"center"},{title:"操作时间",key:"dbtime",align:"center",render:e=>e.dbtime?Je(1,e.dbtime):""},{key:"operate",title:te("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return a("div",{class:"flex-center gap-8px"},[e.setStatus?[We("project:Form:Contact:insert")&&a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>Se(e)},{default:()=>"保存"}),a(z,{type:"default",ghost:!0,size:"small",onClick:()=>Fe(e,t)},{default:()=>"取消"}),We("project:Form:Contact:delete")&&a(rt,{onPositiveClick:async()=>{var o;if(e.id){const{data:i,error:$}=await Dl(e.id);i&&(d.value.contactList.splice(t,1),(o=window.$message)==null||o.success("删除成功"),be(m.id),m.status=0,oe())}else d.value.contactList.splice(t,1)}},{default:()=>te("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>te("common.delete")})})]:We("project:Form:Contact:update")&&a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>Ye(e)},{default:()=>"编辑"})])}}],be=async e=>{if(!e)return;const{data:t}=await Ht({page:J.page,limit:J.pageSize,pid:e});d.value.contactList=t==null?void 0:t.list,console.log(t.list,"项目联系人"),J.itemCount=t==null?void 0:t.total,d.value.contactList.forEach(o=>{o.setStatus=!1}),Y.contactList=JSON.parse(JSON.stringify(d.value.contactList)),we.value=!1},we=b(!1),Ye=e=>{d.value.contactList.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus,we.value=!0},Fe=(e,t)=>{e.setStatus=!e.setStatus,!e.id&&!we.value?d.value.contactList.splice(t,1):e.id&&we.value&&(d.value.contactList=JSON.parse(JSON.stringify(Y.contactList)))},Se=async e=>{var t,o,i,$,L;if(!e.docker){(t=window.$message)==null||t.warning("请输入对接方");return}if(!e.pname){(o=window.$message)==null||o.warning("请输入联系人姓名");return}if(!e.pcontact){(i=window.$message)==null||i.warning("请输入联系方式");return}if(e.id){const{data:ce,error:H}=await Sl([e]);H||(($=window.$message)==null||$.success("修改成功"),be(m.id),m.status=0,e.setStatus=!e.setStatus)}else if(E.operateType=="edit"){const{data:ce,error:H}=await Ll([{...e,pid:m.id}]);H||((L=window.$message)==null||L.success("添加成功"),be(m.id),e.setStatus=!e.setStatus,m.status=0,oe())}else e.setStatus=!e.setStatus,we.value=!1;Re()};function xe(){var e;$t.value.includes("1")||$t.value.push("1"),((e=d.value.contactList[0])!=null&&e.pname||d.value.contactList.length==0)&&(d.value.contactList.unshift({pname:"",pcontact:"",proposition:"",setStatus:!0}),we.value=!1)}const A=b([]),Te=async()=>{var o;const{data:e,error:t}=await ba({page:1,limit:100,id:m.proid});A.value=e==null?void 0:e.list.map(i=>({value:i.id,label:i.contractname,isLeaf:!1})),Ue((o=e==null?void 0:e.list[0])==null?void 0:o.id)},Ne=b([]),ye=b(),{pageData:q,getData:ve}=Ge(_a),Ue=async e=>{await ve({pids:e}),ye.value=[],Ne.value=Array.from(new Set([...Ne.value,...q.data])),ye.value=q.data.map(t=>({label:t.devname,value:t.id}))},n=async e=>{var t;await Ue(e.value),e.children=(t=ye.value)==null?void 0:t.map(o=>({label:o.label,value:o.value,isLeaf:!0}))},y=()=>{_.pageSize==1?_.pageSize=20:_.pageSize=1,f(m.id)},_=ot({page:1,pageSize:1,itemCount:0,showSizePicker:!0,fuzzy:"",pageSizes:[10,20],prefix:()=>`共 ${_.itemCount} 条`,onChange:e=>{_.page=e,f(m.id)},onUpdatePageSize:e=>{_.pageSize=e,_.page=1,f(m.id)}}),r=b(),c=[{title:"绑定合同设备",key:"cid",width:220,align:"center",render(e,t){var o,i;return e.setStatus?a(Rt,{style:"width: 200px",value:e.cid,filterable:!0,placeholder:"请选择合同设备",options:A.value,checkStrategy:"child",showPath:!1,remote:!0,renderSuffix:$=>$.option.hidden?null:$.node,renderLabel:$=>$.hidden?null:$.label,onLoad:n,onUpdateValue($){var ce;d.value.debuggedDevieceList[t].cid=Number($)||0;const L=(ce=Ne.value)==null?void 0:ce.find(H=>H.id==$);e.devname=(L==null?void 0:L.devname)||"",e.devnum=(L==null?void 0:L.devcount)||"",e.notes=(L==null?void 0:L.notes)||"",r.value=(L==null?void 0:L.devcount)||0,e.etype=(L==null?void 0:L.devtype)||0,e.devmanu=(L==null?void 0:L.devmanu)||"",e.devmodel=((L==null?void 0:L.devmodel.length)>64?L==null?void 0:L.devname:L==null?void 0:L.devmodel)||"",e.devunit=(L==null?void 0:L.devunit)||""}}):a("div",{},e.devname2||((i=(o=ye.value)==null?void 0:o.find($=>$.value==e.cid))==null?void 0:i.label))}},{title:"设备名称",key:"devname",width:200,align:"center",render(e,t){return e.setStatus?a(ie,{value:e.devname,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].devname=o}}):a("div",{},e.devname)}},{title:"型号",key:"devmodel",width:100,align:"center",render(e){return a(nl,{tooltipPlacement:"center",style:{maxWidth:"100px"}},{default:()=>e.devmodel||"",tooltip:()=>a("div",{style:{textAlign:"center",padding:"8px",maxWidth:"600px"}},e.devmodel||"")})}},{title:"设备单位",key:"devunit",width:80,align:"center",render(e,t){return a("div",{},e.devunit)}},{title:"数量",key:"devnum",width:100,align:"center",render(e,t){return e.setStatus?a(ha,{value:e.devnum,placeholder:"请输入",max:r.value,onUpdateValue(o){d.value.debuggedDevieceList[t].devnum=o}}):a("div",{},e.devnum)}},{title:"是否为我司设备",key:"etype",width:120,align:"center",render(e,t){return a("div",{},e.etype==0?"是":"否")}},{title:"设备厂家",key:"devmanu",width:100,align:"center",render(e,t){return a("div",{},e.devmanu)}},{title:"厂家联系人",key:"manucontact",width:100,align:"center",render(e,t){return e.setStatus?a(ie,{value:e.manucontact,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].manucontact=o}}):a("div",{},e.manucontact)}},{title:"厂家联系方式",key:"manuinfo",width:100,align:"center",render(e,t){return e.setStatus?a(ie,{value:e.manuinfo,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].manuinfo=o}}):a("div",{},e.manuinfo)}},{title:"文件",key:"re1",width:100,align:"center",render(e,t){return e.setStatus?a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>Qt(e,"debuggedDevieceList",t)},{default:()=>"上传文件"}):a(pt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const o=[{alias:e.re1,file:e.fl1},{alias:e.re2,file:e.fl2},{alias:e.re3,file:e.fl3},{alias:e.re4,file:e.fl4}].filter(i=>i.alias||i.file);return o.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件"),a("th",{style:"text-align:center; padding: 4px 8px;"},"操作")])]),a("tbody",o.map((i,$)=>{var L;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},i.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((L=i.file)==null?void 0:L.split("?")[1])||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>ea({url:i.file})},{default:()=>"下载"}))])}))])])}})}},{title:"设备状态",key:"devstatus",width:120,align:"center",render(e,t){return e.setStatus&&e.id?a(je,{value:e.devstatus,filterable:!0,placeholder:"请选择",options:[{label:"设备无异常",value:0},{label:"异常",value:1},{label:"未知",value:2}],onUpdateValue(o){d.value.debuggedDevieceList[t].devstatus=Number(o)||0}}):a("div",{},e.devstatus===0?"设备无异常":e.devstatus===1?"异常":"未知")}},{title:"接线方式",key:"connectionmode",width:100,align:"center",render(e,t){return e.setStatus?a(ie,{value:e.connectionmode,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].connectionmode=o}}):a("div",{},e.connectionmode)}},{title:"是否安装就位",key:"install",width:120,align:"center",render(e,t){return e.setStatus&&e.id?a(je,{value:e.install,filterable:!0,placeholder:"请选择",options:[{label:"是",value:0},{label:"否",value:1}],onUpdateValue(o){d.value.debuggedDevieceList[t].install=Number(o)||0}}):a("div",{},e.install===0?"是":"否")}},{title:"备注",key:"notes",width:100,align:"center",render(e,t){return e.setStatus?a(ie,{value:e.notes,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].notes=o}}):a("div",{},e.notes)}},{title:"操作信息",key:"dbtime",width:180,align:"center",render(e,t){return a(pt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},e.dbtime?Je(1,e.dbtime):""),default:()=>a("div",{style:"padding: 10px;"},s("div",null,[s("div",null,[P("操作人："),e.username]),s("div",null,[P("操作时间："),e.dbtime]),s("div",null,[P("清点人："),e.dusername]),s("div",null,[P("清点时间："),e.ddbtime])]))})}},{key:"operate",title:te("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return a("div",{class:"flex-center gap-8px"},[e.setStatus?[a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>v(e)},{default:()=>"保存"}),a(z,{type:"default",ghost:!0,size:"small",onClick:()=>u(e,t)},{default:()=>"取消"}),We("project:Form:Equipment:delete")&&a(rt,{onPositiveClick:async()=>{var o,i;if(e.id){const{data:$,error:L}=await wl(e.id);$&&(d.value.debuggedDevieceList.splice(t,1),(o=window.$message)==null||o.success("删除成功"),m.status=0,f(m.id),oe())}else{if(d.value.debuggedBusinessList.some(L=>L.eqmid==e.eqmid))return(i=window.$message)==null?void 0:i.error("该设备在待调试业务中已绑定，请先解除绑定后在删除！");d.value.debuggedDevieceList.splice(t,1)}}},{default:()=>te("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>te("common.delete")})})]:We("project:Form:Equipment:update")&&a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>l(e)},{default:()=>"编辑"})])}}],f=async e=>{if(!e)return;const{data:t}=await Jt({page:_.page,limit:_.pageSize,fuzzy:_.fuzzy,pid:e});d.value.debuggedDevieceList=t.list,_.itemCount=t.total,d.value.debuggedDevieceList.forEach(o=>{o.setStatus=!1}),Y.debuggedDevieceList=JSON.parse(JSON.stringify(d.value.debuggedDevieceList)),C.value=!1,oe()},C=b(!1),l=async e=>{console.log(q.data,e.cid,"ssssssssssssssss"),d.value.debuggedDevieceList.forEach(i=>{i.setStatus=!1});const{data:t,error:o}=await il(e.cid);o||(A.value[A.value.length-1].value!=t.id&&A.value.push({value:t.id,label:t.devname,disabled:!0,isLeaf:!0,hidden:!0}),r.value=t.devcount||0),C.value=!0,e.setStatus=!e.setStatus},u=(e,t)=>{e.setStatus=!e.setStatus,!e.id&&!C.value?d.value.debuggedDevieceList.splice(t,1):e.id&&C.value&&(d.value.debuggedDevieceList=JSON.parse(JSON.stringify(Y.debuggedDevieceList)))},v=async e=>{var t,o,i,$,L,ce;if(!e.cid){(t=window.$message)==null||t.warning("请选择合同设备");return}if(!e.devname){(o=window.$message)==null||o.warning("设备名称不能为空");return}if(!e.devmodel){(i=window.$message)==null||i.warning("设备型号不能为空");return}if(!e.devnum){($=window.$message)==null||$.warning("设备数量不能为空");return}if(e.fileList.length>0&&E.operateType=="edit"){const H=e.fileList.filter(me=>me.file),se=H.length;for(let me=0;me<se;me++){const N=H[me];N.indexText=`${me+1}/${se}`,N.progress=0,N.status="uploading";try{N.url=await tt(N.file.file,N.file.name,""),N.progress=100,N.status="done"}catch{N.status="error"}}e.fileList.forEach((me,N)=>{e[`re${N+1}`]=me.name||"",e[`fl${N+1}`]=me.url||""}),delete e.fileList}if(e.id&&E.operateType=="edit"){const{data:H,error:se}=await Cl([e]);se||((L=window.$message)==null||L.success("修改成功"),f(m.id),m.status=0,e.setStatus=!e.setStatus)}else if(E.operateType=="edit"){const{data:H,error:se}=await La([{...e,pid:m.id}]);se||((ce=window.$message)==null||ce.success("添加成功"),f(m.id),m.status=0,e.setStatus=!e.setStatus,oe())}else e.id?e.id:ka(),e.setStatus=!e.setStatus,C.value=!1},F=b(!1);function D(){F.value=!0}const{pageData:U,getData:x,nextPage:V}=Ge(ya),R=async()=>{await x({usertypes:"2,3"})},de=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&U.data.length<U.total&&(await V(),await Xe(),setTimeout(()=>{t.scrollTop=o}))},{pageData:re,getData:le,nextPage:Me}=Ge(ma),fe=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&re.data.length<re.total&&(await Me(),await Xe(),setTimeout(()=>{t.scrollTop=o}))},k=async()=>{await le(),re.data=re.data.map(e=>(e.name=`${e.weight}  `+e.tname,e))},{pageData:g,getData:B,nextPage:j}=Ge(Ht),Ee=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&g.data.length<g.total&&(await j(),g.data=g.data.map(i=>({...i,value:i.docker+"&id="+i.id})),await Xe(),setTimeout(()=>{t.scrollTop=o}))},Re=async()=>{await B({pid:m.id}),g.data=g.data.map(e=>({...e,value:e.docker+"&id="+e.id}))},{pageData:it,getData:Ze,nextPage:zt}=Ge(Jt),jt=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&re.data.length<re.total&&(await zt(),await Xe(),setTimeout(()=>{t.scrollTop=o}))},Pt=async()=>{m.id&&await Ze({pid:m.id})},ut=b(),gt=[{title:"权重",key:"dtype",width:180,align:"center",render(e,t){var o;return e.setStatus?a(je,{value:e.dtype,filterable:!0,placeholder:"请选择权重",options:re.data,labelField:"tname",valueField:"id",onUpdateValue(i){var $;d.value.debuggedBusinessList[t].dtype=Number(i)||0,d.value.debuggedBusinessList[t].debugname=(($=re.data.find(L=>L.id==i))==null?void 0:$.tname)||""},onScroll(i){fe(i)}}):a("div",{},e.tname||((o=re.data.find(i=>i.id==e.dtype))==null?void 0:o.tname))}},{title:"业务名称",key:"debugname",width:180,align:"center",render(e,t){return e.setStatus?a(ie,{value:e.debugname,placeholder:"请输入业务名称",onUpdateValue(o){d.value.debuggedBusinessList[t].debugname=o}}):a("div",{},e.debugname)}},{key:"eqmname",title:"调试设备",align:"center",width:150,render(e,t){var o;return e.setStatus?a(je,{value:e.eqmid,placeholder:"请选择调试设备",options:E.operateType=="edit"?it.data:d.value.debuggedDevieceList,onscroll:jt,labelField:"devname",valueField:"id",clearable:!0,filterable:!0,onUpdateValue(i){d.value.debuggedBusinessList[t].eqmid=i}}):a("div",{},e.eqmname||((o=d.value.debuggedDevieceList.find(i=>i.eqmid==e.eqmid))==null?void 0:o.devname))}},{title:"调试人",key:"dbcreater",width:120,align:"center",render(e,t){var o;return e.setStatus?a(je,{value:e.dbcreater,filterable:!0,placeholder:"请选择调试人",options:U.data,labelField:"username",valueField:"id",onUpdateValue(i){d.value.debuggedBusinessList[t].dbcreater=i||0},onScroll(i){de(i)}}):a("div",{},e.dbusername||((o=U.data.find(i=>i.id==e.dbcreater))==null?void 0:o.username))}},{title:"对接方",key:"docker",width:120,align:"center",render(e,t){var o;return e.setStatus?a(je,{value:e.docker,placeholder:"请输入或选择对接方",options:E.operateType=="edit"?g.data:d.value.contactList,onscroll:Ee,labelField:"docker",valueField:"value",clearable:!0,filterable:!0,tag:!0,onClear(){e.dockcharge="",e.dockcontact=""},onUpdateValue(i){var H;d.value.debuggedBusinessList[t].docker=i;const[$,L]=(H=e.docker)==null?void 0:H.split("&id="),ce=g.data.find(se=>se.docker===$&&se.id===Number(L));ce?(e.dockcharge=ce.pname,e.dockcontact=ce.pcontact):(e.dockcharge="",e.dockcontact="")}}):a("div",{},(o=e.docker)==null?void 0:o.split("&id=")[0])}},{title:"对接方负责人",key:"dockcharge",width:100,align:"center",render(e,t){return e.setStatus?a(ie,{value:e.dockcharge,placeholder:"请输入对接方负责人",onUpdateValue(o){d.value.debuggedBusinessList[t].dockcharge=o}}):a("div",{},e.dockcharge)}},{title:"联系方式",key:"dockcontact",width:140,align:"center",render(e,t){return e.setStatus?a(ie,{value:e.dockcontact,placeholder:"请输入联系方式",onUpdateValue(o){d.value.debuggedBusinessList[t].dockcontact=o}}):a("div",{},e.dockcontact)}},{title:"文件",key:"re1",width:80,align:"center",render(e,t){return e.setStatus?a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>Qt(e,"debuggedBusinessList",t)},{default:()=>"上传文件"}):a(pt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const o=[{alias:e.re1,file:e.fl1},{alias:e.re2,file:e.fl2},{alias:e.re3,file:e.fl3},{alias:e.re4,file:e.fl4}].filter(i=>i.alias||i.file);return o.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件"),a("th",{style:"text-align:center; padding: 4px 8px;"},"操作")])]),a("tbody",o.map((i,$)=>{var L;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},i.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((L=i.file)==null?void 0:L.split("?")[1])||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>ea({url:i.file})},{default:()=>"下载"}))])}))])])}})}},{title:"备注",key:"notes",width:120,align:"center",render(e,t){return e.setStatus?a(ie,{value:e.notes,placeholder:"请输入备注",onUpdateValue(o){d.value.debuggedBusinessList[t].notes=o}}):a("div",{},e.notes)}},{title:"计划开始时间",key:"starttime",width:140,align:"center",render(e,t){return e.setStatus?a(bt,{type:"date",clearable:!0,value:e.starttime,valueFormat:"yyyy-MM-dd",placeholder:"请选择",onUpdateValue(o){d.value.debuggedBusinessList[t].starttime=o}}):a("div",e.starttime?Je(0,e.starttime):"")}},{title:"计划结束时间",key:"endtime",width:140,align:"center",render:(e,t)=>e.setStatus?a(bt,{type:"date",clearable:!0,valueFormat:"yyyy-MM-dd",value:e.endtime,placeholder:"请选择",onUpdateValue(o){d.value.debuggedBusinessList[t].endtime=o}}):e.endtime?Je(0,e.endtime):""},{key:"username",title:"创建信息",align:"left",width:240,render(e){return s("div",{style:"display:flex; flex-direction:column; gap:3px; line-height:1.4;"},[s("div",null,[s("span",{style:"color:#666"},[P("创建人：")]),s("span",null,[e.username||"-"])]),s("div",null,[s("span",{style:"color:#666"},[P("时间：")]),s("span",null,[e.dbtime||"-"])])])}},{key:"operate",title:te("common.operate"),align:"center",width:280,fixed:"right",render(e,t){return a("div",{class:"flex-center gap-8px"},[e.setStatus?[We("project:Form:Debug:insert")&&a(rt,{onPositiveClick:()=>{wa(e)}},{default:()=>"是否确认保存？",trigger:()=>a(z,{type:"info",ghost:!0,size:"small"},{default:()=>"保存"})}),a(z,{type:"default",ghost:!0,size:"small",onClick:()=>Ca(e,t)},{default:()=>"取消"}),We("project:Form:Debug:delete")&&a(rt,{onPositiveClick:async()=>{var o;if(e.id){const{data:i,error:$}=await Tl(e.id);i&&(d.value.debuggedBusinessList.splice(t,1),(o=window.$message)==null||o.success("删除成功"),I(m.id),m.status=0,oe())}else d.value.debuggedBusinessList.splice(t,1)}},{default:()=>te("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>te("common.delete")})})]:We("project:Form:Debug:update")&&a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>Da(e)},{default:()=>"编辑"})])}}],De=ot({page:1,pageSize:1,showSizePicker:!0,itemCount:0,creater:"",pageSizes:[10,20],prefix:()=>`共 ${De.itemCount} 条`,onChange:e=>{De.page=e,I(m.id)},onUpdatePageSize:e=>{De.pageSize=e,De.page=1,I(m.id)}}),Lt=()=>{De.pageSize==1?De.pageSize=20:De.pageSize=1,I(m.id)},I=async e=>{if(!e)return;const{data:t}=await Fl({page:De.page,limit:De.pageSize,creater:ae.userInfo.id,pid:e});d.value.debuggedBusinessList=t.list,De.itemCount=t.total,d.value.debuggedBusinessList.forEach(o=>{o.setStatus=!1}),Y.debuggedBusinessList=JSON.parse(JSON.stringify(d.value.debuggedBusinessList)),vt.value=!1},vt=b(!1),Da=e=>{e.starttime=oa(e.starttime),e.endtime=oa(e.endtime),ut.value=e.status,d.value.debuggedBusinessList.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus,vt.value=!0},Ca=(e,t)=>{e.setStatus=!e.setStatus,!e.id&&!vt.value?d.value.debuggedBusinessList.splice(t,1):e.id&&vt.value&&(d.value.debuggedBusinessList=JSON.parse(JSON.stringify(Y.debuggedBusinessList)))},wa=async e=>{var i,$,L,ce,H,se,me,N,ue,ge;if(!e.dtype){(i=window.$message)==null||i.warning("请选择权重");return}if(!e.debugname){($=window.$message)==null||$.warning("请输入业务名称");return}if(!e.docker){(L=window.$message)==null||L.warning("请选择或输入对接方");return}if(!e.dockcharge){(ce=window.$message)==null||ce.warning("请输入对接方负责人");return}if(!e.dockcontact){(H=window.$message)==null||H.warning("请输入对接方联系方式");return}if(!e.dbcreater){(se=window.$message)==null||se.warning("请选择调试人");return}const t=Je(0,e.starttime),o=Je(0,e.endtime);if(e.id){const G=JSON.parse(JSON.stringify(e));ut.value==G.status&&delete G.status,G.docker=(me=G.docker)==null?void 0:me.split("&id=")[0];const{data:K,error:He}=await $l([{...G,starttime:t,endtime:o}]);He||((N=window.$message)==null||N.success("修改成功"),I(m.id),m.status=0,e.setStatus=!e.setStatus)}else if(E.operateType=="edit"){e.docker=(ue=e.docker)==null?void 0:ue.split("&id=")[0];const{data:G,error:K}=await Sa([{...e,starttime:t,endtime:o,pid:m.id}]);K||((ge=window.$message)==null||ge.success("添加成功"),I(m.id),e.setStatus=!e.setStatus,m.status=0,oe())}else e.setStatus=!e.setStatus,vt.value=!1},St=b(!1);function Fa(){St.value=!0}const $a=()=>{const e=document.getElementById("__SCROLL_EL_ID__");e==null||e.scrollTo({top:0,behavior:"smooth"})},Yt=e=>{he[e].show=!he[e].show},Bt=e=>{const t=document.getElementById(e);t&&(t.scrollIntoView({behavior:"smooth",block:"start"}),Le.value=e)},Nt=()=>{const e=[];he.forEach(i=>{i.tables.forEach(($,L)=>e.push(`${i.id}-${L}`))});const t=window.scrollY;let o="";for(const i of e){const $=document.getElementById(i);$&&$.offsetTop-100<=t&&(o=i)}Le.value=o},ze=b([]),Dt=b([]),Ct=b([]),wt=b([]),Ft=b([]),Et=b([]),Zt=b({});async function Vt(e){const{data:t,error:o}=await Ul({limit:100,page:1,pid:e});o||(d.value.fileList=[],ze.value=[],Dt.value=[],Ct.value=[],wt.value=[],Ft.value=[],Et.value=[],Zt.value=t,console.log("data",Zt.value),t.list.forEach(i=>{i.sort==1&&d.value.fileList.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==2&&ze.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==3&&Dt.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==4&&Ct.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==5&&wt.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==6&&Ft.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==7&&Et.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime})}),d.value.fileList.reverse(),ze.value.reverse(),Dt.value.reverse(),Ct.value.reverse(),wt.value.reverse(),Ft.value.reverse(),Et.value.reverse(),oe())}const Ta=e=>{const t=e.target,o=document.getElementById("__SCROLL_EL_ID__"),i=document.getElementById("scrollToTop");!o||!i||(t.scrollTop>(o.clientHeight||0)+500?i.classList.add("show"):i.classList.remove("show"))},mt=b(!1),st=b(""),At=b(),Qt=(e,t,o)=>{Qe.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}],mt.value=!0,st.value=t,At.value=o,e.re1&&(Qe.value[0]={name:e.re1,url:e.fl1,file:void 0}),e.re2&&(Qe.value[1]={name:e.re2,url:e.fl2,file:void 0}),e.re3&&(Qe.value[2]={name:e.re3,url:e.fl3,file:void 0}),e.re4&&(Qe.value[3]={name:e.re4,url:e.fl4,file:void 0}),console.log(Qe.value)},Ua=[{title:"",key:"",align:"center",render(e,t){return`附件${t+1}`}},{title:"文件名称",key:"filename",align:"center",render(e){var i;const t=async({file:$,onFinish:L,onError:ce})=>{var H,se;try{e.name=$.name,e.file=$}catch(me){console.error(me),(se=(H=window.$message)==null?void 0:H.error)==null||se.call(H,"文件上传出错")}};async function o($){var L;return $.file.file.size>100*1024*1024?((L=window.$message)==null||L.error("文件大小不能超过100M"),!1):!0}return a("div",{style:"display:flex;justify-content:center;align-items:center;"},[e.file||e.url?a("span",{},[a("span",{},((i=e.file)==null?void 0:i.name)||e.url.split("?")[1]||""),a("span",{style:"color:red;cursor:pointer;font-size:12px;margin-left:8px;",onClick:()=>{e.url="",e.file=null,e.name=""}},"删除")]):a(ht,{action:"#",showFileList:!1,customRequest:t,onBeforeUpload:o},{default:()=>a(z,{type:"info",size:"small",ghost:!0,loading:e.status},{default:()=>"上传文件"})})])}},{title:"文件别名",key:"name",align:"center",render(e){return a(ie,{value:e.name,clearable:!0,onUpdateValue:t=>{e.name=t}})}}],Qe=b([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]);async function ea(e){if(e!=null&&e.url)try{const o=await(await fetch(e.url.split("?")[0],{mode:"cors"})).blob(),i=URL.createObjectURL(o),$=document.createElement("a");$.href=i,$.download=e.url.split("?")[1],$.style.display="none",document.body.appendChild($),$.click(),document.body.removeChild($),URL.revokeObjectURL(i)}catch(t){console.error("下载失败:",t)}}const za=async()=>{var t,o;let e=!0;if(Qe.value.forEach((i,$)=>{var H,se;const L=i.name||"",ce=((H=i.url)==null?void 0:H.split("?")[1])||((se=i.file)==null?void 0:se.name);(L&&!ce||!L&&ce)&&(e=!1)}),!e){(o=(t=window.$message)==null?void 0:t.error)==null||o.call(t,"文件名称和文件地址必须同时存在，不能只填一个");return}d.value[st.value][At.value].fileList=Qe.value,e&&(mt.value=!1,st.value="",At.value=void 0)},ja=()=>{mt.value=!1};xa(async()=>{Ae(),h.query.IsScroll&&setTimeout(()=>{Bt("phase2-0")},800),window.addEventListener("scroll",Nt);const e=document.getElementById("__SCROLL_EL_ID__");e&&e.addEventListener("scroll",Ta)}),sl(()=>{window.removeEventListener("scroll",Nt);const e=document.getElementById("__SCROLL_EL_ID__");e&&e.removeEventListener("scroll",Nt)});const $t=b(["1","2","3"]),Pa=e=>{$t.value=e},ta=b(["1","2","3","4"]),Ba=e=>{ta.value=e},Na=Kt(()=>({add:"新增项目调试单",edit:"修改项目调试单"})[E.operateType]),Ea=e=>{d.value.debuggedDevieceList=d.value.debuggedDevieceList.concat(e).map(t=>({...t,cid:t.cid*1,setStatus:!1})),F.value=!1},Va=e=>{d.value.debuggedBusinessList=d.value.debuggedBusinessList.concat(e).map(t=>({...t,setStatus:!1})),St.value=!1},aa=e=>{e.fileType==2?ze.value=ze.value.concat(e.row).map(t=>({...t})):d.value.fileList=d.value.fileList.concat(e.row).map(t=>({...t}))},la=e=>{e.fileType==2?ze.value.splice(e.index,1):d.value.fileList.splice(e.index,1)},Mt=b();async function Aa(e=0){var t;await Mt.value[0].validate(),(t=window.$dialog)==null||t.info({title:"提示",content:"确定保存并提交吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await na(e)}})}const at=b(!1);async function na(e=0){var t,o,i,$,L,ce;if(!at.value)try{if(await Mt.value[0].validate(),at.value=!0,E.operateType==="edit"){const H=JSON.parse(JSON.stringify(e==1?{...m,status:e}:{...m})),{data:se,error:me}=await bl([H]);me||((t=window.$message)==null||t.success("保存成功"),ee("returnandSub"))}else{if(d.value.debuggedDevieceList.length>0)for(const N of d.value.debuggedDevieceList){if(!N.fileList||N.fileList.length===0)continue;const ue=N.fileList.filter(G=>G.file),ge=ue.length;for(let G=0;G<ge;G++){const K=ue[G];K.indexText=`${G+1}/${ge}`,K.progress=0,K.status="uploading";try{K.url=await tt(K.file.file,K.file.name,""),K.progress=100,K.status="done"}catch{K.status="error",(i=(o=window.$message)==null?void 0:o.error)==null||i.call(o,"文件上传失败，请重试");return}}N.fileList.forEach((G,K)=>{const He=`re${K+1}`,_e=`fl${K+1}`;G.status==="done"?(N[He]=G.name||"",N[_e]=G.url||""):(N[He]="",N[_e]="")}),delete N.fileList}if(d.value.debuggedBusinessList.length>0)for(const N of d.value.debuggedBusinessList){if(!N.fileList||N.fileList.length===0)continue;const ue=N.fileList.filter(G=>G.file),ge=ue.length;for(let G=0;G<ge;G++){const K=ue[G];K.indexText=`${G+1}/${ge}`,K.progress=0,K.status="uploading";try{K.url=await tt(K.file.file,K.file.name,""),K.progress=100,K.status="done"}catch{K.status="error",(L=($=window.$message)==null?void 0:$.error)==null||L.call($,"文件上传失败，请重试");return}}N.fileList.forEach((G,K)=>{const He=`re${K+1}`,_e=`fl${K+1}`;G.status==="done"?(N[He]=G.name||"",N[_e]=G.url||""):(N[He]="",N[_e]="")}),delete N.fileList}if(d.value.fileList.length>0){const N=d.value.fileList.length;for(let ue=0;ue<N;ue++){const ge=d.value.fileList[ue];if(!(!ge.file||typeof ge.file!="object"))try{ge.url=await tt(ge.file,ge.name,"",G=>{})}catch{}}d.value.fileList=d.value.fileList.map(ue=>({...ue,file:ue.url}))}if(ze.value.length>0){const N=ze.value.length;for(let ue=0;ue<N;ue++){const ge=ze.value[ue];if(!(!ge.file||typeof ge.file!="object"))try{ge.url=await tt(ge.file,ge.name,"",G=>{})}catch{}}ze.value=ze.value.map(ue=>({...ue,file:ue.url}))}const H=e==1?{...m,status:e}:{...m},{data:se,error:me}=await hl({projectFormPojo:H,projectFormContactPojoList:d.value.contactList,projectFormDebugPojos:d.value.debuggedBusinessList,projectFormEquipmentPojoList:d.value.debuggedDevieceList,projectFormFilePojos:d.value.fileList.concat(ze.value)});se&&((ce=window.$message)==null||ce.success(se||"添加成功"),ee("returnandSub"))}}catch(H){console.error("提交失败:",H)}finally{at.value=!1}}return(e,t)=>{const o=Ml,i=El,$=ol,L=qa,ce=Ra,H=pa,se=da,me=ca,N=Ja,ue=Ha,ge=xt,G=cl,K=yt("no-auth"),He=yt("loading");return T(),O(et,null,[s($,{bordered:!1,size:"small",class:"card-wrapper"},{default:p(()=>[M("div",sn,[M("h2",on,ne(Na.value),1),M("div",rn,[s(S(z),{ghost:"",type:"primary",onClick:Tt(Ve,["stop"])},{icon:p(()=>[s(o,{class:"text-icon"})]),default:p(()=>[t[16]||(t[16]=P(" 返回 "))]),_:1,__:[16]}),s(S(z),{type:"primary",onClick:t[0]||(t[0]=_e=>na()),loading:at.value},{icon:p(()=>[s(i,{class:"text-icon"})]),default:p(()=>[t[17]||(t[17]=P(" "+ne("保存")))]),_:1,__:[17]},8,["loading"]),m.status==0?(T(),ke(S(z),{key:0,type:"primary",onClick:t[1]||(t[1]=_e=>Aa(1)),loading:at.value},{icon:p(()=>[s(i,{class:"text-icon"})]),default:p(()=>[t[18]||(t[18]=P(" "+ne("保存并提交")))]),_:1,__:[18]},8,["loading"])):W("",!0)])])]),_:1}),s(G,{style:{height:"calc(100vh - 182px)"}},{default:p(()=>[lt((T(),O("div",un,[M("div",{id:"scrollToTop",onClick:$a,title:"回到顶部"},[s(L,{class:"font-size-30px"})]),s($,{bordered:!1,size:"small",class:"card-wrapper pb-40px"},{default:p(()=>[M("div",dn,[M("div",cn,[M("div",pn,[(T(!0),O(et,null,ra(he,(_e,dt)=>(T(),O("div",{key:_e.id,class:"timeline-phase"},[M("div",{class:"timeline-row",id:"phase"+(dt+1)},[M("div",gn,[t[19]||(t[19]=M("div",{class:"vertical-line"},null,-1)),M("div",{class:"flashing-icon",onClick:Ie=>Yt(dt)},null,8,vn)]),M("div",mn,[M("div",{class:"phase-title",onClick:Ie=>Yt(dt)},ne(_e.title),9,yn),s(S(Pe))])],8,fn),s(rl,{name:"fade"},{default:p(()=>[lt(M("div",hn,[dt===0?(T(),O("div",bn,[s(nn,{ref_for:!0,ref_key:"prjDetailRef",ref:Mt,onSubmit:qe,prjInfo:m,"onUpdate:prjInfo":t[2]||(t[2]=Ie=>m=Ie),onChangePrj:Te,"operate-type":E.operateType},null,8,["prjInfo","operate-type"])])):W("",!0),(T(!0),O(et,null,ra(_e.tables,(Ie,ct)=>(T(),O("div",{key:`${_e.id}-${ct}`,class:"timeline-row"},[M("div",_n,[t[20]||(t[20]=M("div",{class:"vertical-line"},null,-1)),Ie.type==1?(T(),O("div",{key:0,class:ul(["icon",{active:Le.value===`${_e.id}-${ct}`}]),style:{"font-size":"20px",border:"3px solid #409eff",color:"#409eff"},onClick:Q=>Bt(`${_e.id}-${ct}`)},[s(ce)],10,kn)):(T(),O("div",{key:1,class:"icon",style:{"font-size":"20px",border:"3px solid #ccc",color:"#ccc"},onClick:Q=>Bt(`${_e.id}-${ct}`)}," 一 ",8,xn))]),M("div",{class:"actProgress",style:qt({background:Ie.type==1?"#409eff":"#ccc"})},null,4),M("div",{class:"timeline-content",id:`${_e.id}-${ct}`},[dt===0?(T(),O(et,{key:0},[s(ue,{"expanded-names":$t.value,"onUpdate:expandedNames":Pa,"trigger-areas":["arrow"]},{default:p(()=>[Ie.id==1?(T(),ke(N,{key:0,name:"1"},{header:p(()=>[s(S(Pe),{align:"center",justify:"space-between",style:{width:"100%"}},{default:p(()=>[M("div",Sn,[t[22]||(t[22]=M("span",null,"项目联系人",-1)),lt((T(),ke(S(z),{size:"small",ghost:"",type:"primary",class:"pos-absolute left-140px",onClick:Tt(xe,["stop"])},{icon:p(()=>[s(H,{class:"text-icon"})]),default:p(()=>[t[21]||(t[21]=P(" 添加项目联系人 "))]),_:1,__:[21]})),[[K,"project:Form:Contact:insert"]])]),J.itemCount>0?(T(),O("div",Dn,"共"+ne(J.itemCount)+"条",1)):W("",!0)]),_:1})]),default:p(()=>[d.value.contactList.length>0?(T(),ke(S(nt),{key:0,columns:Be,data:d.value.contactList,size:"small","scroll-x":702,"row-key":Q=>Q.id,"paginate-single-page":!1,"max-height":350,pagination:J.pageSize==1?!1:J,remote:""},null,8,["data","row-key","pagination"])):W("",!0),J.itemCount>1?(T(),O("div",Cn,[d.value.contactList.length==1?(T(),O("span",{key:0,onClick:Z},[t[23]||(t[23]=P("更多")),s(se,{class:"font-size-20px"})])):(T(),O("span",{key:1,onClick:Z},[t[24]||(t[24]=P("收起")),s(me,{class:"font-size-20px"})]))])):W("",!0)]),_:1})):W("",!0),Ie.id==2?(T(),ke(N,{key:1,title:"待调试设备",name:"2"},{header:p(()=>[s(S(Pe),{align:"center",justify:"space-between",style:{width:"100%"}},{default:p(()=>[M("div",wn,[t[26]||(t[26]=M("span",null,"待调试设备",-1)),lt((T(),ke(S(z),{size:"small",ghost:"",type:"primary",class:"pos-absolute left-140px",onClick:Tt(D,["stop"])},{icon:p(()=>[s(H,{class:"text-icon"})]),default:p(()=>[t[25]||(t[25]=P(" 添加待调试设备 "))]),_:1,__:[25]})),[[K,"project:Equipment:insert"]])]),_.itemCount>0?(T(),O("div",Fn,"共"+ne(_.itemCount)+"条",1)):W("",!0)]),_:1})]),default:p(()=>[s(Ql,{onSubmitted:t[3]||(t[3]=Q=>{f(m.id),m.status=0}),onSubmittedData:t[4]||(t[4]=Q=>Ea(Q)),visible:F.value,"onUpdate:visible":t[5]||(t[5]=Q=>F.value=Q),"operate-type":E.operateType,pid:m.id,proid:m.proid},null,8,["visible","operate-type","pid","proid"]),d.value.debuggedDevieceList.length>0?(T(),ke(S(nt),{key:0,style:qt({width:S(X).siderCollapse?"calc(100vw - 219px)":"calc(100vw - 375px)"}),columns:c,data:d.value.debuggedDevieceList,size:"small","scroll-x":c.reduce((Q,It)=>Q+It.width,0),"row-key":Q=>Q.id,"max-height":350,pagination:_.pageSize==1?!1:_,remote:"","paginate-single-page":!1},null,8,["style","data","scroll-x","row-key","pagination"])):W("",!0),_.itemCount>1?(T(),O("div",$n,[d.value.debuggedDevieceList.length==1?(T(),O("span",{key:0,onClick:y},[t[27]||(t[27]=P("更多")),s(se,{class:"font-size-20px"})])):(T(),O("span",{key:1,onClick:y},[t[28]||(t[28]=P("收起")),s(me,{class:"font-size-20px"})]))])):W("",!0)]),_:2},1024)):W("",!0),Ie.id==3?(T(),ke(N,{key:2,title:"图纸",name:"3"},{default:p(()=>[s(ua,{data:d.value.fileList,onRemoveData:t[6]||(t[6]=Q=>la(Q)),pid:m.id,"operate-type":E.operateType,onGetData:t[7]||(t[7]=Q=>{Vt(m.id),m.status=0}),typename:"图纸",onSubmittedData:t[8]||(t[8]=Q=>aa(Q)),fileType:1},null,8,["data","pid","operate-type"])]),_:1})):W("",!0)]),_:2},1032,["expanded-names"]),Ie==4?(T(),O("div",Tn)):W("",!0)],64)):W("",!0),dt===1?(T(),O(et,{key:1},[s(ue,{"expanded-names":ta.value,"onUpdate:expandedNames":Ba,"trigger-areas":["arrow"]},{default:p(()=>[Ie.id==1?(T(),ke(N,{key:0,title:"待调试业务",name:"1"},{header:p(()=>[s(S(Pe),{align:"center",justify:"space-between",style:{width:"100%"}},{default:p(()=>[M("div",Un,[t[30]||(t[30]=M("span",null,[P("待调试业务 "),M("span",{class:"c-#f0a020 font-bold"},"※")],-1)),lt((T(),ke(S(z),{size:"small",ghost:"",type:"primary",class:"pos-absolute left-140px",onClick:Tt(Fa,["stop"])},{icon:p(()=>[s(H,{class:"text-icon"})]),default:p(()=>[t[29]||(t[29]=P(" 添加待调试业务 "))]),_:1,__:[29]})),[[K,"project:Debug:insert"]])]),De.itemCount>0?(T(),O("div",zn,"共"+ne(De.itemCount)+"条",1)):W("",!0)]),_:1})]),default:p(()=>[s(Zl,{onSubmitted:t[9]||(t[9]=Q=>{I(m.id),m.status=0}),visible:St.value,"onUpdate:visible":t[10]||(t[10]=Q=>St.value=Q),"operate-type":E.operateType,pid:m.id,contactList:d.value.contactList,debuggedDevieceList:d.value.debuggedDevieceList,onSubmittedData:t[11]||(t[11]=Q=>Va(Q))},null,8,["visible","operate-type","pid","contactList","debuggedDevieceList"]),d.value.debuggedBusinessList.length>0?(T(),ke(S(nt),{key:0,style:qt({width:S(X).siderCollapse?"calc(100vw - 219px)":"calc(100vw - 375px)"}),columns:gt,data:d.value.debuggedBusinessList,size:"small","row-key":Q=>Q.id,striped:"","scroll-x":gt.reduce((Q,It)=>Q+It.width,0),"paginate-single-page":!1,pagination:De.pageSize==1?!1:De,remote:"","max-height":350},null,8,["style","data","row-key","scroll-x","pagination"])):W("",!0),De.itemCount>1?(T(),O("div",jn,[d.value.debuggedBusinessList.length==1?(T(),O("span",{key:0,onClick:Lt},[t[31]||(t[31]=P(" 更多 ")),s(se,{class:"font-size-20px"})])):(T(),O("span",{key:1,onClick:Lt},[t[32]||(t[32]=P(" 收起 ")),s(me,{class:"font-size-20px"})]))])):W("",!0)]),_:1})):W("",!0),Ie.id===2?(T(),ke(N,{key:1,title:"文件",name:"2"},{default:p(()=>[s(ua,{data:ze.value,onRemoveData:t[12]||(t[12]=Q=>la(Q)),pid:m.id,onGetData:t[13]||(t[13]=Q=>{Vt(m.id),m.status=0}),typename:"项目文件",onSubmittedData:t[14]||(t[14]=Q=>aa(Q)),"operate-type":E.operateType,fileType:2},null,8,["data","pid","operate-type"])]),_:1})):W("",!0)]),_:2},1032,["expanded-names"]),ct===2?(T(),O("div",Pn)):W("",!0)],64)):W("",!0)],8,Ln)]))),128))],512),[[dl,_e.show]])]),_:2},1024)]))),128))])])])]),_:1}),s(ge,{show:mt.value,"onUpdate:show":t[15]||(t[15]=_e=>mt.value=_e),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:p(()=>[P(ne(st.value=="debuggedDevieceList"?"待调试设备":st.value=="debuggedBusinessList"?"待调试业务":st.value=="needsList"?"客户需求变更":st.value=="developBusinessList"?"需要开发":"")+" 文件列表 ",1)]),footer:p(()=>[s(S(Pe),{justify:"end"},{default:p(()=>[s(S(z),{size:"small",class:"mt-16px",onClick:ja},{default:p(()=>[P(ne(S(te)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",size:"small",class:"mt-16px",onClick:za},{default:p(()=>[P(ne(S(te)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(S(nt),{columns:Ua,"paginate-single-page":!1,data:Qe.value,"max-height":350},null,8,["data"])]),_:1},8,["show"])])),[[He,at.value]])]),_:1})],64)}}}),Nn=va(Bn,[["__scopeId","data-v-fb759da6"]]),Yn=Object.freeze(Object.defineProperty({__proto__:null,default:Nn},Symbol.toStringTag,{value:"Module"}));export{Wn as a,bl as b,Xn as f,Yn as i,Nn as p};
