import{_ as ue}from"./round-search-B4FRvaWk.js";import{d as le,r as _,a as V,at as ne,i as oe,dP as de,b as M,o as b,e as y,z,aT as se,aX as re,g as j,t as L,cJ as me,aP as ve,V as pe,aJ as fe,av as ie,M as ge,a$ as te,eD as he,f5 as ye,f as u,aS as be,az as we,w as D,c as S,h as f,aA as ke,N as Fe,A as _e,au as Te,aD as ae,B as xe,$ as De,U as Me,aI as Ce,b4 as Ae,aU as Ee}from"./index-DECenS4J.js";import{c as $e}from"./home-IO9o44mb.js";import{u as Oe}from"./usePageData-cOQPgHgh.js";import{N as Q}from"./RadioButton-PWlSGSkT.js";import{N as ee}from"./DatePicker-2vmZudqQ.js";const Se={class:"map-wrapper",style:{height:"100%",position:"relative"}},je={class:"map-legend"},ze={class:"legend-list"},Be=["onClick","onContextmenu"],Ne={key:0,class:"visibility-icon"},Pe={key:1,class:"solo-icon"},Ue={class:"legend-name"},Ve={class:"visibility-toggle"},Ie={key:0,class:"solo-notice"},We=le({__name:"historyMap",props:{trackData:{}},setup(A){const d=_(null);let E=null;const R=A,C=_([]),v=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],a=_({}),w=_(""),$=V(()=>{const e={};return Object.keys(C.value).forEach((s,o)=>{e[s]=v[o%v.length],a.value[s]===void 0&&(a.value[s]=!0)}),e});function T(e){if(w.value){I(e);return}a.value[e]=!a.value[e],x()}function I(e){w.value===e?B():(w.value=e,Object.keys(a.value).forEach(t=>{a.value[t]=t===e}),x())}function B(){w.value="",Object.keys(a.value).forEach(e=>{a.value[e]=!0}),x()}function N(){Object.keys(a.value).forEach(e=>{a.value[e]=!a.value[e]}),w.value="",x()}function Y(){Object.keys(a.value).forEach(e=>{a.value[e]=!0}),w.value="",x()}function Z(){Object.keys(a.value).forEach(e=>{a.value[e]=!1}),w.value="",x()}const O=V(()=>{const e=[];return Object.values(C.value).forEach(t=>{e.push(...t)}),e.sort((t,s)=>new Date(t.dbtime).getTime()-new Date(s.dbtime).getTime())}),H=V(()=>{if(O.value.length===0)return[120.370086,30.305716];const e=O.value.map(i=>i.longitude),t=O.value.map(i=>i.latitude),s=(Math.min(...e)+Math.max(...e))/2,o=(Math.min(...t)+Math.max(...t))/2;return console.log(s,o),[s,o]});async function P(){const e="/map-sdk.json",{data:t}=await fe.get(`${e}?_t=${Date.now()}`);return t}function W(e){return new Promise((t,s)=>{if(window.AMap)return t(window.AMap);const o=document.createElement("script");o.src=`https://webapi.amap.com/maps?v=2.0&key=${e}&plugin=AMap.PolylineEditor`,o.defer=!0,o.onload=()=>window.AMap?t(window.AMap):s(new Error("AMapåŠ è½½å¤±è´¥")),o.onerror=()=>s(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(o)})}const p=_({});function U(e,t){const s=t.lng-e.lng,o=t.lat-e.lat;return(Math.atan2(-o,s)*180/Math.PI-90+360)%360-175}function J(e,t,s,o){const i=document.createElement("div");return i.style.cssText=`
    width: 12px;
    height: 18px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 18px solid ${o};
    transform: translate(-50%, -50%) rotate(${s}deg);
    transform-origin: center center;
  `,new e.Marker({position:[t.lng,t.lat],content:i,offset:new e.Pixel(0,0)})}function q(e,t,s,o,i){const r=document.createElement("div");return r.className="custom-marker",r.style.transform="translateX(-50%)",r.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${o};box-shadow: 0 0 5px ${o}, 0 0 6px ${o};">
      <img src="${i||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png"}" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${o};">${s}</div>
  `,new e.Marker({position:[t.lng,t.lat],content:r})}function G(){d.value&&d.value.clearMap(),p.value={}}function x(){!window.AMap||!d.value||Object.keys(p.value).forEach(e=>{const t=a.value[e];(p.value[e]||[]).forEach(o=>{t?o.show():o.hide()})})}function n(e){if(!d.value)return;G();const t={};Object.entries(C.value).forEach(([o,i])=>{t[o]=i.map(r=>({lng:r.longitude,lat:r.latitude,address:r.address,dbtime:r.dbtime,proname:r.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:r.duration||0,userimage:r.userimage,longitude:r.longitude,latitude:r.latitude}))}),Object.keys(t).forEach(o=>{const i=t[o],r=$.value[o];if(i.length===0)return;const h=[];if(i.length>1){const m=new e.Polyline({path:i.map(F=>[F.lng,F.lat]),strokeColor:r,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});m.setMap(d.value),h.push(m)}i.forEach((m,F)=>{const k=q(e,m,o,r,i[0].userimage);k.setMap(d.value),h.push(k),k.on("click",()=>{const K=`
          <div style="min-width:220px; background:#fff; padding:12px 14px; font-size:13px; color:#333; line-height:1.6">
            <div style="font-weight:bold; color:${r}; font-size:15px; margin-bottom:6px; border-bottom:1px solid #f0f0f0; padding-bottom:4px">
              ${o}
            </div>
            <div><b style="color:#555">åœ°ç‚¹ï¼š</b>${m.address}</div>
            <div><b style="color:#555">æ—¶é—´ï¼š</b>${m.dbtime}</div>
            <div><b style="color:#555">é¡¹ç›®ï¼š</b>${m.proname}</div>
            <div><b style="color:#555">ç»çº¬åº¦ï¼š</b><span style="font-size:12px;color:#666">${m.longitude}, ${m.latitude}</span></div>

          </div>
          <div style="margin-top:8px; text-align:right; font-size:12px; color:#999">ç¬¬ ${F+1} ä¸ªæ‰“å¡ç‚¹</div>
        `;E.setContent(K),E.open(d.value,k.getPosition())}),k.on("dblclick",()=>{E.open(d.value,k.getPosition()),d.value.setCenter(k.getPosition()),d.value.setZoom(14)})});for(let m=1;m<i.length;m++){const F=i[m-1],k=i[m];if(c(F,k))continue;const K={lng:(F.lng+k.lng)/2,lat:(F.lat+k.lat)/2},ce=U(F,k),X=J(e,K,ce,r);X.isArrow=!0,X.setMap(d.value),h.push(X)}p.value[o]=h});const s=()=>{const i=d.value.getZoom()>=7,r=l(p.value,a.value);Object.values(r).forEach(h=>{h==null||h.forEach(m=>{m.isArrow&&(i?m.show():m.hide())})})};d.value.on("zoomend",s),s(),Object.keys(p.value).forEach(o=>{(p.value[o]||[]).forEach(r=>{r.isArrow||(a.value[o]?r.show():r.hide())})})}function l(e,t){const s={};for(const o in e)t[o]&&(s[o]=e[o]);return s}function c(e,t,s=1e-7){return Math.abs(e.lng-t.lng)<s&&Math.abs(e.lat-t.lat)<s}async function g(){try{const e=await P(),t=await W(e.AMAP_SDK_KEY);d.value=new t.Map("amap-container",{viewMode:"2D",center:H.value,zoom:5,features:["bg","point"]}),d.value.on("zoomend",()=>{const o=d.value.getZoom()>=12,i=l(p.value,a.value);Object.values(i).forEach(r=>{r.forEach(h=>{h.isArrow&&(o?h.show():h.hide())})})}),E=new t.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),n(t)}catch(e){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",e)}}return ne(()=>R.trackData??[],e=>{console.log(e,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),C.value=e,window.AMap&&d.value&&n(window.AMap)},{immediate:!0,deep:!0}),oe(()=>{g()}),de(()=>{d.value&&d.value.destroy()}),(e,t)=>(b(),M("div",Se,[t[1]||(t[1]=y("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),y("div",je,[y("div",{class:"legend-header"},[t[0]||(t[0]=y("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),y("div",{class:"legend-actions"},[y("button",{class:"action-btn",onClick:Y},"å…¨æ˜¾"),y("button",{class:"action-btn",onClick:Z},"å…¨éš"),y("button",{class:"action-btn",onClick:N},"åé€‰")])]),y("div",ze,[(b(!0),M(se,null,re($.value,(s,o)=>(b(),M("div",{key:o,class:ve(["legend-item",{"legend-item-hidden":!a.value[o],"legend-item-solo":w.value===o}]),onClick:i=>T(o),onContextmenu:me(i=>I(o),["prevent"])},[y("div",{class:"legend-color",style:pe({backgroundColor:s})},[a.value[o]?z("",!0):(b(),M("span",Ne,"ğŸ‘ï¸â€ğŸ—¨ï¸")),w.value===o?(b(),M("span",Pe,"â­")):z("",!0)],4),y("span",Ue,L(o),1),y("span",Ve,L(a.value[o]?"éšè—":"æ˜¾ç¤º"),1)],42,Be))),128))]),w.value?(b(),M("div",Ie,[j(" ä»…æ˜¾ç¤º: "+L(w.value)+" ",1),y("button",{class:"cancel-solo-btn",onClick:B},"å–æ¶ˆ")])):z("",!0)])]))}}),Le=ie(We,[["__scopeId","data-v-c178b1cb"]]),Re={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Ye(A){return typeof A=="function"||Object.prototype.toString.call(A)==="[object Object]"&&!Ee(A)}const Ze=le({name:"trajectory_historytrajectory",__name:"index",setup(A){const d=ge();function E(n){return n.getFullYear()}function R(n){const l=new Date(n.getFullYear(),0,1),c=(n.getTime()-l.getTime())/864e5,g=l.getDay()||7;return Math.ceil((c+g)/7)}function C(){const n=new Date,l=E(n),c=R(n).toString().padStart(2,"0");return`${l}-${c}å‘¨`}const v=_("week"),a=_({dayTime:String(te(0,null)),monthTime:String(te(3,null)),weekTime:C(),startTime:null,endTime:null,dates:null,creater:null}),w=_([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),$=_("table"),T=_({}),I=V(()=>Object.keys(T.value||{}).map(n=>{var l,c;return{key:n,name:n,userimage:(c=(l=T.value[n])==null?void 0:l[0])==null?void 0:c.userimage}})),B=V(()=>{const n=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left",render(c){return u("div",{class:"text-blue-600 flex-col items-center font-medium"},[u(be,{width:"60",height:"60","preview-disabled":!0,src:c.userimage||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png",class:"rounded-md object-cover"},null),u("span",null,[c.name])])}}];let l=[];switch(v.value){case"week":a.value.startTime&&a.value.endTime&&(l=ye(a.value.startTime,a.value.endTime).map(g=>N(g)));break;case"month":a.value.monthTime&&(l=he(a.value.monthTime).map(g=>N(g)));break;case"day":default:a.value.dayTime&&(l=[N(a.value.dayTime)]);break}return[...n,...l]}),N=n=>({title:Y(n),key:n,width:300,align:"center",render:l=>Z(l.name,n)}),Y=n=>{const l=new Date(n),c=l.getMonth()+1,g=l.getDate(),e=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][l.getDay()];return`${c}/${g} å‘¨${e}`},Z=(n,l)=>{let c;const e=(T.value[n]||[]).filter(t=>t.daytime===l);return e.length===0?u("div",{class:"text-gray-400 text-sm"},[j("æ— è®°å½•")]):u("div",{class:"text-left space-y-1"},[u(we,{style:"max-height: 250px;",trigger:"none"},Ye(c=e.map((t,s)=>u("div",{key:s,class:"tableItem p-1 border-b border-gray-100 last:border-b-0"},[u("div",null,[j("é¡¹ç›®ï¼š"),u("span",{class:""},[t.proname||"æš‚æ— é¡¹ç›®"])]),u("div",null,[j("åœ°å€ï¼š "),u("span",{class:""},[t.address])]),u("div",null,[j("æ‰“å¡æ—¶é—´ï¼š"),u("span",{class:""},[t.dbtime])])])))?c:{default:()=>[c]})])},O=n=>{const l=n.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!l)return null;const c=Number(l[1]),g=Number(l[2]),e=new Date(c,0,1+(g-1)*7),t=e.getDay(),s=new Date(e);t<=4?s.setDate(e.getDate()-e.getDay()+1):s.setDate(e.getDate()+8-e.getDay());const o=new Date(s);o.setDate(s.getDate()+6);const i=r=>{const h=r.getFullYear(),m=String(r.getMonth()+1).padStart(2,"0"),F=String(r.getDate()).padStart(2,"0");return`${h}-${m}-${F}`};return{start:i(s),end:i(o)}},H=n=>{T.value={},v.value=n,W()},P=n=>{W(n),p()},W=n=>{switch(v.value){case"week":if(n){const l=O(n);l&&(a.value.startTime=l.start,a.value.endTime=l.end)}break;case"month":a.value.dates=n||a.value.monthTime;break;case"day":default:a.value.dates=n||a.value.dayTime;break}},p=async()=>{try{const n={};a.value.creater&&(n.creater=a.value.creater),v.value==="week"?(n.startTime=a.value.startTime,n.endTime=a.value.endTime):v.value==="month"?n.dates=a.value.monthTime:n.dates=a.value.dayTime;const{data:l,error:c}=await $e(n);c||(T.value=l)}catch(n){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",n)}},{pageData:U,getData:J,nextPage:q}=Oe(Ae),G=async n=>{const l=n.currentTarget,c=l.scrollTop;l.scrollTop+l.offsetHeight>=l.scrollHeight&&U.data.length<U.total&&(await q(),await Ce(),setTimeout(()=>{l.scrollTop=c}))},x=async n=>{a.value.creater=n,p()};return ne([v,()=>a.value.dates],()=>{if(v.value=="week"&&a.value.weekTime){const n=O(a.value.weekTime);n&&(a.value.startTime=n.start,a.value.endTime=n.end),p()}else(v.value=="month"&&a.value.monthTime||v.value=="day"&&a.value.dayTime)&&p()},{immediate:!0}),oe(()=>{a.value.weekTime=C(),J({usertypes:"2,3"}),p()}),(n,l)=>{const c=Te,g=_e,e=ue;return b(),M("div",Re,[u(f(Me),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:D(()=>[u(f(Fe),{align:"center"},{default:D(()=>[l[6]||(l[6]=y("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),u(g,{label:"ç”¨æˆ·",path:"creater","label-placement":"left","show-feedback":!1},{default:D(()=>[u(c,{clearable:"",filterable:"",value:a.value.creater,"onUpdate:value":[l[0]||(l[0]=t=>a.value.creater=t),x],placeholder:"è¯·é€‰æ‹©","label-field":"username",size:"small","value-field":"id",options:f(U).data,onScroll:G},null,8,["value","options"])]),_:1}),u(f(ae),{value:v.value,"onUpdate:value":[l[1]||(l[1]=t=>v.value=t),H],size:"small"},{default:D(()=>[(b(!0),M(se,null,re(w.value,t=>(b(),S(f(Q),{key:t.value,value:t.value,label:t.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),v.value==="day"?(b(),S(f(ee),{key:0,size:"small","formatted-value":a.value.dayTime,"onUpdate:formattedValue":[l[2]||(l[2]=t=>a.value.dayTime=t),P],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):z("",!0),v.value==="week"?(b(),S(f(ee),{key:1,size:"small","formatted-value":a.value.weekTime,"onUpdate:formattedValue":[l[3]||(l[3]=t=>a.value.weekTime=t),P],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):z("",!0),v.value==="month"?(b(),S(f(ee),{key:2,size:"small","formatted-value":a.value.monthTime,"onUpdate:formattedValue":[l[4]||(l[4]=t=>a.value.monthTime=t),P],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):z("",!0),u(f(xe),{type:"primary",onClick:p,size:"small",class:"w-full sm:w-auto"},{icon:D(()=>[u(e,{class:"text-icon"})]),default:D(()=>[j(" "+L(f(De)("common.search")),1)]),_:1}),u(f(ae),{size:"small",value:$.value,"onUpdate:value":l[5]||(l[5]=t=>$.value=t),name:"radiobuttongroup1"},{default:D(()=>[u(f(Q),{value:"table",label:"è¡¨æ ¼"}),u(f(Q),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:D(()=>[$.value=="table"?(b(),S(f(ke),{key:0,columns:B.value,data:I.value,size:"small","flex-height":!f(d).isMobile,"scroll-x":B.value.reduce((t,s)=>t+s.width,0),remote:"","row-key":t=>t.key,class:"h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","row-key"])):(b(),S(Le,{key:1,trackData:T.value},null,8,["trackData"]))]),_:1})])}}}),Qe=ie(Ze,[["__scopeId","data-v-6cafd6af"]]);export{Qe as default};
