import{d as F,n as B,p as oe,s as q,o as O,c as G,w as l,g as t,i as g,W as ie,aE as se,h as D,t as N,$ as x,F as ue,aF as re,aG as ce,Z as de,B as H,N as W,O as pe,ad as Q,a3 as Z,j as T,ae as fe,r as L,av as U,e as X,ay as me,aj as Y,az as _e,S as ve,ar as ge,P as he,Q as ye,f as ee,ai as te,R as ae}from"./index-Dau8rq44.js";import{f as be,a as xe,b as we}from"./audit-events-D2z7Sl4N.js";import{_ as ke,l as le}from"./lodash-DDxVM2rI.js";import{T as j}from"./basicconf-oTy9UseV.js";import{_ as Te}from"./round-search-Czhvpiaz.js";import{_ as De}from"./round-refresh-uN4z1Vas.js";import{u as Se}from"./usePageData-DOSeddPr.js";import{_ as Ce}from"./FormItemGridItem-CL9CbfJw.js";import{_ as Ne}from"./DatePicker-LBkROysW.js";import{_ as ze}from"./Grid-CJI5vxn3.js";import{f as Ae}from"./events-CH3UT6Zv.js";import{_ as Ie,a as $e}from"./DescriptionsItem-CnPWV78l.js";import{e as Ve}from"./exportExcel-D6OyA9oJ.js";import"./TimePicker-D7pUWN0O.js";import"./defineProperty-Cn2l6J40.js";const Me=F({name:"FormSearch",__name:"form-search",props:B({AuditTypeData:{},AuditPolicyData:{}},{model:{required:!0},modelModifiers:{}}),emits:B(["reset","search"],["update:model"]),setup(_,{emit:$}){const S=$,{formRef:C,restoreValidation:n}=oe(),r=q(_,"model");Se(re);async function A(o,y){o&&o.length>0?(r.value.startTime=o[0],r.value.endTime=o[1]):(r.value.startTime=null,r.value.endTime=null),S("search")}async function d(){await n(),r.value.timeRange=null,r.value.atype=null,r.value.ap=null,r.value.startTime=null,r.value.endTime=null,r.value.elevel=null,ce(()=>{S("search")})}async function h(){S("search")}const I=ke.debounce(h,1e3,{leading:!0,trailing:!1});return(o,y)=>{const i=de,p=Ce,u=Ne,k=De,v=H,b=Te,w=W,z=ze,V=pe,M=Q;return O(),G(M,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[t(V,{ref_key:"formRef",ref:C,model:r.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:ue(g(I),["enter"])},{default:l(()=>[t(z,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:l(()=>[t(p,{span:"24 s:12 m:8 l:6",label:"事件等级",path:"elevel"},{default:l(()=>[t(i,{filterable:"",clearable:"",value:r.value.elevel,"onUpdate:value":[y[0]||(y[0]=e=>r.value.elevel=e),h],placeholder:"请选择事件等级",options:g(ie)(g(se))},null,8,["value","options"])]),_:1}),t(p,{span:"24 s:24 m:10 l:10",label:"产生时间",path:"timeRange"},{default:l(()=>[t(u,{clearable:"",value:r.value.timeRange,"onUpdate:value":y[1]||(y[1]=e=>r.value.timeRange=e),type:"datetimerange","value-format":"yyyy-MM-dd HH:mm:ss",style:{width:"100%"},"onUpdate:formattedValue":A},null,8,["value"])]),_:1}),t(p,{span:"24 s:24 m:8 l:6",label:""},{default:l(()=>[t(w,{class:"w-full"},{default:l(()=>[t(v,{onClick:d},{icon:l(()=>[t(k,{class:"text-icon"})]),default:l(()=>[D(" "+N(g(x)("common.reset")),1)]),_:1}),t(v,{type:"primary",ghost:"",onClick:g(I)},{icon:l(()=>[t(b,{class:"text-icon"})]),default:l(()=>[D(" "+N(g(x)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),ne=_=>(he("data-v-2fc23756"),_=_(),ye(),_),Pe=ne(()=>ee("span",null,"事件信息",-1)),Ee=ne(()=>ee("span",null,"事件溯源",-1)),Oe={key:0,style:{display:"flex","justify-content":"center","align-items":"center",color:"#606266","font-size":"14px",height:"500px"}};function Re(_){return typeof _=="function"||Object.prototype.toString.call(_)==="[object Object]"&&!te(_)}const Le=F({__name:"detailInfo",props:B({detailInfo:{},AuditTypeData:{},AuditPolicyData:{}},{detailVisible:{default:!1},detailVisibleModifiers:{}}),emits:["update:detailVisible"],setup(_){const $=Z(),S=q(_,"detailVisible"),C=_,n=T();fe(()=>S.value,async i=>{i&&(n.value=C.detailInfo,h())});const r=[{title:"",key:"index",width:50,render:i=>`${i.index}`},{key:"pname1",title:"安全事件名称",align:"center",minWidth:160,ellipsis:{tooltip:!0}},{key:"pname1",title:"安全事件类型",align:"center",width:140},{key:"pname2",title:"安全事件类别",align:"center",width:140},{key:"elevel",title:"事件等级",align:"center",width:120,render:i=>{(i.elevel===void 0||i.elevel===null)&&(i.elevel=1);const p={0:"#8e9dff",1:"#5da8ff",2:"#fedc69",3:"#ff9874",4:"#ff0000"},u=x(j[i.elevel]);let k={color:p[i.elevel],textColor:"#ffffff",borderColor:p[i.elevel]};return t(U,{size:"small",color:k},Re(u)?u:{default:()=>[u]})}},{key:"aggre",title:"聚合数量",align:"center",width:120},{key:"aggrestarttime",title:"聚合开始时间",align:"center",width:180},{key:"type",title:"发生源设备类型",align:"center",width:160}],A=T(!1);let d=L([]);const h=async i=>{var k;if(!A.value)A.value=!0;else return;let{data:p,error:u}=await Ae({pageId:i,auditid:(k=n.value)==null?void 0:k.auditid,limit:20});if(!u){A.value=!1;const v=p==null?void 0:p.sort((b,w)=>w.id-b.id);i?d=[...d,...v]:d=v,d=d.map((b,w)=>(b.index=w+1,b))}};function I(i){var u;Math.abs(i.target.scrollTop+i.target.offsetHeight-i.target.scrollHeight)<=20&&((u=n.value)==null?void 0:u.eco)>d.length&&o()}const o=le.debounce(()=>{h(d[d.length-1].id)},300),y=L({page:1,pageCount:1,pageSize:20,total:0,prefix({startIndex:i,endIndex:p,page:u,pageSize:k,pageCount:v,itemCount:b}){var w,z;return`已加载${d.length}条 共${(d.length>((w=n.value)==null?void 0:w.eco)?d.length:(z=n.value)==null?void 0:z.eco)||0}条`}});return(i,p)=>{const u=Ie,k=$e,v=W,b=me,w=Y,z=_e,V=ve,M=ge;return O(),G(M,{show:S.value,"onUpdate:show":p[0]||(p[0]=e=>S.value=e),title:"事件详情",preset:"card",class:"w-1200px"},{default:l(()=>[t(V,{class:"max-h-600px pr-20px"},{default:l(()=>[t(z,{type:"line",animated:""},{default:l(()=>[t(b,{name:"1"},{tab:l(()=>[Pe]),default:l(()=>[t(v,{vertical:"",size:12},{default:l(()=>[t(k,{"label-placement":"left",bordered:"",column:2,"label-style":{width:"160px"}},{default:l(()=>[t(u,{label:"审计事件名称"},{default:l(()=>{var e;return[D(N((e=n.value)==null?void 0:e.aename),1)]}),_:1}),t(u,{label:"审计类型"},{default:l(()=>{var e,a;return[D(N(((e=C.AuditTypeData.find(c=>{var s;return c.id===((s=n.value)==null?void 0:s.atype)}))==null?void 0:e.atypename)||((a=n.value)==null?void 0:a.atype)||""),1)]}),_:1}),t(u,{label:"审计策略"},{default:l(()=>{var e,a;return[D(N(((e=C.AuditPolicyData.find(c=>{var s;return c.id===((s=n.value)==null?void 0:s.ap)}))==null?void 0:e.pname)||((a=n.value)==null?void 0:a.ap)||""),1)]}),_:1}),t(u,{label:"事件等级"},{default:l(()=>{var e,a,c,s,f,m,P,R,E,J;return[t(g(U),{size:"small",color:{textColor:"#ffffff",borderColor:((e=n.value)==null?void 0:e.alevel)===0?"#8e9dff":((a=n.value)==null?void 0:a.alevel)===1?"#5da8ff":((c=n.value)==null?void 0:c.alevel)===2?"#fedc69":((s=n.value)==null?void 0:s.alevel)===3?"#ff9874":((f=n.value)==null?void 0:f.alevel)===4?"#ff0000":"#5da8ff",color:((m=n.value)==null?void 0:m.alevel)===0?"#8e9dff":((P=n.value)==null?void 0:P.alevel)===1?"#5da8ff":((R=n.value)==null?void 0:R.alevel)===2?"#fedc69":((E=n.value)==null?void 0:E.alevel)===3?"#ff9874":((J=n.value)==null?void 0:J.alevel)===4?"#ff0000":"#5da8ff"}},{default:l(()=>{var K;return[D(N(g(x)(g(j)[(K=n.value)==null?void 0:K.alevel])),1)]}),_:1},8,["color"])]}),_:1}),t(u,{label:"产生时间"},{default:l(()=>{var e;return[D(N((e=n.value)==null?void 0:e.dbtime),1)]}),_:1}),t(u,{label:"更新时间"},{default:l(()=>{var e;return[D(N((e=n.value)==null?void 0:e.uptime),1)]}),_:1}),t(u,{label:"事件总数"},{default:l(()=>{var e;return[D(N((e=n.value)==null?void 0:e.eco),1)]}),_:1})]),_:1})]),_:1})]),_:1}),t(b,{name:"2"},{tab:l(()=>[Ee]),default:l(()=>[g(d).length==0?(O(),X("div",Oe," 暂无安全事件信息 ")):(O(),G(w,{key:1,style:{height:"500px"},columns:r,remote:"",data:g(d),size:"small","scroll-x":762,"row-key":e=>e.id,"virtual-scroll":"",loading:A.value,"flex-height":!g($).isMobile,pagination:y,onScroll:I},null,8,["data","row-key","loading","flex-height","pagination"]))]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])}}}),je=ae(Le,[["__scopeId","data-v-2fc23756"]]),Be={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Ge(_){return typeof _=="function"||Object.prototype.toString.call(_)==="[object Object]"&&!te(_)}const He=F({name:"audit_event",__name:"index",setup(_){const $=T(window.innerHeight-395),S=Z(),C=T(!1),n=T(),r=T([]);(async()=>{const{data:e,error:a}=await be({page:1,limit:1e3});a||(r.value=JSON.parse(JSON.stringify(e)).list)})();const d=T([]),h=L({limit:100,pageId:void 0,elevel:void 0,atype:void 0,uid:void 0,suditPolicy:void 0,startTime:void 0,endTime:void 0,fuzzy:void 0,_t:new Date().getTime()}),I=[{title:"",key:"index",width:80,align:"center",render:e=>`${e.index}`},{key:"aename",title:x("page.audit.event.eventName"),align:"center",minWidth:160,ellipsis:!0,resizable:!0},{key:"dbtime",title:x("page.audit.event.createTime"),align:"center",width:220,resizable:!0},{key:"uptime",title:x("page.audit.event.updateTime"),align:"center",width:220,resizable:!0},{key:"alevel",title:x("page.audit.event.eventRanK"),align:"center",width:220,render:e=>{(e.alevel===void 0||e.alevel===null)&&(e.alevel=0);const a={0:"#8e9dff",1:"#5da8ff",2:"#fedc69",3:"#ff9874",4:"#ff0000"},c=x(j[e.alevel]);let s={color:a[e.alevel],textColor:"#ffffff",borderColor:a[e.alevel]};return t(U,{size:"small",color:s},Ge(c)?c:{default:()=>[c]})},resizable:!0},{key:"eco",title:x("page.audit.event.eventCount"),align:"center",width:220,resizable:!0},{key:"operate",title:x("common.operate"),align:"center",width:220,fixed:"right",render:e=>t("div",{class:"flex-center gap-8px"},[t(H,{type:"primary",ghost:!0,size:"small",onClick:()=>V(e)},{default:()=>[D("详情")]})])}],o=T([]),y=T(!1),i=T(0),p=async(e=!1)=>{if(!y.value)y.value=!0;else return;y.value=!0;const{data:a,error:c}=await xe(h);c||(i.value=a.length,e?o.value=[...o.value,...a]:o.value=a,o.value=o.value.sort((s,f)=>f.id-s.id).map((s,f)=>(s.index=f+1,s)),y.value=!1)};p();const u=T(!0),k=()=>{o.value=[],h.pageId=void 0,(a=>Object.keys(a).filter(f=>f!=="limit"&&f!=="_t").some(f=>a[f]!==void 0&&a[f]!==""&&a[f]!==null))(h)?u.value=!1:(u.value=!0,b()),p()},v=L({page:1,pageCount:1,pageSize:20,total:0,prefix({startIndex:e,endIndex:a,page:c,pageSize:s,pageCount:f,itemCount:m}){return`已加载${o.value.length}条`+(o.value.length?u.value?` 共计 ${o.value.length>0?m??0:0} 条`:i.value==h.limit?"  预计还有更多":"  没有更多了":"")}});async function b(){const{data:e,error:a}=await we();a||(v.pageCount=20,v.total=Number(e),v.itemCount=Number(e))}b();function w(e){var c;Math.abs(e.target.scrollTop+e.target.offsetHeight-e.target.scrollHeight)<=20&&v.total>((c=o.value)==null?void 0:c.length)&&z()}const z=le.debounce(()=>{var e;((e=o.value)==null?void 0:e.length)<v.total&&(h.pageId=o.value[o.value.length-1].id,p(!0))},300);async function V(e){n.value=e,C.value=!0}async function M(){if(!o.value.length)return;const e=JSON.parse(JSON.stringify(o.value)),a=[];e.forEach(s=>{const f={};I.forEach(m=>{var P;if(s.hasOwnProperty(m.key)){const R=m.key=="alevel"?s[m.key]!=null?x(j[s[m.key]]):"":m.key=="ap"?(P=d.value.find(E=>E.id===E[m.key]))==null?void 0:P.pname:s[m.key];f[m.title]=R}}),a.push(f)}),Ve(a,500,[{wpx:100},{wpx:100},{wpx:100},{wpx:100},{wpx:100},{wpx:100},{wpx:50}],"审计事件_"+new Date().getTime())}return(e,a)=>{const c=W,s=Y,f=Q;return O(),X("div",Be,[t(Me,{model:h,"onUpdate:model":a[0]||(a[0]=m=>h=m),onSearch:k,AuditTypeData:r.value,AuditPolicyData:d.value},null,8,["model","AuditTypeData","AuditPolicyData"]),t(f,{title:g(x)("page.audit.event.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":l(()=>[t(c,null,{default:l(()=>[t(g(H),{type:"primary",size:"small",ghost:"",onClick:M,title:"导出已加载"},{default:l(()=>[D("导出已加载")]),_:1})]),_:1})]),default:l(()=>[t(s,{columns:I,data:o.value,size:"small","virtual-scroll":"","flex-height":!g(S).isMobile,loading:y.value,remote:"","row-key":m=>m.id,"max-height":$.value,pagination:v,onScroll:w,class:"sm:h-full","scroll-x":""},null,8,["data","flex-height","loading","row-key","max-height","pagination"]),t(je,{"detail-visible":C.value,"onUpdate:detailVisible":a[1]||(a[1]=m=>C.value=m),"detail-info":n.value,AuditTypeData:r.value,AuditPolicyData:d.value},null,8,["detail-visible","detail-info","AuditTypeData","AuditPolicyData"])]),_:1},8,["title"])])}}}),ot=ae(He,[["__scopeId","data-v-b0571e35"]]);export{ot as default};
