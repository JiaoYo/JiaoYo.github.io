import{_ as Me}from"./table-header-operation.vue_vue_type_script_setup_true_lang-Bbt3vQ34.js";import{d as J,dQ as $e,j as M,aS as le,ar as ce,b7 as ue,dR as de,dS as pe,a5 as X,ch as Ee,ao as ke,c1 as Ie,r as be,n as ie,s as we,p as xe,q as je,b as ze,ae as Ae,bf as me,be as fe,D as ae,o as U,c as ee,w as a,g as t,h as y,t as C,i as n,$ as A,E as G,e as Te,am as Pe,W as te,G as Ue,f as z,aD as Le,v as Be,bh as Ke,a_ as Fe,J as Re,K as _e,L as qe,aq as Ve,Z as Ge,O as Ce,S as Je,B as V,N as De,bg as Ne,as as We,F as Qe,ad as re,a3 as He,ah as Y,aj as Ze}from"./index-DCJMGCjU.js";import{h as Xe,i as Ye,f as et,j as tt,k as at,l as ve,m as nt}from"./reportForm-fvgaV3m1.js";import{f as ot,i as Se}from"./scheduleTask-DWrbVHON.js";import{u as st,a as lt}from"./table-BbJ_mIRf.js";import{a as Oe,T as ye}from"./task-DHaRQBLb.js";import{M as it}from"./shield-question-outline-rounded-B0xahjMv.js";import{_ as rt}from"./TimePicker-BhqRnlN6.js";import{_ as ct}from"./round-search-CQG7dXzF.js";import{_ as ut}from"./round-refresh-BxO_w5DR.js";import{_ as dt}from"./lodash-mhSI0N8l.js";import{_ as pt}from"./FormItemGridItem-DFSPZS-5.js";import{_ as mt}from"./Grid-D9UUsNcy.js";import{h as he}from"./permission-DTGVaK0w.js";import{_ as ft}from"./Popconfirm-hoFMQo4c.js";import{_ as _t,a as vt}from"./DescriptionsItem-BWHRADpQ.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-BAHRKZjE.js";import"./setting-outlined-DW7BnljB.js";import"./export-Ci30NtKq.js";import"./refresh-BmcUVo7m.js";import"./round-delete-BENxW-Td.js";import"./round-plus-Bqusqz5E.js";import"./Progress-CyaFrR92.js";import"./defineProperty-DAPPGCWD.js";const yt=J({name:"ModalEnvironment",props:Object.assign(Object.assign({},$e),{internalKey:{type:String,required:!0},onInternalAfterLeave:{type:Function,required:!0}}),setup(m){const h=M(!0);function r(){const{onInternalAfterLeave:o,internalKey:u,onAfterLeave:e}=m;o&&o(u),e&&e()}function s(){const{onPositiveClick:o}=m;o?Promise.resolve(o()).then(u=>{u!==!1&&i()}):i()}function g(){const{onNegativeClick:o}=m;o?Promise.resolve(o()).then(u=>{u!==!1&&i()}):i()}function f(){const{onClose:o}=m;o?Promise.resolve(o()).then(u=>{u!==!1&&i()}):i()}function N(o){const{onMaskClick:u,maskClosable:e}=m;u&&(u(o),e&&i())}function S(){const{onEsc:o}=m;o&&o()}function i(){h.value=!1}function k(o){h.value=o}return{show:h,hide:i,handleUpdateShow:k,handleAfterLeave:r,handleCloseClick:f,handleNegativeClick:g,handlePositiveClick:s,handleMaskClick:N,handleEsc:S}},render(){const{handleUpdateShow:m,handleAfterLeave:h,handleMaskClick:r,handleEsc:s,show:g}=this;return le(ce,Object.assign({},this.$props,{show:g,onUpdateShow:m,onMaskClick:r,onEsc:s,onAfterLeave:h,internalAppear:!0,internalModal:!0}))}}),ge=ue("n-modal-provider"),ht=ue("n-modal-api"),gt=ue("n-modal-reactive-list"),kt={to:[String,Object]},bt=J({name:"ModalProvider",props:kt,setup(){const m=de(64),h=pe(),r=M([]),s={};function g(i={}){const k=Ie(),o=be(Object.assign(Object.assign({},i),{key:k,destroy:()=>{var u;(u=s[`n-modal-${k}`])===null||u===void 0||u.hide()}}));return r.value.push(o),o}function f(i){const{value:k}=r;k.splice(k.findIndex(o=>o.key===i),1)}function N(){Object.values(s).forEach(i=>{i==null||i.hide()})}const S={create:g,destroyAll:N};return X(ht,S),X(ge,{clickedRef:de(64),clickedPositionRef:pe()}),X(gt,r),X(ge,{clickedRef:m,clickedPositionRef:h}),Object.assign(Object.assign({},S),{modalList:r,modalInstRefs:s,handleAfterLeave:f})},render(){var m,h;return le(ke,null,[this.modalList.map(r=>{var s;return le(yt,Ee(r,["destroy"],{to:(s=r.to)!==null&&s!==void 0?s:this.to,ref:g=>{g===null?delete this.modalInstRefs[`n-modal-${r.key}`]:this.modalInstRefs[`n-modal-${r.key}`]=g},internalKey:r.key,onInternalAfterLeave:this.handleAfterLeave}))}),(h=(m=this.$slots).default)===null||h===void 0?void 0:h.call(m)])}}),wt=z("span",null,[y("报表统计的周期为： "),z("span",{class:"c-#1890ff"},"前一天"),y(" / "),z("span",{class:"c-#1890ff"},"上周周一至周日"),y(" / "),z("span",{class:"c-#1890ff"},"上个月"),y(" / "),z("span",{class:"c-#1890ff"},"上周周日至周六")],-1),xt=J({name:"TaskModal",__name:"task_modal",props:ie({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:ie(["submitted"],["update:visible"]),setup(m,{expose:h,emit:r}){const s=m,g=r,f=we(m,"visible"),{formRef:N,validate:S,restoreValidation:i}=xe(),{defaultRequiredRule:k,patternRules:o}=je(),u=ze(()=>({add:"新增任务",edit:"编辑任务"})[s.operateType]),e=be($());function $(){return{id:void 0,rname:"",rtype:0,ttype:0,starttime:void 0,endtime:void 0,excute:1,stype:0,recipient:"",rdesc:"",tid:void 0}}const L={rname:k,starttime:k,cron:k,rtype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择实例"},ttype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择任务类型"},stype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择发送类型"},recipient:{required:!0,validator:Le,trigger:["input","change","blur","password-input"]}},D=M(""),B=async()=>{var R,w;const{data:v,error:c}=await Se((R=s.rowData)==null?void 0:R.tid);if(!c){const x=Ne(v==null?void 0:v.cronExpression);D.value=(w=JSON.parse(v==null?void 0:v.params))==null?void 0:w.uuid,e.starttime=x==null?void 0:x.settingTime}};function K(){Object.assign(e,$()),O.value=Be(),s.operateType==="edit"&&s.rowData&&(s.rowData.starttime=s.rowData.starttime.substring(11,19),Object.assign(e,s.rowData),B())}function P(){f.value=!1}const O=M(""),E=async v=>{const{data:c,error:R}=await et({beanName:"ReportTask",remark:O.value,cronExpression:v,params:JSON.stringify({rtype:e.rtype,ttype:e.ttype,uuid:O.value})});return R?!1:(await b(),!0)},b=async()=>{const{data:v,error:c}=await tt({uuid:O.value});e.tid=v};async function F(){var c,R;await S();const v=Ke(e.ttype==1||e.ttype==3?{dayOfWeek:e.excute,time:e.starttime}:null,e.ttype==2?{dayOfMonth:e.excute,time:e.starttime}:null,e.ttype==0?{time:e.starttime}:null);if(s.operateType==="add"){if(!await E(v))return!1}else{const{data:w,error:x}=await ot({id:e.tid,cronExpression:v,beanName:"ReportTask",status:1,params:JSON.stringify({rtype:e.rtype,ttype:e.ttype,uuid:D.value})});if(x)return!1}if(e.ttype==0&&delete e.excute,s.operateType==="add"){const{data:w,error:x}=await Xe({...e,starttime:Fe(1,new Date)});x||((c=window.$message)==null||c.success(A("common.addSuccess")),P(),g("submitted"))}else{delete e.starttime;const{data:w,error:x}=await Ye({...e});x||((R=window.$message)==null||R.success(A("common.updateSuccess")),P(),g("submitted"))}}const W=v=>{e.excute=1};return Ae(f,()=>{f.value&&(K(),i())}),h({monthOption:me,weekOption:fe}),(v,c)=>{const R=Re,w=_e,x=qe,Q=We,d=Ve,l=Ge,T=rt,I=_e,j=Ce,ne=Je,H=V,oe=De,se=ce,p=ae("no-space");return U(),ee(se,{show:f.value,"onUpdate:show":c[5]||(c[5]=_=>f.value=_),title:u.value,preset:"card",class:"w-600px"},{footer:a(()=>[t(oe,{justify:"end",size:16},{default:a(()=>[t(H,{onClick:P},{default:a(()=>[y(C(n(A)("common.cancel")),1)]),_:1}),t(H,{type:"primary",onClick:F},{default:a(()=>[y(C(n(A)("common.confirm")),1)]),_:1})]),_:1})]),default:a(()=>[t(ne,{class:"max-h-520px pr-20px"},{default:a(()=>[t(j,{ref_key:"formRef",ref:N,model:e,rules:L,"label-placement":"left","label-width":110,"require-mark-placement":"left"},{default:a(()=>[t(w,{label:"任务名称",path:"rname"},{default:a(()=>[G(t(R,{value:e.rname,"onUpdate:value":c[0]||(c[0]=_=>e.rname=_),placeholder:"请输入任务名称",clearable:""},null,8,["value"]),[[p]])]),_:1}),t(w,{label:"任务类型",path:"ttype"},{label:a(()=>[y(" 任务类型 "),t(x,{trigger:"hover",placement:"top-start"},{trigger:a(()=>[t(n(it),{class:"text-xl cursor-pointer c-#7a7b78"})]),default:a(()=>[wt]),_:1})]),default:a(()=>[t(d,{value:e.ttype,"onUpdate:value":[c[1]||(c[1]=_=>e.ttype=_),W],name:"radiogroup"},{default:a(()=>[(U(!0),Te(ke,null,Pe(n(te)(n(Oe)),(_,Z)=>(U(),ee(Q,{key:Z,value:_.value},{default:a(()=>[y(C(_.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),[1,2,3].includes(e.ttype)?(U(),ee(w,{key:0,label:e.ttype==2?"每月":"每周",path:"excute"},{default:a(()=>[t(l,{filterable:"",value:e.excute,"onUpdate:value":c[2]||(c[2]=_=>e.excute=_),placeholder:"请选择",options:e.ttype==2?n(me)():n(fe)(),style:{width:"100%"}},null,8,["value","options"])]),_:1},8,["label"])):Ue("",!0),t(I,{label:"执行时间",path:"starttime"},{default:a(()=>[t(T,{"formatted-value":e.starttime,"onUpdate:formattedValue":c[3]||(c[3]=_=>e.starttime=_),placeholder:"选择执行时间"},null,8,["formatted-value"])]),_:1}),t(w,{label:"任务描述",path:"rdesc"},{default:a(()=>[G(t(R,{type:"textarea",value:e.rdesc,"onUpdate:value":c[4]||(c[4]=_=>e.rdesc=_),placeholder:"请输入任务描述",clearable:""},null,8,["value"]),[[p]])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Tt=J({name:"TaskSearch",__name:"task_search",props:{model:{required:!0},modelModifiers:{}},emits:ie(["reset","search"],["update:model"]),setup(m,{emit:h}){const r=h,{formRef:s,restoreValidation:g}=xe(),f=we(m,"model");function N(){f.value.fuzzy=void 0,r("search")}async function S(){await g(),r("reset")}async function i(){r("search")}const k=dt.debounce(i,1e3,{leading:!0,trailing:!1});return(o,u)=>{const e=Re,$=pt,L=ut,D=V,B=ct,K=De,P=mt,O=Ce,E=re,b=ae("no-space");return U(),ee(E,{bordered:!1,size:"small",class:"card-wrapper"},{default:a(()=>[t(O,{ref_key:"formRef",ref:s,model:f.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Qe(n(k),["enter"])},{default:a(()=>[t(P,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:a(()=>[t($,{span:"24 s:12 m:10 l:6",label:"任务名称",path:"fuzzy"},{default:a(()=>[G(t(e,{value:f.value.fuzzy,"onUpdate:value":u[0]||(u[0]=F=>f.value.fuzzy=F),placeholder:"请输入任务名称关键字",clearable:"",onClear:N},null,8,["value"]),[[b]])]),_:1}),t($,{span:"24 s:12 m:8 l:6"},{default:a(()=>[t(K,{class:"w-full"},{default:a(()=>[t(D,{onClick:S},{icon:a(()=>[t(L,{class:"text-icon"})]),default:a(()=>[y(" "+C(n(A)("common.reset")),1)]),_:1}),t(D,{type:"primary",ghost:"",onClick:n(k)},{icon:a(()=>[t(B,{class:"text-icon"})]),default:a(()=>[y(" "+C(n(A)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),Rt={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ct=z("div",{style:{display:"flex","align-items":"center"}},[z("div",null,"报表任务")],-1),Zt=J({name:"reportmanagement_reporttask",__name:"index",setup(m){const h=He(),{columns:r,columnChecks:s,data:g,getData:f,loading:N,mobilePagination:S,searchParams:i,resetSearchParams:k}=st({apiFn:at,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"rname",title:"任务名称",align:"center",width:160},{key:"rtype",title:"实例类型",align:"center",width:160,render:d=>{var l;return t("div",null,[(l=te(ye).find(T=>T.value===d.rtype))==null?void 0:l.label])}},{key:"starttime",title:"任务执行时间",align:"center",width:160},{key:"operate",title:A("common.operate"),align:"center",width:160,render:d=>t("div",{class:"flex-center gap-8px"},[t(bt,null,{default:()=>[t(V,{type:"info",ghost:!0,size:"small",onClick:()=>F(d.id)},{default:()=>[y("详情")]})]}),G(t(V,{type:"warning",ghost:!0,size:"small",onClick:()=>R(d.id)},{default:()=>[y("修改")]}),[[ae("no-auth"),"sys.report.task.update"]]),t(ft,{onPositiveClick:()=>w(d.id)},{default:()=>"确定要删除改数据吗？",trigger:()=>G(t(V,{type:"error",ghost:!0,size:"small"},{default:()=>[y("删除")]}),[[ae("no-auth"),"sys.report.task.delete"]])})])}]}),{drawerVisible:o,operateType:u,editingData:e,handleAdd:$,handleEdit:L,checkedRowKeys:D,onBatchDeleted:B,onDeleted:K,closeDrawer:P}=lt(g,f),O=M(),E=M(!1),b=M({id:void 0,rname:"",rtype:0,ttype:0,starttime:void 0,endtime:void 0,excute:0,stype:0,recipient:"",rdesc:"",tid:void 0}),F=async d=>{E.value=!0;const{data:l,error:T}=await ve(d);T||(b.value=l,v(l.tid+""))},W=M(""),v=async d=>{const{data:l,error:T}=await Se(d);if(!T){const I=Ne(l.cronExpression);W.value=I.settingTime}},c=M();async function R(d){const{data:l,error:T}=await ve(d);T||(c.value=l),L(d)}function w(d){Q(d,l=>{K()})}async function x(){Q(D.value.join(","),d=>{B()})}async function Q(d,l){const{data:T,error:I}=await nt(d);I||l&&l(T)}return(d,l)=>{const T=Me,I=Ze,j=_t,ne=vt,H=re,oe=ce,se=re;return U(),Te("div",Rt,[t(Tt,{model:n(i),"onUpdate:model":l[0]||(l[0]=p=>Y(i)?i.value=p:null),onReset:n(k),onSearch:n(f)},null,8,["model","onReset","onSearch"]),t(se,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:a(()=>[Ct]),"header-extra":a(()=>[t(T,{columns:n(s),"onUpdate:columns":l[1]||(l[1]=p=>Y(s)?s.value=p:null),"disabled-delete":n(D).length===0,loading:n(N),onAdd:n($),onRefresh:n(f),"is-view-add-button":n(he)("sys.report.task.insert"),isViewDeleteButton:n(he)("sys.report.task.delete"),onDelete:x},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","isViewDeleteButton"])]),default:a(()=>[t(I,{"checked-row-keys":n(D),"onUpdate:checkedRowKeys":l[2]||(l[2]=p=>Y(D)?D.value=p:null),columns:n(r),data:n(g),size:"small","flex-height":!n(h).isMobile,"scroll-x":962,loading:n(N),remote:"","row-key":p=>p.id,pagination:n(S),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),t(xt,{ref_key:"TaskModalRef",ref:O,visible:n(o),"onUpdate:visible":l[3]||(l[3]=p=>Y(o)?o.value=p:null),"operate-type":n(u),"row-data":c.value,onSubmitted:n(f)},null,8,["visible","operate-type","row-data","onSubmitted"]),t(oe,{show:E.value,"onUpdate:show":l[4]||(l[4]=p=>E.value=p),preset:"card",class:"w-500px",title:"报表任务详情"},{default:a(()=>[t(H,null,{default:a(()=>[t(ne,{"label-placement":"left",column:1,"label-style":{width:"100px",display:"inline-block",textAlign:"right",marginRight:"10px"}},{default:a(()=>[t(j,{label:"任务名称"},{default:a(()=>[y(C(b.value.rname),1)]),_:1}),t(j,{label:"实例"},{default:a(()=>{var p;return[y(C((p=n(te)(n(ye)).find(_=>_.value===b.value.rtype))==null?void 0:p.label),1)]}),_:1}),t(j,{label:"任务执行时间"},{default:a(()=>[y(C(b.value.starttime),1)]),_:1}),t(j,{label:"任务执行周期"},{default:a(()=>{var p,_,Z;return[y(C((p=n(te)(n(Oe)).find(q=>q.value===b.value.ttype))==null?void 0:p.label)+" "+C(b.value.ttype==1?(_=O.value.weekOption().find(q=>q.value==b.value.excute))==null?void 0:_.label:b.value.ttype==2?(Z=O.value.monthOption().find(q=>q.value==b.value.excute))==null?void 0:Z.label:"")+" "+C(W.value),1)]}),_:1}),t(j,{label:"描述"},{default:a(()=>[y(C(b.value.rdesc),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])]),_:1})])}}});export{Zt as default};
