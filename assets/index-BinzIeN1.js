import{Q as ve,p as he,_ as ye,a as be}from"./pako.esm-ChZc68K6.js";import{_ as xe}from"./export-DEQkfqUw.js";import{_ as ke}from"./round-search-D_uunT1F.js";import{d as J,ab as j,a0 as De,o as P,e as E,bS as Te,_ as K,ef as Se,aw as l,g as o,k as x,x as Pe,aj as Ce,r as $e,w as n,i,B as I,h as L,t as $,$ as H,c as V,D as U,f as A,aN as We,eg as Ne,y as Ie,H as Le,az as Ue,aA as Ae,aB as Be,aC as Me,aV as Re,O as ze,Q as Oe,a6 as qe,c8 as Ve,aT as Ee,P as Fe,c9 as Ge,aJ as je,R as He,T as Qe}from"./index-ABy-DYGK.js";import{u as Je,a as Ke}from"./table-BIfW3tlR.js";import{e as Ze}from"./exportExcel-Bv4G4H50.js";import{u as Xe,L as Q}from"./echarts-C-NvlGnb.js";import{_ as Ye}from"./lodash-D3AcHrqE.js";import{_ as ea}from"./DatePicker-X8jXn92k.js";import{_ as aa}from"./RadioButton-CtrSyOy4.js";import{_ as ta}from"./FormItemGridItem-nzI_lkEE.js";import{_ as oa}from"./Grid-BWAKd0f-.js";const na=J({name:"LineChart",__name:"line-chart",props:{data:{type:Object,default:()=>({})}},setup(S){const w=S;j(()=>w.data,async e=>{k(c=>(c.xAxis.data=w.data.map(r=>r.dbtime),c.series[0].data=w.data.map(r=>r.power),c.series[1].data=w.data.map(r=>r.prePower),c))});const f=De(),{domRef:B,updateOptions:M,updateOptionsAsync:k}=Xe(()=>({tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}},backgroundColor:"#6a7985",textStyle:{color:"rgb(224, 224, 224)"},valueFormatter:function(e){return Te(e,"MW")}},legend:{data:["实际功率","预测功率"]},toolbox:{show:!0,feature:{saveAsImage:{show:!0,name:"功率图表"},magicType:{show:!0,type:["line","bar"]}}},grid:{left:"2%",right:"4%",bottom:"10%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:[]},yAxis:{type:"value",axisLabel:{formatter:"{value} MW"}},series:[{color:"#e90445",name:"实际功率",type:"line",emphasis:{focus:"series"},lineStyle:{width:1},areaStyle:{color:new Q(0,0,0,1,[{offset:0,color:"rgba(233, 4, 69,0.3)"},{offset:1,color:"rgba(233, 4, 69,0)"}],!1),shadowColor:"rgba(233, 4, 69,0.9)",shadowBlur:20},data:[],connectNulls:!0},{color:"#009688",name:"预测功率",type:"line",emphasis:{focus:"series"},lineStyle:{width:1},areaStyle:{color:new Q(0,0,0,1,[{offset:0,color:"rgba(0, 150, 136,0.3)"},{offset:1,color:"rgba(0, 150, 136,0)"}],!1),shadowColor:"rgba(0, 150, 136,0.9)",shadowBlur:20},data:[],connectNulls:!0}],dataZoom:[{type:"inside",start:0,end:100},{start:0,end:100}]}));async function D(){await new Promise(e=>{setTimeout(e,200)}),M(e=>(e.xAxis.data=w.data.map(c=>c.dbtime),e.series[0].data=w.data.map(c=>c.power),e.series[1].data=w.data.map(c=>c.prePower),e))}function R(){M((e,c)=>{const r=c();return e.legend.data=r.legend.data,e.series[0].name=r.series[0].name,e.series[1].name=r.series[1].name,e})}async function z(){D()}return j(()=>f.locale,()=>{R()}),z(),(e,c)=>(P(),E("div",{ref_key:"domRef",ref:B,class:"h-600px overflow-hidden"},null,512))}}),sa=K(na,[["__scopeId","data-v-d0a50e34"]]),Z=S=>(He("data-v-7a60de6a"),S=S(),Qe(),S),ra={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},la=Z(()=>A("div",{style:{width:"100px"}},"定时刷新",-1)),ia={style:{width:"200px","margin-left":"20px"}},ca={key:1},ua=Z(()=>A("span",null,"二维码",-1)),pa=J({name:"realtimequery_powerquery",__name:"index",setup(S){const w=Date.now(),f=new Date(w).setHours(0,0,0,0);new Date(w).setHours(23,59,59,999);const{columns:B,columnChecks:M,data:k,getData:D,loading:R,mobilePagination:z,searchParams:e,resetSearchParams:c}=Je({apiFn:Se,apiParams:{page:1,pageSize:20,limit:20,startTime:l(1,f)||null,endTime:l(1,Date.now()+144e5)||null,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",width:60},{key:"dbtime",title:"时间",align:"center",width:100},{key:"power",title:"实际功率(MW)",align:"center",width:140},{key:"prePower",title:"预测功率(MW)",align:"center",width:140},{key:"ctime",title:"预测计算时间(s)",align:"center",width:140},{key:"operate",title:"误差(MW)",align:"center",width:100,render(t){const a=t.prePower-t.power>=0?t.prePower-t.power:t.power-t.prePower;return o("span",null,[a?parseFloat(a.toFixed(6)):""])}}]}),{checkedRowKeys:r}=Ke(k,D),h=x(null),O=x(!1),X=t=>{if(t){if(h.value!==null)return;y(),h.value=window.setInterval(async()=>y(),1e3*60*3)}else h.value!==null&&(clearInterval(h.value),h.value=null),y()},Y=async()=>{v.value=="0"?await y():await D()},C=x([]),W=x(""),y=async()=>{const{data:t,error:a}=await Ne({startTime:e.startTime,endTime:e.endTime});a||(C.value=t.sort((p,s)=>new Date(p.dbtime).getTime()-new Date(s.dbtime).getTime()))},N=x([f,Date.now()+144e5]);async function ee(t,a){e.startTime=l(1,a[0]),e.endTime=l(1,a[1]),e.startTime==l(1,f)&&e.endTime==l(1,Date.now()+144e5)?b.value="0":e.startTime==l(1,f)&&e.endTime==l(1,Date.now()+864e5*10)?b.value="1":b.value="2",v.value=="1"?D():y()}const ae=t=>{t=="1"?D():y()};Pe(()=>{y()});const te=()=>{var p;if(k.value.length==0)return(p=window.$message)==null?void 0:p.warning("暂无数据。请查询数据后重试。");const t={dbtime:"时间",power:"实际功率",prePower:"预测功率",ctime:"预测计算时间",error:"误差"},a=[];k.value.forEach(s=>{r.value.includes(s.id)&&a.push({dbtime:s.dbtime,power:s.power,prePower:s.prePower,error:s.prePower-s.power>=0?s.prePower-s.power:s.power-s.prePower||""})}),Ze(a,t,"预测数据")},v=x("0"),q=x(!1),oe=()=>{var s,_;if(C.value.length==0)return(s=window.$message)==null?void 0:s.warning("暂无数据。请查询数据后重试。");const t={data:C.value.map(g=>({t:g.dbtime,pP:g.prePower,p:g.power})),type:0,dateTime:l(1,e.startTime)+" --- "+(O.value?l(1,new Date):l(1,e.endTime))},p=he.gzip(JSON.stringify(t),{to:"string"}).reduce((g,d)=>g+String.fromCharCode(d),"");if(W.value=`https://dingiiot.com/powerPrediction/?${btoa(p)}`,W.value.length>2700)return(_=window.$message)==null?void 0:_.warning("二维码生成失败，请缩小查询范围后重试");console.log("地址",W.value),q.value=!0},ne=()=>{var a;const t=document.getElementById("qrcode");if(t){const p=document.createElement("a");p.href=t.toDataURL("image/png"),p.download="qrcode.png",p.click(),(a=window.$message)==null||a.success("下载成功")}else console.error("无法找到二维码 canvas 元素")},se={近一天:[Date.now()-864e5*1,Date.now()],近三天:[Date.now()-864e5*3,Date.now()],近七天:[Date.now()-864e5*7,Date.now()]},b=x("0"),re=t=>{b.value=t,u.powWsData="",t=="0"?(N.value=[f,Date.now()+144e5],e.startTime=l(1,f),e.endTime=l(1,Date.now()+144e5)):(N.value=[f,Date.now()+864e5*10],e.startTime=l(1,f),e.endTime=l(1,Date.now()+864e5*10)),v.value=="1"?D():y()};Ce(()=>{h.value!==null&&(clearInterval(h.value),h.value=null)});const u=$e({powerPreSocketWS:null,powLoading:!1,powWsData:"",timer:null}),le=()=>{var g;(g=u.powerPreSocketWS)==null||g.close(),setTimeout(()=>{var d,T;if(!u.powWsData&&u.powerPreSocketWS.socket)return(d=u.powerPreSocketWS)==null||d.close(),u.powLoading=!1,(T=window.$message)==null?void 0:T.error("查询预测数据超时")},20*1e3);const t=new Date().getTime(),a=Ie(),p=Le(`${a}${t}${b.value=="0"?0:960}`),s=Ue(p),_=new Ae(Be+`/powerPre/${b.value=="0"?0:960}/${s}/${t}/${a}?token=${Me()}`,{maxReconnectAttempts:1,heartbeatInterval:1e3*30});u.powerPreSocketWS=_,_.connect(),_.onclose(()=>{}),_.onerror(()=>{var d;_.close(),(d=window.$message)==null||d.error("查询预测数据失败"),u.powLoading=!1}),_.onopen(()=>{u.powLoading=!0}),_.onmessage(d=>{var T;console.log(d,"数据"),d.data.includes("请求成功,时间")&&(u.powWsData=d.data.replace("请求成功,时间","预测计算消耗时间"),u.powLoading=!1,(T=u.powerPreSocketWS)==null||T.close())})},ie=Ye.debounce(Y,1e3,{leading:!0,trailing:!1});return(t,a)=>{const p=ea,s=aa,_=Re,g=ke,d=ta,T=ye,ce=ze,ue=oa,pe=Oe,F=qe,G=Ve,de=Ee,me=xe,_e=Fe,we=Ge,fe=be,ge=je;return P(),E("div",ra,[o(F,{bordered:!1,size:"small"},{default:n(()=>[o(pe,{ref:"formRef",model:i(e),"label-placement":"left","show-feedback":!1},{default:n(()=>[o(ue,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:n(()=>[o(d,{span:"24 s:24 m:24 l:24",label:"起止时间",path:"startTime"},{default:n(()=>[o(p,{value:N.value,"onUpdate:value":a[0]||(a[0]=m=>N.value=m),type:"datetimerange","value-format":"yyyy-MM-dd hh:mm:ss","onUpdate:formattedValue":ee,"default-time":["00:00:00","23:59:59"],shortcuts:se},null,8,["value"]),o(_,{value:b.value,"onUpdate:value":[a[1]||(a[1]=m=>b.value=m),re],class:"ml-20px"},{default:n(()=>[o(s,{value:"0",label:"超短期"}),o(s,{value:"1",label:"短期"})]),_:1},8,["value"]),o(i(I),{type:"primary",ghost:"",onClick:i(ie),class:"ml-20px"},{icon:n(()=>[o(g,{class:"text-icon"})]),default:n(()=>[L(" "+$(i(H)("common.search")),1)]),_:1},8,["onClick"])]),_:1}),o(d,{span:"24 s:24 m:24 l:24",label:"",path:"startTime"},{default:n(()=>[v.value=="0"?(P(),V(i(I),{key:0,type:"primary",ghost:"",onClick:oe},{icon:n(()=>[o(T,{class:"text-icon"})]),default:n(()=>[L(" "+$("生成二维码"))]),_:1})):U("",!0),v.value=="0"?(P(),V(ce,{key:1,checked:O.value,"onUpdate:checked":[a[2]||(a[2]=m=>O.value=m),X],class:"ml-20px",title:"3分钟自动刷新"},{default:n(()=>[la]),_:1},8,["checked"])):U("",!0),o(i(I),{type:"primary",ghost:"",onClick:le,loading:u.powLoading},{default:n(()=>[L(" 查询预测数据计算时间 ")]),_:1},8,["loading"]),A("span",ia,$(u.powWsData),1)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),o(F,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{default:n(()=>[o(we,{type:"card",animated:"",value:v.value,"onUpdate:value":[a[4]||(a[4]=m=>v.value=m),ae],class:"h-100%","tab-style":{height:"40px"},"pane-wrapper-style":{flex:1}},{suffix:n(()=>[v.value=="1"?(P(),V(_e,{key:0,align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:n(()=>[o(i(I),{onClick:te,size:"small",disabled:i(r).length==0},{icon:n(()=>[o(me,{class:"text-icon"})]),default:n(()=>[L(" "+$(i(H)("common.export")),1)]),_:1},8,["disabled"])]),_:1})):U("",!0),v.value=="0"?(P(),E("span",ca,"共"+$(C.value.length)+"条数据",1)):U("",!0)]),default:n(()=>[o(G,{name:"0",tab:"图表"},{default:n(()=>[o(sa,{data:C.value},null,8,["data"])]),_:1}),o(G,{name:"1",tab:"表格",class:"h-100%"},{default:n(()=>[o(de,{"checked-row-keys":i(r),"onUpdate:checkedRowKeys":a[3]||(a[3]=m=>We(r)?r.value=m:null),columns:i(B),data:i(k),size:"small",loading:i(R),remote:"","row-key":m=>m.id,pagination:i(k).length?i(z):void 0,class:"sm:h-full","flex-height":!0,"scroll-x":""},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1},8,["value"])]),_:1}),o(ge,{show:q.value,"onUpdate:show":a[5]||(a[5]=m=>q.value=m),title:"",preset:"card",class:"w-auto"},{header:n(()=>[A("div",null,[ua,o(fe,{class:"text-icon ml-20px font-size-24px",style:{cursor:"pointer"},onClick:ne})])]),default:n(()=>[o(ve,{id:"qrcode",style:{margin:"0 auto"},value:W.value,margin:3,size:500,level:"L"},null,8,["value"])]),_:1},8,["show"])])}}}),Da=K(pa,[["__scopeId","data-v-7a60de6a"]]);export{Da as default};
