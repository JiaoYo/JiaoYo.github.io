import{_ as se}from"./table-column-setting.vue_vue_type_script_setup_true_lang-C_b5ped_.js";import{_ as le}from"./round-search-BUrhrzUs.js";import{d as oe,bt as ce,g as l,aN as S,aQ as ie,aY as U,v as re,ae as ue,j as v,aq as de,x as j,F as L,a_ as T,a$ as F,b0 as J,aA as V,a6 as pe,o as _e,e as me,w as p,h as E,i as s,ai as he,A as ge,B as fe,aa as ye,f as W,J as ve,z as ke,bu as be,t as we,al as G,af as xe,H as $e,an as Se,K as Te,ag as De,ao as Ne,a1 as ze,O as qe}from"./index-mAjjolp3.js";import{u as Ce,a as Ie}from"./table-DMl8_IGQ.js";import{a as Pe,p as Ae}from"./gather-D7gdhw1p.js";import{h as H}from"./permission-Caq3J9BP.js";import{_ as Ue}from"./InputGroupLabel-CqTQ8stI.js";import{_ as Ee}from"./Tree-HX5myhqE.js";import{_ as Oe}from"./Split-BYOt_Ot5.js";const Ke={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Be={class:"flex flex-col"},Re=oe({name:"configsetting_realtimedata_devicedata",__name:"index",setup(je){const{columns:M,columnChecks:D,data:w,getData:k,loading:O,mobilePagination:Y,searchParams:g,resetSearchParams:Le}=Ce({apiFn:ce,apiParams:{page:1,pageSize:200,limit:200,tagType:null,chlid:null,devId:null,fuzzy:"",chlType:0,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",align:"center",width:48},{key:"id",title:"序号",align:"center",width:80},{key:"devId",title:"设备名称",align:"center",width:100,render:e=>{var t;return l("span",null,[(t=K.value.find(n=>n.id==e.devId))==null?void 0:t.devName])}},{key:"tagName",title:"测点名称",align:"center"},{key:"tagDesc",title:"物模型标识(测点描述)",align:"center"},{key:"value",title:"测点值",align:"center",width:140,render:e=>{var t;return S("span",{style:{color:e.quality===100?"red":e.quality==49?"#409eff":e.quality==50?"#909399":"#67c23a"}},parseFloat((t=e.value)==null?void 0:t.toFixed(6))||e.value)}},{key:"quality",title:"质量",align:"center",width:120,render:e=>(e.quality==100||e.quality==49||e.quality==0)&&S(ie,{style:{background:e.quality===100?"red":e.quality==49?"#409eff":"#67c23a",color:"#fff"}},e.quality==0?"Good":e.quality==49?"人工置数":e.quality==100?"Bad":"")},{key:"dbtime",title:"采集时间",align:"center",minWidth:120,render:e=>{var t,n;return S("span",{title:U(0,+e.dbtime)},e.dbtime?(n=U(2,+e.dbtime))==null?void 0:n.substring(10,(t=U(2,+e.dbtime))==null?void 0:t.length):"")}},{key:"tagType",title:"测点类型",align:"center",width:140,render:e=>l("span",null,[Pe[e.tagType]])},{key:"objAddr",title:"地址",align:"center",width:140}]}),Q=e=>{e===""&&k()};re(async()=>{await X(),C(),Z()}),ue(()=>{var e,t;(e=N.value)==null||e.close(),(t=$.value)==null||t.close()});const y=v(),K=v([]),X=async()=>{const{data:e,error:t}=await de();if((e==null?void 0:e.length)==0)return;function n(m){return m.map(c=>{var a;return{label:c.chlName,key:c.id,dev_status:null,children:(a=c.devicePojoList)!=null&&a.length?c.devicePojoList.map(o=>(K.value.push(o),{label:o.devName,dev_status:null,chlType:c.chlType,key:o.id})):[]}})}y.value=n(e),g.chlid=y.value[0].key,g.devId=y.value[0].children[0].key,I.value=[y.value[0].children[0].key],x.value=y.value[0].children[0].label,k()},N=v(null),Z=()=>{var o,u,f;if((o=N.value)==null||o.close(),!H("channel:status:websocket")){(u=window.$message)==null||u.destroyAll(),(f=window.$message)==null||f.warning("暂无权限连接websocket");return}const e=new Date().getTime(),t=j(),n=L(`${t}${e}getchlstatus`),m=T(n),c=T("getchlstatus"),a=new F(J+`/ChannelStatusWebsocket/${c}/${m}/${e}/${t}?token=${V()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});N.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(_=>{let h=[];console.log(_,"通道状态websocket接受数据"),B(_.data)&&(h=JSON.parse(_.data).data,y.value.forEach(d=>{h.forEach(i=>{var b;i.chl_id==d.key&&(d.dev_status=i.chl_status),i.chl_id==1&&(d.dev_status=1),(b=d.children)==null||b.forEach(r=>{var R;(R=i.devs)==null||R.forEach(A=>{A.dev_id==r.key&&(r.dev_status=A.dev_status),A.dev_id==1&&(r.dev_status=1)})})})}))})},$=v(null),z=v(""),q=v(!0),C=()=>{var o,u,f;if((o=$.value)==null||o.close(),!H("realtime:data:websocket")){(u=window.$message)==null||u.destroyAll(),(f=window.$message)==null||f.warning("暂无权限连接websocket");return}q.value=!0;const e=new Date().getTime(),t=j(),n=L(`${t}${e}${x.value}`),m=T(n),c=T(x.value),a=new F(J+`/realTimeDataWebsocket/${c}/${m}/${e}/${t}?token=${V()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});$.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(_=>{let h=[];console.log(_,"实时数据websocket接受数据"),B(_.data)&&(h=JSON.parse(_.data).data[x.value],h==null||h.forEach(d=>{w.value.forEach(i=>{d.i==i.id&&(i.quality=d.q,i.value=d.v,i.dbtime=d.t)})}),z.value=ne())})},I=v([]),x=v(""),ee=async(e,t,n)=>{var a,o,u,f,_;I.value=[(a=n.node)==null?void 0:a.key],g.chlType=(o=n.node)==null?void 0:o.chlType;function m(h,d){for(const i of h)if(i.children){for(const b of i.children)if(b.key===d)return i.key}return null}const c=await m(y.value,(u=n.node)==null?void 0:u.key);g.chlid=c,g.devId=(f=n.node)==null?void 0:f.key,x.value=(_=n.node)==null?void 0:_.label,k(),C()},te=e=>{var t;e&&w.value.length>0?C():(t=$.value)==null||t.close()};pe(()=>g.tagType,e=>{e||k()});const ae=({option:e})=>e.key==0?"":e.dev_status!==null?S("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:e.hasOwnProperty("dev_status")&&e.dev_status==1?"#00b42a":e.dev_status==2?"#ff0000":"#ccc"}}):"",ne=e=>{const t=new Date,n=t.getFullYear(),m=String(t.getMonth()+1).padStart(2,"0"),c=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),u=String(t.getSeconds()).padStart(2,"0");return`${n}-${m}-${c} ${a}:${o}:${u}`},{drawerVisible:Fe,operateType:Je,editingData:Ve,handleAdd:We,handleEdit:Ge,checkedRowKeys:P,onBatchDeleted:He,onDeleted:Me}=Ie(w,k),B=e=>{try{return JSON.parse(e),!0}catch{return!1}};return(e,t)=>{const n=Ue,m=xe,c=$e,a=le,o=Se,u=Te,f=se,_=Ee,h=De,d=Ne,i=Oe,b=ze;return _e(),me("div",Ke,[l(b,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:p(()=>[l(u,{align:"center",wrap:"",justify:"start",class:"lt-sm:w-200px"},{default:p(()=>[l(o,null,{default:p(()=>[l(n,null,{default:p(()=>[E("测点类型")]),_:1}),l(m,{filterable:"",clearable:"",placeholder:"请选择",value:s(g).tagType,"onUpdate:value":t[0]||(t[0]=r=>s(g).tagType=r),options:s(he)(s(Ae))},null,8,["value","options"]),l(c,{clearable:"",value:s(g).fuzzy,"onUpdate:value":[t[1]||(t[1]=r=>s(g).fuzzy=r),Q],placeholder:"请输入测点名称或描述",style:{width:"150%"},onKeyup:ge(s(k),["enter"])},null,8,["value","onKeyup"]),l(s(fe),{type:"primary",ghost:"",onClick:s(k)},{icon:p(()=>[l(a,{class:ye(["text-icon",{"animate-spin":s(O)}])},null,8,["class"])]),default:p(()=>[E(" 搜索 ")]),_:1},8,["onClick"])]),_:1}),W("div",Be,[l(s(ve),{checked:q.value,"onUpdate:checked":[t[2]||(t[2]=r=>q.value=r),te]},{default:p(()=>[E(" 实时刷新 ")]),_:1},8,["checked"]),ke(W("span",{class:"font-size-14px color-blank",style:{"font-weight":"600"}}," 刷新时间："+we(z.value),513),[[be,z.value]])])]),_:1})]),"header-extra":p(()=>[l(u,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:p(()=>[l(f,{columns:s(D),"onUpdate:columns":t[3]||(t[3]=r=>G(D)?D.value=r:null)},null,8,["columns"])]),_:1})]),default:p(()=>[l(i,{direction:"horizontal",class:"sm:h-full","default-size":.15,max:.35,min:.1,"resize-trigger-size":6},{1:p(()=>[l(h,{style:{"max-height":"700px"}},{default:p(()=>[l(_,{"block-line":"","default-expand-all":"",data:y.value,"checked-keys":I.value,"expand-on-click":!1,"render-prefix":ae,"check-strategy":"child","onUpdate:checkedKeys":ee,checkable:""},null,8,["data","checked-keys"])]),_:1})]),2:p(()=>[l(d,{"checked-row-keys":s(P),"onUpdate:checkedRowKeys":t[4]||(t[4]=r=>G(P)?P.value=r:null),columns:s(M),data:s(w),size:"small",loading:s(O),remote:"","row-key":r=>r.id,"flex-height":!0,"scroll-x":"",pagination:s(w).length?s(Y):void 0,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1})])}}}),lt=qe(Re,[["__scopeId","data-v-34237ec7"]]);export{lt as default};
