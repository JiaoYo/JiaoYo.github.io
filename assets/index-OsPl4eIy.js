import{_ as Ue}from"./table-column-setting.vue_vue_type_script_setup_true_lang-D0lRqPz4.js";import{_ as Be}from"./round-delete-Dxr52Tdg.js";import{_ as Le}from"./round-add-CfYkVrv9.js";import{d as fe,av as me,z as we,D as qe,s as S,aK as be,A as Ce,a as Re,at as ke,au as Ie,c as K,o as j,w as a,f as e,a3 as Fe,b as oe,G as ge,M as xe,h as l,ay as Se,H as ne,aP as Me,b0 as Ee,e as le,t as $,aA as Oe,J as _e,B as I,g as L,$ as F,a4 as Ve,cC as je,aE as Te,aG as Ae,df as Ge,dg as Ke,az as He,L as Je,a2 as De,aJ as Qe,i as We,F as pe,aL as ce,ax as Xe,I as ue,aM as Ye,dh as ve,di as Ze,n as et,aR as tt}from"./index-DCPTYPg6.js";import{u as at,a as nt}from"./table-wEqNRbcE.js";import{u as $e}from"./usePageData-BUYwLNSk.js";import{_ as Ne}from"./Grid-p0WIMYG_.js";import{_ as ze}from"./FormItemGridItem-C8JcVRRJ.js";import{_ as ot}from"./round-search-Digdfr9X.js";import{_ as lt}from"./round-refresh-Bsy-Eh7C.js";import{N as he}from"./Popconfirm-BQoV-jsN.js";const st={key:0,style:{"margin-left":"20px"}},rt=["onClick"],it=["onClick"],ct={key:0},ut={style:{display:"flex","justify-content":"space-between"}},dt=fe({name:"OperateDrawer",__name:"operate-drawer",props:me({operateType:{},rowData:{},pid:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:me(["submitted"],["update:visible"]),setup(N,{emit:H}){const z=we(),q=H,w=N,t=qe(C());S();function C(){return{pid:void 0,id:"",reqcontent:"",customer:"",cstcontact:"",notes:"",re1:"",re2:"",re3:"",re4:"",fl1:"",fl2:"",fl3:"",fl4:""}}const d=S([]),{pageData:_,getData:v,nextPage:J}=$e(je),M=async o=>{const n=o.currentTarget,g=n.scrollTop;n.scrollTop+n.offsetHeight>=n.scrollHeight&&_.data.length<_.total&&(await J(),d.value=_.data,await Te(),setTimeout(()=>{n.scrollTop=g}))},Q=async()=>{await v({fuzzy:z.userInfo.pname,page:1}),d.value=_.data},W=be.debounce(async o=>{await v({fuzzy:o,page:1}),d.value=_.data},300),P=S(!1),U=S(!1),T=o=>{if(t.pid=null,P.value=!0,U.value=!1,!o){E();return}W(o)},X=async()=>{P.value&&!U.value&&(await v({page:1}),d.value=_.data,P.value=!1)},E=async()=>{await v({page:1}),d.value=_.data},se=async o=>{t.pid=o,U.value=!0};async function Y(){var o;if(Q(),Object.assign(t,C()),m.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}],t.pid=w.pid?w.pid:(o=d.value[0])==null?void 0:o.id,w.operateType==="edit"&&w.rowData){Object.assign(t,w.rowData),m.value=[];for(let n=1;n<=4;n++){const g=t[`re${n}`],D=t[`fl${n}`];m.value.push({name:g||"",url:D||"",status:D?"finished":"pending"})}}}const{formRef:A,validate:i,restoreValidation:u}=Ce(),k={pid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择"},reqcontent:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},customer:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},cstcontact:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"}},p=Re(()=>({add:"新增需求变更",edit:"修改需求变更"})[w.operateType]),s=ke(N,"visible");async function h(o){if(o)try{const g=await(await fetch(o==null?void 0:o.split("?")[0],{mode:"cors"})).blob(),D=URL.createObjectURL(g),b=document.createElement("a");b.href=D,b.download=o==null?void 0:o.split("?")[1],b.style.display="none",document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(D)}catch(n){console.error("下载失败:",n)}}Ie(s,()=>{s.value&&(Y(),setTimeout(()=>{const o=document.querySelector(".n-scrollbar-content");o==null||o.scrollTo(0,0)},300),u())});const B=S(!1),x=S(0),m=S([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]);async function Z({file:o},n){m.value[n].file=o,m.value[n].name=o.name}function O(){s.value=!1}async function G(o){var n;return o.file.file.size>100*1024*1024?((n=window.$message)==null||n.error("文件大小不能超过100M"),!1):!0}const y=S(!1);async function Pe(){var o,n,g,D;if(!y.value)try{await i(),y.value=!0;let b=!0;if(m.value.forEach((f,c)=>{var te,ae;const ee=`re${c+1}`,r=`fl${c+1}`,V=f.name||"",R=((te=f.url)==null?void 0:te.split("?")[1])||((ae=f.file)==null?void 0:ae.name);(V&&!R||!V&&R)&&(b=!1),f.status==="done"&&(t[ee]=V,t[r]=R)}),!b){(n=(o=window.$message)==null?void 0:o.error)==null||n.call(o,"文件名称和文件地址必须同时存在，不能只填一个");return}B.value=!0;const re=m.value.filter(f=>f.file),ie=re.length;for(let f=0;f<ie;f++){x.value=f;const c=re[f];c.indexText=`${f+1}/${ie}`,c.progress=0,c.status="uploading";try{c.url=await Ae(c.file.file,c.file.name,"",ee=>{c.progress=ee}),c.progress=100,c.status="done"}catch{c.status="error"}}if(m.value.forEach((f,c)=>{t[`re${c+1}`]=f.name||"",t[`fl${c+1}`]=f.url||""}),B.value=!1,w.operateType==="edit"){const{data:f,error:c}=await Ge([t]);c||(O(),q("submitted"),(g=window.$message)==null||g.success("修改成功"))}else{const{data:f,error:c}=await Ke([{...t}]);c||(O(),q("submitted"),(D=window.$message)==null||D.success("添加成功"))}}catch{}finally{y.value=!1}}return(o,n)=>{const g=ze,D=He,b=Ne,re=xe,ie=Oe,f=Fe,c=_e,ee=Ve;return j(),K(ee,{show:s.value,"onUpdate:show":n[5]||(n[5]=r=>s.value=r),title:p.value,preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{footer:a(()=>[e(c,{justify:"end",size:16},{default:a(()=>[e(l(I),{onClick:O},{default:a(()=>[L($(l(F)("common.cancel")),1)]),_:1}),e(l(I),{type:"primary",onClick:Pe,loading:y.value},{default:a(()=>[L($(l(F)("common.confirm")),1)]),_:1},8,["loading"])]),_:1})]),default:a(()=>[e(f,{class:"pr-20px"},{default:a(()=>[e(re,{ref_key:"formRef",ref:A,model:t,rules:k,"label-placement":"left","label-width":120},{default:a(()=>[e(b,{responsive:"screen","item-responsive":""},{default:a(()=>[e(g,{span:"24 m:12",label:"项目列表",path:"pid"},{default:a(()=>[e(l(Se),{clearable:"",filterable:"",value:t.pid,"onUpdate:value":[n[0]||(n[0]=r=>t.pid=r),se],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:E,onSearch:T,onBlur:X,options:d.value,onScroll:M},null,8,["value","options"])]),_:1}),e(g,{span:"24 m:12",label:"需求内容",path:"reqcontent"},{default:a(()=>[e(l(ne),{value:t.reqcontent,"onUpdate:value":n[1]||(n[1]=r=>t.reqcontent=r),placeholder:"请输入"},null,8,["value"])]),_:1}),e(g,{span:"24 m:12",label:"客户联系人",path:"customer"},{default:a(()=>[e(l(ne),{value:t.customer,"onUpdate:value":n[2]||(n[2]=r=>t.customer=r),placeholder:"请输入"},null,8,["value"])]),_:1}),e(g,{span:"24 m:12",label:"联系方式",path:"cstcontact"},{default:a(()=>[e(l(ne),{value:t.cstcontact,"onUpdate:value":n[3]||(n[3]=r=>t.cstcontact=r),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),e(g,{span:"24 m:12",label:"备注",path:"notes"},{default:a(()=>[e(l(ne),{value:t.notes,"onUpdate:value":n[4]||(n[4]=r=>t.notes=r),placeholder:"请输入"},null,8,["value"])]),_:1}),(j(!0),oe(Me,null,Ee(m.value,(r,V)=>(j(),K(g,{span:"24 m:24",label:"",path:"notes","show-feedback":!1,key:V},{default:a(()=>[e(b,{responsive:"screen","item-responsive":""},{default:a(()=>[e(g,{span:"24 m:12",label:`附件${V+1}`,path:"notes"},{default:a(()=>[e(l(ne),{value:r.name,"onUpdate:value":R=>r.name=R,placeholder:"请输入",style:{width:"250px"}},null,8,["value","onUpdate:value"])]),_:2},1032,["label"]),e(g,{span:"24 m:12",label:"",path:"notes"},{default:a(()=>{var R,te,ae;return[(R=r.url)!=null&&R.split("?")[1]||(te=r.file)!=null&&te.name?(j(),oe("span",st,[L($(((ae=r.url)==null?void 0:ae.split("?")[1])||r.file.name)+" ",1),le("span",{class:"cursor-pointer c-#c92a2a",onClick:de=>{r.url="",r.file=void 0,r.name=""}},"删除",8,rt),r.url?(j(),oe("span",{key:0,class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:de=>h(r.url)},"下载",8,it)):ge("",!0)])):(j(),K(D,{key:1,style:{width:"auto","margin-left":"20px"},ref_for:!0,ref:"uploadRef",action:"#","custom-request":de=>Z(de,V),"show-file-list":!1,onBeforeUpload:G},{default:a(()=>[e(l(I),{size:"small",ghost:"",type:"primary"},{default:a(()=>n[6]||(n[6]=[L($("选择文件"))])),_:1,__:[6]})]),_:2},1032,["custom-request"]))]}),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1},8,["model"]),m.value[x.value]&&B.value?(j(),oe("div",ct,[le("div",ut,[le("span",null,$(m.value[x.value].filename||m.value[x.value].name),1),le("span",null,$(m.value[x.value].indexText),1)]),e(ie,{percentage:m.value[x.value].progress,status:m.value[x.value].status==="error"?"error":"success","show-indicator":""},null,8,["percentage","status"])])):ge("",!0)]),_:1})]),_:1},8,["show","title"])}}}),pt=fe({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:me(["reset","search","clear"],["update:model"]),setup(N,{emit:H}){const z=H,{formRef:q,restoreValidation:w}=Ce(),t=ke(N,"model"),C=we(),d=S([]),{pageData:_,getData:v,nextPage:J}=$e(je),M=async i=>{const u=i.currentTarget,k=u.scrollTop;u.scrollTop+u.offsetHeight>=u.scrollHeight&&_.data.length<_.total&&(await J(),d.value=_.data,await Te(),setTimeout(()=>{u.scrollTop=k}))},Q=async i=>{var u;U.value=!0,i?(t.value.pid=i,z("search"),C.setProjectInfo({pname:(u=d.value.find(k=>k.id==i))==null?void 0:u.proname,pid:i})):z("clear")},W=be.debounce(async i=>{await v({fuzzy:i,page:1}),d.value=_.data},300),P=S(!1),U=S(!1),T=i=>{if(t.value.pid=null,P.value=!0,U.value=!1,!i){E();return}W(i)},X=async()=>{P.value&&!U.value&&(await v({page:1}),d.value=_.data,P.value=!1)},E=async()=>{await v({page:1}),d.value=_.data};(async()=>{var i,u;await v({fuzzy:C.userInfo.pname}),d.value=_.data,t.value.pid=C.userInfo.pid?C.userInfo.pid:(i=d.value[0])==null?void 0:i.id,t.value.pid&&(C.setProjectInfo({pid:t.value.pid,pname:(u=d.value.find(k=>k.id==t.value.pid))==null?void 0:u.proname}),z("search"))})();async function Y(){await w(),t.value.fuzzy="",z("reset")}async function A(){var i,u;t.value.pid?z("search"):((i=window.$message)==null||i.destroyAll(),(u=window.$message)==null||u.warning("请选择项目"))}return(i,u)=>{const k=Se,p=ze,s=lt,h=I,B=ot,x=_e,m=Ne,Z=xe,O=De;return j(),K(O,{bordered:!1,size:"small",class:"card-wrapper"},{default:a(()=>[e(Z,{ref_key:"formRef",ref:q,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Je(A,["enter"])},{default:a(()=>[e(m,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:a(()=>[e(p,{span:"24 s:12 m:6",label:"项目列表",path:"PrjId"},{default:a(()=>[e(k,{filterable:"",clearable:"",value:t.value.pid,"onUpdate:value":[u[0]||(u[0]=G=>t.value.pid=G),Q],placeholder:"请选择项目","label-field":"proname","value-field":"id",options:d.value,onScroll:M,onClear:E,onSearch:T,onBlur:X},null,8,["value","options"])]),_:1}),e(p,{span:"24  s:12 m:6",class:"pr-24px"},{default:a(()=>[e(x,{class:"w-full"},{default:a(()=>[e(h,{onClick:Y},{icon:a(()=>[e(s,{class:"text-icon"})]),default:a(()=>[L(" "+$(l(F)("common.reset")),1)]),_:1}),e(h,{type:"primary",ghost:"",onClick:A},{icon:a(()=>[e(B,{class:"text-icon"})]),default:a(()=>[L(" "+$(l(F)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),mt={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function ye(N){return typeof N=="function"||Object.prototype.toString.call(N)==="[object Object]"&&!tt(N)}const St=fe({name:"projectmanagement_needchange",__name:"index",setup(N){const H=Qe(),{columns:z,columnChecks:q,data:w,getData:t,loading:C,pagination:d,mobilePagination:_,searchParams:v}=at({showTotal:!0,immediate:!1,apiFn:Ze,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"reqcontent",title:"需求内容",align:"center",width:120},{key:"customer",title:"客户联系人",align:"center",width:120},{key:"cstcontact",title:"联系方式",align:"center",width:120},{key:"cstresult",title:"结果",align:"center",width:120,render(p){return et("div",{},p.cstresult==0?"失败":p.cstresult==1?"成功":"")}},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"操作人",align:"center",width:120},{key:"dbtime",title:"操作时间",align:"center",width:120},{key:"operate",title:F("common.operate"),align:"center",width:140,fixed:"right",render:p=>{let s;return e("div",{class:"flex-center gap-8px"},[ue(e(I,{type:"primary",ghost:!0,size:"small",onClick:()=>A(p.id)},ye(s=F("common.edit"))?s:{default:()=>[s]}),[[pe("no-auth"),"project:Customer:update"]]),e(he,{onPositiveClick:()=>Y(p.id)},{default:()=>F("common.confirmDelete"),trigger:()=>{let h;return ue(e(I,{type:"error",ghost:!0,size:"small"},ye(h=F("common.delete"))?h:{default:()=>[h]}),[[pe("no-auth"),"project:Customer:delete"]])}})])}}]}),J=()=>{w.value=[],d.itemCount=0},{drawerVisible:M,operateType:Q,editingData:W,handleAdd:P,handleEdit:U,checkedRowKeys:T,onBatchDeleted:X,onDeleted:E}=nt(w,t);We(async()=>{});async function se(){console.log(T.value),i(T.value.join(","),p=>{X()})}async function Y(p){const{data:s,error:h}=await ve(p,v.pid);h||E()}function A(p){U(p)}async function i(p,s){const{data:h,error:B}=await ve(p,v.pid);if(!B)s&&s(h);else return!1}const u=p=>{t()},k=()=>{t()};return(p,s)=>{const h=_e,B=Le,x=Be,m=Ue,Z=Xe,O=De,G=pe("no-auth");return j(),oe("div",mt,[e(pt,{model:l(v),"onUpdate:model":s[0]||(s[0]=y=>ce(v)?v.value=y:null),onReset:k,onSearch:l(t),onClear:J},null,8,["model","onSearch"]),e(O,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:a(()=>[e(h,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:a(()=>s[4]||(s[4]=[le("div",null,"需求变更",-1)])),_:1,__:[4]})]),"header-extra":a(()=>[e(h,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:a(()=>[ue((j(),K(l(I),{onClick:l(P),size:"small",ghost:"",type:"primary"},{icon:a(()=>[e(B,{class:"text-icon"})]),default:a(()=>[s[5]||(s[5]=L(" "+$("新增")))]),_:1,__:[5]},8,["onClick"])),[[G,"project:Customer:insert"]]),e(l(he),{onPositiveClick:se},{trigger:a(()=>[ue((j(),K(l(I),{size:"small",ghost:"",type:"error",disabled:l(T).length==0},{icon:a(()=>[e(x,{class:Ye(["text-icon",{"animate-spin":l(C)}])},null,8,["class"])]),default:a(()=>[s[6]||(s[6]=L(" "+$("批量删除")))]),_:1,__:[6]},8,["disabled"])),[[G,"project:Customer:delete"]])]),default:a(()=>[s[7]||(s[7]=L(" 确定要删除选中的吗？ "))]),_:1,__:[7]}),e(m,{columns:l(q),"onUpdate:columns":s[1]||(s[1]=y=>ce(q)?q.value=y:null),ctype:13},null,8,["columns"])]),_:1})]),default:a(()=>[e(Z,{"checked-row-keys":l(T),"onUpdate:checkedRowKeys":s[2]||(s[2]=y=>ce(T)?T.value=y:null),columns:l(z),data:l(w),size:"small","flex-height":!l(H).isMobile,loading:l(C),remote:"","row-key":y=>y.id,pagination:l(_),class:"sm:h-full","onUpdate:filters":u},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),e(dt,{visible:l(M),"onUpdate:visible":s[3]||(s[3]=y=>ce(M)?M.value=y:null),onSubmitted:l(t),pid:l(v).pid,"operate-type":l(Q),"row-data":l(W)},null,8,["visible","onSubmitted","pid","operate-type","row-data"])]),_:1})])}}});export{St as default};
