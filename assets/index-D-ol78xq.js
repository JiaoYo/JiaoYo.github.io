import{_ as re}from"./table-header-operation.vue_vue_type_script_setup_true_lang-sZrXAUWR.js";import{d as V,q as O,v as Z,s as J,o as q,c as Q,w as l,g as e,h as D,t as B,i as s,$ as v,M as ie,A as ue,aj as Y,E as ee,B as M,D as ae,a9 as te,r as E,x as me,b as de,y as pe,C as ce,X as fe,aa as ge,ab as _e,Z as ve,ar as ye,am as he,L as H,K as W,e as we,ac as F,ad as be}from"./index-BthjjP8Z.js";import{u as xe,a as De}from"./table-DgUtF0JO.js";import{_ as Ne}from"./round-search-D0y4Bi99.js";import{_ as ke}from"./round-refresh-7YBMJmxM.js";import{_ as Se}from"./FormItemGridItem-Cf_xNcQf.js";import{_ as Te}from"./Grid-CrjQrgB8.js";import{u as Ce}from"./usePageData-DsxRw8IA.js";import{a as ze,b as Ue,c as $e,d as Re,e as Pe}from"./events-DGJVlmYq.js";import{f as Ae,a as Ie}from"./common-DWrY_MNZ.js";import{_ as Le}from"./Cascader-BpetLQ8K.js";import{b as je,a as Fe,_ as Be}from"./DataTable-DVNKf1bg.js";import{h as X}from"./permission-DgnWzPLf.js";import{_ as Me}from"./Popconfirm-DUBjdYuJ.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-P1qKwD6q.js";import"./setting-outlined-CB-n0fXZ.js";import"./round-delete-imzaxX0A.js";import"./refresh-516o5uee.js";import"./Upload-CXW3Rb5a.js";import"./Progress-CegqNBwu.js";import"./Forward-B9_DMOnd.js";const Ee=V({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:O(["reset","search"],["update:model"]),setup(y,{emit:$}){const i=$,{formRef:w,restoreValidation:b}=Z(),n=J(y,"model");function T(p){n.value.fuzzy=p.replace(/\s/g,"")}function R(p){return!p.startsWith(" ")&&!p.endsWith(" ")}function N(){n.value.fuzzy=null,i("search")}async function P(){await b(),i("reset")}async function o(){var p,u,x,_;if(n.value.mintime&&n.value.maxtime&&n.value.maxtime-n.value.mintime<0)return(p=window.$message)==null||p.destroyAll(),(u=window.$message)==null||u.error("最小限定时间不得大于最大限定时间"),!1;if(n.value.minagg&&n.value.maxagg&&n.value.maxagg-n.value.minagg<0)return(x=window.$message)==null||x.destroyAll(),(_=window.$message)==null||_.error("最小聚合次数不得大于最大聚合次数"),!1;i("search")}return(p,u)=>{const x=ue,_=Se,c=Y,h=ee,A=ke,I=M,L=Ne,j=Te,k=ae,C=te;return q(),Q(C,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[e(k,{ref_key:"formRef",ref:w,model:n.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:ie(o,["enter"])},{default:l(()=>[e(j,{responsive:"screen","item-responsive":""},{default:l(()=>[e(_,{span:"24 s:12 m:6",label:"策略名称",path:"fuzzy",class:"pr-24px"},{default:l(()=>[e(x,{clearable:"",value:n.value.fuzzy,"onUpdate:value":u[0]||(u[0]=f=>n.value.fuzzy=f),placeholder:"请输入策略名称",onInput:T,"allow-input":R,onClear:N},null,8,["value"])]),_:1}),e(_,{span:"24 s:12 m:7",label:"最大限定时间",class:"pr-24px"},{default:l(()=>[e(h,{wrap:!1,align:"center"},{default:l(()=>[e(c,{value:n.value.mintime,"onUpdate:value":u[1]||(u[1]=f=>n.value.mintime=f),min:0,placeholder:"最小限定时间"},null,8,["value"]),D(" — "),e(c,{value:n.value.maxtime,"onUpdate:value":u[2]||(u[2]=f=>n.value.maxtime=f),min:0,placeholder:"最大限定时间"},null,8,["value"])]),_:1})]),_:1}),e(_,{span:"24 s:12 m:7",label:"最大聚合次数",class:"pr-24px"},{default:l(()=>[e(h,{wrap:!1,align:"center"},{default:l(()=>[e(c,{value:n.value.minagg,"onUpdate:value":u[3]||(u[3]=f=>n.value.minagg=f),min:0,placeholder:"最小聚合次数"},null,8,["value"]),D(" — "),e(c,{value:n.value.maxagg,"onUpdate:value":u[4]||(u[4]=f=>n.value.maxagg=f),min:0,placeholder:"最大聚合次数"},null,8,["value"])]),_:1})]),_:1}),e(_,{span:"24 m:4",class:"pr-24px"},{default:l(()=>[e(h,{class:"w-full"},{default:l(()=>[e(I,{onClick:P},{icon:l(()=>[e(A,{class:"text-icon"})]),default:l(()=>[D(" "+B(s(v)("common.reset")),1)]),_:1}),e(I,{type:"primary",ghost:"",onClick:o},{icon:l(()=>[e(L,{class:"text-icon"})]),default:l(()=>[D(" "+B(s(v)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Ge=V({name:"OperateDrawer",__name:"operate-drawer",props:O({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:O(["submitted"],["update:visible"]),setup(y,{emit:$}){const i=y,w=$,b=E({eventsTypeDataList:[]}),n=J(y,"visible"),{formRef:T,validate:R,restoreValidation:N}=Z();me();const P=de(()=>({add:"新增聚合策略",edit:"修改聚合策略"})[i.operateType]),o=E(p());function p(){return{etid:null,mrules:null,maxtime:86400,maxagg:2e4,forward:null,sysparam:0}}const u={etid:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},mrules:{type:"array",required:!0,trigger:["blur","change"],message:"不能为空"},maxtime:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},maxagg:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"}};async function x(){const{data:t,error:a}=await Ae();a||(b.eventsTypeDataList=t,_())}async function _(){const{data:t,error:a}=await Ie();a||b.eventsTypeDataList.forEach(r=>{r.children=t.filter(d=>d.pid===r.id)})}const c=E({data:[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}]}),{pageData:h,getData:A,nextPage:I}=Ce(ze),L=async t=>{const a=t.currentTarget;a.scrollTop+a.offsetHeight>=a.scrollHeight&&h.data.length<h.total&&I()};function j(){x(),A(),Object.assign(o,p()),i.operateType==="edit"&&i.rowData&&(i.rowData.mrules=i.rowData.mrules?i.rowData.mrules.split(",").map(Number):[],i.rowData.forward=i.rowData.forward?i.rowData.forward.split(",").map(Number):[],Object.assign(o,i.rowData))}function k(){n.value=!1}async function C(){var t,a,r,d,S,m;if(await R(),i.operateType==="add"){const{data:z,error:U}=await Ue([{etid:o.etid,mrules:(t=o.mrules)==null?void 0:t.join(","),maxtime:o.maxtime,maxagg:o.maxagg,forward:(a=o.forward)==null?void 0:a.join(",")}]);U||((r=window.$message)==null||r.success(v("common.addSuccess")),k(),w("submitted"))}else{const{data:z,error:U}=await $e([{id:i.rowData.id,etid:o.etid,mrules:(d=o.mrules)==null?void 0:d.join(","),maxtime:o.maxtime,maxagg:o.maxagg,forward:(S=o.forward)==null?void 0:S.join(",")}]);U||((m=window.$message)==null||m.success(v("common.updateSuccess")),k(),w("submitted"))}}const f=t=>t.ipaddr+":"+t.fport+" ("+(t.ftype==0?"syslog":"SNMP Trap")+")";return pe(n,()=>{n.value&&(j(),N())}),(t,a)=>{const r=Le,d=ce,S=fe,m=Y,z=je,U=ee,le=Fe,ne=ae,K=M,oe=ge,se=_e;return q(),Q(se,{show:n.value,"onUpdate:show":a[6]||(a[6]=g=>n.value=g),"display-directive":"show",width:450},{default:l(()=>[e(oe,{title:P.value,"native-scrollbar":!1,closable:""},{footer:l(()=>[e(U,{size:16},{default:l(()=>[e(K,{onClick:k},{default:l(()=>[D(B(s(v)("common.cancel")),1)]),_:1}),e(K,{type:"primary",onClick:C},{default:l(()=>[D(B(s(v)("common.confirm")),1)]),_:1})]),_:1})]),default:l(()=>[e(ne,{ref_key:"formRef",ref:T,model:o,rules:u},{default:l(()=>[e(d,{label:"策略名称",path:"etid"},{default:l(()=>[e(r,{value:o.etid,"onUpdate:value":a[0]||(a[0]=g=>o.etid=g),clearable:"","check-strategy":"child",placeholder:"请选择策略名称",options:b.eventsTypeDataList,"show-path":!1,filterable:"","value-field":"id","label-field":"pname"},null,8,["value","options"])]),_:1}),e(d,{label:"匹配规则",path:"mrules"},{default:l(()=>[e(S,{"max-tag-count":2,value:o.mrules,"onUpdate:value":a[1]||(a[1]=g=>o.mrules=g),multiple:"",placeholder:"请选择匹配规则",clearable:"",filterable:"",options:c.data,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),e(d,{label:"最大限定时间",path:"maxtime"},{default:l(()=>[e(m,{value:o.maxtime,"onUpdate:value":a[2]||(a[2]=g=>o.maxtime=g),clearable:"",min:0,placeholder:"请输入最大限定时间(秒)",style:{width:"100%"}},null,8,["value"])]),_:1}),e(d,{label:"最大聚合次数",path:"maxagg"},{default:l(()=>[e(m,{value:o.maxagg,"onUpdate:value":a[3]||(a[3]=g=>o.maxagg=g),clearable:"",min:0,placeholder:"请输入最大聚合次数",style:{width:"100%"}},null,8,["value"])]),_:1}),e(d,{label:"转发类型",path:"forward"},{default:l(()=>[e(S,{"max-tag-count":1,value:o.forward,"onUpdate:value":a[4]||(a[4]=g=>o.forward=g),multiple:"",placeholder:"请选择转发类型",clearable:"","render-label":f,filterable:"","value-field":"id","label-field":"ipaddr",options:s(h).data,"reset-menu-on-options-change":!1,onScroll:L},null,8,["value","options"])]),_:1}),e(d,{label:"是否是系统参数"},{default:l(()=>[e(le,{value:o.sysparam,"onUpdate:value":a[5]||(a[5]=g=>o.sysparam=g),name:"radiogroup"},{default:l(()=>[e(U,null,{default:l(()=>[e(z,{value:0},{default:l(()=>[D("是")]),_:1}),e(z,{value:1},{default:l(()=>[D("否")]),_:1})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),Oe={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function G(y){return typeof y=="function"||Object.prototype.toString.call(y)==="[object Object]"&&!be(y)}const da=V({name:"eventalarm_aggregatepolicy",__name:"index",setup(y){const $=ve(),{columns:i,columnChecks:w,data:b,getData:n,loading:T,mobilePagination:R,searchParams:N,resetSearchParams:P}=xe({apiFn:Re,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,mintime:null,maxtime:null,minagg:null,maxagg:null,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48,fixed:"left"},{key:"pname",title:"策略名称",align:"center",width:160,ellipsis:{tooltip:!0}},{key:"maxtime",title:"最大限定时间(秒)",align:"center",width:180},{key:"maxagg",title:"最大聚合次数",align:"center",width:180},{key:"mrules",title:"匹配规则",align:"center",width:160,render:t=>{const a=t.matchingRulesPojos.length>0?t.matchingRulesPojos.map(r=>r.mname).join(", "):"";return e("div",null,[e("span",null,[a])])}},{key:"sysparam",title:"系统参数",align:"center",width:240,render:t=>{t.sysparam==null&&(t.sysparam=0);const a={0:"success",1:"error"},r=v(ye[t.sysparam]);return e(he,{size:"small",type:a[t.sysparam]},G(r)?r:{default:()=>[r]})}},{key:"operate",title:v("common.operate"),align:"center",width:160,fixed:"right",render:t=>{let a;return t.sysparam!=0&&e("div",{class:"flex-center gap-8px"},[H(e(M,{type:"info",ghost:!0,size:"small",onClick:()=>j(t.id)},G(a=v("common.edit"))?a:{default:()=>[a]}),[[W("no-auth"),"aggregate.policy.update"]]),e(Me,{onPositiveClick:()=>k(t.id)},{default:()=>v("common.confirmDelete"),trigger:()=>{let r;return H(e(M,{type:"error",ghost:!0,size:"small"},G(r=v("common.delete"))?r:{default:()=>[r]}),[[W("no-auth"),"aggregate.policy.delete"]])}})])}}]}),{drawerVisible:o,operateType:p,editingData:u,handleAdd:x,handleEdit:_,checkedRowKeys:c,onBatchDeleted:h,onDeleted:A,closeDrawer:I}=De(b,n);async function L(){console.log(c.value),C(c.value,t=>{h()})}function j(t){_(t)}function k(t){console.log(t),C([t],a=>{A()})}async function C(t,a){const{data:r,error:d}=await Pe(t);if(!d)a&&a(r);else return!1}async function f(){}return(t,a)=>{const r=re,d=Be,S=te;return q(),we("div",Oe,[e(Ee,{model:s(N),"onUpdate:model":a[0]||(a[0]=m=>F(N)?N.value=m:null),onReset:s(P),onSearch:s(n)},null,8,["model","onReset","onSearch"]),e(S,{title:"聚合策略",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":l(()=>[e(r,{columns:s(w),"onUpdate:columns":a[1]||(a[1]=m=>F(w)?w.value=m:null),"disabled-delete":s(c).length===0,loading:s(T),onAdd:s(x),onDelete:L,onRefresh:s(n),"is-view-export-button":!0,onExportHandler:f,"is-view-add-button":s(X)("aggregate.policy.insert"),"is-view-delete-button":s(X)("aggregate.policy.delete")},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","is-view-delete-button"])]),default:l(()=>[e(d,{"checked-row-keys":s(c),"onUpdate:checkedRowKeys":a[2]||(a[2]=m=>F(c)?c.value=m:null),columns:s(i),data:s(b),size:"small","flex-height":!s($).isMobile,"scroll-x":s(i).reduce((m,z)=>m+z.width,0),loading:s(T),remote:"","row-key":m=>m.id,pagination:s(R),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),e(Ge,{visible:s(o),"onUpdate:visible":a[3]||(a[3]=m=>F(o)?o.value=m:null),"operate-type":s(p),"row-data":s(u),onSubmitted:s(n)},null,8,["visible","operate-type","row-data","onSubmitted"])]),_:1})])}}});export{da as default};
