import{_ as Z}from"./table-column-setting.vue_vue_type_script_setup_true_lang-CaE2L_JR.js";import{_ as ee}from"./round-search-Dxiz62Oh.js";import{d as te,bp as ae,g as r,aK as S,aN as ne,aV as P,v as le,af as se,j as f,aq as oe,aX as O,aY as R,E as U,az as W,a7 as ce,o as ie,e as re,w as u,h as L,i as s,aj as de,A as ue,B as pe,ab as _e,f as j,K as me,z as he,bq as fe,t as ge,am as B,ag as ye,I as ve,ao as ke,L as be,ah as we,a2 as xe,P as Se}from"./index-ByQsQpYG.js";import{u as Te,a as $e}from"./table-CQrIFVLV.js";import{a as De,p as Ne}from"./gather-B7_KJv1S.js";import{_ as ze}from"./InputGroupLabel-Ca7DOQhJ.js";import{_ as qe}from"./Tree-1LWg9QBk.js";import{_ as Ce}from"./DataTable-BmHddFa8.js";import{_ as Ie}from"./Split-dXUwIDG1.js";import"./RadioGroup-DngHp1Rz.js";import"./Forward-L7FBmiBZ.js";const Pe={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Le={class:"flex flex-col"},Ae=te({name:"configsetting_realtimedata_devicedata",__name:"index",setup(Ee){const{columns:V,columnChecks:T,data:b,getData:g,loading:A,mobilePagination:F,searchParams:_,resetSearchParams:Ke}=Te({apiFn:ae,apiParams:{page:1,pageSize:200,limit:200,tagType:null,chlid:null,devId:null,fuzzy:"",chlType:0,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",align:"center",width:48},{key:"id",title:"序号",align:"center",width:80},{key:"devId",title:"设备名称",align:"center",width:100,render:e=>{var t;return r("span",null,[(t=E.value.find(a=>a.id==e.devId))==null?void 0:t.devName])}},{key:"tagName",title:"测点名称",align:"center"},{key:"tagDesc",title:"物模型标识(测点描述)",align:"center"},{key:"value",title:"测点值",align:"center",width:140,render:e=>{var t;return S("span",{style:{color:e.quality===100?"red":e.quality==49?"#409eff":e.quality==50?"#909399":"#67c23a"}},parseFloat((t=e.value)==null?void 0:t.toFixed(6))||e.value)}},{key:"quality",title:"质量",align:"center",width:120,render:e=>(e.quality==100||e.quality==49||e.quality==0)&&S(ne,{style:{background:e.quality===100?"red":e.quality==49?"#409eff":"#67c23a",color:"#fff"}},e.quality==0?"Good":e.quality==49?"人工置数":e.quality==100?"Bad":"")},{key:"dbtime",title:"采集时间",align:"center",minWidth:120,render:e=>{var t,a;return S("span",{title:P(0,+e.dbtime)},e.dbtime?(a=P(2,+e.dbtime))==null?void 0:a.substring(10,(t=P(2,+e.dbtime))==null?void 0:t.length):"")}},{key:"tagType",title:"测点类型",align:"center",width:140,render:e=>r("span",null,[De[e.tagType]])},{key:"objAddr",title:"地址",align:"center",width:140}]}),J=e=>{e===""&&g()};le(async()=>{await M(),z(),G()}),se(()=>{var e;(e=$.value)==null||e.close(),w.value.close()});const h=f(),E=f([]),M=async()=>{const{data:e,error:t}=await oe();if((e==null?void 0:e.length)==0)return;function a(n){return n.map(o=>{var c;return{label:o.chlName,key:o.id,dev_status:null,children:(c=o.devicePojoList)!=null&&c.length?o.devicePojoList.map(l=>(E.value.push(l),{label:l.devName,dev_status:null,chlType:o.chlType,key:l.id})):[]}})}h.value=a(e),_.chlid=h.value[0].key,_.devId=h.value[0].children[0].key,q.value=[h.value[0].children[0].key],x.value=h.value[0].children[0].label,g()},$=f(null),G=()=>{var o;(o=$.value)==null||o.close();const e=new O;let t="";e.appendAsciiStr("$Link+Qi^123987WWg#getchlstatus"),t=e.end();const a=new Date().getTime(),n=new R(U.replace("https","wss")+`/ChannelStatusWebsocket/getchlstatus/${t}/${a}?token=${W()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});$.value=n,n.connect(),n.onclose(()=>{}),n.onerror(()=>{}),n.onopen(()=>{}),n.onmessage(c=>{let l=[];console.log(c,"通道状态websocket接受数据"),K(c.data)&&(l=JSON.parse(c.data).data,h.value.forEach(i=>{l.forEach(d=>{var y;d.chl_id==i.key&&(i.dev_status=d.chl_status),d.chl_id==1&&(i.dev_status=1),(y=i.children)==null||y.forEach(v=>{var k;(k=d.devs)==null||k.forEach(m=>{m.dev_id==v.key&&(v.dev_status=m.dev_status),m.dev_id==1&&(v.dev_status=1)})})})}))})},w=f(null),D=f(""),N=f(!0),z=()=>{var o;(o=w.value)==null||o.close(),N.value=!0;const e=new O;let t="";const a=new Date().getTime();e.appendAsciiStr("$Link+Qi^123987WWg#"+a),t=e.end();const n=new R(U.replace("https","wss")+`/realTimeDataWebsocket/${x.value}/${t}/${a}?token=${W()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});w.value=n,n.connect(),n.onclose(()=>{}),n.onerror(()=>{}),n.onopen(()=>{}),n.onmessage(c=>{let l=[];console.log(c,"实时数据websocket接受数据"),K(c.data)&&(l=JSON.parse(c.data).data[x.value],l==null||l.forEach(i=>{b.value.forEach(d=>{i.i==d.id&&(d.quality=i.q,d.value=i.v,d.dbtime=i.t)})}),D.value=X())})},q=f([]),x=f(""),Q=async(e,t,a)=>{var c,l,i,d,y;q.value=[(c=a.node)==null?void 0:c.key],_.chlType=(l=a.node)==null?void 0:l.chlType;function n(v,k){for(const m of v)if(m.children){for(const I of m.children)if(I.key===k)return m.key}return null}const o=await n(h.value,(i=a.node)==null?void 0:i.key);_.chlid=o,_.devId=(d=a.node)==null?void 0:d.key,x.value=(y=a.node)==null?void 0:y.label,g(),z()},Y=e=>{e&&b.value.length>0?z():w.value.close()};ce(()=>_.tagType,e=>{e||g()});const H=({option:e})=>e.key==0?"":e.dev_status!==null?S("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:e.hasOwnProperty("dev_status")&&e.dev_status==1?"#00b42a":e.dev_status==2?"#ff0000":"#ccc"}}):"",X=e=>{const t=new Date,a=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),c=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0");return`${a}-${n}-${o} ${c}:${l}:${i}`},{drawerVisible:Oe,operateType:Re,editingData:Ue,handleAdd:We,handleEdit:je,checkedRowKeys:C,onBatchDeleted:Be,onDeleted:Ve}=$e(b,g),K=e=>{try{return JSON.parse(e),!0}catch{return!1}};return(e,t)=>{const a=ze,n=ye,o=ve,c=ee,l=ke,i=be,d=Z,y=qe,v=we,k=Ce,m=Ie,I=xe;return ie(),re("div",Pe,[r(I,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:u(()=>[r(i,{align:"center",wrap:"",justify:"start",class:"lt-sm:w-200px"},{default:u(()=>[r(l,null,{default:u(()=>[r(a,null,{default:u(()=>[L("测点类型")]),_:1}),r(n,{filterable:"",clearable:"",placeholder:"请选择",value:s(_).tagType,"onUpdate:value":t[0]||(t[0]=p=>s(_).tagType=p),options:s(de)(s(Ne))},null,8,["value","options"]),r(o,{clearable:"",value:s(_).fuzzy,"onUpdate:value":[t[1]||(t[1]=p=>s(_).fuzzy=p),J],placeholder:"请输入测点名称或描述",style:{width:"150%"},onKeyup:ue(s(g),["enter"])},null,8,["value","onKeyup"]),r(s(pe),{type:"primary",ghost:"",onClick:s(g)},{icon:u(()=>[r(c,{class:_e(["text-icon",{"animate-spin":s(A)}])},null,8,["class"])]),default:u(()=>[L(" 搜索 ")]),_:1},8,["onClick"])]),_:1}),j("div",Le,[r(s(me),{checked:N.value,"onUpdate:checked":[t[2]||(t[2]=p=>N.value=p),Y]},{default:u(()=>[L(" 实时刷新 ")]),_:1},8,["checked"]),he(j("span",{class:"font-size-14px color-blank",style:{"font-weight":"600"}}," 刷新时间："+ge(D.value),513),[[fe,D.value]])])]),_:1})]),"header-extra":u(()=>[r(i,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:u(()=>[r(d,{columns:s(T),"onUpdate:columns":t[3]||(t[3]=p=>B(T)?T.value=p:null)},null,8,["columns"])]),_:1})]),default:u(()=>[r(m,{direction:"horizontal",class:"sm:h-full","default-size":.15,max:.35,min:.1,"resize-trigger-size":6},{1:u(()=>[r(v,{style:{"max-height":"700px"}},{default:u(()=>[r(y,{"block-line":"","default-expand-all":"",data:h.value,"checked-keys":q.value,"expand-on-click":!1,"render-prefix":H,"check-strategy":"child","onUpdate:checkedKeys":Q,checkable:""},null,8,["data","checked-keys"])]),_:1})]),2:u(()=>[r(k,{"checked-row-keys":s(C),"onUpdate:checkedRowKeys":t[4]||(t[4]=p=>B(C)?C.value=p:null),columns:s(V),data:s(b),size:"small",loading:s(A),remote:"","row-key":p=>p.id,"flex-height":!0,"scroll-x":"",pagination:s(b).length?s(F):void 0,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1})])}}}),at=Se(Ae,[["__scopeId","data-v-eb7f3c79"]]);export{at as default};
