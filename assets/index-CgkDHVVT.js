import{_ as da,a as ca,V as Ia,b as Ma,c as Oa,d as qa,e as Ra,f as Ha,g as Ga}from"./index-DWXzUyRF.js";import{_ as pa}from"./round-plus-4VT9CDB-.js";import{aU as pe,R as fa,b as q,o as $,e as M,d as _t,z as kt,s as h,F as yt,ax as nt,c as ke,G as W,f as s,I as st,t as se,w as c,g as j,h as L,B as U,az as ot,a4 as xt,M as ga,N as zt,H as re,aB as Ot,J as Ve,ay as ht,$ as ae,aA as Ja,n as a,aG as Ze,el as Ka,W as va,av as vt,A as Jt,a as Kt,at as Wt,au as Yt,aH as Ee,K as ia,a5 as gt,aR as Je,cy as ma,b4 as ya,aC as et,be as ha,cZ as ba,cQ as _a,fb as ka,cC as Wa,aQ as sa,i as xa,aS as Ya,eo as Qa,D as dt,bn as Xa,S as Za,fc as el,aI as tl,X as al,Y as ll,ew as nl,d0 as il,cE as oa,dO as sl,d8 as Ut,a2 as ol,aY as ra,b0 as rl,aK as ul,a7 as qt,dP as dl,a3 as cl}from"./index-DdfiWQes.js";import{u as Ke}from"./usePageData-CaNzzdLX.js";import{h as Xe}from"./permission-DiluPVG9.js";import{N as ct}from"./Popconfirm-DY3Dc_PH.js";import{_ as bt}from"./DatePicker-BTmZbyaH.js";import{N as Rt}from"./Cascader-D9fiH8GH.js";import{_ as pl,a as fl,A as gl}from"./index-CwoCeOZa.js";import{g as vl}from"./business-CSjuRrZJ.js";import{_ as ml}from"./Grid-CPKP2Pfd.js";import{_ as yl}from"./FormItemGridItem-DIoGuRnG.js";function Wn(w){return pe({url:"/projectForm/getPage.do",method:"get",params:w})}function hl(w){return pe({url:"/projectForm/insert.do",method:"post",data:w})}function bl(w){return pe({url:"/projectForm/update.do",method:"put",data:w})}function Yn(w){return pe({url:"/projectForm/delete.do",method:"delete",params:{arrIds:w}})}function _l(w){return pe({url:"/projectForm/getById.do",method:"get",params:{id:w}})}function kl(w){return pe({url:"/projectForm/getIdByProId.do",method:"get",params:{proId:w}})}function xl(w){return pe({url:"/projectForm/getProjectPage.do",method:"get",params:w})}function Ht(w){return pe({url:"/projectFormContact/getPage.do",method:"get",params:w})}function Ll(w){return pe({url:"/projectFormContact/insert.do",method:"post",data:w})}function Sl(w){return pe({url:"/projectFormContact/update.do",method:"put",data:w})}function Dl(w){return pe({url:"/projectFormContact/delete.do",method:"delete",params:{arrIds:w}})}function Gt(w){return pe({url:"/projectFormEquipment/getPage.do",method:"get",params:w})}function La(w){return pe({url:"/projectFormEquipment/insert.do",method:"post",data:w})}function Cl(w){return pe({url:"/projectFormEquipment/update.do",method:"put",data:w})}function wl(w){return console.log(w),pe({url:"/projectFormEquipment/delete.do",method:"delete",params:{arrIds:w}})}function Fl(w){return pe({url:"/projectFormDebug/getPage.do",method:"get",params:w})}function Sa(w){return pe({url:"/projectFormDebug/insert.do",method:"post",data:w})}function $l(w){return pe({url:"/projectFormDebug/update.do",method:"put",data:w})}function Tl(w){return pe({url:"/projectFormDebug/delete.do",method:"delete",params:{arrIds:w}})}function Ul(w){return pe({url:"/projectFormFile/getPage.do",method:"get",params:w})}function zl(w){return pe({url:"/projectFormFile/insert.do",method:"post",data:w})}function jl(w){return pe({url:"/projectFormFile/update.do",method:"put",data:w})}function Pl(w){return pe({url:"/projectFormFile/delete.do",method:"delete",params:{arrIds:w}})}const Bl={class:"inline-block",viewBox:"0 0 24 24",width:"1em",height:"1em"};function Nl(w,Ue){return $(),q("svg",Bl,Ue[0]||(Ue[0]=[M("path",{fill:"currentColor",d:"M21 7v14H3V3h14zm-2 .85L16.15 5H5v14h14zM12 18q1.25 0 2.125-.875T15 15t-.875-2.125T12 12t-2.125.875T9 15t.875 2.125T12 18m-6-8h9V6H6zM5 7.85V19V5z"},null,-1)]))}const El=fa({name:"material-symbols-save-outline-sharp",render:Nl}),Vl={class:"inline-block",viewBox:"0 0 14 14",width:"1em",height:"1em"};function Al(w,Ue){return $(),q("svg",Vl,Ue[0]||(Ue[0]=[M("path",{fill:"currentColor","fill-rule":"evenodd",d:"M6.545.998a1 1 0 0 0 0 2h2.728a2.638 2.638 0 0 1 0 5.275H4.817V6.545a1 1 0 0 0-1.707-.707L.384 8.564a1 1 0 0 0-.22 1.09q.073.18.218.327l2.728 2.728a1 1 0 0 0 1.707-.707v-1.729h4.456a4.638 4.638 0 1 0 0-9.275z","clip-rule":"evenodd"},null,-1)]))}const Il=fa({name:"streamline-return2-solid",render:Al}),Ml={class:"flex items-center justify-between"},Ol={class:"flex items-center"},ql={style:{margin:"10px 0","font-weight":"bolder",width:"140px"}},Rl={key:0,class:"font-size-12px c-#ffa502 ml-10px"},Hl={key:0},Gl={style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},Jl={key:0},Kl={style:{display:"flex","justify-content":"space-between"}},Wl={key:3},Yl=["src"],Ql=_t({__name:"fileList",props:{pid:{},data:{},fileType:{},typename:{},operateType:{}},emits:["getData","myClick","submittedData","removeData"],setup(w,{emit:Ue}){const le=w,Y=kt(),Ce=Ue,y=[{title:"文件别名",key:"name",align:"center",width:200,ellipsis:{tooltip:!0}},{title:"文件名称",key:"filename",align:"center",width:200,ellipsis:{tooltip:!0}},{title:"上传人",key:"creator",align:"center",width:100},{title:"上传时间",key:"dbtime",align:"center",width:200},{title:"操作",key:"actions",align:"center",width:180,render(r,p){return a(Ve,{justify:"center"},[r.id&&a(U,{type:"info",size:"small",ghost:!0,onClick:()=>{tt(r)}},{default:()=>"查看"}),r.id&&a(U,{type:"info",size:"small",ghost:!0,onClick:()=>{He(r)}},{default:()=>"下载"}),r.id&&Xe("project:form:File:update")&&a(U,{type:"info",size:"small",ghost:!0,onClick:()=>{A(r)}},{default:()=>"编辑"}),Xe("project:form:File:delete")&&Y.userInfo.usertype==0&&a(ct,{onPositiveClick:async()=>{var f;if(r.id){const{data:D,error:l}=await Ka(r.url),{data:u,error:g}=await Pl(r.id);g||((f=window.$message)==null||f.success("删除成功"),Ce("getData"))}else Ce("removeData",{index:p,fileType:le.fileType})}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(U,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})])}}];async function Fe(r){return!0}const Q=h(!1),N=h(null),te=h({fileName:"",file:null,id:void 0}),Oe={fileName:[{required:!0,message:"请输入文件别名",trigger:["blur","change"]}]},v=h(0),We=()=>{Ce("myClick"),R.value=[],Q.value=!0,v.value=0,te.value.id=void 0,te.value.fileName="",te.value.file=null},qe=async()=>{var r,p,f,D;try{if(await((r=N.value)==null?void 0:r.validate()),te.value.id){const{data:l,error:u}=await jl([{id:te.value.id,filename:te.value.fileName}]);if(u)return(p=window.$message)==null?void 0:p.error("保存文件记录失败");(f=window.$message)==null||f.destroyAll(),(D=window.$message)==null||D.success("编辑成功"),Ce("getData"),xe.value=!1;return}}catch{xe.value=!1}};async function He(r){if(r!=null&&r.url)try{const f=await(await fetch(r.url,{mode:"cors"})).blob(),D=URL.createObjectURL(f),l=document.createElement("a");l.href=D,l.download=r.filename,l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(D)}catch(p){console.error("下载失败:",p)}}const Ge=()=>{console.log("渲染完成")},he=r=>{console.log(r,"渲染失败")},d=h(!1),ue=h(""),X=h([]),J=h(""),Ae=h("预览文件"),be=h(!1),$e=h(0),tt=r=>{var f,D;if(!(r!=null&&r.url))return;const p=(f=r.filename.split(".").pop())==null?void 0:f.toLowerCase();if(ue.value=r.url,Ae.value=r.filename,["xls","xlsx"].includes(p))J.value="xls";else if(["doc","docx"].includes(p))J.value="doc";else if(["pdf"].includes(p))J.value="pdf";else if(["png","jpg","jpeg","gif","bmp"].includes(p)){J.value="img",X.value=le.data.map(u=>{var g;return["png","jpg","jpeg","gif","bmp"].includes((g=u.filename.split(".").pop())==null?void 0:g.toLowerCase())?u.url:""}).filter(u=>u!=="");const l=X.value.findIndex(u=>u===r.url);$e.value=l,be.value=!0;return}else if(["mp4"].includes(p))J.value="mp4";else{(D=window.$message)==null||D.warning("暂不支持该文件类型预览");return}d.value=!0},Te=h(45),we=()=>{Te.value==45?Te.value=350:Te.value=45},xe=h(!1);function A(r){te.value.id=r.id,te.value.fileName=r.name,xe.value=!0}const ze=()=>{xe.value=!1};function Ie(r){return r.replace(/\.[^/.]+$/,"")}const ye=[{title:"文件名称",key:"filename",align:"center",render(r){if(!r.name){const p=async({file:D,onFinish:l,onError:u})=>{var g,F;try{r.status=!0;const S=await Ze(D.file,D.name,"",z=>{r.progress=z});S&&(r.url=S,r.name=D.name,r.status=!1)}catch(S){console.error(S),(F=(g=window.$message)==null?void 0:g.error)==null||F.call(g,"文件上传出错"),r.status=!1}};async function f(D){return!0}return a("div",{style:"display: flex; justify-content: center; align-items: center;"},[a(ht,{action:"#",showFileList:!1,customRequest:p,onBeforeUpload:f},{default:()=>a(U,{type:"info",size:"small",ghost:!0,loading:r.status},{default:()=>"上传文件"})}),r.progress?a(Ot,{type:"line",percentage:r.progress,indicatorPlacement:"inside",processing:!0}):null])}return a("div",{},r.name)}},{title:"文件别名",key:"filename",align:"center",render(r){return a(re,{value:r.filename??Ie(r.name)??"",onUpdateValue:p=>{r.filename=p}})}},{title:"操作",key:"actions",align:"center",width:100,render(r){return a(Ve,{justify:"center"},[a(U,{type:"error",size:"small",ghost:!0,onClick:()=>{R.value=R.value.filter(p=>p!==r)}},{default:()=>"删除"})])}}],R=h([]),me=h(0),Pe=h(!1),n=async()=>{var r,p,f,D,l,u,g,F;for(let S=0;S<R.value.length;S++){const z=R.value[S];if(!z.name||z.name.toString().trim()===""){(r=window.$message)==null||r.warning(`第 ${S+1} 个文件的文件名称不能为空`);return}if(!z.filename||z.filename.toString().trim()===""){(p=window.$message)==null||p.warning(`第 ${S+1} 个文件的文件别名不能为空`);return}}try{if(Pe.value=!0,le.operateType==="edit"){const S=R.value.length;for(let V=0;V<S;V++){me.value=V;const H=R.value[V];H.indexText=`${V+1}/${S}`,H.progress=0,H.status="uploading";try{H.url=await Ze(H.file,H.name,"",fe=>{H.progress=fe}),H.progress=100,H.status="done"}catch{H.status="error",(D=(f=window.$message)==null?void 0:f.error)==null||D.call(f,`第 ${V+1} 个文件上传失败，请重试`);return}}const z=R.value.map(V=>({file:V.url,filename:V.filename,pid:le.pid,sort:le.fileType})),{error:x}=await zl(z);if(x){(u=(l=window.$message)==null?void 0:l.error)==null||u.call(l,"保存文件记录失败");return}Ce("getData"),(g=window.$message)==null||g.destroyAll(),(F=window.$message)==null||F.success("上传成功"),Q.value=!1}else{const S=R.value.map(z=>({file:z.file,filename:z.name,name:z.filename,sort:le.fileType}));Ce("submittedData",{row:S,fileType:le.fileType}),Q.value=!1}}finally{Pe.value=!1}},m=()=>{Q.value=!1};function _(r){r.fileList.forEach(p=>{p.filename||(p.filename=Ie(p.name))}),R.value=r.fileList}return(r,p)=>{const f=pa,D=da,l=ca,u=zt,g=ga,F=xt,S=Ja,z=yt("no-auth");return $(),q(nt,null,[M("div",Ml,[M("div",Ol,[M("h2",ql,se(le.typename),1),st(($(),ke(L(U),{size:"small",ghost:"",type:"primary",onClick:We},{icon:c(()=>[s(f,{class:"text-icon"})]),default:c(()=>[j(" 新增"+se(le.typename),1)]),_:1})),[[z,"project:form:File:insert"]]),le.fileType==4?($(),q("span",Rl,"照片数不少于6张")):W("",!0)]),le.data.length>0?($(),q("div",Hl,"共"+se(le.data.length)+"条",1)):W("",!0)]),le.data.length>0?($(),ke(L(ot),{key:0,columns:y,data:le.data,size:"small","scroll-x":702,"row-key":x=>x.id,"max-height":Te.value},null,8,["data","row-key","max-height"])):W("",!0),M("div",Gl,[Te.value==45&&le.data.length>1?($(),q("span",{key:0,onClick:we},[p[7]||(p[7]=j(" 更多 ")),s(D,{class:"font-size-20px"})])):W("",!0),Te.value==350&&le.data.length>1?($(),q("span",{key:1,onClick:we},[p[8]||(p[8]=j(" 收起 ")),s(l,{class:"font-size-20px"})])):W("",!0)]),s(F,{show:xe.value,"onUpdate:show":p[1]||(p[1]=x=>xe.value=x),title:(te.value.id?"编辑":"新增")+le.typename,preset:"card",class:"w-700px"},{default:c(()=>[s(g,{ref_key:"formRef",ref:N,model:te.value,rules:Oe,"label-width":"auto",style:{width:"100%"}},{default:c(()=>[s(u,{label:"文件别名",path:"fileName"},{default:c(()=>[s(L(re),{value:te.value.fileName,"onUpdate:value":p[0]||(p[0]=x=>te.value.fileName=x),placeholder:"请输入"},null,8,["value"])]),_:1}),v.value?($(),ke(L(Ot),{key:0,type:"line",percentage:v.value,color:v.value==100?"#18a058":"#2080f0","indicator-placement":"inside",processing:""},null,8,["percentage","color"])):W("",!0),s(u,null,{default:c(()=>[s(L(Ve),{justify:"center",style:{width:"100%"}},{default:c(()=>[s(L(U),{type:"primary",onClick:qe},{default:c(()=>p[9]||(p[9]=[j(se("确认"))])),_:1,__:[9]}),s(L(U),{onClick:ze},{default:c(()=>p[10]||(p[10]=[j("取消")])),_:1,__:[10]})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),s(F,{show:Q.value,"onUpdate:show":p[3]||(p[3]=x=>Q.value=x),title:(te.value.id?"编辑":"新增")+le.typename,preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{footer:c(()=>[s(L(Ve),{justify:"end"},{default:c(()=>[s(L(U),{size:"small",class:"mt-16px",onClick:m},{default:c(()=>[j(se(L(ae)("common.cancel")),1)]),_:1}),s(L(U),{type:"primary",size:"small",class:"mt-16px",onClick:n},{default:c(()=>[j(se(L(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:c(()=>[s(L(ht),{ref:"uploadRef",action:void 0,class:"mb-10px","file-list":R.value,"onUpdate:fileList":p[2]||(p[2]=x=>R.value=x),"auto-upload":!1,onBeforeUpload:Fe,multiple:!0,onChange:_,"show-file-list":!1},{default:c(()=>[s(L(U),{size:"small",ghost:"",type:"primary"},{default:c(()=>p[11]||(p[11]=[j("选择文件")])),_:1,__:[11]})]),_:1},8,["file-list"]),s(L(ot),{columns:ye,"paginate-single-page":!1,data:R.value,"max-height":350},null,8,["data"]),R.value[me.value]&&Pe.value?($(),q("div",Jl,[M("div",Kl,[M("span",null,se(R.value[me.value].filename||R.value[me.value].name),1),M("span",null,se(R.value[me.value].indexText),1)]),s(L(Ot),{percentage:R.value[me.value].progress,status:R.value[me.value].status==="error"?"error":"success","show-indicator":""},null,8,["percentage","status"])])):W("",!0)]),_:1},8,["show","title"]),s(F,{show:d.value,"onUpdate:show":p[4]||(p[4]=x=>d.value=x),title:Ae.value,preset:"card",style:{width:"80%"}},{default:c(()=>[J.value.includes("xls")?($(),ke(L(Ia),{key:0,options:{xls:!0,minColLength:0,minRowLength:0,widthOffset:20,heightOffset:5},src:ue.value,style:{height:"80vh"},onRendered:Ge,onError:he},null,8,["src"])):W("",!0),J.value.includes("doc")?($(),ke(L(Ma),{key:1,src:ue.value,style:{height:"80vh"},onRendered:Ge,onError:he},null,8,["src"])):W("",!0),J.value.includes("pdf")?($(),ke(L(Oa),{key:2,src:ue.value,style:{height:"80vh"},onRendered:Ge,onError:he},null,8,["src"])):W("",!0),J.value.includes("mp4")?($(),q("div",Wl,[M("video",{src:ue.value,controls:"",style:{width:"100%",height:"80vh"}},null,8,Yl)])):W("",!0)]),_:1},8,["show","title"]),s(S,{show:be.value,"onUpdate:show":p[5]||(p[5]=x=>be.value=x),"src-list":X.value,current:$e.value,"onUpdate:current":p[6]||(p[6]=x=>$e.value=x)},null,8,["show","src-list","current"])],64)}}}),ua=va(Ql,[["__scopeId","data-v-6a4ac387"]]),Xl=_t({name:"businessModal",__name:"businessModal",props:vt({pid:{},operateType:{},debuggedDevieceList:{},contactList:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:vt(["submitted","submittedData"],["update:visible"]),setup(w,{emit:Ue}){const le=Ue;kt();const Y=w;async function Ce(){N(),Ge(),X(),Te(),A.value=[],xe.value=!0,we.value=!0,ye.value=[]}Jt();const y=Kt(()=>"新增待调试业务"),Fe=Wt(w,"visible");Yt(Fe,()=>{Fe.value&&Ce()});const{pageData:Q,getData:N,nextPage:te}=Ke(ma),Oe=async l=>{const u=l.currentTarget;u.scrollTop+u.offsetHeight>=u.scrollHeight&&Q.data.length<Q.total&&te()},{pageData:v,getData:We,nextPage:qe}=Ke(Ht),He=async l=>{const u=l.currentTarget;u.scrollTop+u.offsetHeight>=u.scrollHeight&&v.data.length<v.total&&(qe(),v.data=v.data.map(g=>({...g,value:g.docker+"&id="+g.id})))},Ge=async()=>{await We({pid:Y.pid}),v.data=v.data.map(l=>({...l,value:l.docker+"&id="+l.id}))},{pageData:he,getData:d,nextPage:ue}=Ke(ya),X=async()=>{await d({usertypes:"2,3"})},J=async l=>{const u=l.currentTarget;u.scrollTop+u.offsetHeight>=u.scrollHeight&&he.data.length<he.total&&ue()},{pageData:Ae,getData:be,nextPage:$e}=Ke(Gt),tt=async l=>{const u=l.currentTarget,g=u.scrollTop;u.scrollTop+u.offsetHeight>=u.scrollHeight&&Q.data.length<Q.total&&(await $e(),await et(),setTimeout(()=>{u.scrollTop=g}))},Te=async()=>{Y.pid&&await be({pid:Y.pid})},we=h(!0),xe=h(!0),A=h([]),ze=[{title:"权重",key:"dtype",width:180,align:"center",render(l,u){return l.setStatus?a(Ee,{value:l.dtype,filterable:!0,placeholder:"请选择权重",options:Q.data,labelField:"tname",valueField:"id",onUpdateValue(g){var F;A.value[u].dtype=Number(g)||0,A.value[u].debugname=((F=Q.data.find(S=>S.id==g))==null?void 0:F.tname)||""},onScroll(g){Oe(g)}}):a("div",{},l.tname)}},{title:"业务名称",key:"debugname",width:180,align:"center",render(l,u){return l.setStatus?a(re,{value:l.debugname,placeholder:"请输入业务名称",onUpdateValue(g){A.value[u].debugname=g}}):a("div",{},l.debugname)}},{key:"eqmname",title:"调试设备",align:"center",width:150,render(l,u){return a(Ee,{value:l.eqmid,placeholder:"请选择调试设备",options:Y.operateType=="edit"?Ae.data:Y.debuggedDevieceList,onscroll:tt,labelField:"devname",valueField:Y.operateType=="edit"?"id":"eqmid",clearable:!0,filterable:!0,onUpdateValue(g){A.value[u].eqmid=g}})}},{key:"dbcreater",width:140,align:"center",title:()=>a("div",{style:"display:flex;align-items:center;justify-content:center;gap:6px;"},[a("span",null,"调试人"),a(ia,{size:"small",checked:xe.value,label:"联动",style:"margin-left: 10px;font-size: 12px;",onUpdateChecked:l=>{xe.value=l}})]),render(l,u){return l.setStatus?a(Ee,{value:l.dbcreater,filterable:!0,placeholder:"请选择调试人",options:he.data,labelField:"username",valueField:"id",onUpdateValue(g){xe.value?A.value.forEach((F,S)=>{F.dbcreater=g||0}):A.value[u].dbcreater=g||0},onScroll(g){J(g)}}):a("div",{},l.dbusername)}},{key:"docker",width:140,align:"center",title:()=>a("div",{style:"display:flex;align-items:center;justify-content:center;gap:6px;"},[a("span",null,"对接方"),a(ia,{size:"small",checked:we.value,label:"联动",style:"margin-left: 10px;font-size: 12px;",onUpdateChecked:l=>{we.value=l}})]),render(l,u){var g;return l.setStatus?a(Ee,{value:l.docker,placeholder:"请输入或选择对接方",options:Y.operateType=="edit"?v.data:Y.contactList,onscroll:He,labelField:"docker",valueField:Y.operateType=="edit"?"value":"docker",clearable:!0,filterable:!0,tag:!0,onClear(){l.dockcharge="",l.dockcontact=""},onUpdateValue(F){var S;if(we.value)A.value.forEach((z,x)=>{var H;z.docker=F;let V={};if(Y.operateType=="edit"){const[fe,oe]=(H=l.docker)==null?void 0:H.split("&id=");V=v.data.find(ne=>ne.docker===fe&&ne.id===Number(oe))}else V=Y.contactList.find(fe=>fe.docker==z.docker);console.log(Y.contactList,z.docker,"sss"),V?(z.dockcharge=V.pname,z.dockcontact=V.pcontact):(z.dockcharge="",z.dockcontact="")});else{A.value[u].docker=F;let z={};if(Y.operateType=="edit"){const[x,V]=(S=l.docker)==null?void 0:S.split("&id=");z=v.data.find(H=>H.docker===x&&H.id===Number(V))}else z=Y.contactList.find(x=>x.docker==F);z?(l.dockcharge=z.pname,l.dockcontact=z.pcontact):(l.dockcharge="",l.dockcontact="")}}}):a("div",{},(g=l.docker)==null?void 0:g.split("&id=")[0])}},{title:"对接方负责人",key:"dockcharge",width:100,align:"center",render(l,u){return l.setStatus?a(re,{value:l.dockcharge,placeholder:"请输入对接方负责人",onUpdateValue(g){A.value[u].dockcharge=g}}):a("div",{},l.dockcharge)}},{title:"联系方式",key:"dockcontact",width:120,align:"center",render(l,u){return l.setStatus?a(re,{value:l.dockcontact,placeholder:"请输入联系方式",onUpdateValue(g){A.value[u].dockcontact=g}}):a("div",{},l.dockcontact)}},{title:"文件",key:"re1",width:100,align:"center",render(l,u){return l.setStatus?a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>_(l,u)},{default:()=>"上传文件"}):a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const g=[{alias:l.re1,file:l.fl1},{alias:l.re2,file:l.fl2},{alias:l.re3,file:l.fl3},{alias:l.re4,file:l.fl4}].filter(F=>F.alias||F.file);return g.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件")])]),a("tbody",g.map(F=>{var S;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},F.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((S=F.file)==null?void 0:S.split("?")[1])||"-")])}))])])}})}},{title:"备注",key:"notes",width:200,align:"center",render(l,u){return l.setStatus?a(re,{value:l.notes,placeholder:"请输入备注",onUpdateValue(g){A.value[u].notes=g}}):a("div",{},l.notes)}},{title:"计划开始时间",key:"starttime",width:200,align:"center",render(l,u){return l.setStatus?a(bt,{type:"date",clearable:!0,value:l.starttime,valueFormat:"yyyy-MM-dd",placeholder:"请选择",onUpdateValue(g){A.value[u].starttime=g}}):a("div",Je(0,l.starttime))}},{title:"计划结束时间",key:"endtime",width:200,align:"center",render:(l,u)=>l.setStatus?a(bt,{type:"date",clearable:!0,valueFormat:"yyyy-MM-dd",value:l.endtime,placeholder:"请选择",onUpdateValue(g){A.value[u].endtime=g}}):Je(0,l.endtime)},{key:"operate",title:ae("common.operate"),align:"center",width:120,fixed:"right",render(l,u){return a("div",{class:"flex-center gap-8px"},[a(ct,{onPositiveClick:()=>{A.value.splice(u,1),ye.value.splice(u,1)}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(U,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})])}}];function Ie(){Fe.value=!1}const ye=h([]),R=l=>{A.value=[],l.forEach(u=>{var g;A.value.push({debugname:(g=Q.data.find(F=>F.id==u))==null?void 0:g.tname,docker:void 0,dockcharge:"",dockcontact:"",debugresult:0,status:0,notes:"",dbcreater:void 0,dtype:u,setStatus:!0,pid:Y.pid,starttime:null,endtime:null})})},me=h(!1);async function Pe(){var g,F,S,z,x,V,H,fe;const l=["dtype","debugname","docker"],u=A.value.findIndex(oe=>l.some(ne=>!oe[ne]||oe[ne].toString().trim()===""));if(u!==-1){(F=(g=window.$message)==null?void 0:g.error)==null||F.call(g,`第 ${u+1} 行请完整填写必填项（权重、业务名称、对接方）`);return}try{if(me.value=!0,Y.operateType==="edit")for(const ne of A.value){if(!Array.isArray(ne.fileList)||ne.fileList.length===0)continue;const Me=ne.fileList.filter(Le=>(Le==null?void 0:Le.file)&&typeof Le.file=="object"),ge=Me.length;for(let Le=0;Le<ge;Le++){const b=Me[Le];b.indexText=`${Le+1}/${ge}`,b.progress=0,b.status="uploading";try{b.url=await Ze(b.file.file,b.file.name,""),b.progress=100,b.status="done"}catch{b.status="error",(z=(S=window.$message)==null?void 0:S.error)==null||z.call(S,"文件上传失败，请重试");return}}ne.fileList.forEach((Le,b)=>{const k=`re${b+1}`,B=`fl${b+1}`;ne[k]=Le.status==="done"&&Le.name||"",ne[B]=Le.status==="done"&&Le.url||""}),delete ne.fileList}const oe=A.value.map(ne=>{var Me;return{...ne,starttime:Je(0,ne.starttime),endtime:Je(0,ne.endtime),docker:(Me=ne.docker)==null?void 0:Me.split("&id=")[0]}});if(Y.operateType==="edit"){const{error:ne}=await Sa(oe);ne||((V=(x=window.$message)==null?void 0:x.success)==null||V.call(x,"添加成功"),Ie(),le("submitted"))}else le("submittedData",oe)}catch(oe){console.error(oe),(fe=(H=window.$message)==null?void 0:H.error)==null||fe.call(H,"提交失败，请稍后重试")}finally{me.value=!1}}const n=h(!1),m=h(),_=(l,u)=>{n.value=!0,m.value=u,l.fileList&&l.fileList.length>0?p.value=l.fileList:p.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]},r=[{title:"",key:"",align:"center",width:80,render(l,u){return`附件${u+1}`}},{title:"文件名称",key:"filename",align:"center",render(l){var F;const u=async({file:S,onFinish:z,onError:x})=>{var V,H;try{l.name=S.name,l.file=S}catch(fe){console.error(fe),(H=(V=window.$message)==null?void 0:V.error)==null||H.call(V,"文件上传出错")}};async function g(S){return!0}return a("div",{style:"display:flex;justify-content:center;align-items:center;"},[l.file||l.url?a("span",{},[a("span",{},((F=l.file)==null?void 0:F.name)||l.url.split("?")[1]||""),a("span",{style:"color:red;cursor:pointer;font-size:12px;margin-left:8px;",onClick:()=>{l.url="",l.file=null}},"删除")]):a(ht,{action:"#",showFileList:!1,customRequest:u,onBeforeUpload:g},{default:()=>a(U,{type:"info",size:"small",ghost:!0,loading:l.status},{default:()=>"上传文件"})})])}},{title:"文件别名",key:"name",align:"center",render(l){return a(re,{value:l.name,clearable:!0,onUpdateValue:u=>{l.name=u}})}}],p=h([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]),f=async()=>{var u,g;let l=!0;if(p.value.forEach((F,S)=>{var V,H;const z=F.name||"",x=((V=F.url)==null?void 0:V.split("?")[1])||((H=F.file)==null?void 0:H.name);(z&&!x||!z&&x)&&(l=!1)}),!l){(g=(u=window.$message)==null?void 0:u.error)==null||g.call(u,"文件名称和文件地址必须同时存在，不能只填一个");return}A.value[m.value].fileList=p.value,l&&(n.value=!1,m.value=void 0)},D=()=>{n.value=!1};return(l,u)=>{const g=zt,F=ot,S=xt,z=yt("loading");return $(),q(nt,null,[s(S,{show:Fe.value,"onUpdate:show":u[1]||(u[1]=x=>Fe.value=x),title:y.value,preset:"card",class:"w-80% h-70vh","mask-closable":!1,draggable:!0},{footer:c(()=>[s(L(Ve),{justify:"end",size:16},{default:c(()=>[s(L(U),{onClick:Ie},{default:c(()=>[j(se(L(ae)("common.cancel")),1)]),_:1}),s(L(U),{type:"primary",onClick:Pe},{default:c(()=>[j(se(L(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:c(()=>[s(g,{label:"权重","label-placement":"left"},{default:c(()=>[s(L(Ee),{filterable:"",multiple:"",value:ye.value,"onUpdate:value":[u[0]||(u[0]=x=>ye.value=x),R],tag:"",style:{width:"300px"},placeholder:"请选择权重","label-field":"tname","value-field":"id",options:L(Q).data,onScroll:Oe},null,8,["value","options"])]),_:1}),st(s(F,{style:{width:"100%"},columns:ze,data:A.value,size:"small","row-key":x=>x.id,striped:"","scroll-x":ze.reduce((x,V)=>x+V.width,0),"max-height":350},null,8,["data","row-key","scroll-x"]),[[z,me.value]])]),_:1},8,["show","title"]),s(S,{show:n.value,"onUpdate:show":u[2]||(u[2]=x=>n.value=x),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:c(()=>u[3]||(u[3]=[j(" 待调试业务文件列表 ")])),footer:c(()=>[s(L(Ve),{justify:"end"},{default:c(()=>[s(L(U),{size:"small",class:"mt-16px",onClick:D},{default:c(()=>[j(se(L(ae)("common.cancel")),1)]),_:1}),s(L(U),{type:"primary",size:"small",class:"mt-16px",onClick:f},{default:c(()=>[j(se(L(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:c(()=>[s(F,{columns:r,"paginate-single-page":!1,data:p.value,"max-height":350},null,8,["data"])]),_:1},8,["show"])],64)}}}),Zl=_t({name:"deviceModal",__name:"deviceModal",props:vt({pid:{},proid:{},operateType:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:vt(["submitted","submittedData"],["update:visible"]),setup(w,{emit:Ue}){const le=Ue;kt();const Y=w;async function Ce(){Q(),ue.value=[],X.value=[]}const y=Wt(w,"visible");Yt(y,()=>{y.value&&Ce()});const Fe=h([]),Q=async()=>{var _,r;const{data:n,error:m}=await ba({page:1,limit:100,id:Y.proid});if(n){if(Fe.value=n==null?void 0:n.list.map(p=>({value:p.id,label:p.contractname,isLeaf:!1})),Fe.value.length==0)return(_=window.$message)==null?void 0:_.error("该项目没有绑定合同！");qe((r=n==null?void 0:n.list[0])==null?void 0:r.id)}},N=h([]),te=h(),{pageData:Oe,getData:v,nextPage:We}=Ke(_a),qe=async n=>{await v({pids:n}),te.value=[],N.value=Array.from(new Set([...N.value,...Oe.data])),te.value=Oe.data.map(m=>({label:m.devname,value:m.id}))},He=async n=>{var m;await qe(n.value),n.children=(m=te.value)==null?void 0:m.map(_=>({label:_.label,value:_.value,isLeaf:!0})),await et(),setTimeout(()=>{const _=document.querySelectorAll(".n-cascader-submenu-wrapper .n-scrollbar");console.log(_[1]),_[1]&&(_[1].removeEventListener("scroll",xe),_[1].addEventListener("scroll",xe))},2e3)};function Ge(n,m){const _=n.filter(p=>!m.includes(p)),r=m.filter(p=>!n.includes(p));return{toDelete:_,toAdd:r}}const he=h([]),d=async n=>{const{toDelete:m,toAdd:_}=Ge(he.value,n);m.forEach(r=>{const p=X.value.findIndex(f=>f.cid==r);p!=-1&&X.value.splice(p,1)}),_.forEach(async r=>{var p,f,D,l,u,g,F,S,z,x,V,H,fe,oe,ne,Me;X.value.push({devname:((f=(p=N.value)==null?void 0:p.find(ge=>ge.id==r))==null?void 0:f.devname)||"",devmodel:((l=(D=N.value)==null?void 0:D.find(ge=>ge.id==r))==null?void 0:l.devmodel)||"",devnum:((g=(u=N.value)==null?void 0:u.find(ge=>ge.id==r))==null?void 0:g.devcount)||0,devmanu:((S=(F=N.value)==null?void 0:F.find(ge=>ge.id==r))==null?void 0:S.devmanu)||"",etype:((x=(z=N.value)==null?void 0:z.find(ge=>ge.id==r))==null?void 0:x.etype)||0,status:0,devunit:((H=(V=N.value)==null?void 0:V.find(ge=>ge.id==r))==null?void 0:H.devunit)||"",notes:((oe=(fe=N.value)==null?void 0:fe.find(ge=>ge.id==r))==null?void 0:oe.notes)||"",setStatus:!0,cid:r,pid:Y.pid,install:1,connectionmode:"",devstatus:2,manucontact:"",manuinfo:"",devnumber:((Me=(ne=N.value)==null?void 0:ne.find(ge=>ge.id==r))==null?void 0:Me.devcount)||0})}),he.value=n},ue=h([]),X=h([]),J=[{title:"绑定合同设备",key:"cid",width:300,align:"center",render(n,m){var _,r;return n.setStatus?a(Rt,{style:"width: 270px",value:n.cid,filterable:!0,placeholder:"请选择合同设备",options:Fe.value,checkStrategy:"child",showPath:!1,remote:!0,onLoad:He,onUpdateValue(p){var D;X.value[m].cid=Number(p)||0;const f=(D=N.value)==null?void 0:D.find(l=>l.id==p);n.devname=(f==null?void 0:f.devname)||"",n.devnum=(f==null?void 0:f.devcount)||"",n.notes=(f==null?void 0:f.notes)||"",n.devnumber=(f==null?void 0:f.devcount)||0,n.etype=(f==null?void 0:f.devtype)||0,n.devmanu=(f==null?void 0:f.devmanu)||"",n.devmodel=((f==null?void 0:f.devmodel.length)>64?f==null?void 0:f.devname:f==null?void 0:f.devmodel)||"",n.devunit=(f==null?void 0:f.devunit)||""}}):a("div",{},n.devname2||((r=(_=te.value)==null?void 0:_.find(p=>p.value==n.cid))==null?void 0:r.label))}},{title:"设备名称",key:"devname",width:200,align:"center",render(n,m){return n.setStatus?a(re,{value:n.devname,placeholder:"请输入",onUpdateValue(_){X.value[m].devname=_}}):a("div",{},n.devname)}},{title:"型号",key:"devmodel",width:220,align:"center",render(n,m){return a("div",{},n.devmodel)}},{title:"设备单位",key:"devunit",width:120,align:"center",render(n,m){return a("div",{},n.devunit)}},{title:"数量",key:"devnum",width:100,align:"center",render(n,m){return n.setStatus?a(ha,{value:n.devnum,placeholder:"请输入",max:n.devnumber,onUpdateValue(_){X.value[m].devnum=_}}):a("div",{},n.devnum)}},{title:"是否为我司设备",key:"etype",width:260,align:"center",render(n,m){return a("div",{},n.etype==0?"是":"否")}},{title:"设备厂家",key:"devmanu",width:100,align:"center",render(n,m){return a("div",{},n.devmanu)}},{title:"厂家联系人",key:"manucontact",width:100,align:"center",render(n,m){return n.setStatus?a(re,{value:n.manucontact,placeholder:"请输入",onUpdateValue(_){X.value[m].manucontact=_}}):a("div",{},n.manucontact)}},{title:"厂家联系方式",key:"manuinfo",width:100,align:"center",render(n,m){return n.setStatus?a(re,{value:n.manuinfo,placeholder:"请输入",onUpdateValue(_){X.value[m].manuinfo=_}}):a("div",{},n.manuinfo)}},{title:"设备状态",key:"devstatus",width:120,align:"center",render(n,m){return n.setStatus&&n.id?a(Ee,{value:n.devstatus,filterable:!0,placeholder:"请选择",options:[{label:"设备无异常",value:0},{label:"异常",value:1},{label:"未知",value:2}],onUpdateValue(_){X.value[m].devstatus=Number(_)||0}}):a("div",{},n.devstatus===0?"设备无异常":n.devstatus===1?"异常":"未知")}},{title:"接线方式",key:"connectionmode",width:100,align:"center",render(n,m){return n.setStatus?a(re,{value:n.connectionmode,placeholder:"请输入",onUpdateValue(_){X.value[m].connectionmode=_}}):a("div",{},n.connectionmode)}},{title:"是否安装就位",key:"install",width:120,align:"center",render(n,m){return n.setStatus&&n.id?a(Ee,{value:n.install,filterable:!0,placeholder:"请选择",options:[{label:"是",value:0},{label:"否",value:1}],onUpdateValue(_){X.value[m].install=Number(_)||0}}):a("div",{},n.install===0?"是":"否")}},{title:"备注",key:"notes",width:200,align:"center",render(n,m){return a("div",{},n.notes)}},{title:"文件",key:"re1",width:160,align:"center",render(n,m){return n.setStatus?a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>Ie(n,m)},{default:()=>"上传文件"}):a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const _=[{alias:n.re1,file:n.fl1},{alias:n.re2,file:n.fl2},{alias:n.re3,file:n.fl3},{alias:n.re4,file:n.fl4}].filter(r=>r.alias||r.file);return _.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件")])]),a("tbody",_.map(r=>{var p;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},r.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((p=r.file)==null?void 0:p.split("?")[1])||"-")])}))])])}})}},{title:"操作信息",key:"dbtime",width:180,align:"center",render(n,m){return a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},n.dbtime?Je(1,n.dbtime):""),default:()=>a("div",{style:"padding: 10px;"},s("div",null,[s("div",null,[j("操作人："),n.username]),s("div",null,[j("操作时间："),n.dbtime]),s("div",null,[j("清点人："),n.dusername]),s("div",null,[j("清点时间："),n.ddbtime])]))})}},{key:"operate",title:ae("common.operate"),align:"center",width:180,fixed:"right",render(n,m){return a("div",{class:"flex-center gap-8px"},[a(ct,{onPositiveClick:()=>{n.id||(X.value.splice(m,1),ue.value.splice(m,1))}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(U,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})])}}];function Ae(){y.value=!1}const be=h(!1);async function $e(){var _,r,p,f,D,l,u,g;const n=["cid","devname","devnum"],m=X.value.findIndex(F=>n.some(S=>!F[S]||F[S].toString().trim()===""));if(m!==-1){(r=(_=window.$message)==null?void 0:_.error)==null||r.call(_,`第 ${m+1} 行请完整填写必填项（合同设备、设备名称、数量）`);return}try{if(be.value=!0,Y.operateType==="edit")for(const S of X.value){if(!Array.isArray(S.fileList)||S.fileList.length===0)continue;const z=S.fileList.filter(x=>(x==null?void 0:x.file)&&typeof x.file=="object");for(const x of z){x.status="uploading";try{x.url=await Ze(x.file.file,x.file.name,""),x.status="done"}catch{x.status="error",(f=(p=window.$message)==null?void 0:p.error)==null||f.call(p,"文件上传失败，请重试");return}}S.fileList.forEach((x,V)=>{const H=`re${V+1}`,fe=`fl${V+1}`;S[H]=x.status==="done"&&x.name||"",S[fe]=x.status==="done"&&x.url||""}),delete S.fileList}const F=X.value.map(S=>({...S,eqmid:ka()}));if(Y.operateType==="edit"){const{error:S}=await La(F);S||((l=(D=window.$message)==null?void 0:D.success)==null||l.call(D,"添加成功"),Ae(),le("submitted"))}else le("submittedData",F)}catch(F){console.error(F),(g=(u=window.$message)==null?void 0:u.error)==null||g.call(u,"提交失败，请稍后重试")}finally{be.value=!1}}const tt=async n=>{},Te=h(!1),we=h(!0),xe=async n=>{console.log(n);const m=n.target;m.scrollHeight-m.scrollTop-m.clientHeight<10&&!Te.value&&we.value&&(Te.value=!0,We(),te.value=Oe.data.map(r=>({label:r.devname,value:r.id})),Te.value=!1)},A=h(!1),ze=h(),Ie=(n,m)=>{A.value=!0,ze.value=m,n.fileList&&n.fileList.length>0?R.value=n.fileList:R.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]},ye=[{title:"",key:"",align:"center",width:80,render(n,m){return`附件${m+1}`}},{title:"文件名称",key:"filename",align:"center",render(n){var r;const m=async({file:p,onFinish:f,onError:D})=>{var l,u;try{n.name=p.name,n.file=p}catch(g){console.error(g),(u=(l=window.$message)==null?void 0:l.error)==null||u.call(l,"文件上传出错")}};async function _(p){return!0}return a("div",{style:"display:flex;justify-content:center;align-items:center;"},[n.file||n.url?a("span",{},[a("span",{},((r=n.file)==null?void 0:r.name)||n.url.split("?")[1]||""),a("span",{style:"color:red;cursor:pointer;font-size:12px;margin-left:8px;",onClick:()=>{n.url="",n.file=null}},"删除")]):a(ht,{action:"#",showFileList:!1,customRequest:m,onBeforeUpload:_},{default:()=>a(U,{type:"info",size:"small",ghost:!0,loading:n.status},{default:()=>"上传文件"})})])}},{title:"文件别名",key:"name",align:"center",render(n){return a(re,{value:n.name,clearable:!0,onUpdateValue:m=>{n.name=m}})}}],R=h([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]),me=async()=>{var m,_;let n=!0;if(R.value.forEach((r,p)=>{var l,u;const f=r.name||"",D=((l=r.url)==null?void 0:l.split("?")[1])||((u=r.file)==null?void 0:u.name);(f&&!D||!f&&D)&&(n=!1)}),!n){(_=(m=window.$message)==null?void 0:m.error)==null||_.call(m,"文件名称和文件地址必须同时存在，不能只填一个");return}X.value[ze.value].fileList=R.value,n&&(A.value=!1,ze.value=void 0)},Pe=()=>{A.value=!1};return(n,m)=>{const _=zt,r=ot,p=xt,f=yt("loading");return $(),q(nt,null,[s(p,{show:y.value,"onUpdate:show":m[1]||(m[1]=D=>y.value=D),title:"新增待调试设备",preset:"card",class:"w-80% h-70vh","mask-closable":!1,draggable:!0},{footer:c(()=>[s(L(Ve),{justify:"end",size:16},{default:c(()=>[s(L(U),{onClick:Ae},{default:c(()=>[j(se(L(ae)("common.cancel")),1)]),_:1}),s(L(U),{type:"primary",onClick:$e},{default:c(()=>[j(se(L(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:c(()=>[s(_,{label:"合同设备","label-placement":"left"},{default:c(()=>[s(L(Rt),{value:ue.value,"onUpdate:value":[m[0]||(m[0]=D=>ue.value=D),d],placeholder:"请选择合同设备",options:Fe.value,"check-strategy":"child","show-path":!1,labelKey:"label",remote:"",multiple:"",style:{width:"300px"},"on-load":He,"onUpdate:show":tt},null,8,["value","options"])]),_:1}),st(s(r,{style:{width:"100%"},columns:J,data:X.value,size:"small","row-key":D=>D.id,striped:"","scroll-x":J.reduce((D,l)=>D+l.width,0),"max-height":350},null,8,["data","row-key","scroll-x"]),[[f,be.value]])]),_:1},8,["show"]),s(p,{show:A.value,"onUpdate:show":m[2]||(m[2]=D=>A.value=D),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:c(()=>m[3]||(m[3]=[j(" 待调试设备文件列表 ")])),footer:c(()=>[s(L(Ve),{justify:"end"},{default:c(()=>[s(L(U),{size:"small",class:"mt-16px",onClick:Pe},{default:c(()=>[j(se(L(ae)("common.cancel")),1)]),_:1}),s(L(U),{type:"primary",size:"small",class:"mt-16px",onClick:me},{default:c(()=>[j(se(L(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:c(()=>[s(r,{columns:ye,"paginate-single-page":!1,data:R.value,"max-height":350},null,8,["data"])]),_:1},8,["show"])],64)}}}),en={class:"w-100%"},tn={class:"flex"},an={class:"flex-col w-100%"},ln=2,nn=_t({__name:"prjDetail",props:vt({operateType:{}},{prjInfo:{default:()=>({id:void 0,proname:void 0,proaddr:"",prosite:"",longitude:120.373885,latitude:30.303899,proid:null,dtype:null,dispatch:"",status:0,plantime:null,region:null,provice:null})},prjInfoModifiers:{}}),emits:vt(["submit","changePrj"],["update:prjInfo"]),setup(w,{expose:Ue,emit:le}){const Y=kt(),Ce=w,y=Wt(w,"prjInfo"),Fe=le,Q=h([]),{pageData:N,getData:te,nextPage:Oe}=Ke(Y.userInfo.usertype==1?xl:Wa),v=async b=>{const k=b.currentTarget,B=k.scrollTop;k.scrollTop+k.offsetHeight>=k.scrollHeight&&N.data.length<N.total&&(await Oe(),Q.value=N.data,await et(),setTimeout(()=>{k.scrollTop=B}))},We=sa.debounce(async b=>{await te({page:1,fuzzy:b}),Q.value=N.data},300),qe=h(!1),He=h(!1),Ge=b=>{if(y.value.proid=null,qe.value=!0,He.value=!1,!b){d();return}We(b)},he=async()=>{qe.value&&!He.value&&(await te({page:1}),Q.value=N.data,qe.value=!1)},d=async()=>{await te({page:1}),Q.value=N.data},ue=async b=>{await J(b),X.value?y.value.proid=null:y.value.proid=b,Fe("changePrj")},X=h(!1),J=async b=>{var P;X.value=!1;const{data:k,error:B}=await kl(b);k&&(X.value=!0,(P=window.$message)==null||P.warning("该项目已存在调试单，请勿重复添加"))},Ae=h({id:void 0,proname:void 0,proaddr:"",prosite:"",longitude:120.373885,latitude:30.303899,proid:null,dtype:null,dispatch:"",status:0,plantime:null,region:null,provice:null});function be(b){return JSON.parse(JSON.stringify(el(b)))}Kt(()=>Ae.value?JSON.stringify(y.value)!==JSON.stringify(Ae.value):!1),xa(async()=>{await te({page:1}),Q.value=N.data,xe(),Ce.operateType=="edit"&&R(y.value.provice),et(()=>{Ae.value=be(y.value)})});const $e={status:{type:"number",required:!0,trigger:["blur","change"],message:"请选择提交状态"},dtype:{type:"number",required:!0,trigger:["blur","change"],message:"请选择调试类型"},proid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择项目"},prosite:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请输入项目地址"},proaddr:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请输入项目详细地址"},plantime:{type:"string",required:!0,trigger:["blur","change"],message:"请选择计划调试时间"},provice:{type:"number",required:!0,trigger:["blur","change"],message:"请选择省份"},region:{type:"number",required:!0,trigger:["blur","change"],message:"请选择城市"},dispatch:{type:"string",required:!0,trigger:["blur","change"],message:"请输入调度名称"}},{formRef:tt,validate:Te}=Jt(),we=h([]),xe=async()=>{const{data:b,error:k}=await Ya();b&&(we.value=b)},A=b=>{R(b),y.value.region=null,y.value.proaddr=""},ze=b=>{var B;const k=(B=ye.value.find(P=>P.id===b))==null?void 0:B.name;y.value.region&&y.value.prosite&&y.value.proaddr&&!m?(y.value.prosite="",y.value.proaddr=""):Ie(k)};function Ie(b){!b||!m||!n||m.getLocation(b,(k,B)=>{var P;if(k==="complete"&&((P=B.geocodes)!=null&&P.length)){const{location:Be,formattedAddress:Ye}=B.geocodes[0],rt=Be.lng,at=Be.lat;n.setZoomAndCenter(14,[rt,at]),D.longitude=rt,D.latitude=at,y.value.latitude=D.latitude,y.value.longitude=D.longitude,oe(f,{lng:rt,lat:at}),y.value.proaddr=Ye,y.value.prosite=Ye,g.value=Ye}})}const ye=h([]),R=async b=>{var P;if(!b)return(P=window.$message)==null?void 0:P.warning("请先选择省份");const{data:k,error:B}=await Qa({province:b});k&&(ye.value=k)},me=h(!1),Pe=h();let n=null,m=null,_=null,r=null,p=null,f=null;const D=dt({longitude:0,latitude:0});let l;const u=h(!1),g=h(""),F=h([]);let S=0;async function z(){try{if(window._AMapSecurityConfig={securityJsCode:Y.userInfo.sdksecret},!Pe.value)return;f=await gl.load({key:Y.userInfo.sdkkey,version:"2.0",plugins:["AMap.Scale","AMap.PlaceSearch","AMap.AutoComplete","AMap.Geocoder","AMap.Geolocation"]}),n=new f.Map(Pe.value,{zoom:18,center:[y.value.longitude,y.value.latitude],viewMode:"3D",resizeEnable:!0}),m=new f.Geocoder,r=new f.PlaceSearch({city:"全国",pageSize:50}),p=new f.AutoComplete({city:"全国"}),oe(f,{lng:y.value.longitude,lat:y.value.latitude}),n.on("click",b=>{const{lng:k,lat:B}=b.lnglat;l=2,D.latitude=B,D.longitude=k,oe(f,{lng:k,lat:B})}),S=0,et(()=>{window.dispatchEvent(new Event("resize"))})}catch(b){console.error("地图加载失败：",b),S<ln?(S++,console.warn(`地图加载失败，正在第 ${S} 次重试...`),setTimeout(()=>{z()},1500)):console.error("地图加载失败，已达到最大重试次数，停止重试")}}const x=sa.debounce(async b=>{if(!u.value||!b.trim()){F.value=[];return}p.search(b,(k,B)=>{var P;console.log(B,"result"),k=="complete"&&B.info=="OK"&&((P=B==null?void 0:B.tips)!=null&&P.length)?F.value=B.tips.map(Be=>({label:`${Be.name}（${Be.district||Be.address||"无详细地址"}）`,value:`${Be.location.lng}_${Be.location.lat}`,raw:Be})):F.value=[]})},300);Yt(g,b=>{x(b)});function V(b,k){if(console.log(b,k,"option"),!b)return;const[B,P]=b.split("_").map(Number);!B||!P||(n.setCenter([B,P]),l=1,oe(f,{lng:B,lat:P}),D.longitude=B,D.latitude=P)}function H(){me.value=!0,u.value=!1,l=void 0,et(async()=>{await z(),setTimeout(()=>{u.value=!0;const b=document.querySelector(".n-auto-complete input");b==null||b.blur(),y.value.region&&!y.value.prosite&&!y.value.prosite&&ze(y.value.region)},500)})}const fe=h({lng:0,lat:0});function oe(b,k){_&&n.remove(_),_=new b.Marker({position:[k.lng,k.lat],map:n}),n.add(_),m.getAddress(k,async(B,P)=>{B==="complete"&&P.regeocode&&(console.log("result",P),console.log("formattedAddress",P.regeocode.formattedAddress),k.latitude=k.lat,k.longitude=k.lng,fe.value=k,l==1?y.value.proaddr=P.regeocode.formattedAddress:l==2?(g.value=P.regeocode.formattedAddress,y.value.proaddr=P.regeocode.formattedAddress,y.value.provice=ne(y.value.proaddr,we.value),await R(y.value.provice),y.value.region=Me(y.value.proaddr,ye.value)):(g.value=y.value.prosite||P.regeocode.formattedAddress,y.value.proaddr=P.regeocode.formattedAddress,setTimeout(async()=>{y.value.provice=ne(g.value,we.value)||y.value.provice,y.value.provice&&await R(y.value.provice),y.value.region=Me(g.value,ye.value)},1300)))})}function ne(b,k){let B=null;for(const P of k)if(b.includes(P.name)){B=P.id;break}return B}function Me(b,k){let B=null;for(const P of k)if(b.includes(P.name)){B=P.id;break}return B}const ge=async()=>{y.value.latitude=D.latitude||fe.value.lat,y.value.longitude=D.longitude||fe.value.lng,y.value.prosite=g.value,me.value=!1};function Le(){me.value=!1}return Ue({validate:Te}),(b,k)=>{const B=Ee,P=yl,Be=bt,Ye=re,rt=pl,at=U,jt=Za,Pt=ml,Lt=ga,pt=zt,Se=Ve,St=fl,Qe=xt;return $(),q(nt,null,[s(Lt,{ref_key:"formRef",ref:tt,model:y.value,rules:$e,"label-placement":"left","label-width":"120"},{default:c(()=>[s(Pt,{responsive:"screen","item-responsive":"","x-gap":"15"},{default:c(()=>[s(P,{span:"24 s:12 m:9",label:"项目名称",path:"proid"},{default:c(()=>[s(B,{filterable:"",clearable:"",value:y.value.proid,"onUpdate:value":[k[0]||(k[0]=G=>y.value.proid=G),ue],placeholder:"请选择项目","label-field":"proname","value-field":"id",disabled:Ce.operateType=="edit",options:Q.value,onScroll:v,onClear:d,onSearch:Ge,onBlur:he},null,8,["value","disabled","options"])]),_:1}),s(P,{span:"24 s:12 m:5",label:"计划调试时间",path:"plantime"},{default:c(()=>[s(Be,{"formatted-value":y.value.plantime,"onUpdate:formattedValue":k[1]||(k[1]=G=>y.value.plantime=G),type:"date","value-format":"yyyy-MM-dd",style:{width:"100%"}},null,8,["formatted-value"])]),_:1}),s(P,{span:"24 s:12 m:5",label:"调试类型",path:"dtype"},{default:c(()=>[s(B,{filterable:"",value:y.value.dtype,"onUpdate:value":k[2]||(k[2]=G=>y.value.dtype=G),placeholder:"请选择调试类型",options:L(Xa)(L(vl))},null,8,["value","options"])]),_:1}),s(P,{span:"24 s:12 m:5",label:"提交状态",path:"status"},{default:c(()=>[s(B,{filterable:"",disabled:"",value:y.value.status,"onUpdate:value":k[3]||(k[3]=G=>y.value.status=G),placeholder:"请选择提交状态",options:[{label:"未提交",value:0},{label:"已提交",value:1}]},null,8,["value"])]),_:1}),s(P,{span:"24 s:12 m:8",label:"省份",path:"provice"},{default:c(()=>[s(B,{filterable:"",value:y.value.provice,"onUpdate:value":[k[4]||(k[4]=G=>y.value.provice=G),A],placeholder:"请选择省份","label-field":"name","value-field":"id",options:we.value},null,8,["value","options"])]),_:1}),s(P,{span:"24 s:12 m:8",label:"地区",path:"region"},{default:c(()=>[s(B,{filterable:"",value:y.value.region,"onUpdate:value":[k[5]||(k[5]=G=>y.value.region=G),ze],placeholder:"请选择地区","label-field":"name","value-field":"id",options:ye.value},null,8,["value","options"])]),_:1}),s(P,{span:"24 s:12 m:8",label:"调度名称",path:"dispatch"},{default:c(()=>[s(Ye,{clearable:"",value:y.value.dispatch,"onUpdate:value":k[6]||(k[6]=G=>y.value.dispatch=G),placeholder:"请输入调度名称"},null,8,["value"])]),_:1}),s(P,{span:"24 s:12 m:12",label:"项目默认地点",path:"prosite"},{default:c(()=>[M("div",en,[M("div",tn,[s(jt,{onClick:k[8]||(k[8]=G=>H())},{default:c(()=>[s(Ye,{value:y.value.prosite,"onUpdate:value":k[7]||(k[7]=G=>y.value.prosite=G),placeholder:"请选择项目地点"},null,8,["value"]),s(at,null,{icon:c(()=>[s(rt,{class:"text-icon"})]),_:1})]),_:1})])])]),_:1}),s(P,{span:"24 s:12 m:12",label:"项目详细地址",path:"proaddr"},{default:c(()=>[s(Ye,{type:"textarea",rows:1,clearable:"",value:y.value.proaddr,"onUpdate:value":k[9]||(k[9]=G=>y.value.proaddr=G),placeholder:"请输入项目详细地址"},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["model"]),s(Qe,{show:me.value,"onUpdate:show":k[14]||(k[14]=G=>me.value=G),title:"选择项目位置",preset:"card",class:"w-800px"},{footer:c(()=>[s(Se,{justify:"end",size:16},{default:c(()=>[s(at,{onClick:Le},{default:c(()=>[j(se(b.$t("common.cancel")),1)]),_:1}),s(at,{type:"primary",onClick:ge},{default:c(()=>[j(se(b.$t("common.confirm")),1)]),_:1})]),_:1})]),default:c(()=>[s(Se,null,{default:c(()=>[s(pt,{label:"省份",path:"provice","label-placement":"left","label-width":"70"},{default:c(()=>[s(B,{filterable:"",value:y.value.provice,"onUpdate:value":[k[10]||(k[10]=G=>y.value.provice=G),A],placeholder:"请选择省份","label-field":"name","value-field":"id",options:we.value},null,8,["value","options"])]),_:1}),s(pt,{label:"地区",path:"region","label-placement":"left","label-width":"70"},{default:c(()=>[s(B,{filterable:"",value:y.value.region,"onUpdate:value":[k[11]||(k[11]=G=>y.value.region=G),ze],placeholder:"请选择地区","label-field":"name","value-field":"id",options:ye.value},null,8,["value","options"])]),_:1})]),_:1}),u.value?($(),ke(pt,{key:0,label:"项目地址","label-placement":"left"},{default:c(()=>[M("div",an,[s(St,{value:g.value,"onUpdate:value":[k[12]||(k[12]=G=>g.value=G),L(x)],options:F.value,style:{"margin-bottom":"7px"},placeholder:"请输入地点关键字",clearable:"",onSelect:V},null,8,["value","options","onUpdate:value"]),s(Ye,{type:"textarea",rows:2,clearable:"",value:y.value.proaddr,"onUpdate:value":k[13]||(k[13]=G=>y.value.proaddr=G),placeholder:"请输入详细地址"},null,8,["value"])])]),_:1})):W("",!0),M("div",{ref_key:"domRef",ref:Pe,class:"h-full w-full",style:{width:"100%",height:"500px","margin-top":"10px"}},null,512)]),_:1},8,["show"])],64)}}}),sn={class:"flex justify-center items-center"},on={class:"font-size-22px font-bold"},rn={class:"position-absolute right-80px flex items-center gap-x-20px"},un={class:"flex-col-stretch"},dn={class:"timeline-wrapper"},cn={class:"timeline-layout"},pn={class:"timeline"},fn=["id"],gn={class:"timeline-icon"},vn=["onClick"],mn={class:"flex justify-between"},yn=["onClick"],hn={class:"timeline-rows"},bn={key:0,class:"timeline-content",style:{"padding-left":"80px",position:"relative"}},_n={class:"timeline-icon"},kn=["onClick"],xn=["onClick"],Ln=["id"],Sn={style:{display:"flex","align-items":"center",gap:"10px"}},Dn={key:0},Cn={key:1,style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},wn={style:{display:"flex","align-items":"center",gap:"10px"}},Fn={key:0},$n={key:1,style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},Tn={key:0,style:{height:"20px"}},Un={style:{display:"flex","align-items":"center",gap:"10px"}},zn={key:0},jn={key:1,style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},Pn={key:0,style:{height:"20px"}},Bn=_t({name:"projectmanagement_projectdebuggingformdetail",__name:"index",props:{operateType:{},rowData:{}},emits:["return","submit","returnandSub"],setup(w,{emit:Ue}){const le=kt(),Y=tl(),Ce=h(""),y=al(),Fe=ll(),Q=dt({debuggedBusinessList:[],developBusinessList:[],needsList:[]});Jt();const N=w,te=Ue,Oe=()=>{te("return")},v=dt(We());function We(){return{id:void 0,proname:void 0,proaddr:"",prosite:"",longitude:120.373885,latitude:30.303899,proid:null,dtype:null,dispatch:"",status:0,plantime:null,region:null,provice:null}}async function qe(){Object.assign(v,We()),H(),Le(),d.value={projectDetail:{},contactList:[],debuggedBusinessList:[],fileList:[],debuggedDevieceList:[]},N.operateType==="edit"&&N.rowData&&(Object.assign(v,N.rowData),await He(v.proid),ze(),Be()),ue(),setTimeout(()=>{Fe.replace({path:y.path,query:{}})},100)}const He=async e=>{if(!e){d.value={projectDetail:{},contactList:[],debuggedBusinessList:[],fileList:[],debuggedDevieceList:[]};return}it.value=!0;try{const t=await Promise.allSettled([Vt(v.id),Pt(),be(v.id),Qe(v.id),f(v.id)]);ue(),t.forEach((o,i)=>{o.status==="fulfilled"?console.log(`任务 ${i} 成功:`,o):console.warn(`任务 ${i} 失败:`,o.reason)})}catch(t){console.error("意料之外的错误:",t)}finally{it.value=!1}},Ge=async()=>{const{data:e,error:t}=await _l(v.id);t||Object.assign(v,e)},he=dt([{id:"phase1",title:"基本信息",show:!0,tables:[]},{id:"phase2",title:"实施信息",show:!0,tables:[]}]),d=h({projectDetail:{},contactList:[],fileList:[],debuggedDevieceList:[],debuggedBusinessList:[]}),ue=()=>{he[0].tables=[{id:1,name:"项目联系人",type:d.value.contactList.length>0?1:0},{id:2,name:"待调试设备",type:d.value.debuggedDevieceList.length>0?1:0},{id:3,name:"图纸",type:d.value.fileList.length>0?1:0}],he[1].tables=[{id:1,name:"待调试业务",type:d.value.debuggedBusinessList.length>0?1:0},{id:2,name:"文件",type:Ne.value.length>0||Ct.value.length>0||wt.value.length>0||Ft.value.length>0||$t.value.length>0?1:0}]},X=()=>{J.pageSize==1?J.pageSize=20:J.pageSize=1,be(v.id)},J=dt({page:1,pageSize:1,showSizePicker:!0,fuzzy:"",itemCount:0,pageSizes:[10,20],prefix:()=>`共 ${J.itemCount} 条`,onChange:e=>{J.page=e,be(v.id)},onUpdatePageSize:e=>{J.pageSize=e,J.page=1,be(v.id)}}),Ae=[{title:"对接方",key:"docker",align:"center",render(e,t){return e.setStatus?a(re,{value:e.docker,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].docker=o}}):a("div",{},e.docker)}},{title:"姓名",key:"pname",align:"center",render(e,t){return e.setStatus?a(re,{value:e.pname,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].pname=o}}):a("div",{},e.pname)}},{title:"联系方式",key:"pcontact",align:"center",render(e,t){return e.setStatus?a(re,{value:e.pcontact,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].pcontact=o}}):a("div",{},e.pcontact)}},{title:"备注",key:"proposition",align:"center",render(e,t){return e.setStatus?a(re,{value:e.proposition,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].proposition=o}}):a("div",{},e.proposition)}},{title:"操作人",key:"username",align:"center"},{title:"操作时间",key:"dbtime",align:"center",render:e=>e.dbtime?Je(1,e.dbtime):""},{key:"operate",title:ae("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return a("div",{class:"flex-center gap-8px"},[e.setStatus?[Xe("project:Form:Contact:insert")&&a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>we(e)},{default:()=>"保存"}),a(U,{type:"default",ghost:!0,size:"small",onClick:()=>Te(e,t)},{default:()=>"取消"}),Xe("project:Form:Contact:delete")&&a(ct,{onPositiveClick:async()=>{var o;if(e.id){const{data:i,error:T}=await Dl(e.id);i&&(d.value.contactList.splice(t,1),(o=window.$message)==null||o.success("删除成功"),be(v.id),v.status=0,ue())}else d.value.contactList.splice(t,1)}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(U,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})]:Xe("project:Form:Contact:update")&&a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>tt(e)},{default:()=>"编辑"})])}}],be=async e=>{if(!e)return;const{data:t}=await Ht({page:J.page,limit:J.pageSize,pid:e});d.value.contactList=t==null?void 0:t.list,console.log(t.list,"项目联系人"),J.itemCount=t==null?void 0:t.total,d.value.contactList.forEach(o=>{o.setStatus=!1}),Q.contactList=JSON.parse(JSON.stringify(d.value.contactList)),$e.value=!1},$e=h(!1),tt=e=>{d.value.contactList.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus,$e.value=!0},Te=(e,t)=>{e.setStatus=!e.setStatus,!e.id&&!$e.value?d.value.contactList.splice(t,1):e.id&&$e.value&&(d.value.contactList=JSON.parse(JSON.stringify(Q.contactList)))},we=async e=>{var t,o,i,T,C;if(!e.docker){(t=window.$message)==null||t.warning("请输入对接方");return}if(!e.pname){(o=window.$message)==null||o.warning("请输入联系人姓名");return}if(!e.pcontact){(i=window.$message)==null||i.warning("请输入联系方式");return}if(e.id){const{data:ce,error:K}=await Sl([e]);K||((T=window.$message)==null||T.success("修改成功"),be(v.id),v.status=0,e.setStatus=!e.setStatus)}else if(N.operateType=="edit"){const{data:ce,error:K}=await Ll([{...e,pid:v.id}]);K||((C=window.$message)==null||C.success("添加成功"),be(v.id),e.setStatus=!e.setStatus,v.status=0,ue())}else e.setStatus=!e.setStatus,$e.value=!1;Be()};function xe(){var e;Tt.value.includes("1")||Tt.value.push("1"),((e=d.value.contactList[0])!=null&&e.pname||d.value.contactList.length==0)&&(d.value.contactList.unshift({pname:"",pcontact:"",proposition:"",setStatus:!0}),$e.value=!1)}const A=h([]),ze=async()=>{var o;const{data:e,error:t}=await ba({page:1,limit:100,id:v.proid});A.value=e==null?void 0:e.list.map(i=>({value:i.id,label:i.contractname,isLeaf:!1})),Pe((o=e==null?void 0:e.list[0])==null?void 0:o.id)},Ie=h([]),ye=h(),{pageData:R,getData:me}=Ke(_a),Pe=async e=>{await me({pids:e}),ye.value=[],Ie.value=Array.from(new Set([...Ie.value,...R.data])),ye.value=R.data.map(t=>({label:t.devname,value:t.id}))},n=async e=>{var t;await Pe(e.value),e.children=(t=ye.value)==null?void 0:t.map(o=>({label:o.label,value:o.value,isLeaf:!0}))},m=()=>{_.pageSize==1?_.pageSize=20:_.pageSize=1,f(v.id)},_=dt({page:1,pageSize:1,itemCount:0,showSizePicker:!0,fuzzy:"",pageSizes:[10,20],prefix:()=>`共 ${_.itemCount} 条`,onChange:e=>{_.page=e,f(v.id)},onUpdatePageSize:e=>{_.pageSize=e,_.page=1,f(v.id)}}),r=h(),p=[{title:"绑定合同设备",key:"cid",width:220,align:"center",render(e,t){var o,i;return e.setStatus?a(Rt,{style:"width: 200px",value:e.cid,filterable:!0,placeholder:"请选择合同设备",options:A.value,checkStrategy:"child",showPath:!1,remote:!0,renderSuffix:T=>T.option.hidden?null:T.node,renderLabel:T=>T.hidden?null:T.label,onLoad:n,onUpdateValue(T){var ce;d.value.debuggedDevieceList[t].cid=Number(T)||0;const C=(ce=Ie.value)==null?void 0:ce.find(K=>K.id==T);e.devname=(C==null?void 0:C.devname)||"",e.devnum=(C==null?void 0:C.devcount)||"",e.notes=(C==null?void 0:C.notes)||"",r.value=(C==null?void 0:C.devcount)||0,e.etype=(C==null?void 0:C.devtype)||0,e.devmanu=(C==null?void 0:C.devmanu)||"",e.devmodel=((C==null?void 0:C.devmodel.length)>64?C==null?void 0:C.devname:C==null?void 0:C.devmodel)||"",e.devunit=(C==null?void 0:C.devunit)||""}}):a("div",{},e.devname2||((i=(o=ye.value)==null?void 0:o.find(T=>T.value==e.cid))==null?void 0:i.label))}},{title:"设备名称",key:"devname",width:200,align:"center",render(e,t){return e.setStatus?a(re,{value:e.devname,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].devname=o}}):a("div",{},e.devname)}},{title:"型号",key:"devmodel",width:100,align:"center",render(e){return a(nl,{tooltipPlacement:"center",style:{maxWidth:"100px"}},{default:()=>e.devmodel||"",tooltip:()=>a("div",{style:{textAlign:"center",padding:"8px",maxWidth:"600px"}},e.devmodel||"")})}},{title:"设备单位",key:"devunit",width:80,align:"center",render(e,t){return a("div",{},e.devunit)}},{title:"数量",key:"devnum",width:100,align:"center",render(e,t){return e.setStatus?a(ha,{value:e.devnum,placeholder:"请输入",max:r.value,onUpdateValue(o){d.value.debuggedDevieceList[t].devnum=o}}):a("div",{},e.devnum)}},{title:"是否为我司设备",key:"etype",width:120,align:"center",render(e,t){return a("div",{},e.etype==0?"是":"否")}},{title:"设备厂家",key:"devmanu",width:100,align:"center",render(e,t){return a("div",{},e.devmanu)}},{title:"厂家联系人",key:"manucontact",width:100,align:"center",render(e,t){return e.setStatus?a(re,{value:e.manucontact,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].manucontact=o}}):a("div",{},e.manucontact)}},{title:"厂家联系方式",key:"manuinfo",width:100,align:"center",render(e,t){return e.setStatus?a(re,{value:e.manuinfo,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].manuinfo=o}}):a("div",{},e.manuinfo)}},{title:"文件",key:"re1",width:100,align:"center",render(e,t){return e.setStatus?a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>Zt(e,"debuggedDevieceList",t)},{default:()=>"上传文件"}):a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const o=[{alias:e.re1,file:e.fl1},{alias:e.re2,file:e.fl2},{alias:e.re3,file:e.fl3},{alias:e.re4,file:e.fl4}].filter(i=>i.alias||i.file);return o.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件"),a("th",{style:"text-align:center; padding: 4px 8px;"},"操作")])]),a("tbody",o.map((i,T)=>{var C;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},i.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((C=i.file)==null?void 0:C.split("?")[1])||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>ea({url:i.file})},{default:()=>"下载"}))])}))])])}})}},{title:"设备状态",key:"devstatus",width:120,align:"center",render(e,t){return e.setStatus&&e.id?a(Ee,{value:e.devstatus,filterable:!0,placeholder:"请选择",options:[{label:"设备无异常",value:0},{label:"异常",value:1},{label:"未知",value:2}],onUpdateValue(o){d.value.debuggedDevieceList[t].devstatus=Number(o)||0}}):a("div",{},e.devstatus===0?"设备无异常":e.devstatus===1?"异常":"未知")}},{title:"接线方式",key:"connectionmode",width:100,align:"center",render(e,t){return e.setStatus?a(re,{value:e.connectionmode,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].connectionmode=o}}):a("div",{},e.connectionmode)}},{title:"是否安装就位",key:"install",width:120,align:"center",render(e,t){return e.setStatus&&e.id?a(Ee,{value:e.install,filterable:!0,placeholder:"请选择",options:[{label:"是",value:0},{label:"否",value:1}],onUpdateValue(o){d.value.debuggedDevieceList[t].install=Number(o)||0}}):a("div",{},e.install===0?"是":"否")}},{title:"备注",key:"notes",width:100,align:"center",render(e,t){return e.setStatus?a(re,{value:e.notes,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].notes=o}}):a("div",{},e.notes)}},{title:"操作信息",key:"dbtime",width:180,align:"center",render(e,t){return a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},e.dbtime?Je(1,e.dbtime):""),default:()=>a("div",{style:"padding: 10px;"},s("div",null,[s("div",null,[j("操作人："),e.username]),s("div",null,[j("操作时间："),e.dbtime]),s("div",null,[j("清点人："),e.dusername]),s("div",null,[j("清点时间："),e.ddbtime])]))})}},{key:"operate",title:ae("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return a("div",{class:"flex-center gap-8px"},[e.setStatus?[a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>g(e)},{default:()=>"保存"}),a(U,{type:"default",ghost:!0,size:"small",onClick:()=>u(e,t)},{default:()=>"取消"}),Xe("project:Form:Equipment:delete")&&a(ct,{onPositiveClick:async()=>{var o,i;if(e.id){const{data:T,error:C}=await wl(e.id);T&&(d.value.debuggedDevieceList.splice(t,1),(o=window.$message)==null||o.success("删除成功"),v.status=0,f(v.id),ue())}else{if(d.value.debuggedBusinessList.some(C=>C.eqmid==e.eqmid))return(i=window.$message)==null?void 0:i.error("该设备在待调试业务中已绑定，请先解除绑定后在删除！");d.value.debuggedDevieceList.splice(t,1)}}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(U,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})]:Xe("project:Form:Equipment:update")&&a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>l(e)},{default:()=>"编辑"})])}}],f=async e=>{if(!e)return;const{data:t}=await Gt({page:_.page,limit:_.pageSize,fuzzy:_.fuzzy,pid:e});d.value.debuggedDevieceList=t.list,_.itemCount=t.total,d.value.debuggedDevieceList.forEach(o=>{o.setStatus=!1}),Q.debuggedDevieceList=JSON.parse(JSON.stringify(d.value.debuggedDevieceList)),D.value=!1,ue()},D=h(!1),l=async e=>{console.log(R.data,e.cid,"ssssssssssssssss"),d.value.debuggedDevieceList.forEach(i=>{i.setStatus=!1});const{data:t,error:o}=await il(e.cid);o||(A.value[A.value.length-1].value!=t.id&&A.value.push({value:t.id,label:t.devname,disabled:!0,isLeaf:!0,hidden:!0}),r.value=t.devcount||0),D.value=!0,e.setStatus=!e.setStatus},u=(e,t)=>{e.setStatus=!e.setStatus,!e.id&&!D.value?d.value.debuggedDevieceList.splice(t,1):e.id&&D.value&&(d.value.debuggedDevieceList=JSON.parse(JSON.stringify(Q.debuggedDevieceList)))},g=async e=>{var t,o,i,T,C,ce,K;if(!e.cid){(t=window.$message)==null||t.warning("请选择合同设备");return}if(!e.devname){(o=window.$message)==null||o.warning("设备名称不能为空");return}if(!e.devmodel){(i=window.$message)==null||i.warning("设备型号不能为空");return}if(!e.devnum){(T=window.$message)==null||T.warning("设备数量不能为空");return}if(((C=e.fileList)==null?void 0:C.length)>0&&N.operateType=="edit"){const de=e.fileList.filter(E=>E.file),De=de.length;for(let E=0;E<De;E++){const O=de[E];O.indexText=`${E+1}/${De}`,O.progress=0,O.status="uploading";try{O.url=await Ze(O.file.file,O.file.name,""),O.progress=100,O.status="done"}catch{O.status="error"}}e.fileList.forEach((E,O)=>{e[`re${O+1}`]=E.name||"",e[`fl${O+1}`]=E.url||""}),delete e.fileList}if(e.id&&N.operateType=="edit"){const{data:de,error:De}=await Cl([e]);De||((ce=window.$message)==null||ce.success("修改成功"),f(v.id),v.status=0,e.setStatus=!e.setStatus)}else if(N.operateType=="edit"){const{data:de,error:De}=await La([{...e,pid:v.id}]);De||((K=window.$message)==null||K.success("添加成功"),f(v.id),v.status=0,e.setStatus=!e.setStatus,ue())}else e.id?e.id:ka(),e.setStatus=!e.setStatus,D.value=!1},F=h(!1);function S(){F.value=!0}const{pageData:z,getData:x,nextPage:V}=Ke(ya),H=async()=>{await x({usertypes:"2,3"})},fe=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&z.data.length<z.total&&(await V(),await et(),setTimeout(()=>{t.scrollTop=o}))},{pageData:oe,getData:ne,nextPage:Me}=Ke(ma),ge=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&oe.data.length<oe.total&&(await Me(),await et(),setTimeout(()=>{t.scrollTop=o}))},Le=async()=>{await ne(),oe.data=oe.data.map(e=>(e.name=`${e.weight}  `+e.tname,e))},{pageData:b,getData:k,nextPage:B}=Ke(Ht),P=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&b.data.length<b.total&&(await B(),b.data=b.data.map(i=>({...i,value:i.docker+"&id="+i.id})),await et(),setTimeout(()=>{t.scrollTop=o}))},Be=async()=>{await k({pid:v.id}),b.data=b.data.map(e=>({...e,value:e.docker+"&id="+e.id}))},{pageData:Ye,getData:rt,nextPage:at}=Ke(Gt),jt=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&oe.data.length<oe.total&&(await at(),await et(),setTimeout(()=>{t.scrollTop=o}))},Pt=async()=>{v.id&&await rt({pid:v.id})},Lt=h(),pt=[{title:"权重",key:"dtype",width:180,align:"center",render(e,t){var o;return e.setStatus?a(Ee,{value:e.dtype,filterable:!0,placeholder:"请选择权重",options:oe.data,labelField:"tname",valueField:"id",onUpdateValue(i){var T;d.value.debuggedBusinessList[t].dtype=Number(i)||0,d.value.debuggedBusinessList[t].debugname=((T=oe.data.find(C=>C.id==i))==null?void 0:T.tname)||""},onScroll(i){ge(i)}}):a("div",{},e.tname||((o=oe.data.find(i=>i.id==e.dtype))==null?void 0:o.tname))}},{title:"业务名称",key:"debugname",width:180,align:"center",render(e,t){return e.setStatus?a(re,{value:e.debugname,placeholder:"请输入业务名称",onUpdateValue(o){d.value.debuggedBusinessList[t].debugname=o}}):a("div",{},e.debugname)}},{key:"eqmname",title:"调试设备",align:"center",width:150,render(e,t){var o;return e.setStatus?a(Ee,{value:e.eqmid,placeholder:"请选择调试设备",options:N.operateType=="edit"?Ye.data:d.value.debuggedDevieceList,onscroll:jt,labelField:"devname",valueField:"id",clearable:!0,filterable:!0,onUpdateValue(i){d.value.debuggedBusinessList[t].eqmid=i}}):a("div",{},e.eqmname||((o=d.value.debuggedDevieceList.find(i=>i.eqmid==e.eqmid))==null?void 0:o.devname))}},{title:"调试人",key:"dbcreater",width:120,align:"center",render(e,t){var o;return e.setStatus?a(Ee,{value:e.dbcreater,filterable:!0,placeholder:"请选择调试人",options:z.data,labelField:"username",valueField:"id",onUpdateValue(i){d.value.debuggedBusinessList[t].dbcreater=i||0},onScroll(i){fe(i)}}):a("div",{},e.dbusername||((o=z.data.find(i=>i.id==e.dbcreater))==null?void 0:o.username))}},{title:"对接方",key:"docker",width:120,align:"center",render(e,t){var o;return e.setStatus?a(Ee,{value:e.docker,placeholder:"请输入或选择对接方",options:N.operateType=="edit"?b.data:d.value.contactList,onscroll:P,labelField:"docker",valueField:"value",clearable:!0,filterable:!0,tag:!0,onClear(){e.dockcharge="",e.dockcontact=""},onUpdateValue(i){var K;d.value.debuggedBusinessList[t].docker=i;const[T,C]=(K=e.docker)==null?void 0:K.split("&id="),ce=b.data.find(de=>de.docker===T&&de.id===Number(C));ce?(e.dockcharge=ce.pname,e.dockcontact=ce.pcontact):(e.dockcharge="",e.dockcontact="")}}):a("div",{},(o=e.docker)==null?void 0:o.split("&id=")[0])}},{title:"对接方负责人",key:"dockcharge",width:100,align:"center",render(e,t){return e.setStatus?a(re,{value:e.dockcharge,placeholder:"请输入对接方负责人",onUpdateValue(o){d.value.debuggedBusinessList[t].dockcharge=o}}):a("div",{},e.dockcharge)}},{title:"联系方式",key:"dockcontact",width:140,align:"center",render(e,t){return e.setStatus?a(re,{value:e.dockcontact,placeholder:"请输入联系方式",onUpdateValue(o){d.value.debuggedBusinessList[t].dockcontact=o}}):a("div",{},e.dockcontact)}},{title:"文件",key:"re1",width:80,align:"center",render(e,t){return e.setStatus?a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>Zt(e,"debuggedBusinessList",t)},{default:()=>"上传文件"}):a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const o=[{alias:e.re1,file:e.fl1},{alias:e.re2,file:e.fl2},{alias:e.re3,file:e.fl3},{alias:e.re4,file:e.fl4}].filter(i=>i.alias||i.file);return o.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件"),a("th",{style:"text-align:center; padding: 4px 8px;"},"操作")])]),a("tbody",o.map((i,T)=>{var C;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},i.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((C=i.file)==null?void 0:C.split("?")[1])||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>ea({url:i.file})},{default:()=>"下载"}))])}))])])}})}},{title:"备注",key:"notes",width:120,align:"center",render(e,t){return e.setStatus?a(re,{value:e.notes,placeholder:"请输入备注",onUpdateValue(o){d.value.debuggedBusinessList[t].notes=o}}):a("div",{},e.notes)}},{title:"计划开始时间",key:"starttime",width:140,align:"center",render(e,t){return e.setStatus?a(bt,{type:"date",clearable:!0,value:e.starttime,valueFormat:"yyyy-MM-dd",placeholder:"请选择",onUpdateValue(o){d.value.debuggedBusinessList[t].starttime=o}}):a("div",e.starttime?Je(0,e.starttime):"")}},{title:"计划结束时间",key:"endtime",width:140,align:"center",render:(e,t)=>e.setStatus?a(bt,{type:"date",clearable:!0,valueFormat:"yyyy-MM-dd",value:e.endtime,placeholder:"请选择",onUpdateValue(o){d.value.debuggedBusinessList[t].endtime=o}}):e.endtime?Je(0,e.endtime):""},{key:"username",title:"创建信息",align:"left",width:240,render(e){return s("div",{style:"display:flex; flex-direction:column; gap:3px; line-height:1.4;"},[s("div",null,[s("span",{style:"color:#666"},[j("创建人：")]),s("span",null,[e.username||"-"])]),s("div",null,[s("span",{style:"color:#666"},[j("时间：")]),s("span",null,[e.dbtime||"-"])])])}},{key:"operate",title:ae("common.operate"),align:"center",width:280,fixed:"right",render(e,t){return a("div",{class:"flex-center gap-8px"},[e.setStatus?[Xe("project:Form:Debug:insert")&&a(ct,{onPositiveClick:()=>{wa(e)}},{default:()=>"是否确认保存？",trigger:()=>a(U,{type:"info",ghost:!0,size:"small"},{default:()=>"保存"})}),a(U,{type:"default",ghost:!0,size:"small",onClick:()=>Ca(e,t)},{default:()=>"取消"}),Xe("project:Form:Debug:delete")&&a(ct,{onPositiveClick:async()=>{var o;if(e.id){const{data:i,error:T}=await Tl(e.id);i&&(d.value.debuggedBusinessList.splice(t,1),(o=window.$message)==null||o.success("删除成功"),Qe(v.id),v.status=0,ue())}else d.value.debuggedBusinessList.splice(t,1)}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(U,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})]:Xe("project:Form:Debug:update")&&a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>Da(e)},{default:()=>"编辑"})])}}],Se=dt({page:1,pageSize:1,showSizePicker:!0,itemCount:0,creater:"",pageSizes:[10,20],prefix:()=>`共 ${Se.itemCount} 条`,onChange:e=>{Se.page=e,Qe(v.id)},onUpdatePageSize:e=>{Se.pageSize=e,Se.page=1,Qe(v.id)}}),St=()=>{Se.pageSize==1?Se.pageSize=20:Se.pageSize=1,Qe(v.id)},Qe=async e=>{if(!e)return;const{data:t}=await Fl({page:Se.page,limit:Se.pageSize,creater:le.userInfo.id,pid:e});d.value.debuggedBusinessList=t.list,Se.itemCount=t.total,d.value.debuggedBusinessList.forEach(o=>{o.setStatus=!1}),Q.debuggedBusinessList=JSON.parse(JSON.stringify(d.value.debuggedBusinessList)),G.value=!1},G=h(!1),Da=e=>{e.starttime=oa(e.starttime),e.endtime=oa(e.endtime),Lt.value=e.status,d.value.debuggedBusinessList.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus,G.value=!0},Ca=(e,t)=>{e.setStatus=!e.setStatus,!e.id&&!G.value?d.value.debuggedBusinessList.splice(t,1):e.id&&G.value&&(d.value.debuggedBusinessList=JSON.parse(JSON.stringify(Q.debuggedBusinessList)))},wa=async e=>{var i,T,C,ce,K,de,De,E,O,ve,ie;if(!e.dtype){(i=window.$message)==null||i.warning("请选择权重");return}if(!e.debugname){(T=window.$message)==null||T.warning("请输入业务名称");return}if(!e.docker){(C=window.$message)==null||C.warning("请选择或输入对接方");return}if(!e.dockcharge){(ce=window.$message)==null||ce.warning("请输入对接方负责人");return}if(!e.dockcontact){(K=window.$message)==null||K.warning("请输入对接方联系方式");return}if(!e.dbcreater){(de=window.$message)==null||de.warning("请选择调试人");return}const t=Je(0,e.starttime),o=Je(0,e.endtime);if(((De=e.fileList)==null?void 0:De.length)>0&&N.operateType=="edit"){const I=e.fileList.filter(Z=>Z.file),je=I.length;for(let Z=0;Z<je;Z++){const _e=I[Z];_e.indexText=`${Z+1}/${je}`,_e.progress=0,_e.status="uploading";try{_e.url=await Ze(_e.file.file,_e.file.name,""),_e.progress=100,_e.status="done"}catch{_e.status="error"}}e.fileList.forEach((Z,_e)=>{e[`re${_e+1}`]=Z.name||"",e[`fl${_e+1}`]=Z.url||""}),delete e.fileList}if(e.id){const I=JSON.parse(JSON.stringify(e));Lt.value==I.status&&delete I.status,I.docker=(E=I.docker)==null?void 0:E.split("&id=")[0];const{data:je,error:Z}=await $l([{...I,starttime:t,endtime:o}]);Z||((O=window.$message)==null||O.success("修改成功"),Qe(v.id),v.status=0,e.setStatus=!e.setStatus)}else if(N.operateType=="edit"){e.docker=(ve=e.docker)==null?void 0:ve.split("&id=")[0];const{data:I,error:je}=await Sa([{...e,starttime:t,endtime:o,pid:v.id}]);je||((ie=window.$message)==null||ie.success("添加成功"),Qe(v.id),e.setStatus=!e.setStatus,v.status=0,ue())}else e.setStatus=!e.setStatus,G.value=!1},Dt=h(!1);function Fa(){Dt.value=!0}const $a=()=>{const e=document.getElementById("__SCROLL_EL_ID__");e==null||e.scrollTo({top:0,behavior:"smooth"})},Qt=e=>{he[e].show=!he[e].show},Bt=e=>{const t=document.getElementById(e);t&&(t.scrollIntoView({behavior:"smooth",block:"start"}),Ce.value=e)},Nt=()=>{const e=[];he.forEach(i=>{i.tables.forEach((T,C)=>e.push(`${i.id}-${C}`))});const t=window.scrollY;let o="";for(const i of e){const T=document.getElementById(i);T&&T.offsetTop-100<=t&&(o=i)}Ce.value=o},Ne=h([]),Ct=h([]),wt=h([]),Ft=h([]),$t=h([]),Et=h([]),Xt=h({});async function Vt(e){const{data:t,error:o}=await Ul({limit:100,page:1,pid:e});o||(d.value.fileList=[],Ne.value=[],Ct.value=[],wt.value=[],Ft.value=[],$t.value=[],Et.value=[],Xt.value=t,console.log("data",Xt.value),t.list.forEach(i=>{i.sort==1&&d.value.fileList.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==2&&Ne.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==3&&Ct.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==4&&wt.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==5&&Ft.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==6&&$t.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==7&&Et.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime})}),d.value.fileList.reverse(),Ne.value.reverse(),Ct.value.reverse(),wt.value.reverse(),Ft.value.reverse(),$t.value.reverse(),Et.value.reverse(),ue())}const Ta=e=>{const t=e.target,o=document.getElementById("__SCROLL_EL_ID__"),i=document.getElementById("scrollToTop");!o||!i||(t.scrollTop>(o.clientHeight||0)+500?i.classList.add("show"):i.classList.remove("show"))},mt=h(!1),ut=h(""),At=h(),Zt=(e,t,o)=>{lt.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}],mt.value=!0,ut.value=t,At.value=o,e.re1&&(lt.value[0]={name:e.re1,url:e.fl1,file:void 0}),e.re2&&(lt.value[1]={name:e.re2,url:e.fl2,file:void 0}),e.re3&&(lt.value[2]={name:e.re3,url:e.fl3,file:void 0}),e.re4&&(lt.value[3]={name:e.re4,url:e.fl4,file:void 0}),console.log(lt.value)},Ua=[{title:"",key:"",align:"center",render(e,t){return`附件${t+1}`}},{title:"文件名称",key:"filename",align:"center",render(e){var i;const t=async({file:T,onFinish:C,onError:ce})=>{var K,de;try{e.name=T.name,e.file=T}catch(De){console.error(De),(de=(K=window.$message)==null?void 0:K.error)==null||de.call(K,"文件上传出错")}};async function o(T){return!0}return a("div",{style:"display:flex;justify-content:center;align-items:center;"},[e.file||e.url?a("span",{},[a("span",{},((i=e.file)==null?void 0:i.name)||e.url.split("?")[1]||""),a("span",{style:"color:red;cursor:pointer;font-size:12px;margin-left:8px;",onClick:()=>{e.url="",e.file=null,e.name=""}},"删除")]):a(ht,{action:"#",showFileList:!1,customRequest:t,onBeforeUpload:o},{default:()=>a(U,{type:"info",size:"small",ghost:!0,loading:e.status},{default:()=>"上传文件"})})])}},{title:"文件别名",key:"name",align:"center",render(e){return a(re,{value:e.name,clearable:!0,onUpdateValue:t=>{e.name=t}})}}],lt=h([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]);async function ea(e){if(e!=null&&e.url)try{const o=await(await fetch(e.url.split("?")[0],{mode:"cors"})).blob(),i=URL.createObjectURL(o),T=document.createElement("a");T.href=i,T.download=e.url.split("?")[1],T.style.display="none",document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(i)}catch(t){console.error("下载失败:",t)}}const za=async()=>{var t,o;let e=!0;if(lt.value.forEach((i,T)=>{var K,de;const C=i.name||"",ce=((K=i.url)==null?void 0:K.split("?")[1])||((de=i.file)==null?void 0:de.name);(C&&!ce||!C&&ce)&&(e=!1)}),!e){(o=(t=window.$message)==null?void 0:t.error)==null||o.call(t,"文件名称和文件地址必须同时存在，不能只填一个");return}d.value[ut.value][At.value].fileList=lt.value,e&&(mt.value=!1,ut.value="",At.value=void 0)},ja=()=>{mt.value=!1};xa(async()=>{qe(),y.query.IsScroll&&setTimeout(()=>{Bt("phase2-0")},800),window.addEventListener("scroll",Nt);const e=document.getElementById("__SCROLL_EL_ID__");e&&e.addEventListener("scroll",Ta)}),sl(()=>{window.removeEventListener("scroll",Nt);const e=document.getElementById("__SCROLL_EL_ID__");e&&e.removeEventListener("scroll",Nt)});const Tt=h(["1","2","3"]),Pa=e=>{Tt.value=e},ta=h(["1","2","3","4"]),Ba=e=>{ta.value=e},Na=Kt(()=>({add:"新增项目调试单",edit:"修改项目调试单"})[N.operateType]),Ea=e=>{d.value.debuggedDevieceList=d.value.debuggedDevieceList.concat(e).map(t=>({...t,cid:t.cid*1,setStatus:!1})),F.value=!1},Va=e=>{d.value.debuggedBusinessList=d.value.debuggedBusinessList.concat(e).map(t=>({...t,setStatus:!1})),Dt.value=!1},aa=e=>{e.fileType==2?Ne.value=Ne.value.concat(e.row).map(t=>({...t})):d.value.fileList=d.value.fileList.concat(e.row).map(t=>({...t}))},la=e=>{e.fileType==2?Ne.value.splice(e.index,1):d.value.fileList.splice(e.index,1)},It=h();async function Aa(e=0){var t;await It.value[0].validate(),(t=window.$dialog)==null||t.info({title:"提示",content:"确定保存并提交吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await na(e)}})}const it=h(!1);async function na(e=0){var t,o,i,T,C,ce;if(!it.value)try{if(await It.value[0].validate(),it.value=!0,N.operateType==="edit"){const K=JSON.parse(JSON.stringify(e==1?{...v,status:e}:{...v})),{data:de,error:De}=await bl([K]);De||((t=window.$message)==null||t.success("保存成功"),te("returnandSub"))}else{if(d.value.debuggedDevieceList.length>0)for(const E of d.value.debuggedDevieceList){if(!E.fileList||E.fileList.length===0)continue;const O=E.fileList.filter(ie=>ie.file),ve=O.length;for(let ie=0;ie<ve;ie++){const I=O[ie];I.indexText=`${ie+1}/${ve}`,I.progress=0,I.status="uploading";try{I.url=await Ze(I.file.file,I.file.name,""),I.progress=100,I.status="done"}catch{I.status="error",(i=(o=window.$message)==null?void 0:o.error)==null||i.call(o,"文件上传失败，请重试");return}}E.fileList.forEach((ie,I)=>{const je=`re${I+1}`,Z=`fl${I+1}`;ie.status==="done"?(E[je]=ie.name||"",E[Z]=ie.url||""):(E[je]="",E[Z]="")}),delete E.fileList}if(d.value.debuggedBusinessList.length>0)for(const E of d.value.debuggedBusinessList){if(!E.fileList||E.fileList.length===0)continue;const O=E.fileList.filter(ie=>ie.file),ve=O.length;for(let ie=0;ie<ve;ie++){const I=O[ie];I.indexText=`${ie+1}/${ve}`,I.progress=0,I.status="uploading";try{I.url=await Ze(I.file.file,I.file.name,""),I.progress=100,I.status="done"}catch{I.status="error",(C=(T=window.$message)==null?void 0:T.error)==null||C.call(T,"文件上传失败，请重试");return}}E.fileList.forEach((ie,I)=>{const je=`re${I+1}`,Z=`fl${I+1}`;ie.status==="done"?(E[je]=ie.name||"",E[Z]=ie.url||""):(E[je]="",E[Z]="")}),delete E.fileList}if(d.value.fileList.length>0){const E=d.value.fileList.length;for(let O=0;O<E;O++){const ve=d.value.fileList[O];if(!(!ve.file||typeof ve.file!="object"))try{ve.url=await Ze(ve.file,ve.name,"",ie=>{})}catch{}}d.value.fileList=d.value.fileList.map(O=>({...O,file:O.url}))}if(Ne.value.length>0){const E=Ne.value.length;for(let O=0;O<E;O++){const ve=Ne.value[O];if(!(!ve.file||typeof ve.file!="object"))try{ve.url=await Ze(ve.file,ve.name,"",ie=>{})}catch{}}Ne.value=Ne.value.map(O=>({...O,file:O.url}))}const K=e==1?{...v,status:e}:{...v},{data:de,error:De}=await hl({projectFormPojo:K,projectFormContactPojoList:d.value.contactList,projectFormDebugPojos:d.value.debuggedBusinessList,projectFormEquipmentPojoList:d.value.debuggedDevieceList,projectFormFilePojos:d.value.fileList.concat(Ne.value)});de&&((ce=window.$message)==null||ce.success(de||"添加成功"),te("returnandSub"))}}catch(K){console.error("提交失败:",K)}finally{it.value=!1}}return(e,t)=>{const o=Il,i=El,T=ol,C=qa,ce=Ra,K=pa,de=da,De=ca,E=Ga,O=Ha,ve=xt,ie=cl,I=yt("no-auth"),je=yt("loading");return $(),q(nt,null,[s(T,{bordered:!1,size:"small",class:"card-wrapper"},{default:c(()=>[M("div",sn,[M("h2",on,se(Na.value),1),M("div",rn,[s(L(U),{ghost:"",type:"primary",onClick:Ut(Oe,["stop"])},{icon:c(()=>[s(o,{class:"text-icon"})]),default:c(()=>[t[16]||(t[16]=j(" 返回 "))]),_:1,__:[16]}),s(L(U),{type:"primary",onClick:t[0]||(t[0]=Z=>na()),loading:it.value},{icon:c(()=>[s(i,{class:"text-icon"})]),default:c(()=>[t[17]||(t[17]=j(" "+se("保存")))]),_:1,__:[17]},8,["loading"]),v.status==0?($(),ke(L(U),{key:0,type:"primary",onClick:t[1]||(t[1]=Z=>Aa(1)),loading:it.value},{icon:c(()=>[s(i,{class:"text-icon"})]),default:c(()=>[t[18]||(t[18]=j(" "+se("保存并提交")))]),_:1,__:[18]},8,["loading"])):W("",!0)])])]),_:1}),s(ie,{style:{height:"calc(100vh - 182px)"}},{default:c(()=>[st(($(),q("div",un,[M("div",{id:"scrollToTop",onClick:$a,title:"回到顶部"},[s(C,{class:"font-size-30px"})]),s(T,{bordered:!1,size:"small",class:"card-wrapper pb-40px"},{default:c(()=>[M("div",dn,[M("div",cn,[M("div",pn,[($(!0),q(nt,null,ra(he,(Z,_e)=>($(),q("div",{key:Z.id,class:"timeline-phase"},[M("div",{class:"timeline-row",id:"phase"+(_e+1)},[M("div",gn,[t[19]||(t[19]=M("div",{class:"vertical-line"},null,-1)),M("div",{class:"flashing-icon",onClick:Re=>Qt(_e)},null,8,vn)]),M("div",mn,[M("div",{class:"phase-title",onClick:Re=>Qt(_e)},se(Z.title),9,yn),s(L(Ve))])],8,fn),s(rl,{name:"fade"},{default:c(()=>[st(M("div",hn,[_e===0?($(),q("div",bn,[s(nn,{ref_for:!0,ref_key:"prjDetailRef",ref:It,onSubmit:Ge,prjInfo:v,"onUpdate:prjInfo":t[2]||(t[2]=Re=>v=Re),onChangePrj:ze,"operate-type":N.operateType},null,8,["prjInfo","operate-type"])])):W("",!0),($(!0),q(nt,null,ra(Z.tables,(Re,ft)=>($(),q("div",{key:`${Z.id}-${ft}`,class:"timeline-row"},[M("div",_n,[t[20]||(t[20]=M("div",{class:"vertical-line"},null,-1)),Re.type==1?($(),q("div",{key:0,class:ul(["icon",{active:Ce.value===`${Z.id}-${ft}`}]),style:{"font-size":"20px",border:"3px solid #409eff",color:"#409eff"},onClick:ee=>Bt(`${Z.id}-${ft}`)},[s(ce)],10,kn)):($(),q("div",{key:1,class:"icon",style:{"font-size":"20px",border:"3px solid #ccc",color:"#ccc"},onClick:ee=>Bt(`${Z.id}-${ft}`)}," 一 ",8,xn))]),M("div",{class:"actProgress",style:qt({background:Re.type==1?"#409eff":"#ccc"})},null,4),M("div",{class:"timeline-content",id:`${Z.id}-${ft}`},[_e===0?($(),q(nt,{key:0},[s(O,{"expanded-names":Tt.value,"onUpdate:expandedNames":Pa,"trigger-areas":["arrow"]},{default:c(()=>[Re.id==1?($(),ke(E,{key:0,name:"1"},{header:c(()=>[s(L(Ve),{align:"center",justify:"space-between",style:{width:"100%"}},{default:c(()=>[M("div",Sn,[t[22]||(t[22]=M("span",null,"项目联系人",-1)),st(($(),ke(L(U),{size:"small",ghost:"",type:"primary",class:"pos-absolute left-140px",onClick:Ut(xe,["stop"])},{icon:c(()=>[s(K,{class:"text-icon"})]),default:c(()=>[t[21]||(t[21]=j(" 添加项目联系人 "))]),_:1,__:[21]})),[[I,"project:Form:Contact:insert"]])]),J.itemCount>0?($(),q("div",Dn,"共"+se(J.itemCount)+"条",1)):W("",!0)]),_:1})]),default:c(()=>[d.value.contactList.length>0?($(),ke(L(ot),{key:0,columns:Ae,data:d.value.contactList,size:"small","scroll-x":702,"row-key":ee=>ee.id,"paginate-single-page":!1,"max-height":350,pagination:J.pageSize==1?!1:J,remote:""},null,8,["data","row-key","pagination"])):W("",!0),J.itemCount>1?($(),q("div",Cn,[d.value.contactList.length==1?($(),q("span",{key:0,onClick:X},[t[23]||(t[23]=j("更多")),s(de,{class:"font-size-20px"})])):($(),q("span",{key:1,onClick:X},[t[24]||(t[24]=j("收起")),s(De,{class:"font-size-20px"})]))])):W("",!0)]),_:1})):W("",!0),Re.id==2?($(),ke(E,{key:1,title:"待调试设备",name:"2"},{header:c(()=>[s(L(Ve),{align:"center",justify:"space-between",style:{width:"100%"}},{default:c(()=>[M("div",wn,[t[26]||(t[26]=M("span",null,"待调试设备",-1)),st(($(),ke(L(U),{size:"small",ghost:"",type:"primary",class:"pos-absolute left-140px",onClick:Ut(S,["stop"])},{icon:c(()=>[s(K,{class:"text-icon"})]),default:c(()=>[t[25]||(t[25]=j(" 添加待调试设备 "))]),_:1,__:[25]})),[[I,"project:Equipment:insert"]])]),_.itemCount>0?($(),q("div",Fn,"共"+se(_.itemCount)+"条",1)):W("",!0)]),_:1})]),default:c(()=>[s(Zl,{onSubmitted:t[3]||(t[3]=ee=>{f(v.id),v.status=0}),onSubmittedData:t[4]||(t[4]=ee=>Ea(ee)),visible:F.value,"onUpdate:visible":t[5]||(t[5]=ee=>F.value=ee),"operate-type":N.operateType,pid:v.id,proid:v.proid},null,8,["visible","operate-type","pid","proid"]),d.value.debuggedDevieceList.length>0?($(),ke(L(ot),{key:0,style:qt({width:L(Y).siderCollapse?"calc(100vw - 219px)":"calc(100vw - 375px)"}),columns:p,data:d.value.debuggedDevieceList,size:"small","scroll-x":p.reduce((ee,Mt)=>ee+Mt.width,0),"row-key":ee=>ee.id,"max-height":350,pagination:_.pageSize==1?!1:_,remote:"","paginate-single-page":!1},null,8,["style","data","scroll-x","row-key","pagination"])):W("",!0),_.itemCount>1?($(),q("div",$n,[d.value.debuggedDevieceList.length==1?($(),q("span",{key:0,onClick:m},[t[27]||(t[27]=j("更多")),s(de,{class:"font-size-20px"})])):($(),q("span",{key:1,onClick:m},[t[28]||(t[28]=j("收起")),s(De,{class:"font-size-20px"})]))])):W("",!0)]),_:2},1024)):W("",!0),Re.id==3?($(),ke(E,{key:2,title:"图纸",name:"3"},{default:c(()=>[s(ua,{data:d.value.fileList,onRemoveData:t[6]||(t[6]=ee=>la(ee)),pid:v.id,"operate-type":N.operateType,onGetData:t[7]||(t[7]=ee=>{Vt(v.id),v.status=0}),typename:"图纸",onSubmittedData:t[8]||(t[8]=ee=>aa(ee)),fileType:1},null,8,["data","pid","operate-type"])]),_:1})):W("",!0)]),_:2},1032,["expanded-names"]),Re==4?($(),q("div",Tn)):W("",!0)],64)):W("",!0),_e===1?($(),q(nt,{key:1},[s(O,{"expanded-names":ta.value,"onUpdate:expandedNames":Ba,"trigger-areas":["arrow"]},{default:c(()=>[Re.id==1?($(),ke(E,{key:0,title:"待调试业务",name:"1"},{header:c(()=>[s(L(Ve),{align:"center",justify:"space-between",style:{width:"100%"}},{default:c(()=>[M("div",Un,[t[30]||(t[30]=M("span",null,[j("待调试业务 "),M("span",{class:"c-#f0a020 font-bold"},"※")],-1)),st(($(),ke(L(U),{size:"small",ghost:"",type:"primary",class:"pos-absolute left-140px",onClick:Ut(Fa,["stop"])},{icon:c(()=>[s(K,{class:"text-icon"})]),default:c(()=>[t[29]||(t[29]=j(" 添加待调试业务 "))]),_:1,__:[29]})),[[I,"project:Debug:insert"]])]),Se.itemCount>0?($(),q("div",zn,"共"+se(Se.itemCount)+"条",1)):W("",!0)]),_:1})]),default:c(()=>[s(Xl,{onSubmitted:t[9]||(t[9]=ee=>{Qe(v.id),v.status=0}),visible:Dt.value,"onUpdate:visible":t[10]||(t[10]=ee=>Dt.value=ee),"operate-type":N.operateType,pid:v.id,contactList:d.value.contactList,debuggedDevieceList:d.value.debuggedDevieceList,onSubmittedData:t[11]||(t[11]=ee=>Va(ee))},null,8,["visible","operate-type","pid","contactList","debuggedDevieceList"]),d.value.debuggedBusinessList.length>0?($(),ke(L(ot),{key:0,style:qt({width:L(Y).siderCollapse?"calc(100vw - 219px)":"calc(100vw - 375px)"}),columns:pt,data:d.value.debuggedBusinessList,size:"small","row-key":ee=>ee.id,striped:"","scroll-x":pt.reduce((ee,Mt)=>ee+Mt.width,0),"paginate-single-page":!1,pagination:Se.pageSize==1?!1:Se,remote:"","max-height":350},null,8,["style","data","row-key","scroll-x","pagination"])):W("",!0),Se.itemCount>1?($(),q("div",jn,[d.value.debuggedBusinessList.length==1?($(),q("span",{key:0,onClick:St},[t[31]||(t[31]=j(" 更多 ")),s(de,{class:"font-size-20px"})])):($(),q("span",{key:1,onClick:St},[t[32]||(t[32]=j(" 收起 ")),s(De,{class:"font-size-20px"})]))])):W("",!0)]),_:1})):W("",!0),Re.id===2?($(),ke(E,{key:1,title:"文件",name:"2"},{default:c(()=>[s(ua,{data:Ne.value,onRemoveData:t[12]||(t[12]=ee=>la(ee)),pid:v.id,onGetData:t[13]||(t[13]=ee=>{Vt(v.id),v.status=0}),typename:"项目文件",onSubmittedData:t[14]||(t[14]=ee=>aa(ee)),"operate-type":N.operateType,fileType:2},null,8,["data","pid","operate-type"])]),_:1})):W("",!0)]),_:2},1032,["expanded-names"]),ft===2?($(),q("div",Pn)):W("",!0)],64)):W("",!0)],8,Ln)]))),128))],512),[[dl,Z.show]])]),_:2},1024)]))),128))])])])]),_:1}),s(ve,{show:mt.value,"onUpdate:show":t[15]||(t[15]=Z=>mt.value=Z),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:c(()=>[j(se(ut.value=="debuggedDevieceList"?"待调试设备":ut.value=="debuggedBusinessList"?"待调试业务":ut.value=="needsList"?"客户需求变更":ut.value=="developBusinessList"?"需要开发":"")+" 文件列表 ",1)]),footer:c(()=>[s(L(Ve),{justify:"end"},{default:c(()=>[s(L(U),{size:"small",class:"mt-16px",onClick:ja},{default:c(()=>[j(se(L(ae)("common.cancel")),1)]),_:1}),s(L(U),{type:"primary",size:"small",class:"mt-16px",onClick:za},{default:c(()=>[j(se(L(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:c(()=>[s(L(ot),{columns:Ua,"paginate-single-page":!1,data:lt.value,"max-height":350},null,8,["data"])]),_:1},8,["show"])])),[[je,it.value]])]),_:1})],64)}}}),Nn=va(Bn,[["__scopeId","data-v-63653895"]]),Qn=Object.freeze(Object.defineProperty({__proto__:null,default:Nn},Symbol.toStringTag,{value:"Module"}));export{Wn as a,bl as b,Yn as f,Qn as i,Nn as p};
