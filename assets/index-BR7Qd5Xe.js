import{_ as Ue}from"./table-column-setting.vue_vue_type_script_setup_true_lang-Bdcfc8xX.js";import{_ as Be}from"./round-delete-BcVZiUgs.js";import{_ as qe}from"./round-add-m1RhtTAe.js";import{d as fe,av as me,z as we,D as Le,s as S,aQ as be,A as Ce,a as Ie,at as ke,au as Re,c as A,o as j,w as a,f as e,a3 as Fe,b as oe,G as ve,M as xe,h as l,aH as Se,H as ne,ax as Me,aY as Oe,e as le,t as N,aB as Ve,J as _e,B as R,g as q,$ as F,a4 as Ee,cC as je,aC as Te,aG as Ge,dd as Ke,de as Ae,ay as He,L as Je,a2 as De,aI as Qe,i as Ye,F as pe,aJ as ce,az as We,I as ue,aK as Xe,df as ge,dg as Ze,n as et,aP as tt}from"./index-CSRAu6Mr.js";import{u as at,a as nt}from"./table-C4ThAVf4.js";import{u as Ne}from"./usePageData-uFuTUu7m.js";import{_ as $e}from"./Grid-FmK2KN02.js";import{_ as ze}from"./FormItemGridItem-C5FHRong.js";import{_ as ot}from"./round-search-Bq40G238.js";import{_ as lt}from"./round-refresh-BdnAPG6i.js";import{N as he}from"./Popconfirm-BAXNfjls.js";const st={key:0,style:{"margin-left":"20px"}},rt=["onClick"],it=["onClick"],ct={key:0},ut={style:{display:"flex","justify-content":"space-between"}},dt=fe({name:"OperateDrawer",__name:"operate-drawer",props:me({operateType:{},rowData:{},pid:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:me(["submitted"],["update:visible"]),setup($,{emit:H}){const z=we(),L=H,w=$,t=Le(C());S();function C(){return{pid:void 0,id:"",reqcontent:"",customer:"",cstcontact:"",notes:"",re1:"",re2:"",re3:"",re4:"",fl1:"",fl2:"",fl3:"",fl4:""}}const d=S([]),{pageData:_,getData:g,nextPage:J}=Ne(je),M=async n=>{const o=n.currentTarget,v=o.scrollTop;o.scrollTop+o.offsetHeight>=o.scrollHeight&&_.data.length<_.total&&(await J(),d.value=_.data,await Te(),setTimeout(()=>{o.scrollTop=v}))},Q=async()=>{await g({fuzzy:z.userInfo.pname,page:1}),d.value=_.data},Y=be.debounce(async n=>{await g({fuzzy:n,page:1}),d.value=_.data},300),P=S(!1),U=S(!1),T=n=>{if(t.pid=null,P.value=!0,U.value=!1,!n){O();return}Y(n)},W=async()=>{P.value&&!U.value&&(await g({page:1}),d.value=_.data,P.value=!1)},O=async()=>{await g({page:1}),d.value=_.data},se=async n=>{t.pid=n,U.value=!0};async function X(){var n;if(Q(),Object.assign(t,C()),m.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}],t.pid=w.pid?w.pid:(n=d.value[0])==null?void 0:n.id,w.operateType==="edit"&&w.rowData){Object.assign(t,w.rowData),m.value=[];for(let o=1;o<=4;o++){const v=t[`re${o}`],D=t[`fl${o}`];m.value.push({name:v||"",url:D||"",status:D?"finished":"pending"})}}}const{formRef:G,validate:i,restoreValidation:u}=Ce(),k={pid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择"},reqcontent:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},customer:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},cstcontact:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"}},p=Ie(()=>({add:"新增需求变更",edit:"修改需求变更"})[w.operateType]),s=ke($,"visible");async function h(n){if(n)try{const v=await(await fetch(n==null?void 0:n.split("?")[0],{mode:"cors"})).blob(),D=URL.createObjectURL(v),b=document.createElement("a");b.href=D,b.download=n==null?void 0:n.split("?")[1],b.style.display="none",document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(D)}catch(o){console.error("下载失败:",o)}}Re(s,()=>{s.value&&(X(),setTimeout(()=>{const n=document.querySelector(".n-scrollbar-content");n==null||n.scrollTo(0,0)},300),u())});const B=S(!1),x=S(0),m=S([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]);async function Z({file:n},o){m.value[o].file=n,m.value[o].name=n.name}function V(){s.value=!1}async function K(n){return!0}const y=S(!1);async function Pe(){var n,o,v,D;if(!y.value)try{await i(),y.value=!0;let b=!0;if(m.value.forEach((f,c)=>{var te,ae;const ee=`re${c+1}`,r=`fl${c+1}`,E=f.name||"",I=((te=f.url)==null?void 0:te.split("?")[1])||((ae=f.file)==null?void 0:ae.name);(E&&!I||!E&&I)&&(b=!1),f.status==="done"&&(t[ee]=E,t[r]=I)}),!b){(o=(n=window.$message)==null?void 0:n.error)==null||o.call(n,"文件名称和文件地址必须同时存在，不能只填一个");return}B.value=!0;const re=m.value.filter(f=>f.file),ie=re.length;for(let f=0;f<ie;f++){x.value=f;const c=re[f];c.indexText=`${f+1}/${ie}`,c.progress=0,c.status="uploading";try{c.url=await Ge(c.file.file,c.file.name,"",ee=>{c.progress=ee}),c.progress=100,c.status="done"}catch{c.status="error"}}if(m.value.forEach((f,c)=>{t[`re${c+1}`]=f.name||"",t[`fl${c+1}`]=f.url||""}),B.value=!1,w.operateType==="edit"){const{data:f,error:c}=await Ke([t]);c||(V(),L("submitted"),(v=window.$message)==null||v.success("修改成功"))}else{const{data:f,error:c}=await Ae([{...t}]);c||(V(),L("submitted"),(D=window.$message)==null||D.success("添加成功"))}}catch{}finally{y.value=!1}}return(n,o)=>{const v=ze,D=He,b=$e,re=xe,ie=Ve,f=Fe,c=_e,ee=Ee;return j(),A(ee,{show:s.value,"onUpdate:show":o[5]||(o[5]=r=>s.value=r),title:p.value,preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{footer:a(()=>[e(c,{justify:"end",size:16},{default:a(()=>[e(l(R),{onClick:V},{default:a(()=>[q(N(l(F)("common.cancel")),1)]),_:1}),e(l(R),{type:"primary",onClick:Pe,loading:y.value},{default:a(()=>[q(N(l(F)("common.confirm")),1)]),_:1},8,["loading"])]),_:1})]),default:a(()=>[e(f,{class:"pr-20px"},{default:a(()=>[e(re,{ref_key:"formRef",ref:G,model:t,rules:k,"label-placement":"left","label-width":120},{default:a(()=>[e(b,{responsive:"screen","item-responsive":""},{default:a(()=>[e(v,{span:"24 m:12",label:"项目列表",path:"pid"},{default:a(()=>[e(l(Se),{clearable:"",filterable:"",value:t.pid,"onUpdate:value":[o[0]||(o[0]=r=>t.pid=r),se],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:O,onSearch:T,onBlur:W,options:d.value,onScroll:M},null,8,["value","options"])]),_:1}),e(v,{span:"24 m:12",label:"需求内容",path:"reqcontent"},{default:a(()=>[e(l(ne),{value:t.reqcontent,"onUpdate:value":o[1]||(o[1]=r=>t.reqcontent=r),placeholder:"请输入"},null,8,["value"])]),_:1}),e(v,{span:"24 m:12",label:"客户联系人",path:"customer"},{default:a(()=>[e(l(ne),{value:t.customer,"onUpdate:value":o[2]||(o[2]=r=>t.customer=r),placeholder:"请输入"},null,8,["value"])]),_:1}),e(v,{span:"24 m:12",label:"联系方式",path:"cstcontact"},{default:a(()=>[e(l(ne),{value:t.cstcontact,"onUpdate:value":o[3]||(o[3]=r=>t.cstcontact=r),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),e(v,{span:"24 m:12",label:"备注",path:"notes"},{default:a(()=>[e(l(ne),{value:t.notes,"onUpdate:value":o[4]||(o[4]=r=>t.notes=r),placeholder:"请输入"},null,8,["value"])]),_:1}),(j(!0),oe(Me,null,Oe(m.value,(r,E)=>(j(),A(v,{span:"24 m:24",label:"",path:"notes","show-feedback":!1,key:E},{default:a(()=>[e(b,{responsive:"screen","item-responsive":""},{default:a(()=>[e(v,{span:"24 m:12",label:`附件${E+1}`,path:"notes"},{default:a(()=>[e(l(ne),{value:r.name,"onUpdate:value":I=>r.name=I,placeholder:"请输入",style:{width:"250px"}},null,8,["value","onUpdate:value"])]),_:2},1032,["label"]),e(v,{span:"24 m:12",label:"",path:"notes"},{default:a(()=>{var I,te,ae;return[(I=r.url)!=null&&I.split("?")[1]||(te=r.file)!=null&&te.name?(j(),oe("span",st,[q(N(((ae=r.url)==null?void 0:ae.split("?")[1])||r.file.name)+" ",1),le("span",{class:"cursor-pointer c-#c92a2a",onClick:de=>{r.url="",r.file=void 0,r.name=""}},"删除",8,rt),r.url?(j(),oe("span",{key:0,class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:de=>h(r.url)},"下载",8,it)):ve("",!0)])):(j(),A(D,{key:1,style:{width:"auto","margin-left":"20px"},ref_for:!0,ref:"uploadRef",action:"#","custom-request":de=>Z(de,E),"show-file-list":!1,onBeforeUpload:K},{default:a(()=>[e(l(R),{size:"small",ghost:"",type:"primary"},{default:a(()=>o[6]||(o[6]=[q(N("选择文件"))])),_:1,__:[6]})]),_:2},1032,["custom-request"]))]}),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1},8,["model"]),m.value[x.value]&&B.value?(j(),oe("div",ct,[le("div",ut,[le("span",null,N(m.value[x.value].filename||m.value[x.value].name),1),le("span",null,N(m.value[x.value].indexText),1)]),e(ie,{percentage:m.value[x.value].progress,status:m.value[x.value].status==="error"?"error":"success","show-indicator":""},null,8,["percentage","status"])])):ve("",!0)]),_:1})]),_:1},8,["show","title"])}}}),pt=fe({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:me(["reset","search","clear"],["update:model"]),setup($,{emit:H}){const z=H,{formRef:L,restoreValidation:w}=Ce(),t=ke($,"model"),C=we(),d=S([]),{pageData:_,getData:g,nextPage:J}=Ne(je),M=async i=>{const u=i.currentTarget,k=u.scrollTop;u.scrollTop+u.offsetHeight>=u.scrollHeight&&_.data.length<_.total&&(await J(),d.value=_.data,await Te(),setTimeout(()=>{u.scrollTop=k}))},Q=async i=>{var u;U.value=!0,i?(t.value.pid=i,z("search"),C.setProjectInfo({pname:(u=d.value.find(k=>k.id==i))==null?void 0:u.proname,pid:i})):z("clear")},Y=be.debounce(async i=>{await g({fuzzy:i,page:1}),d.value=_.data},300),P=S(!1),U=S(!1),T=i=>{if(t.value.pid=null,P.value=!0,U.value=!1,!i){O();return}Y(i)},W=async()=>{P.value&&!U.value&&(await g({page:1}),d.value=_.data,P.value=!1)},O=async()=>{await g({page:1}),d.value=_.data};(async()=>{var i,u;await g({fuzzy:C.userInfo.pname}),d.value=_.data,t.value.pid=C.userInfo.pid?C.userInfo.pid:(i=d.value[0])==null?void 0:i.id,t.value.pid&&(C.setProjectInfo({pid:t.value.pid,pname:(u=d.value.find(k=>k.id==t.value.pid))==null?void 0:u.proname}),z("search"))})();async function X(){await w(),t.value.fuzzy="",z("reset")}async function G(){var i,u;t.value.pid?z("search"):((i=window.$message)==null||i.destroyAll(),(u=window.$message)==null||u.warning("请选择项目"))}return(i,u)=>{const k=Se,p=ze,s=lt,h=R,B=ot,x=_e,m=$e,Z=xe,V=De;return j(),A(V,{bordered:!1,size:"small",class:"card-wrapper"},{default:a(()=>[e(Z,{ref_key:"formRef",ref:L,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Je(G,["enter"])},{default:a(()=>[e(m,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:a(()=>[e(p,{span:"24 s:12 m:6",label:"项目列表",path:"PrjId"},{default:a(()=>[e(k,{filterable:"",clearable:"",value:t.value.pid,"onUpdate:value":[u[0]||(u[0]=K=>t.value.pid=K),Q],placeholder:"请选择项目","label-field":"proname","value-field":"id",options:d.value,onScroll:M,onClear:O,onSearch:T,onBlur:W},null,8,["value","options"])]),_:1}),e(p,{span:"24  s:12 m:6",class:"pr-24px"},{default:a(()=>[e(x,{class:"w-full"},{default:a(()=>[e(h,{onClick:X},{icon:a(()=>[e(s,{class:"text-icon"})]),default:a(()=>[q(" "+N(l(F)("common.reset")),1)]),_:1}),e(h,{type:"primary",ghost:"",onClick:G},{icon:a(()=>[e(B,{class:"text-icon"})]),default:a(()=>[q(" "+N(l(F)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),mt={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function ye($){return typeof $=="function"||Object.prototype.toString.call($)==="[object Object]"&&!tt($)}const St=fe({name:"projectmanagement_needchange",__name:"index",setup($){const H=Qe(),{columns:z,columnChecks:L,data:w,getData:t,loading:C,pagination:d,mobilePagination:_,searchParams:g}=at({showTotal:!0,immediate:!1,apiFn:Ze,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"reqcontent",title:"需求内容",align:"center",width:120},{key:"customer",title:"客户联系人",align:"center",width:120},{key:"cstcontact",title:"联系方式",align:"center",width:120},{key:"cstresult",title:"结果",align:"center",width:120,render(p){return et("div",{},p.cstresult==0?"失败":p.cstresult==1?"成功":"")}},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"操作人",align:"center",width:120},{key:"dbtime",title:"操作时间",align:"center",width:120},{key:"operate",title:F("common.operate"),align:"center",width:140,fixed:"right",render:p=>{let s;return e("div",{class:"flex-center gap-8px"},[ue(e(R,{type:"primary",ghost:!0,size:"small",onClick:()=>G(p.id)},ye(s=F("common.edit"))?s:{default:()=>[s]}),[[pe("no-auth"),"project:Customer:update"]]),e(he,{onPositiveClick:()=>X(p.id)},{default:()=>F("common.confirmDelete"),trigger:()=>{let h;return ue(e(R,{type:"error",ghost:!0,size:"small"},ye(h=F("common.delete"))?h:{default:()=>[h]}),[[pe("no-auth"),"project:Customer:delete"]])}})])}}]}),J=()=>{w.value=[],d.itemCount=0},{drawerVisible:M,operateType:Q,editingData:Y,handleAdd:P,handleEdit:U,checkedRowKeys:T,onBatchDeleted:W,onDeleted:O}=nt(w,t);Ye(async()=>{});async function se(){console.log(T.value),i(T.value.join(","),p=>{W()})}async function X(p){const{data:s,error:h}=await ge(p,g.pid);h||O()}function G(p){U(p)}async function i(p,s){const{data:h,error:B}=await ge(p,g.pid);if(!B)s&&s(h);else return!1}const u=p=>{t()},k=()=>{t()};return(p,s)=>{const h=_e,B=qe,x=Be,m=Ue,Z=We,V=De,K=pe("no-auth");return j(),oe("div",mt,[e(pt,{model:l(g),"onUpdate:model":s[0]||(s[0]=y=>ce(g)?g.value=y:null),onReset:k,onSearch:l(t),onClear:J},null,8,["model","onSearch"]),e(V,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:a(()=>[e(h,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:a(()=>s[4]||(s[4]=[le("div",null,"需求变更",-1)])),_:1,__:[4]})]),"header-extra":a(()=>[e(h,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:a(()=>[ue((j(),A(l(R),{onClick:l(P),size:"small",ghost:"",type:"primary"},{icon:a(()=>[e(B,{class:"text-icon"})]),default:a(()=>[s[5]||(s[5]=q(" "+N("新增")))]),_:1,__:[5]},8,["onClick"])),[[K,"project:Customer:insert"]]),e(l(he),{onPositiveClick:se},{trigger:a(()=>[ue((j(),A(l(R),{size:"small",ghost:"",type:"error",disabled:l(T).length==0},{icon:a(()=>[e(x,{class:Xe(["text-icon",{"animate-spin":l(C)}])},null,8,["class"])]),default:a(()=>[s[6]||(s[6]=q(" "+N("批量删除")))]),_:1,__:[6]},8,["disabled"])),[[K,"project:Customer:delete"]])]),default:a(()=>[s[7]||(s[7]=q(" 确定要删除选中的吗？ "))]),_:1,__:[7]}),e(m,{columns:l(L),"onUpdate:columns":s[1]||(s[1]=y=>ce(L)?L.value=y:null),ctype:13},null,8,["columns"])]),_:1})]),default:a(()=>[e(Z,{"checked-row-keys":l(T),"onUpdate:checkedRowKeys":s[2]||(s[2]=y=>ce(T)?T.value=y:null),columns:l(z),data:l(w),size:"small","flex-height":!l(H).isMobile,loading:l(C),remote:"","row-key":y=>y.id,pagination:l(_),class:"sm:h-full","onUpdate:filters":u},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),e(dt,{visible:l(M),"onUpdate:visible":s[3]||(s[3]=y=>ce(M)?M.value=y:null),onSubmitted:l(t),pid:l(g).pid,"operate-type":l(Q),"row-data":l(Y)},null,8,["visible","onSubmitted","pid","operate-type","row-data"])]),_:1})])}}});export{St as default};
