import{_ as ue}from"./round-search-DI_38Hoo.js";import{d as ne,r as k,a as V,at as oe,i as se,dP as de,b as D,o as y,e as h,z as B,aT as re,aX as ie,g as j,t as R,cL as me,aP as ve,V as pe,aJ as fe,av as ce,M as ge,a$ as ae,eE as he,f7 as ye,f as d,aS as be,az as we,w as _,c as S,h as g,aA as ke,N as Fe,A as Te,au as xe,aD as le,B as _e,$ as De,U as Me,aI as Ce,b4 as Ee,aU as Ae}from"./index-9CCyyUlU.js";import{d as $e}from"./home-mlDGjyLN.js";import{u as Oe}from"./usePageData-BXqTxcmW.js";import{N as ee}from"./RadioButton-C1T2uxP0.js";import{N as te}from"./DatePicker-WBRN1db9.js";const Se={class:"map-wrapper",style:{height:"100%",position:"relative"}},je={class:"map-legend"},Be={class:"legend-list"},ze=["onClick","onContextmenu"],Ne={key:0,class:"visibility-icon"},Pe={key:1,class:"solo-icon"},Ue={class:"legend-name"},Ve={class:"visibility-toggle"},Ie={key:0,class:"solo-notice"},Le=ne({__name:"historyMap",props:{trackData:{}},setup(A){const u=k(null);let M=null;const Y=A,C=k([]),v=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],a=k({}),b=k(""),$=V(()=>{const e={};return Object.keys(C.value).forEach((n,l)=>{e[n]=v[l%v.length],a.value[n]===void 0&&(a.value[n]=!0)}),e});function x(e){if(b.value){I(e);return}a.value[e]=!a.value[e],F()}function I(e){b.value===e?z():(b.value=e,Object.keys(a.value).forEach(t=>{a.value[t]=t===e}),F())}function z(){b.value="",Object.keys(a.value).forEach(e=>{a.value[e]=!0}),F()}function N(){Object.keys(a.value).forEach(e=>{a.value[e]=!a.value[e]}),b.value="",F()}function Z(){Object.keys(a.value).forEach(e=>{a.value[e]=!0}),b.value="",F()}function H(){Object.keys(a.value).forEach(e=>{a.value[e]=!1}),b.value="",F()}const O=V(()=>{const e=[];return Object.values(C.value).forEach(t=>{e.push(...t)}),e.sort((t,n)=>new Date(t.dbtime).getTime()-new Date(n.dbtime).getTime())}),q=V(()=>{if(O.value.length===0)return[120.370086,30.305716];const e=O.value.map(i=>i.longitude),t=O.value.map(i=>i.latitude),n=(Math.min(...e)+Math.max(...e))/2,l=(Math.min(...t)+Math.max(...t))/2;return console.log(n,l),[n,l]});async function P(){const e="/map-sdk.json",{data:t}=await fe.get(`${e}?_t=${Date.now()}`);return t}function L(e){return new Promise((t,n)=>{if(window.AMap)return t(window.AMap);const l=document.createElement("script");l.src=`https://webapi.amap.com/maps?v=2.0&key=${e}&plugin=AMap.PolylineEditor`,l.defer=!0,l.onload=()=>window.AMap?t(window.AMap):n(new Error("AMapåŠ è½½å¤±è´¥")),l.onerror=()=>n(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(l)})}const f=k({});function U(e,t){const n=t.lng-e.lng,l=t.lat-e.lat;return(Math.atan2(-l,n)*180/Math.PI-90+360)%360-175}function G(e,t,n,l){const i=document.createElement("div");return i.style.cssText=`
    width: 12px;
    height: 18px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 18px solid ${l};
    transform: translate(-50%, -50%) rotate(${n}deg);
    transform-origin: center center;
  `,new e.Marker({position:[t.lng,t.lat],content:i,offset:new e.Pixel(0,0)})}function J(e,t,n,l,i){const r=document.createElement("div");return r.className="custom-marker",r.style.transform="translate(calc(-50% + 4px),-120%)",r.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${l};box-shadow: 0 0 5px ${l}, 0 0 6px ${l};">
      <img src="${i||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png"}" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${l};">${n}</div>
  `,new e.Marker({position:[t.lng,t.lat],content:r})}function K(){u.value&&u.value.clearMap(),f.value={}}function F(){!window.AMap||!u.value||Object.keys(f.value).forEach(e=>{const t=a.value[e];(f.value[e]||[]).forEach(l=>{t?l.show():l.hide()})})}function W(e){if(!u.value)return;K();const t={};Object.entries(C.value).forEach(([l,i])=>{t[l]=i.map(r=>({lng:r.longitude,lat:r.latitude,address:r.address,dbtime:r.dbtime,proname:r.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:r.duration||0,userimage:r.userimage,longitude:r.longitude,latitude:r.latitude}))}),Object.keys(t).forEach(l=>{const i=t[l],r=$.value[l];if(i.length===0)return;const p=[];if(i.length>1){const m=new e.Polyline({path:i.map(w=>[w.lng,w.lat]),strokeColor:r,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});m.setMap(u.value),p.push(m)}i.forEach((m,w)=>{new e.Marker({position:[m.longitude,m.latitude],content:'<div class="marker-dot"></div>',anchor:"center",offset:new e.Pixel(0,0)}).setMap(u.value);const T=J(e,m,l,r,i[0].userimage);T.setMap(u.value),p.push(T),T.on("click",()=>{const X=`
          <div style="min-width:220px; background:#fff; padding:12px 14px; font-size:13px; color:#333; line-height:1.6">
            <div style="font-weight:bold; color:${r}; font-size:15px; margin-bottom:6px; border-bottom:1px solid #f0f0f0; padding-bottom:4px">
              ${l}
            </div>
            <div><b style="color:#555">åœ°ç‚¹ï¼š</b>${m.address}</div>
            <div><b style="color:#555">æ—¶é—´ï¼š</b>${m.dbtime}</div>
            <div><b style="color:#555">é¡¹ç›®ï¼š</b>${m.proname}</div>
            <div><b style="color:#555">ç»çº¬åº¦ï¼š</b><span style="font-size:12px;color:#666">${m.longitude}, ${m.latitude}</span></div>

          </div>
          <div style="margin-top:8px; text-align:right; font-size:12px; color:#999">ç¬¬ ${w+1} ä¸ªæ‰“å¡ç‚¹</div>
        `;M.setContent(X),M.setOffset(new e.Pixel(4,-60)),M.open(u.value,T.getPosition())}),T.on("dblclick",()=>{M.open(u.value,T.getPosition()),u.value.setCenter(T.getPosition()),u.value.setZoom(14)})});for(let m=1;m<i.length;m++){const w=i[m-1],E=i[m];if(s(w,E))continue;const T={lng:(w.lng+E.lng)/2,lat:(w.lat+E.lat)/2},X=U(w,E),Q=G(e,T,X,r);Q.isArrow=!0,Q.setMap(u.value),p.push(Q)}Object.keys(t).length==1&&u.value.setFitView(p,!1,[60,60,60,60]),f.value[l]=p});const n=()=>{const i=u.value.getZoom()>=7,r=o(f.value,a.value);Object.values(r).forEach(p=>{p==null||p.forEach(m=>{m.isArrow&&(i?m.show():m.hide())})})};u.value.on("zoomend",n),n(),Object.keys(f.value).forEach(l=>{(f.value[l]||[]).forEach(r=>{r.isArrow||(a.value[l]?r.show():r.hide())})})}function o(e,t){const n={};for(const l in e)t[l]&&(n[l]=e[l]);return n}function s(e,t,n=1e-7){return Math.abs(e.lng-t.lng)<n&&Math.abs(e.lat-t.lat)<n}async function c(){try{const e=await P(),t=await L(e.AMAP_SDK_KEY);u.value=new t.Map("amap-container",{viewMode:"2D",center:q.value,zoom:5,features:["bg","point"]}),t.plugin(["AMap.Scale","AMap.ToolBar"],()=>{u.value.addControl(new t.Scale),u.value.addControl(new t.ToolBar)}),u.value.on("zoomend",()=>{const l=u.value.getZoom()>=12,i=o(f.value,a.value);Object.values(i).forEach(r=>{r.forEach(p=>{p.isArrow&&(l?p.show():p.hide())})})}),M=new t.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),W(t)}catch(e){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",e)}}return oe(()=>Y.trackData??[],e=>{console.log(e,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),C.value=e,window.AMap&&u.value&&W(window.AMap)},{immediate:!0,deep:!0}),se(()=>{c()}),de(()=>{u.value&&u.value.destroy()}),(e,t)=>(y(),D("div",Se,[t[1]||(t[1]=h("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),h("div",je,[h("div",{class:"legend-header"},[t[0]||(t[0]=h("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),h("div",{class:"legend-actions"},[h("button",{class:"action-btn",onClick:Z},"å…¨æ˜¾"),h("button",{class:"action-btn",onClick:H},"å…¨éš"),h("button",{class:"action-btn",onClick:N},"åé€‰")])]),h("div",Be,[(y(!0),D(re,null,ie($.value,(n,l)=>(y(),D("div",{key:l,class:ve(["legend-item",{"legend-item-hidden":!a.value[l],"legend-item-solo":b.value===l}]),onClick:i=>x(l),onContextmenu:me(i=>I(l),["prevent"])},[h("div",{class:"legend-color",style:pe({backgroundColor:n})},[a.value[l]?B("",!0):(y(),D("span",Ne,"ğŸ‘ï¸â€ğŸ—¨ï¸")),b.value===l?(y(),D("span",Pe,"â­")):B("",!0)],4),h("span",Ue,R(l),1),h("span",Ve,R(a.value[l]?"éšè—":"æ˜¾ç¤º"),1)],42,ze))),128))]),b.value?(y(),D("div",Ie,[j(" ä»…æ˜¾ç¤º: "+R(b.value)+" ",1),h("button",{class:"cancel-solo-btn",onClick:z},"å–æ¶ˆ")])):B("",!0)])]))}}),We=ce(Le,[["__scopeId","data-v-6571a729"]]),Re={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Ye(A){return typeof A=="function"||Object.prototype.toString.call(A)==="[object Object]"&&!Ae(A)}const Ze=ne({name:"trajectory_historytrajectory",__name:"index",setup(A){const u=ge();function M(o){return o.getFullYear()}function Y(o){const s=new Date(o.getFullYear(),0,1),c=(o.getTime()-s.getTime())/864e5,e=s.getDay()||7;return Math.ceil((c+e)/7)}function C(){const o=new Date,s=M(o),c=Y(o).toString().padStart(2,"0");return`${s}-${c}å‘¨`}const v=k("week"),a=k({dayTime:String(ae(0,null)),monthTime:String(ae(3,null)),weekTime:C(),startTime:null,endTime:null,dates:null,creater:null}),b=k([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),$=k("table"),x=k({}),I=V(()=>Object.keys(x.value||{}).map(o=>{var s,c;return{key:o,name:o,userimage:(c=(s=x.value[o])==null?void 0:s[0])==null?void 0:c.userimage}})),z=V(()=>{const o=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left",render(c){return d("div",{class:"text-blue-600 flex-col items-center font-medium"},[d(be,{width:"60",height:"60","preview-disabled":!0,src:c.userimage||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png",class:"rounded-md object-cover"},null),d("span",null,[c.name])])}}];let s=[];switch(v.value){case"week":a.value.startTime&&a.value.endTime&&(s=ye(a.value.startTime,a.value.endTime).map(e=>N(e)));break;case"month":a.value.monthTime&&(s=he(a.value.monthTime).map(e=>N(e)));break;case"day":default:a.value.dayTime&&(s=[N(a.value.dayTime)]);break}return[...o,...s]}),N=o=>({title:Z(o),key:o,width:300,align:"center",render:s=>H(s.name,o)}),Z=o=>{const s=new Date(o),c=s.getMonth()+1,e=s.getDate(),t=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][s.getDay()];return`${c}/${e} å‘¨${t}`},H=(o,s)=>{let c;const t=(x.value[o]||[]).filter(n=>n.daytime===s);return t.length===0?d("div",{class:"text-gray-400 text-sm"},[j("æ— è®°å½•")]):d("div",{class:"text-left space-y-1"},[d(we,{style:"max-height: 250px;",trigger:"none"},Ye(c=t.map((n,l)=>d("div",{key:l,class:"tableItem p-1 border-b border-gray-100 last:border-b-0"},[d("div",null,[j("é¡¹ç›®ï¼š"),d("span",{class:""},[n.proname||"æš‚æ— é¡¹ç›®"])]),d("div",null,[j("åœ°å€ï¼š "),d("span",{class:""},[n.address])]),d("div",null,[j("æ‰“å¡æ—¶é—´ï¼š"),d("span",{class:""},[n.dbtime])])])))?c:{default:()=>[c]})])},O=o=>{const s=o.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!s)return null;const c=Number(s[1]),e=Number(s[2]),t=new Date(c,0,1+(e-1)*7),n=t.getDay(),l=new Date(t);n<=4?l.setDate(t.getDate()-t.getDay()+1):l.setDate(t.getDate()+8-t.getDay());const i=new Date(l);i.setDate(l.getDate()+6);const r=p=>{const m=p.getFullYear(),w=String(p.getMonth()+1).padStart(2,"0"),E=String(p.getDate()).padStart(2,"0");return`${m}-${w}-${E}`};return{start:r(l),end:r(i)}},q=o=>{x.value={},v.value=o,L()},P=o=>{L(o),f()},L=o=>{switch(v.value){case"week":if(o){const s=O(o);s&&(a.value.startTime=s.start,a.value.endTime=s.end)}break;case"month":a.value.dates=o||a.value.monthTime;break;case"day":default:a.value.dates=o||a.value.dayTime;break}},f=async()=>{try{const o={};a.value.creater&&(o.creater=a.value.creater),v.value==="week"?(o.startTime=a.value.startTime,o.endTime=a.value.endTime):v.value==="month"?o.dates=a.value.monthTime:o.dates=a.value.dayTime;const{data:s,error:c}=await $e(o);c||(x.value=s)}catch(o){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",o)}},{pageData:U,getData:G,nextPage:J}=Oe(Ee),K=async o=>{const s=o.currentTarget,c=s.scrollTop;s.scrollTop+s.offsetHeight>=s.scrollHeight&&U.data.length<U.total&&(await J(),await Ce(),setTimeout(()=>{s.scrollTop=c}))},F=k(1),W=async o=>{a.value.creater=o,o||setTimeout(()=>{F.value++},500),f()};return oe([v,()=>a.value.dates],()=>{if(v.value=="week"&&a.value.weekTime){const o=O(a.value.weekTime);o&&(a.value.startTime=o.start,a.value.endTime=o.end),f()}else(v.value=="month"&&a.value.monthTime||v.value=="day"&&a.value.dayTime)&&f()},{immediate:!0}),se(()=>{a.value.weekTime=C(),G({usertypes:"2,3"}),f()}),(o,s)=>{const c=xe,e=Te,t=ue;return y(),D("div",Re,[d(g(Me),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:_(()=>[d(g(Fe),{align:"center"},{default:_(()=>[s[6]||(s[6]=h("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),d(e,{label:"ç”¨æˆ·",path:"creater","label-placement":"left","show-feedback":!1},{default:_(()=>[d(c,{clearable:"",filterable:"",value:a.value.creater,"onUpdate:value":[s[0]||(s[0]=n=>a.value.creater=n),W],placeholder:"è¯·é€‰æ‹©","label-field":"username",size:"small","value-field":"id",options:g(U).data,onScroll:K},null,8,["value","options"])]),_:1}),d(g(le),{value:v.value,"onUpdate:value":[s[1]||(s[1]=n=>v.value=n),q],size:"small"},{default:_(()=>[(y(!0),D(re,null,ie(b.value,n=>(y(),S(g(ee),{key:n.value,value:n.value,label:n.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),v.value==="day"?(y(),S(g(te),{key:0,size:"small","formatted-value":a.value.dayTime,"onUpdate:formattedValue":[s[2]||(s[2]=n=>a.value.dayTime=n),P],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):B("",!0),v.value==="week"?(y(),S(g(te),{key:1,size:"small","formatted-value":a.value.weekTime,"onUpdate:formattedValue":[s[3]||(s[3]=n=>a.value.weekTime=n),P],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):B("",!0),v.value==="month"?(y(),S(g(te),{key:2,size:"small","formatted-value":a.value.monthTime,"onUpdate:formattedValue":[s[4]||(s[4]=n=>a.value.monthTime=n),P],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):B("",!0),d(g(_e),{type:"primary",onClick:f,size:"small",class:"w-full sm:w-auto"},{icon:_(()=>[d(t,{class:"text-icon"})]),default:_(()=>[j(" "+R(g(De)("common.search")),1)]),_:1}),d(g(le),{size:"small",value:$.value,"onUpdate:value":s[5]||(s[5]=n=>$.value=n),name:"radiobuttongroup1"},{default:_(()=>[d(g(ee),{value:"table",label:"è¡¨æ ¼"}),d(g(ee),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:_(()=>[$.value=="table"?(y(),S(g(ke),{key:0,columns:z.value,data:I.value,size:"small","flex-height":!g(u).isMobile,"scroll-x":z.value.reduce((n,l)=>n+l.width,0),remote:"","row-key":n=>n.key,class:"h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","row-key"])):(y(),S(We,{trackData:x.value,key:F.value},null,8,["trackData"]))]),_:1})])}}}),Qe=ce(Ze,[["__scopeId","data-v-b6785915"]]);export{Qe as default};
