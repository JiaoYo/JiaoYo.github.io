import{_ as Bt}from"./table-column-setting.vue_vue_type_script_setup_true_lang-C_eTRE9G.js";import{_ as Jt}from"./round-delete-BR4xLn1t.js";import{_ as qt}from"./round-add-C8B53gbo.js";import{d as Ee,aq as Le,p as yt,s as $e,r as P,q as _t,$ as x,W as u,A as F,B as g,an as dt,at as he,a as Gt,ar as Qe,a1 as bt,b as St,o as te,a5 as Kt,f as a,aw as Ht,w as l,as as Wt,F as wt,E as kt,c as ye,y as We,h as s,au as Ne,am as Xt,e as H,N as ie,g as _,av as Ze,t as re,b6 as Ct,a2 as Yt,bp as Qt,bZ as Zt,U as et,a8 as ct,ab as Oe,ac as ea,L as ta,c0 as aa,bY as na,i as sa,x as ze,az as Fe,C as we,bl as la,aa as oa,aC as ia}from"./index-4KD-vN5g.js";import{i as ra,j as ua,g as da,h as pt,w as ca,x as pa,u as ma,v as mt,Q as Dt,R as ft,S as fa,T as gt,U as ga,V as va,W as ha,M as vt,O as ya,A as _a,C as ba,k as Sa,L as wa,a as ka,N as Ca,s as Da,o as xa,X as ht,f as za}from"./project-7u2zw58B.js";import{u as Ye,a as Na}from"./table-CMF0XvP8.js";import{_ as Pa}from"./round-plus-CC7AVHTO.js";import{_ as Ia,a as ja,A as Ta}from"./index-DlOnVpi_.js";import{f as tt,g as Aa,h as xt,p as Ua,d as $a}from"./business-aihDdTLH.js";import{u as Fa}from"./usePageData-qV_ZYP2C.js";import{v as La}from"./v4-FuVw324d.js";import{N as ke}from"./Popconfirm-BZ6JUSak.js";import{_ as zt}from"./Grid-2C9g2pEs.js";import{_ as Nt}from"./FormItemGridItem-2xSWM4_z.js";import{N as Oa}from"./Upload-B6kV4XIm.js";import{_ as Ea}from"./round-search-BAjusteF.js";import{_ as Ma}from"./round-refresh-mVkdoSVJ.js";import{N as Ra}from"./DatePicker-C6EJG8c4.js";import{N as Va}from"./RadioButton-CwRqyg9o.js";import{N as Ba}from"./Progress-IaMeDIfx.js";import"./utils-O9K5fIQg.js";const Ja={style:{display:"flex","flex-direction":"column"}},qa={style:{display:"flex","flex-direction":"column"}},Ga={style:{display:"flex","flex-direction":"column"}},Ka=Ee({name:"OperateDrawer",__name:"operate-drawer",props:Le({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:Le(["submitted"],["update:visible"]),setup(L,{emit:W}){const k=yt(),B=W,O=$e({contactList:[],debuggedDevieceList:[]}),r=L,o=$e(X());function X(){return{proname:"",dispatchIds:[],contractIds:[],proaddr:"",cpdbtime:null,prosite:"",longitude:120.373885,latitude:30.303899,period:void 0,dtype:void 0,dispatch:"",status:1}}const I=P(0);async function Y(){Object.assign(o,X()),Et(),r.operateType==="edit"&&r.rowData&&(Object.assign(o,r.rowData),I.value=o.period,await ot(),rt(o.proaddr||o.prosite),$t())}const{formRef:M,validate:v,restoreValidation:S}=_t(),ue={proname:{type:"string",required:!0,trigger:["blur","change"],message:"请输入项目名称"},status:{type:"number",required:!0,trigger:["blur","change"],message:"请选择项目状态"},contractIds:{type:"array",required:!0,trigger:["blur","change"],message:"请选择合同"},dtype:{type:"number",required:!0,trigger:["blur","change"],message:"请选择调试类型"},period:{type:"number",required:!0,trigger:["blur","change"],message:"请输入周期"},prosite:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请选择项目地点"},cpdbtime:{type:"string",required:!0,trigger:["blur","change"],message:"请选择时间"}},f=P([]),j=$e({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",pageSizes:[20],prefix:()=>`共 ${f.value.length} 条`,onChange:e=>{j.page=e,h()},onUpdatePageSize:e=>{j.pageSize=e,j.page=1,h()}}),de=[{title:"姓名",key:"pname",align:"center",render(e,t){return e.setStatus?u(F,{value:e.pname,placeholder:"请输入姓名",onUpdateValue(n){f.value[t].pname=n}}):u("div",{},e.pname)}},{title:"联系方式",key:"pcontact",align:"center",render(e,t){return e.setStatus?u(F,{value:e.pcontact,placeholder:"请输入联系方式",onUpdateValue(n){f.value[t].pcontact=n}}):u("div",{},e.pcontact)}},{title:"备注",key:"proposition",align:"center",render(e,t){return e.setStatus?u(F,{value:e.proposition,placeholder:"请输入备注",onUpdateValue(n){f.value[t].proposition=n}}):u("div",{},e.proposition)}},{key:"operate",title:x("common.operate"),align:"center",minWidth:120,fixed:"right",render(e,t){return u("div",{class:"flex-center gap-8px"},[e.setStatus?[u(g,{type:"primary",ghost:!0,size:"small",onClick:()=>ce(e)},{default:()=>"保存"}),u(g,{type:"default",ghost:!0,size:"small",onClick:()=>ae(e,t)},{default:()=>"取消"}),u(ke,{onPositiveClick:()=>{r.operateType==="edit"&&e.id?ra(e.id).then(()=>{var n;f.value.splice(t,1),(n=window.$message)==null||n.success("删除成功")}):f.value.splice(t,1)}},{default:()=>x("common.confirmDelete"),trigger:()=>u(g,{type:"error",ghost:!0,size:"small"},{default:()=>x("common.delete")})})]:u(g,{type:"primary",ghost:!0,size:"small",onClick:()=>T(e)},{default:()=>"编辑"})])}}],h=async()=>{var t;const{data:e}=await ua({page:j.page,limit:j.pageSize,pid:(t=r.rowData)==null?void 0:t.id});f.value=e==null?void 0:e.list,f.value.forEach(n=>{n.setStatus=!1}),O.contactList=JSON.parse(JSON.stringify(f.value))},T=e=>{f.value.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus},ae=(e,t)=>{e.setStatus=!e.setStatus,e.id?f.value=JSON.parse(JSON.stringify(O.contactList)):f.value.splice(t,1)},ce=async e=>{var t,n,m,y,b;if(!e.pname){(t=window.$message)==null||t.warning("请输入联系人姓名");return}if(!e.pcontact){(n=window.$message)==null||n.warning("请输入联系方式");return}if(r.operateType==="edit")if(e.id){const{data:z,error:C}=await da([e]);C||((m=window.$message)==null||m.success("修改成功"),h(),e.setStatus=!e.setStatus)}else{const{data:z,error:C}=await pt([{...e,pid:(y=r.rowData)==null?void 0:y.id}]);C||((b=window.$message)==null||b.success("添加成功"),h(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function pe(){var e;((e=f.value[0])!=null&&e.pname||f.value.length==0)&&f.value.unshift({pname:"",pcontact:"",proposition:"",setStatus:!0})}const c=P([]),A=$e({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",pageSizes:[20],prefix:()=>`共 ${c.value.length} 条`,onChange:e=>{A.page=e,ne()},onUpdatePageSize:e=>{A.pageSize=e,A.page=1,ne()}}),U=[{title:"设备名称",key:"devname",align:"center",render(e,t){return e.setStatus?u(F,{value:e.devname,placeholder:"请输入设备名称",onUpdateValue(n){c.value[t].devname=n}}):u("div",{},e.devname)}},{title:"型号",key:"devmodel",align:"center",render(e,t){return e.setStatus?u(F,{value:e.devmodel,placeholder:"请输入型号",onUpdateValue(n){c.value[t].devmodel=n}}):u("div",{},e.devmodel)}},{title:"数量",key:"devnum",align:"center",render(e,t){return e.setStatus?u(dt,{value:e.devnum,placeholder:"请输入数量",onUpdateValue(n){c.value[t].devnum=Number(n)||0}}):u("div",{},e.devnum)}},{title:"是否为我司设备",key:"etype",align:"center",render(e,t){return e.setStatus?u(he,{value:e.etype,options:[{label:"是",value:0},{label:"否",value:1}],onUpdateValue(n){c.value[t].etype=n}}):u("div",{},e.etype===0?"是":"否")}},{title:"设备厂家",key:"devmanu",align:"center",render(e,t){return e.setStatus?u(F,{value:e.devmanu,placeholder:"请输入设备厂家",onUpdateValue(n){c.value[t].devmanu=n}}):u("div",{},e.devmanu)}},{title:"备注",key:"notes",align:"center",render(e,t){return e.setStatus?u(F,{value:e.notes,placeholder:"请输入备注",onUpdateValue(n){c.value[t].notes=n}}):u("div",{},e.notes)}},{title:"清点状态",key:"status",align:"center",render(e,t){return e.setStatus?u(he,{value:e.status,options:[{label:"未清点",value:0},{label:"正常",value:1},{label:"增补",value:2},{label:"退货",value:3},{label:"换货",value:4}],onUpdateValue(n){c.value[t].status=n}}):u("div",{},e.status===0?"未清点":e.status===1?"正常":e.status===2?"增补":e.status===3?"退货":"换货")}},{key:"operate",title:x("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return u("div",{class:"flex-center gap-8px"},[e.setStatus?[u(g,{type:"primary",ghost:!0,size:"small",onClick:()=>Re(e)},{default:()=>"保存"}),u(g,{type:"default",ghost:!0,size:"small",onClick:()=>Me(e,t)},{default:()=>"取消"}),u(ke,{onPositiveClick:()=>{r.operateType==="edit"&&e.id?ca(e.id).then(()=>{var n;c.value.splice(t,1),(n=window.$message)==null||n.success("删除成功")}):c.value.splice(t,1)}},{default:()=>x("common.confirmDelete"),trigger:()=>u(g,{type:"error",ghost:!0,size:"small"},{default:()=>x("common.delete")})})]:u(g,{type:"primary",ghost:!0,size:"small",onClick:()=>Pe(e)},{default:()=>"编辑"})])}}],ne=async()=>{var t;const{data:e}=await pa({page:A.page,limit:A.pageSize,fuzzy:A.fuzzy,pid:(t=r.rowData)==null?void 0:t.id});c.value=e.list,O.debuggedDevieceList=JSON.parse(JSON.stringify(c.value))},Pe=e=>{c.value.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus},Me=(e,t)=>{e.setStatus=!e.setStatus,e.id?c.value=JSON.parse(JSON.stringify(O.debuggedDevieceList)):c.value.splice(t,1)},Re=async e=>{var n,m,y,b,z,C;if(!e.devname){(n=window.$message)==null||n.warning("设备名称不能为空");return}if(!e.devmodel){(m=window.$message)==null||m.warning("设备型号不能为空");return}if(!e.devnum){(y=window.$message)==null||y.warning("设备数量不能为空");return}const t=e.dcreater*1;if(r.operateType==="edit")if(e.id){const{data:E,error:N}=await ma([{...e,dcreater:t}]);N||((b=window.$message)==null||b.success("修改成功"),ne(),e.setStatus=!e.setStatus)}else{const{data:E,error:N}=await mt([{...e,pid:(z=r.rowData)==null?void 0:z.id,dcreater:t}]);N||((C=window.$message)==null||C.success("添加成功"),ne(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function _e(){var e;((e=c.value[0])!=null&&e.devname||c.value.length==0)&&c.value.unshift({status:void 0,devmanu:"",etype:0,devname:"",devmodel:"",devnum:0,notes:"",setStatus:!0})}const Ve=P({}),J=P([]);async function Ie(){var t;J.value=[];const{data:e}=await Ca({page:1,limit:100,pid:(t=r.rowData)==null?void 0:t.id});e.list.forEach(n=>{n.sort==1&&J.value.push({id:n.id,name:n.filename,url:n.file,status:"finished",creator:n.username,dbtime:n.dbtime})}),J.value.reverse(),Ve.value=JSON.parse(JSON.stringify(e))}const i=[{title:"文件别名",key:"name",align:"center",width:200,render(e){return e.setStatus?u(F,{value:e.name,onUpdateValue:t=>{e.name=t}}):u("div",{},e.name)}},{title:"文件名称",key:"filename",align:"center",width:200,render(e){return e.setStatus&&!e.url?u(Oa,{action:"#",showFileList:!1,customRequest:async({file:n,onFinish:m,onError:y})=>{var b,z,C,E;try{const N=new FormData;N.append("multipartFile",n.file);const{data:K,error:Q}=await ka(N);if(Q){(z=(b=window.$message)==null?void 0:b.error)==null||z.call(b,"文件上传失败");return}K&&(e.url=K)}catch(N){console.error(N),(E=(C=window.$message)==null?void 0:C.error)==null||E.call(C,"文件上传出错")}}},{default:()=>u(g,{type:"info",size:"small",ghost:!0},{default:()=>"上传文件"})}):e.setStatus&&e.url&&!e.id?a("span",null,[e.url.split("?")[1],_(" "),a("span",{onClick:()=>e.url=""},[_("X")])]):u("div",{},e.url.split("?")[1])}},{title:"上传人",key:"creator",align:"center",width:100,render(e){return u("div",{},e.creator)}},{title:"上传时间",key:"dbtime",align:"center",width:200,render(e){return u("div",{},e.dbtime?e.dbtime:"")}},{title:"操作",key:"actions",align:"center",width:180,render(e){return u(ie,{justify:"center"},[!e.setStatus&&e.id&&u(g,{type:"info",size:"small",ghost:!0,onClick:()=>{d(e)}},{default:()=>"下载"}),e.setStatus&&u(g,{type:"info",size:"small",ghost:!0,onClick:()=>{me(e)}},{default:()=>"保存"}),e.setStatus&&u(g,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"取消"}),!e.setStatus&&u(g,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"编辑"})])}}];async function d(e){if(e!=null&&e.url)try{const n=await(await fetch(e.url.split("?")[0],{mode:"cors"})).blob(),m=URL.createObjectURL(n),y=document.createElement("a");y.href=m,y.download=e.url.split("?")[1],y.style.display="none",document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(m)}catch(t){console.error("下载失败:",t)}}const $=()=>{J.value.push({id:"",name:"",url:"",status:"uploading",setStatus:!0})},me=async e=>{var t,n,m,y,b,z,C,E,N,K,Q,ve;if(!e.name){(n=(t=window.$message)==null?void 0:t.warning)==null||n.call(t,"请输入文件别名");return}if(!e.url){(y=(m=window.$message)==null?void 0:m.warning)==null||y.call(m,"请上传文件");return}if((b=r.rowData)!=null&&b.id){const{data:p,error:De}=await vt([{pid:(z=r.rowData)==null?void 0:z.id,filename:e.name,file:e.url,sort:1}]);if(De)return(C=window.$message)==null?void 0:C.error("保存文件记录失败");(E=window.$message)==null||E.destroyAll(),e.setStatus=!e.setStatus,Ie(),(N=window.$message)==null||N.success("保存成功")}else if(e.id){const{data:p,error:De}=await wa([{id:e.id,filename:e.name}]);if(De)return(K=window.$message)==null?void 0:K.error("保存文件记录失败");(Q=window.$message)==null||Q.destroyAll(),e.setStatus=!e.setStatus,(ve=window.$message)==null||ve.success("编辑成功")}else e.setStatus=!e.setStatus},fe=Gt(()=>({add:"新增项目",edit:"修改项目"})[r.operateType]),ge=Qe(L,"visible");bt(ge,()=>{ge.value&&(Y(),setTimeout(()=>{const e=document.querySelector(".n-scrollbar-content");e==null||e.scrollTo(0,0)},300),S())});function Be(e){e||q()}function q(){ge.value=!1}function Je(){w.value=!1}async function je(){var e;await v(),(e=window.$dialog)==null||e.info({title:"提示",content:"确定提交吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await Te()}})}async function Te(){var e,t,n,m,y,b,z,C,E,N,K,Q,ve;if(r.operateType==="edit"){const p=JSON.parse(JSON.stringify(o));I.value==p.period&&delete p.period;const{data:De,error:He}=await Dt([p]);if(!He){let Z=function(ee,R){const V=ee.filter(oe=>!R.includes(oe)),be=R.filter(oe=>!ee.includes(oe));return{toDelete:V,toAdd:be}};if((e=o.dispatchIds)!=null&&e.length&&((t=o.dispatchIds)==null?void 0:t.length)>0){const{toDelete:ee,toAdd:R}=Z(st.value,o.dispatchIds);if(R.length>0){const V=R.map(Ue=>({pid:o.id,did:Ue})),{data:be,error:oe}=await ft(V)}if(ee.length>0){const{data:V,error:be}=await fa(ee.join(","))}}if((n=o.contractIds)!=null&&n.length&&((m=o.contractIds)==null?void 0:m.length)>0){const{toDelete:ee,toAdd:R}=Z(Rt.value,o.contractIds);if(R.length>0){const V=R.map(Ue=>({pid:o.id,did:Ue})),{data:be,error:oe}=await gt(V)}if(ee.length>0){const{data:V,error:be}=await ga(ee.join(","))}}q(),B("submitted"),(y=window.$message)==null||y.success("修改成功")}}else{const p=La(),{data:De,error:He}=await va([{...o,uuid:p}]);if(!He){const{data:Z,error:ee}=await ha(p);if(Z){let R=function(D,Se,ut){return D.map(xe=>({...xe,pid:Se}))};if(o.dispatchIds&&o.dispatchIds.length>0){const D=[];(b=o.dispatchIds)==null||b.forEach(async xe=>{D.push({pid:Z,did:xe})});const{data:Se,error:ut}=await ft(D)}if(o.contractIds&&o.contractIds.length>0){const D=[];(z=o.contractIds)==null||z.forEach(async xe=>{D.push({proid:Z,conid:xe})});const{data:Se,error:ut}=await gt(D)}const V=[];if(f.value.length>0){const D=R(f.value,Z);V.push(pt(D))}if(c.value.length>0){const D=R(c.value,Z);V.push(mt(D))}if((await Promise.allSettled(V)).forEach((D,Se)=>{D.status==="fulfilled"?console.log(`第 ${Se+1} 个请求成功`,D.value):console.error(`第 ${Se+1} 个请求失败`,D.reason)}),!J.value.length){(C=window.$message)==null||C.destroyAll(),(E=window.$message)==null||E.success("操作成功"),q(),B("submitted");return}const oe=[];J.value.forEach(D=>{oe.push({pid:Z,filename:D.name,file:D.url,sort:1})});const{data:Ue,error:Vt}=await vt(oe);Vt&&((N=window.$message)==null||N.error("保存文件记录失败")),(K=window.$message)==null||K.destroyAll(),(Q=window.$message)==null||Q.success("操作成功"),q(),B("submitted")}}q(),B("submitted"),(ve=window.$message)==null||ve.success("添加成功")}}const w=P(!1),Ce=P();async function Pt(){const e="https://dingiiot.com/map-sdk.json";try{return(await Qt.get(`${e}?_t=${Date.now()}`)).data}catch(t){throw console.error("获取地图 SDK 配置失败:",t),t}}let se=null,at=null,Ae=null,nt=null,G=null;const le=P(""),qe=P([]);async function It(){const e=await Pt();if(window._AMapSecurityConfig={securityJsCode:e.AMAP_SDK_SECRET},!!Ce.value)try{G=await Ta.load({key:e.AMAP_SDK_KEY,version:"2.0",plugins:["AMap.Scale","AMap.PlaceSearch","AMap.AutoComplete","AMap.Lnglat","AMap.Geocoder","AMap.Geolocation"]}),se=new G.Map(Ce.value,{zoom:18,center:[o.longitude,o.latitude],viewMode:"3D",resizeEnable:!0});const t=new G.Geolocation({enableHighAccuracy:!0,timeout:1e4,position:"RT",buttonOffset:new G.Pixel(10,20),zoomToAccuracy:!0});se.addControl(t),se.addControl(new G.Scale),at=new G.Geocoder,nt=new G.PlaceSearch({pageSize:50}),se.on("click",n=>{console.log("e",n);const m=n.lnglat.lng,y=n.lnglat.lat;Ge(G,{lng:m,lat:y})}),Ge(G,{lng:o.longitude,lat:o.latitude})}catch(t){console.error("地图加载失败:",t)}}function jt(){le.value.trim()&&nt.search(le.value,(e,t)=>{if(console.log(e,t),qe.value=[],e==="complete"&&t.info==="OK"){const n=t.poiList.pois;n.length>0&&n.forEach(m=>{const{address:y,location:b}=m;qe.value.push({label:y,value:b.lng+"_"+b.lat})})}else console.log("搜索失败或无结果")})}function Tt(){w.value=!0,Yt(()=>{It()})}function At(e){console.log("key",le.value),console.log("val",e);let t=e.split("_")[0],n=e.split("_")[1];se.setCenter([t,n]),Ge(G,{lng:t,lat:n})}function Ge(e,t){Ae&&se.remove(Ae),Ae=new e.Marker({position:[t.lng,t.lat],map:se}),se.add(Ae),at.getAddress(t,(n,m)=>{n==="complete"&&m.regeocode&&(console.log("result",m),console.log("formattedAddress",m.regeocode.formattedAddress),o.latitude=t.lat,o.longitude=t.lng,le.value=m.regeocode.formattedAddress)})}function Ut(e,t){if(!t)return null;const n=t.replace(/省|市|特别行政区|自治区|壮族|回族|维吾尔/g,"").trim(),m=e.find(y=>t.includes(y.name)||y.name.includes(n));return m?m.id:null}const st=P([]),$t=async()=>{const{data:e,error:t}=await ya({page:1,limit:100,pid:r.rowData.id});o.dispatchIds=e==null?void 0:e.list.map(n=>n.did),st.value=JSON.parse(JSON.stringify(o.dispatchIds))},lt=P([]),ot=async()=>{const{data:e,error:t}=await _a();e&&(lt.value=e)},it=P([]),rt=async e=>{let t=Ut(lt.value,e);const{data:n,error:m}=await ba({page:1,limit:100,province:t});it.value=n.list},Ft=async()=>{await ot(),o.prosite=le.value,rt(le.value),w.value=!1},{pageData:Ke,getData:Lt,nextPage:Ot}=Fa(Sa),Et=async()=>{await Lt({limit:100})},Mt=async e=>{const t=e.currentTarget;t.scrollTop+t.offsetHeight>=t.scrollHeight&&Ke.data.length<Ke.total&&Ot()},Rt=P([]);return(e,t)=>{const n=Nt,m=Ia,y=Xt,b=Pa,z=Ze,C=zt,E=wt,N=Wt,K=Ht,Q=ja,ve=Ct;return te(),St(Kt,null,[a(K,{show:ge.value,"onUpdate:show":[t[9]||(t[9]=p=>ge.value=p),Be],"display-directive":"show",width:1100,onMaskClick:q,onEsc:q},{default:l(()=>[a(N,{title:fe.value,"native-scrollbar":!1,closable:""},{footer:l(()=>[a(s(ie),{size:16,justify:"end"},{default:l(()=>[a(s(g),{onClick:q},{default:l(()=>[_(re(s(x)("common.cancel")),1)]),_:1}),a(s(g),{type:"primary",onClick:je},{default:l(()=>[_(re(s(x)("common.confirm")),1)]),_:1})]),_:1})]),default:l(()=>[a(E,{ref_key:"formRef",ref:M,model:o,rules:ue,onKeyup:kt(je,["enter"])},{default:l(()=>[a(C,{responsive:"screen","item-responsive":"","x-gap":"15"},{default:l(()=>[a(n,{span:"24 s:12 m:12",label:"项目名称",path:"proname"},{default:l(()=>[a(s(F),{clearable:"",value:o.proname,"onUpdate:value":t[0]||(t[0]=p=>o.proname=p),placeholder:"请输入项目名称"},null,8,["value"])]),_:1}),r.operateType==="add"?(te(),ye(n,{key:0,span:"24 s:12 m:12",label:"绑定合同",path:"contractIds"},{default:l(()=>[a(s(he),{filterable:"",multiple:"",value:o.contractIds,"onUpdate:value":t[1]||(t[1]=p=>o.contractIds=p),placeholder:"请选择合同","label-field":"contractname","value-field":"id",options:s(Ke).data,onScroll:Mt},null,8,["value","options"])]),_:1})):We("",!0),r.operateType==="edit"?(te(),ye(n,{key:1,span:"24 s:12 m:12",label:"项目状态",path:"status"},{default:l(()=>[a(s(he),{filterable:"",value:o.status,"onUpdate:value":t[2]||(t[2]=p=>o.status=p),placeholder:"请选择项目状态",options:s(Ne)(s(k).userInfo.usertype==0||s(k).userInfo.usertype==2?s(tt):s(Aa))},null,8,["value","options"])]),_:1})):We("",!0),a(n,{span:"24 s:12 m:12",label:"调度名称",path:"dispatch"},{default:l(()=>[a(s(F),{clearable:"",value:o.dispatch,"onUpdate:value":t[3]||(t[3]=p=>o.dispatch=p),placeholder:"请输入调度名称"},null,8,["value"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"调试类型",path:"dtype"},{default:l(()=>[a(s(he),{filterable:"",value:o.dtype,"onUpdate:value":t[4]||(t[4]=p=>o.dtype=p),placeholder:"请选择调试类型",options:s(Ne)(s(xt))},null,8,["value","options"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"周期（天）",path:"period"},{default:l(()=>[a(s(dt),{clearable:"",value:o.period,"onUpdate:value":t[5]||(t[5]=p=>o.period=p),style:{width:"100%"},placeholder:"请输入周期"},null,8,["value"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"项目地点",path:"prosite"},{default:l(()=>[a(y,{onClick:Tt},{default:l(()=>[a(s(F),{value:o.prosite,"onUpdate:value":t[6]||(t[6]=p=>o.prosite=p),placeholder:"请输入项目地点"},null,8,["value"]),a(s(g),null,{icon:l(()=>[a(m,{class:"text-icon"})]),_:1})]),_:1})]),_:1}),a(n,{span:"24 s:12 m:12",label:"选择调度",path:"dispatchIds"},{default:l(()=>[a(s(he),{filterable:"",multiple:"",value:o.dispatchIds,"onUpdate:value":t[7]||(t[7]=p=>o.dispatchIds=p),placeholder:"请选择所属项目","label-field":"dname","value-field":"id",options:it.value},null,8,["value","options"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"项目详细地址",path:"proaddr"},{default:l(()=>[a(s(F),{type:"textarea",rows:1,clearable:"",value:o.proaddr,"onUpdate:value":t[8]||(t[8]=p=>o.proaddr=p),placeholder:"请输入项目详细地址"},null,8,["value"])]),_:1}),a(n,{span:"24 s:12 m:24",path:"contactList"},{default:l(()=>[H("div",Ja,[a(s(ie),{align:"center",style:{"margin-bottom":"10px"}},{default:l(()=>[t[13]||(t[13]=H("span",null,"项目联系人",-1)),a(s(g),{size:"small",ghost:"",type:"primary",onClick:pe},{icon:l(()=>[a(b,{class:"text-icon"})]),default:l(()=>[t[12]||(t[12]=_(" 添加项目联系人 "))]),_:1,__:[12]})]),_:1,__:[13]}),a(z,{columns:de,"paginate-single-page":!1,data:f.value,pagination:j,"max-height":350},null,8,["data","pagination"])])]),_:1}),a(n,{span:"24 s:12 m:24",path:"debuggedDevieceList"},{default:l(()=>[H("div",qa,[a(s(ie),{align:"center",style:{"margin-bottom":"10px"}},{default:l(()=>[t[15]||(t[15]=H("span",null,"待调试设备",-1)),a(s(g),{size:"small",ghost:"",type:"primary",onClick:_e},{icon:l(()=>[a(b,{class:"text-icon"})]),default:l(()=>[t[14]||(t[14]=_(" 添加待调试设备 "))]),_:1,__:[14]})]),_:1,__:[15]}),a(z,{columns:U,"paginate-single-page":!1,data:c.value,pagination:A,"max-height":350},null,8,["data","pagination"])])]),_:1}),a(n,{span:"24 s:12 m:24"},{default:l(()=>[H("div",Ga,[a(s(ie),{align:"center",style:{"margin-bottom":"10px"}},{default:l(()=>[t[17]||(t[17]=H("span",null,"图纸",-1)),a(s(g),{size:"small",ghost:"",type:"primary",onClick:$},{icon:l(()=>[a(b,{class:"text-icon"})]),default:l(()=>[t[16]||(t[16]=_(" 添加图纸 "))]),_:1,__:[16]})]),_:1,__:[17]}),J.value.length>0?(te(),ye(z,{key:0,columns:i,data:J.value,size:"small","scroll-x":702,"row-key":p=>p.id,"max-height":350},null,8,["data","row-key"])):We("",!0)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"]),a(ve,{show:w.value,"onUpdate:show":t[11]||(t[11]=p=>w.value=p),title:"选择项目位置",preset:"card",class:"w-800px"},{footer:l(()=>[a(s(ie),{justify:"end",size:16},{default:l(()=>[a(s(g),{onClick:Je},{default:l(()=>[_(re(s(x)("common.cancel")),1)]),_:1}),a(s(g),{type:"primary",onClick:Ft},{default:l(()=>[_(re(s(x)("common.confirm")),1)]),_:1})]),_:1})]),default:l(()=>[a(Q,{value:le.value,"onUpdate:value":[t[10]||(t[10]=p=>le.value=p),jt],options:qe.value,placeholder:"请输入地点关键字",clearable:"",onSelect:At},null,8,["value","options"]),H("div",{ref_key:"domRef",ref:Ce,class:"h-full w-full",style:{width:"100%",height:"500px","margin-top":"10px"}},null,512)]),_:1},8,["show"])],64)}}}),Ha=Ee({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:Le(["reset","search"],["update:model"]),setup(L,{emit:W}){Zt();const k=W,{formRef:B,restoreValidation:O}=_t(),r=Qe(L,"model"),o={当日:()=>{const v=new Date().getTime();return[v,v]},本周:()=>{const v=new Date().getTime();return[v-24*60*60*1e3*7,v]},上月:()=>{const v=new Date().getTime();return[v-24*60*60*1e3*30,v]},近一年:()=>{const v=new Date().getTime();return[v-24*60*60*1e3*365,v]},近三年:()=>{const v=new Date().getTime();return[v-24*60*60*1e3*365*3,v]}};function X(){r.value.fuzzy="",k("search")}async function I(v,S){if(!v){r.value.startTime=void 0,r.value.endTime=void 0,k("search");return}r.value.startTime=String(ct(1,S[0])),r.value.endTime=String(ct(1,S[1])),k("search")}async function Y(){r.value.startTime=void 0,r.value.endTime=void 0,r.value.startAndTimeRange=null,r.value.fuzzy="",r.value.status=null,r.value.ptype=null,r.value.dtype=null,await O(),k("reset")}async function M(){k("search")}return(v,S)=>{const ue=F,f=Nt,j=he,de=Ra,h=Ma,T=g,ae=Ea,ce=ie,pe=zt,c=wt,A=et;return te(),ye(A,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[a(c,{ref_key:"formRef",ref:B,model:r.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:kt(M,["enter"])},{default:l(()=>[a(pe,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:l(()=>[a(f,{span:"24 s:12 m:6",label:"项目名称",path:"fuzzy"},{default:l(()=>[a(ue,{clearable:"",value:r.value.fuzzy,"onUpdate:value":S[0]||(S[0]=U=>r.value.fuzzy=U),placeholder:"请输入项目名称",onClear:X},null,8,["value"])]),_:1}),a(f,{span:"24 s:12 m:6",label:"项目状态",path:"status"},{default:l(()=>[a(j,{clearable:"",filterable:"",value:r.value.status,"onUpdate:value":[S[1]||(S[1]=U=>r.value.status=U),M],placeholder:"请选择项目状态",options:s(Ne)(s(tt))},null,8,["value","options"])]),_:1}),a(f,{span:"24 s:12 m:6",label:"进度状态",path:"ptype"},{default:l(()=>[a(j,{clearable:"",filterable:"",value:r.value.ptype,"onUpdate:value":[S[2]||(S[2]=U=>r.value.ptype=U),M],placeholder:"请选择进度状态",options:[{label:"正常",value:0},{label:"已延期",value:1}]},null,8,["value"])]),_:1}),a(f,{span:"24 s:12 m:6",label:"调试类型",path:"dtype"},{default:l(()=>[a(j,{clearable:"",filterable:"",value:r.value.dtype,"onUpdate:value":[S[3]||(S[3]=U=>r.value.dtype=U),M],placeholder:"请选择调试类型",options:s(Ne)(s(xt))},null,8,["value","options"])]),_:1}),a(f,{span:"24 s:12 m:8",label:"起止时间"},{default:l(()=>[a(de,{value:r.value.startAndTimeRange,"onUpdate:value":S[4]||(S[4]=U=>r.value.startAndTimeRange=U),type:"datetimerange",clearable:"",shortcuts:o,"onUpdate:formattedValue":I},null,8,["value"])]),_:1}),a(f,{span:"24  s:12 m:6",class:"pr-24px"},{default:l(()=>[a(ce,{class:"w-full"},{default:l(()=>[a(T,{onClick:Y},{icon:l(()=>[a(h,{class:"text-icon"})]),default:l(()=>[_(" "+re(s(x)("common.reset")),1)]),_:1}),a(T,{type:"primary",ghost:"",onClick:M},{icon:l(()=>[a(ae,{class:"text-icon"})]),default:l(()=>[_(" "+re(s(x)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Wa={class:"min-h-500px flex gap-16px"},Xa={class:"flex items-center justify-end gap-16px"},Ya=Ee({__name:"relatedContractLook",props:Le({id:{}},{visable:{type:Boolean},visableModifiers:{}}),emits:["update:visable"],setup(L){const W=L,k=Qe(L,"visable"),{columns:B,data:O,getData:r,loading:o,mobilePagination:X,searchParams:I}=Ye({apiFn:Da,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,id:W.id,_t:new Date().getTime()},columns:()=>[{key:"contractname",title:"合同",width:200,render:h=>a("div",{class:f.pids==h.id?"bg-#f1f1f1 cursor-pointer p-5px":"cursor-pointer p-5px",onClick:()=>j(h.id)},[a("div",{class:"flex"},[a("div",{class:"w-60px inline-block"},[_("名称：")]),h.contractname]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("编号：")]),_(" "),h.contractnum]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("联系人：")]),h.businesscon]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("联系方式：")]),h.businessinfo]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("注意事项：")]),h.precautions]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("备注：")]),h.notes])])}]}),{columns:Y,data:M,getData:v,loading:S,mobilePagination:ue,searchParams:f}=Ye({apiFn:xa,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,pids:W.id,_t:new Date().getTime()},columns:()=>[{key:"devname",title:"设备名称",align:"center",width:200,ellipsis:{tooltip:!0}},{key:"devcount",title:"数量",align:"center",width:120},{key:"devmodel",title:"规格型号",align:"center",width:120,ellipsis:{tooltip:!0}},{key:"devunit",title:"单位",align:"center",width:120},{key:"devtype",title:"是否为我司设备",align:"center",width:120,render:h=>h.devtype==0?a(Oe,{type:"success"},{default:()=>[_("是")]}):a(Oe,{type:"info"},{default:()=>[_("否")]})},{key:"devmanu",title:"设备厂家",align:"center",width:120},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"创建人",align:"center",width:120},{key:"dbtime",title:"创建时间",align:"center",width:180}]}),j=h=>{f.pids=h,v()},de=()=>{k.value=!1};return bt(()=>k.value,async h=>{var T;h&&(I.id=W.id,await r(),f.pids=(T=O.value[0])==null?void 0:T.id,v())}),(h,T)=>{const ae=Ze,ce=et,pe=Ct;return te(),ye(pe,{show:k.value,"onUpdate:show":T[0]||(T[0]=c=>k.value=c),preset:"card",class:"w-1400px",title:"项目关联的合同"},{footer:l(()=>[H("div",Xa,[a(s(g),{type:"primary",size:"small",onClick:de},{default:l(()=>T[1]||(T[1]=[_(" 关闭 ")])),_:1,__:[1]})])]),default:l(()=>[H("div",Wa,[a(ae,{class:"left",columns:s(B),data:s(O),"paginate-single-page":!1,size:"small",remote:"",loading:s(o),pagination:s(X),"row-key":c=>c.id,"max-height":600},null,8,["columns","data","loading","pagination","row-key"]),a(ce,{bordered:!1,size:"small",title:"设备",class:"w-1100px"},{default:l(()=>[a(ae,{style:{width:"100%"},columns:s(Y),data:s(M),size:"small","max-height":600,loading:s(S),remote:"","scroll-x":s(Y).reduce((c,A)=>c+(A.width||100),0),"paginate-single-page":!1,pagination:s(ue),"row-key":c=>c.id},null,8,["columns","data","loading","scroll-x","pagination","row-key"])]),_:1})])]),_:1},8,["show"])}}}),Qa=ea(Ya,[["__scopeId","data-v-07ffc593"]]),Za={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Xe(L){return typeof L=="function"||Object.prototype.toString.call(L)==="[object Object]"&&!ia(L)}const kn=Ee({name:"projectmanagement_projectlist",__name:"index",setup(L){const W=ta(),k=yt(),B=aa(),O=na(),{columns:r,columnChecks:o,data:X,getData:I,loading:Y,mobilePagination:M,searchParams:v}=Ye({showTotal:!0,apiFn:za,apiParams:{page:1,pageSize:20,limit:20,status:null,startAndTimeRange:null,startTime:null,endTime:null,creater:void 0,fuzzy:"",_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"proname",title:"项目名称",align:"center",width:240},{key:"progess",title:"项目进度",align:"center",width:140,render:i=>a(Ba,{type:"line",showIndicator:!0,percentage:i.progess,"indicator-placement":"inside",processing:!0,color:"#1890ff"},null)},{key:"status",title:"项目状态",align:"center",width:120,defaultFilterOptionValue:null,filterOptions:Ne(tt),filter:!0,filterMultiple:!1,render:i=>{if(i.status===null)return null;const d=x(Ua[i.status]);return a("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",color:i.status===0?"#3498db":i.status===1?"#f39c12":i.status===2?"#f1c40f":"#2ecc71",borderRadius:"50%"}},[a("span",{style:{width:"10px",height:"10px",marginRight:"5px",backgroundColor:i.status===0?"#3498db":i.status===1?"#f39c12":i.status===2?"#f1c40f":"#2ecc71",borderRadius:"50%"}},null),a("span",null,[d])])}},{key:"cpdbtime",title:"预计完成日期",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"period",title:"周期",align:"center",width:100,render:i=>a("div",null,[i.period,_("天")])},{key:"ptype",title:"状态",align:"center",width:100,render:i=>a(Oe,{type:i.ptype===0?"success":"warning"},{default:()=>[i.ptype===0?"正常":"已延期"]})},{key:"dtype",title:"调试类型",align:"center",width:100,render:i=>{if(i.status===null)return null;const d=x($a[i.dtype]);return a(Oe,{type:"info"},Xe(d)?d:{default:()=>[d]})}},{key:"username",title:"创建人",align:"center",width:100,ellipsis:{tooltip:!0}},{key:"dbtime",title:"创建时间",align:"center",width:180},{key:"operate",title:x("common.operate"),align:"center",width:320,fixed:"right",render:i=>{let d;return a("div",{class:"flex-center gap-8px"},[i.status==0&&(k.userInfo.usertype==0||k.userInfo.usertype==2||k.userInfo.usertype==3)&&a(ke,{onPositiveClick:()=>c(i,1)},{default:()=>"确定启动项目吗？",trigger:()=>we(a(g,{type:"success",ghost:!0,size:"small"},{default:()=>["开始"]}),[[ze("no-auth"),"project:Info:update"]])}),i.status==2&&(k.userInfo.usertype==0||k.userInfo.usertype==2)&&a(ke,{onPositiveClick:()=>c(i,3)},{default:()=>"是否确认执行审核操作？",trigger:()=>we(a(g,{type:"warning",ghost:!0,size:"small"},{default:()=>["审核"]}),[[ze("no-auth"),"project:Info:update"]])}),a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>J(i)},{default:()=>["详情"]}),a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>Me(i)},{default:()=>["关联合同"]}),we(a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>A(i.id)},Xe(d=x("common.edit"))?d:{default:()=>[d]}),[[ze("no-auth"),"project:Info:update"]]),a(ke,{onPositiveClick:()=>pe(i.id)},{default:()=>x("common.confirmDelete"),trigger:()=>{let $;return we(a(g,{type:"error",ghost:!0,size:"small"},Xe($=x("common.delete"))?$:{default:()=>[$]}),[[ze("no-auth"),"project:Info:delete"]])}})])}}]}),{drawerVisible:S,operateType:ue,editingData:f,handleAdd:j,handleEdit:de,checkedRowKeys:h,onBatchDeleted:T,onDeleted:ae}=Na(X,I);async function ce(){console.log(h.value),U(h.value.join(","),i=>{T()})}async function pe(i){const{data:d,error:$}=await ht(i);$||ae()}const c=async(i,d)=>{var fe;const{data:$,error:me}=await Dt([{id:i.id,status:d}]);me||((fe=window.$message)==null||fe.success("操作成功"),I())};function A(i){de(i)}async function U(i,d){const{data:$,error:me}=await ht(i);if(!me)d&&d($);else return!1}const ne=P(!1),Pe=P(0),Me=i=>{ne.value=!0,Pe.value=i.id},Re=i=>{v.status=i.status,I()},_e=P(-1),Ve=i=>{i>0?(_e.value=i,v.creater=JSON.parse(JSON.stringify(i)),I()):(v.creater=void 0,_e.value=-1,I())},J=i=>{B.push("/projectmanagement/orderdetail?prjId="+i.id)},Ie=()=>{I()};return sa(()=>{O.query.pname&&(v.fuzzy=O.query.pname,Ie())}),(i,d)=>{const $=Va,me=oa,fe=ie,ge=qt,Be=Jt,q=Bt,Je=Ze,je=et,Te=ze("no-auth");return te(),St("div",Za,[a(Ha,{model:s(v),"onUpdate:model":d[0]||(d[0]=w=>Fe(v)?v.value=w:null),onReset:Ie,onSearch:s(I)},null,8,["model","onSearch"]),a(je,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:l(()=>[a(fe,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:l(()=>[d[6]||(d[6]=H("div",null,"项目列表",-1)),a(me,{size:"small",value:_e.value,"onUpdate:value":[d[1]||(d[1]=w=>_e.value=w),Ve],name:"radiobuttongroup1"},{default:l(()=>[a($,{value:-1,label:"默认"}),a($,{value:s(k).userInfo.id,label:"我创建的"},null,8,["value"])]),_:1},8,["value"])]),_:1,__:[6]})]),"header-extra":l(()=>[a(fe,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:l(()=>[we((te(),ye(s(g),{onClick:s(j),size:"small",ghost:"",type:"primary"},{icon:l(()=>[a(ge,{class:"text-icon"})]),default:l(()=>[d[7]||(d[7]=_(" "+re("新增项目")))]),_:1,__:[7]},8,["onClick"])),[[Te,"project:Info:insert"]]),a(s(ke),{onPositiveClick:ce},{trigger:l(()=>[we((te(),ye(s(g),{size:"small",ghost:"",type:"error",disabled:s(h).length==0},{icon:l(()=>[a(Be,{class:la(["text-icon",{"animate-spin":s(Y)}])},null,8,["class"])]),default:l(()=>[d[8]||(d[8]=_(" "+re("批量删除")))]),_:1,__:[8]},8,["disabled"])),[[Te,"project:Info:delete"]])]),default:l(()=>[d[9]||(d[9]=_(" 确定要删除选中的合同吗？ "))]),_:1,__:[9]}),a(q,{columns:s(o),"onUpdate:columns":d[2]||(d[2]=w=>Fe(o)?o.value=w:null)},null,8,["columns"])]),_:1})]),default:l(()=>[a(Je,{"checked-row-keys":s(h),"onUpdate:checkedRowKeys":d[3]||(d[3]=w=>Fe(h)?h.value=w:null),columns:s(r),data:s(X),size:"small","flex-height":!s(W).isMobile,"scroll-x":s(r).reduce((w,Ce)=>w+(Ce.width||100),0),loading:s(Y),remote:"","row-key":w=>w.id,pagination:s(M),class:"sm:h-full","onUpdate:filters":Re},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),a(Ka,{visible:s(S),"onUpdate:visible":d[4]||(d[4]=w=>Fe(S)?S.value=w:null),onSubmitted:s(I),"operate-type":s(ue),"row-data":s(f)},null,8,["visible","onSubmitted","operate-type","row-data"]),a(Qa,{visable:ne.value,"onUpdate:visable":d[5]||(d[5]=w=>ne.value=w),id:Pe.value},null,8,["visable","id"])]),_:1})])}}});export{kn as default};
