import{bW as v,d as A,a2 as G,$ as h,g as s,D as B,C as U,B as d,h as f,s as J,x as W,y as X,v as Y,c3 as H,r as K,j as N,o as w,e as Q,w as o,c as b,i as t,f as Z,t as V,am as ee,F as $,an as te,ap as ae,aq as ne,at as se,ac as oe,Y as ie,J as le,M as S,N as re,ak as ce}from"./index-DLQv0xE2.js";import{u as ue}from"./table-Dfen2niS.js";import{f as me}from"./reportForm-xxvjNrTv.js";import{f as pe}from"./scheduleTask-BJ0xPBii.js";import{N as ge}from"./Popconfirm-G8CimJZQ.js";import{_ as de}from"./TimePicker-B5ZvLBUm.js";import"./defineProperty-BYTHWXAG.js";function fe(_){return v({url:"/logBackUps/getLogBackUps.do",method:"get",params:_})}function _e(){return v({url:"/logBackUps/getLogBackUpsTask.do",method:"get"})}function ke(_){return v({url:"/logBackUps/restore.do",method:"post",params:{fname:_}})}const ye={class:"min-h-500px flex-col-stretch gap-16px overflow-auto lt-sm:overflow-auto"},we={class:"flex justify-center"},Se=A({name:"logretrieval_logbackup",__name:"index",setup(_){const I=G(),{columns:D,columnChecks:he,data:E,getData:be,loading:L,mobilePagination:O,searchParams:ve,resetSearchParams:Ce}=ue({apiFn:fe,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{key:"fname",title:"文件名称",align:"center",width:240},{key:"dbtime",title:"备份时间",align:"center",width:240},{key:"operate",title:h("common.operate"),align:"center",width:130,render:n=>s("div",{class:"flex-center gap-8px"},[B(s(d,{type:"primary",ghost:!0,size:"small",onClick:()=>R(n.fname)},{default:()=>[f("下载")]}),[[U("no-auth"),"sysmanger.logBackUps.download"]]),s(ge,{onPositiveClick:()=>j(n.fname)},{default:()=>"确定恢复吗?",trigger:()=>s(d,{type:"info",ghost:!0,size:"small"},{default:()=>[f("恢复")]})})])}]});async function R(n){const a=J(),l=Date.now().toString(),c=W(`${a}${l}${"fname="+encodeURIComponent(n)}`);X({url:`${Y}/logBackUps/download.do`,method:"post",params:{fname:n},responseType:"blob",headers:{token:H(),"X-Nonce":a,"X-Timestamp":l,"X-Signature":c}}).then(async r=>{var m,y;if(r.data.type=="application/json"){const g=await r.data.text();var u=JSON.parse(g);if(u.code==500)return(m=window.$message)==null?void 0:m.error(u.data)}if(r.data){const g=window.URL.createObjectURL(new Blob([r.data])),p=document.createElement("a");p.href=g,p.setAttribute("download",n),document.body.appendChild(p),p.click()}(y=window.$message)==null||y.success("下载成功")})}const j=async n=>{var c;const{data:a,error:l}=await ke(n);l||(c=window.$message)==null||c.success("恢复成功")},C=()=>({id:"",beanName:"",params:"",cronExpression:"",status:1,remark:""});let e=K({taskInfo:C(),setting:{settingCycle:void 0,settingCycleValue:void 0,settingTime:void 0}});const q={setting:{settingCycle:{type:"number",required:!0,message:"请选择设置周期",trigger:"blur"},settingCycleValue:{type:"number",required:!1,message:"请选择设置周期值",trigger:"blur"},settingTime:{required:!0,message:"请选择设置时间",trigger:"blur"}}},x=N(null),k=N(!1),z=async()=>{k.value=!0;const{data:n,error:a}=await _e();if(!a){console.log(n);const l=ae(n.cronExpression);Object.assign(e.setting,l),e.taskInfo=n}},T=()=>{k.value=!1,e.taskInfo=C()},P=async()=>{var a,l,c,r;await((a=x.value)==null?void 0:a.validate());const n=ne(e.setting.settingCycle==1?{dayOfWeek:e.setting.settingCycleValue,time:e.setting.settingTime}:null,e.setting.settingCycle==2?{dayOfMonth:e.setting.settingCycleValue,time:e.setting.settingTime}:null,e.setting.settingCycle==3?{time:e.setting.settingTime}:null);if((l=e.taskInfo)!=null&&l.id){const{data:u,error:m}=await pe({beanName:e.taskInfo.beanName,cronExpression:n,id:e.taskInfo.id,params:e.taskInfo.params,status:e.taskInfo.status,remark:e.taskInfo.remark});m||(r=window.$message)==null||r.success("设置成功")}else{const{data:u,error:m}=await me({beanName:"LogBackUpsTask",cronExpression:n,params:JSON.stringify({cron:n}),remark:""});m||(c=window.$message)==null||c.success("设置成功")}T()};return(n,a)=>{const l=se,c=oe,r=ie,u=le,m=S,y=de,g=re,p=S,M=ce,F=U("no-auth");return w(),Q("div",ye,[s(c,{title:"日志备份",bordered:!1,size:"small",class:"sm:flex-1-hidden"},{"header-extra":o(()=>[B((w(),b(t(d),{type:"primary",ghost:"",onClick:z},{default:o(()=>[f("备份设置 ")]),_:1})),[[F,"sysmanger.logBackUps.task"]])]),default:o(()=>[s(l,{columns:t(D),data:t(E),size:"small","flex-height":!t(I).isMobile,"scroll-x":962,loading:t(L),remote:"","row-key":i=>i.id,pagination:t(O),class:"sm:h-full"},null,8,["columns","data","flex-height","loading","row-key","pagination"])]),_:1}),s(M,{show:k.value,"onUpdate:show":a[5]||(a[5]=i=>k.value=i),title:"日志备份设置",preset:"card",class:"w-400px"},{footer:o(()=>[Z("div",we,[s(p,{justify:"end",size:16},{default:o(()=>[s(t(d),{onClick:T},{default:o(()=>[f(V(t(h)("common.cancel")),1)]),_:1}),s(t(d),{type:"primary",onClick:P},{default:o(()=>[f(V(t(h)("common.confirm")),1)]),_:1})]),_:1})])]),default:o(()=>[s(g,{ref_key:"formRef",ref:x,model:t(e),rules:q,"label-placement":"left","label-width":140,"require-mark-placement":"left"},{default:o(()=>[s(u,{label:"设置周期",path:"setting.settingCycle"},{default:o(()=>[s(m,{justify:"space-between"},{default:o(()=>[s(r,{value:t(e).setting.settingCycle,"onUpdate:value":[a[0]||(a[0]=i=>t(e).setting.settingCycle=i),a[1]||(a[1]=i=>t(e).setting.settingCycleValue=1)],options:[{label:"每周",value:1},{label:"每月",value:2},{label:"每日",value:3}],style:{width:"140px"}},null,8,["value"]),s(u,{label:"",path:"setting.settingCycleValue","show-feedback":!1},{default:o(()=>[t(e).setting.settingCycle==1?(w(),b(r,{key:0,value:t(e).setting.settingCycleValue,"onUpdate:value":a[2]||(a[2]=i=>t(e).setting.settingCycleValue=i),options:t(ee)(),style:{width:"140px"}},null,8,["value","options"])):$("",!0),t(e).setting.settingCycle==2?(w(),b(r,{key:1,value:t(e).setting.settingCycleValue,"onUpdate:value":a[3]||(a[3]=i=>t(e).setting.settingCycleValue=i),options:t(te)(),style:{width:"140px"}},null,8,["value","options"])):$("",!0)]),_:1})]),_:1})]),_:1}),s(u,{label:"设置时间",path:"setting.settingTime"},{default:o(()=>[s(y,{"formatted-value":t(e).setting.settingTime,"onUpdate:formattedValue":a[4]||(a[4]=i=>t(e).setting.settingTime=i)},null,8,["formatted-value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])])}}});export{Se as default};
