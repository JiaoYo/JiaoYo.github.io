import{l as Q}from"./lodash-C68MRtPW.js";import{d as K,q as R,j as I,v as X,s as Z,o as W,c as ee,w as r,g as l,i as y,$ as b,V as ae,h as U,t as F,N as te,ay as le,ao as D,ap as z,Y as ne,A as oe,B,E as J,D as re,aa as Y,a0 as ie,r as j,an as se,K as ue,e as de,ae as pe,aU as ce,aw as ve}from"./index-CaRSwrxR.js";import{_ as me}from"./round-search-DcPqtNKB.js";import{_ as ge}from"./round-refresh-DH4W3hYO.js";import{u as fe}from"./usePageData-DEdEXPef.js";import{a as he,T as q}from"./basicconf-BpaB-5Sq.js";import{f as Ie}from"./system-manage-BvYcIoFj.js";import{_ as _e}from"./DatePicker-WbRmNCGU.js";import{_ as ye}from"./Cascader-C7-VBpgs.js";import{_ as we}from"./FormItemGridItem-BXzdliJT.js";import{_ as Se}from"./Grid-DI4-4Zeg.js";import{_ as Ae}from"./originlogInfo.vue_vue_type_script_setup_true_lang-CgcxCSXG.js";import{e as xe}from"./exportExcel-D6OyA9oJ.js";import{B as be,t as Oe}from"./events-Bi1_rfVV.js";import{b as Ee,f as ke,a as De}from"./common-7dwhgC1M.js";import{_ as Le}from"./DataTable-CvFsglEk.js";import"./TimePicker-CE2vfveM.js";import"./defineProperty-BE3KqpHP.js";import"./Forward-Eh4K3nYq.js";import"./DescriptionsItem-1jpat6d_.js";import"./CollapseItem-Ypm3GNez.js";const Ce=K({name:"FormSearch",__name:"form-search",props:R(["eventsTypeDataList","LogSourceDeviceList","logsoudev"],{model:{required:!0},modelModifiers:{}}),emits:R(["search"],["update:model"]),setup(w,{emit:V}){const S=w,h=V;I(0);const{formRef:P,restoreValidation:H}=X(),e=Z(w,"model"),{pageData:L,getData:G,nextPage:M}=fe(Ie),C=async f=>{const n=f.currentTarget;n.scrollTop+n.offsetHeight>=n.scrollHeight&&L.data.length<L.total&&M()};G();async function $(){await H(),e.value.etypeid=null,e.value.elevel=null,e.value.rtime=null,e.value.user=null,e.value.logodid=null,e.value.target=null,e.value.startAndEndOriginIp=null,e.value.startAndEndSourceIp=null,e.value.startAndEndAimSourceIp=null,e.value.expression=null,e.value.startOriginIp=null,e.value.endOriginIp=null,e.value.startAimOriginIp=null,e.value.endAimOriginIp=null,e.value.startSourceIp=null,e.value.endSourceIp=null,le(()=>{h("search")})}const N=f=>{e.value.elevel=f,c()},A=(f,n)=>{e.value.rtime=n,c()},d=f=>{e.value.logodid=f,c()},T=()=>{e.value.startAndEndOriginIp=null,c()},o=()=>{e.value.startAndEndSourceIp=null,c()},O=()=>{e.value.startAndEndAimSourceIp=null,c()};async function c(){var f,n,g,p,x,E,_,k,a,t,i,v;if(e.value.startAndEndOriginIp&&e.value.startAndEndOriginIp.length>0?(e.value.startOriginIp=e.value.startAndEndOriginIp[0]||null,e.value.endOriginIp=e.value.startAndEndOriginIp[1]||null):(e.value.startOriginIp=null,e.value.endOriginIp=null),e.value.startAndEndAimSourceIp&&e.value.startAndEndAimSourceIp.length>0?(e.value.startAimOriginIp=e.value.startAndEndAimSourceIp[0]||null,e.value.endAimOriginIp=e.value.startAndEndAimSourceIp[1]||null):(e.value.startAimOriginIp=null,e.value.endAimOriginIp=null),e.value.startAndEndSourceIp&&e.value.startAndEndSourceIp.length>0?(e.value.startSourceIp=e.value.startAndEndSourceIp[0]||null,e.value.endSourceIp=e.value.startAndEndSourceIp[1]||null):(e.value.startSourceIp=null,e.value.endSourceIp=null),e.value.startOriginIp&&!D(e.value.startOriginIp)||e.value.endOriginIp&&!D(e.value.endOriginIp))return(f=window.$message)==null||f.destroyAll(),(n=window.$message)==null||n.error("请输入正确的IP地址"),!1;if(e.value.startOriginIp&&e.value.endOriginIp&&z(e.value.startOriginIp,e.value.endOriginIp)>0)return(g=window.$message)==null||g.destroyAll(),(p=window.$message)==null||p.error("起始IP不能大于终止IP"),!1;if(e.value.startAimOriginIp&&!D(e.value.startAimOriginIp)||e.value.endAimOriginIp&&!D(e.value.endAimOriginIp))return(x=window.$message)==null||x.destroyAll(),(E=window.$message)==null||E.error("请输入正确的IP地址"),!1;if(e.value.startAimOriginIp&&e.value.endAimOriginIp&&z(e.value.startAimOriginIp,e.value.endAimOriginIp)>0)return(_=window.$message)==null||_.destroyAll(),(k=window.$message)==null||k.error("起始IP不能大于终止IP"),!1;if(e.value.startSourceIp&&!D(e.value.startSourceIp)||e.value.endSourceIp&&!D(e.value.endSourceIp))return(a=window.$message)==null||a.destroyAll(),(t=window.$message)==null||t.error("请输入正确的IP地址"),!1;if(e.value.startSourceIp&&e.value.endSourceIp&&z(e.value.startSourceIp,e.value.endSourceIp)>0)return(i=window.$message)==null||i.destroyAll(),(v=window.$message)==null||v.error("起始IP不能大于终止IP"),!1;h("search")}return(f,n)=>{const g=ye,p=we,x=ne,E=_e,_=oe,k=ge,a=B,t=me,i=J,v=Se,m=re,u=Y;return W(),ee(u,{bordered:!1,size:"small",class:"card-wrapper"},{default:r(()=>[l(m,{ref_key:"formRef",ref:P,model:e.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:te(c,["enter"])},{default:r(()=>[l(v,{responsive:"screen","item-responsive":""},{default:r(()=>[l(p,{span:"24 s:24 m:6",label:"事件类型",path:"etypeid",class:"pr-24px"},{default:r(()=>[l(g,{value:e.value.etypeid,"onUpdate:value":[n[0]||(n[0]=s=>e.value.etypeid=s),d],clearable:"",placeholder:"请选择事件","max-tag-count":1,options:S.eventsTypeDataList,"show-path":!1,filterable:"","value-field":"id","check-strategy":"child","label-field":"pname"},null,8,["value","options"])]),_:1}),l(p,{span:"24 s:24 m:6",label:y(b)("page.manage.alarm.level"),path:"elevel",class:"pr-24px"},{default:r(()=>[l(x,{filterable:"",clearable:"",placeholder:y(b)("page.manage.alarm.form.level"),value:e.value.elevel,"onUpdate:value":[n[1]||(n[1]=s=>e.value.elevel=s),N],"reset-menu-on-options-change":!1,options:y(ae)(y(he))},null,8,["placeholder","value","options"])]),_:1},8,["label"]),l(p,{span:"24 s:24 m:6",label:"接收时间",path:"rtime",class:"pr-24px"},{default:r(()=>[l(E,{placeholder:"请选择接收时间","formatted-value":e.value.rtime,"onUpdate:formattedValue":n[2]||(n[2]=s=>e.value.rtime=s),"value-format":"yyyy-MM-dd HH:mm:ss",type:"datetime",clearable:"",style:{width:"100%"},"onUpdate:value":A},null,8,["formatted-value"])]),_:1}),l(p,{span:"24 s:24 m:6",label:"用户",path:"user",class:"pr-24px"},{default:r(()=>[l(x,{value:e.value.user,"onUpdate:value":n[3]||(n[3]=s=>e.value.user=s),placeholder:"请选择用户",clearable:"",filterable:"","value-field":"id","label-field":"username",options:y(L).data,"reset-menu-on-options-change":!1,onScroll:C},null,8,["value","options"])]),_:1}),l(p,{span:"24 s:24 m:8",label:"源IP",path:"startAndEndOriginIp",class:"pr-24px mt-10px"},{default:r(()=>[l(_,{pair:"",separator:"-",placeholder:["源起始IP","源终止IP"],clearable:"",value:e.value.startAndEndOriginIp,"onUpdate:value":n[4]||(n[4]=s=>e.value.startAndEndOriginIp=s),onClear:T},null,8,["value"])]),_:1}),l(p,{span:"24 s:24 m:8",label:"目的IP",path:"startAndEndAimSourceIp",class:"pr-24px mt-10px"},{default:r(()=>[l(_,{pair:"",separator:"-",placeholder:["目的起始IP","目的终止IP"],clearable:"",value:e.value.startAndEndAimSourceIp,"onUpdate:value":n[5]||(n[5]=s=>e.value.startAndEndAimSourceIp=s),onClear:O},null,8,["value"])]),_:1}),l(p,{span:"24 s:24 m:8",label:"发生源IP",path:"startAndEndSourceIp",class:"pr-24px mt-10px"},{default:r(()=>[l(_,{pair:"",separator:"-",disabled:S.logsoudev,placeholder:["发送源起始IP","发生源终止IP"],clearable:"",value:e.value.startAndEndSourceIp,"onUpdate:value":n[6]||(n[6]=s=>e.value.startAndEndSourceIp=s),onClear:o},null,8,["disabled","value"])]),_:1}),l(p,{span:"24 s:24 m:6",label:"日志源设备",path:"logodid",class:"pr-24px mt-10px"},{default:r(()=>[l(g,{disabled:S.logsoudev,value:e.value.logodid,"onUpdate:value":[n[7]||(n[7]=s=>e.value.logodid=s),c],placeholder:"请选择日志源设备",options:S.LogSourceDeviceList,"check-strategy":"child","children-field":"data","value-field":"id","label-field":"type",clearable:"",style:{width:"100%"},"show-path":!1},null,8,["disabled","value","options"])]),_:1}),l(p,{span:"24 s:24 m:6",label:"目标对象",path:"target",class:"pr-24px mt-10px"},{default:r(()=>[l(_,{placeholder:"请输入目标对象",value:e.value.target,"onUpdate:value":n[8]||(n[8]=s=>e.value.target=s),clearable:""},null,8,["value"])]),_:1}),l(p,{span:"24 m:8",class:"pr-24px mt-10px"},{default:r(()=>[l(i,{class:"w-full"},{default:r(()=>[l(a,{onClick:$},{icon:r(()=>[l(k,{class:"text-icon"})]),default:r(()=>[U(" "+F(y(b)("common.reset")),1)]),_:1}),l(a,{type:"primary",ghost:"",onClick:c},{icon:r(()=>[l(t,{class:"text-icon"})]),default:r(()=>[U(" "+F(y(b)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Te={class:"min-h-500px flex-col-stretch overflow-hidden lt-sm:overflow-auto"};function Pe(w){return typeof w=="function"||Object.prototype.toString.call(w)==="[object Object]"&&!pe(w)}const $e=K({name:"eventalarm_originlog",__name:"index",props:{logsoudev:{},aip:{}},setup(w){const V=ie(),S=I(window.innerHeight-395),h=w,P=I([]);(async()=>{const{data:a,error:t}=await Ee();t||(P.value=a.map(i=>({...i,id:"+"+i.id,type:i.cname})))})();const e=I([]),L=I([]);async function G(){const{data:a,error:t}=await ke();t||(e.value=a,await M())}async function M(){const{data:a,error:t}=await De();if(!t){L.value=a;let i=e.value.concat(a);e.value=ce(i)}}G();const C=I(!1),$=I(),N=I(),A=I(!1),d=j({pageId:void 0,limit:100,etypeid:void 0,elevel:void 0,rtime:void 0,startOriginIp:void 0,endOriginIp:void 0,startAimOriginIp:void 0,endAimOriginIp:void 0,startSourceIp:void 0,endSourceIp:void 0,logodid:void 0,user:void 0,target:void 0,fuzzy:void 0,_t:new Date().getTime()}),T=[{title:"",key:"key",width:80,render:(a,t)=>`${t+1}`},{key:"pname2",title:"事件类别",align:"center",width:160,ellipsis:{tooltip:!0}},{key:"pname1",title:"事件类型",align:"center",width:160},{key:"elevel",title:"事件等级",align:"center",width:120,render:a=>{(a.elevel===void 0||a.elevel===null)&&(a.elevel=1);const t={0:"#8e9dff",1:"#5da8ff",2:"#fedc69",3:"#ff9874",4:"#ff0000"},i=b(q[a.elevel]);let v={color:t[a.elevel],textColor:"#ffffff",borderColor:t[a.elevel]};return l(se,{size:"small",color:v},Pe(i)?i:{default:()=>[i]})}},{key:"cname",title:"设备类别",align:"center",width:180},{key:"type",title:"设备类型",align:"center",width:180},{key:"rtime",title:"接收时间",align:"center",width:160},{key:"sourceip",title:"发生源IP",align:"center",width:180},{key:"prifinallog",title:"日志原文",align:"center",width:240,ellipsis:{tooltip:!0}},{key:"operate",title:b("common.operate"),align:"center",width:100,fixed:"right",render:a=>l("div",{class:"flex-center gap-8px"},[l(B,{type:"info",ghost:!0,size:"small",onClick:()=>x(a)},{default:()=>[U("详情")]})])}],o=I([]),O=async(a=!1)=>{if(!A.value)A.value=!0;else return;A.value=!0,h.logsoudev&&h.aip&&(c.value=!1,d.logodid=h.logsoudev,d.startAndEndSourceIp=[h.aip,h.aip],d.startSourceIp=h.aip,d.endSourceIp=h.aip);const{data:t,error:i}=await Oe(d);i||(a?o.value=[...o.value,...t]:o.value=t,A.value=!1)},c=I(!0),f=()=>{o.value=[],d.pageId=void 0,(t=>Object.keys(t).filter(m=>m!=="limit"&&m!=="_t").some(m=>t[m]!==void 0&&t[m]!==""&&t[m]!==null))(d)?c.value=!1:(c.value=!0,p()),O()},n=async()=>{var a,t;if(o.value.length<S.value/44&&o.value.length<g.total){if(d.pageId==o.value[o.value.length-1].id)return;d.pageId=((t=(a=o.value)==null?void 0:a[o.value.length-1])==null?void 0:t.id)??void 0,O(!0)}};ue(async()=>{await O(),await p(),n()});const g=j({page:1,pageCount:1,pageSize:20,total:0,prefix({startIndex:a,endIndex:t,page:i,pageSize:v,pageCount:m,itemCount:u}){return`已加载${o.value.length}条`+(o.value.length?c.value?` 共计 ${o.value.length>0?u??0:0} 条`:o.value.length>=d.limit?"  预计还有更多":"":"")}});async function p(){const{data:a,error:t}=await be();t||(g.pageCount=20,g.total=Number(a),g.itemCount=Number(a))}const x=a=>{$.value=a.id,N.value=a,C.value=!0};function E(a){Math.abs(a.target.scrollTop+a.target.offsetHeight-a.target.scrollHeight)<=20&&g.total>o.value.length&&_()}const _=Q.debounce(()=>{var a;if(((a=o.value)==null?void 0:a.length)<g.total){if(d.pageId==o.value[o.value.length-1].id)return;d.pageId=o.value[o.value.length-1].id,O(!0)}},300);async function k(){if(!o.value.length)return;const a=JSON.parse(JSON.stringify(o.value)),t=[];a.forEach(v=>{const m={};T.forEach(u=>{if(v.hasOwnProperty(u.key)){const s=u.key=="elevel"?b(q[v[u.key]]):v[u.key];m[u.title]=s}}),t.push(m)}),xe(t,500,[{wpx:120},{wpx:120},{wpx:80},{wpx:100},{wpx:100},{wpx:120},{wpx:100},{wpx:500}],"原始日志_"+new Date().getTime())}return(a,t)=>{const i=J,v=Le,m=Y;return W(),de("div",Te,[l(Ce,{model:d,"onUpdate:model":t[0]||(t[0]=u=>d=u),onSearch:f,eventsTypeDataList:e.value,LogSourceDeviceList:P.value,class:"mb-16px",logsoudev:h.logsoudev},null,8,["model","eventsTypeDataList","LogSourceDeviceList","logsoudev"]),l(m,{title:"原始日志",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":r(()=>[l(i,null,{default:r(()=>[l(y(B),{type:"primary",size:"small",ghost:"",onClick:k,title:"导出已加载"},{default:r(()=>[U("导出已加载")]),_:1})]),_:1})]),default:r(()=>[l(v,{columns:T,data:o.value,size:"small","flex-height":!y(V).isMobile,loading:A.value,remote:"","row-key":u=>u.id,"virtual-scroll":"","scroll-x":T.reduce((u,s)=>u+s.width,0),pagination:g,class:"sm:h-full",onScroll:E,"max-height":S.value},null,8,["data","flex-height","loading","row-key","scroll-x","pagination","max-height"])]),_:1}),l(Ae,{detailVisible:C.value,"onUpdate:detailVisible":t[1]||(t[1]=u=>C.value=u),detailId:$.value,detailInfo:N.value},null,8,["detailVisible","detailId","detailInfo"])])}}}),ta=ve($e,[["__scopeId","data-v-531ebd33"]]);export{ta as default};
