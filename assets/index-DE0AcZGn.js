import{_ as oe}from"./table-column-setting.vue_vue_type_script_setup_true_lang-CRaBf14l.js";import{_ as ce}from"./round-search-DJvkGjS2.js";import{d as ie,bJ as re,g as l,b2 as T,b5 as de,aw as U,z as ue,aj as pe,m as k,aJ as _e,A as R,J as j,be as $,bf as L,bg as F,aS as G,ab as he,o as me,b as fe,w as p,h as O,f as o,aB as ge,E as ye,B as ve,af as ke,e as H,Q as be,D as we,bK as xe,t as Se,aE as M,ak as Te,N as $e,aG as De,R as Ne,S as ze,aH as qe,a6 as Ce,_ as Ie}from"./index-CWjhsADG.js";import{u as Ee,a as Pe}from"./table-CU66vj2P.js";import{a as Ae,p as Ue}from"./gather-CJWV7uZ9.js";import{h as W}from"./permission-BDieze7U.js";import{_ as Oe}from"./InputGroupLabel-BXGOV4Rx.js";import{_ as Ve}from"./Tree-fx8vJESI.js";import{_ as Be}from"./Split-CFIwlbVT.js";const Je={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ke={class:"flex flex-col"},Re=ie({name:"configsetting_realtimedata_devicedata",__name:"index",setup(je){const{columns:Q,columnChecks:D,data:w,getData:b,loading:V,mobilePagination:Y,searchParams:f,resetSearchParams:Le}=Ee({apiFn:re,apiParams:{page:1,pageSize:200,limit:200,tagType:null,chlid:null,devId:null,fuzzy:"",chlType:0,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",align:"center",width:48},{key:"id",title:"序号",align:"center",width:80},{key:"devId",title:"设备名称",align:"center",width:100,render:e=>{var t;return l("span",null,[(t=B.value.find(n=>n.id==e.devId))==null?void 0:t.devName])}},{key:"tagName",title:"测点名称",align:"center"},{key:"tagDesc",title:"物模型标识(测点描述)",align:"center"},{key:"value",title:"测点值",align:"center",width:140,render:e=>{var t;return T("span",{style:{color:e.quality===100?"red":e.quality==49?"#409eff":e.quality==50?"#909399":"#67c23a"}},parseFloat((t=e.value)==null?void 0:t.toFixed(6))||e.value)}},{key:"quality",title:"质量",align:"center",width:120,render:e=>(e.quality==100||e.quality==49||e.quality==0)&&T(de,{style:{background:e.quality===100?"red":e.quality==49?"#409eff":"#67c23a",color:"#fff"}},e.quality==0?"Good":e.quality==49?"人工置数":e.quality==100?"Bad":"")},{key:"dbtime",title:"采集时间",align:"center",minWidth:120,render:e=>{var t,n;return T("span",{title:U(0,+e.dbtime)},e.dbtime?(n=U(2,+e.dbtime))==null?void 0:n.substring(10,(t=U(2,+e.dbtime))==null?void 0:t.length):"")}},{key:"tagType",title:"测点类型",align:"center",width:140,render:e=>l("span",null,[Ae[e.tagType]])},{key:"objAddr",title:"地址",align:"center",width:140}]}),X=e=>{e===""&&b()};ue(async()=>{await Z(),C(),ee()}),pe(()=>{var e,t;(e=N.value)==null||e.close(),(t=S.value)==null||t.close()});const v=k(),B=k([]),Z=async()=>{const{data:e,error:t}=await _e();if((e==null?void 0:e.length)==0)return;function n(_){return _.map(i=>{var a;return{label:i.chlName,key:i.id,dev_status:null,children:(a=i.devicePojoList)!=null&&a.length?i.devicePojoList.map(c=>(B.value.push(c),{label:c.devName,dev_status:null,chlType:i.chlType,key:c.id})):[]}})}v.value=n(e),f.chlid=v.value[0].key,f.devId=v.value[0].children[0].key,I.value=[v.value[0].children[0].key],x.value=v.value[0].children[0].label,b()},N=k(null),ee=()=>{var c,d,g;if((c=N.value)==null||c.close(),!W("channel:status:websocket")){(d=window.$message)==null||d.destroyAll(),(g=window.$message)==null||g.warning("暂无权限连接websocket");return}const e=new Date().getTime(),t=R(),n=j(`${t}${e}getchlstatus`),_=$(n),i=$("getchlstatus"),a=new L(F+`/ChannelStatusWebsocket/${i}/${_}/${e}/${t}?token=${G()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});N.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(u=>{let h=[];if(console.log(u,"通道状态websocket接受数据"),!J(u.data))return;h=JSON.parse(u.data).data;const y=JSON.parse(u.data).valid;v.value.forEach(s=>{h.forEach(m=>{var r;m.chl_id==s.key&&(s.dev_status=m.chl_status),m.chl_id==1&&(s.dev_status=1),(r=s.children)==null||r.forEach(P=>{var K;(K=m.devs)==null||K.forEach(A=>{A.dev_id==P.key&&(P.dev_status=A.dev_status),A.dev_id==1&&(P.dev_status=1)})})})}),v.value.forEach(s=>{y.forEach(m=>{s.key==m.id&&(s.chlValid=m.chlValid)})})})},S=k(null),z=k(""),q=k(!0),C=()=>{var c,d,g;if((c=S.value)==null||c.close(),!W("realtime:data:websocket")){(d=window.$message)==null||d.destroyAll(),(g=window.$message)==null||g.warning("暂无权限连接websocket");return}q.value=!0;const e=new Date().getTime(),t=R(),n=j(`${t}${e}${x.value}`),_=$(n),i=$(x.value),a=new L(F+`/realTimeDataWebsocket/${i}/${_}/${e}/${t}?token=${G()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});S.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(u=>{let h=[];console.log(u,"实时数据websocket接受数据"),J(u.data)&&(h=JSON.parse(u.data).data[x.value],h==null||h.forEach(y=>{w.value.forEach(s=>{y.i==s.id&&(s.quality=y.q,s.value=y.v,s.dbtime=y.t)})}),z.value=se())})},I=k([]),x=k(""),te=async(e,t,n)=>{var a,c,d,g,u;I.value=[(a=n.node)==null?void 0:a.key],f.chlType=(c=n.node)==null?void 0:c.chlType;function _(h,y){for(const s of h)if(s.children){for(const m of s.children)if(m.key===y)return s.key}return null}const i=await _(v.value,(d=n.node)==null?void 0:d.key);f.chlid=i,f.devId=(g=n.node)==null?void 0:g.key,x.value=(u=n.node)==null?void 0:u.label,b(),C()},ae=e=>{var t;e&&w.value.length>0?C():(t=S.value)==null||t.close()};he(()=>f.tagType,e=>{e||b()});const ne=({option:e})=>e.key==0?"":e.dev_status!==null?T("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:e.hasOwnProperty("dev_status")&&e.dev_status==1?"#00b42a":e.dev_status==2?"#ff0000":"#ccc",color:"#ff0000",lineHeight:"12px",textAlign:"center",fontSize:"16px"}},e.chlValid==1?"":e.chlValid==2?"×":""):"",se=e=>{const t=new Date,n=t.getFullYear(),_=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),c=String(t.getMinutes()).padStart(2,"0"),d=String(t.getSeconds()).padStart(2,"0");return`${n}-${_}-${i} ${a}:${c}:${d}`},{drawerVisible:Fe,operateType:Ge,editingData:He,handleAdd:Me,handleEdit:We,checkedRowKeys:E,onBatchDeleted:Qe,onDeleted:Ye}=Pe(w,b),le=()=>{b()},J=e=>{try{return JSON.parse(e),!0}catch{return!1}};return(e,t)=>{const n=Oe,_=Te,i=$e,a=ce,c=De,d=Ne,g=oe,u=Ve,h=ze,y=qe,s=Be,m=Ce;return me(),fe("div",Je,[l(m,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:p(()=>[l(d,{align:"center",wrap:"",justify:"start",class:"lt-sm:w-200px"},{default:p(()=>[l(c,null,{default:p(()=>[l(n,null,{default:p(()=>[O("测点类型")]),_:1}),l(_,{filterable:"",clearable:"",placeholder:"请选择",value:o(f).tagType,"onUpdate:value":t[0]||(t[0]=r=>o(f).tagType=r),options:o(ge)(o(Ue))},null,8,["value","options"]),l(i,{clearable:"",value:o(f).fuzzy,"onUpdate:value":[t[1]||(t[1]=r=>o(f).fuzzy=r),X],placeholder:"请输入测点名称或描述",style:{width:"150%"},onKeyup:ye(o(b),["enter"])},null,8,["value","onKeyup"]),l(o(ve),{type:"primary",ghost:"",onClick:le},{icon:p(()=>[l(a,{class:ke(["text-icon",{"animate-spin":o(V)}])},null,8,["class"])]),default:p(()=>[O(" 搜索 ")]),_:1})]),_:1}),H("div",Ke,[l(o(be),{checked:q.value,"onUpdate:checked":[t[2]||(t[2]=r=>q.value=r),ae]},{default:p(()=>[O(" 实时刷新 ")]),_:1},8,["checked"]),we(H("span",{class:"font-size-14px color-blank",style:{"font-weight":"600"}}," 刷新时间："+Se(z.value),513),[[xe,z.value]])])]),_:1})]),"header-extra":p(()=>[l(d,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:p(()=>[l(g,{columns:o(D),"onUpdate:columns":t[3]||(t[3]=r=>M(D)?D.value=r:null)},null,8,["columns"])]),_:1})]),default:p(()=>[l(s,{direction:"horizontal",class:"sm:h-full","default-size":.15,max:.35,min:.1,"resize-trigger-size":6},{1:p(()=>[l(h,{style:{"max-height":"calc(100vh - 210px)"}},{default:p(()=>[l(u,{"block-line":"","default-expand-all":"",data:v.value,"checked-keys":I.value,"expand-on-click":!1,"render-prefix":ne,"check-strategy":"child","onUpdate:checkedKeys":te,checkable:""},null,8,["data","checked-keys"])]),_:1})]),2:p(()=>[l(y,{"checked-row-keys":o(E),"onUpdate:checkedRowKeys":t[4]||(t[4]=r=>M(E)?E.value=r:null),columns:o(Q),data:o(w),size:"small",loading:o(V),remote:"","row-key":r=>r.id,"flex-height":!0,"scroll-x":"",pagination:o(w).length?o(Y):void 0,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1})])}}}),ct=Ie(Re,[["__scopeId","data-v-f7edb8ab"]]);export{ct as default};
