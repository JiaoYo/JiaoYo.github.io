import{_ as _e}from"./table-column-setting.vue_vue_type_script_setup_true_lang-CMdAjh88.js";import{_ as ge}from"./round-delete-wQkUyB87.js";import{_ as he}from"./round-add--_pSpbF_.js";import{d as ee,at as Y,q as le,v as ve,r as Z,s as se,a as ye,au as re,a2 as we,c as $,o as v,w as n,f as o,b8 as be,G as ie,h as l,aw as ce,C as T,b as A,g as f,e as q,t as D,bp as ke,B as k,N as te,$ as R,b9 as Ce,c0 as ue,c1 as xe,cH as De,cI as Se,F as je,U as de,M as Ne,i as Ue,y as X,aB as E,ad as qe,D as J,bn as ze,cJ as ae,cK as Pe,W as Te,aF as $e}from"./index-DMk9ecAg.js";import{u as Re,a as Fe}from"./table-C6eerTnn.js";import{u as pe}from"./usePageData-KTtgYQ98.js";import{_ as me}from"./Grid-BIOqdWqR.js";import{_ as fe}from"./FormItemGridItem-CblRT5zG.js";import{_ as Be}from"./round-search-D0NIJO1w.js";import{_ as Ie}from"./round-refresh-BaPFSueZ.js";import{N as oe}from"./Popconfirm-ZXnEhqzl.js";const Le={key:0},Me={key:0},Oe={key:0},Ve={key:0},Ge=ee({name:"OperateDrawer",__name:"operate-drawer",props:Y({operateType:{},rowData:{},pid:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:Y(["submitted"],["update:visible"]),setup(S,{emit:L}){const j=le(),z=L,g=S,t=ve(w());Z();function w(){return{pid:void 0,id:"",reqcontent:"",customer:"",cstcontact:"",notes:"",re1:"",re2:"",re3:"",re4:"",fl1:"",fl2:"",fl3:"",fl4:""}}const m=Z([]),{pageData:_,getData:h,nextPage:M}=pe(ue),F=async a=>{const e=a.currentTarget;e.scrollTop+e.offsetHeight>=e.scrollHeight&&_.data.length<_.total&&(M(),m.value=_.data)},O=async()=>{await h({fuzzy:j.userInfo.pname,page:1}),m.value=_.data},V=async()=>{await h({page:1}),m.value=_.data},G=async a=>{t.pid=a};async function H(){var a;O(),Object.assign(t,w()),t.pid=g.pid?g.pid:(a=m.value[0])==null?void 0:a.id,g.operateType==="edit"&&g.rowData&&Object.assign(t,g.rowData)}const{formRef:C,validate:I,restoreValidation:c}=se(),u={pid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择"},reqcontent:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},customer:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},cstcontact:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"}},N=ye(()=>({add:"新增需求变更",edit:"修改需求变更"})[g.operateType]),x=re(S,"visible");async function P(a){if(a)try{const i=await(await fetch(a==null?void 0:a.split("?")[0],{mode:"cors"})).blob(),p=URL.createObjectURL(i),y=document.createElement("a");y.href=p,y.download=a==null?void 0:a.split("?")[1],y.style.display="none",document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(p)}catch(e){console.error("下载失败:",e)}}we(x,()=>{x.value&&(H(),setTimeout(()=>{const a=document.querySelector(".n-scrollbar-content");a==null||a.scrollTo(0,0)},300),c())});async function U({file:a},e){let i=new FormData;i.append("multipartFile",a.file);const{data:p,error:y}=await xe(i);y||(t[e]=p)}function B(){x.value=!1}async function d(){var a,e;if(await I(),g.operateType==="edit"){const{data:i,error:p}=await De([t]);p||(B(),z("submitted"),(a=window.$message)==null||a.success("修改成功"))}else{const{data:i,error:p}=await Se([{...t}]);p||(B(),z("submitted"),(e=window.$message)==null||e.success("添加成功"))}}return(a,e)=>{const i=fe,p=ke,y=me,W=ie,Q=be,K=te,b=Ce;return v(),$(b,{show:x.value,"onUpdate:show":e[17]||(e[17]=s=>x.value=s),title:N.value,preset:"card",class:"w-800px"},{footer:n(()=>[o(K,{justify:"end",size:16},{default:n(()=>[o(l(k),{onClick:B},{default:n(()=>[f(D(l(R)("common.cancel")),1)]),_:1}),o(l(k),{type:"primary",onClick:d},{default:n(()=>[f(D(l(R)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[o(Q,{class:"pr-20px"},{default:n(()=>[o(W,{ref_key:"formRef",ref:C,model:t,rules:u,"label-placement":"left","label-width":120},{default:n(()=>[o(y,{responsive:"screen","item-responsive":""},{default:n(()=>[o(i,{span:"24 m:12",label:"项目列表",path:"pid"},{default:n(()=>[o(l(ce),{clearable:"",filterable:"",value:t.pid,"onUpdate:value":[e[0]||(e[0]=s=>t.pid=s),G],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:V,options:m.value,onScroll:F},null,8,["value","options"])]),_:1}),o(i,{span:"24 m:12",label:"需求内容",path:"reqcontent"},{default:n(()=>[o(l(T),{value:t.reqcontent,"onUpdate:value":e[1]||(e[1]=s=>t.reqcontent=s),placeholder:"请输入"},null,8,["value"])]),_:1}),o(i,{span:"24 m:12",label:"客户联系人",path:"customer"},{default:n(()=>[o(l(T),{value:t.customer,"onUpdate:value":e[2]||(e[2]=s=>t.customer=s),placeholder:"请输入"},null,8,["value"])]),_:1}),o(i,{span:"24 m:12",label:"联系方式",path:"cstcontact"},{default:n(()=>[o(l(T),{value:t.cstcontact,"onUpdate:value":e[3]||(e[3]=s=>t.cstcontact=s),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),o(i,{span:"24 m:12",label:"备注",path:"notes"},{default:n(()=>[o(l(T),{value:t.notes,"onUpdate:value":e[4]||(e[4]=s=>t.notes=s),placeholder:"请输入"},null,8,["value"])]),_:1}),o(i,{span:"24 m:24",label:"附件1",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re1,"onUpdate:value":e[5]||(e[5]=r=>t.re1=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl1?(v(),A("span",Le,[f(D((s=t.fl1)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[6]||(e[6]=r=>t.fl1="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[7]||(e[7]=r=>P(t.fl1))},"下载")])):(v(),$(p,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl1"),"show-file-list":!1},{default:n(()=>[o(l(k),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[18]||(e[18]=[f("选择文件")])),_:1,__:[18]})]),_:1},8,["custom-request"]))]}),_:1}),o(i,{span:"24 m:24",label:"附件2",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re2,"onUpdate:value":e[8]||(e[8]=r=>t.re2=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl2?(v(),A("span",Me,[f(D((s=t.fl2)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[9]||(e[9]=r=>t.fl2="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[10]||(e[10]=r=>P(t.fl2))},"下载")])):(v(),$(p,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl2"),"show-file-list":!1},{default:n(()=>[o(l(k),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[19]||(e[19]=[f("选择文件")])),_:1,__:[19]})]),_:1},8,["custom-request"]))]}),_:1}),o(i,{span:"24 m:24",label:"附件3",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re3,"onUpdate:value":e[11]||(e[11]=r=>t.re3=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl3?(v(),A("span",Oe,[f(D((s=t.fl3)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[12]||(e[12]=r=>t.fl3="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[13]||(e[13]=r=>P(t.fl3))},"下载")])):(v(),$(p,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl3"),"show-file-list":!1},{default:n(()=>[o(l(k),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[20]||(e[20]=[f("选择文件")])),_:1,__:[20]})]),_:1},8,["custom-request"]))]}),_:1}),o(i,{span:"24 m:24",label:"附件4",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re4,"onUpdate:value":e[14]||(e[14]=r=>t.re4=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl4?(v(),A("span",Ve,[f(D((s=t.fl4)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[15]||(e[15]=r=>t.fl4="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[16]||(e[16]=r=>P(t.fl4))},"下载")])):(v(),$(p,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl4"),"show-file-list":!1},{default:n(()=>[o(l(k),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[21]||(e[21]=[f("选择文件")])),_:1,__:[21]})]),_:1},8,["custom-request"]))]}),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Ae=ee({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:Y(["reset","search","clear"],["update:model"]),setup(S,{emit:L}){const j=L,{formRef:z,restoreValidation:g}=se(),t=re(S,"model"),w=le(),m=Z([]),{pageData:_,getData:h,nextPage:M}=pe(ue),F=async c=>{const u=c.currentTarget;u.scrollTop+u.offsetHeight>=u.scrollHeight&&_.data.length<_.total&&(M(),m.value=_.data)},O=async c=>{var u;c?(t.value.pid=c,j("search"),w.setProjectInfo({pname:(u=m.value.find(N=>N.id==c))==null?void 0:u.proname,pid:c})):j("clear")},V=async c=>{await h({fuzzy:c,page:1}),m.value=_.data},G=async()=>{await h({page:1}),m.value=_.data};(async()=>{var c,u;await h({fuzzy:w.userInfo.pname}),m.value=_.data,t.value.pid=w.userInfo.pid?w.userInfo.pid:(c=m.value[0])==null?void 0:c.id,w.setProjectInfo({pid:t.value.pid,pname:(u=m.value.find(N=>N.id==t.value.pid))==null?void 0:u.proname}),j("search")})();async function C(){await g(),t.value.fuzzy="",j("reset")}async function I(){var c,u;t.value.pid?j("search"):((c=window.$message)==null||c.destroyAll(),(u=window.$message)==null||u.warning("请选择项目"))}return(c,u)=>{const N=ce,x=fe,P=Ie,U=k,B=Be,d=te,a=me,e=ie,i=de;return v(),$(i,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[o(e,{ref_key:"formRef",ref:z,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:je(I,["enter"])},{default:n(()=>[o(a,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:n(()=>[o(x,{span:"24 s:12 m:6",label:"项目列表",path:"PrjId"},{default:n(()=>[o(N,{filterable:"",clearable:"",value:t.value.pid,"onUpdate:value":[u[0]||(u[0]=p=>t.value.pid=p),O],placeholder:"请选择项目","label-field":"proname","value-field":"id",options:m.value,onScroll:F,onClear:G,onSearch:V},null,8,["value","options"])]),_:1}),o(x,{span:"24  s:12 m:6",class:"pr-24px"},{default:n(()=>[o(d,{class:"w-full"},{default:n(()=>[o(U,{onClick:C},{icon:n(()=>[o(P,{class:"text-icon"})]),default:n(()=>[f(" "+D(l(R)("common.reset")),1)]),_:1}),o(U,{type:"primary",ghost:"",onClick:I},{icon:n(()=>[o(B,{class:"text-icon"})]),default:n(()=>[f(" "+D(l(R)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),He={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function ne(S){return typeof S=="function"||Object.prototype.toString.call(S)==="[object Object]"&&!$e(S)}const ot=ee({name:"projectmanagement_needchange",__name:"index",setup(S){const L=Ne(),{columns:j,columnChecks:z,data:g,getData:t,loading:w,pagination:m,mobilePagination:_,searchParams:h}=Re({showTotal:!0,immediate:!1,apiFn:Pe,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"reqcontent",title:"需求内容",align:"center",width:120},{key:"customer",title:"客户联系人",align:"center",width:120},{key:"cstcontact",title:"联系方式",align:"center",width:120},{key:"cstresult",title:"结果",align:"center",width:120,render(d){return Te("div",{},d.cstresult==0?"失败":d.cstresult==1?"成功":"")}},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"操作人",align:"center",width:120},{key:"dbtime",title:"操作时间",align:"center",width:120},{key:"operate",title:R("common.operate"),align:"center",width:140,fixed:"right",render:d=>{let a;return o("div",{class:"flex-center gap-8px"},[J(o(k,{type:"primary",ghost:!0,size:"small",onClick:()=>x(d.id)},ne(a=R("common.edit"))?a:{default:()=>[a]}),[[X("no-auth"),"project:Customer:update"]]),o(oe,{onPositiveClick:()=>N(d.id)},{default:()=>R("common.confirmDelete"),trigger:()=>{let e;return J(o(k,{type:"error",ghost:!0,size:"small"},ne(e=R("common.delete"))?e:{default:()=>[e]}),[[X("no-auth"),"project:Customer:delete"]])}})])}}]}),M=()=>{g.value=[],m.itemCount=0},{drawerVisible:F,operateType:O,editingData:V,handleAdd:G,handleEdit:H,checkedRowKeys:C,onBatchDeleted:I,onDeleted:c}=Fe(g,t);Ue(async()=>{});async function u(){console.log(C.value),P(C.value.join(","),d=>{I()})}async function N(d){const{data:a,error:e}=await ae(d,h.pid);e||c()}function x(d){H(d)}async function P(d,a){const{data:e,error:i}=await ae(d,h.pid);if(!i)a&&a(e);else return!1}const U=d=>{t()},B=()=>{t()};return(d,a)=>{const e=te,i=he,p=ge,y=_e,W=qe,Q=de,K=X("no-auth");return v(),A("div",He,[o(Ae,{model:l(h),"onUpdate:model":a[0]||(a[0]=b=>E(h)?h.value=b:null),onReset:B,onSearch:l(t),onClear:M},null,8,["model","onSearch"]),o(Q,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:n(()=>[o(e,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:n(()=>a[4]||(a[4]=[q("div",null,"需求变更",-1)])),_:1,__:[4]})]),"header-extra":n(()=>[o(e,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:n(()=>[J((v(),$(l(k),{onClick:l(G),size:"small",ghost:"",type:"primary"},{icon:n(()=>[o(i,{class:"text-icon"})]),default:n(()=>[a[5]||(a[5]=f(" "+D("新增")))]),_:1,__:[5]},8,["onClick"])),[[K,"project:Customer:insert"]]),o(l(oe),{onPositiveClick:u},{trigger:n(()=>[J((v(),$(l(k),{size:"small",ghost:"",type:"error",disabled:l(C).length==0},{icon:n(()=>[o(p,{class:ze(["text-icon",{"animate-spin":l(w)}])},null,8,["class"])]),default:n(()=>[a[6]||(a[6]=f(" "+D("批量删除")))]),_:1,__:[6]},8,["disabled"])),[[K,"project:Customer:delete"]])]),default:n(()=>[a[7]||(a[7]=f(" 确定要删除选中的吗？ "))]),_:1,__:[7]}),o(y,{columns:l(z),"onUpdate:columns":a[1]||(a[1]=b=>E(z)?z.value=b:null)},null,8,["columns"])]),_:1})]),default:n(()=>[o(W,{"checked-row-keys":l(C),"onUpdate:checkedRowKeys":a[2]||(a[2]=b=>E(C)?C.value=b:null),columns:l(j),data:l(g),size:"small","flex-height":!l(L).isMobile,loading:l(w),remote:"","row-key":b=>b.id,pagination:l(_),class:"sm:h-full","onUpdate:filters":U},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),o(Ge,{visible:l(F),"onUpdate:visible":a[3]||(a[3]=b=>E(F)?F.value=b:null),onSubmitted:l(t),pid:l(h).pid,"operate-type":l(O),"row-data":l(V)},null,8,["visible","onSubmitted","pid","operate-type","row-data"])]),_:1})])}}});export{ot as default};
