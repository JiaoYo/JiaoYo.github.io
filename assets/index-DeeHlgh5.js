import{_ as Ce}from"./table-column-setting.vue_vue_type_script_setup_true_lang-DR_-APvx.js";import{_ as xe}from"./round-delete-DqVens2M.js";import{_ as Se}from"./round-add-CRyZaE6z.js";import{d as te,aE as ee,m as re,r as Te,H as Y,n as ie,a as je,aG as ce,aC as Ne,bY as ue,d2 as De,d3 as Ue,c as T,o as g,w as l,f as t,Z as ze,C as pe,h as n,aD as de,x as R,b as J,s as Q,g as b,e as q,t as C,aI as Pe,B as N,aJ as qe,N as ae,$ as B,a0 as $e,cs as me,aO as fe,aQ as Re,A as Be,Y as ge,aS as Ie,i as Le,q as X,aT as Z,aH as Me,y as W,aU as Fe,d4 as ne,d5 as Oe,ae as Ve,aY as Ae}from"./index-CcQeCAU2.js";import{u as Ee,a as Ge}from"./table-BCI5iDb3.js";import{u as _e}from"./usePageData-BOHG_mYN.js";import{_ as ve}from"./Grid-fZ6d61Oc.js";import{_ as he}from"./FormItemGridItem-ChLVyUt0.js";import{_ as He}from"./round-search-DoegYRZG.js";import{_ as Ke}from"./round-refresh-DedALtP7.js";import{N as oe}from"./Popconfirm-ChYgVziE.js";const Ye={key:0,style:{"margin-left":"20px"}},Je={key:0,style:{"margin-left":"20px"}},Qe={key:0,style:{"margin-left":"20px"}},Ze={key:0,style:{"margin-left":"20px"}},We=te({name:"OperateDrawer",__name:"operate-drawer",props:ee({operateType:{},rowData:{},pid:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:ee(["submitted"],["update:visible"]),setup(D,{emit:O}){const U=re(),$=O,x=D,e=Te(j());Y();function j(){return{pid:void 0,id:"",reqcontent:"",customer:"",cstcontact:"",notes:"",re1:"",re2:"",re3:"",re4:"",fl1:"",fl2:"",fl3:"",fl4:""}}const _=Y([]),{pageData:k,getData:S,nextPage:V}=_e(me),I=async o=>{const a=o.currentTarget,i=a.scrollTop;a.scrollTop+a.offsetHeight>=a.scrollHeight&&k.data.length<k.total&&(await V(),_.value=k.data,await fe(),setTimeout(()=>{a.scrollTop=i}))},A=async()=>{await S({fuzzy:U.userInfo.pname,page:1}),_.value=k.data},E=async()=>{await S({page:1}),_.value=k.data},G=async o=>{e.pid=o};async function M(){var o;A(),Object.assign(e,j()),e.pid=x.pid?x.pid:(o=_.value[0])==null?void 0:o.id,x.operateType==="edit"&&x.rowData&&Object.assign(e,x.rowData)}const{formRef:z,validate:H,restoreValidation:F}=ie(),u={pid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择"},reqcontent:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},customer:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},cstcontact:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"}},p=je(()=>({add:"新增需求变更",edit:"修改需求变更"})[x.operateType]),y=ce(D,"visible");async function P(o){if(o)try{const i=await(await fetch(o==null?void 0:o.split("?")[0],{mode:"cors"})).blob(),h=URL.createObjectURL(i),m=document.createElement("a");m.href=h,m.download=o==null?void 0:o.split("?")[1],m.style.display="none",document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(h)}catch(a){console.error("下载失败:",a)}}Ne(y,()=>{y.value&&(M(),setTimeout(()=>{const o=document.querySelector(".n-scrollbar-content");o==null||o.scrollTo(0,0)},300),F())});const c=Y(0),f=Y("");async function d({file:o},a){c.value=0,f.value=a;const i=await Re(o.file,o.name,"",h=>{c.value=h});i&&(e[a]=i,c.value=0)}function r(){y.value=!1}async function v(o){var a;return o.file.file.size>100*1024*1024?((a=window.$message)==null||a.error("文件大小不能超过100M"),!1):!0}const L=ue.debounce(async()=>{await K()},1e3,{leading:!0,trailing:!1});async function K(){var o,a;if(await H(),x.operateType==="edit"){const{data:i,error:h}=await De([e]);h||(r(),$("submitted"),(o=window.$message)==null||o.success("修改成功"))}else{const{data:i,error:h}=await Ue([{...e}]);h||(r(),$("submitted"),(a=window.$message)==null||a.success("添加成功"))}}return(o,a)=>{const i=he,h=Pe,m=qe,le=ve,ye=pe,we=ze,be=ae,ke=$e;return g(),T(ke,{show:y.value,"onUpdate:show":a[17]||(a[17]=s=>y.value=s),title:p.value,preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{footer:l(()=>[t(be,{justify:"end",size:16},{default:l(()=>[t(n(N),{onClick:r},{default:l(()=>[b(C(n(B)("common.cancel")),1)]),_:1}),t(n(N),{type:"primary",onClick:n(L)},{default:l(()=>[b(C(n(B)("common.confirm")),1)]),_:1},8,["onClick"])]),_:1})]),default:l(()=>[t(we,{class:"pr-20px"},{default:l(()=>[t(ye,{ref_key:"formRef",ref:z,model:e,rules:u,"label-placement":"left","label-width":120},{default:l(()=>[t(le,{responsive:"screen","item-responsive":""},{default:l(()=>[t(i,{span:"24 m:12",label:"项目列表",path:"pid"},{default:l(()=>[t(n(de),{clearable:"",filterable:"",value:e.pid,"onUpdate:value":[a[0]||(a[0]=s=>e.pid=s),G],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:E,options:_.value,onScroll:I},null,8,["value","options"])]),_:1}),t(i,{span:"24 m:12",label:"需求内容",path:"reqcontent"},{default:l(()=>[t(n(R),{value:e.reqcontent,"onUpdate:value":a[1]||(a[1]=s=>e.reqcontent=s),placeholder:"请输入"},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"客户联系人",path:"customer"},{default:l(()=>[t(n(R),{value:e.customer,"onUpdate:value":a[2]||(a[2]=s=>e.customer=s),placeholder:"请输入"},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"联系方式",path:"cstcontact"},{default:l(()=>[t(n(R),{value:e.cstcontact,"onUpdate:value":a[3]||(a[3]=s=>e.cstcontact=s),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"备注",path:"notes"},{default:l(()=>[t(n(R),{value:e.notes,"onUpdate:value":a[4]||(a[4]=s=>e.notes=s),placeholder:"请输入"},null,8,["value"])]),_:1}),t(i,{span:"24 m:24",label:"",path:"notes","show-feedback":!1},{default:l(()=>[t(le,{responsive:"screen","item-responsive":""},{default:l(()=>[t(i,{span:"24 m:12",label:"附件1",path:"notes"},{default:l(()=>[t(n(R),{value:e.re1,"onUpdate:value":a[5]||(a[5]=s=>e.re1=s),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var s;return[e.fl1?(g(),J("span",Ye,[b(C((s=e.fl1)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:a[6]||(a[6]=w=>e.fl1="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[7]||(a[7]=w=>P(e.fl1))},"下载")])):(g(),T(h,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":w=>d(w,"fl1"),"show-file-list":!1,onBeforeUpload:v},{default:l(()=>[t(n(N),{loading:c.value>0&&!e.fl1&&f.value=="fl1",size:"small",ghost:"",type:"primary"},{default:l(()=>[b(C(c.value>0&&!e.fl1&&f.value=="fl1"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),c.value&&!e.fl1&&f.value=="fl1"?(g(),T(m,{key:2,type:"line",percentage:c.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):Q("",!0)]}),_:1})]),_:1})]),_:1}),t(i,{span:"24 m:12",label:"附件2",path:"notes"},{default:l(()=>[t(n(R),{value:e.re2,"onUpdate:value":a[8]||(a[8]=s=>e.re2=s),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var s;return[e.fl2?(g(),J("span",Je,[b(C((s=e.fl2)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:a[9]||(a[9]=w=>e.fl2="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[10]||(a[10]=w=>P(e.fl2))},"下载")])):(g(),T(h,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":w=>d(w,"fl2"),"show-file-list":!1,onBeforeUpload:v},{default:l(()=>[t(n(N),{loading:c.value>0&&!e.fl2&&f.value=="fl2",size:"small",ghost:"",type:"primary"},{default:l(()=>[b(C(c.value>0&&!e.fl2&&f.value=="fl2"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),c.value&&!e.fl2&&f.value=="fl2"?(g(),T(m,{key:2,type:"line",percentage:c.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):Q("",!0)]}),_:1}),t(i,{span:"24 m:12",label:"附件3",path:"notes"},{default:l(()=>[t(n(R),{value:e.re3,"onUpdate:value":a[11]||(a[11]=s=>e.re3=s),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var s;return[e.fl3?(g(),J("span",Qe,[b(C((s=e.fl3)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:a[12]||(a[12]=w=>e.fl3="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[13]||(a[13]=w=>P(e.fl3))},"下载")])):(g(),T(h,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":w=>d(w,"fl3"),"show-file-list":!1,onBeforeUpload:v},{default:l(()=>[t(n(N),{loading:c.value>0&&!e.fl3&&f.value=="fl3",size:"small",ghost:"",type:"primary"},{default:l(()=>[b(C(c.value>0&&!e.fl3&&f.value=="fl3"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),c.value&&!e.fl3&&f.value=="fl3"?(g(),T(m,{key:2,type:"line",percentage:c.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):Q("",!0)]}),_:1}),t(i,{span:"24 m:12",label:"附件4",path:"notes"},{default:l(()=>[t(n(R),{value:e.re4,"onUpdate:value":a[14]||(a[14]=s=>e.re4=s),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var s;return[e.fl4?(g(),J("span",Ze,[b(C((s=e.fl4)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:a[15]||(a[15]=w=>e.fl4="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[16]||(a[16]=w=>P(e.fl4))},"下载")])):(g(),T(h,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":w=>d(w,"fl4"),"show-file-list":!1},{default:l(()=>[t(n(N),{loading:c.value>0&&!e.fl4&&f.value=="fl4",size:"small",ghost:"",type:"primary"},{default:l(()=>[b(C(c.value>0&&!e.fl4&&f.value=="fl4"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),c.value&&!e.fl4&&f.value=="fl4"?(g(),T(m,{key:2,type:"line",percentage:c.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):Q("",!0)]}),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Xe=te({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:ee(["reset","search","clear"],["update:model"]),setup(D,{emit:O}){const U=O,{formRef:$,restoreValidation:x}=ie(),e=ce(D,"model"),j=re(),_=Y([]),{pageData:k,getData:S,nextPage:V}=_e(me),I=async u=>{const p=u.currentTarget,y=p.scrollTop;p.scrollTop+p.offsetHeight>=p.scrollHeight&&k.data.length<k.total&&(await V(),_.value=k.data,await fe(),setTimeout(()=>{p.scrollTop=y}))},A=async u=>{var p;u?(e.value.pid=u,U("search"),j.setProjectInfo({pname:(p=_.value.find(y=>y.id==u))==null?void 0:p.proname,pid:u})):U("clear")},E=ue.debounce(async u=>{await S({fuzzy:u,page:1}),_.value=k.data},300),G=u=>{if(!u){e.value.pid=null,M();return}E(u)},M=async()=>{await S({page:1}),_.value=k.data};(async()=>{var u,p;await S({fuzzy:j.userInfo.pname}),_.value=k.data,e.value.pid=j.userInfo.pid?j.userInfo.pid:(u=_.value[0])==null?void 0:u.id,j.setProjectInfo({pid:e.value.pid,pname:(p=_.value.find(y=>y.id==e.value.pid))==null?void 0:p.proname}),U("search")})();async function H(){await x(),e.value.fuzzy="",U("reset")}async function F(){var u,p;e.value.pid?U("search"):((u=window.$message)==null||u.destroyAll(),(p=window.$message)==null||p.warning("请选择项目"))}return(u,p)=>{const y=de,P=he,c=Ke,f=N,d=He,r=ae,v=ve,L=pe,K=ge;return g(),T(K,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[t(L,{ref_key:"formRef",ref:$,model:e.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Be(F,["enter"])},{default:l(()=>[t(v,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:l(()=>[t(P,{span:"24 s:12 m:6",label:"项目列表",path:"PrjId"},{default:l(()=>[t(y,{filterable:"",clearable:"",value:e.value.pid,"onUpdate:value":[p[0]||(p[0]=o=>e.value.pid=o),A],placeholder:"请选择项目","label-field":"proname","value-field":"id",options:_.value,onScroll:I,onClear:M,onSearch:G},null,8,["value","options"])]),_:1}),t(P,{span:"24  s:12 m:6",class:"pr-24px"},{default:l(()=>[t(r,{class:"w-full"},{default:l(()=>[t(f,{onClick:H},{icon:l(()=>[t(c,{class:"text-icon"})]),default:l(()=>[b(" "+C(n(B)("common.reset")),1)]),_:1}),t(f,{type:"primary",ghost:"",onClick:F},{icon:l(()=>[t(d,{class:"text-icon"})]),default:l(()=>[b(" "+C(n(B)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),et={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function se(D){return typeof D=="function"||Object.prototype.toString.call(D)==="[object Object]"&&!Ae(D)}const dt=te({name:"projectmanagement_needchange",__name:"index",setup(D){const O=Ie(),{columns:U,columnChecks:$,data:x,getData:e,loading:j,pagination:_,mobilePagination:k,searchParams:S}=Ee({showTotal:!0,immediate:!1,apiFn:Oe,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"reqcontent",title:"需求内容",align:"center",width:120},{key:"customer",title:"客户联系人",align:"center",width:120},{key:"cstcontact",title:"联系方式",align:"center",width:120},{key:"cstresult",title:"结果",align:"center",width:120,render(d){return Ve("div",{},d.cstresult==0?"失败":d.cstresult==1?"成功":"")}},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"操作人",align:"center",width:120},{key:"dbtime",title:"操作时间",align:"center",width:120},{key:"operate",title:B("common.operate"),align:"center",width:140,fixed:"right",render:d=>{let r;return t("div",{class:"flex-center gap-8px"},[W(t(N,{type:"primary",ghost:!0,size:"small",onClick:()=>y(d.id)},se(r=B("common.edit"))?r:{default:()=>[r]}),[[X("no-auth"),"project:Customer:update"]]),t(oe,{onPositiveClick:()=>p(d.id)},{default:()=>B("common.confirmDelete"),trigger:()=>{let v;return W(t(N,{type:"error",ghost:!0,size:"small"},se(v=B("common.delete"))?v:{default:()=>[v]}),[[X("no-auth"),"project:Customer:delete"]])}})])}}]}),V=()=>{x.value=[],_.itemCount=0},{drawerVisible:I,operateType:A,editingData:E,handleAdd:G,handleEdit:M,checkedRowKeys:z,onBatchDeleted:H,onDeleted:F}=Ge(x,e);Le(async()=>{});async function u(){console.log(z.value),P(z.value.join(","),d=>{H()})}async function p(d){const{data:r,error:v}=await ne(d,S.pid);v||F()}function y(d){M(d)}async function P(d,r){const{data:v,error:L}=await ne(d,S.pid);if(!L)r&&r(v);else return!1}const c=d=>{e()},f=()=>{e()};return(d,r)=>{const v=ae,L=Se,K=xe,o=Ce,a=Me,i=ge,h=X("no-auth");return g(),J("div",et,[t(Xe,{model:n(S),"onUpdate:model":r[0]||(r[0]=m=>Z(S)?S.value=m:null),onReset:f,onSearch:n(e),onClear:V},null,8,["model","onSearch"]),t(i,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:l(()=>[t(v,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:l(()=>r[4]||(r[4]=[q("div",null,"需求变更",-1)])),_:1,__:[4]})]),"header-extra":l(()=>[t(v,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:l(()=>[W((g(),T(n(N),{onClick:n(G),size:"small",ghost:"",type:"primary"},{icon:l(()=>[t(L,{class:"text-icon"})]),default:l(()=>[r[5]||(r[5]=b(" "+C("新增")))]),_:1,__:[5]},8,["onClick"])),[[h,"project:Customer:insert"]]),t(n(oe),{onPositiveClick:u},{trigger:l(()=>[W((g(),T(n(N),{size:"small",ghost:"",type:"error",disabled:n(z).length==0},{icon:l(()=>[t(K,{class:Fe(["text-icon",{"animate-spin":n(j)}])},null,8,["class"])]),default:l(()=>[r[6]||(r[6]=b(" "+C("批量删除")))]),_:1,__:[6]},8,["disabled"])),[[h,"project:Customer:delete"]])]),default:l(()=>[r[7]||(r[7]=b(" 确定要删除选中的吗？ "))]),_:1,__:[7]}),t(o,{columns:n($),"onUpdate:columns":r[1]||(r[1]=m=>Z($)?$.value=m:null)},null,8,["columns"])]),_:1})]),default:l(()=>[t(a,{"checked-row-keys":n(z),"onUpdate:checkedRowKeys":r[2]||(r[2]=m=>Z(z)?z.value=m:null),columns:n(U),data:n(x),size:"small","flex-height":!n(O).isMobile,loading:n(j),remote:"","row-key":m=>m.id,pagination:n(k),class:"sm:h-full","onUpdate:filters":c},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),t(We,{visible:n(I),"onUpdate:visible":r[3]||(r[3]=m=>Z(I)?I.value=m:null),onSubmitted:n(e),pid:n(S).pid,"operate-type":n(A),"row-data":n(E)},null,8,["visible","onSubmitted","pid","operate-type","row-data"])]),_:1})])}}});export{dt as default};
