import{_ as _e}from"./table-column-setting.vue_vue_type_script_setup_true_lang-Bd_ydgz6.js";import{_ as ge}from"./round-delete-DpC2P942.js";import{_ as he}from"./round-add-D3WUtpeV.js";import{d as ee,as as Y,p as le,s as ve,r as Z,q as se,a as ye,at as re,a1 as we,c as $,o as v,w as n,f as o,b7 as be,F as ie,h as l,av as ce,A as T,b as E,g as f,e as q,t as S,bp as ke,B as k,N as te,$ as R,b8 as Ce,ad as de,c0 as xe,cF as Se,cG as je,E as De,U as ue,L as Ne,i as Ue,x as X,aB as K,ax as qe,C as W,bn as ze,cH as ae,cI as Pe,W as Te,aE as $e}from"./index-GKZr6R-C.js";import{u as Re,a as Fe}from"./table-VcDsA4zD.js";import{u as pe}from"./usePageData-CFaE5rQl.js";import{_ as me}from"./Grid-C-96xXAi.js";import{_ as fe}from"./FormItemGridItem-Dlimnbl-.js";import{_ as Le}from"./round-search-DYdIbIbe.js";import{_ as Be}from"./round-refresh-BRaDYp-e.js";import{N as oe}from"./Popconfirm-C9ev1_yH.js";const Ie={key:0},Me={key:0},Oe={key:0},Ve={key:0},Ae=ee({name:"OperateDrawer",__name:"operate-drawer",props:Y({operateType:{},rowData:{},pid:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:Y(["submitted"],["update:visible"]),setup(j,{emit:I}){const D=le(),z=I,g=j,t=ve(w());Z();function w(){return{pid:void 0,id:"",reqcontent:"",customer:"",cstcontact:"",notes:"",re1:"",re2:"",re3:"",re4:"",fl1:"",fl2:"",fl3:"",fl4:""}}const m=Z([]),{pageData:_,getData:h,nextPage:M}=pe(de),F=async a=>{const e=a.currentTarget;e.scrollTop+e.offsetHeight>=e.scrollHeight&&_.data.length<_.total&&(M(),m.value=_.data)},O=async()=>{await h({fuzzy:D.userInfo.pname}),m.value=_.data},V=async()=>{await h(),m.value=_.data},A=async a=>{t.pid=a};async function G(){var a;O(),Object.assign(t,w()),t.pid=g.pid?g.pid:(a=m.value[0])==null?void 0:a.id,g.operateType==="edit"&&g.rowData&&Object.assign(t,g.rowData)}const{formRef:C,validate:B,restoreValidation:c}=se(),d={pid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择"},reqcontent:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},customer:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},cstcontact:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"}},N=ye(()=>({add:"新增需求变更",edit:"修改需求变更"})[g.operateType]),x=re(j,"visible");async function P(a){if(a)try{const i=await(await fetch(a==null?void 0:a.split("?")[0],{mode:"cors"})).blob(),p=URL.createObjectURL(i),y=document.createElement("a");y.href=p,y.download=a==null?void 0:a.split("?")[1],y.style.display="none",document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(p)}catch(e){console.error("下载失败:",e)}}we(x,()=>{x.value&&(G(),setTimeout(()=>{const a=document.querySelector(".n-scrollbar-content");a==null||a.scrollTo(0,0)},300),c())});async function U({file:a},e){let i=new FormData;i.append("multipartFile",a.file);const{data:p,error:y}=await xe(i);y||(t[e]=p)}function L(){x.value=!1}async function u(){var a,e;if(await B(),g.operateType==="edit"){const{data:i,error:p}=await Se([t]);p||(L(),z("submitted"),(a=window.$message)==null||a.success("修改成功"))}else{const{data:i,error:p}=await je([{...t}]);p||(L(),z("submitted"),(e=window.$message)==null||e.success("添加成功"))}}return(a,e)=>{const i=fe,p=ke,y=me,J=ie,Q=be,H=te,b=Ce;return v(),$(b,{show:x.value,"onUpdate:show":e[17]||(e[17]=s=>x.value=s),title:N.value,preset:"card",class:"w-800px"},{footer:n(()=>[o(H,{justify:"end",size:16},{default:n(()=>[o(l(k),{onClick:L},{default:n(()=>[f(S(l(R)("common.cancel")),1)]),_:1}),o(l(k),{type:"primary",onClick:u},{default:n(()=>[f(S(l(R)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[o(Q,{class:"pr-20px"},{default:n(()=>[o(J,{ref_key:"formRef",ref:C,model:t,rules:d,"label-placement":"left","label-width":120},{default:n(()=>[o(y,{responsive:"screen","item-responsive":""},{default:n(()=>[o(i,{span:"24 m:12",label:"项目列表",path:"pid"},{default:n(()=>[o(l(ce),{clearable:"",filterable:"",value:t.pid,"onUpdate:value":[e[0]||(e[0]=s=>t.pid=s),A],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:V,options:m.value,onScroll:F},null,8,["value","options"])]),_:1}),o(i,{span:"24 m:12",label:"需求内容",path:"reqcontent"},{default:n(()=>[o(l(T),{value:t.reqcontent,"onUpdate:value":e[1]||(e[1]=s=>t.reqcontent=s),placeholder:"请输入"},null,8,["value"])]),_:1}),o(i,{span:"24 m:12",label:"客户联系人",path:"customer"},{default:n(()=>[o(l(T),{value:t.customer,"onUpdate:value":e[2]||(e[2]=s=>t.customer=s),placeholder:"请输入"},null,8,["value"])]),_:1}),o(i,{span:"24 m:12",label:"联系方式",path:"cstcontact"},{default:n(()=>[o(l(T),{value:t.cstcontact,"onUpdate:value":e[3]||(e[3]=s=>t.cstcontact=s),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),o(i,{span:"24 m:12",label:"备注",path:"notes"},{default:n(()=>[o(l(T),{value:t.notes,"onUpdate:value":e[4]||(e[4]=s=>t.notes=s),placeholder:"请输入"},null,8,["value"])]),_:1}),o(i,{span:"24 m:24",label:"附件1",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re1,"onUpdate:value":e[5]||(e[5]=r=>t.re1=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl1?(v(),E("span",Ie,[f(S((s=t.fl1)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[6]||(e[6]=r=>t.fl1="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[7]||(e[7]=r=>P(t.fl1))},"下载")])):(v(),$(p,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl1"),"show-file-list":!1},{default:n(()=>[o(l(k),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[18]||(e[18]=[f("选择文件")])),_:1,__:[18]})]),_:1},8,["custom-request"]))]}),_:1}),o(i,{span:"24 m:24",label:"附件2",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re2,"onUpdate:value":e[8]||(e[8]=r=>t.re2=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl2?(v(),E("span",Me,[f(S((s=t.fl2)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[9]||(e[9]=r=>t.fl2="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[10]||(e[10]=r=>P(t.fl2))},"下载")])):(v(),$(p,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl2"),"show-file-list":!1},{default:n(()=>[o(l(k),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[19]||(e[19]=[f("选择文件")])),_:1,__:[19]})]),_:1},8,["custom-request"]))]}),_:1}),o(i,{span:"24 m:24",label:"附件3",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re3,"onUpdate:value":e[11]||(e[11]=r=>t.re3=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl3?(v(),E("span",Oe,[f(S((s=t.fl3)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[12]||(e[12]=r=>t.fl3="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[13]||(e[13]=r=>P(t.fl3))},"下载")])):(v(),$(p,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl3"),"show-file-list":!1},{default:n(()=>[o(l(k),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[20]||(e[20]=[f("选择文件")])),_:1,__:[20]})]),_:1},8,["custom-request"]))]}),_:1}),o(i,{span:"24 m:24",label:"附件4",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re4,"onUpdate:value":e[14]||(e[14]=r=>t.re4=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl4?(v(),E("span",Ve,[f(S((s=t.fl4)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[15]||(e[15]=r=>t.fl4="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[16]||(e[16]=r=>P(t.fl4))},"下载")])):(v(),$(p,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl4"),"show-file-list":!1},{default:n(()=>[o(l(k),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[21]||(e[21]=[f("选择文件")])),_:1,__:[21]})]),_:1},8,["custom-request"]))]}),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Ee=ee({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:Y(["reset","search","clear"],["update:model"]),setup(j,{emit:I}){const D=I,{formRef:z,restoreValidation:g}=se(),t=re(j,"model"),w=le(),m=Z([]),{pageData:_,getData:h,nextPage:M}=pe(de),F=async c=>{const d=c.currentTarget;d.scrollTop+d.offsetHeight>=d.scrollHeight&&_.data.length<_.total&&(M(),m.value=_.data)},O=async c=>{var d;c?(t.value.pid=c,D("search"),w.setProjectInfo({pname:(d=m.value.find(N=>N.id==c))==null?void 0:d.proname,pid:c})):D("clear")},V=async c=>{await h({fuzzy:c,page:1}),m.value=_.data},A=async()=>{await h({page:1}),m.value=_.data};(async()=>{var c,d;await h({fuzzy:w.userInfo.pname}),m.value=_.data,t.value.pid=w.userInfo.pid?w.userInfo.pid:(c=m.value[0])==null?void 0:c.id,w.setProjectInfo({pid:t.value.pid,pname:(d=m.value.find(N=>N.id==t.value.pid))==null?void 0:d.proname}),D("search")})();async function C(){await g(),t.value.fuzzy="",D("reset")}async function B(){var c,d;t.value.pid?D("search"):((c=window.$message)==null||c.destroyAll(),(d=window.$message)==null||d.warning("请选择项目"))}return(c,d)=>{const N=ce,x=fe,P=Be,U=k,L=Le,u=te,a=me,e=ie,i=ue;return v(),$(i,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[o(e,{ref_key:"formRef",ref:z,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:De(B,["enter"])},{default:n(()=>[o(a,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:n(()=>[o(x,{span:"24 s:12 m:6",label:"项目列表",path:"PrjId"},{default:n(()=>[o(N,{filterable:"",clearable:"",value:t.value.pid,"onUpdate:value":[d[0]||(d[0]=p=>t.value.pid=p),O],placeholder:"请选择项目","label-field":"proname","value-field":"id",options:m.value,onScroll:F,onClear:A,onSearch:V},null,8,["value","options"])]),_:1}),o(x,{span:"24  s:12 m:6",class:"pr-24px"},{default:n(()=>[o(u,{class:"w-full"},{default:n(()=>[o(U,{onClick:C},{icon:n(()=>[o(P,{class:"text-icon"})]),default:n(()=>[f(" "+S(l(R)("common.reset")),1)]),_:1}),o(U,{type:"primary",ghost:"",onClick:B},{icon:n(()=>[o(L,{class:"text-icon"})]),default:n(()=>[f(" "+S(l(R)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Ge={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function ne(j){return typeof j=="function"||Object.prototype.toString.call(j)==="[object Object]"&&!$e(j)}const ot=ee({name:"projectmanagement_needchange",__name:"index",setup(j){const I=Ne(),{columns:D,columnChecks:z,data:g,getData:t,loading:w,pagination:m,mobilePagination:_,searchParams:h}=Re({showTotal:!0,immediate:!1,apiFn:Pe,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"reqcontent",title:"需求内容",align:"center",width:120},{key:"customer",title:"客户联系人",align:"center",width:120},{key:"cstcontact",title:"联系方式",align:"center",width:120},{key:"cstresult",title:"结果",align:"center",width:120,render(u){return Te("div",{},u.cstresult==0?"失败":u.cstresult==1?"成功":"")}},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"操作人",align:"center",width:120},{key:"dbtime",title:"操作时间",align:"center",width:120},{key:"operate",title:R("common.operate"),align:"center",width:140,fixed:"right",render:u=>{let a;return o("div",{class:"flex-center gap-8px"},[W(o(k,{type:"primary",ghost:!0,size:"small",onClick:()=>x(u.id)},ne(a=R("common.edit"))?a:{default:()=>[a]}),[[X("no-auth"),"project:Customer:update"]]),o(oe,{onPositiveClick:()=>N(u.id)},{default:()=>R("common.confirmDelete"),trigger:()=>{let e;return W(o(k,{type:"error",ghost:!0,size:"small"},ne(e=R("common.delete"))?e:{default:()=>[e]}),[[X("no-auth"),"project:Customer:delete"]])}})])}}]}),M=()=>{g.value=[],m.itemCount=0},{drawerVisible:F,operateType:O,editingData:V,handleAdd:A,handleEdit:G,checkedRowKeys:C,onBatchDeleted:B,onDeleted:c}=Fe(g,t);Ue(async()=>{});async function d(){console.log(C.value),P(C.value.join(","),u=>{B()})}async function N(u){const{data:a,error:e}=await ae(u,h.pid);e||c()}function x(u){G(u)}async function P(u,a){const{data:e,error:i}=await ae(u,h.pid);if(!i)a&&a(e);else return!1}const U=u=>{t()},L=()=>{t()};return(u,a)=>{const e=te,i=he,p=ge,y=_e,J=qe,Q=ue,H=X("no-auth");return v(),E("div",Ge,[o(Ee,{model:l(h),"onUpdate:model":a[0]||(a[0]=b=>K(h)?h.value=b:null),onReset:L,onSearch:l(t),onClear:M},null,8,["model","onSearch"]),o(Q,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:n(()=>[o(e,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:n(()=>a[4]||(a[4]=[q("div",null,"需求变更",-1)])),_:1,__:[4]})]),"header-extra":n(()=>[o(e,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:n(()=>[W((v(),$(l(k),{onClick:l(A),size:"small",ghost:"",type:"primary"},{icon:n(()=>[o(i,{class:"text-icon"})]),default:n(()=>[a[5]||(a[5]=f(" "+S("新增")))]),_:1,__:[5]},8,["onClick"])),[[H,"project:Customer:insert"]]),o(l(oe),{onPositiveClick:d},{trigger:n(()=>[W((v(),$(l(k),{size:"small",ghost:"",type:"error",disabled:l(C).length==0},{icon:n(()=>[o(p,{class:ze(["text-icon",{"animate-spin":l(w)}])},null,8,["class"])]),default:n(()=>[a[6]||(a[6]=f(" "+S("批量删除")))]),_:1,__:[6]},8,["disabled"])),[[H,"project:Customer:delete"]])]),default:n(()=>[a[7]||(a[7]=f(" 确定要删除选中的吗？ "))]),_:1,__:[7]}),o(y,{columns:l(z),"onUpdate:columns":a[1]||(a[1]=b=>K(z)?z.value=b:null)},null,8,["columns"])]),_:1})]),default:n(()=>[o(J,{"checked-row-keys":l(C),"onUpdate:checkedRowKeys":a[2]||(a[2]=b=>K(C)?C.value=b:null),columns:l(D),data:l(g),size:"small","flex-height":!l(I).isMobile,loading:l(w),remote:"","row-key":b=>b.id,pagination:l(_),class:"sm:h-full","onUpdate:filters":U},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),o(Ae,{visible:l(F),"onUpdate:visible":a[3]||(a[3]=b=>K(F)?F.value=b:null),onSubmitted:l(t),pid:l(h).pid,"operate-type":l(O),"row-data":l(V)},null,8,["visible","onSubmitted","pid","operate-type","row-data"])]),_:1})])}}});export{ot as default};
