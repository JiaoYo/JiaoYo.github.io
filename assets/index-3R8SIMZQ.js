import{_ as ie}from"./round-search-6gH5MaEH.js";import{d as te,r as w,a as P,aw as ae,i as le,dF as ce,b as T,o as g,e as f,z as O,aR as ne,aV as oe,g as M,t as R,cG as ue,aN as de,V as me,aI as ve,aL as se,M as pe,aZ as X,e_ as fe,e$ as ge,f as c,aQ as ye,ax as he,w as _,c as S,h as v,ay as be,N as ke,A as we,az as Fe,aC as ee,B as xe,$ as _e,U as Te,aH as De,aS as Me,cl as Ce}from"./index--GDXRx9n.js";import{d as $e}from"./home-B-BgWMDo.js";import{u as Ee}from"./usePageData-GADHvGie.js";import{N as Z}from"./RadioButton-DeB00DGi.js";import{N as J}from"./DatePicker-BbhJnWX3.js";import"./utils-DG-EDt72.js";const Ae={class:"map-wrapper",style:{height:"100%",position:"relative"}},Se={class:"map-legend"},Oe={class:"legend-list"},Ne=["onClick","onContextmenu"],je={key:0,class:"visibility-icon"},Be={key:1,class:"solo-icon"},ze={class:"legend-name"},Ue={class:"visibility-toggle"},Pe={key:0,class:"solo-notice"},Ve=te({__name:"historyMap",props:{trackData:{}},setup(C){const m=w(null);let $=null;const L=C,D=w([]),d=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],a=w({}),y=w(""),E=P(()=>{const e={};return Object.keys(D.value).forEach((t,n)=>{e[t]=d[n%d.length],a.value[t]===void 0&&(a.value[t]=!0)}),e});function x(e){if(y.value){V(e);return}a.value[e]=!a.value[e],F()}function V(e){y.value===e?N():(y.value=e,Object.keys(a.value).forEach(l=>{a.value[l]=l===e}),F())}function N(){y.value="",Object.keys(a.value).forEach(e=>{a.value[e]=!0}),F()}function j(){Object.keys(a.value).forEach(e=>{a.value[e]=!a.value[e]}),y.value="",F()}function W(){Object.keys(a.value).forEach(e=>{a.value[e]=!0}),y.value="",F()}function Y(){Object.keys(a.value).forEach(e=>{a.value[e]=!1}),y.value="",F()}const A=P(()=>{const e=[];return Object.values(D.value).forEach(l=>{e.push(...l)}),e.sort((l,t)=>new Date(l.dbtime).getTime()-new Date(t.dbtime).getTime())}),H=P(()=>{if(A.value.length===0)return[120.370086,30.305716];const e=A.value.map(r=>r.longitude),l=A.value.map(r=>r.latitude),t=(Math.min(...e)+Math.max(...e))/2,n=(Math.min(...l)+Math.max(...l))/2;return console.log(t,n),[t,n]});async function B(){const e="/map-sdk.json",{data:l}=await ve.get(`${e}?_t=${Date.now()}`);return l}function I(e){return new Promise((l,t)=>{if(window.AMap)return l(window.AMap);const n=document.createElement("script");n.src=`https://webapi.amap.com/maps?v=2.0&key=${e}&plugin=AMap.PolylineEditor`,n.defer=!0,n.onload=()=>window.AMap?l(window.AMap):t(new Error("AMapåŠ è½½å¤±è´¥")),n.onerror=()=>t(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(n)})}const b=w({});function z(e,l){const t=l.lng-e.lng,n=l.lat-e.lat;return(Math.atan2(-n,t)*180/Math.PI-90+360)%360-175}function G(e,l,t,n){const r=document.createElement("div");return r.style.cssText=`
    width: 12px;
    height: 18px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 18px solid ${n};
    transform: translate(-50%, -50%) rotate(${t}deg);
    transform-origin: center center;
  `,new e.Marker({position:[l.lng,l.lat],content:r,offset:new e.Pixel(0,0)})}function q(e,l,t,n,r){const h=document.createElement("div");return h.className="custom-marker",h.style.transform="translateX(-50%)",h.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${n}; box-shadow: 0 0 10px ${n}, 0 0 20px ${n};">
      <img src="${r||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png"}" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${n};">${t}</div>
  `,new e.Marker({position:[l.lng,l.lat],content:h})}function K(){m.value&&m.value.clearMap(),b.value={}}function F(){!window.AMap||!m.value||Object.keys(b.value).forEach(e=>{const l=a.value[e];(b.value[e]||[]).forEach(n=>{l?n.show():n.hide()})})}function o(e){K();const l={};Object.entries(D.value).forEach(([t,n])=>{l[t]=n.map(r=>({lng:r.longitude,lat:r.latitude,address:r.address,dbtime:r.dbtime,proname:r.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:r.duration||0,userimage:r.userimage,longitude:r.longitude,latitude:r.latitude}))}),Object.keys(l).forEach(t=>{const n=l[t];console.log(n,"sssasfas fasfadasd");const r=E.value[t];if(n.length===0)return;const h=[];if(n.length>1){const u=new e.Polyline({path:n.map(k=>[k.lng,k.lat]),strokeColor:r,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});u.setMap(m.value),h.push(u)}n.forEach((u,k)=>{console.log(t);const p=q(e,u,t,r,n[0].userimage);p.setMap(m.value),h.push(p),p.on("click",()=>{const U=`
        <div style="
          min-width: 220px;
          background: #fff;
          padding: 12px 14px;
          font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          font-size: 13px;
          color: #333;
          line-height: 1.6;
        ">
          <div style="
            font-weight: bold;
            color: ${r};
            font-size: 15px;
            margin-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 4px;
          ">${t}</div>

          <div style="margin-bottom: 4px;"><b style="color:#555;">åœ°ç‚¹ï¼š</b><span style="color:#333;">${u.address}</span></div>
          <div style="margin-bottom: 4px;"><b style="color:#555;">æ—¶é—´ï¼š</b><span style="color:#333;">${u.dbtime}</span></div>
          <div style="margin-bottom: 4px;"><b style="color:#555;">é¡¹ç›®ï¼š</b><span style="color:#333;">${u.proname}</span></div>
          <div style="margin-bottom: 4px;"><b style="color:#555;">ç»çº¬åº¦ï¼š</b><span style="color:#666; font-size:12px;">
        ${u.longitude} , ${u.latitude}
      </span></div>

          ${u.duration?`<div style="margin-bottom: 4px;"><b style="color:#555;">å·¥æ—¶ï¼š</b><span style="color:#333;">${u.duration} å°æ—¶</span></div>`:""}
          
          </div>
          <div style="
            margin-top: 8px;
            text-align: right;
            color: #999;
            font-size: 12px;
          ">ç¬¬ ${k+1} ä¸ªæ‰“å¡ç‚¹</div>
        `;$.setContent(U),$.open(m.value,p.getPosition())}),p.on("dblclick",()=>{$.open(m.value,p.getPosition()),m.value.setCenter(p.getPosition()),m.value.setZoom(14)})});for(let u=1;u<n.length;u++){const k=n[u-1],p=n[u];if(s(k,p))continue;const U={lng:(k.lng+p.lng)/2,lat:(k.lat+p.lat)/2},re=z(k,p),Q=G(e,U,re,r);Q.setMap(m.value),h.push(Q)}b.value[t]=h}),F()}function s(e,l,t=1e-7){return Math.abs(e.lng-l.lng)<t&&Math.abs(e.lat-l.lat)<t}async function i(){try{const e=await B(),l=await I(e.AMAP_SDK_KEY);m.value=new l.Map("amap-container",{viewMode:"2D",center:H.value,zoom:5,features:["bg","point"]}),$=new l.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),o(l)}catch(e){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",e)}}return ae(()=>L.trackData??[],e=>{console.log(e,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),D.value=e,window.AMap&&m.value&&o(window.AMap)},{immediate:!0,deep:!0}),le(()=>{i()}),ce(()=>{m.value&&m.value.destroy()}),(e,l)=>(g(),T("div",Ae,[l[1]||(l[1]=f("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),f("div",Se,[f("div",{class:"legend-header"},[l[0]||(l[0]=f("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),f("div",{class:"legend-actions"},[f("button",{class:"action-btn",onClick:W},"å…¨æ˜¾"),f("button",{class:"action-btn",onClick:Y},"å…¨éš"),f("button",{class:"action-btn",onClick:j},"åé€‰")])]),f("div",Oe,[(g(!0),T(ne,null,oe(E.value,(t,n)=>(g(),T("div",{key:n,class:de(["legend-item",{"legend-item-hidden":!a.value[n],"legend-item-solo":y.value===n}]),onClick:r=>x(n),onContextmenu:ue(r=>V(n),["prevent"])},[f("div",{class:"legend-color",style:me({backgroundColor:t})},[a.value[n]?O("",!0):(g(),T("span",je,"ğŸ‘ï¸â€ğŸ—¨ï¸")),y.value===n?(g(),T("span",Be,"â­")):O("",!0)],4),f("span",ze,R(n),1),f("span",Ue,R(a.value[n]?"éšè—":"æ˜¾ç¤º"),1)],42,Ne))),128))]),y.value?(g(),T("div",Pe,[M(" ä»…æ˜¾ç¤º: "+R(y.value)+" ",1),f("button",{class:"cancel-solo-btn",onClick:N},"å–æ¶ˆ")])):O("",!0)])]))}}),Ie=se(Ve,[["__scopeId","data-v-657cb08d"]]),Re={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Le(C){return typeof C=="function"||Object.prototype.toString.call(C)==="[object Object]"&&!Me(C)}const We=te({name:"trajectory_historytrajectory",__name:"index",setup(C){const m=pe();function $(o){return o.getFullYear()}function L(o){const s=new Date(o.getFullYear(),0,1),i=(o.getTime()-s.getTime())/864e5,e=s.getDay()||7;return Math.ceil((i+e)/7)}function D(){const o=new Date,s=$(o),i=L(o).toString().padStart(2,"0");return`${s}-${i}å‘¨`}const d=w("week"),a=w({dayTime:String(X(0,null)),monthTime:String(X(3,null)),weekTime:D(),startTime:null,endTime:null,dates:null,creater:null}),y=w([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),E=w("table"),x=w({}),V=P(()=>Object.keys(x.value||{}).map(o=>{var s,i;return{key:o,name:o,userimage:(i=(s=x.value[o])==null?void 0:s[0])==null?void 0:i.userimage}})),N=P(()=>{const o=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left",render(i){return c("div",{class:"text-blue-600 flex-col items-center font-medium"},[c(ye,{width:"60",height:"60","preview-disabled":!0,src:i.userimage||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png",class:"rounded-md object-cover"},null),c("span",null,[i.name])])}}];let s=[];switch(d.value){case"week":a.value.startTime&&a.value.endTime&&(s=ge(a.value.startTime,a.value.endTime).map(e=>j(e)));break;case"month":a.value.monthTime&&(s=fe(a.value.monthTime).map(e=>j(e)));break;case"day":default:a.value.dayTime&&(s=[j(a.value.dayTime)]);break}return[...o,...s]}),j=o=>({title:W(o),key:o,width:300,align:"center",render:s=>Y(s.name,o)}),W=o=>{const s=new Date(o),i=s.getMonth()+1,e=s.getDate(),l=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][s.getDay()];return`${i}/${e} å‘¨${l}`},Y=(o,s)=>{let i;const l=(x.value[o]||[]).filter(t=>t.daytime===s);return l.length===0?c("div",{class:"text-gray-400 text-sm"},[M("æ— è®°å½•")]):c("div",{class:"text-left space-y-1"},[c(he,{style:"height: 300px;",trigger:"none"},Le(i=l.map((t,n)=>c("div",{key:n,class:"tableItem p-1 border-b border-gray-100 last:border-b-0"},[c("div",null,[M("é¡¹ç›®ï¼š"),c("span",{class:""},[t.proname||"æš‚æ— é¡¹ç›®"])]),c("div",null,[M("åœ°å€ï¼š "),c("span",{class:""},[t.address])]),c("div",null,[M("æ‰“å¡æ—¶é—´ï¼š"),c("span",{class:""},[t.dbtime])]),c("div",null,[M("å·¥æ—¶ï¼š"),c("span",{class:""},[t.duration?t.duration+"å°æ—¶":"æ— "])])])))?i:{default:()=>[i]})])},A=o=>{const s=o.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!s)return null;const i=Number(s[1]),e=Number(s[2]),l=new Date(i,0,1+(e-1)*7),t=l.getDay(),n=new Date(l);t<=4?n.setDate(l.getDate()-l.getDay()+1):n.setDate(l.getDate()+8-l.getDay());const r=new Date(n);r.setDate(n.getDate()+6);const h=u=>{const k=u.getFullYear(),p=String(u.getMonth()+1).padStart(2,"0"),U=String(u.getDate()).padStart(2,"0");return`${k}-${p}-${U}`};return{start:h(n),end:h(r)}},H=o=>{x.value={},d.value=o,I()},B=o=>{I(o),b()},I=o=>{switch(d.value){case"week":if(o){const s=A(o);s&&(a.value.startTime=s.start,a.value.endTime=s.end)}break;case"month":a.value.dates=o||a.value.monthTime;break;case"day":default:a.value.dates=o||a.value.dayTime;break}},b=async()=>{try{const o={};a.value.creater&&(o.creater=a.value.creater),d.value==="week"?(o.startTime=a.value.startTime,o.endTime=a.value.endTime):d.value==="month"?o.dates=a.value.monthTime:o.dates=a.value.dayTime;const{data:s,error:i}=await $e(o);i||(x.value=s)}catch(o){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",o)}},{pageData:z,getData:G,nextPage:q}=Ee(Ce),K=async o=>{const s=o.currentTarget,i=s.scrollTop;s.scrollTop+s.offsetHeight>=s.scrollHeight&&z.data.length<z.total&&(await q(),await De(),setTimeout(()=>{s.scrollTop=i}))},F=async o=>{a.value.creater=o,b()};return ae([d,()=>a.value.dates],()=>{if(d.value=="week"&&a.value.weekTime){const o=A(a.value.weekTime);o&&(a.value.startTime=o.start,a.value.endTime=o.end),b()}else(d.value=="month"&&a.value.monthTime||d.value=="day"&&a.value.dayTime)&&b()},{immediate:!0}),le(()=>{a.value.weekTime=D(),G({usertypes:"2,3"}),b()}),(o,s)=>{const i=Fe,e=we,l=ie;return g(),T("div",Re,[c(v(Te),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:_(()=>[c(v(ke),{align:"center"},{default:_(()=>[s[6]||(s[6]=f("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),c(e,{label:"ç”¨æˆ·",path:"creater","label-placement":"left","show-feedback":!1},{default:_(()=>[c(i,{clearable:"",filterable:"",value:a.value.creater,"onUpdate:value":[s[0]||(s[0]=t=>a.value.creater=t),F],placeholder:"è¯·é€‰æ‹©","label-field":"username",size:"small","value-field":"id",options:v(z).data,onScroll:K},null,8,["value","options"])]),_:1}),c(v(ee),{value:d.value,"onUpdate:value":[s[1]||(s[1]=t=>d.value=t),H],size:"small"},{default:_(()=>[(g(!0),T(ne,null,oe(y.value,t=>(g(),S(v(Z),{key:t.value,value:t.value,label:t.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),d.value==="day"?(g(),S(v(J),{key:0,size:"small","formatted-value":a.value.dayTime,"onUpdate:formattedValue":[s[2]||(s[2]=t=>a.value.dayTime=t),B],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):O("",!0),d.value==="week"?(g(),S(v(J),{key:1,size:"small","formatted-value":a.value.weekTime,"onUpdate:formattedValue":[s[3]||(s[3]=t=>a.value.weekTime=t),B],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):O("",!0),d.value==="month"?(g(),S(v(J),{key:2,size:"small","formatted-value":a.value.monthTime,"onUpdate:formattedValue":[s[4]||(s[4]=t=>a.value.monthTime=t),B],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):O("",!0),c(v(xe),{type:"primary",onClick:b,size:"small",class:"w-full sm:w-auto"},{icon:_(()=>[c(l,{class:"text-icon"})]),default:_(()=>[M(" "+R(v(_e)("common.search")),1)]),_:1}),c(v(ee),{size:"small",value:E.value,"onUpdate:value":s[5]||(s[5]=t=>E.value=t),name:"radiobuttongroup1"},{default:_(()=>[c(v(Z),{value:"table",label:"è¡¨æ ¼"}),c(v(Z),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:_(()=>[E.value=="table"?(g(),S(v(be),{key:0,columns:N.value,data:V.value,size:"small","flex-height":!v(m).isMobile,"scroll-x":N.value.reduce((t,n)=>t+n.width,0),remote:"","row-key":t=>t.key,class:"h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","row-key"])):(g(),S(Ie,{key:1,trackData:x.value},null,8,["trackData"]))]),_:1})])}}}),Qe=se(We,[["__scopeId","data-v-c4b69818"]]);export{Qe as default};
