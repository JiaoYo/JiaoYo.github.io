import{_ as ke}from"./table-column-setting.vue_vue_type_script_setup_true_lang-DT_rKwFE.js";import{_ as Ce}from"./round-delete-CXeWWwZt.js";import{_ as xe}from"./round-add-fZpBfy1-.js";import{d as te,ax as ee,p as re,s as Se,r as K,q as ie,a as je,az as ce,av as Ne,b_ as Te,d4 as De,d5 as Ue,c as S,o as g,w as l,f as t,aA as ze,F as ue,h as n,aw as pe,A as B,b as J,y as W,g as w,e as q,t as k,aC as Pe,B as T,aD as qe,N as ae,$ as L,aG as $e,cu as de,aJ as me,aL as Re,E as Be,U as fe,L as Le,i as Fe,x as Z,aP as X,aB as Ie,C as Y,aQ as Me,d6 as ne,d7 as Ve,a7 as Oe,aV as Ae}from"./index-C1b7XuIM.js";import{u as Ee,a as Ge}from"./table-CxZfD_QR.js";import{u as ge}from"./usePageData-DJD0HzyT.js";import{_ as _e}from"./Grid-doj7iZBh.js";import{_ as ve}from"./FormItemGridItem-CdsywRZD.js";import{_ as He}from"./round-search-Bo3FaEpc.js";import{_ as Ke}from"./round-refresh-DUW2ws6U.js";import{N as oe}from"./Popconfirm-5yWRjm7D.js";const Je={key:0,style:{"margin-left":"20px"}},Qe={key:0,style:{"margin-left":"20px"}},We={key:0,style:{"margin-left":"20px"}},Xe={key:0,style:{"margin-left":"20px"}},Ye=te({name:"OperateDrawer",__name:"operate-drawer",props:ee({operateType:{},rowData:{},pid:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:ee(["submitted"],["update:visible"]),setup(z,{emit:V}){const P=re(),$=V,C=z,e=Se(j());K();function j(){return{pid:void 0,id:"",reqcontent:"",customer:"",cstcontact:"",notes:"",re1:"",re2:"",re3:"",re4:"",fl1:"",fl2:"",fl3:"",fl4:""}}const _=K([]),{pageData:b,getData:x,nextPage:O}=ge(de),F=async r=>{const a=r.currentTarget,i=a.scrollTop;a.scrollTop+a.offsetHeight>=a.scrollHeight&&b.data.length<b.total&&(await O(),_.value=b.data,await me(),setTimeout(()=>{a.scrollTop=i}))},A=async()=>{await x({fuzzy:P.userInfo.pname,page:1}),_.value=b.data},E=async()=>{await x({page:1}),_.value=b.data},G=async r=>{e.pid=r};async function Q(){var r;A(),Object.assign(e,j()),e.pid=C.pid?C.pid:(r=_.value[0])==null?void 0:r.id,C.operateType==="edit"&&C.rowData&&Object.assign(e,C.rowData)}const{formRef:D,validate:M,restoreValidation:m}=ie(),u={pid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择"},reqcontent:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},customer:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},cstcontact:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"}},N=je(()=>({add:"新增需求变更",edit:"修改需求变更"})[C.operateType]),U=ce(z,"visible");async function R(r){if(r)try{const i=await(await fetch(r==null?void 0:r.split("?")[0],{mode:"cors"})).blob(),h=URL.createObjectURL(i),d=document.createElement("a");d.href=h,d.download=r==null?void 0:r.split("?")[1],d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(h)}catch(a){console.error("下载失败:",a)}}Ne(U,()=>{U.value&&(Q(),setTimeout(()=>{const r=document.querySelector(".n-scrollbar-content");r==null||r.scrollTo(0,0)},300),m())});const c=K(0),f=K("");async function p({file:r},a){c.value=0,f.value=a;const i=await Re(r.file,r.name,"",h=>{c.value=h});i&&(e[a]=i,c.value=0)}function s(){U.value=!1}async function v(r){var a;return r.file.file.size>100*1024*1024?((a=window.$message)==null||a.error("文件大小不能超过100M"),!1):!0}const I=Te.debounce(async()=>{await H()},1e3,{leading:!0,trailing:!1});async function H(){var r,a;if(await M(),C.operateType==="edit"){const{data:i,error:h}=await De([e]);h||(s(),$("submitted"),(r=window.$message)==null||r.success("修改成功"))}else{const{data:i,error:h}=await Ue([{...e}]);h||(s(),$("submitted"),(a=window.$message)==null||a.success("添加成功"))}}return(r,a)=>{const i=ve,h=Pe,d=qe,le=_e,he=ue,ye=ze,we=ae,be=$e;return g(),S(be,{show:U.value,"onUpdate:show":a[17]||(a[17]=o=>U.value=o),title:N.value,preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{footer:l(()=>[t(we,{justify:"end",size:16},{default:l(()=>[t(n(T),{onClick:s},{default:l(()=>[w(k(n(L)("common.cancel")),1)]),_:1}),t(n(T),{type:"primary",onClick:n(I)},{default:l(()=>[w(k(n(L)("common.confirm")),1)]),_:1},8,["onClick"])]),_:1})]),default:l(()=>[t(ye,{class:"pr-20px"},{default:l(()=>[t(he,{ref_key:"formRef",ref:D,model:e,rules:u,"label-placement":"left","label-width":120},{default:l(()=>[t(le,{responsive:"screen","item-responsive":""},{default:l(()=>[t(i,{span:"24 m:12",label:"项目列表",path:"pid"},{default:l(()=>[t(n(pe),{clearable:"",filterable:"",value:e.pid,"onUpdate:value":[a[0]||(a[0]=o=>e.pid=o),G],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:E,options:_.value,onScroll:F},null,8,["value","options"])]),_:1}),t(i,{span:"24 m:12",label:"需求内容",path:"reqcontent"},{default:l(()=>[t(n(B),{value:e.reqcontent,"onUpdate:value":a[1]||(a[1]=o=>e.reqcontent=o),placeholder:"请输入"},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"客户联系人",path:"customer"},{default:l(()=>[t(n(B),{value:e.customer,"onUpdate:value":a[2]||(a[2]=o=>e.customer=o),placeholder:"请输入"},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"联系方式",path:"cstcontact"},{default:l(()=>[t(n(B),{value:e.cstcontact,"onUpdate:value":a[3]||(a[3]=o=>e.cstcontact=o),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"备注",path:"notes"},{default:l(()=>[t(n(B),{value:e.notes,"onUpdate:value":a[4]||(a[4]=o=>e.notes=o),placeholder:"请输入"},null,8,["value"])]),_:1}),t(i,{span:"24 m:24",label:"",path:"notes","show-feedback":!1},{default:l(()=>[t(le,{responsive:"screen","item-responsive":""},{default:l(()=>[t(i,{span:"24 m:12",label:"附件1",path:"notes"},{default:l(()=>[t(n(B),{value:e.re1,"onUpdate:value":a[5]||(a[5]=o=>e.re1=o),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var o;return[e.fl1?(g(),J("span",Je,[w(k((o=e.fl1)==null?void 0:o.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:a[6]||(a[6]=y=>e.fl1="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[7]||(a[7]=y=>R(e.fl1))},"下载")])):(g(),S(h,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":y=>p(y,"fl1"),"show-file-list":!1,onBeforeUpload:v},{default:l(()=>[t(n(T),{loading:c.value>0&&!e.fl1&&f.value=="fl1",size:"small",ghost:"",type:"primary"},{default:l(()=>[w(k(c.value>0&&!e.fl1&&f.value=="fl1"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),c.value&&!e.fl1&&f.value=="fl1"?(g(),S(d,{key:2,type:"line",percentage:c.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):W("",!0)]}),_:1})]),_:1})]),_:1}),t(i,{span:"24 m:12",label:"附件2",path:"notes"},{default:l(()=>[t(n(B),{value:e.re2,"onUpdate:value":a[8]||(a[8]=o=>e.re2=o),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var o;return[e.fl2?(g(),J("span",Qe,[w(k((o=e.fl2)==null?void 0:o.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:a[9]||(a[9]=y=>e.fl2="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[10]||(a[10]=y=>R(e.fl2))},"下载")])):(g(),S(h,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":y=>p(y,"fl2"),"show-file-list":!1,onBeforeUpload:v},{default:l(()=>[t(n(T),{loading:c.value>0&&!e.fl2&&f.value=="fl2",size:"small",ghost:"",type:"primary"},{default:l(()=>[w(k(c.value>0&&!e.fl2&&f.value=="fl2"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),c.value&&!e.fl2&&f.value=="fl2"?(g(),S(d,{key:2,type:"line",percentage:c.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):W("",!0)]}),_:1}),t(i,{span:"24 m:12",label:"附件3",path:"notes"},{default:l(()=>[t(n(B),{value:e.re3,"onUpdate:value":a[11]||(a[11]=o=>e.re3=o),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var o;return[e.fl3?(g(),J("span",We,[w(k((o=e.fl3)==null?void 0:o.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:a[12]||(a[12]=y=>e.fl3="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[13]||(a[13]=y=>R(e.fl3))},"下载")])):(g(),S(h,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":y=>p(y,"fl3"),"show-file-list":!1,onBeforeUpload:v},{default:l(()=>[t(n(T),{loading:c.value>0&&!e.fl3&&f.value=="fl3",size:"small",ghost:"",type:"primary"},{default:l(()=>[w(k(c.value>0&&!e.fl3&&f.value=="fl3"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),c.value&&!e.fl3&&f.value=="fl3"?(g(),S(d,{key:2,type:"line",percentage:c.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):W("",!0)]}),_:1}),t(i,{span:"24 m:12",label:"附件4",path:"notes"},{default:l(()=>[t(n(B),{value:e.re4,"onUpdate:value":a[14]||(a[14]=o=>e.re4=o),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(i,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var o;return[e.fl4?(g(),J("span",Xe,[w(k((o=e.fl4)==null?void 0:o.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:a[15]||(a[15]=y=>e.fl4="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[16]||(a[16]=y=>R(e.fl4))},"下载")])):(g(),S(h,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":y=>p(y,"fl4"),"show-file-list":!1},{default:l(()=>[t(n(T),{loading:c.value>0&&!e.fl4&&f.value=="fl4",size:"small",ghost:"",type:"primary"},{default:l(()=>[w(k(c.value>0&&!e.fl4&&f.value=="fl4"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),c.value&&!e.fl4&&f.value=="fl4"?(g(),S(d,{key:2,type:"line",percentage:c.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):W("",!0)]}),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Ze=te({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:ee(["reset","search","clear"],["update:model"]),setup(z,{emit:V}){const P=V,{formRef:$,restoreValidation:C}=ie(),e=ce(z,"model"),j=re(),_=K([]),{pageData:b,getData:x,nextPage:O}=ge(de),F=async m=>{const u=m.currentTarget,N=u.scrollTop;u.scrollTop+u.offsetHeight>=u.scrollHeight&&b.data.length<b.total&&(await O(),_.value=b.data,await me(),setTimeout(()=>{u.scrollTop=N}))},A=async m=>{var u;m?(e.value.pid=m,P("search"),j.setProjectInfo({pname:(u=_.value.find(N=>N.id==m))==null?void 0:u.proname,pid:m})):P("clear")},E=async m=>{await x({fuzzy:m,page:1}),_.value=b.data},G=async()=>{await x({page:1}),_.value=b.data};(async()=>{var m,u;await x({fuzzy:j.userInfo.pname}),_.value=b.data,e.value.pid=j.userInfo.pid?j.userInfo.pid:(m=_.value[0])==null?void 0:m.id,j.setProjectInfo({pid:e.value.pid,pname:(u=_.value.find(N=>N.id==e.value.pid))==null?void 0:u.proname}),P("search")})();async function D(){await C(),e.value.fuzzy="",P("reset")}async function M(){var m,u;e.value.pid?P("search"):((m=window.$message)==null||m.destroyAll(),(u=window.$message)==null||u.warning("请选择项目"))}return(m,u)=>{const N=pe,U=ve,R=Ke,c=T,f=He,p=ae,s=_e,v=ue,I=fe;return g(),S(I,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[t(v,{ref_key:"formRef",ref:$,model:e.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Be(M,["enter"])},{default:l(()=>[t(s,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:l(()=>[t(U,{span:"24 s:12 m:6",label:"项目列表",path:"PrjId"},{default:l(()=>[t(N,{filterable:"",clearable:"",value:e.value.pid,"onUpdate:value":[u[0]||(u[0]=H=>e.value.pid=H),A],placeholder:"请选择项目","label-field":"proname","value-field":"id",options:_.value,onScroll:F,onClear:G,onSearch:E},null,8,["value","options"])]),_:1}),t(U,{span:"24  s:12 m:6",class:"pr-24px"},{default:l(()=>[t(p,{class:"w-full"},{default:l(()=>[t(c,{onClick:D},{icon:l(()=>[t(R,{class:"text-icon"})]),default:l(()=>[w(" "+k(n(L)("common.reset")),1)]),_:1}),t(c,{type:"primary",ghost:"",onClick:M},{icon:l(()=>[t(f,{class:"text-icon"})]),default:l(()=>[w(" "+k(n(L)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),et={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function se(z){return typeof z=="function"||Object.prototype.toString.call(z)==="[object Object]"&&!Ae(z)}const dt=te({name:"projectmanagement_needchange",__name:"index",setup(z){const V=Le(),{columns:P,columnChecks:$,data:C,getData:e,loading:j,pagination:_,mobilePagination:b,searchParams:x}=Ee({showTotal:!0,immediate:!1,apiFn:Ve,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"reqcontent",title:"需求内容",align:"center",width:120},{key:"customer",title:"客户联系人",align:"center",width:120},{key:"cstcontact",title:"联系方式",align:"center",width:120},{key:"cstresult",title:"结果",align:"center",width:120,render(p){return Oe("div",{},p.cstresult==0?"失败":p.cstresult==1?"成功":"")}},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"操作人",align:"center",width:120},{key:"dbtime",title:"操作时间",align:"center",width:120},{key:"operate",title:L("common.operate"),align:"center",width:140,fixed:"right",render:p=>{let s;return t("div",{class:"flex-center gap-8px"},[Y(t(T,{type:"primary",ghost:!0,size:"small",onClick:()=>U(p.id)},se(s=L("common.edit"))?s:{default:()=>[s]}),[[Z("no-auth"),"project:Customer:update"]]),t(oe,{onPositiveClick:()=>N(p.id)},{default:()=>L("common.confirmDelete"),trigger:()=>{let v;return Y(t(T,{type:"error",ghost:!0,size:"small"},se(v=L("common.delete"))?v:{default:()=>[v]}),[[Z("no-auth"),"project:Customer:delete"]])}})])}}]}),O=()=>{C.value=[],_.itemCount=0},{drawerVisible:F,operateType:A,editingData:E,handleAdd:G,handleEdit:Q,checkedRowKeys:D,onBatchDeleted:M,onDeleted:m}=Ge(C,e);Fe(async()=>{});async function u(){console.log(D.value),R(D.value.join(","),p=>{M()})}async function N(p){const{data:s,error:v}=await ne(p,x.pid);v||m()}function U(p){Q(p)}async function R(p,s){const{data:v,error:I}=await ne(p,x.pid);if(!I)s&&s(v);else return!1}const c=p=>{e()},f=()=>{e()};return(p,s)=>{const v=ae,I=xe,H=Ce,r=ke,a=Ie,i=fe,h=Z("no-auth");return g(),J("div",et,[t(Ze,{model:n(x),"onUpdate:model":s[0]||(s[0]=d=>X(x)?x.value=d:null),onReset:f,onSearch:n(e),onClear:O},null,8,["model","onSearch"]),t(i,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:l(()=>[t(v,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:l(()=>s[4]||(s[4]=[q("div",null,"需求变更",-1)])),_:1,__:[4]})]),"header-extra":l(()=>[t(v,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:l(()=>[Y((g(),S(n(T),{onClick:n(G),size:"small",ghost:"",type:"primary"},{icon:l(()=>[t(I,{class:"text-icon"})]),default:l(()=>[s[5]||(s[5]=w(" "+k("新增")))]),_:1,__:[5]},8,["onClick"])),[[h,"project:Customer:insert"]]),t(n(oe),{onPositiveClick:u},{trigger:l(()=>[Y((g(),S(n(T),{size:"small",ghost:"",type:"error",disabled:n(D).length==0},{icon:l(()=>[t(H,{class:Me(["text-icon",{"animate-spin":n(j)}])},null,8,["class"])]),default:l(()=>[s[6]||(s[6]=w(" "+k("批量删除")))]),_:1,__:[6]},8,["disabled"])),[[h,"project:Customer:delete"]])]),default:l(()=>[s[7]||(s[7]=w(" 确定要删除选中的吗？ "))]),_:1,__:[7]}),t(r,{columns:n($),"onUpdate:columns":s[1]||(s[1]=d=>X($)?$.value=d:null)},null,8,["columns"])]),_:1})]),default:l(()=>[t(a,{"checked-row-keys":n(D),"onUpdate:checkedRowKeys":s[2]||(s[2]=d=>X(D)?D.value=d:null),columns:n(P),data:n(C),size:"small","flex-height":!n(V).isMobile,loading:n(j),remote:"","row-key":d=>d.id,pagination:n(b),class:"sm:h-full","onUpdate:filters":c},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),t(Ye,{visible:n(F),"onUpdate:visible":s[3]||(s[3]=d=>X(F)?F.value=d:null),onSubmitted:n(e),pid:n(x).pid,"operate-type":n(A),"row-data":n(E)},null,8,["visible","onSubmitted","pid","operate-type","row-data"])]),_:1})])}}});export{dt as default};
