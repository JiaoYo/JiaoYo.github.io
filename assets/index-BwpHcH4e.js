import{_ as ce}from"./round-search-B9RiPIED.js";import{d as le,r as _,a as V,aw as ne,i as oe,dP as de,b as M,o as b,e as y,z,aT as se,aX as re,g as E,t as L,cJ as me,aP as ve,V as pe,aI as fe,aM as ie,M as ge,a$ as te,eD as he,f5 as ye,f as c,aS as be,ax as we,w as D,c as j,h as f,ay as ke,N as Fe,A as _e,az as xe,aC as ae,B as Te,$ as De,U as Me,aH as Ce,b4 as Ee,aU as Ae}from"./index-BhBp_qK9.js";import{d as $e}from"./home-Djs9YVwE.js";import{u as Oe}from"./usePageData-DDI8WLoO.js";import{N as Q}from"./RadioButton-CGixugkd.js";import{N as ee}from"./DatePicker-D7-WF1QQ.js";const Se={class:"map-wrapper",style:{height:"100%",position:"relative"}},je={class:"map-legend"},ze={class:"legend-list"},Be=["onClick","onContextmenu"],Ne={key:0,class:"visibility-icon"},Pe={key:1,class:"solo-icon"},Ue={class:"legend-name"},Ve={class:"visibility-toggle"},Ie={key:0,class:"solo-notice"},We=le({__name:"historyMap",props:{trackData:{}},setup(A){const m=_(null);let $=null;const R=A,C=_([]),v=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],a=_({}),w=_(""),O=V(()=>{const t={};return Object.keys(C.value).forEach((s,o)=>{t[s]=v[o%v.length],a.value[s]===void 0&&(a.value[s]=!0)}),t});function x(t){if(w.value){I(t);return}a.value[t]=!a.value[t],T()}function I(t){w.value===t?B():(w.value=t,Object.keys(a.value).forEach(e=>{a.value[e]=e===t}),T())}function B(){w.value="",Object.keys(a.value).forEach(t=>{a.value[t]=!0}),T()}function N(){Object.keys(a.value).forEach(t=>{a.value[t]=!a.value[t]}),w.value="",T()}function Y(){Object.keys(a.value).forEach(t=>{a.value[t]=!0}),w.value="",T()}function H(){Object.keys(a.value).forEach(t=>{a.value[t]=!1}),w.value="",T()}const S=V(()=>{const t=[];return Object.values(C.value).forEach(e=>{t.push(...e)}),t.sort((e,s)=>new Date(e.dbtime).getTime()-new Date(s.dbtime).getTime())}),Z=V(()=>{if(S.value.length===0)return[120.370086,30.305716];const t=S.value.map(i=>i.longitude),e=S.value.map(i=>i.latitude),s=(Math.min(...t)+Math.max(...t))/2,o=(Math.min(...e)+Math.max(...e))/2;return console.log(s,o),[s,o]});async function P(){const t="/map-sdk.json",{data:e}=await fe.get(`${t}?_t=${Date.now()}`);return e}function W(t){return new Promise((e,s)=>{if(window.AMap)return e(window.AMap);const o=document.createElement("script");o.src=`https://webapi.amap.com/maps?v=2.0&key=${t}&plugin=AMap.PolylineEditor`,o.defer=!0,o.onload=()=>window.AMap?e(window.AMap):s(new Error("AMapåŠ è½½å¤±è´¥")),o.onerror=()=>s(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(o)})}const p=_({});function U(t,e){const s=e.lng-t.lng,o=e.lat-t.lat;return(Math.atan2(-o,s)*180/Math.PI-90+360)%360-175}function q(t,e,s,o){const i=document.createElement("div");return i.style.cssText=`
    width: 12px;
    height: 18px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 18px solid ${o};
    transform: translate(-50%, -50%) rotate(${s}deg);
    transform-origin: center center;
  `,new t.Marker({position:[e.lng,e.lat],content:i,offset:new t.Pixel(0,0)})}function G(t,e,s,o,i){const r=document.createElement("div");return r.className="custom-marker",r.style.transform="translateX(-50%)",r.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${o};box-shadow: 0 0 5px ${o}, 0 0 6px ${o};">
      <img src="${i||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png"}" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${o};">${s}</div>
  `,new t.Marker({position:[e.lng,e.lat],content:r})}function J(){m.value&&m.value.clearMap(),p.value={}}function T(){!window.AMap||!m.value||Object.keys(p.value).forEach(t=>{const e=a.value[t];(p.value[t]||[]).forEach(o=>{e?o.show():o.hide()})})}function n(t){if(!m.value)return;J();const e={};Object.entries(C.value).forEach(([o,i])=>{e[o]=i.map(r=>({lng:r.longitude,lat:r.latitude,address:r.address,dbtime:r.dbtime,proname:r.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:r.duration||0,userimage:r.userimage,longitude:r.longitude,latitude:r.latitude}))}),Object.keys(e).forEach(o=>{const i=e[o],r=O.value[o];if(i.length===0)return;const h=[];if(i.length>1){const d=new t.Polyline({path:i.map(F=>[F.lng,F.lat]),strokeColor:r,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});d.setMap(m.value),h.push(d)}i.forEach((d,F)=>{const k=G(t,d,o,r,i[0].userimage);k.setMap(m.value),h.push(k),k.on("click",()=>{const K=`
          <div style="min-width:220px; background:#fff; padding:12px 14px; font-size:13px; color:#333; line-height:1.6">
            <div style="font-weight:bold; color:${r}; font-size:15px; margin-bottom:6px; border-bottom:1px solid #f0f0f0; padding-bottom:4px">
              ${o}
            </div>
            <div><b style="color:#555">åœ°ç‚¹ï¼š</b>${d.address}</div>
            <div><b style="color:#555">æ—¶é—´ï¼š</b>${d.dbtime}</div>
            <div><b style="color:#555">é¡¹ç›®ï¼š</b>${d.proname}</div>
            <div><b style="color:#555">ç»çº¬åº¦ï¼š</b><span style="font-size:12px;color:#666">${d.longitude}, ${d.latitude}</span></div>
            ${d.duration?`<div><b style="color:#555">å·¥æ—¶ï¼š</b>${d.duration} å°æ—¶</div>`:""}
          </div>
          <div style="margin-top:8px; text-align:right; font-size:12px; color:#999">ç¬¬ ${F+1} ä¸ªæ‰“å¡ç‚¹</div>
        `;$.setContent(K),$.open(m.value,k.getPosition())}),k.on("dblclick",()=>{$.open(m.value,k.getPosition()),m.value.setCenter(k.getPosition()),m.value.setZoom(14)})});for(let d=1;d<i.length;d++){const F=i[d-1],k=i[d];if(u(F,k))continue;const K={lng:(F.lng+k.lng)/2,lat:(F.lat+k.lat)/2},ue=U(F,k),X=q(t,K,ue,r);X.isArrow=!0,X.setMap(m.value),h.push(X)}p.value[o]=h});const s=()=>{const i=m.value.getZoom()>=7,r=l(p.value,a.value);Object.values(r).forEach(h=>{h==null||h.forEach(d=>{d.isArrow&&(i?d.show():d.hide())})})};m.value.on("zoomend",s),s(),Object.keys(p.value).forEach(o=>{(p.value[o]||[]).forEach(r=>{r.isArrow||(a.value[o]?r.show():r.hide())})})}function l(t,e){const s={};for(const o in t)e[o]&&(s[o]=t[o]);return s}function u(t,e,s=1e-7){return Math.abs(t.lng-e.lng)<s&&Math.abs(t.lat-e.lat)<s}async function g(){try{const t=await P(),e=await W(t.AMAP_SDK_KEY);m.value=new e.Map("amap-container",{viewMode:"2D",center:Z.value,zoom:5,features:["bg","point"]}),m.value.on("zoomend",()=>{const o=m.value.getZoom()>=12,i=l(p.value,a.value);Object.values(i).forEach(r=>{r.forEach(h=>{h.isArrow&&(o?h.show():h.hide())})})}),$=new e.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),n(e)}catch(t){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",t)}}return ne(()=>R.trackData??[],t=>{console.log(t,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),C.value=t,window.AMap&&m.value&&n(window.AMap)},{immediate:!0,deep:!0}),oe(()=>{g()}),de(()=>{m.value&&m.value.destroy()}),(t,e)=>(b(),M("div",Se,[e[1]||(e[1]=y("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),y("div",je,[y("div",{class:"legend-header"},[e[0]||(e[0]=y("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),y("div",{class:"legend-actions"},[y("button",{class:"action-btn",onClick:Y},"å…¨æ˜¾"),y("button",{class:"action-btn",onClick:H},"å…¨éš"),y("button",{class:"action-btn",onClick:N},"åé€‰")])]),y("div",ze,[(b(!0),M(se,null,re(O.value,(s,o)=>(b(),M("div",{key:o,class:ve(["legend-item",{"legend-item-hidden":!a.value[o],"legend-item-solo":w.value===o}]),onClick:i=>x(o),onContextmenu:me(i=>I(o),["prevent"])},[y("div",{class:"legend-color",style:pe({backgroundColor:s})},[a.value[o]?z("",!0):(b(),M("span",Ne,"ğŸ‘ï¸â€ğŸ—¨ï¸")),w.value===o?(b(),M("span",Pe,"â­")):z("",!0)],4),y("span",Ue,L(o),1),y("span",Ve,L(a.value[o]?"éšè—":"æ˜¾ç¤º"),1)],42,Be))),128))]),w.value?(b(),M("div",Ie,[E(" ä»…æ˜¾ç¤º: "+L(w.value)+" ",1),y("button",{class:"cancel-solo-btn",onClick:B},"å–æ¶ˆ")])):z("",!0)])]))}}),Le=ie(We,[["__scopeId","data-v-df37825f"]]),Re={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Ye(A){return typeof A=="function"||Object.prototype.toString.call(A)==="[object Object]"&&!Ae(A)}const He=le({name:"trajectory_historytrajectory",__name:"index",setup(A){const m=ge();function $(n){return n.getFullYear()}function R(n){const l=new Date(n.getFullYear(),0,1),u=(n.getTime()-l.getTime())/864e5,g=l.getDay()||7;return Math.ceil((u+g)/7)}function C(){const n=new Date,l=$(n),u=R(n).toString().padStart(2,"0");return`${l}-${u}å‘¨`}const v=_("week"),a=_({dayTime:String(te(0,null)),monthTime:String(te(3,null)),weekTime:C(),startTime:null,endTime:null,dates:null,creater:null}),w=_([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),O=_("table"),x=_({}),I=V(()=>Object.keys(x.value||{}).map(n=>{var l,u;return{key:n,name:n,userimage:(u=(l=x.value[n])==null?void 0:l[0])==null?void 0:u.userimage}})),B=V(()=>{const n=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left",render(u){return c("div",{class:"text-blue-600 flex-col items-center font-medium"},[c(be,{width:"60",height:"60","preview-disabled":!0,src:u.userimage||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png",class:"rounded-md object-cover"},null),c("span",null,[u.name])])}}];let l=[];switch(v.value){case"week":a.value.startTime&&a.value.endTime&&(l=ye(a.value.startTime,a.value.endTime).map(g=>N(g)));break;case"month":a.value.monthTime&&(l=he(a.value.monthTime).map(g=>N(g)));break;case"day":default:a.value.dayTime&&(l=[N(a.value.dayTime)]);break}return[...n,...l]}),N=n=>({title:Y(n),key:n,width:300,align:"center",render:l=>H(l.name,n)}),Y=n=>{const l=new Date(n),u=l.getMonth()+1,g=l.getDate(),t=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][l.getDay()];return`${u}/${g} å‘¨${t}`},H=(n,l)=>{let u;const t=(x.value[n]||[]).filter(e=>e.daytime===l);return t.length===0?c("div",{class:"text-gray-400 text-sm"},[E("æ— è®°å½•")]):c("div",{class:"text-left space-y-1"},[c(we,{style:"max-height: 250px;",trigger:"none"},Ye(u=t.map((e,s)=>c("div",{key:s,class:"tableItem p-1 border-b border-gray-100 last:border-b-0"},[c("div",null,[E("é¡¹ç›®ï¼š"),c("span",{class:""},[e.proname||"æš‚æ— é¡¹ç›®"])]),c("div",null,[E("åœ°å€ï¼š "),c("span",{class:""},[e.address])]),c("div",null,[E("æ‰“å¡æ—¶é—´ï¼š"),c("span",{class:""},[e.dbtime])]),c("div",null,[E("å·¥æ—¶ï¼š"),c("span",{class:""},[e.duration?e.duration+"å°æ—¶":"æ— "])])])))?u:{default:()=>[u]})])},S=n=>{const l=n.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!l)return null;const u=Number(l[1]),g=Number(l[2]),t=new Date(u,0,1+(g-1)*7),e=t.getDay(),s=new Date(t);e<=4?s.setDate(t.getDate()-t.getDay()+1):s.setDate(t.getDate()+8-t.getDay());const o=new Date(s);o.setDate(s.getDate()+6);const i=r=>{const h=r.getFullYear(),d=String(r.getMonth()+1).padStart(2,"0"),F=String(r.getDate()).padStart(2,"0");return`${h}-${d}-${F}`};return{start:i(s),end:i(o)}},Z=n=>{x.value={},v.value=n,W()},P=n=>{W(n),p()},W=n=>{switch(v.value){case"week":if(n){const l=S(n);l&&(a.value.startTime=l.start,a.value.endTime=l.end)}break;case"month":a.value.dates=n||a.value.monthTime;break;case"day":default:a.value.dates=n||a.value.dayTime;break}},p=async()=>{try{const n={};a.value.creater&&(n.creater=a.value.creater),v.value==="week"?(n.startTime=a.value.startTime,n.endTime=a.value.endTime):v.value==="month"?n.dates=a.value.monthTime:n.dates=a.value.dayTime;const{data:l,error:u}=await $e(n);u||(x.value=l)}catch(n){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",n)}},{pageData:U,getData:q,nextPage:G}=Oe(Ee),J=async n=>{const l=n.currentTarget,u=l.scrollTop;l.scrollTop+l.offsetHeight>=l.scrollHeight&&U.data.length<U.total&&(await G(),await Ce(),setTimeout(()=>{l.scrollTop=u}))},T=async n=>{a.value.creater=n,p()};return ne([v,()=>a.value.dates],()=>{if(v.value=="week"&&a.value.weekTime){const n=S(a.value.weekTime);n&&(a.value.startTime=n.start,a.value.endTime=n.end),p()}else(v.value=="month"&&a.value.monthTime||v.value=="day"&&a.value.dayTime)&&p()},{immediate:!0}),oe(()=>{a.value.weekTime=C(),q({usertypes:"2,3"}),p()}),(n,l)=>{const u=xe,g=_e,t=ce;return b(),M("div",Re,[c(f(Me),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:D(()=>[c(f(Fe),{align:"center"},{default:D(()=>[l[6]||(l[6]=y("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),c(g,{label:"ç”¨æˆ·",path:"creater","label-placement":"left","show-feedback":!1},{default:D(()=>[c(u,{clearable:"",filterable:"",value:a.value.creater,"onUpdate:value":[l[0]||(l[0]=e=>a.value.creater=e),T],placeholder:"è¯·é€‰æ‹©","label-field":"username",size:"small","value-field":"id",options:f(U).data,onScroll:J},null,8,["value","options"])]),_:1}),c(f(ae),{value:v.value,"onUpdate:value":[l[1]||(l[1]=e=>v.value=e),Z],size:"small"},{default:D(()=>[(b(!0),M(se,null,re(w.value,e=>(b(),j(f(Q),{key:e.value,value:e.value,label:e.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),v.value==="day"?(b(),j(f(ee),{key:0,size:"small","formatted-value":a.value.dayTime,"onUpdate:formattedValue":[l[2]||(l[2]=e=>a.value.dayTime=e),P],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):z("",!0),v.value==="week"?(b(),j(f(ee),{key:1,size:"small","formatted-value":a.value.weekTime,"onUpdate:formattedValue":[l[3]||(l[3]=e=>a.value.weekTime=e),P],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):z("",!0),v.value==="month"?(b(),j(f(ee),{key:2,size:"small","formatted-value":a.value.monthTime,"onUpdate:formattedValue":[l[4]||(l[4]=e=>a.value.monthTime=e),P],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):z("",!0),c(f(Te),{type:"primary",onClick:p,size:"small",class:"w-full sm:w-auto"},{icon:D(()=>[c(t,{class:"text-icon"})]),default:D(()=>[E(" "+L(f(De)("common.search")),1)]),_:1}),c(f(ae),{size:"small",value:O.value,"onUpdate:value":l[5]||(l[5]=e=>O.value=e),name:"radiobuttongroup1"},{default:D(()=>[c(f(Q),{value:"table",label:"è¡¨æ ¼"}),c(f(Q),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:D(()=>[O.value=="table"?(b(),j(f(ke),{key:0,columns:B.value,data:I.value,size:"small","flex-height":!f(m).isMobile,"scroll-x":B.value.reduce((e,s)=>e+s.width,0),remote:"","row-key":e=>e.key,class:"h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","row-key"])):(b(),j(Le,{key:1,trackData:x.value},null,8,["trackData"]))]),_:1})])}}}),Qe=ie(He,[["__scopeId","data-v-612dee95"]]);export{Qe as default};
