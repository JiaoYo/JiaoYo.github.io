import{_ as ie}from"./round-search-Dzp6xJh-.js";import{d as te,r as k,a as U,aw as ae,i as le,dF as ce,b as _,o as f,e as p,z as S,aR as ne,aV as oe,g as D,t as L,cG as ue,aN as de,V as me,aI as ve,aL as se,M as pe,aZ as X,e_ as fe,e$ as ge,f as i,aQ as ye,ax as he,w as x,c as A,h as m,ay as be,N as ke,A as we,az as Fe,aC as ee,B as xe,$ as _e,U as Te,aH as De,aS as Me,cl as Ce}from"./index-BHFXhhrx.js";import{d as $e}from"./home-nfNbJEJ5.js";import{u as Ee}from"./usePageData-CiDKwIfi.js";import{N as Z}from"./RadioButton-euKXrJ-r.js";import{N as J}from"./DatePicker-CSWbZL6L.js";import"./utils-Ck3BJELy.js";const Ae={class:"map-wrapper",style:{height:"100%",position:"relative"}},Se={class:"map-legend"},Oe={class:"legend-list"},Ne=["onClick","onContextmenu"],je={key:0,class:"visibility-icon"},Be={key:1,class:"solo-icon"},ze={class:"legend-name"},Ue={class:"visibility-toggle"},Pe={key:0,class:"solo-notice"},Ve=te({__name:"historyMap",props:{trackData:{}},setup(M){const d=k(null);let C=null;const I=M,T=k([]),u=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],a=k({}),g=k(""),$=U(()=>{const e={};return Object.keys(T.value).forEach((s,t)=>{e[s]=u[t%u.length],a.value[s]===void 0&&(a.value[s]=!0)}),e});function F(e){if(g.value){P(e);return}a.value[e]=!a.value[e],w()}function P(e){g.value===e?O():(g.value=e,Object.keys(a.value).forEach(o=>{a.value[o]=o===e}),w())}function O(){g.value="",Object.keys(a.value).forEach(e=>{a.value[e]=!0}),w()}function N(){Object.keys(a.value).forEach(e=>{a.value[e]=!a.value[e]}),g.value="",w()}function W(){Object.keys(a.value).forEach(e=>{a.value[e]=!0}),g.value="",w()}function R(){Object.keys(a.value).forEach(e=>{a.value[e]=!1}),g.value="",w()}const E=U(()=>{const e=[];return Object.values(T.value).forEach(o=>{e.push(...o)}),e.sort((o,s)=>new Date(o.dbtime).getTime()-new Date(s.dbtime).getTime())}),H=U(()=>{if(E.value.length===0)return[120.370086,30.305716];const e=E.value.map(r=>r.longitude),o=E.value.map(r=>r.latitude),s=(Math.min(...e)+Math.max(...e))/2,t=(Math.min(...o)+Math.max(...o))/2;return console.log(s,t),[s,t]});async function j(){const e="/map-sdk.json",{data:o}=await ve.get(`${e}?_t=${Date.now()}`);return o}function V(e){return new Promise((o,s)=>{if(window.AMap)return o(window.AMap);const t=document.createElement("script");t.src=`https://webapi.amap.com/maps?v=2.0&key=${e}&plugin=AMap.PolylineEditor`,t.defer=!0,t.onload=()=>window.AMap?o(window.AMap):s(new Error("AMapåŠ è½½å¤±è´¥")),t.onerror=()=>s(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(t)})}const h=k({});function B(e,o){const s=o.lng-e.lng,t=o.lat-e.lat;return Math.atan2(t,s)*180/Math.PI}function Y(e,o,s,t,r){const v=`
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                background: white; border-radius: 50%; width: 20px; height: 20px; 
                display: flex; align-items: center; justify-content: center; 
                font-size: 10px; font-weight: bold; color: ${t}; border: 2px solid ${t};">
      ${r}
    </div>
  `,c=document.createElement("div");return c.style.cssText=`
    position: relative;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  `,c.innerHTML=v,new e.Marker({position:[o.lng,o.lat],content:c,offset:new e.Pixel(-10,-10)})}function G(e,o,s,t,r){const v=document.createElement("div");return v.className="custom-marker",v.style.transform="translateX(-50%)",v.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${t}; box-shadow: 0 0 10px ${t}, 0 0 20px ${t};">
      <img src="${r||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png"}" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${t};">${s}</div>
  `,new e.Marker({position:[o.lng,o.lat],content:v})}function q(){d.value&&d.value.clearMap(),h.value={}}function w(){!window.AMap||!d.value||Object.keys(h.value).forEach(e=>{const o=a.value[e];(h.value[e]||[]).forEach(t=>{o?t.show():t.hide()})})}function l(e){q();const o={};Object.entries(T.value).forEach(([s,t])=>{o[s]=t.map(r=>({lng:r.longitude,lat:r.latitude,address:r.address,dbtime:r.dbtime,proname:r.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:r.duration||0,userimage:r.userimage,longitude:r.longitude,latitude:r.latitude}))}),Object.keys(o).forEach(s=>{const t=o[s];console.log(t,"sssasfas fasfadasd");const r=$.value[s];if(t.length===0)return;const v=[];if(t.length>1){const c=new e.Polyline({path:t.map(b=>[b.lng,b.lat]),strokeColor:r,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});c.setMap(d.value),v.push(c)}if(t.forEach((c,b)=>{console.log(s);const y=G(e,c,s,r,t[0].userimage);y.setMap(d.value),v.push(y),y.on("click",()=>{const z=`
        <div style="
          min-width: 220px;
          background: #fff;
          padding: 12px 14px;
          font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          font-size: 13px;
          color: #333;
          line-height: 1.6;
        ">
          <div style="
            font-weight: bold;
            color: ${r};
            font-size: 15px;
            margin-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 4px;
          ">${s}</div>

          <div style="margin-bottom: 4px;"><b style="color:#555;">åœ°ç‚¹ï¼š</b><span style="color:#333;">${c.address}</span></div>
          <div style="margin-bottom: 4px;"><b style="color:#555;">æ—¶é—´ï¼š</b><span style="color:#333;">${c.dbtime}</span></div>
          <div style="margin-bottom: 4px;"><b style="color:#555;">é¡¹ç›®ï¼š</b><span style="color:#333;">${c.proname}</span></div>
          <div style="margin-bottom: 4px;"><b style="color:#555;">ç»çº¬åº¦ï¼š</b><span style="color:#666; font-size:12px;">
        ${c.longitude} , ${c.latitude}
      </span></div>

          ${c.duration?`<div style="margin-bottom: 4px;"><b style="color:#555;">å·¥æ—¶ï¼š</b><span style="color:#333;">${c.duration} å°æ—¶</span></div>`:""}
          
          </div>
        `;C.setContent(z),C.open(d.value,y.getPosition())}),y.on("dblclick",()=>{C.open(d.value,y.getPosition()),d.value.setCenter(y.getPosition()),d.value.setZoom(14)})}),t.length>1)for(let c=1;c<t.length;c++){const b=t[c-1],y=t[c],z=(b.lng+y.lng)/2,K=(b.lat+y.lat)/2,re=B(b,y),Q=Y(e,{lng:z,lat:K},re,r,c);Q.setMap(d.value),v.push(Q)}h.value[s]=v}),w()}async function n(){try{const e=await j(),o=await V(e.AMAP_SDK_KEY);d.value=new o.Map("amap-container",{viewMode:"2D",center:H.value,zoom:5,features:["bg","point"]}),C=new o.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),l(o)}catch(e){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",e)}}return ae(()=>I.trackData??[],e=>{console.log(e,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),T.value=e,window.AMap&&d.value&&l(window.AMap)},{immediate:!0,deep:!0}),le(()=>{n()}),ce(()=>{d.value&&d.value.destroy()}),(e,o)=>(f(),_("div",Ae,[o[1]||(o[1]=p("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),p("div",Se,[p("div",{class:"legend-header"},[o[0]||(o[0]=p("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),p("div",{class:"legend-actions"},[p("button",{class:"action-btn",onClick:W},"å…¨æ˜¾"),p("button",{class:"action-btn",onClick:R},"å…¨éš"),p("button",{class:"action-btn",onClick:N},"åé€‰")])]),p("div",Oe,[(f(!0),_(ne,null,oe($.value,(s,t)=>(f(),_("div",{key:t,class:de(["legend-item",{"legend-item-hidden":!a.value[t],"legend-item-solo":g.value===t}]),onClick:r=>F(t),onContextmenu:ue(r=>P(t),["prevent"])},[p("div",{class:"legend-color",style:me({backgroundColor:s})},[a.value[t]?S("",!0):(f(),_("span",je,"ğŸ‘ï¸â€ğŸ—¨ï¸")),g.value===t?(f(),_("span",Be,"â­")):S("",!0)],4),p("span",ze,L(t),1),p("span",Ue,L(a.value[t]?"éšè—":"æ˜¾ç¤º"),1)],42,Ne))),128))]),g.value?(f(),_("div",Pe,[D(" ä»…æ˜¾ç¤º: "+L(g.value)+" ",1),p("button",{class:"cancel-solo-btn",onClick:O},"å–æ¶ˆ")])):S("",!0)])]))}}),Le=se(Ve,[["__scopeId","data-v-f11e299a"]]),Ie={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function We(M){return typeof M=="function"||Object.prototype.toString.call(M)==="[object Object]"&&!Me(M)}const Re=te({name:"trajectory_historytrajectory",__name:"index",setup(M){const d=pe();function C(l){return l.getFullYear()}function I(l){const n=new Date(l.getFullYear(),0,1),e=(l.getTime()-n.getTime())/864e5,o=n.getDay()||7;return Math.ceil((e+o)/7)}function T(){const l=new Date,n=C(l),e=I(l).toString().padStart(2,"0");return`${n}-${e}å‘¨`}const u=k("week"),a=k({dayTime:String(X(0,null)),monthTime:String(X(3,null)),weekTime:T(),startTime:null,endTime:null,dates:null,creater:null}),g=k([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),$=k("table"),F=k({}),P=U(()=>Object.keys(F.value||{}).map(l=>{var n,e;return{key:l,name:l,userimage:(e=(n=F.value[l])==null?void 0:n[0])==null?void 0:e.userimage}})),O=U(()=>{const l=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left",render(e){return i("div",{class:"text-blue-600 flex-col items-center font-medium"},[i(ye,{width:"60",height:"60","preview-disabled":!0,src:e.userimage||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png",class:"rounded-md object-cover"},null),i("span",null,[e.name])])}}];let n=[];switch(u.value){case"week":a.value.startTime&&a.value.endTime&&(n=ge(a.value.startTime,a.value.endTime).map(o=>N(o)));break;case"month":a.value.monthTime&&(n=fe(a.value.monthTime).map(o=>N(o)));break;case"day":default:a.value.dayTime&&(n=[N(a.value.dayTime)]);break}return[...l,...n]}),N=l=>({title:W(l),key:l,width:300,align:"center",render:n=>R(n.name,l)}),W=l=>{const n=new Date(l),e=n.getMonth()+1,o=n.getDate(),s=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][n.getDay()];return`${e}/${o} å‘¨${s}`},R=(l,n)=>{let e;const s=(F.value[l]||[]).filter(t=>t.daytime===n);return s.length===0?i("div",{class:"text-gray-400 text-sm"},[D("æ— è®°å½•")]):i("div",{class:"text-left space-y-1"},[i(he,{style:"max-height: 300px;",trigger:"none"},We(e=s.map((t,r)=>i("div",{key:r,class:"tableItem p-1 border-b border-gray-100 last:border-b-0"},[i("div",null,[D("é¡¹ç›®ï¼š"),i("span",{class:""},[t.proname||"æš‚æ— é¡¹ç›®"])]),i("div",null,[D("åœ°å€ï¼š "),i("span",{class:""},[t.address])]),i("div",null,[D("æ‰“å¡æ—¶é—´ï¼š"),i("span",{class:""},[t.dbtime])]),i("div",null,[D("å·¥æ—¶ï¼š"),i("span",{class:""},[t.duration?t.duration+"å°æ—¶":"æ— "])])])))?e:{default:()=>[e]})])},E=l=>{const n=l.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!n)return null;const e=Number(n[1]),o=Number(n[2]),s=new Date(e,0,1+(o-1)*7),t=s.getDay(),r=new Date(s);t<=4?r.setDate(s.getDate()-s.getDay()+1):r.setDate(s.getDate()+8-s.getDay());const v=new Date(r);v.setDate(r.getDate()+6);const c=b=>{const y=b.getFullYear(),z=String(b.getMonth()+1).padStart(2,"0"),K=String(b.getDate()).padStart(2,"0");return`${y}-${z}-${K}`};return{start:c(r),end:c(v)}},H=l=>{F.value={},u.value=l,V()},j=l=>{V(l),h()},V=l=>{switch(u.value){case"week":if(l){const n=E(l);n&&(a.value.startTime=n.start,a.value.endTime=n.end)}break;case"month":a.value.dates=l||a.value.monthTime;break;case"day":default:a.value.dates=l||a.value.dayTime;break}},h=async()=>{try{const l={};a.value.creater&&(l.creater=a.value.creater),u.value==="week"?(l.startTime=a.value.startTime,l.endTime=a.value.endTime):u.value==="month"?l.dates=a.value.monthTime:l.dates=a.value.dayTime;const{data:n,error:e}=await $e(l);e||(F.value=n)}catch(l){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",l)}},{pageData:B,getData:Y,nextPage:G}=Ee(Ce),q=async l=>{const n=l.currentTarget,e=n.scrollTop;n.scrollTop+n.offsetHeight>=n.scrollHeight&&B.data.length<B.total&&(await G(),await De(),setTimeout(()=>{n.scrollTop=e}))},w=async l=>{a.value.creater=l,h()};return ae([u,()=>a.value.dates],()=>{if(u.value=="week"&&a.value.weekTime){const l=E(a.value.weekTime);l&&(a.value.startTime=l.start,a.value.endTime=l.end),h()}else(u.value=="month"&&a.value.monthTime||u.value=="day"&&a.value.dayTime)&&h()},{immediate:!0}),le(()=>{a.value.weekTime=T(),Y({usertypes:"2,3"}),h()}),(l,n)=>{const e=Fe,o=we,s=ie;return f(),_("div",Ie,[i(m(Te),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:x(()=>[i(m(ke),{align:"center"},{default:x(()=>[n[6]||(n[6]=p("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),i(o,{label:"ç”¨æˆ·",path:"creater","label-placement":"left","show-feedback":!1},{default:x(()=>[i(e,{clearable:"",filterable:"",value:a.value.creater,"onUpdate:value":[n[0]||(n[0]=t=>a.value.creater=t),w],placeholder:"è¯·é€‰æ‹©","label-field":"username",size:"small","value-field":"id",options:m(B).data,onScroll:q},null,8,["value","options"])]),_:1}),i(m(ee),{value:u.value,"onUpdate:value":[n[1]||(n[1]=t=>u.value=t),H],size:"small"},{default:x(()=>[(f(!0),_(ne,null,oe(g.value,t=>(f(),A(m(Z),{key:t.value,value:t.value,label:t.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),u.value==="day"?(f(),A(m(J),{key:0,size:"small","formatted-value":a.value.dayTime,"onUpdate:formattedValue":[n[2]||(n[2]=t=>a.value.dayTime=t),j],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):S("",!0),u.value==="week"?(f(),A(m(J),{key:1,size:"small","formatted-value":a.value.weekTime,"onUpdate:formattedValue":[n[3]||(n[3]=t=>a.value.weekTime=t),j],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):S("",!0),u.value==="month"?(f(),A(m(J),{key:2,size:"small","formatted-value":a.value.monthTime,"onUpdate:formattedValue":[n[4]||(n[4]=t=>a.value.monthTime=t),j],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):S("",!0),i(m(xe),{type:"primary",onClick:h,size:"small",class:"w-full sm:w-auto"},{icon:x(()=>[i(s,{class:"text-icon"})]),default:x(()=>[D(" "+L(m(_e)("common.search")),1)]),_:1}),i(m(ee),{size:"small",value:$.value,"onUpdate:value":n[5]||(n[5]=t=>$.value=t),name:"radiobuttongroup1"},{default:x(()=>[i(m(Z),{value:"table",label:"è¡¨æ ¼"}),i(m(Z),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:x(()=>[$.value=="table"?(f(),A(m(be),{key:0,columns:O.value,data:P.value,size:"small","flex-height":!m(d).isMobile,"scroll-x":O.value.reduce((t,r)=>t+r.width,0),remote:"","row-key":t=>t.key,class:"h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","row-key"])):(f(),A(Le,{key:1,trackData:F.value},null,8,["trackData"]))]),_:1})])}}}),Qe=se(Re,[["__scopeId","data-v-ad625aa4"]]);export{Qe as default};
