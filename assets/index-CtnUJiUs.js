import{_ as Ee}from"./table-header-operation.vue_vue_type_script_setup_true_lang-DblglBez.js";import{d as Q,dF as Ie,j as $,aM as le,F as pe,bd as me,dG as fe,dH as _e,bb as Y,bW as Ae,am as ie,cl as Ue,r as xe,q as re,s as Te,v as Re,x as ze,b as Pe,y as je,bl as ve,bk as ye,K as te,o as E,c as J,w as a,g as e,h as p,t as w,i as n,$ as z,L as K,e as ue,ak as he,Z as P,N as Le,f as U,ay as Be,H as Fe,bn as Ke,aV as Ve,A as Ce,C as ge,R as qe,a2 as Ge,D as Ne,S as He,B as W,E as De,bm as Se,M as Je,ad as de,a4 as We,ag as ee}from"./index-7Q9xZuwa.js";import{e as Qe,g as Ze,f as Xe,h as Ye,i as et,j as be,k as tt}from"./reportForm-CrOLjfvW.js";import{f as at,i as Oe}from"./scheduleTask-DOPo8pTp.js";import{u as nt,a as ot}from"./table-G6_8Abm0.js";import{T as ce,a as Me,S as $e}from"./task-l058OQsC.js";import{M as st}from"./shield-question-outline-rounded-BJdrXAQE.js";import{a as lt,b as it,_ as rt}from"./DataTable-n3fP4Loy.js";import{_ as ut}from"./TimePicker-BYx0IEL9.js";import{_ as dt}from"./round-search-BQOA9W6m.js";import{_ as ct}from"./round-refresh-DJiiF7wv.js";import{_ as pt}from"./FormItemGridItem-DYTXkfwP.js";import{_ as mt}from"./Grid-CRtcNhSF.js";import{h as ke}from"./permission-BYoerBbx.js";import{_ as ft}from"./Popconfirm-BEMrdOuM.js";import{_ as _t,a as vt}from"./DescriptionsItem-DfMvCpt5.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-D8fMBsYv.js";import"./setting-outlined-V9qGIWHT.js";import"./export-oh2-I3ZA.js";import"./refresh-av0Mcmzj.js";import"./round-delete-BZFRn3Yp.js";import"./round-plus-Cy8c1zzO.js";import"./Upload-CwzIyBrH.js";import"./Progress-DAZ1S5w7.js";import"./Forward-BzUEeUAa.js";import"./defineProperty-B4q_dn_D.js";const yt=Q({name:"ModalEnvironment",props:Object.assign(Object.assign({},Ie),{internalKey:{type:String,required:!0},onInternalAfterLeave:{type:Function,required:!0}}),setup(_){const h=$(!0);function c(){const{onInternalAfterLeave:o,internalKey:m,onAfterLeave:t}=_;o&&o(m),t&&t()}function i(){const{onPositiveClick:o}=_;o?Promise.resolve(o()).then(m=>{m!==!1&&u()}):u()}function g(){const{onNegativeClick:o}=_;o?Promise.resolve(o()).then(m=>{m!==!1&&u()}):u()}function v(){const{onClose:o}=_;o?Promise.resolve(o()).then(m=>{m!==!1&&u()}):u()}function N(o){const{onMaskClick:m,maskClosable:t}=_;m&&(m(o),t&&u())}function D(){const{onEsc:o}=_;o&&o()}function u(){h.value=!1}function x(o){h.value=o}return{show:h,hide:u,handleUpdateShow:x,handleAfterLeave:c,handleCloseClick:v,handleNegativeClick:g,handlePositiveClick:i,handleMaskClick:N,handleEsc:D}},render(){const{handleUpdateShow:_,handleAfterLeave:h,handleMaskClick:c,handleEsc:i,show:g}=this;return le(pe,Object.assign({},this.$props,{show:g,onUpdateShow:_,onMaskClick:c,onEsc:i,onAfterLeave:h,internalAppear:!0,internalModal:!0}))}}),we=me("n-modal-provider"),ht=me("n-modal-api"),gt=me("n-modal-reactive-list"),bt={to:[String,Object]},kt=Q({name:"ModalProvider",props:bt,setup(){const _=fe(64),h=_e(),c=$([]),i={};function g(u={}){const x=Ue(),o=xe(Object.assign(Object.assign({},u),{key:x,destroy:()=>{var m;(m=i[`n-modal-${x}`])===null||m===void 0||m.hide()}}));return c.value.push(o),o}function v(u){const{value:x}=c;x.splice(x.findIndex(o=>o.key===u),1)}function N(){Object.values(i).forEach(u=>{u==null||u.hide()})}const D={create:g,destroyAll:N};return Y(ht,D),Y(we,{clickedRef:fe(64),clickedPositionRef:_e()}),Y(gt,c),Y(we,{clickedRef:_,clickedPositionRef:h}),Object.assign(Object.assign({},D),{modalList:c,modalInstRefs:i,handleAfterLeave:v})},render(){var _,h;return le(ie,null,[this.modalList.map(c=>{var i;return le(yt,Ae(c,["destroy"],{to:(i=c.to)!==null&&i!==void 0?i:this.to,ref:g=>{g===null?delete this.modalInstRefs[`n-modal-${c.key}`]:this.modalInstRefs[`n-modal-${c.key}`]=g},internalKey:c.key,onInternalAfterLeave:this.handleAfterLeave}))}),(h=(_=this.$slots).default)===null||h===void 0?void 0:h.call(_)])}}),wt=U("span",null,[p("报表统计的周期为： "),U("span",{class:"c-#1890ff"},"前一天"),p(" / "),U("span",{class:"c-#1890ff"},"上周周一至周日"),p(" / "),U("span",{class:"c-#1890ff"},"上个月"),p(" / "),U("span",{class:"c-#1890ff"},"上周周日至周六")],-1),xt=Q({name:"TaskModal",__name:"task_modal",props:re({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:re(["submitted"],["update:visible"]),setup(_,{expose:h,emit:c}){const i=_,g=c,v=Te(_,"visible"),{formRef:N,validate:D,restoreValidation:u}=Re(),{defaultRequiredRule:x,patternRules:o}=ze(),m=Pe(()=>({add:"新增任务",edit:"编辑任务"})[i.operateType]),t=xe(j());function j(){return{id:void 0,rname:"",rtype:0,ttype:0,starttime:void 0,endtime:void 0,excute:1,stype:0,recipient:"",rdesc:"",tid:void 0}}const L={rname:x,starttime:x,cron:x,rtype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择实例"},ttype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择任务类型"},stype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择发送类型"},recipient:{required:!0,validator:Be,trigger:["input","change","blur","password-input"]}},S=$(""),V=async()=>{var R,k;const{data:y,error:l}=await Oe((R=i.rowData)==null?void 0:R.tid);if(!l){const T=Se(y==null?void 0:y.cronExpression);S.value=(k=JSON.parse(y==null?void 0:y.params))==null?void 0:k.uuid,t.starttime=T==null?void 0:T.settingTime}};function q(){Object.assign(t,j()),O.value=Fe(),i.operateType==="edit"&&i.rowData&&(i.rowData.starttime=i.rowData.starttime.substring(11,19),Object.assign(t,i.rowData),V())}function B(){v.value=!1}const O=$(""),I=async y=>{const{data:l,error:R}=await Xe({beanName:"ReportTask",remark:O.value,cronExpression:y,params:JSON.stringify({rtype:t.rtype,ttype:t.ttype,uuid:O.value})});return R?!1:(await b(),!0)},b=async()=>{const{data:y,error:l}=await Ye({uuid:O.value});t.tid=y};async function ae(){var l,R;await D();const y=Ke(t.ttype==1||t.ttype==3?{dayOfWeek:t.excute,time:t.starttime}:null,t.ttype==2?{dayOfMonth:t.excute,time:t.starttime}:null,t.ttype==0?{time:t.starttime}:null);if(i.operateType==="add"){if(!await I(y))return!1}else{const{data:k,error:T}=await at({id:t.tid,cronExpression:y,beanName:"ReportTask",status:1,params:JSON.stringify({rtype:t.rtype,ttype:t.ttype,uuid:S.value})});if(T)return!1}if(t.ttype==0&&delete t.excute,i.operateType==="add"){const{data:k,error:T}=await Qe({...t,starttime:Ve(1,new Date)});T||((l=window.$message)==null||l.success(z("common.addSuccess")),B(),g("submitted"))}else{delete t.starttime;const{data:k,error:T}=await Ze({...t});T||((R=window.$message)==null||R.success(z("common.updateSuccess")),B(),g("submitted"))}}const Z=y=>{t.excute=1};return je(v,()=>{v.value&&(q(),u())}),h({monthOption:ve,weekOption:ye}),(y,l)=>{const R=Ce,k=ge,T=it,G=lt,f=qe,r=Ge,C=ut,A=ge,M=Ne,ne=He,X=W,oe=De,se=pe,d=te("no-space");return E(),J(se,{show:v.value,"onUpdate:show":l[8]||(l[8]=s=>v.value=s),title:m.value,preset:"card",class:"w-600px"},{footer:a(()=>[e(oe,{justify:"end",size:16},{default:a(()=>[e(X,{onClick:B},{default:a(()=>[p(w(n(z)("common.cancel")),1)]),_:1}),e(X,{type:"primary",onClick:ae},{default:a(()=>[p(w(n(z)("common.confirm")),1)]),_:1})]),_:1})]),default:a(()=>[e(ne,{class:"max-h-520px pr-20px"},{default:a(()=>[e(M,{ref_key:"formRef",ref:N,model:t,rules:L,"label-placement":"left","label-width":110,"require-mark-placement":"left"},{default:a(()=>[e(k,{label:"任务名称",path:"rname"},{default:a(()=>[K(e(R,{value:t.rname,"onUpdate:value":l[0]||(l[0]=s=>t.rname=s),placeholder:"请输入任务名称",clearable:""},null,8,["value"]),[[d]])]),_:1}),e(k,{label:"实例选择",path:"rtype"},{default:a(()=>[e(G,{value:t.rtype,"onUpdate:value":l[1]||(l[1]=s=>t.rtype=s),name:"radiogroup"},{default:a(()=>[(E(!0),ue(ie,null,he(n(P)(n(ce)),(s,F)=>(E(),J(T,{key:F,value:s.value},{default:a(()=>[p(w(s.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),e(k,{label:"任务类型",path:"ttype"},{label:a(()=>[p(" 任务类型 "),e(f,{trigger:"hover",placement:"top-start"},{trigger:a(()=>[e(n(st),{class:"text-xl cursor-pointer c-#7a7b78"})]),default:a(()=>[wt]),_:1})]),default:a(()=>[e(G,{value:t.ttype,"onUpdate:value":[l[2]||(l[2]=s=>t.ttype=s),Z],name:"radiogroup"},{default:a(()=>[(E(!0),ue(ie,null,he(n(P)(n(Me)),(s,F)=>(E(),J(T,{key:F,value:s.value},{default:a(()=>[p(w(s.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),[1,2,3].includes(t.ttype)?(E(),J(k,{key:0,label:t.ttype==2?"每月":"每周",path:"excute"},{default:a(()=>[e(r,{filterable:"",value:t.excute,"onUpdate:value":l[3]||(l[3]=s=>t.excute=s),placeholder:"请选择",options:t.ttype==2?n(ve)():n(ye)(),style:{width:"100%"}},null,8,["value","options"])]),_:1},8,["label"])):Le("",!0),e(A,{label:"执行时间",path:"starttime"},{default:a(()=>[e(C,{"formatted-value":t.starttime,"onUpdate:formattedValue":l[4]||(l[4]=s=>t.starttime=s),placeholder:"选择执行时间"},null,8,["formatted-value"])]),_:1}),e(k,{label:"收件人",path:"recipient"},{default:a(()=>[K(e(R,{value:t.recipient,"onUpdate:value":l[5]||(l[5]=s=>t.recipient=s),placeholder:"请输入收件人",clearable:""},null,8,["value"]),[[d]])]),_:1}),e(k,{label:"发送类型",path:"stype"},{default:a(()=>[e(r,{filterable:"",value:t.stype,"onUpdate:value":l[6]||(l[6]=s=>t.stype=s),placeholder:"请选择发送类型",options:n(P)(n($e)),style:{width:"100%"}},null,8,["value","options"])]),_:1}),e(k,{label:"任务描述",path:"rdesc"},{default:a(()=>[K(e(R,{type:"textarea",value:t.rdesc,"onUpdate:value":l[7]||(l[7]=s=>t.rdesc=s),placeholder:"请输入任务描述",clearable:""},null,8,["value"]),[[d]])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Tt=Q({name:"TaskSearch",__name:"task_search",props:{model:{required:!0},modelModifiers:{}},emits:re(["reset","search"],["update:model"]),setup(_,{emit:h}){const c=h,{formRef:i,restoreValidation:g}=Re(),v=Te(_,"model");function N(){v.value.fuzzy=void 0,c("search")}async function D(){await g(),c("reset")}async function u(){c("search")}return(x,o)=>{const m=Ce,t=pt,j=ct,L=W,S=dt,V=De,q=mt,B=Ne,O=de,I=te("no-space");return E(),J(O,{bordered:!1,size:"small",class:"card-wrapper"},{default:a(()=>[e(B,{ref_key:"formRef",ref:i,model:v.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Je(u,["enter"])},{default:a(()=>[e(q,{responsive:"screen","item-responsive":""},{default:a(()=>[e(t,{span:"24 s:12 m:6",label:"任务名称",path:"fuzzy",class:"pr-24px"},{default:a(()=>[K(e(m,{value:v.value.fuzzy,"onUpdate:value":o[0]||(o[0]=b=>v.value.fuzzy=b),placeholder:"请输入任务名称关键字",clearable:"",onClear:N},null,8,["value"]),[[I]])]),_:1}),e(t,{span:"24 m:6",class:"pr-24px"},{default:a(()=>[e(V,{class:"w-full"},{default:a(()=>[e(L,{onClick:D},{icon:a(()=>[e(j,{class:"text-icon"})]),default:a(()=>[p(" "+w(n(z)("common.reset")),1)]),_:1}),e(L,{type:"primary",ghost:"",onClick:u},{icon:a(()=>[e(S,{class:"text-icon"})]),default:a(()=>[p(" "+w(n(z)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Rt={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ct=U("div",{style:{display:"flex","align-items":"center"}},[U("div",null,"报表任务")],-1),Yt=Q({name:"reportmanagement_reporttask",__name:"index",setup(_){const h=We(),{columns:c,columnChecks:i,data:g,getData:v,loading:N,mobilePagination:D,searchParams:u,resetSearchParams:x}=nt({apiFn:et,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"rname",title:"任务名称",align:"center",width:160},{key:"rtype",title:"实例类型",align:"center",width:160,render:f=>{var r;return e("div",null,[(r=P(ce).find(C=>C.value===f.rtype))==null?void 0:r.label])}},{key:"starttime",title:"创建时间",align:"center",width:160},{key:"operate",title:z("common.operate"),align:"center",width:160,render:f=>e("div",{class:"flex-center gap-8px"},[e(kt,null,{default:()=>[e(W,{type:"info",ghost:!0,size:"small",onClick:()=>ae(f.id)},{default:()=>[p("详情")]})]}),K(e(W,{type:"warning",ghost:!0,size:"small",onClick:()=>R(f.id)},{default:()=>[p("修改")]}),[[te("no-auth"),"sys.report.task.update"]]),e(ft,{onPositiveClick:()=>k(f.id)},{default:()=>"确定要删除改数据吗？",trigger:()=>K(e(W,{type:"error",ghost:!0,size:"small"},{default:()=>[p("删除")]}),[[te("no-auth"),"sys.report.task.delete"]])})])}]}),{drawerVisible:o,operateType:m,editingData:t,handleAdd:j,handleEdit:L,checkedRowKeys:S,onBatchDeleted:V,onDeleted:q,closeDrawer:B}=ot(g,v),O=$(),I=$(!1),b=$({id:void 0,rname:"",rtype:0,ttype:0,starttime:void 0,endtime:void 0,excute:0,stype:0,recipient:"",rdesc:"",tid:void 0}),ae=async f=>{I.value=!0;const{data:r,error:C}=await be(f);C||(b.value=r,y(r.tid+""))},Z=$(""),y=async f=>{const{data:r,error:C}=await Oe(f);if(!C){const A=Se(r.cronExpression);Z.value=A.settingTime}},l=$();async function R(f){const{data:r,error:C}=await be(f);C||(l.value=r),L(f)}function k(f){G(f,r=>{q()})}async function T(){G(S.value.join(","),f=>{V()})}async function G(f,r){const{data:C,error:A}=await tt(f);A||r&&r(C)}return(f,r)=>{const C=Ee,A=rt,M=_t,ne=vt,X=de,oe=pe,se=de;return E(),ue("div",Rt,[e(Tt,{model:n(u),"onUpdate:model":r[0]||(r[0]=d=>ee(u)?u.value=d:null),onReset:n(x),onSearch:n(v)},null,8,["model","onReset","onSearch"]),e(se,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:a(()=>[Ct]),"header-extra":a(()=>[e(C,{columns:n(i),"onUpdate:columns":r[1]||(r[1]=d=>ee(i)?i.value=d:null),"disabled-delete":n(S).length===0,loading:n(N),onAdd:n(j),onRefresh:n(v),"is-view-add-button":n(ke)("sys.report.task.insert"),isViewDeleteButton:n(ke)("sys.report.task.delete"),onDelete:T},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","isViewDeleteButton"])]),default:a(()=>[e(A,{"checked-row-keys":n(S),"onUpdate:checkedRowKeys":r[2]||(r[2]=d=>ee(S)?S.value=d:null),columns:n(c),data:n(g),size:"small","flex-height":!n(h).isMobile,"scroll-x":962,loading:n(N),remote:"","row-key":d=>d.id,pagination:n(D),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),e(xt,{ref_key:"TaskModalRef",ref:O,visible:n(o),"onUpdate:visible":r[3]||(r[3]=d=>ee(o)?o.value=d:null),"operate-type":n(m),"row-data":l.value,onSubmitted:n(v)},null,8,["visible","operate-type","row-data","onSubmitted"]),e(oe,{show:I.value,"onUpdate:show":r[4]||(r[4]=d=>I.value=d),preset:"card",class:"w-500px",title:"报表任务详情"},{default:a(()=>[e(X,null,{default:a(()=>[e(ne,{"label-placement":"left",column:1,"label-style":{width:"100px",display:"inline-block",textAlign:"right",marginRight:"10px"}},{default:a(()=>[e(M,{label:"任务名称"},{default:a(()=>[p(w(b.value.rname),1)]),_:1}),e(M,{label:"实例"},{default:a(()=>{var d;return[p(w((d=n(P)(n(ce)).find(s=>s.value===b.value.rtype))==null?void 0:d.label),1)]}),_:1}),e(M,{label:"创建时间"},{default:a(()=>[p(w(b.value.starttime),1)]),_:1}),e(M,{label:"任务执行周期"},{default:a(()=>{var d,s,F;return[p(w((d=n(P)(n(Me)).find(H=>H.value===b.value.ttype))==null?void 0:d.label)+" "+w(b.value.ttype==1?(s=O.value.weekOption().find(H=>H.value==b.value.excute))==null?void 0:s.label:b.value.ttype==2?(F=O.value.monthOption().find(H=>H.value==b.value.excute))==null?void 0:F.label:"")+" "+w(Z.value),1)]}),_:1}),e(M,{label:"发送类型"},{default:a(()=>{var d;return[p(w((d=n(P)(n($e)).find(s=>s.value===b.value.stype))==null?void 0:d.label),1)]}),_:1}),e(M,{label:"收件人"},{default:a(()=>[p(w(b.value.recipient),1)]),_:1}),e(M,{label:"描述"},{default:a(()=>[p(w(b.value.rdesc),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])]),_:1})])}}});export{Yt as default};
