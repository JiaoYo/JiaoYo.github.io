import{_ as le}from"./table-column-setting.vue_vue_type_script_setup_true_lang-x9QqHz1q.js";import{_ as oe}from"./round-search-U2uRVYGb.js";import{d as ce,bw as ie,g as o,aQ as T,aT as re,a$ as O,v as de,ai as ue,j as k,au as pe,x as L,F as R,b1 as $,b2 as F,b3 as J,aD as W,aa as _e,o as he,e as me,w as p,h as U,i as l,am as fe,A as ge,B as ye,ae as ve,f as G,N as ke,z as be,bx as we,t as xe,ap as H,aj as Se,L as Te,ar as $e,O as De,ak as Ne,as as ze,a5 as Ce,S as qe}from"./index-DUtpuk6Y.js";import{u as Ie,a as Ee}from"./table-6stvuKK6.js";import{a as Pe,p as Ae}from"./gather-5KVYwAhq.js";import{h as M}from"./permission-Bx9DMYgP.js";import{_ as Oe}from"./InputGroupLabel-BFLjX3VM.js";import{_ as Ue}from"./Tree-edI_kJKH.js";import{_ as Ve}from"./Split-koo6bSU3.js";const je={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Be={class:"flex flex-col"},Ke=ce({name:"configsetting_realtimedata_devicedata",__name:"index",setup(Le){const{columns:Q,columnChecks:D,data:w,getData:b,loading:V,mobilePagination:Y,searchParams:f,resetSearchParams:Re}=Ie({apiFn:ie,apiParams:{page:1,pageSize:200,limit:200,tagType:null,chlid:null,devId:null,fuzzy:"",chlType:0,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",align:"center",width:48},{key:"id",title:"序号",align:"center",width:80},{key:"devId",title:"设备名称",align:"center",width:100,render:e=>{var t;return o("span",null,[(t=j.value.find(n=>n.id==e.devId))==null?void 0:t.devName])}},{key:"tagName",title:"测点名称",align:"center"},{key:"tagDesc",title:"物模型标识(测点描述)",align:"center"},{key:"value",title:"测点值",align:"center",width:140,render:e=>{var t;return T("span",{style:{color:e.quality===100?"red":e.quality==49?"#409eff":e.quality==50?"#909399":"#67c23a"}},parseFloat((t=e.value)==null?void 0:t.toFixed(6))||e.value)}},{key:"quality",title:"质量",align:"center",width:120,render:e=>(e.quality==100||e.quality==49||e.quality==0)&&T(re,{style:{background:e.quality===100?"red":e.quality==49?"#409eff":"#67c23a",color:"#fff"}},e.quality==0?"Good":e.quality==49?"人工置数":e.quality==100?"Bad":"")},{key:"dbtime",title:"采集时间",align:"center",minWidth:120,render:e=>{var t,n;return T("span",{title:O(0,+e.dbtime)},e.dbtime?(n=O(2,+e.dbtime))==null?void 0:n.substring(10,(t=O(2,+e.dbtime))==null?void 0:t.length):"")}},{key:"tagType",title:"测点类型",align:"center",width:140,render:e=>o("span",null,[Pe[e.tagType]])},{key:"objAddr",title:"地址",align:"center",width:140}]}),X=e=>{e===""&&b()};de(async()=>{await Z(),q(),ee()}),ue(()=>{var e,t;(e=N.value)==null||e.close(),(t=S.value)==null||t.close()});const v=k(),j=k([]),Z=async()=>{const{data:e,error:t}=await pe();if((e==null?void 0:e.length)==0)return;function n(_){return _.map(i=>{var a;return{label:i.chlName,key:i.id,dev_status:null,children:(a=i.devicePojoList)!=null&&a.length?i.devicePojoList.map(c=>(j.value.push(c),{label:c.devName,dev_status:null,chlType:i.chlType,key:c.id})):[]}})}v.value=n(e),f.chlid=v.value[0].key,f.devId=v.value[0].children[0].key,I.value=[v.value[0].children[0].key],x.value=v.value[0].children[0].label,b()},N=k(null),ee=()=>{var c,d,g;if((c=N.value)==null||c.close(),!M("channel:status:websocket")){(d=window.$message)==null||d.destroyAll(),(g=window.$message)==null||g.warning("暂无权限连接websocket");return}const e=new Date().getTime(),t=L(),n=R(`${t}${e}getchlstatus`),_=$(n),i=$("getchlstatus"),a=new F(J+`/ChannelStatusWebsocket/${i}/${_}/${e}/${t}?token=${W()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});N.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(u=>{let h=[];if(console.log(u,"通道状态websocket接受数据"),!B(u.data))return;h=JSON.parse(u.data).data;const y=JSON.parse(u.data).valid;v.value.forEach(s=>{h.forEach(m=>{var r;m.chl_id==s.key&&(s.dev_status=m.chl_status),m.chl_id==1&&(s.dev_status=1),(r=s.children)==null||r.forEach(P=>{var K;(K=m.devs)==null||K.forEach(A=>{A.dev_id==P.key&&(P.dev_status=A.dev_status),A.dev_id==1&&(P.dev_status=1)})})})}),v.value.forEach(s=>{y.forEach(m=>{s.key==m.id&&(s.chlValid=m.chlValid)})})})},S=k(null),z=k(""),C=k(!0),q=()=>{var c,d,g;if((c=S.value)==null||c.close(),!M("realtime:data:websocket")){(d=window.$message)==null||d.destroyAll(),(g=window.$message)==null||g.warning("暂无权限连接websocket");return}C.value=!0;const e=new Date().getTime(),t=L(),n=R(`${t}${e}${x.value}`),_=$(n),i=$(x.value),a=new F(J+`/realTimeDataWebsocket/${i}/${_}/${e}/${t}?token=${W()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});S.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(u=>{let h=[];console.log(u,"实时数据websocket接受数据"),B(u.data)&&(h=JSON.parse(u.data).data[x.value],h==null||h.forEach(y=>{w.value.forEach(s=>{y.i==s.id&&(s.quality=y.q,s.value=y.v,s.dbtime=y.t)})}),z.value=se())})},I=k([]),x=k(""),te=async(e,t,n)=>{var a,c,d,g,u;I.value=[(a=n.node)==null?void 0:a.key],f.chlType=(c=n.node)==null?void 0:c.chlType;function _(h,y){for(const s of h)if(s.children){for(const m of s.children)if(m.key===y)return s.key}return null}const i=await _(v.value,(d=n.node)==null?void 0:d.key);f.chlid=i,f.devId=(g=n.node)==null?void 0:g.key,x.value=(u=n.node)==null?void 0:u.label,b(),q()},ae=e=>{var t;e&&w.value.length>0?q():(t=S.value)==null||t.close()};_e(()=>f.tagType,e=>{e||b()});const ne=({option:e})=>e.key==0?"":e.dev_status!==null?T("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:e.hasOwnProperty("dev_status")&&e.dev_status==1?"#00b42a":e.dev_status==2?"#ff0000":"#ccc",color:"#ff0000",lineHeight:"12px",textAlign:"center",fontSize:"16px"}},e.chlValid==1?"":e.chlValid==2?"×":""):"",se=e=>{const t=new Date,n=t.getFullYear(),_=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),c=String(t.getMinutes()).padStart(2,"0"),d=String(t.getSeconds()).padStart(2,"0");return`${n}-${_}-${i} ${a}:${c}:${d}`},{drawerVisible:Fe,operateType:Je,editingData:We,handleAdd:Ge,handleEdit:He,checkedRowKeys:E,onBatchDeleted:Me,onDeleted:Qe}=Ee(w,b),B=e=>{try{return JSON.parse(e),!0}catch{return!1}};return(e,t)=>{const n=Oe,_=Se,i=Te,a=oe,c=$e,d=De,g=le,u=Ue,h=Ne,y=ze,s=Ve,m=Ce;return he(),me("div",je,[o(m,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:p(()=>[o(d,{align:"center",wrap:"",justify:"start",class:"lt-sm:w-200px"},{default:p(()=>[o(c,null,{default:p(()=>[o(n,null,{default:p(()=>[U("测点类型")]),_:1}),o(_,{filterable:"",clearable:"",placeholder:"请选择",value:l(f).tagType,"onUpdate:value":t[0]||(t[0]=r=>l(f).tagType=r),options:l(fe)(l(Ae))},null,8,["value","options"]),o(i,{clearable:"",value:l(f).fuzzy,"onUpdate:value":[t[1]||(t[1]=r=>l(f).fuzzy=r),X],placeholder:"请输入测点名称或描述",style:{width:"150%"},onKeyup:ge(l(b),["enter"])},null,8,["value","onKeyup"]),o(l(ye),{type:"primary",ghost:"",onClick:l(b)},{icon:p(()=>[o(a,{class:ve(["text-icon",{"animate-spin":l(V)}])},null,8,["class"])]),default:p(()=>[U(" 搜索 ")]),_:1},8,["onClick"])]),_:1}),G("div",Be,[o(l(ke),{checked:C.value,"onUpdate:checked":[t[2]||(t[2]=r=>C.value=r),ae]},{default:p(()=>[U(" 实时刷新 ")]),_:1},8,["checked"]),be(G("span",{class:"font-size-14px color-blank",style:{"font-weight":"600"}}," 刷新时间："+xe(z.value),513),[[we,z.value]])])]),_:1})]),"header-extra":p(()=>[o(d,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:p(()=>[o(g,{columns:l(D),"onUpdate:columns":t[3]||(t[3]=r=>H(D)?D.value=r:null)},null,8,["columns"])]),_:1})]),default:p(()=>[o(s,{direction:"horizontal",class:"sm:h-full","default-size":.15,max:.35,min:.1,"resize-trigger-size":6},{1:p(()=>[o(h,{style:{"max-height":"700px"}},{default:p(()=>[o(u,{"block-line":"","default-expand-all":"",data:v.value,"checked-keys":I.value,"expand-on-click":!1,"render-prefix":ne,"check-strategy":"child","onUpdate:checkedKeys":te,checkable:""},null,8,["data","checked-keys"])]),_:1})]),2:p(()=>[o(y,{"checked-row-keys":l(E),"onUpdate:checkedRowKeys":t[4]||(t[4]=r=>H(E)?E.value=r:null),columns:l(Q),data:l(w),size:"small",loading:l(V),remote:"","row-key":r=>r.id,"flex-height":!0,"scroll-x":"",pagination:l(w).length?l(Y):void 0,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1})])}}}),ot=qe(Ke,[["__scopeId","data-v-cf5c6d90"]]);export{ot as default};
