import{T as L,bQ as j,r as A,j as C,b as x,bp as $,a3 as I,$ as _,ae as H,l as R,bR as U}from"./index-DqR-s4w3.js";function Y(o){const{loading:u,startLoading:y,endLoading:l}=L(),{bool:P,setBool:d}=j(),{apiFn:v,apiParams:p,transformer:k,immediate:m=!1,getColumnChecks:w,getColumns:D}=o,n=A({...p}),g=C(o.columns()),S=C([]),h=C(w(o.columns())),z=x(()=>D(g.value,h.value));function b(){g.value=o.columns();const i=new Map(h.value.map(e=>[e.key,e.checked])),r=w(g.value);h.value=r.map(e=>({...e,checked:i.get(e.key)??e.checked}))}async function f(i){var a;y();const r=T(i?Object.assign(n,i):n),e=await v(r),t=k(e);S.value=t.data,d(t.data.length===0),await((a=o.onFetched)==null?void 0:a.call(o,t)),l()}function T(i){const r={};return Object.entries(i).forEach(([e,t])=>{t!=null&&(r[e]=t)}),r}function s(i){Object.assign(n,i)}function N(){Object.assign(n,p),f()}return m&&f(),{loading:u,empty:P,data:S,columns:z,columnChecks:h,reloadColumns:b,getData:f,searchParams:n,updateSearchParams:s,resetSearchParams:N}}function V(o){const u=$(),y=I(),l=x(()=>y.isMobile),{apiFn:P,apiParams:d,immediate:v,showTotal:p=!0}=o,k="__selection__",m="__expand__",{loading:w,empty:D,data:n,columns:g,columnChecks:S,reloadColumns:h,getData:z,searchParams:b,updateSearchParams:f,resetSearchParams:T}=Y({apiFn:P,apiParams:d,columns:o.columns,transformer:e=>{let t=b;if(e.error)return{data:[],pageNum:t.page,pageSize:t.pageSize,total:0};e.hasOwnProperty("total")||(e.total=0);const{data:a=[],pageNum:O=1,pageSize:c=20,total:M=0}=e||{},F=(a instanceof Array?a:a?a.hasOwnProperty("list")?a.list:a.data||[]:[]).map((B,K)=>({...B,index:(O-1)*c+K+1}));return e.total=a instanceof Array?Object.prototype.hasOwnProperty.call(a,"total")?Number(a.total):Number(M):Number(a.total),{data:F,pageNum:t.page,pageSize:t.pageSize,total:Number.isNaN(e.total)?0:e.total}},getColumnChecks:e=>{const t=[];return e.forEach(a=>{E(a)?t.push({key:a.key,title:a.title,checked:!0}):a.type==="selection"?t.push({key:k,title:_("common.check"),checked:!0}):a.type==="expand"&&t.push({key:m,title:_("common.expandColumn"),checked:!0})}),t},getColumns:(e,t)=>{const a=new Map;return e.forEach(c=>{E(c)?a.set(c.key,c):c.type==="selection"?a.set(k,c):c.type==="expand"&&a.set(m,c)}),t.filter(c=>c.checked).map(c=>a.get(c.key))},onFetched:async e=>{const{pageNum:t,pageSize:a,total:O}=e;r({page:t,pageSize:a,itemCount:O})},immediate:v}),s=A({page:1,pageSize:20,itemCount:0,showSizePicker:!0,pageSizes:[20,50,100,200],onUpdatePage:async e=>{s.page=e,f({page:e,pageSize:s.pageSize||20,limit:s.pageSize||20,_t:new Date().getTime()}),await N()},onUpdatePageSize:async e=>{s.pageSize=e,s.page=1,f({page:s.page,pageSize:e,limit:e,_t:new Date().getTime()}),await N()},...p?{prefix:e=>_("datatable.itemCount",{total:e.itemCount})}:{}}),N=async()=>{n.value.length===1&&s.page&&s.page>1?(s.page-=1,b.page=s.page,await z()):(await z(),n.value.length===0&&s.page&&s.page>1&&(s.page-=1,b.page=s.page,await z()))},i=x(()=>({...s,pageSlot:l.value?3:9,prefix:!l.value&&p?s.prefix:void 0}));function r(e){Object.assign(s,e)}return u.run(()=>{H(()=>y.locale,()=>{h()})}),R(()=>{u.stop()}),{loading:w,empty:D,data:n,columns:g,columnChecks:S,reloadColumns:h,pagination:s,mobilePagination:i,updatePagination:r,getData:N,searchParams:b,updateSearchParams:f,resetSearchParams:T}}function W(o,u){const{bool:y,setTrue:l,setFalse:P}=j(),d=C("add");function v(){d.value="add",l()}const p=C(null);function k(n){d.value="edit";const g=o.value.find(S=>S.id===n)||null;p.value=U(g),l()}const m=C([]);async function w(){var n;(n=window.$message)==null||n.success(_("common.deleteSuccess")),m.value=[],await u()}async function D(){var n;(n=window.$message)==null||n.success(_("common.deleteSuccess")),await u()}return{drawerVisible:y,openDrawer:l,closeDrawer:P,operateType:d,handleAdd:v,editingData:p,handleEdit:k,checkedRowKeys:m,onBatchDeleted:w,onDeleted:D}}function E(o){return!!o.key}export{W as a,V as u};
