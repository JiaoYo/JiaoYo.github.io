import{_ as Vt}from"./table-column-setting.vue_vue_type_script_setup_true_lang-Bd_ydgz6.js";import{_ as Jt}from"./round-delete-DpC2P942.js";import{_ as qt}from"./round-add-D3WUtpeV.js";import{d as Fe,as as $e,p as yt,s as je,r as P,q as _t,$ as j,W as d,A as $,B as g,c8 as Gt,b$ as Kt,c6 as Ht,c7 as dt,ap as ct,av as ge,cs as Wt,ct as Xt,cq as Yt,cr as pt,a as Qt,at as Ye,a1 as Qe,b as bt,o as te,a5 as Zt,f as a,ay as ea,w as l,au as ta,F as St,E as kt,c as ve,y as We,h as s,aw as xe,ao as aa,e as H,N as le,g as _,ax as Ze,t as ie,b8 as wt,di as Ct,dx as mt,dy as na,dz as ft,dA as sa,dB as la,dC as ia,dc as gt,a2 as oa,dj as ra,cw as ua,cy as da,c9 as ca,bp as pa,db as ma,c0 as fa,dh as ga,bs as va,cg as ha,U as et,a8 as vt,co as ya,cd as _a,ac as Ue,ae as ba,L as Sa,ck as ka,c3 as wa,i as Ca,x as Ae,aB as Te,C as Ce,bn as Da,aa as xa,dD as za,ad as Na,ab as Pa,aE as Ia}from"./index-GKZr6R-C.js";import{u as Xe,a as ja}from"./table-VcDsA4zD.js";import{_ as Aa}from"./round-plus-FACknECR.js";import{_ as Ta,a as $a,A as Ua}from"./index-DByo00vF.js";import{f as tt,g as Fa,h as Dt,p as La,d as Oa}from"./business-Cjsb8Ai9.js";import{u as Ea}from"./usePageData-CFaE5rQl.js";import{v as Ma}from"./v4-FuVw324d.js";import{N as De}from"./Popconfirm-C9ev1_yH.js";import{_ as xt}from"./Grid-C-96xXAi.js";import{_ as zt}from"./FormItemGridItem-Dlimnbl-.js";import{_ as Ra}from"./round-search-DYdIbIbe.js";import{_ as Ba}from"./round-refresh-BRaDYp-e.js";import{N as Va}from"./DatePicker--SC4nRCK.js";import{N as Ja}from"./RadioButton-D1mbb0Eu.js";const qa={style:{display:"flex","flex-direction":"column"}},Ga={style:{display:"flex","flex-direction":"column"}},Ka={style:{display:"flex","flex-direction":"column"}},Ha=Fe({name:"OperateDrawer",__name:"operate-drawer",props:$e({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:$e(["submitted"],["update:visible"]),setup(U,{emit:W}){const k=yt(),J=W,A=je({contactList:[],debuggedDevieceList:[]}),r=U,i=je(X());function X(){return{proname:"",dispatchIds:[],contractIds:[],proaddr:"",cpdbtime:null,prosite:"",longitude:120.373885,latitude:30.303899,period:void 0,dtype:void 0,dispatch:"",status:1}}const x=P(0),q=P(void 0);async function F(){Object.assign(i,X()),Et(),r.operateType==="edit"&&r.rowData&&(Object.assign(i,r.rowData),x.value=i.period,q.value=i.status,await it(),rt(i.proaddr||i.prosite),Ut())}const{formRef:m,validate:w,restoreValidation:oe}=_t(),L={proname:{type:"string",required:!0,trigger:["blur","change"],message:"请输入项目名称"},status:{type:"number",required:!0,trigger:["blur","change"],message:"请选择项目状态"},contractIds:{type:"array",required:!0,trigger:["blur","change"],message:"请选择合同"},dtype:{type:"number",required:!0,trigger:["blur","change"],message:"请选择调试类型"},period:{type:"number",required:!0,trigger:["blur","change"],message:"请输入周期"},prosite:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请选择项目地点"},cpdbtime:{type:"string",required:!0,trigger:["blur","change"],message:"请选择时间"}},v=P([]),O=je({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",pageSizes:[20],prefix:()=>`共 ${v.value.length} 条`,onChange:e=>{O.page=e,y()},onUpdatePageSize:e=>{O.pageSize=e,O.page=1,y()}}),E=[{title:"姓名",key:"pname",align:"center",render(e,t){return e.setStatus?d($,{value:e.pname,placeholder:"请输入姓名",onUpdateValue(n){v.value[t].pname=n}}):d("div",{},e.pname)}},{title:"联系方式",key:"pcontact",align:"center",render(e,t){return e.setStatus?d($,{value:e.pcontact,placeholder:"请输入联系方式",onUpdateValue(n){v.value[t].pcontact=n}}):d("div",{},e.pcontact)}},{title:"备注",key:"proposition",align:"center",render(e,t){return e.setStatus?d($,{value:e.proposition,placeholder:"请输入备注",onUpdateValue(n){v.value[t].proposition=n}}):d("div",{},e.proposition)}},{key:"operate",title:j("common.operate"),align:"center",minWidth:120,fixed:"right",render(e,t){return d("div",{class:"flex-center gap-8px"},[e.setStatus?[d(g,{type:"primary",ghost:!0,size:"small",onClick:()=>re(e)},{default:()=>"保存"}),d(g,{type:"default",ghost:!0,size:"small",onClick:()=>Y(e,t)},{default:()=>"取消"}),d(De,{onPositiveClick:()=>{r.operateType==="edit"&&e.id?Gt(e.id).then(()=>{var n;v.value.splice(t,1),(n=window.$message)==null||n.success("删除成功")}):v.value.splice(t,1)}},{default:()=>j("common.confirmDelete"),trigger:()=>d(g,{type:"error",ghost:!0,size:"small"},{default:()=>j("common.delete")})})]:d(g,{type:"primary",ghost:!0,size:"small",onClick:()=>T(e)},{default:()=>"编辑"})])}}],y=async()=>{var t;const{data:e}=await Kt({page:O.page,limit:O.pageSize,pid:(t=r.rowData)==null?void 0:t.id});v.value=e==null?void 0:e.list,v.value.forEach(n=>{n.setStatus=!1}),A.contactList=JSON.parse(JSON.stringify(v.value))},T=e=>{v.value.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus},Y=(e,t)=>{e.setStatus=!e.setStatus,e.id?v.value=JSON.parse(JSON.stringify(A.contactList)):v.value.splice(t,1)},re=async e=>{var t,n,f,h,b;if(!e.pname){(t=window.$message)==null||t.warning("请输入联系人姓名");return}if(!e.pcontact){(n=window.$message)==null||n.warning("请输入联系方式");return}if(r.operateType==="edit")if(e.id){const{data:N,error:C}=await Ht([e]);C||((f=window.$message)==null||f.success("修改成功"),y(),e.setStatus=!e.setStatus)}else{const{data:N,error:C}=await dt([{...e,pid:(h=r.rowData)==null?void 0:h.id}]);C||((b=window.$message)==null||b.success("添加成功"),y(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function ue(){var e;((e=v.value[0])!=null&&e.pname||v.value.length==0)&&v.value.unshift({pname:"",pcontact:"",proposition:"",setStatus:!0})}const p=P([]),S=je({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",pageSizes:[20],prefix:()=>`共 ${p.value.length} 条`,onChange:e=>{S.page=e,he()},onUpdatePageSize:e=>{S.pageSize=e,S.page=1,he()}}),Le=[{title:"设备名称",key:"devname",align:"center",render(e,t){return e.setStatus?d($,{value:e.devname,placeholder:"请输入设备名称",onUpdateValue(n){p.value[t].devname=n}}):d("div",{},e.devname)}},{title:"型号",key:"devmodel",align:"center",render(e,t){return e.setStatus?d($,{value:e.devmodel,placeholder:"请输入型号",onUpdateValue(n){p.value[t].devmodel=n}}):d("div",{},e.devmodel)}},{title:"数量",key:"devnum",align:"center",render(e,t){return e.setStatus?d(ct,{value:e.devnum,placeholder:"请输入数量",onUpdateValue(n){p.value[t].devnum=Number(n)||0}}):d("div",{},e.devnum)}},{title:"是否为我司设备",key:"etype",align:"center",render(e,t){return e.setStatus?d(ge,{value:e.etype,options:[{label:"是",value:0},{label:"否",value:1}],onUpdateValue(n){p.value[t].etype=n}}):d("div",{},e.etype===0?"是":"否")}},{title:"设备厂家",key:"devmanu",align:"center",render(e,t){return e.setStatus?d($,{value:e.devmanu,placeholder:"请输入设备厂家",onUpdateValue(n){p.value[t].devmanu=n}}):d("div",{},e.devmanu)}},{title:"备注",key:"notes",align:"center",render(e,t){return e.setStatus?d($,{value:e.notes,placeholder:"请输入备注",onUpdateValue(n){p.value[t].notes=n}}):d("div",{},e.notes)}},{title:"清点状态",key:"status",align:"center",render(e,t){return e.setStatus?d(ge,{value:e.status,options:[{label:"未清点",value:0},{label:"正常",value:1},{label:"增补",value:2},{label:"退货",value:3},{label:"换货",value:4}],onUpdateValue(n){p.value[t].status=n}}):d("div",{},e.status===0?"未清点":e.status===1?"正常":e.status===2?"增补":e.status===3?"退货":"换货")}},{key:"operate",title:j("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return d("div",{class:"flex-center gap-8px"},[e.setStatus?[d(g,{type:"primary",ghost:!0,size:"small",onClick:()=>Ee(e)},{default:()=>"保存"}),d(g,{type:"default",ghost:!0,size:"small",onClick:()=>Oe(e,t)},{default:()=>"取消"}),d(De,{onPositiveClick:()=>{r.operateType==="edit"&&e.id?Wt(e.id).then(()=>{var n;p.value.splice(t,1),(n=window.$message)==null||n.success("删除成功")}):p.value.splice(t,1)}},{default:()=>j("common.confirmDelete"),trigger:()=>d(g,{type:"error",ghost:!0,size:"small"},{default:()=>j("common.delete")})})]:d(g,{type:"primary",ghost:!0,size:"small",onClick:()=>ye(e)},{default:()=>"编辑"})])}}],he=async()=>{var t;const{data:e}=await Xt({page:S.page,limit:S.pageSize,fuzzy:S.fuzzy,pid:(t=r.rowData)==null?void 0:t.id});p.value=e.list,A.debuggedDevieceList=JSON.parse(JSON.stringify(p.value))},ye=e=>{p.value.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus},Oe=(e,t)=>{e.setStatus=!e.setStatus,e.id?p.value=JSON.parse(JSON.stringify(A.debuggedDevieceList)):p.value.splice(t,1)},Ee=async e=>{var n,f,h,b,N,C;if(!e.devname){(n=window.$message)==null||n.warning("设备名称不能为空");return}if(!e.devmodel){(f=window.$message)==null||f.warning("设备型号不能为空");return}if(!e.devnum){(h=window.$message)==null||h.warning("设备数量不能为空");return}const t=e.dcreater*1;if(r.operateType==="edit")if(e.id){const{data:M,error:I}=await Yt([{...e,dcreater:t}]);I||((b=window.$message)==null||b.success("修改成功"),he(),e.setStatus=!e.setStatus)}else{const{data:M,error:I}=await pt([{...e,pid:(N=r.rowData)==null?void 0:N.id,dcreater:t}]);I||((C=window.$message)==null||C.success("添加成功"),he(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function ze(){var e;((e=p.value[0])!=null&&e.devname||p.value.length==0)&&p.value.unshift({status:void 0,devmanu:"",etype:0,devname:"",devmodel:"",devnum:0,notes:"",setStatus:!0})}const o=P({}),u=P([]);async function de(){var t;u.value=[];const{data:e}=await ga({page:1,limit:100,pid:(t=r.rowData)==null?void 0:t.id});e.list.forEach(n=>{n.sort==1&&u.value.push({id:n.id,name:n.filename,url:n.file,status:"finished",creator:n.username,dbtime:n.dbtime})}),u.value.reverse(),o.value=JSON.parse(JSON.stringify(e))}const ce=[{title:"文件别名",key:"name",align:"center",width:200,render(e){return e.setStatus?d($,{value:e.name,onUpdateValue:t=>{e.name=t}}):d("div",{},e.name)}},{title:"文件名称",key:"filename",align:"center",width:200,render(e){return e.setStatus&&!e.url?d(pa,{action:"#",showFileList:!1,customRequest:async({file:n,onFinish:f,onError:h})=>{var b,N,C,M;try{const I=new FormData;I.append("multipartFile",n.file);const{data:K,error:Q}=await fa(I);if(Q){(N=(b=window.$message)==null?void 0:b.error)==null||N.call(b,"文件上传失败");return}K&&(e.url=K)}catch(I){console.error(I),(M=(C=window.$message)==null?void 0:C.error)==null||M.call(C,"文件上传出错")}}},{default:()=>d(g,{type:"info",size:"small",ghost:!0},{default:()=>"上传文件"})}):e.setStatus&&e.url&&!e.id?a("span",null,[e.url.split("?")[1],_(" "),a("span",{onClick:()=>e.url=""},[_("X")])]):d("div",{},e.url.split("?")[1])}},{title:"上传人",key:"creator",align:"center",width:100,render(e){return d("div",{},e.creator)}},{title:"上传时间",key:"dbtime",align:"center",width:200,render(e){return d("div",{},e.dbtime?e.dbtime:"")}},{title:"操作",key:"actions",align:"center",width:180,render(e){return d(le,{justify:"center"},[!e.setStatus&&e.id&&d(g,{type:"info",size:"small",ghost:!0,onClick:()=>{pe(e)}},{default:()=>"下载"}),e.setStatus&&d(g,{type:"info",size:"small",ghost:!0,onClick:()=>{Re(e)}},{default:()=>"保存"}),e.setStatus&&d(g,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"取消"}),!e.setStatus&&d(g,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"编辑"})])}}];async function pe(e){if(e!=null&&e.url)try{const n=await(await fetch(e.url.split("?")[0],{mode:"cors"})).blob(),f=URL.createObjectURL(n),h=document.createElement("a");h.href=f,h.download=e.url.split("?")[1],h.style.display="none",document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(f)}catch(t){console.error("下载失败:",t)}}const Me=()=>{u.value.push({id:"",name:"",url:"",status:"uploading",setStatus:!0})},Re=async e=>{var t,n,f,h,b,N,C,M,I,K,Q,fe;if(!e.name){(n=(t=window.$message)==null?void 0:t.warning)==null||n.call(t,"请输入文件别名");return}if(!e.url){(h=(f=window.$message)==null?void 0:f.warning)==null||h.call(f,"请上传文件");return}if((b=r.rowData)!=null&&b.id){const{data:c,error:ke}=await gt([{pid:(N=r.rowData)==null?void 0:N.id,filename:e.name,file:e.url,sort:1}]);if(ke)return(C=window.$message)==null?void 0:C.error("保存文件记录失败");(M=window.$message)==null||M.destroyAll(),e.setStatus=!e.setStatus,de(),(I=window.$message)==null||I.success("保存成功")}else if(e.id){const{data:c,error:ke}=await ma([{id:e.id,filename:e.name}]);if(ke)return(K=window.$message)==null?void 0:K.error("保存文件记录失败");(Q=window.$message)==null||Q.destroyAll(),e.setStatus=!e.setStatus,(fe=window.$message)==null||fe.success("编辑成功")}else e.setStatus=!e.setStatus},Be=Qt(()=>({add:"新增项目",edit:"修改项目"})[r.operateType]),me=Ye(U,"visible");Qe(me,()=>{me.value&&(F(),setTimeout(()=>{const e=document.querySelector(".n-scrollbar-content");e==null||e.scrollTo(0,0)},300),oe())});function Ve(e){e||R()}function R(){me.value=!1}function z(){Se.value=!1}async function Ne(){var e;await w(),(e=window.$dialog)==null||e.info({title:"提示",content:"确定提交吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await Nt()}})}async function Nt(){var e,t,n,f,h,b,N,C,M,I,K,Q,fe;if(r.operateType==="edit"){const c=JSON.parse(JSON.stringify(i));x.value==c.period&&delete c.period,q.value==c.status&&delete c.status;const{data:ke,error:He}=await Ct([c]);if(!He){let Z=function(ee,B){const V=ee.filter(se=>!B.includes(se)),_e=B.filter(se=>!ee.includes(se));return{toDelete:V,toAdd:_e}};if((e=i.dispatchIds)!=null&&e.length&&((t=i.dispatchIds)==null?void 0:t.length)>0){const{toDelete:ee,toAdd:B}=Z(st.value,i.dispatchIds);if(B.length>0){const V=B.map(Ie=>({pid:i.id,did:Ie})),{data:_e,error:se}=await mt(V)}if(ee.length>0){const{data:V,error:_e}=await na(ee.join(","))}}if((n=i.contractIds)!=null&&n.length&&((f=i.contractIds)==null?void 0:f.length)>0){const{toDelete:ee,toAdd:B}=Z(Rt.value,i.contractIds);if(B.length>0){const V=B.map(Ie=>({pid:i.id,did:Ie})),{data:_e,error:se}=await ft(V)}if(ee.length>0){const{data:V,error:_e}=await sa(ee.join(","))}}R(),J("submitted"),(h=window.$message)==null||h.success("修改成功")}}else{const c=Ma(),{data:ke,error:He}=await la([{...i,uuid:c}]);if(!He){const{data:Z,error:ee}=await ia(c);if(Z){let B=function(D,be,ut){return D.map(we=>({...we,pid:be}))};if(i.dispatchIds&&i.dispatchIds.length>0){const D=[];(b=i.dispatchIds)==null||b.forEach(async we=>{D.push({pid:Z,did:we})});const{data:be,error:ut}=await mt(D)}if(i.contractIds&&i.contractIds.length>0){const D=[];(N=i.contractIds)==null||N.forEach(async we=>{D.push({proid:Z,conid:we})});const{data:be,error:ut}=await ft(D)}const V=[];if(v.value.length>0){const D=B(v.value,Z);V.push(dt(D))}if(p.value.length>0){const D=B(p.value,Z);V.push(pt(D))}if((await Promise.allSettled(V)).forEach((D,be)=>{D.status==="fulfilled"?console.log(`第 ${be+1} 个请求成功`,D.value):console.error(`第 ${be+1} 个请求失败`,D.reason)}),!u.value.length){(C=window.$message)==null||C.destroyAll(),(M=window.$message)==null||M.success("操作成功"),R(),J("submitted");return}const se=[];u.value.forEach(D=>{se.push({pid:Z,filename:D.name,file:D.url,sort:1})});const{data:Ie,error:Bt}=await gt(se);Bt&&((I=window.$message)==null||I.error("保存文件记录失败")),(K=window.$message)==null||K.destroyAll(),(Q=window.$message)==null||Q.success("操作成功"),R(),J("submitted")}}R(),J("submitted"),(fe=window.$message)==null||fe.success("添加成功")}}const Se=P(!1),Je=P();async function Pt(){const e="/map-sdk.json";try{return(await va.get(`${e}?_t=${Date.now()}`)).data}catch(t){throw console.error("获取地图 SDK 配置失败:",t),t}}let ae=null,at=null,Pe=null,nt=null,G=null;const ne=P(""),qe=P([]);async function It(){const e=await Pt();if(window._AMapSecurityConfig={securityJsCode:e.AMAP_SDK_SECRET},!!Je.value)try{G=await Ua.load({key:e.AMAP_SDK_KEY,version:"2.0",plugins:["AMap.Scale","AMap.PlaceSearch","AMap.AutoComplete","AMap.Lnglat","AMap.Geocoder","AMap.Geolocation"]}),ae=new G.Map(Je.value,{zoom:18,center:[i.longitude,i.latitude],viewMode:"3D",resizeEnable:!0});const t=new G.Geolocation({enableHighAccuracy:!0,timeout:1e4,position:"RT",buttonOffset:new G.Pixel(10,20),zoomToAccuracy:!0});ae.addControl(t),ae.addControl(new G.Scale),at=new G.Geocoder,nt=new G.PlaceSearch({pageSize:50}),ae.on("click",n=>{console.log("e",n);const f=n.lnglat.lng,h=n.lnglat.lat;Ge(G,{lng:f,lat:h})}),Ge(G,{lng:i.longitude,lat:i.latitude})}catch(t){console.error("地图加载失败:",t)}}function jt(){ne.value.trim()&&nt.search(ne.value,(e,t)=>{if(console.log(e,t),qe.value=[],e==="complete"&&t.info==="OK"){const n=t.poiList.pois;n.length>0&&n.forEach(f=>{const{address:h,location:b}=f;qe.value.push({label:h,value:b.lng+"_"+b.lat})})}else console.log("搜索失败或无结果")})}function At(){Se.value=!0,oa(()=>{It()})}function Tt(e){console.log("key",ne.value),console.log("val",e);let t=e.split("_")[0],n=e.split("_")[1];ae.setCenter([t,n]),Ge(G,{lng:t,lat:n})}function Ge(e,t){Pe&&ae.remove(Pe),Pe=new e.Marker({position:[t.lng,t.lat],map:ae}),ae.add(Pe),at.getAddress(t,(n,f)=>{n==="complete"&&f.regeocode&&(console.log("result",f),console.log("formattedAddress",f.regeocode.formattedAddress),i.latitude=t.lat,i.longitude=t.lng,ne.value=f.regeocode.formattedAddress)})}function $t(e,t){if(!t)return null;const n=t.replace(/省|市|特别行政区|自治区|壮族|回族|维吾尔/g,"").trim(),f=e.find(h=>t.includes(h.name)||h.name.includes(n));return f?f.id:null}const st=P([]),Ut=async()=>{const{data:e,error:t}=await ra({page:1,limit:100,pid:r.rowData.id});i.dispatchIds=e==null?void 0:e.list.map(n=>n.did),st.value=JSON.parse(JSON.stringify(i.dispatchIds))},lt=P([]),it=async()=>{const{data:e,error:t}=await ua();e&&(lt.value=e)},ot=P([]),rt=async e=>{let t=$t(lt.value,e);const{data:n,error:f}=await da({page:1,limit:100,province:t});ot.value=n.list},Ft=async()=>{await it(),i.prosite=ne.value,rt(ne.value),Se.value=!1},{pageData:Ke,getData:Lt,nextPage:Ot}=Ea(ca),Et=async()=>{await Lt({limit:100})},Mt=async e=>{const t=e.currentTarget;t.scrollTop+t.offsetHeight>=t.scrollHeight&&Ke.data.length<Ke.total&&Ot()},Rt=P([]);return(e,t)=>{const n=zt,f=Ta,h=aa,b=Aa,N=Ze,C=xt,M=St,I=ta,K=ea,Q=$a,fe=wt;return te(),bt(Zt,null,[a(K,{show:me.value,"onUpdate:show":[t[9]||(t[9]=c=>me.value=c),Ve],"display-directive":"show",width:1100,onMaskClick:R,onEsc:R},{default:l(()=>[a(I,{title:Be.value,"native-scrollbar":!1,closable:""},{footer:l(()=>[a(s(le),{size:16,justify:"end"},{default:l(()=>[a(s(g),{onClick:R},{default:l(()=>[_(ie(s(j)("common.cancel")),1)]),_:1}),a(s(g),{type:"primary",onClick:Ne},{default:l(()=>[_(ie(s(j)("common.confirm")),1)]),_:1})]),_:1})]),default:l(()=>[a(M,{ref_key:"formRef",ref:m,model:i,rules:L,onKeyup:kt(Ne,["enter"])},{default:l(()=>[a(C,{responsive:"screen","item-responsive":"","x-gap":"15"},{default:l(()=>[a(n,{span:"24 s:12 m:12",label:"项目名称",path:"proname"},{default:l(()=>[a(s($),{clearable:"",value:i.proname,"onUpdate:value":t[0]||(t[0]=c=>i.proname=c),placeholder:"请输入项目名称"},null,8,["value"])]),_:1}),r.operateType==="add"?(te(),ve(n,{key:0,span:"24 s:12 m:12",label:"绑定合同",path:"contractIds"},{default:l(()=>[a(s(ge),{filterable:"",multiple:"",value:i.contractIds,"onUpdate:value":t[1]||(t[1]=c=>i.contractIds=c),placeholder:"请选择合同","label-field":"contractname","value-field":"id",options:s(Ke).data,onScroll:Mt},null,8,["value","options"])]),_:1})):We("",!0),r.operateType==="edit"?(te(),ve(n,{key:1,span:"24 s:12 m:12",label:"项目状态",path:"status"},{default:l(()=>[a(s(ge),{filterable:"",value:i.status,"onUpdate:value":t[2]||(t[2]=c=>i.status=c),placeholder:"请选择项目状态",options:s(xe)(s(k).userInfo.usertype==0||s(k).userInfo.usertype==2?s(tt):s(Fa))},null,8,["value","options"])]),_:1})):We("",!0),a(n,{span:"24 s:12 m:12",label:"调度名称",path:"dispatch"},{default:l(()=>[a(s($),{clearable:"",value:i.dispatch,"onUpdate:value":t[3]||(t[3]=c=>i.dispatch=c),placeholder:"请输入调度名称"},null,8,["value"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"调试类型",path:"dtype"},{default:l(()=>[a(s(ge),{filterable:"",value:i.dtype,"onUpdate:value":t[4]||(t[4]=c=>i.dtype=c),placeholder:"请选择调试类型",options:s(xe)(s(Dt))},null,8,["value","options"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"周期（天）",path:"period"},{default:l(()=>[a(s(ct),{clearable:"",value:i.period,"onUpdate:value":t[5]||(t[5]=c=>i.period=c),style:{width:"100%"},placeholder:"请输入周期"},null,8,["value"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"项目地点",path:"prosite"},{default:l(()=>[a(h,{onClick:At},{default:l(()=>[a(s($),{value:i.prosite,"onUpdate:value":t[6]||(t[6]=c=>i.prosite=c),placeholder:"请输入项目地点"},null,8,["value"]),a(s(g),null,{icon:l(()=>[a(f,{class:"text-icon"})]),_:1})]),_:1})]),_:1}),a(n,{span:"24 s:12 m:12",label:"选择调度",path:"dispatchIds"},{default:l(()=>[a(s(ge),{filterable:"",multiple:"",value:i.dispatchIds,"onUpdate:value":t[7]||(t[7]=c=>i.dispatchIds=c),placeholder:"请选择所属项目","label-field":"dname","value-field":"id",options:ot.value},null,8,["value","options"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"项目详细地址",path:"proaddr"},{default:l(()=>[a(s($),{type:"textarea",rows:1,clearable:"",value:i.proaddr,"onUpdate:value":t[8]||(t[8]=c=>i.proaddr=c),placeholder:"请输入项目详细地址"},null,8,["value"])]),_:1}),a(n,{span:"24 s:12 m:24",path:"contactList"},{default:l(()=>[H("div",qa,[a(s(le),{align:"center",style:{"margin-bottom":"10px"}},{default:l(()=>[t[13]||(t[13]=H("span",null,"项目联系人",-1)),a(s(g),{size:"small",ghost:"",type:"primary",onClick:ue},{icon:l(()=>[a(b,{class:"text-icon"})]),default:l(()=>[t[12]||(t[12]=_(" 添加项目联系人 "))]),_:1,__:[12]})]),_:1,__:[13]}),a(N,{columns:E,"paginate-single-page":!1,data:v.value,pagination:O,"max-height":350},null,8,["data","pagination"])])]),_:1}),a(n,{span:"24 s:12 m:24",path:"debuggedDevieceList"},{default:l(()=>[H("div",Ga,[a(s(le),{align:"center",style:{"margin-bottom":"10px"}},{default:l(()=>[t[15]||(t[15]=H("span",null,"待调试设备",-1)),a(s(g),{size:"small",ghost:"",type:"primary",onClick:ze},{icon:l(()=>[a(b,{class:"text-icon"})]),default:l(()=>[t[14]||(t[14]=_(" 添加待调试设备 "))]),_:1,__:[14]})]),_:1,__:[15]}),a(N,{columns:Le,"paginate-single-page":!1,data:p.value,pagination:S,"max-height":350},null,8,["data","pagination"])])]),_:1}),a(n,{span:"24 s:12 m:24"},{default:l(()=>[H("div",Ka,[a(s(le),{align:"center",style:{"margin-bottom":"10px"}},{default:l(()=>[t[17]||(t[17]=H("span",null,"图纸",-1)),a(s(g),{size:"small",ghost:"",type:"primary",onClick:Me},{icon:l(()=>[a(b,{class:"text-icon"})]),default:l(()=>[t[16]||(t[16]=_(" 添加图纸 "))]),_:1,__:[16]})]),_:1,__:[17]}),u.value.length>0?(te(),ve(N,{key:0,columns:ce,data:u.value,size:"small","scroll-x":702,"row-key":c=>c.id,"max-height":350},null,8,["data","row-key"])):We("",!0)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"]),a(fe,{show:Se.value,"onUpdate:show":t[11]||(t[11]=c=>Se.value=c),title:"选择项目位置",preset:"card",class:"w-800px"},{footer:l(()=>[a(s(le),{justify:"end",size:16},{default:l(()=>[a(s(g),{onClick:z},{default:l(()=>[_(ie(s(j)("common.cancel")),1)]),_:1}),a(s(g),{type:"primary",onClick:Ft},{default:l(()=>[_(ie(s(j)("common.confirm")),1)]),_:1})]),_:1})]),default:l(()=>[a(Q,{value:ne.value,"onUpdate:value":[t[10]||(t[10]=c=>ne.value=c),jt],options:qe.value,placeholder:"请输入地点关键字",clearable:"",onSelect:Tt},null,8,["value","options"]),H("div",{ref_key:"domRef",ref:Je,class:"h-full w-full",style:{width:"100%",height:"500px","margin-top":"10px"}},null,512)]),_:1},8,["show"])],64)}}}),Wa=Fe({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:$e(["reset","search"],["update:model"]),setup(U,{emit:W}){ha();const k=W,{formRef:J,restoreValidation:A}=_t(),r=Ye(U,"model"),i={当日:()=>{const m=new Date().getTime();return[m,m]},本周:()=>{const m=new Date().getTime();return[m-24*60*60*1e3*7,m]},上月:()=>{const m=new Date().getTime();return[m-24*60*60*1e3*30,m]},近一年:()=>{const m=new Date().getTime();return[m-24*60*60*1e3*365,m]},近三年:()=>{const m=new Date().getTime();return[m-24*60*60*1e3*365*3,m]}};function X(){r.value.fuzzy="",k("search")}async function x(m,w){if(!m){r.value.startTime=void 0,r.value.endTime=void 0,k("search");return}r.value.startTime=String(vt(1,w[0])),r.value.endTime=String(vt(1,w[1])),k("search")}async function q(){r.value.startTime=void 0,r.value.endTime=void 0,r.value.startAndTimeRange=null,r.value.fuzzy="",r.value.status=null,r.value.ptype=null,r.value.dtype=null,await A(),k("reset")}async function F(){k("search")}return(m,w)=>{const oe=$,L=zt,v=ge,O=Va,E=Ba,y=g,T=Ra,Y=le,re=xt,ue=St,p=et;return te(),ve(p,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[a(ue,{ref_key:"formRef",ref:J,model:r.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:kt(F,["enter"])},{default:l(()=>[a(re,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:l(()=>[a(L,{span:"24 s:12 m:6",label:"项目名称",path:"fuzzy"},{default:l(()=>[a(oe,{clearable:"",value:r.value.fuzzy,"onUpdate:value":w[0]||(w[0]=S=>r.value.fuzzy=S),placeholder:"请输入项目名称",onClear:X},null,8,["value"])]),_:1}),a(L,{span:"24 s:12 m:6",label:"项目状态",path:"status"},{default:l(()=>[a(v,{clearable:"",filterable:"",value:r.value.status,"onUpdate:value":[w[1]||(w[1]=S=>r.value.status=S),F],placeholder:"请选择项目状态",options:s(xe)(s(tt))},null,8,["value","options"])]),_:1}),a(L,{span:"24 s:12 m:6",label:"进度状态",path:"ptype"},{default:l(()=>[a(v,{clearable:"",filterable:"",value:r.value.ptype,"onUpdate:value":[w[2]||(w[2]=S=>r.value.ptype=S),F],placeholder:"请选择进度状态",options:[{label:"正常",value:0},{label:"已延期",value:1}]},null,8,["value"])]),_:1}),a(L,{span:"24 s:12 m:6",label:"调试类型",path:"dtype"},{default:l(()=>[a(v,{clearable:"",filterable:"",value:r.value.dtype,"onUpdate:value":[w[3]||(w[3]=S=>r.value.dtype=S),F],placeholder:"请选择调试类型",options:s(xe)(s(Dt))},null,8,["value","options"])]),_:1}),a(L,{span:"24 s:12 m:8",label:"起止时间"},{default:l(()=>[a(O,{value:r.value.startAndTimeRange,"onUpdate:value":w[4]||(w[4]=S=>r.value.startAndTimeRange=S),type:"datetimerange",clearable:"",shortcuts:i,"onUpdate:formattedValue":x},null,8,["value"])]),_:1}),a(L,{span:"24  s:12 m:6",class:"pr-24px"},{default:l(()=>[a(Y,{class:"w-full"},{default:l(()=>[a(y,{onClick:q},{icon:l(()=>[a(E,{class:"text-icon"})]),default:l(()=>[_(" "+ie(s(j)("common.reset")),1)]),_:1}),a(y,{type:"primary",ghost:"",onClick:F},{icon:l(()=>[a(T,{class:"text-icon"})]),default:l(()=>[_(" "+ie(s(j)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Xa={class:"min-h-500px flex gap-16px"},Ya={class:"flex items-center justify-end gap-16px"},Qa=Fe({__name:"relatedContractLook",props:$e({id:{}},{visable:{type:Boolean},visableModifiers:{}}),emits:["update:visable"],setup(U){const W=U,k=Ye(U,"visable"),{columns:J,data:A,getData:r,loading:i,mobilePagination:X,searchParams:x}=Xe({apiFn:ya,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,id:W.id,_t:new Date().getTime()},columns:()=>[{key:"contractname",title:"合同",width:200,render:y=>a("div",{class:v.pids==y.id?"bg-#f1f1f1 cursor-pointer p-5px":"cursor-pointer p-5px",onClick:()=>O(y.id)},[a("div",{class:"flex"},[a("div",{class:"w-60px inline-block"},[_("名称：")]),y.contractname]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("编号：")]),_(" "),y.contractnum]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("联系人：")]),y.businesscon]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("联系方式：")]),y.businessinfo]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("注意事项：")]),y.precautions]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("备注：")]),y.notes])])}]}),{columns:q,data:F,getData:m,loading:w,pagination:oe,mobilePagination:L,searchParams:v}=Xe({apiFn:_a,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,pids:W.id,_t:new Date().getTime()},columns:()=>[{key:"devname",title:"设备名称",align:"center",width:200,ellipsis:{tooltip:!0}},{key:"devcount",title:"数量",align:"center",width:120},{key:"devmodel",title:"规格型号",align:"center",width:120,ellipsis:{tooltip:!0}},{key:"devunit",title:"单位",align:"center",width:120},{key:"devtype",title:"是否为我司设备",align:"center",width:120,render:y=>y.devtype==0?a(Ue,{type:"success"},{default:()=>[_("是")]}):a(Ue,{type:"info"},{default:()=>[_("否")]})},{key:"devmanu",title:"设备厂家",align:"center",width:120},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"创建人",align:"center",width:120},{key:"dbtime",title:"创建时间",align:"center",width:180}]}),O=y=>{v.pids=y,m()},E=()=>{k.value=!1};return Qe(()=>k.value,async y=>{var T;y&&(x.id=W.id,F.value=[],oe.itemCount=0,await r(),v.pids=(T=A.value[0])==null?void 0:T.id,v.pids&&m())}),(y,T)=>{const Y=Ze,re=et,ue=wt;return te(),ve(ue,{show:k.value,"onUpdate:show":T[0]||(T[0]=p=>k.value=p),preset:"card",class:"w-1400px",title:"项目关联的合同"},{footer:l(()=>[H("div",Ya,[a(s(g),{type:"primary",size:"small",onClick:E},{default:l(()=>T[1]||(T[1]=[_(" 关闭 ")])),_:1,__:[1]})])]),default:l(()=>[H("div",Xa,[a(Y,{class:"left",columns:s(J),data:s(A),"paginate-single-page":!1,size:"small",remote:"",loading:s(i),pagination:s(X),"row-key":p=>p.id,"max-height":600},null,8,["columns","data","loading","pagination","row-key"]),a(re,{bordered:!1,size:"small",title:"设备",class:"w-1100px"},{default:l(()=>[a(Y,{style:{width:"100%"},columns:s(q),data:s(F),size:"small","max-height":600,loading:s(w),remote:"","scroll-x":s(q).reduce((p,S)=>p+(S.width||100),0),"paginate-single-page":!1,pagination:s(L),"row-key":p=>p.id},null,8,["columns","data","loading","scroll-x","pagination","row-key"])]),_:1})])]),_:1},8,["show"])}}}),Za=ba(Qa,[["__scopeId","data-v-a53f455a"]]),en={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function ht(U){return typeof U=="function"||Object.prototype.toString.call(U)==="[object Object]"&&!Ia(U)}const bn=Fe({name:"projectmanagement_projectlist",__name:"index",setup(U){const W=Sa(),k=yt(),J=ka(),A=wa(),{columns:r,columnChecks:i,data:X,getData:x,loading:q,mobilePagination:F,searchParams:m}=Xe({showTotal:!0,apiFn:Na,apiParams:{page:1,pageSize:20,limit:20,status:null,startAndTimeRange:null,startTime:null,endTime:null,creater:void 0,fuzzy:"",_t:new Date().getTime()},immediate:!1,columns:()=>[{type:"selection",align:"center",width:48},{key:"proname",title:"项目名称",align:"center",width:240},{key:"progess",title:"项目进度",align:"center",width:140,render:o=>a(Pa,{type:"line",showIndicator:!0,percentage:o.progess,"indicator-placement":"inside",processing:!0,color:"#1890ff"},null)},{key:"status",title:"项目状态",align:"center",width:120,defaultFilterOptionValue:null,filterOptions:xe(tt),filter:!0,filterMultiple:!1,render:o=>{if(o.status===null)return null;const u=j(La[o.status]);return a("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",color:o.status===0?"#3498db":o.status===1?"#f39c12":o.status===2?"#f1c40f":"#2ecc71",borderRadius:"50%"}},[a("span",{style:{width:"10px",height:"10px",marginRight:"5px",backgroundColor:o.status===0?"#3498db":o.status===1?"#f39c12":o.status===2?"#f1c40f":"#2ecc71",borderRadius:"50%"}},null),a("span",null,[u])])}},{key:"cpdbtime",title:"预计完成日期",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"period",title:"周期",align:"center",width:100,render:o=>a("div",null,[o.period,_("天")])},{key:"ptype",title:"状态",align:"center",width:100,render:o=>a(Ue,{type:o.ptype===0?"success":"warning"},{default:()=>[o.ptype===0?"正常":"已延期"]})},{key:"dtype",title:"调试类型",align:"center",width:100,render:o=>{if(o.status===null)return null;const u=j(Oa[o.dtype]);return a(Ue,{type:"info"},ht(u)?u:{default:()=>[u]})}},{key:"username",title:"创建人",align:"center",width:100,ellipsis:{tooltip:!0}},{key:"dbtime",title:"创建时间",align:"center",width:180},{key:"operate",title:j("common.operate"),align:"center",width:320,fixed:"right",render:o=>{let u;return a("div",{class:"flex justify-end gap-8px"},[o.status==0&&(k.userInfo.usertype==0||k.userInfo.usertype==2||k.userInfo.usertype==3)&&a(De,{onPositiveClick:()=>Y(o,1)},{default:()=>"确定启动项目吗？",trigger:()=>Ce(a(g,{type:"success",ghost:!0,size:"small"},{default:()=>["启动"]}),[[Ae("no-auth"),"project:Info:update"]])}),o.status==2&&(k.userInfo.usertype==0||k.userInfo.usertype==2)&&a(De,{onPositiveClick:()=>Y(o,3)},{default:()=>"是否确认执行审核操作？",trigger:()=>Ce(a(g,{type:"warning",ghost:!0,size:"small"},{default:()=>["审核"]}),[[Ae("no-auth"),"project:Info:update"]])}),a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>Ee(o)},{default:()=>["详情"]}),a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>Le(o)},{default:()=>["关联合同"]}),Ce(a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>re(o.id)},ht(u=j("common.edit"))?u:{default:()=>[u]}),[[Ae("no-auth"),"project:Info:update"]])])}}]}),{drawerVisible:w,operateType:oe,editingData:L,handleAdd:v,handleEdit:O,checkedRowKeys:E,onBatchDeleted:y}=ja(X,x);async function T(){console.log(E.value),ue(E.value.join(","),o=>{y()})}const Y=async(o,u)=>{var pe;const{data:de,error:ce}=await Ct([{id:o.id,status:u}]);ce||((pe=window.$message)==null||pe.success("操作成功"),x())};function re(o){O(o)}async function ue(o,u){const{data:de,error:ce}=await za(o);if(!ce)u&&u(de);else return!1}const p=P(!1),S=P(0),Le=o=>{p.value=!0,S.value=o.id},he=o=>{m.status=o.status,x()},ye=P(-1),Oe=o=>{o>0?(ye.value=o,m.creater=JSON.parse(JSON.stringify(o)),x()):(m.creater=void 0,ye.value=-1,x())},Ee=o=>{J.push("/projectmanagement/orderdetail?prjId="+o.id),k.setProjectInfo({pid:o.id,pname:o.proname})},ze=()=>{x()};return Ca(()=>{A.query.pname?(m.fuzzy=A.query.pname,m.status=2,ze()):x()}),Qe(()=>A.query.pname,o=>{o&&(m.fuzzy=o,x())}),(o,u)=>{const de=Ja,ce=xa,pe=le,Me=qt,Re=Jt,Be=Vt,me=Ze,Ve=et,R=Ae("no-auth");return te(),bt("div",en,[a(Wa,{model:s(m),"onUpdate:model":u[0]||(u[0]=z=>Te(m)?m.value=z:null),onReset:ze,onSearch:s(x)},null,8,["model","onSearch"]),a(Ve,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:l(()=>[a(pe,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:l(()=>[u[6]||(u[6]=H("div",null,"项目列表",-1)),a(ce,{size:"small",value:ye.value,"onUpdate:value":[u[1]||(u[1]=z=>ye.value=z),Oe],name:"radiobuttongroup1"},{default:l(()=>[a(de,{value:-1,label:"默认"}),a(de,{value:s(k).userInfo.id,label:"我创建的"},null,8,["value"])]),_:1},8,["value"])]),_:1,__:[6]})]),"header-extra":l(()=>[a(pe,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:l(()=>[Ce((te(),ve(s(g),{onClick:s(v),size:"small",ghost:"",type:"primary"},{icon:l(()=>[a(Me,{class:"text-icon"})]),default:l(()=>[u[7]||(u[7]=_(" "+ie("新增项目")))]),_:1,__:[7]},8,["onClick"])),[[R,"project:Info:insert"]]),a(s(De),{onPositiveClick:T},{trigger:l(()=>[Ce((te(),ve(s(g),{size:"small",ghost:"",type:"error",disabled:s(E).length==0},{icon:l(()=>[a(Re,{class:Da(["text-icon",{"animate-spin":s(q)}])},null,8,["class"])]),default:l(()=>[u[8]||(u[8]=_(" "+ie("批量删除")))]),_:1,__:[8]},8,["disabled"])),[[R,"project:Info:delete"]])]),default:l(()=>[u[9]||(u[9]=_(" 确定要删除选中的合同吗？ "))]),_:1,__:[9]}),a(Be,{columns:s(i),"onUpdate:columns":u[2]||(u[2]=z=>Te(i)?i.value=z:null)},null,8,["columns"])]),_:1})]),default:l(()=>[a(me,{"checked-row-keys":s(E),"onUpdate:checkedRowKeys":u[3]||(u[3]=z=>Te(E)?E.value=z:null),columns:s(r),data:s(X),size:"small","flex-height":!s(W).isMobile,"scroll-x":s(r).reduce((z,Ne)=>z+(Ne.width||100),0),loading:s(q),remote:"","row-key":z=>z.id,pagination:s(F),class:"sm:h-full","onUpdate:filters":he},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),a(Ha,{visible:s(w),"onUpdate:visible":u[4]||(u[4]=z=>Te(w)?w.value=z:null),onSubmitted:s(x),"operate-type":s(oe),"row-data":s(L)},null,8,["visible","onSubmitted","operate-type","row-data"]),a(Za,{visable:p.value,"onUpdate:visable":u[5]||(u[5]=z=>p.value=z),id:S.value},null,8,["visable","id"])]),_:1})])}}});export{bn as default};
