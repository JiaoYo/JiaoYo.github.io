import{_ as Pe}from"./table-column-setting.vue_vue_type_script_setup_true_lang-7c1PcpHz.js";import{_ as Be}from"./round-delete-CPUsZN4F.js";import{_ as Le}from"./round-add-DM4opCm7.js";import{d as ve,av as me,z as be,D as Re,s as N,aK as ke,A as Ce,a as Ie,ax as xe,at as Fe,c as G,o as D,w as t,f as e,a3 as Me,b as oe,G as ge,M as ze,h as o,au as De,H as B,aP as qe,a$ as Ee,e as se,t as S,aA as Oe,J as _e,B as L,g as U,$ as R,a4 as Ve,cC as Ne,aE as Se,aG as Ae,db as Ge,dc as Ke,az as He,L as Je,a2 as je,aJ as Qe,i as We,F as fe,aL as ce,ay as Xe,I as de,aM as Ye,dd as he,de as Ze,aR as ea}from"./index-CYM7WsrU.js";import{u as aa,a as ta}from"./table-DBhYnjkY.js";import{u as Te}from"./usePageData-DZmITRE8.js";import{_ as $e}from"./Grid-XBh6Ijop.js";import{_ as Ue}from"./FormItemGridItem-DU6pdzl5.js";import{_ as na}from"./round-search-zdbG5kkR.js";import{_ as la}from"./round-refresh-vzWe8w_x.js";import{N as ye}from"./Popconfirm-C8JWPuCK.js";const oa={key:0,style:{"margin-left":"20px"}},sa=["onClick"],ra=["onClick"],ia={key:0},ua={style:{display:"flex","justify-content":"space-between"}},ca=ve({name:"OperateDrawer",__name:"operate-drawer",props:me({operateType:{},rowData:{},pid:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:me(["submitted"],["update:visible"]),setup(j,{emit:K}){const x=K,I=be(),b=j,a=Re(z());function z(){return{pid:void 0,id:"",affectedbusiness:"",devname:"",apidocument:"",uid:void 0,period:"",notes:"",re1:"",re2:"",re3:"",re4:"",fl1:"",fl2:"",fl3:"",fl4:""}}const f=N([]),{pageData:_,getData:g,nextPage:F}=Te(Ne),H=async n=>{const l=n.currentTarget,p=l.scrollTop;l.scrollTop+l.offsetHeight>=l.scrollHeight&&_.data.length<_.total&&(await F(),f.value=_.data,await Se(),setTimeout(()=>{l.scrollTop=p}))},J=async()=>{var n;await g({fuzzy:I.userInfo.pname,page:1}),f.value=_.data,a.pid=b.pid?b.pid:(n=f.value[0])==null?void 0:n.id},Q=ke.debounce(async n=>{await g({fuzzy:n,page:1}),f.value=_.data},300),T=N(!1),y=N(!1),W=n=>{if(a.pid=null,T.value=!0,y.value=!1,!n){M();return}Q(n)},X=async()=>{T.value&&!y.value&&(await g({page:1}),f.value=_.data,T.value=!1)},M=async()=>{await g({page:1}),f.value=_.data},re=async n=>{a.pid=n,y.value=!0};async function Y(){if(J(),Object.assign(a,z()),m.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}],b.operateType==="edit"&&b.rowData){Object.assign(a,b.rowData),m.value=[];for(let n=1;n<=4;n++){const l=a[`re${n}`],p=a[`fl${n}`];m.value.push({name:l||"",url:p||"",status:p?"finished":"pending"})}}}const{formRef:Z,validate:V,restoreValidation:u}=Ce(),i={pid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择"},affectedbusiness:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},devname:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},apidocument:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},period:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},uid:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"}},d=Ie(()=>({add:"新增需要开发",edit:"修改需要开发"})[b.operateType]),s=xe(j,"visible");async function w(n){if(n)try{const p=await(await fetch(n==null?void 0:n.split("?")[0],{mode:"cors"})).blob(),E=URL.createObjectURL(p),k=document.createElement("a");k.href=E,k.download=n==null?void 0:n.split("?")[1],k.style.display="none",document.body.appendChild(k),k.click(),document.body.removeChild(k),URL.revokeObjectURL(E)}catch(l){console.error("下载失败:",l)}}Fe(s,()=>{s.value&&(Y(),setTimeout(()=>{const n=document.querySelector(".n-scrollbar-content");n==null||n.scrollTo(0,0)},300),u())});const $=N(!1),C=N(0),m=N([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]);async function ee({file:n},l){m.value[l].file=n,m.value[l].name=n.name}function q(){s.value=!1}async function A(n){var l;return n.file.file.size>100*1024*1024?((l=window.$message)==null||l.error("文件大小不能超过100M"),!1):!0}const h=N(!1);async function ae(){var n,l,p,E;if(!h.value)try{await V(),h.value=!0;let k=!0;if(m.value.forEach((v,c)=>{var ne,le;const te=`re${c+1}`,r=`fl${c+1}`,O=v.name||"",P=((ne=v.url)==null?void 0:ne.split("?")[1])||((le=v.file)==null?void 0:le.name);(O&&!P||!O&&P)&&(k=!1),v.status==="done"&&(a[te]=O,a[r]=P)}),!k){(l=(n=window.$message)==null?void 0:n.error)==null||l.call(n,"文件名称和文件地址必须同时存在，不能只填一个");return}$.value=!0;const ie=m.value.filter(v=>v.file),ue=ie.length;for(let v=0;v<ue;v++){C.value=v;const c=ie[v];c.indexText=`${v+1}/${ue}`,c.progress=0,c.status="uploading";try{c.url=await Ae(c.file.file,c.file.name,"",te=>{c.progress=te}),c.progress=100,c.status="done"}catch{c.status="error"}}if(m.value.forEach((v,c)=>{a[`re${c+1}`]=v.name||"",a[`fl${c+1}`]=v.url||""}),$.value=!1,b.operateType==="edit"){const{data:v,error:c}=await Ge([a]);c||(q(),x("submitted"),(p=window.$message)==null||p.success("修改成功"))}else{const{data:v,error:c}=await Ke([{...a}]);c||(q(),x("submitted"),(E=window.$message)==null||E.success("添加成功"))}}catch{}finally{h.value=!1}}return(n,l)=>{const p=Ue,E=He,k=$e,ie=ze,ue=Oe,v=Me,c=_e,te=Ve;return D(),G(te,{show:s.value,"onUpdate:show":l[7]||(l[7]=r=>s.value=r),title:d.value,preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{footer:t(()=>[e(c,{justify:"end",size:16},{default:t(()=>[e(o(L),{onClick:q},{default:t(()=>[U(S(o(R)("common.cancel")),1)]),_:1}),e(o(L),{type:"primary",onClick:ae,loading:h.value},{default:t(()=>[U(S(o(R)("common.confirm")),1)]),_:1},8,["loading"])]),_:1})]),default:t(()=>[e(v,{class:"pr-20px"},{default:t(()=>[e(ie,{ref_key:"formRef",ref:Z,model:a,rules:i,"label-placement":"left","label-width":120},{default:t(()=>[e(k,{responsive:"screen","item-responsive":""},{default:t(()=>[e(p,{span:"24 m:12",label:"项目列表",path:"pid"},{default:t(()=>[e(o(De),{clearable:"",filterable:"",value:a.pid,"onUpdate:value":[l[0]||(l[0]=r=>a.pid=r),re],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:M,onSearch:W,onBlur:X,options:f.value,onScroll:H},null,8,["value","options"])]),_:1}),e(p,{span:"24 m:12",label:"影响的业务",path:"affectedbusiness"},{default:t(()=>[e(o(B),{value:a.affectedbusiness,"onUpdate:value":l[1]||(l[1]=r=>a.affectedbusiness=r),placeholder:"请输入"},null,8,["value"])]),_:1}),e(p,{span:"24 m:12",label:"设备名称",path:"devname"},{default:t(()=>[e(o(B),{value:a.devname,"onUpdate:value":l[2]||(l[2]=r=>a.devname=r),placeholder:"请输入"},null,8,["value"])]),_:1}),e(p,{span:"24 m:12",label:"接口文档",path:"apidocument"},{default:t(()=>[e(o(B),{value:a.apidocument,"onUpdate:value":l[3]||(l[3]=r=>a.apidocument=r),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),e(p,{span:"24 m:12",label:"研发对接人",path:"uid"},{default:t(()=>[e(o(B),{value:a.uid,"onUpdate:value":l[4]||(l[4]=r=>a.uid=r),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),e(p,{span:"24 m:12",label:"研发周期",path:"period"},{default:t(()=>[e(o(B),{value:a.period,"onUpdate:value":l[5]||(l[5]=r=>a.period=r),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),e(p,{span:"24 m:12",label:"备注",path:"notes"},{default:t(()=>[e(o(B),{value:a.notes,"onUpdate:value":l[6]||(l[6]=r=>a.notes=r),placeholder:"请输入"},null,8,["value"])]),_:1}),(D(!0),oe(qe,null,Ee(m.value,(r,O)=>(D(),G(p,{span:"24 m:24",label:"",path:"notes","show-feedback":!1,key:O},{default:t(()=>[e(k,{responsive:"screen","item-responsive":""},{default:t(()=>[e(p,{span:"24 m:12",label:`附件${O+1}`,path:"notes"},{default:t(()=>[e(o(B),{value:r.name,"onUpdate:value":P=>r.name=P,placeholder:"请输入",style:{width:"250px"}},null,8,["value","onUpdate:value"])]),_:2},1032,["label"]),e(p,{span:"24 m:12",label:"",path:"notes"},{default:t(()=>{var P,ne,le;return[(P=r.url)!=null&&P.split("?")[1]||(ne=r.file)!=null&&ne.name?(D(),oe("span",oa,[U(S(((le=r.url)==null?void 0:le.split("?")[1])||r.file.name)+" ",1),se("span",{class:"cursor-pointer c-#c92a2a",onClick:pe=>{r.url="",r.file=void 0,r.name=""}},"删除",8,sa),r.url?(D(),oe("span",{key:0,class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:pe=>w(r.url)},"下载",8,ra)):ge("",!0)])):(D(),G(E,{key:1,style:{width:"auto","margin-left":"20px"},ref_for:!0,ref:"uploadRef",action:"#","custom-request":pe=>ee(pe,O),"show-file-list":!1,onBeforeUpload:A},{default:t(()=>[e(o(L),{size:"small",ghost:"",type:"primary"},{default:t(()=>l[8]||(l[8]=[U(S("选择文件"))])),_:1,__:[8]})]),_:2},1032,["custom-request"]))]}),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1},8,["model"]),m.value[C.value]&&$.value?(D(),oe("div",ia,[se("div",ua,[se("span",null,S(m.value[C.value].filename||m.value[C.value].name),1),se("span",null,S(m.value[C.value].indexText),1)]),e(ue,{percentage:m.value[C.value].progress,status:m.value[C.value].status==="error"?"error":"success","show-indicator":""},null,8,["percentage","status"])])):ge("",!0)]),_:1})]),_:1},8,["show","title"])}}}),da=ve({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:me(["reset","search","clear"],["update:model"]),setup(j,{emit:K}){const x=K,{formRef:I,restoreValidation:b}=Ce(),a=xe(j,"model"),z=be(),f=N([]),{pageData:_,getData:g,nextPage:F}=Te(Ne),H=async u=>{const i=u.currentTarget,d=i.scrollTop;i.scrollTop+i.offsetHeight>=i.scrollHeight&&_.data.length<_.total&&(await F(),f.value=_.data,await Se(),setTimeout(()=>{i.scrollTop=d}))},J=async u=>{var i;y.value=!0,u?(a.value.pid=u,x("search"),z.setProjectInfo({pname:(i=f.value.find(d=>d.id==u))==null?void 0:i.proname,pid:u})):x("clear")},Q=ke.debounce(async u=>{await g({fuzzy:u,page:1}),f.value=_.data},300),T=N(!1),y=N(!1),W=u=>{if(a.value.pid=null,T.value=!0,y.value=!1,!u){M();return}Q(u)},X=async()=>{T.value&&!y.value&&(await g({page:1}),f.value=_.data,T.value=!1)},M=async()=>{await g({page:1}),f.value=_.data};(async()=>{var u,i;await g({fuzzy:z.userInfo.pname}),f.value=_.data,a.value.pid=z.userInfo.pid?z.userInfo.pid:(u=f.value[0])==null?void 0:u.id,a.value.pid&&(z.setProjectInfo({pid:a.value.pid,pname:(i=f.value.find(d=>d.id==a.value.pid))==null?void 0:i.proname}),x("search"))})();async function Y(){await b(),a.value.fuzzy="",x("reset")}const Z=()=>{a.value.fuzzy="",x("search")};async function V(){var u,i;a.value.pid?x("search"):((u=window.$message)==null||u.destroyAll(),(i=window.$message)==null||i.warning("请选择项目"))}return(u,i)=>{const d=De,s=Ue,w=B,$=la,C=L,m=na,ee=_e,q=$e,A=ze,h=je;return D(),G(h,{bordered:!1,size:"small",class:"card-wrapper"},{default:t(()=>[e(A,{ref_key:"formRef",ref:I,model:a.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Je(V,["enter"])},{default:t(()=>[e(q,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:t(()=>[e(s,{span:"24 s:12 m:6",label:"项目列表",path:"PrjId"},{default:t(()=>[e(d,{filterable:"",clearable:"",value:a.value.pid,"onUpdate:value":[i[0]||(i[0]=ae=>a.value.pid=ae),J],placeholder:"请选择项目","label-field":"proname","value-field":"id",options:f.value,onScroll:H,onClear:M,onSearch:W,onBlur:X},null,8,["value","options"])]),_:1}),e(s,{span:"24 s:12 m:6",label:"设备名称",path:"fuzzy"},{default:t(()=>[e(w,{value:a.value.fuzzy,"onUpdate:value":i[1]||(i[1]=ae=>a.value.fuzzy=ae),placeholder:"请输入",clearable:"",onClear:Z},null,8,["value"])]),_:1}),e(s,{span:"24  s:12 m:6",class:"pr-24px"},{default:t(()=>[e(ee,{class:"w-full"},{default:t(()=>[e(C,{onClick:Y},{icon:t(()=>[e($,{class:"text-icon"})]),default:t(()=>[U(" "+S(o(R)("common.reset")),1)]),_:1}),e(C,{type:"primary",ghost:"",onClick:V},{icon:t(()=>[e(m,{class:"text-icon"})]),default:t(()=>[U(" "+S(o(R)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),pa={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function we(j){return typeof j=="function"||Object.prototype.toString.call(j)==="[object Object]"&&!ea(j)}const xa=ve({name:"projectmanagement_need",__name:"index",setup(j){const K=Qe(),{columns:x,columnChecks:I,data:b,getData:a,loading:z,pagination:f,mobilePagination:_,searchParams:g}=aa({showTotal:!0,immediate:!1,apiFn:Ze,apiParams:{page:1,pageSize:20,limit:20,fuzzy:"",_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"affectedbusiness",title:"影响的业务",align:"center",width:120},{key:"devname",title:"设备名称",align:"center",width:120},{key:"apidocument",title:"接口文档",align:"center",width:120},{key:"uid",title:"研发对接人",align:"center",width:120},{key:"period",title:"研发周期",align:"center",width:120},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"操作人",align:"center",width:120},{key:"dbtime",title:"操作时间",align:"center",width:120},{key:"operate",title:R("common.operate"),align:"center",width:140,fixed:"right",render:d=>{let s;return e("div",{class:"flex-center gap-8px"},[de(e(L,{type:"primary",ghost:!0,size:"small",onClick:()=>Y(d.id)},we(s=R("common.edit"))?s:{default:()=>[s]}),[[fe("no-auth"),"project:Development:update"]]),e(ye,{onPositiveClick:()=>re(d.id)},{default:()=>R("common.confirmDelete"),trigger:()=>{let w;return de(e(L,{type:"error",ghost:!0,size:"small"},we(w=R("common.delete"))?w:{default:()=>[w]}),[[fe("no-auth"),"project:Development:delete"]])}})])}}]}),{drawerVisible:F,operateType:H,editingData:J,handleAdd:Q,handleEdit:T,checkedRowKeys:y,onBatchDeleted:W,onDeleted:X}=ta(b,a);We(async()=>{});async function M(){console.log(y.value),Z(y.value.join(","),d=>{W()})}async function re(d){const{data:s,error:w}=await he(d,g.pid);w||X()}function Y(d){T(d)}async function Z(d,s){const{data:w,error:$}=await he(d,g.pid);if(!$)s&&s(w);else return!1}const V=d=>{a()},u=()=>{b.value=[],f.itemCount=0},i=()=>{a()};return(d,s)=>{const w=_e,$=Le,C=Be,m=Pe,ee=Xe,q=je,A=fe("no-auth");return D(),oe("div",pa,[e(da,{model:o(g),"onUpdate:model":s[0]||(s[0]=h=>ce(g)?g.value=h:null),onReset:i,onSearch:o(a),onClear:u},null,8,["model","onSearch"]),e(q,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:t(()=>[e(w,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:t(()=>s[4]||(s[4]=[se("div",null,"需要开发",-1)])),_:1,__:[4]})]),"header-extra":t(()=>[e(w,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:t(()=>[de((D(),G(o(L),{onClick:o(Q),size:"small",ghost:"",type:"primary"},{icon:t(()=>[e($,{class:"text-icon"})]),default:t(()=>[s[5]||(s[5]=U(" "+S("新增")))]),_:1,__:[5]},8,["onClick"])),[[A,"project:Development:insert"]]),e(o(ye),{onPositiveClick:M},{trigger:t(()=>[de((D(),G(o(L),{size:"small",ghost:"",type:"error",disabled:o(y).length==0},{icon:t(()=>[e(C,{class:Ye(["text-icon",{"animate-spin":o(z)}])},null,8,["class"])]),default:t(()=>[s[6]||(s[6]=U(" "+S("批量删除")))]),_:1,__:[6]},8,["disabled"])),[[A,"project:Development:delete"]])]),default:t(()=>[s[7]||(s[7]=U(" 确定要删除选中的吗？ "))]),_:1,__:[7]}),e(m,{columns:o(I),"onUpdate:columns":s[1]||(s[1]=h=>ce(I)?I.value=h:null),ctype:12},null,8,["columns"])]),_:1})]),default:t(()=>[e(ee,{"checked-row-keys":o(y),"onUpdate:checkedRowKeys":s[2]||(s[2]=h=>ce(y)?y.value=h:null),columns:o(x),data:o(b),size:"small","flex-height":!o(K).isMobile,loading:o(z),remote:"","row-key":h=>h.id,pagination:o(_),class:"sm:h-full","onUpdate:filters":V},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),e(ca,{visible:o(F),"onUpdate:visible":s[3]||(s[3]=h=>ce(F)?F.value=h:null),onSubmitted:o(a),pid:o(g).pid,"operate-type":o(H),"row-data":o(J)},null,8,["visible","onSubmitted","pid","operate-type","row-data"])]),_:1})])}}});export{xa as default};
