import{_ as $a}from"./table-column-setting.vue_vue_type_script_setup_true_lang-Dg__PXp0.js";import{_ as Ht}from"./round-delete-CojfW_rY.js";import{_ as Na}from"./round-add-CcJ-eWvp.js";import{d as ot,aE as tt,m as Yt,r as Te,H as h,n as Zt,$ as z,ae as r,x as Z,b2 as at,B as g,cA as La,cr as Ua,cy as ja,cz as At,b8 as Ft,aD as Oe,aN as Tt,f as a,g as v,cT as Aa,cU as Fa,cS as Ta,cP as Oa,a as Ea,aG as yt,aC as st,bY as Qt,b as et,o as N,U as Ot,bi as Ra,w as n,bg as Ma,C as Wt,A as Xt,c as R,s as fe,h as i,bh as Ve,e as F,I as Ba,cJ as Et,V as Va,z as de,aH as lt,t as J,a1 as ea,cR as ta,cF as aa,dT as Ja,aI as Rt,aJ as nt,dI as sa,dY as Mt,dZ as qa,d_ as Bt,d$ as Ga,cq as Ka,e0 as Ha,e1 as Ya,cQ as Za,dK as Vt,dF as Jt,aO as gt,dU as Qa,cX as Wa,cZ as Xa,dJ as es,cB as ts,cI as as,dL as ss,dG as ls,dH as ns,aQ as is,dE as os,dM as rs,e2 as us,bd as ds,Z as _t,aM as it,M as la,aS as cs,P as ps,O as fs,i as ms,b3 as gs,q as We,aT as Xe,cO as vs,y as Be,aU as hs,aK as ys,e3 as _s,aW as bs,cs as ks,aY as xs}from"./index-CbkGmsUT.js";import{u as ht,a as Cs}from"./table-CST65CZ1.js";import{_ as Ss}from"./round-plus-Cs7LS9FY.js";import{_ as ws,a as Ds,A as zs}from"./index-B_ZD-bqb.js";import{g as bt,h as Ps,i as na,p as qt,f as Is}from"./business-DAxKw-B3.js";import{u as Gt}from"./usePageData-CtVI6YRj.js";import{h as vt}from"./permission-WYQvwezt.js";import{N as ke}from"./Popconfirm-CfoHIMzd.js";import{N as $s}from"./Cascader-CrktSfnm.js";import{_ as ia}from"./Grid-CyaoSB-i.js";import{_ as oa}from"./FormItemGridItem-D8sOQ-r2.js";import{_ as Ns}from"./round-search-opoHbQsz.js";import{_ as Ls}from"./round-refresh-BzOWd9gI.js";import{_ as Us}from"./DatePicker-DuNimOXS.js";import{N as js}from"./RadioButton-CUo6Xoh2.js";const As={class:"w-100%"},Fs={class:"flex"},Ts={style:{display:"flex","flex-direction":"column",width:"100%"}},Os={class:"flex items-center"},Es={class:"w-100%"},Rs={class:"w-100px"},Ms={style:{display:"flex","flex-direction":"column"}},Bs={style:{display:"flex","flex-direction":"column"}},Vs={style:{display:"flex","flex-direction":"column"}},Js=ot({name:"OperateDrawer",__name:"operate-drawer",props:tt({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:tt(["submitted"],["update:visible"]),setup(Q,{emit:ne}){const _=Yt(),ie=ne,q=Te({contactList:[],debuggedDevieceList:[]}),p=Q,u=Te(ce());function ce(){return{proname:"",dispatchIds:[],contractIds:[],proaddr:"",cpdbtime:null,prosite:"",longitude:120.373885,latitude:30.303899,period:void 0,dtype:void 0,dispatch:"",status:1}}const U=h(0),oe=h(void 0);async function me(){w.value=[{longitude:120.373885,latitude:30.303899,addr:""}],Object.assign(u,ce()),Sa(),p.operateType==="edit"&&p.rowData&&(await Promise.all([Da(),Ee(),Le(),x(),kt(),Ze()]),Object.assign(u,p.rowData),U.value=u.period,oe.value=u.status,await $t(),Lt(u.proaddr||u.prosite),_a())}const{formRef:T,validate:G,restoreValidation:b}=Zt(),P={proname:{type:"string",required:!0,trigger:["blur","change"],message:"请输入项目名称"},status:{type:"number",required:!0,trigger:["blur","change"],message:"请选择项目状态"},contractIds:{type:"array",required:!0,trigger:["blur","change"],message:"请选择合同"},dtype:{type:"number",required:!0,trigger:["blur","change"],message:"请选择调试类型"},period:{type:"number",required:!0,trigger:["blur","change"],message:"请输入周期"},prosite:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请选择项目地点"},cpdbtime:{type:"string",required:!0,trigger:["blur","change"],message:"请选择时间"}},y=h([]),j=Te({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",pageSizes:[20],prefix:()=>`共 ${y.value.length} 条`,onChange:e=>{j.page=e,x()},onUpdatePageSize:e=>{j.pageSize=e,j.page=1,x()}}),O=[{title:"对接方",key:"docker",align:"center",width:150,render(e,t){return e.setStatus?r(Z,{value:e.docker,placeholder:"请输入",onUpdateValue(s){y.value[t].docker=s}}):r("div",{},e.docker)}},{title:"姓名",key:"pname",align:"center",width:100,render(e,t){return e.setStatus?r(Z,{value:e.pname,placeholder:"请输入姓名",onUpdateValue(s){y.value[t].pname=s}}):r("div",{},e.pname)}},{title:"联系方式",key:"pcontact",align:"center",width:150,render(e,t){return e.setStatus?r(Z,{value:e.pcontact,placeholder:"请输入联系方式",onUpdateValue(s){y.value[t].pcontact=s}}):r("div",{},e.pcontact)}},{title:"备注",key:"proposition",align:"center",width:150,render(e,t){return e.setStatus?r(Z,{value:e.proposition,placeholder:"请输入备注",onUpdateValue(s){y.value[t].proposition=s}}):r("div",{},e.proposition)}},{title:"操作人",width:100,key:"username",align:"center"},{title:"操作时间",key:"dbtime",width:180,align:"center",render:e=>e.dbtime?at(1,e.dbtime):""},{key:"operate",title:z("common.operate"),align:"center",width:160,fixed:"right",render(e,t){return r("div",{class:"flex-center gap-8px"},[e.setStatus?[r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>xe(e)},{default:()=>"保存"}),r(g,{type:"default",ghost:!0,size:"small",onClick:()=>te(e,t)},{default:()=>"取消"}),r(ke,{onPositiveClick:()=>{p.operateType==="edit"&&e.id?La(e.id).then(()=>{var s;y.value.splice(t,1),(s=window.$message)==null||s.success("删除成功")}):y.value.splice(t,1)}},{default:()=>z("common.confirmDelete"),trigger:()=>r(g,{type:"error",ghost:!0,size:"small"},{default:()=>z("common.delete")})})]:r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>K(e)},{default:()=>"编辑"})])}}],x=async()=>{var t;const{data:e}=await Ua({page:j.page,limit:j.pageSize,pid:(t=p.rowData)==null?void 0:t.id});y.value=e==null?void 0:e.list,y.value.forEach(s=>{s.setStatus=!1}),q.contactList=JSON.parse(JSON.stringify(y.value))},K=e=>{y.value.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus},te=(e,t)=>{e.setStatus=!e.setStatus,e.id?y.value=JSON.parse(JSON.stringify(q.contactList)):y.value.splice(t,1)},xe=async e=>{var t,s,o,d,c;if(!e.pname){(t=window.$message)==null||t.warning("请输入联系人姓名");return}if(!e.pcontact){(s=window.$message)==null||s.warning("请输入联系方式");return}if(p.operateType==="edit")if(e.id){const{data:D,error:k}=await ja([e]);k||((o=window.$message)==null||o.success("修改成功"),x(),e.setStatus=!e.setStatus)}else{const{data:D,error:k}=await At([{...e,pid:(d=p.rowData)==null?void 0:d.id}]);k||((c=window.$message)==null||c.success("添加成功"),x(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function Ce(){var e;((e=y.value[0])!=null&&e.pname||y.value.length==0)&&y.value.unshift({pname:"",pcontact:"",proposition:"",setStatus:!0})}const E=e=>{var t;u.contractIds=e,M.value=Ye.data.filter(s=>e.includes(s.id)).map(s=>({value:s.id,label:s.contractname,isLeaf:!1})),Se((t=M.value[0])==null?void 0:t.id)},M=h([]),Ee=async()=>{var s;const{data:e,error:t}=await ta({page:1,limit:100,id:p.rowData.id});M.value=e==null?void 0:e.list.map(o=>({value:o.id,label:o.contractname,isLeaf:!1})),Se((s=e==null?void 0:e.list[0])==null?void 0:s.id)},A=h([]),ge=h(),{pageData:re,getData:rt}=Gt(aa),Se=async e=>{await rt({pids:e}),ge.value=[],A.value=Array.from(new Set([...A.value,...re.data])),ge.value=re.data.map(t=>({label:t.devname,value:t.id}))},Je=async e=>{var t;await Se(e.value),e.children=(t=ge.value)==null?void 0:t.map(s=>({label:s.label,value:s.value,isLeaf:!0}))},C=h([]),I=Te({page:1,pageSize:20,itemCount:0,showSizePicker:!0,fuzzy:"",pageSizes:[10,20],prefix:()=>`共 ${I.itemCount} 条`,onChange:e=>{I.page=e,Le()},onUpdatePageSize:e=>{I.pageSize=e,I.page=1,Le()}}),Ie=h(),$e=[{title:"绑定合同设备",key:"cid",width:300,align:"center",render(e,t){var s,o;return e.setStatus?r($s,{style:"width: 270px",value:e.cid,filterable:!0,placeholder:"请选择合同设备",options:M.value,checkStrategy:"child",showPath:!1,remote:!0,renderSuffix:d=>d.option.hidden?null:d.node,renderLabel:d=>d.hidden?null:d.label,onLoad:Je,onUpdateValue(d){var D;C.value[t].cid=Number(d)||0;const c=(D=A.value)==null?void 0:D.find(k=>k.id==d);e.devname=(c==null?void 0:c.devname)||"",e.devnum=(c==null?void 0:c.devcount)||"",e.notes=(c==null?void 0:c.notes)||"",Ie.value=(c==null?void 0:c.devcount)||0,e.etype=(c==null?void 0:c.devtype)||0,e.devmanu=(c==null?void 0:c.devmanu)||"",e.devmodel=(c==null?void 0:c.devmodel)||"",e.devunit=(c==null?void 0:c.devunit)||""}}):r("div",{},e.devname2||((o=(s=ge.value)==null?void 0:s.find(d=>d.value==e.cid))==null?void 0:o.label))}},{title:"设备名称",key:"devname",width:200,align:"center",render(e,t){return e.setStatus?r(Z,{value:e.devname,placeholder:"请输入",onUpdateValue(s){C.value[t].devname=s}}):r("div",{},e.devname)}},{title:"型号",key:"devmodel",width:220,align:"center",render(e,t){return r("div",{},e.devmodel)}},{title:"设备单位",key:"devunit",width:120,align:"center",render(e,t){return r("div",{},e.devunit)}},{title:"数量",key:"devnum",width:100,align:"center",render(e,t){return e.setStatus?r(Ft,{value:e.devnum,placeholder:"请输入",max:Ie.value,onUpdateValue(s){C.value[t].devnum=s}}):r("div",{},e.devnum)}},{title:"是否为我司设备",key:"etype",width:260,align:"center",render(e,t){return r("div",{},e.etype==0?"是":"否")}},{title:"设备厂家",key:"devmanu",width:200,align:"center",render(e,t){return r("div",{},e.devmanu)}},{title:"清点状态",key:"status",width:120,align:"center",render(e,t){return e.setStatus&&e.id?r(Oe,{value:e.status,filterable:!0,placeholder:"请选择状态",options:[{label:"未清点",value:0},{label:"正常",value:1},{label:"增补",value:2},{label:"退货",value:3},{label:"换货",value:4}],onUpdateValue(s){C.value[t].status=Number(s)||0}}):r("div",{},e.status===0?"未清点":e.status===1?"正常":e.status===2?"增补":e.status===3?"退货":"换货")}},{title:"备注",key:"notes",width:200,align:"center",render(e,t){return r("div",{},e.notes)}},{title:"文件",key:"re1",width:160,align:"center",render(e,t){return e.setStatus?r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>ue(e,"debuggedDevieceList",t)},{default:()=>"上传文件"}):r(Tt,{trigger:"hover"},{trigger:()=>r("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const s=[{alias:e.re1,file:e.fl1},{alias:e.re2,file:e.fl2},{alias:e.re3,file:e.fl3},{alias:e.re4,file:e.fl4}].filter(o=>o.alias||o.file);return s.length===0?r("div",{style:"padding: 10px; color: #999;"},"暂无文件"):r("div",{style:"padding: 10px;"},[r("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[r("thead",[r("tr",[r("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),r("th",{style:"text-align:center; padding: 4px 8px;"},"文件"),r("th",{style:"text-align:center; padding: 4px 8px;"},"操作")])]),r("tbody",s.map((o,d)=>{var c;return r("tr",[r("td",{style:"text-align:center; padding: 4px 8px;"},o.alias||"-"),r("td",{style:"text-align:center; padding: 4px 8px;"},((c=o.file)==null?void 0:c.split("?")[1])||"-"),r("td",{style:"text-align:center; padding: 4px 8px;"},r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>xt({url:o.file})},{default:()=>"下载"}))])}))])])}})}},{title:"操作信息",key:"dbtime",width:180,align:"center",render(e,t){return r(Tt,{trigger:"hover"},{trigger:()=>r("div",{style:"color: #1890ff;cursor: pointer;"},e.dbtime?at(1,e.dbtime):""),default:()=>r("div",{style:"padding: 10px;"},a("div",null,[a("div",null,[v("操作人："),e.username]),a("div",null,[v("操作时间："),e.dbtime]),a("div",null,[v("清点人："),e.dusername]),a("div",null,[v("清点时间："),e.ddbtime])]))})}},{key:"operate",title:z("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return r("div",{class:"flex-center gap-8px"},[e.setStatus?[r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>ct(e)},{default:()=>"保存"}),r(g,{type:"default",ghost:!0,size:"small",onClick:()=>dt(e,t)},{default:()=>"取消"}),vt("project:Equipment:delete")&&r(ke,{onPositiveClick:async()=>{var s;if(e.id){const{data:o,error:d}=await Aa(e.id);o&&(C.value.splice(t,1),(s=window.$message)==null||s.success("删除成功"))}else C.value.splice(t,1)}},{default:()=>z("common.confirmDelete"),trigger:()=>r(g,{type:"error",ghost:!0,size:"small"},{default:()=>z("common.delete")})})]:vt("project:Equipment:update")&&r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>ut(e)},{default:()=>"编辑"})])}}],l=h([]),f=h(!1),B=h(""),ae=h(),ue=(e,t,s)=>{l.value=[],f.value=!0,B.value=t,ae.value=s,e.re1&&l.value.push({id:"",name:e.re1,url:e.fl1,status:"uploading",setStatus:!1,progress:0}),e.re2&&l.value.push({id:"",name:e.re2,url:e.fl2,status:"uploading",setStatus:!1,progress:0}),e.re3&&l.value.push({id:"",name:e.re3,url:e.fl3,status:"uploading",setStatus:!1,progress:0}),e.re4&&l.value.push({id:"",name:e.re4,url:e.fl4,status:"uploading",setStatus:!1,progress:0})},Ne=async()=>{var t,s;let e=!0;for(let o=0;o<l.value.length;o++){const d=l.value[o];if(!d.url){(t=window.$message)==null||t.warning(`第${o+1}个文件的文件名称不能为空`),e=!1;break}if(!d.name){(s=window.$message)==null||s.warning(`第${o+1}个文件的文件别名不能为空`),e=!1;break}C.value[ae.value][`re${o+1}`]=d.name,C.value[ae.value][`fl${o+1}`]=d.url}e&&(f.value=!1,B.value="",ae.value=void 0)},Le=async()=>{var t;const{data:e}=await Fa({page:I.page,limit:I.pageSize,fuzzy:I.fuzzy,pid:(t=p.rowData)==null?void 0:t.id});C.value=e.list,q.debuggedDevieceList=JSON.parse(JSON.stringify(C.value))},ut=async e=>{var o;console.log(re.data,e.cid,"ssssssssssssssss"),C.value.forEach(d=>{d.setStatus=!1});const{data:t,error:s}=await Ta(e.cid);s||(((o=M.value[M.value.length-1])==null?void 0:o.value)!=t.id&&M.value.push({value:t.id,label:t.devname,disabled:!0,isLeaf:!0,hidden:!0}),Ie.value=t.devcount||0),e.setStatus=!e.setStatus},dt=(e,t)=>{e.setStatus=!e.setStatus,e.id?C.value=JSON.parse(JSON.stringify(q.debuggedDevieceList)):C.value.splice(t,1)},ct=async e=>{var t,s,o,d,c;if(!e.cid){(t=window.$message)==null||t.warning("请选择合同设备");return}if(!e.devname){(s=window.$message)==null||s.warning("设备名称不能为空");return}if(!e.devmodel){(o=window.$message)==null||o.warning("设备型号不能为空");return}if(!e.devnum){(d=window.$message)==null||d.warning("设备数量不能为空");return}if(e.id){const{data:D,error:k}=await Oa([e]);k||((c=window.$message)==null||c.success("修改成功"),Le(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function pt(){var e;((e=C.value[0])!=null&&e.devname||C.value.length==0)&&C.value.unshift({status:void 0,devmanu:"",etype:0,devname:"",devmodel:"",devnum:0,notes:"",setStatus:!0})}const qe=()=>{f.value=!1},$=h({}),V=h([]);async function kt(){var t;V.value=[];const{data:e}=await Ja({page:1,limit:100,pid:(t=p.rowData)==null?void 0:t.id});e.list.forEach(s=>{s.sort==1&&V.value.push({id:s.id,name:s.filename,url:s.file,status:"finished",creator:s.username,dbtime:s.dbtime})}),V.value.reverse(),$.value=JSON.parse(JSON.stringify(e))}const ra=[{title:"文件别名",key:"name",align:"center",width:200,render(e){return e.setStatus?r(Z,{value:e.name,onUpdateValue:t=>{e.name=t}}):r("div",{},e.name)}},{title:"文件名称",key:"filename",align:"center",width:200,render(e){return e.setStatus&&!e.url?r("div",{style:"display: flex; justify-content: center; align-items: center;"},[r(Rt,{action:"#",showFileList:!1,customRequest:async({file:s,onFinish:o,onError:d})=>{var c,D;try{e.status=!0;const{data:k,error:H}=await us(s.file,se=>{e.progress=se});k&&(e.url=k,e.status=!1)}catch(k){console.error(k),(D=(c=window.$message)==null?void 0:c.error)==null||D.call(c,"文件上传出错"),e.status=!1}}},{default:()=>r(g,{type:"info",size:"small",ghost:!0,loading:e.status},{default:()=>"上传文件"})}),e.progress?r(nt,{type:"line",percentage:e.progress,indicatorPlacement:"inside",processing:!0}):null]):e.setStatus&&e.url&&!e.id?a("span",null,[e.url.split("?")[1],v(" "),a("span",{onClick:()=>{e.url="",e.progress=0},style:"color: red;cursor: pointer;font-size: 12px;"},[v("删除")])]):r("div",{},e.url.split("?")[1])}},{title:"上传人",key:"creator",align:"center",width:100,render(e){return r("div",{},e.creator)}},{title:"上传时间",key:"dbtime",align:"center",width:200,render(e){return r("div",{},e.dbtime?e.dbtime:"")}},{title:"操作",key:"actions",align:"center",width:180,render(e){return r(de,{justify:"center"},[!e.setStatus&&e.id&&r(g,{type:"info",size:"small",ghost:!0,onClick:()=>{xt(e)}},{default:()=>"下载"}),e.setStatus&&r(g,{type:"info",size:"small",ghost:!0,onClick:()=>{pa(e)}},{default:()=>"保存"}),e.setStatus&&r(g,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"取消"}),!e.setStatus&&r(g,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"编辑"}),vt("project:File:delete")&&(_.userInfo.usertype==0||_.userInfo.usertype==2)&&r(ke,{onPositiveClick:async()=>{var t;if(e.id){const{data:s,error:o}=await ls(e.url),{data:d,error:c}=await ns(e.id);c||(t=window.$message)==null||t.success("删除成功")}else V.value=V.value.filter(s=>s!==e)}},{default:()=>z("common.confirmDelete"),trigger:()=>r(g,{type:"error",ghost:!0,size:"small"},{default:()=>z("common.delete")})})])}}],ua=[{title:"文件名称",key:"filename",align:"center",render(e){if(!e.url){const t=async({file:o,onFinish:d,onError:c})=>{var D,k;try{e.status=!0;const H=await is(o.file,o.name,"",se=>{e.progress=se});H&&(e.url=H,e.name=o.name,e.status=!1)}catch(H){console.error(H),(k=(D=window.$message)==null?void 0:D.error)==null||k.call(D,"文件上传出错"),e.status=!1}};async function s(o){var d;return o.file.file.size>100*1024*1024?((d=window.$message)==null||d.error("文件大小不能超过100M"),!1):!0}return r("div",{style:"display: flex; justify-content: center; align-items: center;"},[r(Rt,{action:"#",showFileList:!1,customRequest:t,onBeforeUpload:s},{default:()=>r(g,{type:"info",size:"small",ghost:!0,loading:e.status},{default:()=>"上传文件"})}),e.progress?r(nt,{type:"line",percentage:e.progress,indicatorPlacement:"inside",processing:!0}):null])}return e.url&&!e.id?a("span",null,[e.url.split("?")[1],v(" "),a("span",{onClick:()=>{e.url="",e.progress=0,e.status=!1},style:"color: red;cursor: pointer;font-size: 12px;"},[v("删除")])]):r("div",{},e.url.split("?")[1])}},{title:"文件别名",key:"name",align:"center",render(e){return r(Z,{value:e.name,onUpdateValue:t=>{e.name=t}})}},{title:"操作",key:"actions",align:"center",width:100,render(e){return r(de,{justify:"center"},[r(g,{type:"error",size:"small",ghost:!0,onClick:()=>{l.value=l.value.filter(t=>t!==e)}},{default:()=>"删除"})])}}];async function xt(e){if(e!=null&&e.url)try{const s=await(await fetch(e.url.split("?")[0],{mode:"cors"})).blob(),o=URL.createObjectURL(s),d=document.createElement("a");d.href=o,d.download=e.url.split("?")[1],d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(o)}catch(t){console.error("下载失败:",t)}}const da=()=>{var e,t;if(l.value.length>=4)return(t=(e=window.$message)==null?void 0:e.warning)==null?void 0:t.call(e,"最多上传4个文件");l.value.push({id:"",name:"",url:"",status:!1,setStatus:!0,progress:0})},ca=()=>{V.value.push({id:"",name:"",url:"",status:!1,setStatus:!0})},pa=async e=>{var t,s,o,d,c,D,k,H,se,ze,Pe,_e;if(!e.name){(s=(t=window.$message)==null?void 0:t.warning)==null||s.call(t,"请输入文件别名");return}if(!e.url){(d=(o=window.$message)==null?void 0:o.warning)==null||d.call(o,"请上传文件");return}if((c=p.rowData)!=null&&c.id){const{data:W,error:m}=await Jt([{pid:(D=p.rowData)==null?void 0:D.id,filename:e.name,file:e.url,sort:1}]);if(m)return(k=window.$message)==null?void 0:k.error("保存文件记录失败");(H=window.$message)==null||H.destroyAll(),e.setStatus=!e.setStatus,kt(),(se=window.$message)==null||se.success("保存成功")}else if(e.id){const{data:W,error:m}=await os([{id:e.id,filename:e.name}]);if(m)return(ze=window.$message)==null?void 0:ze.error("保存文件记录失败");(Pe=window.$message)==null||Pe.destroyAll(),e.setStatus=!e.setStatus,(_e=window.$message)==null||_e.success("编辑成功")}else e.setStatus=!e.setStatus},fa=Ea(()=>({add:"新增项目",edit:"修改项目"})[p.operateType]),Ue=yt(Q,"visible");st(Ue,()=>{Ue.value&&(me(),setTimeout(()=>{const e=document.querySelector(".n-scrollbar-content");e==null||e.scrollTo(0,0)},300),b())});function ma(e){e||we()}function we(){Ue.value=!1}async function Ct(){var e;await G(),(e=window.$dialog)==null||e.info({title:"提示",content:"确定提交吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await ga()}})}async function ga(){var e,t,s,o,d,c,D,k,H,se,ze,Pe,_e;if(p.operateType==="edit"){const W=JSON.parse(JSON.stringify(u));U.value==W.period&&delete W.period,oe.value==W.status&&delete W.status;const{data:m,error:X}=await sa([W]);if(!X){let Y=function(pe,le){const ee=pe.filter(be=>!le.includes(be)),Ae=le.filter(be=>!pe.includes(be));return{toDelete:ee,toAdd:Ae}};if((e=u.dispatchIds)!=null&&e.length&&((t=u.dispatchIds)==null?void 0:t.length)>0){const{toDelete:pe,toAdd:le}=Y(Pt.value,u.dispatchIds);if(le.length>0){const ee=le.map(Qe=>({pid:u.id,did:Qe})),{data:Ae,error:be}=await Mt(ee)}if(pe.length>0){const{data:ee,error:Ae}=await qa(pe.join(","))}}if((s=u.contractIds)!=null&&s.length&&((o=u.contractIds)==null?void 0:o.length)>0){const{toDelete:pe,toAdd:le}=Y(Ut.value,u.contractIds);if(le.length>0){const ee=le.map(Qe=>({pid:u.id,did:Qe})),{data:Ae,error:be}=await Bt(ee)}if(pe.length>0){const{data:ee,error:Ae}=await Ga(pe.join(","))}}we(),ie("submitted"),(d=window.$message)==null||d.success("修改成功")}}else{const W=Ka(),{data:m,error:X}=await Ha([{...u,uuid:W}]);if(!X){const{data:Y,error:pe}=await Ya(W);if(Y){let le=function(L,Fe,jt){return L.map(Me=>({...Me,pid:Fe}))};if(u.dispatchIds&&u.dispatchIds.length>0){const L=[];(c=u.dispatchIds)==null||c.forEach(Me=>{L.push({pid:Y,did:Me})});const{data:Fe,error:jt}=await Mt(L)}if(u.contractIds&&u.contractIds.length>0){const L=[];(D=u.contractIds)==null||D.forEach(async Me=>{L.push({proid:Y,conid:Me})});const{data:Fe,error:jt}=await Bt(L)}const ee=[];if(y.value.length>0){const L=le(y.value,Y);ee.push(At(L))}if(C.value.length>0){const L=le(C.value,Y);ee.push(Za(L))}if(w.value.length>0&&ee.push(Vt(w.value)),(await Promise.allSettled(ee)).forEach((L,Fe)=>{L.status==="fulfilled"?console.log(`第 ${Fe+1} 个请求成功`,L.value):console.error(`第 ${Fe+1} 个请求失败`,L.reason)}),!V.value.length){(k=window.$message)==null||k.destroyAll(),(H=window.$message)==null||H.success("操作成功"),we(),ie("submitted");return}const be=[];V.value.forEach(L=>{be.push({pid:Y,filename:L.name,file:L.url,sort:1})});const{data:Qe,error:Ia}=await Jt(be);Ia&&((se=window.$message)==null||se.error("保存文件记录失败")),(ze=window.$message)==null||ze.destroyAll(),(Pe=window.$message)==null||Pe.success("操作成功"),we(),ie("submitted")}}we(),ie("submitted"),(_e=window.$message)==null||_e.success("添加成功")}}const De=h(!1),ft=h();let je=null,St=null,Ge=null,wt=null,ve=null;const he=Te({longitude:0,latitude:0});let Re;const Ke=h(!1),ye=h(""),He=h([]);async function va(){window._AMapSecurityConfig={securityJsCode:_.userInfo.sdksecret},ft.value&&(ve=await zs.load({key:_.userInfo.sdkkey,version:"2.0",plugins:["AMap.Scale","AMap.PlaceSearch","AMap.AutoComplete","AMap.Geocoder","AMap.Geolocation"]}),je=new ve.Map(ft.value,{zoom:18,center:[S.value>0?w.value[S.value-1].longitude:u.longitude,S.value>0?w.value[S.value-1].latitude:u.latitude],viewMode:"3D",resizeEnable:!0}),St=new ve.Geocoder,new ve.PlaceSearch({city:"全国",pageSize:50}),wt=new ve.AutoComplete({city:"全国"}),mt(ve,{lng:S.value>0?w.value[S.value-1].longitude:u.longitude,lat:S.value>0?w.value[S.value-1].latitude:u.latitude}),je.on("click",e=>{const{lng:t,lat:s}=e.lnglat;Re=2,he.latitude=s,he.longitude=t,mt(ve,{lng:t,lat:s})}),gt(()=>window.dispatchEvent(new Event("resize"))))}const Dt=Qt.debounce(async e=>{if(!Ke.value||!e.trim()){He.value=[];return}wt.search(e,(t,s)=>{var o;console.log(s,"result"),t=="complete"&&s.info=="OK"&&((o=s==null?void 0:s.tips)!=null&&o.length)?He.value=s.tips.map(d=>({label:`${d.name}（${d.district||d.address||"无详细地址"}）`,value:`${d.location.lng}_${d.location.lat}`,raw:d})):He.value=[]})},300);st(ye,e=>{Dt(e)});function ha(e,t){if(console.log(e,t,"option"),!e)return;const[s,o]=e.split("_").map(Number);!s||!o||(je.setCenter([s,o]),Re=1,mt(ve,{lng:s,lat:o}),he.longitude=s,he.latitude=o)}const S=h(0);function zt(e){e?S.value=e:S.value=0,De.value=!0,Ke.value=!1,Re=void 0,gt(async()=>{await va(),setTimeout(()=>{Ke.value=!0;const t=document.querySelector(".n-auto-complete input");t==null||t.blur()},500)})}function mt(e,t){Ge&&je.remove(Ge),Ge=new e.Marker({position:[t.lng,t.lat],map:je}),je.add(Ge),St.getAddress(t,(s,o)=>{s==="complete"&&o.regeocode&&(console.log("result",o),console.log("formattedAddress",o.regeocode.formattedAddress),t.latitude=t.lat,t.longitude=t.lng,Re==1||(Re==2?ye.value=o.regeocode.formattedAddress:ye.value=S.value>0?w.value[S.value-1].addr||o.regeocode.formattedAddress:u.prosite||o.regeocode.formattedAddress))})}function ya(e,t){if(!t)return null;const s=t.replace(/省|市|特别行政区|自治区|壮族|回族|维吾尔/g,"").trim(),o=e.find(d=>t.includes(d.name)||d.name.includes(s));return o?o.id:null}const Pt=h([]),_a=async()=>{const{data:e,error:t}=await Qa({page:1,limit:100,pid:p.rowData.id});u.dispatchIds=e==null?void 0:e.list.map(s=>s.did),Pt.value=JSON.parse(JSON.stringify(u.dispatchIds))},It=h([]),$t=async()=>{const{data:e,error:t}=await Wa();e&&(It.value=e)},Nt=h([]),Lt=async e=>{let t=ya(It.value,e);const{data:s,error:o}=await Xa({page:1,limit:100,province:t});Nt.value=s.list},ba=async()=>{var e,t,s;if(S.value==0)u.latitude=he.latitude,u.longitude=he.longitude,u.prosite=ye.value,await $t(),Lt(ye.value);else if(w.value[S.value-1].addr=ye.value,w.value[S.value-1].latitude=he.latitude,w.value[S.value-1].longitude=he.longitude,p.operateType=="edit"){let o=w.value[S.value-1];if(w.value[S.value-1].id){const{data:d,error:c}=await es([o]);d&&((e=window.$message)==null||e.success("修改位置成功"),De.value=!1,S.value=0,Ze())}else{o.pid=(t=p.rowData)==null?void 0:t.id;const{data:d,error:c}=await Vt([o]);d&&((s=window.$message)==null||s.success("添加位置成功"),De.value=!1,S.value=0,Ze())}}De.value=!1,S.value=0};function ka(){De.value=!1}const{pageData:Ye,getData:xa,nextPage:Ca}=Gt(ts),Sa=async()=>{await xa({limit:100})},wa=async e=>{const t=e.currentTarget,s=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&Ye.data.length<Ye.total&&(await Ca(),await gt(),setTimeout(()=>{t.scrollTop=s}))},Ut=h([]),Da=async()=>{var s;const{data:e,error:t}=await as({page:1,limit:100,proid:(s=p.rowData)==null?void 0:s.id});u.contractIds=e==null?void 0:e.list.map(o=>o.conid),Ut.value=JSON.parse(JSON.stringify(u.contractIds))},w=h([{longitude:120.373885,latitude:30.303899,addr:""}]),za=h([]),Ze=async()=>{var s;const{data:e,error:t}=await ss({pid:(s=p.rowData)==null?void 0:s.id,page:1,limit:99});w.value=e.list.length==0?[{longitude:120.373885,latitude:30.303899,addr:""}]:e.list,za.value=JSON.parse(JSON.stringify(w.value))},Pa=async e=>{var t;if(e.id){const{data:s,error:o}=await rs(e.id);s&&((t=window.$message)==null||t.success("删除成功"),Ze())}else w.value.splice(w.value.indexOf(e),1)};return(e,t)=>{const s=oa,o=ws,d=Ba,c=Ss,D=Ht,k=lt,H=ia,se=Wt,ze=Ma,Pe=Ra,_e=ea,W=Ds;return N(),et(Ot,null,[a(Pe,{show:Ue.value,"onUpdate:show":[t[13]||(t[13]=m=>Ue.value=m),ma],"display-directive":"show",width:1100,onMaskClick:t[14]||(t[14]=m=>Ue.value=!0),onEsc:we},{default:n(()=>[a(ze,{title:fa.value,"native-scrollbar":!1,closable:""},{footer:n(()=>[a(i(de),{size:16,justify:"end"},{default:n(()=>[a(i(g),{onClick:we},{default:n(()=>[v(J(i(z)("common.cancel")),1)]),_:1}),a(i(g),{type:"primary",onClick:Ct},{default:n(()=>[v(J(i(z)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[a(se,{ref_key:"formRef",ref:T,model:u,rules:P,onKeyup:Xt(Ct,["enter"])},{default:n(()=>[a(H,{responsive:"screen","item-responsive":"","x-gap":"15"},{default:n(()=>[a(s,{span:"24 s:12 m:12",label:"项目名称",path:"proname"},{default:n(()=>[a(i(Z),{clearable:"",value:u.proname,"onUpdate:value":t[0]||(t[0]=m=>u.proname=m),placeholder:"请输入项目名称"},null,8,["value"])]),_:1}),p.operateType==="add"?(N(),R(s,{key:0,span:"24 s:12 m:12",label:"绑定合同",path:"contractIds"},{default:n(()=>[a(i(Oe),{filterable:"",multiple:"",value:u.contractIds,"onUpdate:value":[t[1]||(t[1]=m=>u.contractIds=m),E],placeholder:"请选择合同","label-field":"contractname","value-field":"id",options:i(Ye).data,onScroll:wa},null,8,["value","options"])]),_:1})):fe("",!0),p.operateType==="edit"?(N(),R(s,{key:1,span:"24 s:12 m:12",label:"项目状态",path:"status"},{default:n(()=>[a(i(Oe),{filterable:"",value:u.status,"onUpdate:value":t[2]||(t[2]=m=>u.status=m),placeholder:"请选择项目状态",options:i(Ve)(i(_).userInfo.usertype==0||i(_).userInfo.usertype==2?i(bt):i(Ps))},null,8,["value","options"])]),_:1})):fe("",!0),a(s,{span:"24 s:12 m:12",label:"周期（天）",path:"period"},{default:n(()=>[a(i(Ft),{clearable:"",value:u.period,"onUpdate:value":t[3]||(t[3]=m=>u.period=m),style:{width:"100%"},placeholder:"请输入周期"},null,8,["value"])]),_:1}),a(s,{span:"24 s:12 m:12",label:"调试类型",path:"dtype"},{default:n(()=>[a(i(Oe),{filterable:"",value:u.dtype,"onUpdate:value":t[4]||(t[4]=m=>u.dtype=m),placeholder:"请选择调试类型",options:i(Ve)(i(na))},null,8,["value","options"])]),_:1}),a(s,{span:"24 s:12 m:12",label:"项目默认地点",path:"prosite"},{default:n(()=>[F("div",As,[F("div",Fs,[a(d,{onClick:t[6]||(t[6]=m=>zt())},{default:n(()=>[a(i(Z),{value:u.prosite,"onUpdate:value":t[5]||(t[5]=m=>u.prosite=m),placeholder:"请选择项目地点"},null,8,["value"]),a(i(g),null,{icon:n(()=>[a(o,{class:"text-icon"})]),_:1})]),_:1})])])]),_:1}),a(s,{span:"24 s:12 m:12",label:"项目详细地址",path:"proaddr"},{default:n(()=>[a(i(Z),{type:"textarea",rows:1,clearable:"",value:u.proaddr,"onUpdate:value":t[7]||(t[7]=m=>u.proaddr=m),placeholder:"请输入项目详细地址"},null,8,["value"])]),_:1}),w.value.length?(N(),R(s,{key:2,span:"24 s:12 m:24",label:"",path:""},{default:n(()=>[F("div",Ts,[F("div",Os,[F("span",{class:"mr-10px",onClick:t[8]||(t[8]=Et(()=>{},["stop"]))},"其他地址"),a(i(g),{size:"small",ghost:"",type:"primary",onMousedown:t[9]||(t[9]=Et(()=>{},["stop"])),onClick:t[10]||(t[10]=m=>w.value.push({latitude:30.303899,longitude:120.373885,addr:""}))},{icon:n(()=>[a(c,{class:"text-icon"})]),default:n(()=>[t[18]||(t[18]=v(" 添加 "))]),_:1,__:[18]})]),F("div",Es,[(N(!0),et(Ot,null,Va(w.value,(m,X)=>(N(),et("div",{class:"flex px-50px items-center mt-10px w-100%",key:m.latitude},[F("span",Rs,"项目地址"+J(X+1),1),a(d,{onClick:Y=>zt(X+1)},{default:n(()=>[a(i(Z),{readonly:"",value:m.addr,"onUpdate:value":Y=>m.addr=Y,placeholder:"请选择项目地址"+(X+1)},null,8,["value","onUpdate:value","placeholder"]),a(i(g),null,{icon:n(()=>[a(o,{class:"text-icon"})]),_:1})]),_:2},1032,["onClick"]),w.value.length>1?(N(),R(i(ke),{key:0,onPositiveClick:Y=>Pa(m)},{trigger:n(()=>[a(i(g),{size:"small",ghost:"",type:"error",class:"ml-10px"},{icon:n(()=>[a(D,{class:"text-icon"})]),default:n(()=>[t[19]||(t[19]=v(" "+J("删除")))]),_:1,__:[19]})]),default:n(()=>[v(" 确定要删除项目地址"+J(X+1)+"吗？ ",1)]),_:2},1032,["onPositiveClick"])):fe("",!0)]))),128))])])]),_:1})):fe("",!0),a(s,{span:"24 s:12 m:12",label:"调度名称",path:"dispatch"},{default:n(()=>[a(i(Z),{clearable:"",value:u.dispatch,"onUpdate:value":t[11]||(t[11]=m=>u.dispatch=m),placeholder:"请输入调度名称"},null,8,["value"])]),_:1}),a(s,{span:"24 s:12 m:12",label:"选择调度",path:"dispatchIds"},{default:n(()=>[a(i(Oe),{filterable:"",multiple:"",value:u.dispatchIds,"onUpdate:value":t[12]||(t[12]=m=>u.dispatchIds=m),placeholder:"请选择调度","label-field":"dname","value-field":"id",options:Nt.value},null,8,["value","options"])]),_:1}),a(s,{span:"24 s:12 m:24",path:"contactList"},{default:n(()=>[F("div",Ms,[a(i(de),{align:"center",style:{"margin-bottom":"10px"}},{default:n(()=>[t[21]||(t[21]=F("span",null,"项目联系人",-1)),a(i(g),{size:"small",ghost:"",type:"primary",onClick:Ce},{icon:n(()=>[a(c,{class:"text-icon"})]),default:n(()=>[t[20]||(t[20]=v(" 添加项目联系人 "))]),_:1,__:[20]})]),_:1,__:[21]}),y.value.length>0?(N(),R(k,{key:0,columns:O,"paginate-single-page":!1,data:y.value,pagination:j,"max-height":350,"scroll-x":O.reduce((m,X)=>m+X.width,0)},null,8,["data","pagination","scroll-x"])):fe("",!0)])]),_:1}),a(s,{span:"24 s:12 m:24",path:"debuggedDevieceList"},{default:n(()=>[F("div",Bs,[a(i(de),{align:"center",style:{"margin-bottom":"10px"}},{default:n(()=>[t[23]||(t[23]=F("span",null,"待调试设备",-1)),a(i(g),{size:"small",ghost:"",type:"primary",onClick:pt},{icon:n(()=>[a(c,{class:"text-icon"})]),default:n(()=>[t[22]||(t[22]=v(" 添加待调试设备 "))]),_:1,__:[22]})]),_:1,__:[23]}),C.value.length>0?(N(),R(k,{key:0,style:{width:"1050px"},columns:$e,data:C.value,size:"small","scroll-x":$e.reduce((m,X)=>m+X.width,0),"row-key":m=>m.id,"max-height":350,pagination:I.pageSize==1?!1:I,remote:"","paginate-single-page":!1},null,8,["data","scroll-x","row-key","pagination"])):fe("",!0)])]),_:1}),a(s,{span:"24 s:12 m:24"},{default:n(()=>[F("div",Vs,[a(i(de),{align:"center",style:{"margin-bottom":"10px"}},{default:n(()=>[t[25]||(t[25]=F("span",null,"图纸",-1)),a(i(g),{size:"small",ghost:"",type:"primary",onClick:ca},{icon:n(()=>[a(c,{class:"text-icon"})]),default:n(()=>[t[24]||(t[24]=v(" 添加图纸 "))]),_:1,__:[24]})]),_:1,__:[25]}),V.value.length>0?(N(),R(k,{key:0,columns:ra,data:V.value,size:"small","scroll-x":702,"row-key":m=>m.id,"max-height":350},null,8,["data","row-key"])):fe("",!0)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"]),a(_e,{show:f.value,"onUpdate:show":t[15]||(t[15]=m=>f.value=m),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:n(()=>[v(J(B.value=="debuggedDevieceList"?"待调试设备":B.value=="debuggedBusinessList"?"待调试业务":B.value=="needsList"?"客户需求变更":B.value=="developBusinessList"?"需要开发":"")+" 文件列表 ",1)]),footer:n(()=>[a(i(de),{justify:"end"},{default:n(()=>[a(i(g),{size:"small",class:"mt-16px",onClick:qe},{default:n(()=>[v(J(i(z)("common.cancel")),1)]),_:1}),a(i(g),{type:"primary",size:"small",class:"mt-16px",onClick:Ne},{default:n(()=>[v(J(i(z)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[a(i(g),{size:"small",ghost:"",type:"primary",onClick:da},{icon:n(()=>[a(c,{class:"text-icon"})]),default:n(()=>[t[26]||(t[26]=v(" 添加 "))]),_:1,__:[26]}),a(k,{columns:ua,"paginate-single-page":!1,data:l.value,"max-height":350},null,8,["data"])]),_:1},8,["show"]),a(_e,{show:De.value,"onUpdate:show":t[17]||(t[17]=m=>De.value=m),title:"选择项目位置",preset:"card",class:"w-800px"},{footer:n(()=>[a(i(de),{justify:"end",size:16},{default:n(()=>[a(i(g),{onClick:ka},{default:n(()=>[v(J(i(z)("common.cancel")),1)]),_:1}),a(i(g),{type:"primary",onClick:ba},{default:n(()=>[v(J(i(z)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[Ke.value?(N(),R(W,{key:0,value:ye.value,"onUpdate:value":[t[16]||(t[16]=m=>ye.value=m),i(Dt)],options:He.value,placeholder:"请输入地点关键字",clearable:"",onSelect:ha},null,8,["value","options","onUpdate:value"])):fe("",!0),F("div",{ref_key:"domRef",ref:ft,class:"h-full w-full",style:{width:"100%",height:"500px","margin-top":"10px"}},null,512)]),_:1},8,["show"])],64)}}}),qs=ot({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:tt(["reset","search"],["update:model"]),setup(Q,{emit:ne}){ds();const _=ne,{formRef:ie,restoreValidation:q}=Zt(),p=yt(Q,"model"),u={当日:()=>{const b=new Date().getTime();return[b,b]},本周:()=>{const b=new Date().getTime();return[b-24*60*60*1e3*7,b]},上月:()=>{const b=new Date().getTime();return[b-24*60*60*1e3*30,b]},近一年:()=>{const b=new Date().getTime();return[b-24*60*60*1e3*365,b]},近三年:()=>{const b=new Date().getTime();return[b-24*60*60*1e3*365*3,b]}};function ce(){p.value.fuzzy="",_("search")}async function U(b,P){if(!b){p.value.startTime=void 0,p.value.endTime=void 0,_("search");return}p.value.startTime=String(at(1,P[0])),p.value.endTime=String(at(1,P[1])),_("search")}async function oe(){p.value.startTime=void 0,p.value.endTime=void 0,p.value.startAndTimeRange=null,p.value.fuzzy="",p.value.status=null,p.value.ptype=null,p.value.dtype=null,await q(),_("reset")}const me=Qt.debounce(b=>{_("search")},1e3,{leading:!0,trailing:!1}),T=b=>{p.value.fuzzy=b,me(b)};async function G(){_("search")}return(b,P)=>{const y=Z,j=oa,O=Oe,x=Us,K=Ls,te=g,xe=Ns,Ce=de,E=ia,M=Wt,Ee=_t;return N(),R(Ee,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[a(M,{ref_key:"formRef",ref:ie,model:p.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Xt(G,["enter"])},{default:n(()=>[a(E,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:n(()=>[a(j,{span:"24 s:12 m:6",label:"项目/客户",path:"fuzzy"},{default:n(()=>[a(y,{clearable:"",value:p.value.fuzzy,"onUpdate:value":P[0]||(P[0]=A=>p.value.fuzzy=A),placeholder:"请输入项目名称或客户名称",onClear:ce,onInput:T},null,8,["value"])]),_:1}),a(j,{span:"24 s:12 m:6",label:"项目状态",path:"status"},{default:n(()=>[a(O,{clearable:"",filterable:"",value:p.value.status,"onUpdate:value":[P[1]||(P[1]=A=>p.value.status=A),G],placeholder:"请选择项目状态",options:i(Ve)(i(bt)).sort((A,ge)=>A.value-ge.value)},null,8,["value","options"])]),_:1}),a(j,{span:"24 s:12 m:6",label:"进度状态",path:"ptype"},{default:n(()=>[a(O,{clearable:"",filterable:"",value:p.value.ptype,"onUpdate:value":[P[2]||(P[2]=A=>p.value.ptype=A),G],placeholder:"请选择进度状态",options:[{label:"正常",value:0},{label:"已延期",value:1}]},null,8,["value"])]),_:1}),a(j,{span:"24 s:12 m:6",label:"调试类型",path:"dtype"},{default:n(()=>[a(O,{clearable:"",filterable:"",value:p.value.dtype,"onUpdate:value":[P[3]||(P[3]=A=>p.value.dtype=A),G],placeholder:"请选择调试类型",options:i(Ve)(i(na))},null,8,["value","options"])]),_:1}),a(j,{span:"24 s:12 m:8",label:"起止时间"},{default:n(()=>[a(x,{value:p.value.startAndTimeRange,"onUpdate:value":P[4]||(P[4]=A=>p.value.startAndTimeRange=A),type:"datetimerange",clearable:"",shortcuts:u,"onUpdate:formattedValue":U},null,8,["value"])]),_:1}),a(j,{span:"24  s:12 m:6",class:"pr-24px"},{default:n(()=>[a(Ce,{class:"w-full"},{default:n(()=>[a(te,{onClick:oe},{icon:n(()=>[a(K,{class:"text-icon"})]),default:n(()=>[v(" "+J(i(z)("common.reset")),1)]),_:1}),a(te,{type:"primary",ghost:"",onClick:G},{icon:n(()=>[a(xe,{class:"text-icon"})]),default:n(()=>[v(" "+J(i(z)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Gs={class:"min-h-500px flex gap-16px"},Ks={class:"flex items-center justify-end gap-16px"},Hs=ot({__name:"relatedContractLook",props:tt({id:{}},{visable:{type:Boolean},visableModifiers:{}}),emits:["update:visable"],setup(Q){const ne=Q,_=yt(Q,"visable"),{columns:ie,data:q,getData:p,loading:u,mobilePagination:ce,searchParams:U}=ht({apiFn:ta,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,id:ne.id,_t:new Date().getTime()},columns:()=>[{key:"contractname",title:"合同",width:200,render:x=>a("div",{class:y.pids==x.id?"bg-#f1f1f1 cursor-pointer p-5px":"cursor-pointer p-5px",onClick:()=>j(x.id)},[a("div",{class:"flex"},[a("div",{class:"w-60px inline-block"},[v("名称：")]),x.contractname]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[v("编号：")]),v(" "),x.contractnum]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[v("联系人：")]),x.businesscon]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[v("联系方式：")]),x.businessinfo]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[v("注意事项：")]),x.precautions]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[v("备注：")]),x.notes])])}]}),{columns:oe,data:me,getData:T,loading:G,pagination:b,mobilePagination:P,searchParams:y}=ht({apiFn:aa,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,pids:ne.id,_t:new Date().getTime()},columns:()=>[{key:"devname",title:"设备名称",align:"center",width:200,ellipsis:{tooltip:!0}},{key:"devcount",title:"数量",align:"center",width:120},{key:"devmodel",title:"规格型号",align:"center",width:120,ellipsis:{tooltip:!0}},{key:"devunit",title:"单位",align:"center",width:120},{key:"devtype",title:"是否为我司设备",align:"center",width:120,render:x=>x.devtype==0?a(it,{type:"success"},{default:()=>[v("是")]}):a(it,{type:"info"},{default:()=>[v("否")]})},{key:"devmanu",title:"设备厂家",align:"center",width:120},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"创建人",align:"center",width:120},{key:"dbtime",title:"创建时间",align:"center",width:180}]}),j=x=>{y.pids=x,T()},O=()=>{_.value=!1};return st(()=>_.value,async x=>{var K;x&&(U.id=ne.id,me.value=[],b.itemCount=0,await p(),y.pids=(K=q.value[0])==null?void 0:K.id,y.pids&&T())}),(x,K)=>{const te=lt,xe=_t,Ce=ea;return N(),R(Ce,{show:_.value,"onUpdate:show":K[0]||(K[0]=E=>_.value=E),preset:"card",class:"w-1400px",title:"项目关联的合同"},{footer:n(()=>[F("div",Ks,[a(i(g),{type:"primary",size:"small",onClick:O},{default:n(()=>K[1]||(K[1]=[v(" 关闭 ")])),_:1,__:[1]})])]),default:n(()=>[F("div",Gs,[a(te,{class:"left",columns:i(ie),data:i(q),"paginate-single-page":!1,size:"small",remote:"",loading:i(u),pagination:i(ce),"row-key":E=>E.id,"max-height":600},null,8,["columns","data","loading","pagination","row-key"]),a(xe,{bordered:!1,size:"small",title:"设备",class:"w-1100px"},{default:n(()=>[a(te,{style:{width:"100%"},columns:i(oe),data:i(me),size:"small","max-height":600,loading:i(G),remote:"","scroll-x":i(oe).reduce((E,M)=>E+(M.width||100),0),"paginate-single-page":!1,pagination:i(P),"row-key":E=>E.id},null,8,["columns","data","loading","scroll-x","pagination","row-key"])]),_:1})])]),_:1},8,["show"])}}}),Ys=la(Hs,[["__scopeId","data-v-a53f455a"]]),Zs={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Kt(Q){return typeof Q=="function"||Object.prototype.toString.call(Q)==="[object Object]"&&!xs(Q)}const Qs=ot({name:"projectmanagement_projectlist",__name:"index",setup(Q){const ne=cs(),_=Yt(),ie=ps(),q=fs(),{columns:p,columnChecks:u,data:ce,getData:U,loading:oe,mobilePagination:me,searchParams:T}=ht({showTotal:!0,apiFn:ks,apiParams:{page:1,pageSize:20,limit:20,status:null,startAndTimeRange:null,startTime:null,endTime:null,creater:void 0,fuzzy:"",sort:void 0,_t:new Date().getTime()},immediate:!1,columns:()=>[{type:"selection",align:"center",width:48},{key:"proname",title:"项目名称",align:"center",width:240,render:l=>a("div",{class:"cursor-pointer",onClick:()=>Se(l)},[l.proname])},{key:"progess",title:"项目进度",align:"center",width:140,sorter:!0,render:l=>a(nt,{type:"line",showIndicator:!0,percentage:l.progess,"indicator-placement":"inside",processing:!0,color:"#1890ff"},null)},{key:"status",title:"项目状态",align:"center",width:120,defaultFilterOptionValue:null,filterOptions:Ve(bt),filter:!0,filterMultiple:!1,render:l=>{if(l.status===null)return null;const f=z(qt[l.status]);return a("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",color:l.status==-1?"#a27ff9":l.status===0?"#9ca3af":l.status===1?"#3b82f6":l.status===2?"#facc15":"#22c55e",borderRadius:"50%"}},[a("span",{style:{width:"10px",height:"10px",marginRight:"5px",backgroundColor:l.status==-1?"#a27ff9":l.status===0?"#9ca3af":l.status===1?"#3b82f6":l.status===2?"#facc15":"#22c55e",borderRadius:"50%"}},null),a("span",null,[f])])}},{key:"cpdbtime",title:"预计完成日期",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"period",title:"周期",align:"center",width:100,render:l=>a("div",null,[l.period,v("天")])},{key:"ptype",title:"状态",align:"center",width:100,render:l=>a(it,{type:l.ptype===0?"success":"error"},{default:()=>[l.ptype===0?"正常":"已延期"]})},{key:"dtype",title:"调试类型",align:"center",width:100,render:l=>{if(l.dtype===null)return null;const f=z(Is[l.dtype]);return a(it,{type:l.dtype==0?"warning":l.dtype==1?"success":"info"},Kt(f)?f:{default:()=>[f]})}},{key:"debugs",title:"统计数量信息",align:"center",width:200,render(l){const f=(B,ae,ue)=>{const Ne=ue>0;return r("div",{style:`
                    cursor: ${Ne?"pointer":"default"};
                    color: ${Ne?"#1890ff":"#999"};
                    user-select: none;
                  `},`${B}：${ue}`)};return r("div",{style:"display:flex; flex-direction:column; gap:4px;"},[f("调试任务","debug",l.debugs),f("项目总结","summary",l.summarys),f("日报数量","daily",l.dailys)])}},{key:"username",title:"创建人",align:"center",width:100,ellipsis:{tooltip:!0}},{key:"dbtime",title:"创建时间",align:"center",width:180},{key:"operate",title:z("common.operate"),align:"center",width:320,fixed:"right",render:l=>{let f;return a("div",{class:"flex justify-end gap-8px"},[l.status==-1&&(_.userInfo.usertype==0||_.userInfo.id==1021||_.userInfo.id==1023)&&a(ke,{onPositiveClick:()=>te(l,0)},{default:()=>"确定核准该项目吗？",trigger:()=>a(g,{color:"#a43cf9",ghost:!0,size:"small"},{default:()=>["核准"]})}),l.status==0&&(_.userInfo.usertype==0||_.userInfo.usertype==2)&&a(ke,{onPositiveClick:()=>te(l,1)},{default:()=>"确定启动该项目吗？",trigger:()=>Be(a(g,{type:"success",ghost:!0,size:"small"},{default:()=>["启动"]}),[[We("no-auth"),"project:Info:update"]])}),l.status==2&&(_.userInfo.usertype==0||_.userInfo.usertype==2)&&a(ke,{onPositiveClick:()=>te(l,3)},{default:()=>"是否确认执行审核操作？",trigger:()=>Be(a(g,{type:"warning",ghost:!0,size:"small"},{default:()=>["审核"]}),[[We("no-auth"),"project:Info:update"]])}),a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>Se(l)},{default:()=>["详情"]}),a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>Ee(l)},{default:()=>["关联合同"]}),Be(a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>xe(l.id)},Kt(f=z("common.edit"))?f:{default:()=>[f]}),[[We("no-auth"),"project:Info:update"]])])}}]}),{drawerVisible:G,operateType:b,editingData:P,handleAdd:y,handleEdit:j,checkedRowKeys:O,onBatchDeleted:x}=Cs(ce,U);async function K(){console.log(O.value),Ce(O.value.join(","),l=>{x()})}const te=async(l,f)=>{var ue;const{data:B,error:ae}=await sa([{id:l.id,status:f}]);ae||((ue=window.$message)==null||ue.success("操作成功"),U(),f==3&&window.dispatchEvent(new CustomEvent("clearReview",{detail:{id:l.pid,type:"prj"}})))};function xe(l){j(l)}async function Ce(l,f){const{data:B,error:ae}=await _s(l);if(!ae)f&&f(B);else return!1}const E=h(!1),M=h(0),Ee=l=>{E.value=!0,M.value=l.id},A=l=>{T.status=l.status,U()},ge=l=>{console.log(l),l.columnKey=="progess"&&(T.sort=l.order=="ascend"?0:l.order=="descend"?1:void 0,U())},re=h(0),rt=l=>{re.value=l,l==0?U():$e()},Se=l=>{ie.push("/projectmanagement/orderdetail?prjId="+l.id),_.setProjectInfo({pid:l.id,pname:l.proname})},Je=()=>{U()};ms(()=>{q.query.pname?(T.fuzzy=q.query.pname,T.status=2,Je()):U()}),st(()=>q.query.pname,l=>{l&&(T.fuzzy=l,U())});const C=[{key:"proname",width:300,title(){return a("div",{class:"font-size-16px font-bold"},[v("近期项目")])},ellipsis:{tooltip:!0},render:l=>a(bs,{placement:"top",trigger:"hover"},{trigger:()=>a("div",{class:"cursor-pointer text-ellipsis overflow-hidden whitespace-nowrap font-bold",onClick:()=>Se(l),style:"max-width: 280px;"},[l.proname||"-"]),default:()=>l.proname||"-"})},{key:"progess",title:"项目进度",align:"center",width:120,render:l=>a(nt,{type:"line",showIndicator:!0,percentage:l.progess,"indicator-placement":"inside",processing:!0,color:l.progess==100?"#22C55E":"#1890ff"},null)},{key:"status",title:"项目状态",align:"center",width:100,render:l=>{if(l.status===null)return null;const f=z(qt[l.status]);return a("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",color:l.status===0?"#9ca3af":l.status===1?"#3B82F6":l.status===2?"#f1c40f":"#2ecc71",borderRadius:"50%"}},[a("span",{style:{width:"10px",height:"10px",marginRight:"5px",backgroundColor:l.status===0?"#9ca3af":l.status===1?"#3B82F6":l.status===2?"#f1c40f":"#2ecc71",borderRadius:"50%"}},null),a("span",null,[f])])}},{title:"调试人",key:"username",width:90},{title:"调试任务名称",key:"debugname",width:180},{title:"调试时间",key:"dbdbtime",width:180},{title:"任务审核时间",key:"ckdbtime",width:180}],I=Te({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",itemCount:0,pageSizes:[10,20],prefix:()=>`共 ${I.itemCount} 条`,onChange:l=>{I.page=l,$e()},onUpdatePageSize:l=>{I.pageSize=l,I.page=1,$e()}}),Ie=h([]),$e=async()=>{const{data:l,error:f}=await gs({page:I.page,limit:I.pageSize});f||(Ie.value=l.list,I.itemCount=l.total)};return(l,f)=>{const B=js,ae=ys,ue=de,Ne=Na,Le=Ht,ut=$a,dt=lt,ct=lt,pt=_t,qe=We("no-auth");return N(),et("div",Zs,[re.value==0?(N(),R(qs,{key:0,model:i(T),"onUpdate:model":f[0]||(f[0]=$=>Xe(T)?T.value=$:null),onReset:Je,onSearch:i(U)},null,8,["model","onSearch"])):fe("",!0),a(pt,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},vs({header:n(()=>[a(ue,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:n(()=>[f[6]||(f[6]=F("div",null,"项目列表",-1)),a(ae,{size:"small",value:re.value,"onUpdate:value":[f[1]||(f[1]=$=>re.value=$),rt],name:"radiobuttongroup1"},{default:n(()=>[a(B,{value:0,label:"默认"}),a(B,{value:1,label:"近期项目"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:n(()=>[re.value==0?(N(),R(dt,{key:0,"checked-row-keys":i(O),"onUpdate:checkedRowKeys":f[3]||(f[3]=$=>Xe(O)?O.value=$:null),columns:i(p),data:i(ce),size:"small","flex-height":!i(ne).isMobile,"scroll-x":i(p).reduce(($,V)=>$+(V.width||100),0),loading:i(oe),remote:"","row-key":$=>$.id,"onUpdate:sorter":ge,pagination:i(me),class:"sm:h-full","onUpdate:filters":A},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"])):(N(),R(ct,{key:1,ref:"tableContainer",class:"sm:h-full",remote:"",pagination:I.pageSize==1?!1:I,"scroll-x":C.reduce(($,V)=>$+(V.width||100),0),columns:C,data:Ie.value,bordered:!1,"flex-height":!i(ne).isMobile},null,8,["pagination","scroll-x","data","flex-height"])),a(Js,{visible:i(G),"onUpdate:visible":f[4]||(f[4]=$=>Xe(G)?G.value=$:null),onSubmitted:i(U),"operate-type":i(b),"row-data":i(P)},null,8,["visible","onSubmitted","operate-type","row-data"]),a(Ys,{visable:E.value,"onUpdate:visable":f[5]||(f[5]=$=>E.value=$),id:M.value},null,8,["visable","id"])]),_:2},[re.value==0?{name:"header-extra",fn:n(()=>[a(ue,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:n(()=>[Be((N(),R(i(g),{onClick:i(y),size:"small",ghost:"",type:"primary"},{icon:n(()=>[a(Ne,{class:"text-icon"})]),default:n(()=>[f[7]||(f[7]=v(" "+J("新增项目")))]),_:1,__:[7]},8,["onClick"])),[[qe,"project:Info:insert"]]),a(i(ke),{onPositiveClick:K},{trigger:n(()=>[Be((N(),R(i(g),{size:"small",ghost:"",type:"error",disabled:i(O).length==0},{icon:n(()=>[a(Le,{class:hs(["text-icon",{"animate-spin":i(oe)}])},null,8,["class"])]),default:n(()=>[f[8]||(f[8]=v(" "+J("批量删除")))]),_:1,__:[8]},8,["disabled"])),[[qe,"project:Info:delete"]])]),default:n(()=>[f[9]||(f[9]=v(" 确定要删除选中的合同吗？ "))]),_:1,__:[9]}),a(ut,{columns:i(u),"onUpdate:columns":f[2]||(f[2]=$=>Xe(u)?u.value=$:null)},null,8,["columns"])]),_:1})]),key:"0"}:void 0]),1024)])}}}),hl=la(Qs,[["__scopeId","data-v-6dff3013"]]);export{hl as default};
