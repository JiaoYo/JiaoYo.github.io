import{d as W,q as G,s as le,x as K,o as E,c as q,w as n,g as a,i as h,Y as ne,aG as oe,h as k,t as N,$ as g,H as ie,aH as se,aI as ue,a1 as re,B as U,P as F,Q as ce,af as Q,j as w,ag as de,r as H,ax as j,e as J,aA as pe,al as Y,aB as fe,S as me,at as _e,R as ve,T as ge,f as X,ak as Z,U as ee,a5 as he}from"./index-uWl0lIER.js";import{f as ye,a as be,b as xe,c as we}from"./audit-events-D8zZUCjJ.js";import{_ as ke,l as te}from"./lodash-CX70KSBg.js";import{T as B}from"./basicconf-9tFEKmK9.js";import{_ as Te}from"./round-search-DfAfcfoj.js";import{_ as Se}from"./round-refresh-BwkPlWDE.js";import{u as De}from"./usePageData-5dakVWUn.js";import{_ as Ce}from"./FormItemGridItem-Cb7akj-q.js";import{_ as Ne}from"./DatePicker-CNq34CW9.js";import{_ as Ae}from"./Grid-BA1XrY0C.js";import{f as ze}from"./events-BKVXdf9u.js";import{_ as Ie,a as Pe}from"./DescriptionsItem-fxhwcO3u.js";import{e as $e}from"./exportExcel-D6OyA9oJ.js";import"./TimePicker-CHp7lcub.js";import"./defineProperty-C5BOWma5.js";const Ve=W({name:"FormSearch",__name:"form-search",props:G({AuditTypeData:{},AuditPolicyData:{}},{model:{required:!0},modelModifiers:{}}),emits:G(["reset","search"],["update:model"]),setup(d,{emit:A}){const z=d,o=A,{formRef:P,restoreValidation:T}=le(),i=K(d,"model");De(se);async function S(t,u){t&&t.length>0?(i.value.startTime=t[0],i.value.endTime=t[1]):(i.value.startTime=null,i.value.endTime=null),o("search")}async function L(){await T(),i.value.timeRange=null,i.value.atype=null,i.value.ap=null,i.value.startTime=null,i.value.endTime=null,i.value.elevel=null,ue(()=>{o("search")})}async function y(){o("search")}const I=ke.throttle(y,1e3,{trailing:!1});return(t,u)=>{const r=re,_=Ce,x=Ne,D=Se,v=U,C=Te,$=F,V=Ae,s=ce,b=Q;return E(),q(b,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[a(s,{ref_key:"formRef",ref:P,model:i.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:ie(h(I),["enter"])},{default:n(()=>[a(V,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:n(()=>[a(_,{span:"24 s:12 m:8 l:8",label:"事件等级",path:"elevel"},{default:n(()=>[a(r,{filterable:"",clearable:"",value:i.value.elevel,"onUpdate:value":[u[0]||(u[0]=e=>i.value.elevel=e),y],placeholder:"请选择事件等级",options:h(ne)(h(oe))},null,8,["value","options"])]),_:1}),a(_,{span:"24 s:12 m:8 l:8",label:"审计策略",path:"ap"},{default:n(()=>[a(r,{value:i.value.ap,"onUpdate:value":[u[1]||(u[1]=e=>i.value.ap=e),y],placeholder:"请选择审计策略",clearable:"",filterable:"","value-field":"id","label-field":"pname",options:z.AuditPolicyData,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),a(_,{span:"24 s:24 m:16 l:10",label:"产生时间",path:"timeRange"},{default:n(()=>[a(x,{clearable:"",value:i.value.timeRange,"onUpdate:value":u[2]||(u[2]=e=>i.value.timeRange=e),type:"datetimerange","value-format":"yyyy-MM-dd HH:mm:ss",style:{width:"100%"},"onUpdate:formattedValue":S},null,8,["value"])]),_:1}),a(_,{span:"24 s:24 m:8 l:10",label:" "},{default:n(()=>[a($,{class:"w-full"},{default:n(()=>[a(v,{onClick:L},{icon:n(()=>[a(D,{class:"text-icon"})]),default:n(()=>[k(" "+N(h(g)("common.reset")),1)]),_:1}),a(v,{type:"primary",ghost:"",onClick:h(I)},{icon:n(()=>[a(C,{class:"text-icon"})]),default:n(()=>[k(" "+N(h(g)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),ae=d=>(ve("data-v-cfb2eed2"),d=d(),ge(),d),Me=ae(()=>X("span",null,"事件信息",-1)),Oe=ae(()=>X("span",null,"事件溯源",-1)),Ee={key:0,style:{display:"flex","justify-content":"center","align-items":"center",color:"#606266","font-size":"14px",height:"500px"}},Le={key:1,class:"max-h-500px min-h-320px"};function Re(d){return typeof d=="function"||Object.prototype.toString.call(d)==="[object Object]"&&!Z(d)}const He=W({__name:"detailInfo",props:G({detailInfo:{},AuditTypeData:{},AuditPolicyData:{}},{detailVisible:{default:!1},detailVisibleModifiers:{}}),emits:["update:detailVisible"],setup(d){const A=K(d,"detailVisible"),z=d,o=w();de(()=>A.value,async t=>{t&&(o.value=z.detailInfo,S())});const P=[{title:"",key:"index",width:50,render:t=>`${t.index}`},{key:"pname1",title:"安全事件名称",align:"center",minWidth:160,ellipsis:{tooltip:!0}},{key:"pname1",title:"安全事件类型",align:"center",width:140},{key:"pname2",title:"安全事件类别",align:"center",width:140},{key:"elevel",title:"事件等级",align:"center",width:120,render:t=>{(t.elevel===void 0||t.elevel===null)&&(t.elevel=1);const u={0:"#8e9dff",1:"#5da8ff",2:"#fedc69",3:"#ff9874",4:"#ff0000"},r=g(B[t.elevel]);let _={color:u[t.elevel],textColor:"#ffffff",borderColor:u[t.elevel]};return a(j,{size:"small",color:_},Re(r)?r:{default:()=>[r]})}},{key:"aggre",title:"聚合数量",align:"center",width:120},{key:"aggrestarttime",title:"聚合开始时间",align:"center",width:180},{key:"type",title:"发生源设备类型",align:"center",width:160}],T=w(!1);let i=H([]);const S=async t=>{var _;if(!T.value)T.value=!0;else return;const{data:u,error:r}=await ze({pageId:t,auditid:(_=o.value)==null?void 0:_.auditid,limit:20});r||(T.value=!1,t?i=[...i,...u]:i=u,i=i.map((x,D)=>(x.index=D+1,x)))};function L(t){var r;Math.abs(t.target.scrollTop+t.target.offsetHeight-t.target.scrollHeight)<=20&&((r=o.value)==null?void 0:r.eco)>i.length&&y()}const y=te.debounce(()=>{S(i[i.length-1].id)},300),I=H({page:1,pageCount:1,pageSize:20,total:0,prefix({startIndex:t,endIndex:u,page:r,pageSize:_,pageCount:x,itemCount:D}){var v,C;return`已加载${i.length}条 共${(i.length>((v=o.value)==null?void 0:v.eco)?i.length:(C=o.value)==null?void 0:C.eco)||0}条`}});return(t,u)=>{const r=Ie,_=Pe,x=F,D=pe,v=Y,C=fe,$=me,V=_e;return E(),q(V,{show:A.value,"onUpdate:show":u[0]||(u[0]=s=>A.value=s),title:"事件详情",preset:"card",class:"w-1200px"},{default:n(()=>[a($,{class:"max-h-600px pr-20px"},{default:n(()=>[a(C,{type:"line",animated:""},{default:n(()=>[a(D,{name:"1"},{tab:n(()=>[Me]),default:n(()=>[a(x,{vertical:"",size:12},{default:n(()=>[a(_,{"label-placement":"left",bordered:"",column:2,"label-style":{width:"160px"}},{default:n(()=>[a(r,{label:"审计事件名称"},{default:n(()=>{var s;return[k(N((s=o.value)==null?void 0:s.aename),1)]}),_:1}),a(r,{label:"审计类型"},{default:n(()=>{var s,b;return[k(N(((s=z.AuditTypeData.find(e=>{var l;return e.id===((l=o.value)==null?void 0:l.atype)}))==null?void 0:s.atypename)||((b=o.value)==null?void 0:b.atype)||""),1)]}),_:1}),a(r,{label:"审计策略"},{default:n(()=>{var s,b;return[k(N(((s=z.AuditPolicyData.find(e=>{var l;return e.id===((l=o.value)==null?void 0:l.ap)}))==null?void 0:s.pname)||((b=o.value)==null?void 0:b.ap)||""),1)]}),_:1}),a(r,{label:"事件等级"},{default:n(()=>{var s,b,e,l,c,f,m,p,M,R;return[a(h(j),{size:"small",color:{textColor:"#ffffff",borderColor:((s=o.value)==null?void 0:s.alevel)===0?"#8e9dff":((b=o.value)==null?void 0:b.alevel)===1?"#5da8ff":((e=o.value)==null?void 0:e.alevel)===2?"#fedc69":((l=o.value)==null?void 0:l.alevel)===3?"#ff9874":((c=o.value)==null?void 0:c.alevel)===4?"#ff0000":"#5da8ff",color:((f=o.value)==null?void 0:f.alevel)===0?"#8e9dff":((m=o.value)==null?void 0:m.alevel)===1?"#5da8ff":((p=o.value)==null?void 0:p.alevel)===2?"#fedc69":((M=o.value)==null?void 0:M.alevel)===3?"#ff9874":((R=o.value)==null?void 0:R.alevel)===4?"#ff0000":"#5da8ff"}},{default:n(()=>{var O;return[k(N(h(g)(h(B)[(O=o.value)==null?void 0:O.alevel])),1)]}),_:1},8,["color"])]}),_:1}),a(r,{label:"产生时间"},{default:n(()=>{var s;return[k(N((s=o.value)==null?void 0:s.dbtime),1)]}),_:1}),a(r,{label:"更新时间"},{default:n(()=>{var s;return[k(N((s=o.value)==null?void 0:s.uptime),1)]}),_:1}),a(r,{label:"事件总数"},{default:n(()=>{var s;return[k(N((s=o.value)==null?void 0:s.eco),1)]}),_:1})]),_:1})]),_:1})]),_:1}),a(D,{name:"2"},{tab:n(()=>[Oe]),default:n(()=>[h(i).length==0?(E(),J("div",Ee," 暂无安全事件信息 ")):(E(),J("div",Le,[a(v,{columns:P,remote:"",data:h(i),size:"small","scroll-x":762,"row-key":s=>s.id,"virtual-scroll":"",class:"sm:h-full","max-height":400,loading:T.value,pagination:I,onScroll:L},null,8,["data","row-key","loading","pagination"])]))]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])}}}),Be=ee(He,[["__scopeId","data-v-cfb2eed2"]]),Ge={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Ue(d){return typeof d=="function"||Object.prototype.toString.call(d)==="[object Object]"&&!Z(d)}const je=W({name:"audit_event",__name:"index",setup(d){const A=w(window.innerHeight-395),z=he(),o=w(!1),P=w(),T=w([]);(async()=>{const{data:e,error:l}=await ye({page:1,limit:1e3});l||(T.value=JSON.parse(JSON.stringify(e)).list)})();const S=w([]);(async()=>{const{data:e,error:l}=await be({page:1,limit:1e3});l||(S.value=JSON.parse(JSON.stringify(e)).list)})();const y=H({limit:100,pageId:void 0,elevel:void 0,atype:void 0,uid:void 0,suditPolicy:void 0,startTime:void 0,endTime:void 0,fuzzy:void 0,_t:new Date().getTime()}),I=[{title:"",key:"index",width:80,align:"center",render:e=>`${e.index}`},{key:"aename",title:g("page.audit.event.eventName"),align:"center",minWidth:160,ellipsis:!0,resizable:!0},{key:"dbtime",title:g("page.audit.event.createTime"),align:"center",width:220,resizable:!0},{key:"uptime",title:g("page.audit.event.updateTime"),align:"center",width:220,resizable:!0},{key:"ap",title:g("page.audit.event.strategy"),align:"center",width:220,render:e=>{var c;const l=(c=S.value.find(f=>f.id===e.ap))==null?void 0:c.pname;return a("span",null,[l||e.ap])},resizable:!0},{key:"alevel",title:g("page.audit.event.eventRanK"),align:"center",width:220,render:e=>{(e.alevel===void 0||e.alevel===null)&&(e.alevel=0);const l={0:"#8e9dff",1:"#5da8ff",2:"#fedc69",3:"#ff9874",4:"#ff0000"},c=g(B[e.alevel]);let f={color:l[e.alevel],textColor:"#ffffff",borderColor:l[e.alevel]};return a(j,{size:"small",color:f},Ue(c)?c:{default:()=>[c]})},resizable:!0},{key:"eco",title:g("page.audit.event.eventCount"),align:"center",width:220,resizable:!0},{key:"operate",title:g("common.operate"),align:"center",width:220,fixed:"right",render:e=>a("div",{class:"flex-center gap-8px"},[a(U,{type:"primary",ghost:!0,size:"small",onClick:()=>s(e)},{default:()=>[k("详情")]})])}],t=w([]),u=w(!1),r=w(0),_=async(e=!1)=>{if(!u.value)u.value=!0;else return;u.value=!0;const{data:l,error:c}=await xe(y);c||(r.value=l.length,e?t.value=[...t.value,...l]:t.value=l,t.value=t.value.map((f,m)=>(f.index=m+1,f)),u.value=!1)};_();const x=w(!0),D=()=>{t.value=[],y.pageId=void 0,(l=>Object.keys(l).filter(m=>m!=="limit"&&m!=="_t").some(m=>l[m]!==void 0&&l[m]!==""&&l[m]!==null))(y)?x.value=!1:(x.value=!0,C()),_()},v=H({page:1,pageCount:1,pageSize:20,total:0,prefix({startIndex:e,endIndex:l,page:c,pageSize:f,pageCount:m,itemCount:p}){return`已加载${t.value.length}条`+(t.value.length?x.value?` 共计 ${t.value.length>0?p??0:0} 条`:r.value==y.limit?"  预计还有更多":"  没有更多了":"")}});async function C(){const{data:e,error:l}=await we();l||(v.pageCount=20,v.total=Number(e),v.itemCount=Number(e))}C();function $(e){var c;Math.abs(e.target.scrollTop+e.target.offsetHeight-e.target.scrollHeight)<=20&&v.total>((c=t.value)==null?void 0:c.length)&&V()}const V=te.debounce(()=>{var e;((e=t.value)==null?void 0:e.length)<v.total&&(y.pageId=t.value[t.value.length-1].id,_(!0))},300);async function s(e){P.value=e,o.value=!0}async function b(){if(!t.value.length)return;const e=JSON.parse(JSON.stringify(t.value)),l=[];e.forEach(f=>{const m={};I.forEach(p=>{var M;if(f.hasOwnProperty(p.key)){const R=p.key=="alevel"?g(B[f[p.key]]):p.key=="ap"?(M=S.value.find(O=>O.id===O[p.key]))==null?void 0:M.pname:f[p.key];m[p.title]=R}}),l.push(m)}),$e(l,500,[{wpx:100},{wpx:100},{wpx:100},{wpx:100},{wpx:100},{wpx:100},{wpx:50}],"审计事件_"+new Date().getTime())}return(e,l)=>{const c=F,f=Y,m=Q;return E(),J("div",Ge,[a(Ve,{model:y,"onUpdate:model":l[0]||(l[0]=p=>y=p),onSearch:D,AuditTypeData:T.value,AuditPolicyData:S.value},null,8,["model","AuditTypeData","AuditPolicyData"]),a(m,{title:h(g)("page.audit.event.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":n(()=>[a(c,null,{default:n(()=>[a(h(U),{type:"primary",size:"small",ghost:"",onClick:b,title:"导出已加载"},{default:n(()=>[k("导出已加载")]),_:1})]),_:1})]),default:n(()=>[a(f,{columns:I,data:t.value,size:"small","virtual-scroll":"","flex-height":!h(z).isMobile,loading:u.value,remote:"","row-key":p=>p.id,"max-height":A.value,pagination:v,onScroll:$,class:"sm:h-full","scroll-x":""},null,8,["data","flex-height","loading","row-key","max-height","pagination"]),a(Be,{"detail-visible":o.value,"onUpdate:detailVisible":l[1]||(l[1]=p=>o.value=p),"detail-info":P.value,AuditTypeData:T.value,AuditPolicyData:S.value},null,8,["detail-visible","detail-info","AuditTypeData","AuditPolicyData"])]),_:1},8,["title"])])}}}),it=ee(je,[["__scopeId","data-v-a66033c2"]]);export{it as default};
