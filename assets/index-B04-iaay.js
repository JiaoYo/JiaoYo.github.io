import{_ as te}from"./table-column-setting.vue_vue_type_script_setup_true_lang-DRBn7s0v.js";import{_ as ae}from"./round-search-SK0LkSqR.js";import{d as ne,bp as se,g as o,aK as T,aN as le,aV as E,v as oe,ae as ce,j as g,ap as ie,x as R,F as A,aX as B,aY as L,E as j,az as F,a6 as re,o as ue,e as de,w as d,h as P,i as l,ai as pe,A as _e,B as me,aa as he,f as J,J as fe,z as ge,bq as ye,t as ve,al as V,af as ke,H as be,an as we,K as xe,ag as Se,a1 as Te,O as $e}from"./index-C2u6vOA1.js";import{u as De,a as Ne}from"./table-Cb07FrQD.js";import{a as ze,p as qe}from"./gather-BLPYjlkF.js";import{_ as Ce}from"./InputGroupLabel-dvdG1V-u.js";import{_ as Ie}from"./Tree-4caxcqoe.js";import{_ as Ee}from"./DataTable-B59_lcFE.js";import{_ as Pe}from"./Split-DdPVVjTV.js";import"./RadioGroup-dVRs7CWd.js";import"./Forward-DB9iWvzA.js";const Ue={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ke={class:"flex flex-col"},Oe=ne({name:"configsetting_realtimedata_devicedata",__name:"index",setup(Re){const{columns:W,columnChecks:$,data:w,getData:y,loading:U,mobilePagination:G,searchParams:m,resetSearchParams:Ae}=De({apiFn:se,apiParams:{page:1,pageSize:200,limit:200,tagType:null,chlid:null,devId:null,fuzzy:"",chlType:0,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",align:"center",width:48},{key:"id",title:"序号",align:"center",width:80},{key:"devId",title:"设备名称",align:"center",width:100,render:e=>{var t;return o("span",null,[(t=K.value.find(n=>n.id==e.devId))==null?void 0:t.devName])}},{key:"tagName",title:"测点名称",align:"center"},{key:"tagDesc",title:"物模型标识(测点描述)",align:"center"},{key:"value",title:"测点值",align:"center",width:140,render:e=>{var t;return T("span",{style:{color:e.quality===100?"red":e.quality==49?"#409eff":e.quality==50?"#909399":"#67c23a"}},parseFloat((t=e.value)==null?void 0:t.toFixed(6))||e.value)}},{key:"quality",title:"质量",align:"center",width:120,render:e=>(e.quality==100||e.quality==49||e.quality==0)&&T(le,{style:{background:e.quality===100?"red":e.quality==49?"#409eff":"#67c23a",color:"#fff"}},e.quality==0?"Good":e.quality==49?"人工置数":e.quality==100?"Bad":"")},{key:"dbtime",title:"采集时间",align:"center",minWidth:120,render:e=>{var t,n;return T("span",{title:E(0,+e.dbtime)},e.dbtime?(n=E(2,+e.dbtime))==null?void 0:n.substring(10,(t=E(2,+e.dbtime))==null?void 0:t.length):"")}},{key:"tagType",title:"测点类型",align:"center",width:140,render:e=>o("span",null,[ze[e.tagType]])},{key:"objAddr",title:"地址",align:"center",width:140}]}),H=e=>{e===""&&y()};oe(async()=>{await M(),q(),Y()}),ce(()=>{var e;(e=D.value)==null||e.close(),S.value.close()});const h=g(),K=g([]),M=async()=>{const{data:e,error:t}=await ie();if((e==null?void 0:e.length)==0)return;function n(p){return p.map(a=>{var c;return{label:a.chlName,key:a.id,dev_status:null,children:(c=a.devicePojoList)!=null&&c.length?a.devicePojoList.map(s=>(K.value.push(s),{label:s.devName,dev_status:null,chlType:a.chlType,key:s.id})):[]}})}h.value=n(e),m.chlid=h.value[0].key,m.devId=h.value[0].children[0].key,C.value=[h.value[0].children[0].key],x.value=h.value[0].children[0].label,y()},D=g(null),Y=()=>{var c;(c=D.value)==null||c.close();const e=new Date().getTime(),t=R(),n=A(`${t}${e}getchlstatus`),p=B(n),a=new L(j.replace("https","wss")+`/ChannelStatusWebsocket/getchlstatus/${p}/${e}/${t}?token=${F()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});D.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(s=>{let i=[];console.log(s,"通道状态websocket接受数据"),O(s.data)&&(i=JSON.parse(s.data).data,h.value.forEach(r=>{i.forEach(u=>{var b;u.chl_id==r.key&&(r.dev_status=u.chl_status),u.chl_id==1&&(r.dev_status=1),(b=r.children)==null||b.forEach(v=>{var f;(f=u.devs)==null||f.forEach(k=>{k.dev_id==v.key&&(v.dev_status=k.dev_status),k.dev_id==1&&(v.dev_status=1)})})})}))})},S=g(null),N=g(""),z=g(!0),q=()=>{var c;(c=S.value)==null||c.close(),z.value=!0;const e=new Date().getTime(),t=R(),n=A(`${t}${e}${x.value}`),p=B(n),a=new L(j.replace("https","wss")+`/realTimeDataWebsocket/${x.value}/${p}/${e}/${t}?token=${F()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});S.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(s=>{let i=[];console.log(s,"实时数据websocket接受数据"),O(s.data)&&(i=JSON.parse(s.data).data[x.value],i==null||i.forEach(r=>{w.value.forEach(u=>{r.i==u.id&&(u.quality=r.q,u.value=r.v,u.dbtime=r.t)})}),N.value=ee())})},C=g([]),x=g(""),X=async(e,t,n)=>{var c,s,i,r,u;C.value=[(c=n.node)==null?void 0:c.key],m.chlType=(s=n.node)==null?void 0:s.chlType;function p(b,v){for(const f of b)if(f.children){for(const k of f.children)if(k.key===v)return f.key}return null}const a=await p(h.value,(i=n.node)==null?void 0:i.key);m.chlid=a,m.devId=(r=n.node)==null?void 0:r.key,x.value=(u=n.node)==null?void 0:u.label,y(),q()},Q=e=>{e&&w.value.length>0?q():S.value.close()};re(()=>m.tagType,e=>{e||y()});const Z=({option:e})=>e.key==0?"":e.dev_status!==null?T("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:e.hasOwnProperty("dev_status")&&e.dev_status==1?"#00b42a":e.dev_status==2?"#ff0000":"#ccc"}}):"",ee=e=>{const t=new Date,n=t.getFullYear(),p=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),c=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0");return`${n}-${p}-${a} ${c}:${s}:${i}`},{drawerVisible:Be,operateType:Le,editingData:je,handleAdd:Fe,handleEdit:Je,checkedRowKeys:I,onBatchDeleted:Ve,onDeleted:We}=Ne(w,y),O=e=>{try{return JSON.parse(e),!0}catch{return!1}};return(e,t)=>{const n=Ce,p=ke,a=be,c=ae,s=we,i=xe,r=te,u=Ie,b=Se,v=Ee,f=Pe,k=Te;return ue(),de("div",Ue,[o(k,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:d(()=>[o(i,{align:"center",wrap:"",justify:"start",class:"lt-sm:w-200px"},{default:d(()=>[o(s,null,{default:d(()=>[o(n,null,{default:d(()=>[P("测点类型")]),_:1}),o(p,{filterable:"",clearable:"",placeholder:"请选择",value:l(m).tagType,"onUpdate:value":t[0]||(t[0]=_=>l(m).tagType=_),options:l(pe)(l(qe))},null,8,["value","options"]),o(a,{clearable:"",value:l(m).fuzzy,"onUpdate:value":[t[1]||(t[1]=_=>l(m).fuzzy=_),H],placeholder:"请输入测点名称或描述",style:{width:"150%"},onKeyup:_e(l(y),["enter"])},null,8,["value","onKeyup"]),o(l(me),{type:"primary",ghost:"",onClick:l(y)},{icon:d(()=>[o(c,{class:he(["text-icon",{"animate-spin":l(U)}])},null,8,["class"])]),default:d(()=>[P(" 搜索 ")]),_:1},8,["onClick"])]),_:1}),J("div",Ke,[o(l(fe),{checked:z.value,"onUpdate:checked":[t[2]||(t[2]=_=>z.value=_),Q]},{default:d(()=>[P(" 实时刷新 ")]),_:1},8,["checked"]),ge(J("span",{class:"font-size-14px color-blank",style:{"font-weight":"600"}}," 刷新时间："+ve(N.value),513),[[ye,N.value]])])]),_:1})]),"header-extra":d(()=>[o(i,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:d(()=>[o(r,{columns:l($),"onUpdate:columns":t[3]||(t[3]=_=>V($)?$.value=_:null)},null,8,["columns"])]),_:1})]),default:d(()=>[o(f,{direction:"horizontal",class:"sm:h-full","default-size":.15,max:.35,min:.1,"resize-trigger-size":6},{1:d(()=>[o(b,{style:{"max-height":"700px"}},{default:d(()=>[o(u,{"block-line":"","default-expand-all":"",data:h.value,"checked-keys":C.value,"expand-on-click":!1,"render-prefix":Z,"check-strategy":"child","onUpdate:checkedKeys":X,checkable:""},null,8,["data","checked-keys"])]),_:1})]),2:d(()=>[o(v,{"checked-row-keys":l(I),"onUpdate:checkedRowKeys":t[4]||(t[4]=_=>V(I)?I.value=_:null),columns:l(W),data:l(w),size:"small",loading:l(U),remote:"","row-key":_=>_.id,"flex-height":!0,"scroll-x":"",pagination:l(w).length?l(G):void 0,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1})])}}}),st=$e(Oe,[["__scopeId","data-v-f1ae19e4"]]);export{st as default};
