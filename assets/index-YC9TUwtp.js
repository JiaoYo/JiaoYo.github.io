import{_ as _e}from"./table-column-setting.vue_vue_type_script_setup_true_lang-BqSXzLBW.js";import{_ as ge}from"./round-delete-C1xvOo2m.js";import{_ as he}from"./round-add-CnBYTu1X.js";import{d as ee,aq as Y,p as le,s as ve,r as Z,q as se,a as ye,ar as re,a1 as be,c as $,o as v,w as n,f as o,b5 as we,F as ie,h as l,at as ce,A as T,b as E,g as f,e as q,t as S,B as C,N as te,$ as R,b6 as Ce,E as ke,U as ue,L as xe,i as Se,x as X,az as K,av as je,C as J,bl as De,W as Ne,aC as Ue}from"./index-BrSW3Qk_.js";import{f as pe,b as qe,H as ze,I as Pe,J as ae,K as Te}from"./project-ClKCYf-S.js";import{u as $e,a as Re}from"./table-BgZMMP2L.js";import{u as de}from"./usePageData-DxOb3kll.js";import{_ as me}from"./Grid-CF6VHH9t.js";import{_ as fe}from"./FormItemGridItem-CtEU2lvz.js";import{N as Fe}from"./Upload-Do_zf-0j.js";import{_ as Le}from"./round-search-Bt589pab.js";import{_ as Ie}from"./round-refresh-DBlHyOAy.js";import{N as oe}from"./Popconfirm-BS6m75G8.js";import"./Progress-ZAqDftr5.js";import"./utils-BNOftVEY.js";const Be={key:0},Me={key:0},Oe={key:0},Ve={key:0},Ae=ee({name:"OperateDrawer",__name:"operate-drawer",props:Y({operateType:{},rowData:{},pid:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:Y(["submitted"],["update:visible"]),setup(j,{emit:B}){const D=le(),z=B,g=j,t=ve(b());Z();function b(){return{pid:void 0,id:"",reqcontent:"",customer:"",cstcontact:"",notes:"",re1:"",re2:"",re3:"",re4:"",fl1:"",fl2:"",fl3:"",fl4:""}}const p=Z([]),{pageData:_,getData:h,nextPage:M}=de(pe),F=async a=>{const e=a.currentTarget;e.scrollTop+e.offsetHeight>=e.scrollHeight&&_.data.length<_.total&&(M(),p.value=_.data)},O=async()=>{await h({fuzzy:D.userInfo.pname}),p.value=_.data},V=async()=>{await h(),p.value=_.data},A=async a=>{t.pid=a};async function G(){var a;O(),Object.assign(t,b()),t.pid=g.pid?g.pid:(a=p.value[0])==null?void 0:a.id,g.operateType==="edit"&&g.rowData&&Object.assign(t,g.rowData)}const{formRef:k,validate:I,restoreValidation:d}=se(),m={pid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择"},reqcontent:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},customer:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},cstcontact:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"}},N=ye(()=>({add:"新增需求变更",edit:"修改需求变更"})[g.operateType]),x=re(j,"visible");async function P(a){if(a)try{const i=await(await fetch(a==null?void 0:a.split("?")[0],{mode:"cors"})).blob(),u=URL.createObjectURL(i),y=document.createElement("a");y.href=u,y.download=a==null?void 0:a.split("?")[1],y.style.display="none",document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(u)}catch(e){console.error("下载失败:",e)}}be(x,()=>{x.value&&(G(),setTimeout(()=>{const a=document.querySelector(".n-scrollbar-content");a==null||a.scrollTo(0,0)},300),d())});async function U({file:a},e){let i=new FormData;i.append("multipartFile",a.file);const{data:u,error:y}=await qe(i);y||(t[e]=u)}function L(){x.value=!1}async function c(){var a,e;if(await I(),g.operateType==="edit"){const{data:i,error:u}=await ze([t]);u||(L(),z("submitted"),(a=window.$message)==null||a.success("修改成功"))}else{const{data:i,error:u}=await Pe([{...t}]);u||(L(),z("submitted"),(e=window.$message)==null||e.success("添加成功"))}}return(a,e)=>{const i=fe,u=Fe,y=me,W=ie,Q=we,H=te,w=Ce;return v(),$(w,{show:x.value,"onUpdate:show":e[17]||(e[17]=s=>x.value=s),title:N.value,preset:"card",class:"w-800px"},{footer:n(()=>[o(H,{justify:"end",size:16},{default:n(()=>[o(l(C),{onClick:L},{default:n(()=>[f(S(l(R)("common.cancel")),1)]),_:1}),o(l(C),{type:"primary",onClick:c},{default:n(()=>[f(S(l(R)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[o(Q,{class:"pr-20px"},{default:n(()=>[o(W,{ref_key:"formRef",ref:k,model:t,rules:m,"label-placement":"left","label-width":120},{default:n(()=>[o(y,{responsive:"screen","item-responsive":""},{default:n(()=>[o(i,{span:"24 m:12",label:"项目列表",path:"pid"},{default:n(()=>[o(l(ce),{clearable:"",filterable:"",value:t.pid,"onUpdate:value":[e[0]||(e[0]=s=>t.pid=s),A],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:V,options:p.value,onScroll:F},null,8,["value","options"])]),_:1}),o(i,{span:"24 m:12",label:"需求内容",path:"reqcontent"},{default:n(()=>[o(l(T),{value:t.reqcontent,"onUpdate:value":e[1]||(e[1]=s=>t.reqcontent=s),placeholder:"请输入"},null,8,["value"])]),_:1}),o(i,{span:"24 m:12",label:"客户联系人",path:"customer"},{default:n(()=>[o(l(T),{value:t.customer,"onUpdate:value":e[2]||(e[2]=s=>t.customer=s),placeholder:"请输入"},null,8,["value"])]),_:1}),o(i,{span:"24 m:12",label:"联系方式",path:"cstcontact"},{default:n(()=>[o(l(T),{value:t.cstcontact,"onUpdate:value":e[3]||(e[3]=s=>t.cstcontact=s),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),o(i,{span:"24 m:12",label:"备注",path:"notes"},{default:n(()=>[o(l(T),{value:t.notes,"onUpdate:value":e[4]||(e[4]=s=>t.notes=s),placeholder:"请输入"},null,8,["value"])]),_:1}),o(i,{span:"24 m:24",label:"附件1",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re1,"onUpdate:value":e[5]||(e[5]=r=>t.re1=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl1?(v(),E("span",Be,[f(S((s=t.fl1)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[6]||(e[6]=r=>t.fl1="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[7]||(e[7]=r=>P(t.fl1))},"下载")])):(v(),$(u,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl1"),"show-file-list":!1},{default:n(()=>[o(l(C),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[18]||(e[18]=[f("选择文件")])),_:1,__:[18]})]),_:1},8,["custom-request"]))]}),_:1}),o(i,{span:"24 m:24",label:"附件2",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re2,"onUpdate:value":e[8]||(e[8]=r=>t.re2=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl2?(v(),E("span",Me,[f(S((s=t.fl2)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[9]||(e[9]=r=>t.fl2="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[10]||(e[10]=r=>P(t.fl2))},"下载")])):(v(),$(u,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl2"),"show-file-list":!1},{default:n(()=>[o(l(C),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[19]||(e[19]=[f("选择文件")])),_:1,__:[19]})]),_:1},8,["custom-request"]))]}),_:1}),o(i,{span:"24 m:24",label:"附件3",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re3,"onUpdate:value":e[11]||(e[11]=r=>t.re3=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl3?(v(),E("span",Oe,[f(S((s=t.fl3)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[12]||(e[12]=r=>t.fl3="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[13]||(e[13]=r=>P(t.fl3))},"下载")])):(v(),$(u,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl3"),"show-file-list":!1},{default:n(()=>[o(l(C),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[20]||(e[20]=[f("选择文件")])),_:1,__:[20]})]),_:1},8,["custom-request"]))]}),_:1}),o(i,{span:"24 m:24",label:"附件4",path:"notes"},{default:n(()=>{var s;return[o(l(T),{value:t.re4,"onUpdate:value":e[14]||(e[14]=r=>t.re4=r),placeholder:"请输入",style:{width:"250px","margin-right":"20px"}},null,8,["value"]),t.fl4?(v(),E("span",Ve,[f(S((s=t.fl4)==null?void 0:s.split("?")[1])+" ",1),q("span",{class:"cursor-pointer c-#c92a2a",onClick:e[15]||(e[15]=r=>t.fl4="")},"删除"),q("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:e[16]||(e[16]=r=>P(t.fl4))},"下载")])):(v(),$(u,{key:1,style:{width:"auto"},ref:"uploadRef",action:"#","custom-request":r=>U(r,"fl4"),"show-file-list":!1},{default:n(()=>[o(l(C),{size:"small",ghost:"",type:"primary"},{default:n(()=>e[21]||(e[21]=[f("选择文件")])),_:1,__:[21]})]),_:1},8,["custom-request"]))]}),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Ee=ee({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:Y(["reset","search","clear"],["update:model"]),setup(j,{emit:B}){const D=B,{formRef:z,restoreValidation:g}=se(),t=re(j,"model"),b=le(),p=Z([]),{pageData:_,getData:h,nextPage:M}=de(pe),F=async d=>{const m=d.currentTarget;m.scrollTop+m.offsetHeight>=m.scrollHeight&&_.data.length<_.total&&(M(),p.value=_.data)},O=async d=>{var m;d?(t.value.pid=d,D("search"),b.setProjectInfo({pname:(m=p.value.find(N=>N.id==d))==null?void 0:m.proname,pid:d})):D("clear")},V=async d=>{await h({fuzzy:d}),p.value=_.data},A=async()=>{await h(),p.value=_.data};(async()=>{var d,m;await h({fuzzy:b.userInfo.pname}),p.value=_.data,t.value.pid=b.userInfo.pid?b.userInfo.pid:(d=p.value[0])==null?void 0:d.id,b.setProjectInfo({pid:t.value.pid,pname:(m=p.value.find(N=>N.id==t.value.pid))==null?void 0:m.proname}),D("search")})();async function k(){await g(),t.value.fuzzy="",D("reset")}async function I(){D("search")}return(d,m)=>{const N=ce,x=fe,P=Ie,U=C,L=Le,c=te,a=me,e=ie,i=ue;return v(),$(i,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[o(e,{ref_key:"formRef",ref:z,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:ke(I,["enter"])},{default:n(()=>[o(a,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:n(()=>[o(x,{span:"24 s:12 m:6",label:"项目列表",path:"PrjId"},{default:n(()=>[o(N,{filterable:"",clearable:"",value:t.value.pid,"onUpdate:value":[m[0]||(m[0]=u=>t.value.pid=u),O],placeholder:"请选择项目","label-field":"proname","value-field":"id",options:p.value,onScroll:F,onClear:A,onSearch:V},null,8,["value","options"])]),_:1}),o(x,{span:"24  s:12 m:6",class:"pr-24px"},{default:n(()=>[o(c,{class:"w-full"},{default:n(()=>[o(U,{onClick:k},{icon:n(()=>[o(P,{class:"text-icon"})]),default:n(()=>[f(" "+S(l(R)("common.reset")),1)]),_:1}),o(U,{type:"primary",ghost:"",onClick:I},{icon:n(()=>[o(L,{class:"text-icon"})]),default:n(()=>[f(" "+S(l(R)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Ge={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function ne(j){return typeof j=="function"||Object.prototype.toString.call(j)==="[object Object]"&&!Ue(j)}const rt=ee({name:"projectmanagement_needchange",__name:"index",setup(j){const B=xe(),{columns:D,columnChecks:z,data:g,getData:t,loading:b,pagination:p,mobilePagination:_,searchParams:h}=$e({showTotal:!0,immediate:!1,apiFn:Te,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"reqcontent",title:"需求内容",align:"center",width:120},{key:"customer",title:"客户联系人",align:"center",width:120},{key:"cstcontact",title:"联系方式",align:"center",width:120},{key:"cstresult",title:"结果",align:"center",width:120,render(c){return Ne("div",{},c.cstresult==0?"失败":c.cstresult==1?"成功":"")}},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"操作人",align:"center",width:120},{key:"dbtime",title:"操作时间",align:"center",width:120},{key:"operate",title:R("common.operate"),align:"center",width:140,fixed:"right",render:c=>{let a;return o("div",{class:"flex-center gap-8px"},[J(o(C,{type:"primary",ghost:!0,size:"small",onClick:()=>x(c.id)},ne(a=R("common.edit"))?a:{default:()=>[a]}),[[X("no-auth"),"project:Customer:update"]]),o(oe,{onPositiveClick:()=>N(c.id)},{default:()=>R("common.confirmDelete"),trigger:()=>{let e;return J(o(C,{type:"error",ghost:!0,size:"small"},ne(e=R("common.delete"))?e:{default:()=>[e]}),[[X("no-auth"),"project:Customer:delete"]])}})])}}]}),M=()=>{g.value=[],p.itemCount=0},{drawerVisible:F,operateType:O,editingData:V,handleAdd:A,handleEdit:G,checkedRowKeys:k,onBatchDeleted:I,onDeleted:d}=Re(g,t);Se(async()=>{});async function m(){console.log(k.value),P(k.value.join(","),c=>{I()})}async function N(c){const{data:a,error:e}=await ae(c,h.pid);e||d()}function x(c){G(c)}async function P(c,a){const{data:e,error:i}=await ae(c,h.pid);if(!i)a&&a(e);else return!1}const U=c=>{t()},L=()=>{t()};return(c,a)=>{const e=te,i=he,u=ge,y=_e,W=je,Q=ue,H=X("no-auth");return v(),E("div",Ge,[o(Ee,{model:l(h),"onUpdate:model":a[0]||(a[0]=w=>K(h)?h.value=w:null),onReset:L,onSearch:l(t),onClear:M},null,8,["model","onSearch"]),o(Q,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:n(()=>[o(e,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:n(()=>a[4]||(a[4]=[q("div",null,"需求变更",-1)])),_:1,__:[4]})]),"header-extra":n(()=>[o(e,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:n(()=>[J((v(),$(l(C),{onClick:l(A),size:"small",ghost:"",type:"primary"},{icon:n(()=>[o(i,{class:"text-icon"})]),default:n(()=>[a[5]||(a[5]=f(" "+S("新增")))]),_:1,__:[5]},8,["onClick"])),[[H,"project:Customer:insert"]]),o(l(oe),{onPositiveClick:m},{trigger:n(()=>[J((v(),$(l(C),{size:"small",ghost:"",type:"error",disabled:l(k).length==0},{icon:n(()=>[o(u,{class:De(["text-icon",{"animate-spin":l(b)}])},null,8,["class"])]),default:n(()=>[a[6]||(a[6]=f(" "+S("批量删除")))]),_:1,__:[6]},8,["disabled"])),[[H,"project:Customer:delete"]])]),default:n(()=>[a[7]||(a[7]=f(" 确定要删除选中的吗？ "))]),_:1,__:[7]}),o(y,{columns:l(z),"onUpdate:columns":a[1]||(a[1]=w=>K(z)?z.value=w:null)},null,8,["columns"])]),_:1})]),default:n(()=>[o(W,{"checked-row-keys":l(k),"onUpdate:checkedRowKeys":a[2]||(a[2]=w=>K(k)?k.value=w:null),columns:l(D),data:l(g),size:"small","flex-height":!l(B).isMobile,loading:l(b),remote:"","row-key":w=>w.id,pagination:l(_),class:"sm:h-full","onUpdate:filters":U},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),o(Ae,{visible:l(F),"onUpdate:visible":a[3]||(a[3]=w=>K(F)?F.value=w:null),onSubmitted:l(t),pid:l(h).pid,"operate-type":l(O),"row-data":l(V)},null,8,["visible","onSubmitted","pid","operate-type","row-data"])]),_:1})])}}});export{rt as default};
