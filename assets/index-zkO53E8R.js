import{Q as fe,p as ge,_ as ve,a as he}from"./pako.esm-DHwybaxa.js";import{_ as ye}from"./export-4ZOKfZHZ.js";import{_ as be}from"./round-search-DVDB1PMU.js";import{d as J,ab as j,a0 as xe,o as P,b as q,bG as ke,_ as K,e9 as De,a$ as l,g as o,m as x,z as Te,aj as Se,r as Pe,w as n,f as p,B as L,h as C,t as W,$ as H,c as O,F as U,e as G,ap as $e,ea as Ce,A as We,J as Ne,b1 as Ie,b2 as Le,b3 as Ue,aD as Ae,aF as Me,Q as Be,T as Re,a6 as ze,b$ as Fe,as as Oe,R as qe,c0 as Ge,ao as Ee,p as Ve,i as je}from"./index-Cqw4OD9i.js";import{u as He,a as Qe}from"./table-BBgSyjoT.js";import{e as Je}from"./exportExcel-Bv4G4H50.js";import{u as Ke,L as Q}from"./echarts-DngX8br7.js";import{_ as Ze}from"./DatePicker-DLuRMjmo.js";import{_ as Xe}from"./RadioButton-CeBn_pFk.js";import{_ as Ye}from"./FormItemGridItem-DKYTTcXQ.js";import{_ as ea}from"./Grid-UqFBXM4M.js";const aa=J({name:"LineChart",__name:"line-chart",props:{data:{type:Object,default:()=>({})}},setup(S){const w=S;j(()=>w.data,async e=>{k(i=>(i.xAxis.data=w.data.map(r=>r.dbtime),i.series[0].data=w.data.map(r=>r.power),i.series[1].data=w.data.map(r=>r.prePower),i))});const f=xe(),{domRef:A,updateOptions:M,updateOptionsAsync:k}=Ke(()=>({tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}},backgroundColor:"#6a7985",textStyle:{color:"rgb(224, 224, 224)"},valueFormatter:function(e){return ke(e,"MW")}},legend:{data:["实际功率","预测功率"]},toolbox:{show:!0,feature:{saveAsImage:{show:!0,name:"功率图表"},magicType:{show:!0,type:["line","bar"]}}},grid:{left:"2%",right:"4%",bottom:"10%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:[]},yAxis:{type:"value",axisLabel:{formatter:"{value} MW"}},series:[{color:"#e90445",name:"实际功率",type:"line",emphasis:{focus:"series"},lineStyle:{width:1},areaStyle:{color:new Q(0,0,0,1,[{offset:0,color:"rgba(233, 4, 69,0.3)"},{offset:1,color:"rgba(233, 4, 69,0)"}],!1),shadowColor:"rgba(233, 4, 69,0.9)",shadowBlur:20},data:[],connectNulls:!0},{color:"#009688",name:"预测功率",type:"line",emphasis:{focus:"series"},lineStyle:{width:1},areaStyle:{color:new Q(0,0,0,1,[{offset:0,color:"rgba(0, 150, 136,0.3)"},{offset:1,color:"rgba(0, 150, 136,0)"}],!1),shadowColor:"rgba(0, 150, 136,0.9)",shadowBlur:20},data:[],connectNulls:!0}],dataZoom:[{type:"inside",start:0,end:100},{start:0,end:100}]}));async function D(){await new Promise(e=>{setTimeout(e,200)}),M(e=>(e.xAxis.data=w.data.map(i=>i.dbtime),e.series[0].data=w.data.map(i=>i.power),e.series[1].data=w.data.map(i=>i.prePower),e))}function B(){M((e,i)=>{const r=i();return e.legend.data=r.legend.data,e.series[0].name=r.series[0].name,e.series[1].name=r.series[1].name,e})}async function R(){D()}return j(()=>f.locale,()=>{B()}),R(),(e,i)=>(P(),q("div",{ref_key:"domRef",ref:A,class:"h-600px overflow-hidden"},null,512))}}),ta=K(aa,[["__scopeId","data-v-d0a50e34"]]),oa=S=>(Ve("data-v-e6f6a286"),S=S(),je(),S),na={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},sa={style:{width:"200px","margin-left":"20px"}},ra={key:1},la=oa(()=>G("span",null,"二维码",-1)),ia=J({name:"realtimequery_powerquery",__name:"index",setup(S){const w=Date.now(),f=new Date(w).setHours(0,0,0,0);new Date(w).setHours(23,59,59,999);const{columns:A,columnChecks:M,data:k,getData:D,loading:B,mobilePagination:R,searchParams:e,resetSearchParams:i}=He({apiFn:De,apiParams:{page:1,pageSize:20,limit:20,startTime:l(1,f)||null,endTime:l(1,Date.now()+144e5)||null,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",width:60},{key:"dbtime",title:"时间",align:"center",width:100},{key:"power",title:"实际功率(MW)",align:"center",width:140},{key:"prePower",title:"预测功率(MW)",align:"center",width:140},{key:"ctime",title:"预测计算时间(s)",align:"center",width:140},{key:"operate",title:"误差(MW)",align:"center",width:100,render(t){const a=t.prePower-t.power>=0?t.prePower-t.power:t.power-t.prePower;return o("span",null,[a?parseFloat(a.toFixed(6)):""])}}]}),{checkedRowKeys:r}=Qe(k,D),h=x(null),z=x(!1),Z=t=>{if(t){if(h.value!==null)return;y(),h.value=window.setInterval(async()=>y(),1e3*60*3)}else h.value!==null&&(clearInterval(h.value),h.value=null),y()},X=async()=>{v.value=="0"?await y():await D()},$=x([]),N=x(""),y=async()=>{const{data:t,error:a}=await Ce({startTime:e.startTime,endTime:e.endTime});a||($.value=t.sort((u,s)=>new Date(u.dbtime).getTime()-new Date(s.dbtime).getTime()))},I=x([f,Date.now()+144e5]);async function Y(t,a){e.startTime=l(1,a[0]),e.endTime=l(1,a[1]),e.startTime==l(1,f)&&e.endTime==l(1,Date.now()+144e5)?b.value="0":e.startTime==l(1,f)&&e.endTime==l(1,Date.now()+864e5*10)?b.value="1":b.value="2",v.value=="1"?D():y()}const ee=t=>{t=="1"?D():y()};Te(()=>{y()});const ae=()=>{var u;if(k.value.length==0)return(u=window.$message)==null?void 0:u.warning("暂无数据。请查询数据后重试。");const t={dbtime:"时间",power:"实际功率",prePower:"预测功率",ctime:"预测计算时间",error:"误差"},a=[];k.value.forEach(s=>{r.value.includes(s.id)&&a.push({dbtime:s.dbtime,power:s.power,prePower:s.prePower,error:s.prePower-s.power>=0?s.prePower-s.power:s.power-s.prePower||""})}),Je(a,t,"预测数据")},v=x("0"),F=x(!1),te=()=>{var s,_;if($.value.length==0)return(s=window.$message)==null?void 0:s.warning("暂无数据。请查询数据后重试。");const t={data:$.value.map(g=>({t:g.dbtime,pP:g.prePower,p:g.power})),type:0,dateTime:l(1,e.startTime)+" --- "+(z.value?l(1,new Date):l(1,e.endTime))},u=ge.gzip(JSON.stringify(t),{to:"string"}).reduce((g,d)=>g+String.fromCharCode(d),"");if(N.value=`https://dingiiot.com/powerPrediction/?${btoa(u)}`,N.value.length>2700)return(_=window.$message)==null?void 0:_.warning("二维码生成失败，请缩小查询范围后重试");console.log("地址",N.value),F.value=!0},oe=()=>{var a;const t=document.getElementById("qrcode");if(t){const u=document.createElement("a");u.href=t.toDataURL("image/png"),u.download="qrcode.png",u.click(),(a=window.$message)==null||a.success("下载成功")}else console.error("无法找到二维码 canvas 元素")},ne={近一天:[Date.now()-864e5*1,Date.now()],近三天:[Date.now()-864e5*3,Date.now()],近七天:[Date.now()-864e5*7,Date.now()]},b=x("0"),se=t=>{b.value=t,c.powWsData="",t=="0"?(I.value=[f,Date.now()+144e5],e.startTime=l(1,f),e.endTime=l(1,Date.now()+144e5)):(I.value=[f,Date.now()+864e5*10],e.startTime=l(1,f),e.endTime=l(1,Date.now()+864e5*10)),v.value=="1"?D():y()};Se(()=>{h.value!==null&&(clearInterval(h.value),h.value=null)});const c=Pe({powerPreSocketWS:null,powLoading:!1,powWsData:"",timer:null}),re=()=>{var g;(g=c.powerPreSocketWS)==null||g.close(),setTimeout(()=>{var d,T;if(!c.powWsData&&c.powerPreSocketWS.socket)return(d=c.powerPreSocketWS)==null||d.close(),c.powLoading=!1,(T=window.$message)==null?void 0:T.error("查询预测数据超时")},20*1e3);const t=new Date().getTime(),a=We(),u=Ne(`${a}${t}${b.value=="0"?0:960}`),s=Ie(u),_=new Le(Ue+`/powerPre/${b.value=="0"?0:960}/${s}/${t}/${a}?token=${Ae()}`,{maxReconnectAttempts:1,heartbeatInterval:1e3*30});c.powerPreSocketWS=_,_.connect(),_.onclose(()=>{}),_.onerror(()=>{var d;_.close(),(d=window.$message)==null||d.error("查询预测数据失败"),c.powLoading=!1}),_.onopen(()=>{c.powLoading=!0}),_.onmessage(d=>{var T;console.log(d,"数据"),d.data.includes("请求成功,时间")&&(c.powWsData=d.data,c.powLoading=!1,(T=c.powerPreSocketWS)==null||T.close())})};return(t,a)=>{const u=Ze,s=Xe,_=Me,g=be,d=ve,T=Be,le=Ye,ie=ea,ce=Re,E=ze,V=Fe,ue=Oe,pe=ye,de=qe,me=Ge,_e=he,we=Ee;return P(),q("div",na,[o(E,{bordered:!1,size:"small"},{default:n(()=>[o(ce,{ref:"formRef",model:p(e),"label-placement":"left","show-feedback":!1},{default:n(()=>[o(ie,{"y-gap":16,responsive:"screen","item-responsive":""},{default:n(()=>[o(le,{span:"24 s:12 m:24",label:"起止时间",path:"startTime"},{default:n(()=>[o(u,{value:I.value,"onUpdate:value":a[0]||(a[0]=m=>I.value=m),type:"datetimerange","value-format":"yyyy-MM-dd hh:mm:ss","onUpdate:formattedValue":Y,"default-time":["00:00:00","23:59:59"],shortcuts:ne},null,8,["value"]),o(_,{value:b.value,"onUpdate:value":[a[1]||(a[1]=m=>b.value=m),se],class:"ml-20px"},{default:n(()=>[o(s,{value:"0",label:"超短期"}),o(s,{value:"1",label:"短期"})]),_:1},8,["value"]),o(p(L),{type:"primary",ghost:"",onClick:X,class:"ml-20px"},{icon:n(()=>[o(g,{class:"text-icon"})]),default:n(()=>[C(" "+W(p(H)("common.search")),1)]),_:1}),v.value=="0"?(P(),O(p(L),{key:0,type:"primary",ghost:"",onClick:te,class:"ml-20px"},{icon:n(()=>[o(d,{class:"text-icon"})]),default:n(()=>[C(" "+W("生成二维码"))]),_:1})):U("",!0),v.value=="0"?(P(),O(T,{key:1,checked:z.value,"onUpdate:checked":[a[2]||(a[2]=m=>z.value=m),Z],class:"ml-20px",title:"3分钟自动刷新"},{default:n(()=>[C(" 定时刷新 ")]),_:1},8,["checked"])):U("",!0),o(p(L),{type:"primary",ghost:"",onClick:re,class:"ml-20px",loading:c.powLoading},{default:n(()=>[C(" 查询预测数据计算时间 ")]),_:1},8,["loading"]),G("span",sa,W(c.powWsData),1)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),o(E,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{default:n(()=>[o(me,{type:"card",animated:"",value:v.value,"onUpdate:value":[a[4]||(a[4]=m=>v.value=m),ee],class:"h-100%","tab-style":{height:"40px"},"pane-wrapper-style":{flex:1}},{suffix:n(()=>[v.value=="1"?(P(),O(de,{key:0,align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:n(()=>[o(p(L),{onClick:ae,size:"small",disabled:p(r).length==0},{icon:n(()=>[o(pe,{class:"text-icon"})]),default:n(()=>[C(" "+W(p(H)("common.export")),1)]),_:1},8,["disabled"])]),_:1})):U("",!0),v.value=="0"?(P(),q("span",ra,"共"+W($.value.length)+"条数据",1)):U("",!0)]),default:n(()=>[o(V,{name:"0",tab:"图表"},{default:n(()=>[o(ta,{data:$.value},null,8,["data"])]),_:1}),o(V,{name:"1",tab:"表格",class:"h-100%"},{default:n(()=>[o(ue,{"checked-row-keys":p(r),"onUpdate:checkedRowKeys":a[3]||(a[3]=m=>$e(r)?r.value=m:null),columns:p(A),data:p(k),size:"small",loading:p(B),remote:"","row-key":m=>m.id,pagination:p(k).length?p(R):void 0,class:"sm:h-full","flex-height":!0,"scroll-x":""},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1},8,["value"])]),_:1}),o(we,{show:F.value,"onUpdate:show":a[5]||(a[5]=m=>F.value=m),title:"",preset:"card",class:"w-auto"},{header:n(()=>[G("div",null,[la,o(_e,{class:"text-icon ml-20px font-size-24px",style:{cursor:"pointer"},onClick:oe})])]),default:n(()=>[o(fe,{id:"qrcode",style:{margin:"0 auto"},value:N.value,margin:3,size:500,level:"L"},null,8,["value"])]),_:1},8,["show"])])}}}),ya=K(ia,[["__scopeId","data-v-e6f6a286"]]);export{ya as default};
