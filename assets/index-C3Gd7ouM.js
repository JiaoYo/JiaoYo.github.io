import{_ as Me}from"./table-header-operation.vue_vue_type_script_setup_true_lang-dBtr50ma.js";import{d as W,dQ as $e,j as $,aS as le,ar as ce,b7 as ue,dR as de,dS as pe,a5 as Y,bW as Ee,ao as be,cd as Ie,r as ke,n as ie,s as we,p as xe,q as je,b as ze,ae as Ae,bf as me,be as fe,D as ae,o as U,c as te,w as a,g as e,h as f,t as w,i as n,$ as A,E as J,e as Te,am as Pe,W as V,G as Ue,f as z,aD as Le,v as Be,bh as Ke,a_ as Fe,J as Re,K as _e,L as qe,aq as Ve,Z as Ge,O as Ce,S as Je,B as G,N as Ne,bg as De,as as We,F as Qe,ad as re,a3 as He,ah as ee,aj as Ze}from"./index-DOohPrRP.js";import{h as Xe,i as Ye,f as et,j as tt,k as at,l as ve,m as nt}from"./reportForm-ZD62v8QT.js";import{f as ot,i as Se}from"./scheduleTask-Ba3TAOxO.js";import{u as st,a as lt}from"./table-BfjKpFkX.js";import{a as Oe,T as ye,S as it}from"./task-sIqhb8FP.js";import{M as rt}from"./shield-question-outline-rounded-C0Au-lO-.js";import{_ as ct}from"./TimePicker-CA4a1Ds9.js";import{_ as ut}from"./round-search-BxVWD0EK.js";import{_ as dt}from"./round-refresh-BCHybn7o.js";import{_ as pt}from"./lodash-ffFD2ya4.js";import{_ as mt}from"./FormItemGridItem-BscgKSfD.js";import{_ as ft}from"./Grid-CohnLNvv.js";import{h as he}from"./permission-CTKXR_21.js";import{_ as _t}from"./Popconfirm-BCeMv-nO.js";import{_ as vt,a as yt}from"./DescriptionsItem-CGa7pAxX.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-R0GNNKKK.js";import"./setting-outlined-01_hOQ_i.js";import"./export-OgJnGaLp.js";import"./refresh-DfuWa4Y1.js";import"./round-delete-BQ3cU12H.js";import"./round-plus-CK9DqpBO.js";import"./Upload-j7MJs8TM.js";import"./Progress-C-EMU4G1.js";import"./defineProperty-Bq0o15Xa.js";const ht=W({name:"ModalEnvironment",props:Object.assign(Object.assign({},$e),{internalKey:{type:String,required:!0},onInternalAfterLeave:{type:Function,required:!0}}),setup(_){const h=$(!0);function c(){const{onInternalAfterLeave:o,internalKey:d,onAfterLeave:t}=_;o&&o(d),t&&t()}function s(){const{onPositiveClick:o}=_;o?Promise.resolve(o()).then(d=>{d!==!1&&i()}):i()}function g(){const{onNegativeClick:o}=_;o?Promise.resolve(o()).then(d=>{d!==!1&&i()}):i()}function v(){const{onClose:o}=_;o?Promise.resolve(o()).then(d=>{d!==!1&&i()}):i()}function D(o){const{onMaskClick:d,maskClosable:t}=_;d&&(d(o),t&&i())}function S(){const{onEsc:o}=_;o&&o()}function i(){h.value=!1}function b(o){h.value=o}return{show:h,hide:i,handleUpdateShow:b,handleAfterLeave:c,handleCloseClick:v,handleNegativeClick:g,handlePositiveClick:s,handleMaskClick:D,handleEsc:S}},render(){const{handleUpdateShow:_,handleAfterLeave:h,handleMaskClick:c,handleEsc:s,show:g}=this;return le(ce,Object.assign({},this.$props,{show:g,onUpdateShow:_,onMaskClick:c,onEsc:s,onAfterLeave:h,internalAppear:!0,internalModal:!0}))}}),ge=ue("n-modal-provider"),gt=ue("n-modal-api"),bt=ue("n-modal-reactive-list"),kt={to:[String,Object]},wt=W({name:"ModalProvider",props:kt,setup(){const _=de(64),h=pe(),c=$([]),s={};function g(i={}){const b=Ie(),o=ke(Object.assign(Object.assign({},i),{key:b,destroy:()=>{var d;(d=s[`n-modal-${b}`])===null||d===void 0||d.hide()}}));return c.value.push(o),o}function v(i){const{value:b}=c;b.splice(b.findIndex(o=>o.key===i),1)}function D(){Object.values(s).forEach(i=>{i==null||i.hide()})}const S={create:g,destroyAll:D};return Y(gt,S),Y(ge,{clickedRef:de(64),clickedPositionRef:pe()}),Y(bt,c),Y(ge,{clickedRef:_,clickedPositionRef:h}),Object.assign(Object.assign({},S),{modalList:c,modalInstRefs:s,handleAfterLeave:v})},render(){var _,h;return le(be,null,[this.modalList.map(c=>{var s;return le(ht,Ee(c,["destroy"],{to:(s=c.to)!==null&&s!==void 0?s:this.to,ref:g=>{g===null?delete this.modalInstRefs[`n-modal-${c.key}`]:this.modalInstRefs[`n-modal-${c.key}`]=g},internalKey:c.key,onInternalAfterLeave:this.handleAfterLeave}))}),(h=(_=this.$slots).default)===null||h===void 0?void 0:h.call(_)])}}),xt=z("span",null,[f("报表统计的周期为： "),z("span",{class:"c-#1890ff"},"前一天"),f(" / "),z("span",{class:"c-#1890ff"},"上周周一至周日"),f(" / "),z("span",{class:"c-#1890ff"},"上个月"),f(" / "),z("span",{class:"c-#1890ff"},"上周周日至周六")],-1),Tt=W({name:"TaskModal",__name:"task_modal",props:ie({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:ie(["submitted"],["update:visible"]),setup(_,{expose:h,emit:c}){const s=_,g=c,v=we(_,"visible"),{formRef:D,validate:S,restoreValidation:i}=xe(),{defaultRequiredRule:b,patternRules:o}=je(),d=ze(()=>({add:"新增任务",edit:"编辑任务"})[s.operateType]),t=ke(E());function E(){return{id:void 0,rname:"",rtype:0,ttype:0,starttime:void 0,endtime:void 0,excute:1,stype:0,recipient:"",rdesc:"",tid:void 0}}const L={rname:b,starttime:b,cron:b,rtype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择实例"},ttype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择任务类型"},stype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择发送类型"},recipient:{required:!0,validator:Le,trigger:["input","change","blur","password-input"]}},N=$(""),B=async()=>{var C,x;const{data:y,error:u}=await Se((C=s.rowData)==null?void 0:C.tid);if(!u){const T=De(y==null?void 0:y.cronExpression);N.value=(x=JSON.parse(y==null?void 0:y.params))==null?void 0:x.uuid,t.starttime=T==null?void 0:T.settingTime}};function K(){Object.assign(t,E()),O.value=Be(),s.operateType==="edit"&&s.rowData&&(s.rowData.starttime=s.rowData.starttime.substring(11,19),Object.assign(t,s.rowData),B())}function P(){v.value=!1}const O=$(""),I=async y=>{const{data:u,error:C}=await et({beanName:"ReportTask",remark:O.value,cronExpression:y,params:JSON.stringify({rtype:t.rtype,ttype:t.ttype,uuid:O.value})});return C?!1:(await k(),!0)},k=async()=>{const{data:y,error:u}=await tt({uuid:O.value});t.tid=y};async function F(){var u,C;await S();const y=Ke(t.ttype==1||t.ttype==3?{dayOfWeek:t.excute,time:t.starttime}:null,t.ttype==2?{dayOfMonth:t.excute,time:t.starttime}:null,t.ttype==0?{time:t.starttime}:null);if(s.operateType==="add"){if(!await I(y))return!1}else{const{data:x,error:T}=await ot({id:t.tid,cronExpression:y,beanName:"ReportTask",status:1,params:JSON.stringify({rtype:t.rtype,ttype:t.ttype,uuid:N.value})});if(T)return!1}if(t.ttype==0&&delete t.excute,s.operateType==="add"){const{data:x,error:T}=await Xe({...t,starttime:Fe(1,new Date)});T||((u=window.$message)==null||u.success(A("common.addSuccess")),P(),g("submitted"))}else{delete t.starttime;const{data:x,error:T}=await Ye({...t});T||((C=window.$message)==null||C.success(A("common.updateSuccess")),P(),g("submitted"))}}const Q=y=>{t.excute=1};return Ae(v,()=>{v.value&&(K(),i())}),h({monthOption:me,weekOption:fe}),(y,u)=>{const C=Re,x=_e,T=qe,H=We,m=Ve,l=Ge,R=ct,j=_e,M=Ce,ne=Je,Z=G,oe=Ne,se=ce,r=ae("no-space");return U(),te(se,{show:v.value,"onUpdate:show":u[5]||(u[5]=p=>v.value=p),title:d.value,preset:"card",class:"w-600px"},{footer:a(()=>[e(oe,{justify:"end",size:16},{default:a(()=>[e(Z,{onClick:P},{default:a(()=>[f(w(n(A)("common.cancel")),1)]),_:1}),e(Z,{type:"primary",onClick:F},{default:a(()=>[f(w(n(A)("common.confirm")),1)]),_:1})]),_:1})]),default:a(()=>[e(ne,{class:"max-h-520px pr-20px"},{default:a(()=>[e(M,{ref_key:"formRef",ref:D,model:t,rules:L,"label-placement":"left","label-width":110,"require-mark-placement":"left"},{default:a(()=>[e(x,{label:"任务名称",path:"rname"},{default:a(()=>[J(e(C,{value:t.rname,"onUpdate:value":u[0]||(u[0]=p=>t.rname=p),placeholder:"请输入任务名称",clearable:""},null,8,["value"]),[[r]])]),_:1}),e(x,{label:"任务类型",path:"ttype"},{label:a(()=>[f(" 任务类型 "),e(T,{trigger:"hover",placement:"top-start"},{trigger:a(()=>[e(n(rt),{class:"text-xl cursor-pointer c-#7a7b78"})]),default:a(()=>[xt]),_:1})]),default:a(()=>[e(m,{value:t.ttype,"onUpdate:value":[u[1]||(u[1]=p=>t.ttype=p),Q],name:"radiogroup"},{default:a(()=>[(U(!0),Te(be,null,Pe(n(V)(n(Oe)),(p,X)=>(U(),te(H,{key:X,value:p.value},{default:a(()=>[f(w(p.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),[1,2,3].includes(t.ttype)?(U(),te(x,{key:0,label:t.ttype==2?"每月":"每周",path:"excute"},{default:a(()=>[e(l,{filterable:"",value:t.excute,"onUpdate:value":u[2]||(u[2]=p=>t.excute=p),placeholder:"请选择",options:t.ttype==2?n(me)():n(fe)(),style:{width:"100%"}},null,8,["value","options"])]),_:1},8,["label"])):Ue("",!0),e(j,{label:"执行时间",path:"starttime"},{default:a(()=>[e(R,{"formatted-value":t.starttime,"onUpdate:formattedValue":u[3]||(u[3]=p=>t.starttime=p),placeholder:"选择执行时间"},null,8,["formatted-value"])]),_:1}),e(x,{label:"任务描述",path:"rdesc"},{default:a(()=>[J(e(C,{type:"textarea",value:t.rdesc,"onUpdate:value":u[4]||(u[4]=p=>t.rdesc=p),placeholder:"请输入任务描述",clearable:""},null,8,["value"]),[[r]])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Rt=W({name:"TaskSearch",__name:"task_search",props:{model:{required:!0},modelModifiers:{}},emits:ie(["reset","search"],["update:model"]),setup(_,{emit:h}){const c=h,{formRef:s,restoreValidation:g}=xe(),v=we(_,"model");function D(){v.value.fuzzy=void 0,c("search")}async function S(){await g(),c("reset")}async function i(){c("search")}const b=pt.debounce(i,1e3,{leading:!0,trailing:!1});return(o,d)=>{const t=Re,E=mt,L=dt,N=G,B=ut,K=Ne,P=ft,O=Ce,I=re,k=ae("no-space");return U(),te(I,{bordered:!1,size:"small",class:"card-wrapper"},{default:a(()=>[e(O,{ref_key:"formRef",ref:s,model:v.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Qe(n(b),["enter"])},{default:a(()=>[e(P,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:a(()=>[e(E,{span:"24 s:12 m:10 l:6",label:"任务名称",path:"fuzzy"},{default:a(()=>[J(e(t,{value:v.value.fuzzy,"onUpdate:value":d[0]||(d[0]=F=>v.value.fuzzy=F),placeholder:"请输入任务名称关键字",clearable:"",onClear:D},null,8,["value"]),[[k]])]),_:1}),e(E,{span:"24 s:12 m:8 l:6"},{default:a(()=>[e(K,{class:"w-full"},{default:a(()=>[e(N,{onClick:S},{icon:a(()=>[e(L,{class:"text-icon"})]),default:a(()=>[f(" "+w(n(A)("common.reset")),1)]),_:1}),e(N,{type:"primary",ghost:"",onClick:n(b)},{icon:a(()=>[e(B,{class:"text-icon"})]),default:a(()=>[f(" "+w(n(A)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),Ct={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Nt=z("div",{style:{display:"flex","align-items":"center"}},[z("div",null,"报表任务")],-1),Yt=W({name:"reportmanagement_reporttask",__name:"index",setup(_){const h=He(),{columns:c,columnChecks:s,data:g,getData:v,loading:D,mobilePagination:S,searchParams:i,resetSearchParams:b}=st({apiFn:at,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"rname",title:"任务名称",align:"center",width:160},{key:"rtype",title:"实例类型",align:"center",width:160,render:m=>{var l;return e("div",null,[(l=V(ye).find(R=>R.value===m.rtype))==null?void 0:l.label])}},{key:"starttime",title:"任务执行时间",align:"center",width:160},{key:"operate",title:A("common.operate"),align:"center",width:160,render:m=>e("div",{class:"flex-center gap-8px"},[e(wt,null,{default:()=>[e(G,{type:"info",ghost:!0,size:"small",onClick:()=>F(m.id)},{default:()=>[f("详情")]})]}),J(e(G,{type:"warning",ghost:!0,size:"small",onClick:()=>C(m.id)},{default:()=>[f("修改")]}),[[ae("no-auth"),"sys.report.task.update"]]),e(_t,{onPositiveClick:()=>x(m.id)},{default:()=>"确定要删除改数据吗？",trigger:()=>J(e(G,{type:"error",ghost:!0,size:"small"},{default:()=>[f("删除")]}),[[ae("no-auth"),"sys.report.task.delete"]])})])}]}),{drawerVisible:o,operateType:d,editingData:t,handleAdd:E,handleEdit:L,checkedRowKeys:N,onBatchDeleted:B,onDeleted:K,closeDrawer:P}=lt(g,v),O=$(),I=$(!1),k=$({id:void 0,rname:"",rtype:0,ttype:0,starttime:void 0,endtime:void 0,excute:0,stype:0,recipient:"",rdesc:"",tid:void 0}),F=async m=>{I.value=!0;const{data:l,error:R}=await ve(m);R||(k.value=l,y(l.tid+""))},Q=$(""),y=async m=>{const{data:l,error:R}=await Se(m);if(!R){const j=De(l.cronExpression);Q.value=j.settingTime}},u=$();async function C(m){const{data:l,error:R}=await ve(m);R||(u.value=l),L(m)}function x(m){H(m,l=>{K()})}async function T(){H(N.value.join(","),m=>{B()})}async function H(m,l){const{data:R,error:j}=await nt(m);j||l&&l(R)}return(m,l)=>{const R=Me,j=Ze,M=vt,ne=yt,Z=re,oe=ce,se=re;return U(),Te("div",Ct,[e(Rt,{model:n(i),"onUpdate:model":l[0]||(l[0]=r=>ee(i)?i.value=r:null),onReset:n(b),onSearch:n(v)},null,8,["model","onReset","onSearch"]),e(se,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:a(()=>[Nt]),"header-extra":a(()=>[e(R,{columns:n(s),"onUpdate:columns":l[1]||(l[1]=r=>ee(s)?s.value=r:null),"disabled-delete":n(N).length===0,loading:n(D),onAdd:n(E),onRefresh:n(v),"is-view-add-button":n(he)("sys.report.task.insert"),isViewDeleteButton:n(he)("sys.report.task.delete"),onDelete:T},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","isViewDeleteButton"])]),default:a(()=>[e(j,{"checked-row-keys":n(N),"onUpdate:checkedRowKeys":l[2]||(l[2]=r=>ee(N)?N.value=r:null),columns:n(c),data:n(g),size:"small","flex-height":!n(h).isMobile,"scroll-x":962,loading:n(D),remote:"","row-key":r=>r.id,pagination:n(S),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),e(Tt,{ref_key:"TaskModalRef",ref:O,visible:n(o),"onUpdate:visible":l[3]||(l[3]=r=>ee(o)?o.value=r:null),"operate-type":n(d),"row-data":u.value,onSubmitted:n(v)},null,8,["visible","operate-type","row-data","onSubmitted"]),e(oe,{show:I.value,"onUpdate:show":l[4]||(l[4]=r=>I.value=r),preset:"card",class:"w-500px",title:"报表任务详情"},{default:a(()=>[e(Z,null,{default:a(()=>[e(ne,{"label-placement":"left",column:1,"label-style":{width:"100px",display:"inline-block",textAlign:"right",marginRight:"10px"}},{default:a(()=>[e(M,{label:"任务名称"},{default:a(()=>[f(w(k.value.rname),1)]),_:1}),e(M,{label:"实例"},{default:a(()=>{var r;return[f(w((r=n(V)(n(ye)).find(p=>p.value===k.value.rtype))==null?void 0:r.label),1)]}),_:1}),e(M,{label:"任务执行时间"},{default:a(()=>[f(w(k.value.starttime),1)]),_:1}),e(M,{label:"任务执行周期"},{default:a(()=>{var r,p,X;return[f(w((r=n(V)(n(Oe)).find(q=>q.value===k.value.ttype))==null?void 0:r.label)+" "+w(k.value.ttype==1?(p=O.value.weekOption().find(q=>q.value==k.value.excute))==null?void 0:p.label:k.value.ttype==2?(X=O.value.monthOption().find(q=>q.value==k.value.excute))==null?void 0:X.label:"")+" "+w(Q.value),1)]}),_:1}),e(M,{label:"发送类型"},{default:a(()=>{var r;return[f(w((r=n(V)(n(it)).find(p=>p.value===k.value.stype))==null?void 0:r.label),1)]}),_:1}),e(M,{label:"收件人"},{default:a(()=>[f(w(k.value.recipient),1)]),_:1}),e(M,{label:"描述"},{default:a(()=>[f(w(k.value.rdesc),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])]),_:1})])}}});export{Yt as default};
