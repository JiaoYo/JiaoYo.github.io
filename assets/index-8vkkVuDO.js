import{_ as ie}from"./round-search-Nrgthioa.js";import{d as te,r as k,a as U,Z as ae,i as le,dn as ce,b as D,o as f,e as p,z as A,a2 as ne,a1 as oe,g as E,t as L,cp as ue,ab as de,V as me,eN as ve,a3 as se,M as pe,a7 as Q,eO as fe,eP as ge,f as c,cE as ye,w as F,c as $,h as m,ac as he,N as be,A as ke,aw as we,a9 as ee,B as xe,$ as Fe,U as De,a0 as Te,c4 as _e}from"./index-BvFB2cuj.js";import{d as Me}from"./home-BXToz1zf.js";import{u as Ce}from"./usePageData-CTXHmZzP.js";import{N as K}from"./RadioButton-BdB-fRS6.js";import{N as J}from"./DatePicker-DpVzl5o9.js";const $e={class:"map-wrapper",style:{height:"100%",position:"relative"}},Ee={class:"map-legend"},Ae={class:"legend-list"},Se=["onClick","onContextmenu"],Oe={key:0,class:"visibility-icon"},Ne={key:1,class:"solo-icon"},Be={class:"legend-name"},je={class:"visibility-toggle"},Ue={key:0,class:"solo-notice"},ze=te({__name:"historyMap",props:{trackData:{}},setup(X){const d=k(null);let _=null;const V=X,T=k([]),u=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],a=k({}),g=k(""),M=U(()=>{const e={};return Object.keys(T.value).forEach((s,t)=>{e[s]=u[t%u.length],a.value[s]===void 0&&(a.value[s]=!0)}),e});function x(e){if(g.value){z(e);return}a.value[e]=!a.value[e],w()}function z(e){g.value===e?S():(g.value=e,Object.keys(a.value).forEach(l=>{a.value[l]=l===e}),w())}function S(){g.value="",Object.keys(a.value).forEach(e=>{a.value[e]=!0}),w()}function O(){Object.keys(a.value).forEach(e=>{a.value[e]=!a.value[e]}),g.value="",w()}function I(){Object.keys(a.value).forEach(e=>{a.value[e]=!0}),g.value="",w()}function W(){Object.keys(a.value).forEach(e=>{a.value[e]=!1}),g.value="",w()}const C=U(()=>{const e=[];return Object.values(T.value).forEach(l=>{e.push(...l)}),e.sort((l,s)=>new Date(l.dbtime).getTime()-new Date(s.dbtime).getTime())}),R=U(()=>{if(C.value.length===0)return[120.370086,30.305716];const e=C.value.map(r=>r.longitude),l=C.value.map(r=>r.latitude),s=(Math.min(...e)+Math.max(...e))/2,t=(Math.min(...l)+Math.max(...l))/2;return console.log(s,t),[s,t]});async function N(){const e="/map-sdk.json",{data:l}=await ve.get(`${e}?_t=${Date.now()}`);return l}function P(e){return new Promise((l,s)=>{if(window.AMap)return l(window.AMap);const t=document.createElement("script");t.src=`https://webapi.amap.com/maps?v=2.0&key=${e}&plugin=AMap.PolylineEditor`,t.defer=!0,t.onload=()=>window.AMap?l(window.AMap):s(new Error("AMapåŠ è½½å¤±è´¥")),t.onerror=()=>s(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(t)})}const h=k({});function B(e,l){const s=l.lng-e.lng,t=l.lat-e.lat;return Math.atan2(t,s)*180/Math.PI}function Y(e,l,s,t,r){const v=`
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                background: white; border-radius: 50%; width: 20px; height: 20px; 
                display: flex; align-items: center; justify-content: center; 
                font-size: 10px; font-weight: bold; color: ${t}; border: 2px solid ${t};">
      ${r}
    </div>
  `,i=document.createElement("div");return i.style.cssText=`
    position: relative;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  `,i.innerHTML=v,new e.Marker({position:[l.lng,l.lat],content:i,offset:new e.Pixel(-10,-10)})}function H(e,l,s,t,r){const v=document.createElement("div");return v.className="custom-marker",v.style.transform="translateX(-50%)",v.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${t}; box-shadow: 0 0 10px ${t}, 0 0 20px ${t};">
      <img src="${r||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png"}" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${t};">${s}</div>
  `,new e.Marker({position:[l.lng,l.lat],content:v})}function q(){d.value&&d.value.clearMap(),h.value={}}function w(){!window.AMap||!d.value||Object.keys(h.value).forEach(e=>{const l=a.value[e];(h.value[e]||[]).forEach(t=>{l?t.show():t.hide()})})}function n(e){q();const l={};Object.entries(T.value).forEach(([s,t])=>{l[s]=t.map(r=>({lng:r.longitude,lat:r.latitude,address:r.address,dbtime:r.dbtime,proname:r.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:r.duration||0,userimage:r.userimage,longitude:r.longitude,latitude:r.latitude}))}),Object.keys(l).forEach(s=>{const t=l[s];console.log(t,"sssasfas fasfadasd");const r=M.value[s];if(t.length===0)return;const v=[];if(t.length>1){const i=new e.Polyline({path:t.map(b=>[b.lng,b.lat]),strokeColor:r,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});i.setMap(d.value),v.push(i)}if(t.forEach((i,b)=>{console.log(s);const y=H(e,i,s,r,t[0].userimage);y.setMap(d.value),v.push(y),y.on("click",()=>{const j=`
        <div style="
          min-width: 220px;
          background: #fff;
          padding: 12px 14px;
          font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          font-size: 13px;
          color: #333;
          line-height: 1.6;
        ">
          <div style="
            font-weight: bold;
            color: ${r};
            font-size: 15px;
            margin-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 4px;
          ">${s}</div>

          <div style="margin-bottom: 4px;"><b style="color:#555;">åœ°ç‚¹ï¼š</b><span style="color:#333;">${i.address}</span></div>
          <div style="margin-bottom: 4px;"><b style="color:#555;">æ—¶é—´ï¼š</b><span style="color:#333;">${i.dbtime}</span></div>
          <div style="margin-bottom: 4px;"><b style="color:#555;">é¡¹ç›®ï¼š</b><span style="color:#333;">${i.proname}</span></div>
          <div style="margin-bottom: 4px;"><b style="color:#555;">ç»çº¬åº¦ï¼š</b><span style="color:#666; font-size:12px;">
        ${i.longitude} , ${i.latitude}
      </span></div>

          ${i.duration?`<div style="margin-bottom: 4px;"><b style="color:#555;">å·¥æ—¶ï¼š</b><span style="color:#333;">${i.duration} å°æ—¶</span></div>`:""}
          
          </div>
        `;_.setContent(j),_.open(d.value,y.getPosition())}),y.on("dblclick",()=>{_.open(d.value,y.getPosition()),d.value.setCenter(y.getPosition())})}),t.length>1)for(let i=1;i<t.length;i++){const b=t[i-1],y=t[i],j=(b.lng+y.lng)/2,G=(b.lat+y.lat)/2,re=B(b,y),Z=Y(e,{lng:j,lat:G},re,r,i);Z.setMap(d.value),v.push(Z)}h.value[s]=v}),w()}async function o(){try{const e=await N(),l=await P(e.AMAP_SDK_KEY);d.value=new l.Map("amap-container",{viewMode:"2D",center:R.value,zoom:5,features:["bg","point"]}),_=new l.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),n(l)}catch(e){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",e)}}return ae(()=>V.trackData??[],e=>{console.log(e,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),T.value=e,window.AMap&&d.value&&n(window.AMap)},{immediate:!0,deep:!0}),le(()=>{o()}),ce(()=>{d.value&&d.value.destroy()}),(e,l)=>(f(),D("div",$e,[l[1]||(l[1]=p("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),p("div",Ee,[p("div",{class:"legend-header"},[l[0]||(l[0]=p("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),p("div",{class:"legend-actions"},[p("button",{class:"action-btn",onClick:I},"å…¨æ˜¾"),p("button",{class:"action-btn",onClick:W},"å…¨éš"),p("button",{class:"action-btn",onClick:O},"åé€‰")])]),p("div",Ae,[(f(!0),D(ne,null,oe(M.value,(s,t)=>(f(),D("div",{key:t,class:de(["legend-item",{"legend-item-hidden":!a.value[t],"legend-item-solo":g.value===t}]),onClick:r=>x(t),onContextmenu:ue(r=>z(t),["prevent"])},[p("div",{class:"legend-color",style:me({backgroundColor:s})},[a.value[t]?A("",!0):(f(),D("span",Oe,"ğŸ‘ï¸â€ğŸ—¨ï¸")),g.value===t?(f(),D("span",Ne,"â­")):A("",!0)],4),p("span",Be,L(t),1),p("span",je,L(a.value[t]?"éšè—":"æ˜¾ç¤º"),1)],42,Se))),128))]),g.value?(f(),D("div",Ue,[E(" ä»…æ˜¾ç¤º: "+L(g.value)+" ",1),p("button",{class:"cancel-solo-btn",onClick:S},"å–æ¶ˆ")])):A("",!0)])]))}}),Pe=se(ze,[["__scopeId","data-v-6ace4abd"]]),Le={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ve=te({name:"trajectory_historytrajectory",__name:"index",setup(X){const d=pe();function _(n){return n.getFullYear()}function V(n){const o=new Date(n.getFullYear(),0,1),e=(n.getTime()-o.getTime())/864e5,l=o.getDay()||7;return Math.ceil((e+l)/7)}function T(){const n=new Date,o=_(n),e=V(n).toString().padStart(2,"0");return`${o}-${e}å‘¨`}const u=k("week"),a=k({dayTime:String(Q(0,null)),monthTime:String(Q(3,null)),weekTime:T(),startTime:null,endTime:null,dates:null,creater:null}),g=k([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),M=k("table"),x=k({}),z=U(()=>Object.keys(x.value||{}).map(n=>{var o,e;return{key:n,name:n,userimage:(e=(o=x.value[n])==null?void 0:o[0])==null?void 0:e.userimage}})),S=U(()=>{const n=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left",render(e){return c("div",{class:"text-blue-600 flex-col items-center font-medium"},[c(ye,{width:"80",height:"80","preview-disabled":!0,src:e.userimage||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png",class:"rounded-md object-cover"},null),c("span",null,[e.name])])}}];let o=[];switch(u.value){case"week":a.value.startTime&&a.value.endTime&&(o=ge(a.value.startTime,a.value.endTime).map(l=>O(l)));break;case"month":a.value.monthTime&&(o=fe(a.value.monthTime).map(l=>O(l)));break;case"day":default:a.value.dayTime&&(o=[O(a.value.dayTime)]);break}return[...n,...o]}),O=n=>({title:I(n),key:n,width:200,align:"center",render:o=>W(o.name,n)}),I=n=>{const o=new Date(n),e=o.getMonth()+1,l=o.getDate(),s=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][o.getDay()];return`${e}/${l} å‘¨${s}`},W=(n,o)=>{const l=(x.value[n]||[]).filter(s=>s.daytime===o);return l.length===0?c("div",{class:"text-gray-400 text-sm"},[E("æ— è®°å½•")]):c("div",{class:"text-left space-y-1"},[l.map((s,t)=>c("div",{key:t,class:"p-1 border-b border-gray-100 last:border-b-0"},[c("div",{class:"font-medium text-blue-600"},[s.proname]),c("div",{class:"text-xs text-gray-600"},[E("ğŸ“ "),s.address]),c("div",{class:"text-xs text-gray-500"},[E("ğŸ•’ "),s.dbtime]),c("div",{class:"text-xs text-green-600 font-bold"},[E("â±ï¸ "),s.duration?s.duration+"å°æ—¶":"æ— "])]))])},C=n=>{const o=n.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!o)return null;const e=Number(o[1]),l=Number(o[2]),s=new Date(e,0,1+(l-1)*7),t=s.getDay(),r=new Date(s);t<=4?r.setDate(s.getDate()-s.getDay()+1):r.setDate(s.getDate()+8-s.getDay());const v=new Date(r);v.setDate(r.getDate()+6);const i=b=>{const y=b.getFullYear(),j=String(b.getMonth()+1).padStart(2,"0"),G=String(b.getDate()).padStart(2,"0");return`${y}-${j}-${G}`};return{start:i(r),end:i(v)}},R=n=>{x.value={},u.value=n,P()},N=n=>{P(n),h()},P=n=>{switch(u.value){case"week":if(n){const o=C(n);o&&(a.value.startTime=o.start,a.value.endTime=o.end)}break;case"month":a.value.dates=n||a.value.monthTime;break;case"day":default:a.value.dates=n||a.value.dayTime;break}},h=async()=>{try{const n={};a.value.creater&&(n.creater=a.value.creater),u.value==="week"?(n.startTime=a.value.startTime,n.endTime=a.value.endTime):u.value==="month"?n.dates=a.value.monthTime:n.dates=a.value.dayTime;const{data:o,error:e}=await Me(n);e||(x.value=o)}catch(n){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",n)}},{pageData:B,getData:Y,nextPage:H}=Ce(_e),q=async n=>{const o=n.currentTarget,e=o.scrollTop;o.scrollTop+o.offsetHeight>=o.scrollHeight&&B.data.length<B.total&&(await H(),await Te(),setTimeout(()=>{o.scrollTop=e}))},w=async n=>{a.value.creater=n,h()};return ae([u,()=>a.value.dates],()=>{if(u.value=="week"&&a.value.weekTime){const n=C(a.value.weekTime);n&&(a.value.startTime=n.start,a.value.endTime=n.end),h()}else(u.value=="month"&&a.value.monthTime||u.value=="day"&&a.value.dayTime)&&h()},{immediate:!0}),le(()=>{a.value.weekTime=T(),Y({usertypes:"2,3"}),h()}),(n,o)=>{const e=we,l=ke,s=ie;return f(),D("div",Le,[c(m(De),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:F(()=>[c(m(be),{align:"center"},{default:F(()=>[o[6]||(o[6]=p("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),c(l,{label:"ç”¨æˆ·",path:"creater","label-placement":"left","show-feedback":!1},{default:F(()=>[c(e,{clearable:"",filterable:"",value:a.value.creater,"onUpdate:value":[o[0]||(o[0]=t=>a.value.creater=t),w],placeholder:"è¯·é€‰æ‹©","label-field":"username",size:"small","value-field":"id",options:m(B).data,onScroll:q},null,8,["value","options"])]),_:1}),c(m(ee),{value:u.value,"onUpdate:value":[o[1]||(o[1]=t=>u.value=t),R],size:"small"},{default:F(()=>[(f(!0),D(ne,null,oe(g.value,t=>(f(),$(m(K),{key:t.value,value:t.value,label:t.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),u.value==="day"?(f(),$(m(J),{key:0,size:"small","formatted-value":a.value.dayTime,"onUpdate:formattedValue":[o[2]||(o[2]=t=>a.value.dayTime=t),N],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):A("",!0),u.value==="week"?(f(),$(m(J),{key:1,size:"small","formatted-value":a.value.weekTime,"onUpdate:formattedValue":[o[3]||(o[3]=t=>a.value.weekTime=t),N],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):A("",!0),u.value==="month"?(f(),$(m(J),{key:2,size:"small","formatted-value":a.value.monthTime,"onUpdate:formattedValue":[o[4]||(o[4]=t=>a.value.monthTime=t),N],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):A("",!0),c(m(xe),{type:"primary",onClick:h,size:"small",class:"w-full sm:w-auto"},{icon:F(()=>[c(s,{class:"text-icon"})]),default:F(()=>[E(" "+L(m(Fe)("common.search")),1)]),_:1}),c(m(ee),{size:"small",value:M.value,"onUpdate:value":o[5]||(o[5]=t=>M.value=t),name:"radiobuttongroup1"},{default:F(()=>[c(m(K),{value:"table",label:"è¡¨æ ¼"}),c(m(K),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:F(()=>[M.value=="table"?(f(),$(m(he),{key:0,columns:S.value,data:z.value,size:"small","flex-height":!m(d).isMobile,"scroll-x":S.value.reduce((t,r)=>t+r.width,0),remote:"","row-key":t=>t.key,class:"h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","row-key"])):(f(),$(Pe,{key:1,trackData:x.value},null,8,["trackData"]))]),_:1})])}}}),Ge=se(Ve,[["__scopeId","data-v-7b93b868"]]);export{Ge as default};
