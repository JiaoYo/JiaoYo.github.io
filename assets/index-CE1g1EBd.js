import{_ as Ia}from"./table-column-setting.vue_vue_type_script_setup_true_lang-DR_-APvx.js";import{_ as Jt}from"./round-delete-DqVens2M.js";import{_ as Na}from"./round-add-CRyZaE6z.js";import{d as at,aE as Ze,m as Vt,r as Ee,H as y,n as qt,$ as D,ae as r,x as G,b2 as We,B as g,cA as $a,cr as La,cy as Ua,cz as $t,b8 as Lt,aD as je,aN as Ut,f as a,g as v,cT as Aa,cU as ja,cS as Ta,cP as Fa,a as Oa,aG as ft,aC as et,bY as Gt,b as Xe,o as T,T as At,bi as Ea,w as n,bg as Ma,C as Kt,A as Ht,c as X,s as _e,h as i,bh as Re,e as j,I as Ra,cJ as jt,U as Ba,N as le,aH as mt,t as M,a0 as Yt,cR as Qt,cF as Xt,dQ as Ja,aI as Tt,aJ as ct,dI as Zt,dV as Ft,dW as Va,dX as Ot,dY as qa,cq as Ga,dZ as Ka,d_ as Ha,cQ as Ya,dK as Et,dF as Mt,aO as dt,dR as Qa,cX as Xa,cZ as Za,dJ as Wa,cB as es,cI as ts,dL as as,dG as ss,dH as ls,aQ as ns,dE as is,dM as os,d$ as rs,bd as ds,Y as gt,aM as tt,a4 as Wt,aS as us,M as cs,L as ps,i as fs,q as Ye,aT as Qe,y as Me,aU as ms,aK as gs,e0 as vs,cs as hs,aY as ys}from"./index-CcQeCAU2.js";import{u as pt,a as _s}from"./table-BCI5iDb3.js";import{_ as bs}from"./round-plus-C5uNZN3w.js";import{_ as ks,a as xs,A as Ss}from"./index-DjijAwZ8.js";import{g as vt,h as Cs,i as ea,p as ws,f as Ds}from"./business-BQT3wlae.js";import{u as Rt}from"./usePageData-BOHG_mYN.js";import{h as ut}from"./permission-C-eJ4dt4.js";import{N as be}from"./Popconfirm-ChYgVziE.js";import{N as zs}from"./Cascader-FhvsJTH3.js";import{_ as ta}from"./Grid-fZ6d61Oc.js";import{_ as aa}from"./FormItemGridItem-ChLVyUt0.js";import{_ as Ps}from"./round-search-DoegYRZG.js";import{_ as Is}from"./round-refresh-DedALtP7.js";import{N as Ns}from"./DatePicker-Cc9xllGV.js";import{N as $s}from"./RadioButton-MvTqynOM.js";const Ls={class:"w-100%"},Us={class:"flex"},As={style:{display:"flex","flex-direction":"column",width:"100%"}},js={class:"flex items-center"},Ts={class:"w-100%"},Fs={class:"w-100px"},Os={style:{display:"flex","flex-direction":"column"}},Es={style:{display:"flex","flex-direction":"column"}},Ms={style:{display:"flex","flex-direction":"column"}},Rs=at({name:"OperateDrawer",__name:"operate-drawer",props:Ze({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:Ze(["submitted"],["update:visible"]),setup(K,{emit:ne}){const _=Vt(),te=ne,R=Ee({contactList:[],debuggedDevieceList:[]}),p=K,d=Ee(ie());function ie(){return{proname:"",dispatchIds:[],contractIds:[],proaddr:"",cpdbtime:null,prosite:"",longitude:120.373885,latitude:30.303899,period:void 0,dtype:void 0,dispatch:"",status:1}}const P=y(0),ae=y(void 0);async function de(){C.value=[{longitude:120.373885,latitude:30.303899,addr:""}],Object.assign(d,ie()),Sa(),p.operateType==="edit"&&p.rowData&&(await Promise.all([wa(),Te(),Ce(),x(),ht(),Ke()]),Object.assign(d,p.rowData),P.value=d.period,ae.value=d.status,await Dt(),Pt(d.proaddr||d.prosite),ya())}const{formRef:$,validate:B,restoreValidation:b}=qt(),z={proname:{type:"string",required:!0,trigger:["blur","change"],message:"请输入项目名称"},status:{type:"number",required:!0,trigger:["blur","change"],message:"请选择项目状态"},contractIds:{type:"array",required:!0,trigger:["blur","change"],message:"请选择合同"},dtype:{type:"number",required:!0,trigger:["blur","change"],message:"请选择调试类型"},period:{type:"number",required:!0,trigger:["blur","change"],message:"请输入周期"},prosite:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请选择项目地点"},cpdbtime:{type:"string",required:!0,trigger:["blur","change"],message:"请选择时间"}},h=y([]),L=Ee({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",pageSizes:[20],prefix:()=>`共 ${h.value.length} 条`,onChange:e=>{L.page=e,x()},onUpdatePageSize:e=>{L.pageSize=e,L.page=1,x()}}),F=[{title:"对接方",key:"docker",align:"center",width:150,render(e,t){return e.setStatus?r(G,{value:e.docker,placeholder:"请输入",onUpdateValue(s){h.value[t].docker=s}}):r("div",{},e.docker)}},{title:"姓名",key:"pname",align:"center",width:100,render(e,t){return e.setStatus?r(G,{value:e.pname,placeholder:"请输入姓名",onUpdateValue(s){h.value[t].pname=s}}):r("div",{},e.pname)}},{title:"联系方式",key:"pcontact",align:"center",width:150,render(e,t){return e.setStatus?r(G,{value:e.pcontact,placeholder:"请输入联系方式",onUpdateValue(s){h.value[t].pcontact=s}}):r("div",{},e.pcontact)}},{title:"备注",key:"proposition",align:"center",width:150,render(e,t){return e.setStatus?r(G,{value:e.proposition,placeholder:"请输入备注",onUpdateValue(s){h.value[t].proposition=s}}):r("div",{},e.proposition)}},{title:"操作人",width:100,key:"username",align:"center"},{title:"操作时间",key:"dbtime",width:180,align:"center",render:e=>e.dbtime?We(1,e.dbtime):""},{key:"operate",title:D("common.operate"),align:"center",width:160,fixed:"right",render(e,t){return r("div",{class:"flex-center gap-8px"},[e.setStatus?[r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>ke(e)},{default:()=>"保存"}),r(g,{type:"default",ghost:!0,size:"small",onClick:()=>Z(e,t)},{default:()=>"取消"}),r(be,{onPositiveClick:()=>{p.operateType==="edit"&&e.id?$a(e.id).then(()=>{var s;h.value.splice(t,1),(s=window.$message)==null||s.success("删除成功")}):h.value.splice(t,1)}},{default:()=>D("common.confirmDelete"),trigger:()=>r(g,{type:"error",ghost:!0,size:"small"},{default:()=>D("common.delete")})})]:r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>J(e)},{default:()=>"编辑"})])}}],x=async()=>{var t;const{data:e}=await La({page:L.page,limit:L.pageSize,pid:(t=p.rowData)==null?void 0:t.id});h.value=e==null?void 0:e.list,h.value.forEach(s=>{s.setStatus=!1}),R.contactList=JSON.parse(JSON.stringify(h.value))},J=e=>{h.value.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus},Z=(e,t)=>{e.setStatus=!e.setStatus,e.id?h.value=JSON.parse(JSON.stringify(R.contactList)):h.value.splice(t,1)},ke=async e=>{var t,s,o,u,c;if(!e.pname){(t=window.$message)==null||t.warning("请输入联系人姓名");return}if(!e.pcontact){(s=window.$message)==null||s.warning("请输入联系方式");return}if(p.operateType==="edit")if(e.id){const{data:w,error:k}=await Ua([e]);k||((o=window.$message)==null||o.success("修改成功"),x(),e.setStatus=!e.setStatus)}else{const{data:w,error:k}=await $t([{...e,pid:(u=p.rowData)==null?void 0:u.id}]);k||((c=window.$message)==null||c.success("添加成功"),x(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function xe(){var e;((e=h.value[0])!=null&&e.pname||h.value.length==0)&&h.value.unshift({pname:"",pcontact:"",proposition:"",setStatus:!0})}const O=e=>{var t;d.contractIds=e,E.value=Ge.data.filter(s=>e.includes(s.id)).map(s=>({value:s.id,label:s.contractname,isLeaf:!1})),Ie((t=E.value[0])==null?void 0:t.id)},E=y([]),Te=async()=>{var s;const{data:e,error:t}=await Qt({page:1,limit:100,id:p.rowData.id});E.value=e==null?void 0:e.list.map(o=>({value:o.id,label:o.contractname,isLeaf:!1})),Ie((s=e==null?void 0:e.list[0])==null?void 0:s.id)},U=y([]),ue=y(),{pageData:ce,getData:st}=Rt(Xt),Ie=async e=>{await st({pids:e}),ue.value=[],U.value=Array.from(new Set([...U.value,...ce.data])),ue.value=ce.data.map(t=>({label:t.devname,value:t.id}))},Be=async e=>{var t;await Ie(e.value),e.children=(t=ue.value)==null?void 0:t.map(s=>({label:s.label,value:s.value,isLeaf:!0}))},l=y([]),m=Ee({page:1,pageSize:20,itemCount:0,showSizePicker:!0,fuzzy:"",pageSizes:[10,20],prefix:()=>`共 ${m.itemCount} 条`,onChange:e=>{m.page=e,Ce()},onUpdatePageSize:e=>{m.pageSize=e,m.page=1,Ce()}}),oe=y(),pe=[{title:"绑定合同设备",key:"cid",width:300,align:"center",render(e,t){var s,o;return e.setStatus?r(zs,{style:"width: 270px",value:e.cid,filterable:!0,placeholder:"请选择合同设备",options:E.value,checkStrategy:"child",showPath:!1,remote:!0,renderSuffix:u=>u.option.hidden?null:u.node,renderLabel:u=>u.hidden?null:u.label,onLoad:Be,onUpdateValue(u){var w;l.value[t].cid=Number(u)||0;const c=(w=U.value)==null?void 0:w.find(k=>k.id==u);e.devname=(c==null?void 0:c.devname)||"",e.devnum=(c==null?void 0:c.devcount)||"",e.notes=(c==null?void 0:c.notes)||"",oe.value=(c==null?void 0:c.devcount)||0,e.etype=(c==null?void 0:c.devtype)||0,e.devmanu=(c==null?void 0:c.devmanu)||"",e.devmodel=(c==null?void 0:c.devmodel)||"",e.devunit=(c==null?void 0:c.devunit)||""}}):r("div",{},e.devname2||((o=(s=ue.value)==null?void 0:s.find(u=>u.value==e.cid))==null?void 0:o.label))}},{title:"设备名称",key:"devname",width:200,align:"center",render(e,t){return e.setStatus?r(G,{value:e.devname,placeholder:"请输入",onUpdateValue(s){l.value[t].devname=s}}):r("div",{},e.devname)}},{title:"型号",key:"devmodel",width:220,align:"center",render(e,t){return r("div",{},e.devmodel)}},{title:"设备单位",key:"devunit",width:120,align:"center",render(e,t){return r("div",{},e.devunit)}},{title:"数量",key:"devnum",width:100,align:"center",render(e,t){return e.setStatus?r(Lt,{value:e.devnum,placeholder:"请输入",max:oe.value,onUpdateValue(s){l.value[t].devnum=s}}):r("div",{},e.devnum)}},{title:"是否为我司设备",key:"etype",width:260,align:"center",render(e,t){return r("div",{},e.etype==0?"是":"否")}},{title:"设备厂家",key:"devmanu",width:200,align:"center",render(e,t){return r("div",{},e.devmanu)}},{title:"清点状态",key:"status",width:120,align:"center",render(e,t){return e.setStatus&&e.id?r(je,{value:e.status,filterable:!0,placeholder:"请选择状态",options:[{label:"未清点",value:0},{label:"正常",value:1},{label:"增补",value:2},{label:"退货",value:3},{label:"换货",value:4}],onUpdateValue(s){l.value[t].status=Number(s)||0}}):r("div",{},e.status===0?"未清点":e.status===1?"正常":e.status===2?"增补":e.status===3?"退货":"换货")}},{title:"备注",key:"notes",width:200,align:"center",render(e,t){return r("div",{},e.notes)}},{title:"文件",key:"re1",width:160,align:"center",render(e,t){return e.setStatus?r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>lt(e,"debuggedDevieceList",t)},{default:()=>"上传文件"}):r(Ut,{trigger:"hover"},{trigger:()=>r("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const s=[{alias:e.re1,file:e.fl1},{alias:e.re2,file:e.fl2},{alias:e.re3,file:e.fl3},{alias:e.re4,file:e.fl4}].filter(o=>o.alias||o.file);return s.length===0?r("div",{style:"padding: 10px; color: #999;"},"暂无文件"):r("div",{style:"padding: 10px;"},[r("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[r("thead",[r("tr",[r("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),r("th",{style:"text-align:center; padding: 4px 8px;"},"文件"),r("th",{style:"text-align:center; padding: 4px 8px;"},"操作")])]),r("tbody",s.map((o,u)=>{var c;return r("tr",[r("td",{style:"text-align:center; padding: 4px 8px;"},o.alias||"-"),r("td",{style:"text-align:center; padding: 4px 8px;"},((c=o.file)==null?void 0:c.split("?")[1])||"-"),r("td",{style:"text-align:center; padding: 4px 8px;"},r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>yt({url:o.file})},{default:()=>"下载"}))])}))])])}})}},{title:"操作信息",key:"dbtime",width:180,align:"center",render(e,t){return r(Ut,{trigger:"hover"},{trigger:()=>r("div",{style:"color: #1890ff;cursor: pointer;"},e.dbtime?We(1,e.dbtime):""),default:()=>r("div",{style:"padding: 10px;"},a("div",null,[a("div",null,[v("操作人："),e.username]),a("div",null,[v("操作时间："),e.dbtime]),a("div",null,[v("清点人："),e.dusername]),a("div",null,[v("清点时间："),e.ddbtime])]))})}},{key:"operate",title:D("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return r("div",{class:"flex-center gap-8px"},[e.setStatus?[r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>sa(e)},{default:()=>"保存"}),r(g,{type:"default",ghost:!0,size:"small",onClick:()=>it(e,t)},{default:()=>"取消"}),ut("project:Equipment:delete")&&r(be,{onPositiveClick:async()=>{var s;if(e.id){const{data:o,error:u}=await Aa(e.id);o&&(l.value.splice(t,1),(s=window.$message)==null||s.success("删除成功"))}else l.value.splice(t,1)}},{default:()=>D("common.confirmDelete"),trigger:()=>r(g,{type:"error",ghost:!0,size:"small"},{default:()=>D("common.delete")})})]:ut("project:Equipment:update")&&r(g,{type:"primary",ghost:!0,size:"small",onClick:()=>A(e)},{default:()=>"编辑"})])}}],I=y([]),Se=y(!1),fe=y(""),Ne=y(),lt=(e,t,s)=>{I.value=[],Se.value=!0,fe.value=t,Ne.value=s,e.re1&&I.value.push({id:"",name:e.re1,url:e.fl1,status:"uploading",setStatus:!1,progress:0}),e.re2&&I.value.push({id:"",name:e.re2,url:e.fl2,status:"uploading",setStatus:!1,progress:0}),e.re3&&I.value.push({id:"",name:e.re3,url:e.fl3,status:"uploading",setStatus:!1,progress:0}),e.re4&&I.value.push({id:"",name:e.re4,url:e.fl4,status:"uploading",setStatus:!1,progress:0})},nt=async()=>{var t,s;let e=!0;for(let o=0;o<I.value.length;o++){const u=I.value[o];if(!u.url){(t=window.$message)==null||t.warning(`第${o+1}个文件的文件名称不能为空`),e=!1;break}if(!u.name){(s=window.$message)==null||s.warning(`第${o+1}个文件的文件别名不能为空`),e=!1;break}l.value[Ne.value][`re${o+1}`]=u.name,l.value[Ne.value][`fl${o+1}`]=u.url}e&&(Se.value=!1,fe.value="",Ne.value=void 0)},Ce=async()=>{var t;const{data:e}=await ja({page:m.page,limit:m.pageSize,fuzzy:m.fuzzy,pid:(t=p.rowData)==null?void 0:t.id});l.value=e.list,R.debuggedDevieceList=JSON.parse(JSON.stringify(l.value))},A=async e=>{var o;console.log(ce.data,e.cid,"ssssssssssssssss"),l.value.forEach(u=>{u.setStatus=!1});const{data:t,error:s}=await Ta(e.cid);s||(((o=E.value[E.value.length-1])==null?void 0:o.value)!=t.id&&E.value.push({value:t.id,label:t.devname,disabled:!0,isLeaf:!0,hidden:!0}),oe.value=t.devcount||0),e.setStatus=!e.setStatus},it=(e,t)=>{e.setStatus=!e.setStatus,e.id?l.value=JSON.parse(JSON.stringify(R.debuggedDevieceList)):l.value.splice(t,1)},sa=async e=>{var t,s,o,u,c;if(!e.cid){(t=window.$message)==null||t.warning("请选择合同设备");return}if(!e.devname){(s=window.$message)==null||s.warning("设备名称不能为空");return}if(!e.devmodel){(o=window.$message)==null||o.warning("设备型号不能为空");return}if(!e.devnum){(u=window.$message)==null||u.warning("设备数量不能为空");return}if(e.id){const{data:w,error:k}=await Fa([e]);k||((c=window.$message)==null||c.success("修改成功"),Ce(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function la(){var e;((e=l.value[0])!=null&&e.devname||l.value.length==0)&&l.value.unshift({status:void 0,devmanu:"",etype:0,devname:"",devmodel:"",devnum:0,notes:"",setStatus:!0})}const na=()=>{Se.value=!1},ia=y({}),se=y([]);async function ht(){var t;se.value=[];const{data:e}=await Ja({page:1,limit:100,pid:(t=p.rowData)==null?void 0:t.id});e.list.forEach(s=>{s.sort==1&&se.value.push({id:s.id,name:s.filename,url:s.file,status:"finished",creator:s.username,dbtime:s.dbtime})}),se.value.reverse(),ia.value=JSON.parse(JSON.stringify(e))}const oa=[{title:"文件别名",key:"name",align:"center",width:200,render(e){return e.setStatus?r(G,{value:e.name,onUpdateValue:t=>{e.name=t}}):r("div",{},e.name)}},{title:"文件名称",key:"filename",align:"center",width:200,render(e){return e.setStatus&&!e.url?r("div",{style:"display: flex; justify-content: center; align-items: center;"},[r(Tt,{action:"#",showFileList:!1,customRequest:async({file:s,onFinish:o,onError:u})=>{var c,w;try{e.status=!0;const{data:k,error:V}=await rs(s.file,W=>{e.progress=W});k&&(e.url=k,e.status=!1)}catch(k){console.error(k),(w=(c=window.$message)==null?void 0:c.error)==null||w.call(c,"文件上传出错"),e.status=!1}}},{default:()=>r(g,{type:"info",size:"small",ghost:!0,loading:e.status},{default:()=>"上传文件"})}),e.progress?r(ct,{type:"line",percentage:e.progress,indicatorPlacement:"inside",processing:!0}):null]):e.setStatus&&e.url&&!e.id?a("span",null,[e.url.split("?")[1],v(" "),a("span",{onClick:()=>{e.url="",e.progress=0},style:"color: red;cursor: pointer;font-size: 12px;"},[v("删除")])]):r("div",{},e.url.split("?")[1])}},{title:"上传人",key:"creator",align:"center",width:100,render(e){return r("div",{},e.creator)}},{title:"上传时间",key:"dbtime",align:"center",width:200,render(e){return r("div",{},e.dbtime?e.dbtime:"")}},{title:"操作",key:"actions",align:"center",width:180,render(e){return r(le,{justify:"center"},[!e.setStatus&&e.id&&r(g,{type:"info",size:"small",ghost:!0,onClick:()=>{yt(e)}},{default:()=>"下载"}),e.setStatus&&r(g,{type:"info",size:"small",ghost:!0,onClick:()=>{ca(e)}},{default:()=>"保存"}),e.setStatus&&r(g,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"取消"}),!e.setStatus&&r(g,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"编辑"}),ut("project:File:delete")&&(_.userInfo.usertype==0||_.userInfo.usertype==2)&&r(be,{onPositiveClick:async()=>{var t;if(e.id){const{data:s,error:o}=await ss(e.url),{data:u,error:c}=await ls(e.id);c||(t=window.$message)==null||t.success("删除成功")}else se.value=se.value.filter(s=>s!==e)}},{default:()=>D("common.confirmDelete"),trigger:()=>r(g,{type:"error",ghost:!0,size:"small"},{default:()=>D("common.delete")})})])}}],ra=[{title:"文件名称",key:"filename",align:"center",render(e){if(!e.url){const t=async({file:o,onFinish:u,onError:c})=>{var w,k;try{e.status=!0;const V=await ns(o.file,o.name,"",W=>{e.progress=W});V&&(e.url=V,e.name=o.name,e.status=!1)}catch(V){console.error(V),(k=(w=window.$message)==null?void 0:w.error)==null||k.call(w,"文件上传出错"),e.status=!1}};async function s(o){var u;return o.file.file.size>100*1024*1024?((u=window.$message)==null||u.error("文件大小不能超过100M"),!1):!0}return r("div",{style:"display: flex; justify-content: center; align-items: center;"},[r(Tt,{action:"#",showFileList:!1,customRequest:t,onBeforeUpload:s},{default:()=>r(g,{type:"info",size:"small",ghost:!0,loading:e.status},{default:()=>"上传文件"})}),e.progress?r(ct,{type:"line",percentage:e.progress,indicatorPlacement:"inside",processing:!0}):null])}return e.url&&!e.id?a("span",null,[e.url.split("?")[1],v(" "),a("span",{onClick:()=>{e.url="",e.progress=0,e.status=!1},style:"color: red;cursor: pointer;font-size: 12px;"},[v("删除")])]):r("div",{},e.url.split("?")[1])}},{title:"文件别名",key:"name",align:"center",render(e){return r(G,{value:e.name,onUpdateValue:t=>{e.name=t}})}},{title:"操作",key:"actions",align:"center",width:100,render(e){return r(le,{justify:"center"},[r(g,{type:"error",size:"small",ghost:!0,onClick:()=>{I.value=I.value.filter(t=>t!==e)}},{default:()=>"删除"})])}}];async function yt(e){if(e!=null&&e.url)try{const s=await(await fetch(e.url.split("?")[0],{mode:"cors"})).blob(),o=URL.createObjectURL(s),u=document.createElement("a");u.href=o,u.download=e.url.split("?")[1],u.style.display="none",document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(o)}catch(t){console.error("下载失败:",t)}}const da=()=>{var e,t;if(I.value.length>=4)return(t=(e=window.$message)==null?void 0:e.warning)==null?void 0:t.call(e,"最多上传4个文件");I.value.push({id:"",name:"",url:"",status:!1,setStatus:!0,progress:0})},ua=()=>{se.value.push({id:"",name:"",url:"",status:!1,setStatus:!0})},ca=async e=>{var t,s,o,u,c,w,k,V,W,ze,Pe,he;if(!e.name){(s=(t=window.$message)==null?void 0:t.warning)==null||s.call(t,"请输入文件别名");return}if(!e.url){(u=(o=window.$message)==null?void 0:o.warning)==null||u.call(o,"请上传文件");return}if((c=p.rowData)!=null&&c.id){const{data:H,error:f}=await Mt([{pid:(w=p.rowData)==null?void 0:w.id,filename:e.name,file:e.url,sort:1}]);if(f)return(k=window.$message)==null?void 0:k.error("保存文件记录失败");(V=window.$message)==null||V.destroyAll(),e.setStatus=!e.setStatus,ht(),(W=window.$message)==null||W.success("保存成功")}else if(e.id){const{data:H,error:f}=await is([{id:e.id,filename:e.name}]);if(f)return(ze=window.$message)==null?void 0:ze.error("保存文件记录失败");(Pe=window.$message)==null||Pe.destroyAll(),e.setStatus=!e.setStatus,(he=window.$message)==null||he.success("编辑成功")}else e.setStatus=!e.setStatus},pa=Oa(()=>({add:"新增项目",edit:"修改项目"})[p.operateType]),$e=ft(K,"visible");et($e,()=>{$e.value&&(de(),setTimeout(()=>{const e=document.querySelector(".n-scrollbar-content");e==null||e.scrollTo(0,0)},300),b())});function fa(e){e||we()}function we(){$e.value=!1}async function _t(){var e;await B(),(e=window.$dialog)==null||e.info({title:"提示",content:"确定提交吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await ma()}})}async function ma(){var e,t,s,o,u,c,w,k,V,W,ze,Pe,he;if(p.operateType==="edit"){const H=JSON.parse(JSON.stringify(d));P.value==H.period&&delete H.period,ae.value==H.status&&delete H.status;const{data:f,error:Y}=await Zt([H]);if(!Y){let q=function(re,ee){const Q=re.filter(ye=>!ee.includes(ye)),Ue=ee.filter(ye=>!re.includes(ye));return{toDelete:Q,toAdd:Ue}};if((e=d.dispatchIds)!=null&&e.length&&((t=d.dispatchIds)==null?void 0:t.length)>0){const{toDelete:re,toAdd:ee}=q(Ct.value,d.dispatchIds);if(ee.length>0){const Q=ee.map(He=>({pid:d.id,did:He})),{data:Ue,error:ye}=await Ft(Q)}if(re.length>0){const{data:Q,error:Ue}=await Va(re.join(","))}}if((s=d.contractIds)!=null&&s.length&&((o=d.contractIds)==null?void 0:o.length)>0){const{toDelete:re,toAdd:ee}=q(It.value,d.contractIds);if(ee.length>0){const Q=ee.map(He=>({pid:d.id,did:He})),{data:Ue,error:ye}=await Ot(Q)}if(re.length>0){const{data:Q,error:Ue}=await qa(re.join(","))}}we(),te("submitted"),(u=window.$message)==null||u.success("修改成功")}}else{const H=Ga(),{data:f,error:Y}=await Ka([{...d,uuid:H}]);if(!Y){const{data:q,error:re}=await Ha(H);if(q){let ee=function(N,Ae,Nt){return N.map(Oe=>({...Oe,pid:Ae}))};if(d.dispatchIds&&d.dispatchIds.length>0){const N=[];(c=d.dispatchIds)==null||c.forEach(Oe=>{N.push({pid:q,did:Oe})});const{data:Ae,error:Nt}=await Ft(N)}if(d.contractIds&&d.contractIds.length>0){const N=[];(w=d.contractIds)==null||w.forEach(async Oe=>{N.push({proid:q,conid:Oe})});const{data:Ae,error:Nt}=await Ot(N)}const Q=[];if(h.value.length>0){const N=ee(h.value,q);Q.push($t(N))}if(l.value.length>0){const N=ee(l.value,q);Q.push(Ya(N))}if(C.value.length>0&&Q.push(Et(C.value)),(await Promise.allSettled(Q)).forEach((N,Ae)=>{N.status==="fulfilled"?console.log(`第 ${Ae+1} 个请求成功`,N.value):console.error(`第 ${Ae+1} 个请求失败`,N.reason)}),!se.value.length){(k=window.$message)==null||k.destroyAll(),(V=window.$message)==null||V.success("操作成功"),we(),te("submitted");return}const ye=[];se.value.forEach(N=>{ye.push({pid:q,filename:N.name,file:N.url,sort:1})});const{data:He,error:Pa}=await Mt(ye);Pa&&((W=window.$message)==null||W.error("保存文件记录失败")),(ze=window.$message)==null||ze.destroyAll(),(Pe=window.$message)==null||Pe.success("操作成功"),we(),te("submitted")}}we(),te("submitted"),(he=window.$message)==null||he.success("添加成功")}}const De=y(!1),ot=y();let Le=null,bt=null,Je=null,kt=null,me=null;const ge=Ee({longitude:0,latitude:0});let Fe;const Ve=y(!1),ve=y(""),qe=y([]);async function ga(){window._AMapSecurityConfig={securityJsCode:_.userInfo.sdksecret},ot.value&&(me=await Ss.load({key:_.userInfo.sdkkey,version:"2.0",plugins:["AMap.Scale","AMap.PlaceSearch","AMap.AutoComplete","AMap.Geocoder","AMap.Geolocation"]}),Le=new me.Map(ot.value,{zoom:18,center:[S.value>0?C.value[S.value-1].longitude:d.longitude,S.value>0?C.value[S.value-1].latitude:d.latitude],viewMode:"3D",resizeEnable:!0}),bt=new me.Geocoder,new me.PlaceSearch({city:"全国",pageSize:50}),kt=new me.AutoComplete({city:"全国"}),rt(me,{lng:S.value>0?C.value[S.value-1].longitude:d.longitude,lat:S.value>0?C.value[S.value-1].latitude:d.latitude}),Le.on("click",e=>{const{lng:t,lat:s}=e.lnglat;Fe=2,ge.latitude=s,ge.longitude=t,rt(me,{lng:t,lat:s})}),dt(()=>window.dispatchEvent(new Event("resize"))))}const xt=Gt.debounce(async e=>{if(!Ve.value||!e.trim()){qe.value=[];return}kt.search(e,(t,s)=>{var o;console.log(s,"result"),t=="complete"&&s.info=="OK"&&((o=s==null?void 0:s.tips)!=null&&o.length)?qe.value=s.tips.map(u=>({label:`${u.name}（${u.district||u.address||"无详细地址"}）`,value:`${u.location.lng}_${u.location.lat}`,raw:u})):qe.value=[]})},300);et(ve,e=>{xt(e)});function va(e,t){if(console.log(e,t,"option"),!e)return;const[s,o]=e.split("_").map(Number);!s||!o||(Le.setCenter([s,o]),Fe=1,rt(me,{lng:s,lat:o}),ge.longitude=s,ge.latitude=o)}const S=y(0);function St(e){e?S.value=e:S.value=0,De.value=!0,Ve.value=!1,Fe=void 0,dt(async()=>{await ga(),setTimeout(()=>{Ve.value=!0;const t=document.querySelector(".n-auto-complete input");t==null||t.blur()},500)})}function rt(e,t){Je&&Le.remove(Je),Je=new e.Marker({position:[t.lng,t.lat],map:Le}),Le.add(Je),bt.getAddress(t,(s,o)=>{s==="complete"&&o.regeocode&&(console.log("result",o),console.log("formattedAddress",o.regeocode.formattedAddress),t.latitude=t.lat,t.longitude=t.lng,Fe==1||(Fe==2?ve.value=o.regeocode.formattedAddress:ve.value=S.value>0?C.value[S.value-1].addr||o.regeocode.formattedAddress:d.prosite||o.regeocode.formattedAddress))})}function ha(e,t){if(!t)return null;const s=t.replace(/省|市|特别行政区|自治区|壮族|回族|维吾尔/g,"").trim(),o=e.find(u=>t.includes(u.name)||u.name.includes(s));return o?o.id:null}const Ct=y([]),ya=async()=>{const{data:e,error:t}=await Qa({page:1,limit:100,pid:p.rowData.id});d.dispatchIds=e==null?void 0:e.list.map(s=>s.did),Ct.value=JSON.parse(JSON.stringify(d.dispatchIds))},wt=y([]),Dt=async()=>{const{data:e,error:t}=await Xa();e&&(wt.value=e)},zt=y([]),Pt=async e=>{let t=ha(wt.value,e);const{data:s,error:o}=await Za({page:1,limit:100,province:t});zt.value=s.list},_a=async()=>{var e,t,s;if(S.value==0)d.latitude=ge.latitude,d.longitude=ge.longitude,d.prosite=ve.value,await Dt(),Pt(ve.value);else if(C.value[S.value-1].addr=ve.value,C.value[S.value-1].latitude=ge.latitude,C.value[S.value-1].longitude=ge.longitude,p.operateType=="edit"){let o=C.value[S.value-1];if(C.value[S.value-1].id){const{data:u,error:c}=await Wa([o]);u&&((e=window.$message)==null||e.success("修改位置成功"),De.value=!1,S.value=0,Ke())}else{o.pid=(t=p.rowData)==null?void 0:t.id;const{data:u,error:c}=await Et([o]);u&&((s=window.$message)==null||s.success("添加位置成功"),De.value=!1,S.value=0,Ke())}}De.value=!1,S.value=0};function ba(){De.value=!1}const{pageData:Ge,getData:ka,nextPage:xa}=Rt(es),Sa=async()=>{await ka({limit:100})},Ca=async e=>{const t=e.currentTarget,s=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&Ge.data.length<Ge.total&&(await xa(),await dt(),setTimeout(()=>{t.scrollTop=s}))},It=y([]),wa=async()=>{var s;const{data:e,error:t}=await ts({page:1,limit:100,proid:(s=p.rowData)==null?void 0:s.id});d.contractIds=e==null?void 0:e.list.map(o=>o.conid),It.value=JSON.parse(JSON.stringify(d.contractIds))},C=y([{longitude:120.373885,latitude:30.303899,addr:""}]),Da=y([]),Ke=async()=>{var s;const{data:e,error:t}=await as({pid:(s=p.rowData)==null?void 0:s.id,page:1,limit:99});C.value=e.list.length==0?[{longitude:120.373885,latitude:30.303899,addr:""}]:e.list,Da.value=JSON.parse(JSON.stringify(C.value))},za=async e=>{var t;if(e.id){const{data:s,error:o}=await os(e.id);s&&((t=window.$message)==null||t.success("删除成功"),Ke())}else C.value.splice(C.value.indexOf(e),1)};return(e,t)=>{const s=aa,o=ks,u=Ra,c=bs,w=Jt,k=mt,V=ta,W=Kt,ze=Ma,Pe=Ea,he=Yt,H=xs;return T(),Xe(At,null,[a(Pe,{show:$e.value,"onUpdate:show":[t[13]||(t[13]=f=>$e.value=f),fa],"display-directive":"show",width:1100,onMaskClick:t[14]||(t[14]=f=>$e.value=!0),onEsc:we},{default:n(()=>[a(ze,{title:pa.value,"native-scrollbar":!1,closable:""},{footer:n(()=>[a(i(le),{size:16,justify:"end"},{default:n(()=>[a(i(g),{onClick:we},{default:n(()=>[v(M(i(D)("common.cancel")),1)]),_:1}),a(i(g),{type:"primary",onClick:_t},{default:n(()=>[v(M(i(D)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[a(W,{ref_key:"formRef",ref:$,model:d,rules:z,onKeyup:Ht(_t,["enter"])},{default:n(()=>[a(V,{responsive:"screen","item-responsive":"","x-gap":"15"},{default:n(()=>[a(s,{span:"24 s:12 m:12",label:"项目名称",path:"proname"},{default:n(()=>[a(i(G),{clearable:"",value:d.proname,"onUpdate:value":t[0]||(t[0]=f=>d.proname=f),placeholder:"请输入项目名称"},null,8,["value"])]),_:1}),p.operateType==="add"?(T(),X(s,{key:0,span:"24 s:12 m:12",label:"绑定合同",path:"contractIds"},{default:n(()=>[a(i(je),{filterable:"",multiple:"",value:d.contractIds,"onUpdate:value":[t[1]||(t[1]=f=>d.contractIds=f),O],placeholder:"请选择合同","label-field":"contractname","value-field":"id",options:i(Ge).data,onScroll:Ca},null,8,["value","options"])]),_:1})):_e("",!0),p.operateType==="edit"?(T(),X(s,{key:1,span:"24 s:12 m:12",label:"项目状态",path:"status"},{default:n(()=>[a(i(je),{filterable:"",value:d.status,"onUpdate:value":t[2]||(t[2]=f=>d.status=f),placeholder:"请选择项目状态",options:i(Re)(i(_).userInfo.usertype==0||i(_).userInfo.usertype==2?i(vt):i(Cs))},null,8,["value","options"])]),_:1})):_e("",!0),a(s,{span:"24 s:12 m:12",label:"周期（天）",path:"period"},{default:n(()=>[a(i(Lt),{clearable:"",value:d.period,"onUpdate:value":t[3]||(t[3]=f=>d.period=f),style:{width:"100%"},placeholder:"请输入周期"},null,8,["value"])]),_:1}),a(s,{span:"24 s:12 m:12",label:"调试类型",path:"dtype"},{default:n(()=>[a(i(je),{filterable:"",value:d.dtype,"onUpdate:value":t[4]||(t[4]=f=>d.dtype=f),placeholder:"请选择调试类型",options:i(Re)(i(ea))},null,8,["value","options"])]),_:1}),a(s,{span:"24 s:12 m:12",label:"项目默认地点",path:"prosite"},{default:n(()=>[j("div",Ls,[j("div",Us,[a(u,{onClick:t[6]||(t[6]=f=>St())},{default:n(()=>[a(i(G),{value:d.prosite,"onUpdate:value":t[5]||(t[5]=f=>d.prosite=f),placeholder:"请选择项目地点"},null,8,["value"]),a(i(g),null,{icon:n(()=>[a(o,{class:"text-icon"})]),_:1})]),_:1})])])]),_:1}),a(s,{span:"24 s:12 m:12",label:"项目详细地址",path:"proaddr"},{default:n(()=>[a(i(G),{type:"textarea",rows:1,clearable:"",value:d.proaddr,"onUpdate:value":t[7]||(t[7]=f=>d.proaddr=f),placeholder:"请输入项目详细地址"},null,8,["value"])]),_:1}),C.value.length?(T(),X(s,{key:2,span:"24 s:12 m:24",label:"",path:""},{default:n(()=>[j("div",As,[j("div",js,[j("span",{class:"mr-10px",onClick:t[8]||(t[8]=jt(()=>{},["stop"]))},"其他地址"),a(i(g),{size:"small",ghost:"",type:"primary",onMousedown:t[9]||(t[9]=jt(()=>{},["stop"])),onClick:t[10]||(t[10]=f=>C.value.push({latitude:30.303899,longitude:120.373885,addr:""}))},{icon:n(()=>[a(c,{class:"text-icon"})]),default:n(()=>[t[18]||(t[18]=v(" 添加 "))]),_:1,__:[18]})]),j("div",Ts,[(T(!0),Xe(At,null,Ba(C.value,(f,Y)=>(T(),Xe("div",{class:"flex px-50px items-center mt-10px w-100%",key:f.latitude},[j("span",Fs,"项目地址"+M(Y+1),1),a(u,{onClick:q=>St(Y+1)},{default:n(()=>[a(i(G),{readonly:"",value:f.addr,"onUpdate:value":q=>f.addr=q,placeholder:"请选择项目地址"+(Y+1)},null,8,["value","onUpdate:value","placeholder"]),a(i(g),null,{icon:n(()=>[a(o,{class:"text-icon"})]),_:1})]),_:2},1032,["onClick"]),C.value.length>1?(T(),X(i(be),{key:0,onPositiveClick:q=>za(f)},{trigger:n(()=>[a(i(g),{size:"small",ghost:"",type:"error",class:"ml-10px"},{icon:n(()=>[a(w,{class:"text-icon"})]),default:n(()=>[t[19]||(t[19]=v(" "+M("删除")))]),_:1,__:[19]})]),default:n(()=>[v(" 确定要删除项目地址"+M(Y+1)+"吗？ ",1)]),_:2},1032,["onPositiveClick"])):_e("",!0)]))),128))])])]),_:1})):_e("",!0),a(s,{span:"24 s:12 m:12",label:"调度名称",path:"dispatch"},{default:n(()=>[a(i(G),{clearable:"",value:d.dispatch,"onUpdate:value":t[11]||(t[11]=f=>d.dispatch=f),placeholder:"请输入调度名称"},null,8,["value"])]),_:1}),a(s,{span:"24 s:12 m:12",label:"选择调度",path:"dispatchIds"},{default:n(()=>[a(i(je),{filterable:"",multiple:"",value:d.dispatchIds,"onUpdate:value":t[12]||(t[12]=f=>d.dispatchIds=f),placeholder:"请选择调度","label-field":"dname","value-field":"id",options:zt.value},null,8,["value","options"])]),_:1}),a(s,{span:"24 s:12 m:24",path:"contactList"},{default:n(()=>[j("div",Os,[a(i(le),{align:"center",style:{"margin-bottom":"10px"}},{default:n(()=>[t[21]||(t[21]=j("span",null,"项目联系人",-1)),a(i(g),{size:"small",ghost:"",type:"primary",onClick:xe},{icon:n(()=>[a(c,{class:"text-icon"})]),default:n(()=>[t[20]||(t[20]=v(" 添加项目联系人 "))]),_:1,__:[20]})]),_:1,__:[21]}),h.value.length>0?(T(),X(k,{key:0,columns:F,"paginate-single-page":!1,data:h.value,pagination:L,"max-height":350,"scroll-x":F.reduce((f,Y)=>f+Y.width,0)},null,8,["data","pagination","scroll-x"])):_e("",!0)])]),_:1}),a(s,{span:"24 s:12 m:24",path:"debuggedDevieceList"},{default:n(()=>[j("div",Es,[a(i(le),{align:"center",style:{"margin-bottom":"10px"}},{default:n(()=>[t[23]||(t[23]=j("span",null,"待调试设备",-1)),a(i(g),{size:"small",ghost:"",type:"primary",onClick:la},{icon:n(()=>[a(c,{class:"text-icon"})]),default:n(()=>[t[22]||(t[22]=v(" 添加待调试设备 "))]),_:1,__:[22]})]),_:1,__:[23]}),l.value.length>0?(T(),X(k,{key:0,style:{width:"1050px"},columns:pe,data:l.value,size:"small","scroll-x":pe.reduce((f,Y)=>f+Y.width,0),"row-key":f=>f.id,"max-height":350,pagination:m.pageSize==1?!1:m,remote:"","paginate-single-page":!1},null,8,["data","scroll-x","row-key","pagination"])):_e("",!0)])]),_:1}),a(s,{span:"24 s:12 m:24"},{default:n(()=>[j("div",Ms,[a(i(le),{align:"center",style:{"margin-bottom":"10px"}},{default:n(()=>[t[25]||(t[25]=j("span",null,"图纸",-1)),a(i(g),{size:"small",ghost:"",type:"primary",onClick:ua},{icon:n(()=>[a(c,{class:"text-icon"})]),default:n(()=>[t[24]||(t[24]=v(" 添加图纸 "))]),_:1,__:[24]})]),_:1,__:[25]}),se.value.length>0?(T(),X(k,{key:0,columns:oa,data:se.value,size:"small","scroll-x":702,"row-key":f=>f.id,"max-height":350},null,8,["data","row-key"])):_e("",!0)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"]),a(he,{show:Se.value,"onUpdate:show":t[15]||(t[15]=f=>Se.value=f),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:n(()=>[v(M(fe.value=="debuggedDevieceList"?"待调试设备":fe.value=="debuggedBusinessList"?"待调试业务":fe.value=="needsList"?"客户需求变更":fe.value=="developBusinessList"?"需要开发":"")+" 文件列表 ",1)]),footer:n(()=>[a(i(le),{justify:"end"},{default:n(()=>[a(i(g),{size:"small",class:"mt-16px",onClick:na},{default:n(()=>[v(M(i(D)("common.cancel")),1)]),_:1}),a(i(g),{type:"primary",size:"small",class:"mt-16px",onClick:nt},{default:n(()=>[v(M(i(D)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[a(i(g),{size:"small",ghost:"",type:"primary",onClick:da},{icon:n(()=>[a(c,{class:"text-icon"})]),default:n(()=>[t[26]||(t[26]=v(" 添加 "))]),_:1,__:[26]}),a(k,{columns:ra,"paginate-single-page":!1,data:I.value,"max-height":350},null,8,["data"])]),_:1},8,["show"]),a(he,{show:De.value,"onUpdate:show":t[17]||(t[17]=f=>De.value=f),title:"选择项目位置",preset:"card",class:"w-800px"},{footer:n(()=>[a(i(le),{justify:"end",size:16},{default:n(()=>[a(i(g),{onClick:ba},{default:n(()=>[v(M(i(D)("common.cancel")),1)]),_:1}),a(i(g),{type:"primary",onClick:_a},{default:n(()=>[v(M(i(D)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[Ve.value?(T(),X(H,{key:0,value:ve.value,"onUpdate:value":[t[16]||(t[16]=f=>ve.value=f),i(xt)],options:qe.value,placeholder:"请输入地点关键字",clearable:"",onSelect:va},null,8,["value","options","onUpdate:value"])):_e("",!0),j("div",{ref_key:"domRef",ref:ot,class:"h-full w-full",style:{width:"100%",height:"500px","margin-top":"10px"}},null,512)]),_:1},8,["show"])],64)}}}),Bs=at({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:Ze(["reset","search"],["update:model"]),setup(K,{emit:ne}){ds();const _=ne,{formRef:te,restoreValidation:R}=qt(),p=ft(K,"model"),d={当日:()=>{const b=new Date().getTime();return[b,b]},本周:()=>{const b=new Date().getTime();return[b-24*60*60*1e3*7,b]},上月:()=>{const b=new Date().getTime();return[b-24*60*60*1e3*30,b]},近一年:()=>{const b=new Date().getTime();return[b-24*60*60*1e3*365,b]},近三年:()=>{const b=new Date().getTime();return[b-24*60*60*1e3*365*3,b]}};function ie(){p.value.fuzzy="",_("search")}async function P(b,z){if(!b){p.value.startTime=void 0,p.value.endTime=void 0,_("search");return}p.value.startTime=String(We(1,z[0])),p.value.endTime=String(We(1,z[1])),_("search")}async function ae(){p.value.startTime=void 0,p.value.endTime=void 0,p.value.startAndTimeRange=null,p.value.fuzzy="",p.value.status=null,p.value.ptype=null,p.value.dtype=null,await R(),_("reset")}const de=Gt.debounce(b=>{_("search")},1e3,{leading:!0,trailing:!1}),$=b=>{p.value.fuzzy=b,de(b)};async function B(){_("search")}return(b,z)=>{const h=G,L=aa,F=je,x=Ns,J=Is,Z=g,ke=Ps,xe=le,O=ta,E=Kt,Te=gt;return T(),X(Te,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[a(E,{ref_key:"formRef",ref:te,model:p.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Ht(B,["enter"])},{default:n(()=>[a(O,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:n(()=>[a(L,{span:"24 s:12 m:6",label:"项目/客户",path:"fuzzy"},{default:n(()=>[a(h,{clearable:"",value:p.value.fuzzy,"onUpdate:value":z[0]||(z[0]=U=>p.value.fuzzy=U),placeholder:"请输入项目名称或客户名称",onClear:ie,onInput:$},null,8,["value"])]),_:1}),a(L,{span:"24 s:12 m:6",label:"项目状态",path:"status"},{default:n(()=>[a(F,{clearable:"",filterable:"",value:p.value.status,"onUpdate:value":[z[1]||(z[1]=U=>p.value.status=U),B],placeholder:"请选择项目状态",options:i(Re)(i(vt)).sort((U,ue)=>U.value-ue.value)},null,8,["value","options"])]),_:1}),a(L,{span:"24 s:12 m:6",label:"进度状态",path:"ptype"},{default:n(()=>[a(F,{clearable:"",filterable:"",value:p.value.ptype,"onUpdate:value":[z[2]||(z[2]=U=>p.value.ptype=U),B],placeholder:"请选择进度状态",options:[{label:"正常",value:0},{label:"已延期",value:1}]},null,8,["value"])]),_:1}),a(L,{span:"24 s:12 m:6",label:"调试类型",path:"dtype"},{default:n(()=>[a(F,{clearable:"",filterable:"",value:p.value.dtype,"onUpdate:value":[z[3]||(z[3]=U=>p.value.dtype=U),B],placeholder:"请选择调试类型",options:i(Re)(i(ea))},null,8,["value","options"])]),_:1}),a(L,{span:"24 s:12 m:8",label:"起止时间"},{default:n(()=>[a(x,{value:p.value.startAndTimeRange,"onUpdate:value":z[4]||(z[4]=U=>p.value.startAndTimeRange=U),type:"datetimerange",clearable:"",shortcuts:d,"onUpdate:formattedValue":P},null,8,["value"])]),_:1}),a(L,{span:"24  s:12 m:6",class:"pr-24px"},{default:n(()=>[a(xe,{class:"w-full"},{default:n(()=>[a(Z,{onClick:ae},{icon:n(()=>[a(J,{class:"text-icon"})]),default:n(()=>[v(" "+M(i(D)("common.reset")),1)]),_:1}),a(Z,{type:"primary",ghost:"",onClick:B},{icon:n(()=>[a(ke,{class:"text-icon"})]),default:n(()=>[v(" "+M(i(D)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Js={class:"min-h-500px flex gap-16px"},Vs={class:"flex items-center justify-end gap-16px"},qs=at({__name:"relatedContractLook",props:Ze({id:{}},{visable:{type:Boolean},visableModifiers:{}}),emits:["update:visable"],setup(K){const ne=K,_=ft(K,"visable"),{columns:te,data:R,getData:p,loading:d,mobilePagination:ie,searchParams:P}=pt({apiFn:Qt,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,id:ne.id,_t:new Date().getTime()},columns:()=>[{key:"contractname",title:"合同",width:200,render:x=>a("div",{class:h.pids==x.id?"bg-#f1f1f1 cursor-pointer p-5px":"cursor-pointer p-5px",onClick:()=>L(x.id)},[a("div",{class:"flex"},[a("div",{class:"w-60px inline-block"},[v("名称：")]),x.contractname]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[v("编号：")]),v(" "),x.contractnum]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[v("联系人：")]),x.businesscon]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[v("联系方式：")]),x.businessinfo]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[v("注意事项：")]),x.precautions]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[v("备注：")]),x.notes])])}]}),{columns:ae,data:de,getData:$,loading:B,pagination:b,mobilePagination:z,searchParams:h}=pt({apiFn:Xt,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,pids:ne.id,_t:new Date().getTime()},columns:()=>[{key:"devname",title:"设备名称",align:"center",width:200,ellipsis:{tooltip:!0}},{key:"devcount",title:"数量",align:"center",width:120},{key:"devmodel",title:"规格型号",align:"center",width:120,ellipsis:{tooltip:!0}},{key:"devunit",title:"单位",align:"center",width:120},{key:"devtype",title:"是否为我司设备",align:"center",width:120,render:x=>x.devtype==0?a(tt,{type:"success"},{default:()=>[v("是")]}):a(tt,{type:"info"},{default:()=>[v("否")]})},{key:"devmanu",title:"设备厂家",align:"center",width:120},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"创建人",align:"center",width:120},{key:"dbtime",title:"创建时间",align:"center",width:180}]}),L=x=>{h.pids=x,$()},F=()=>{_.value=!1};return et(()=>_.value,async x=>{var J;x&&(P.id=ne.id,de.value=[],b.itemCount=0,await p(),h.pids=(J=R.value[0])==null?void 0:J.id,h.pids&&$())}),(x,J)=>{const Z=mt,ke=gt,xe=Yt;return T(),X(xe,{show:_.value,"onUpdate:show":J[0]||(J[0]=O=>_.value=O),preset:"card",class:"w-1400px",title:"项目关联的合同"},{footer:n(()=>[j("div",Vs,[a(i(g),{type:"primary",size:"small",onClick:F},{default:n(()=>J[1]||(J[1]=[v(" 关闭 ")])),_:1,__:[1]})])]),default:n(()=>[j("div",Js,[a(Z,{class:"left",columns:i(te),data:i(R),"paginate-single-page":!1,size:"small",remote:"",loading:i(d),pagination:i(ie),"row-key":O=>O.id,"max-height":600},null,8,["columns","data","loading","pagination","row-key"]),a(ke,{bordered:!1,size:"small",title:"设备",class:"w-1100px"},{default:n(()=>[a(Z,{style:{width:"100%"},columns:i(ae),data:i(de),size:"small","max-height":600,loading:i(B),remote:"","scroll-x":i(ae).reduce((O,E)=>O+(E.width||100),0),"paginate-single-page":!1,pagination:i(z),"row-key":O=>O.id},null,8,["columns","data","loading","scroll-x","pagination","row-key"])]),_:1})])]),_:1},8,["show"])}}}),Gs=Wt(qs,[["__scopeId","data-v-a53f455a"]]),Ks={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Bt(K){return typeof K=="function"||Object.prototype.toString.call(K)==="[object Object]"&&!ys(K)}const Hs=at({name:"projectmanagement_projectlist",__name:"index",setup(K){const ne=us(),_=Vt(),te=cs(),R=ps(),{columns:p,columnChecks:d,data:ie,getData:P,loading:ae,mobilePagination:de,searchParams:$}=pt({showTotal:!0,apiFn:hs,apiParams:{page:1,pageSize:20,limit:20,status:null,startAndTimeRange:null,startTime:null,endTime:null,creater:void 0,fuzzy:"",sort:void 0,_t:new Date().getTime()},immediate:!1,columns:()=>[{type:"selection",align:"center",width:48},{key:"proname",title:"项目名称",align:"center",width:240,render:l=>a("div",{class:"cursor-pointer",onClick:()=>Ie(l)},[l.proname])},{key:"progess",title:"项目进度",align:"center",width:140,sorter:!0,render:l=>a(ct,{type:"line",showIndicator:!0,percentage:l.progess,"indicator-placement":"inside",processing:!0,color:"#1890ff"},null)},{key:"status",title:"项目状态",align:"center",width:120,defaultFilterOptionValue:null,filterOptions:Re(vt),filter:!0,filterMultiple:!1,render:l=>{if(l.status===null)return null;const m=D(ws[l.status]);return a("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",color:l.status==-1?"#a27ff9":l.status===0?"#9ca3af":l.status===1?"#3b82f6":l.status===2?"#facc15":"#22c55e",borderRadius:"50%"}},[a("span",{style:{width:"10px",height:"10px",marginRight:"5px",backgroundColor:l.status==-1?"#a27ff9":l.status===0?"#9ca3af":l.status===1?"#3b82f6":l.status===2?"#facc15":"#22c55e",borderRadius:"50%"}},null),a("span",null,[m])])}},{key:"cpdbtime",title:"预计完成日期",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"period",title:"周期",align:"center",width:100,render:l=>a("div",null,[l.period,v("天")])},{key:"ptype",title:"状态",align:"center",width:100,render:l=>a(tt,{type:l.ptype===0?"success":"error"},{default:()=>[l.ptype===0?"正常":"已延期"]})},{key:"dtype",title:"调试类型",align:"center",width:100,render:l=>{if(l.dtype===null)return null;const m=D(Ds[l.dtype]);return a(tt,{type:l.dtype==0?"warning":l.dtype==1?"success":"info"},Bt(m)?m:{default:()=>[m]})}},{key:"username",title:"创建人",align:"center",width:100,ellipsis:{tooltip:!0}},{key:"dbtime",title:"创建时间",align:"center",width:180},{key:"operate",title:D("common.operate"),align:"center",width:320,fixed:"right",render:l=>{let m;return a("div",{class:"flex justify-end gap-8px"},[l.status==-1&&(_.userInfo.usertype==0||_.userInfo.id==1021||_.userInfo.id==1023)&&a(be,{onPositiveClick:()=>Z(l,0)},{default:()=>"确定核准该项目吗？",trigger:()=>a(g,{color:"#a43cf9",ghost:!0,size:"small"},{default:()=>["核准"]})}),l.status==0&&(_.userInfo.usertype==0||_.userInfo.usertype==2)&&a(be,{onPositiveClick:()=>Z(l,1)},{default:()=>"确定启动该项目吗？",trigger:()=>Me(a(g,{type:"success",ghost:!0,size:"small"},{default:()=>["启动"]}),[[Ye("no-auth"),"project:Info:update"]])}),l.status==2&&(_.userInfo.usertype==0||_.userInfo.usertype==2)&&a(be,{onPositiveClick:()=>Z(l,3)},{default:()=>"是否确认执行审核操作？",trigger:()=>Me(a(g,{type:"warning",ghost:!0,size:"small"},{default:()=>["审核"]}),[[Ye("no-auth"),"project:Info:update"]])}),a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>Ie(l)},{default:()=>["详情"]}),a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>Te(l)},{default:()=>["关联合同"]}),Me(a(g,{type:"primary",ghost:!0,size:"small",onClick:()=>ke(l.id)},Bt(m=D("common.edit"))?m:{default:()=>[m]}),[[Ye("no-auth"),"project:Info:update"]])])}}]}),{drawerVisible:B,operateType:b,editingData:z,handleAdd:h,handleEdit:L,checkedRowKeys:F,onBatchDeleted:x}=_s(ie,P);async function J(){console.log(F.value),xe(F.value.join(","),l=>{x()})}const Z=async(l,m)=>{var I;const{data:oe,error:pe}=await Zt([{id:l.id,status:m}]);pe||((I=window.$message)==null||I.success("操作成功"),P(),m==3&&window.dispatchEvent(new CustomEvent("clearReview",{detail:{id:l.pid,type:"prj"}})))};function ke(l){L(l)}async function xe(l,m){const{data:oe,error:pe}=await vs(l);if(!pe)m&&m(oe);else return!1}const O=y(!1),E=y(0),Te=l=>{O.value=!0,E.value=l.id},U=l=>{$.status=l.status,P()},ue=l=>{console.log(l),l.columnKey=="progess"&&($.sort=l.order=="ascend"?0:l.order=="descend"?1:void 0,P())},ce=y(-1),st=l=>{l>0?(ce.value=l,$.creater=JSON.parse(JSON.stringify(l)),P()):($.creater=void 0,ce.value=-1,P())},Ie=l=>{te.push("/projectmanagement/orderdetail?prjId="+l.id),_.setProjectInfo({pid:l.id,pname:l.proname})},Be=()=>{P()};return fs(()=>{R.query.pname?($.fuzzy=R.query.pname,$.status=2,Be()):P()}),et(()=>R.query.pname,l=>{l&&($.fuzzy=l,P())}),(l,m)=>{const oe=$s,pe=gs,I=le,Se=Na,fe=Jt,Ne=Ia,lt=mt,nt=gt,Ce=Ye("no-auth");return T(),Xe("div",Ks,[a(Bs,{model:i($),"onUpdate:model":m[0]||(m[0]=A=>Qe($)?$.value=A:null),onReset:Be,onSearch:i(P)},null,8,["model","onSearch"]),a(nt,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:n(()=>[a(I,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:n(()=>[m[6]||(m[6]=j("div",null,"项目列表",-1)),a(pe,{size:"small",value:ce.value,"onUpdate:value":[m[1]||(m[1]=A=>ce.value=A),st],name:"radiobuttongroup1"},{default:n(()=>[a(oe,{value:-1,label:"默认"}),a(oe,{value:i(_).userInfo.id,label:"我创建的"},null,8,["value"])]),_:1},8,["value"])]),_:1,__:[6]})]),"header-extra":n(()=>[a(I,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:n(()=>[Me((T(),X(i(g),{onClick:i(h),size:"small",ghost:"",type:"primary"},{icon:n(()=>[a(Se,{class:"text-icon"})]),default:n(()=>[m[7]||(m[7]=v(" "+M("新增项目")))]),_:1,__:[7]},8,["onClick"])),[[Ce,"project:Info:insert"]]),a(i(be),{onPositiveClick:J},{trigger:n(()=>[Me((T(),X(i(g),{size:"small",ghost:"",type:"error",disabled:i(F).length==0},{icon:n(()=>[a(fe,{class:ms(["text-icon",{"animate-spin":i(ae)}])},null,8,["class"])]),default:n(()=>[m[8]||(m[8]=v(" "+M("批量删除")))]),_:1,__:[8]},8,["disabled"])),[[Ce,"project:Info:delete"]])]),default:n(()=>[m[9]||(m[9]=v(" 确定要删除选中的合同吗？ "))]),_:1,__:[9]}),a(Ne,{columns:i(d),"onUpdate:columns":m[2]||(m[2]=A=>Qe(d)?d.value=A:null)},null,8,["columns"])]),_:1})]),default:n(()=>[a(lt,{"checked-row-keys":i(F),"onUpdate:checkedRowKeys":m[3]||(m[3]=A=>Qe(F)?F.value=A:null),columns:i(p),data:i(ie),size:"small","flex-height":!i(ne).isMobile,"scroll-x":i(p).reduce((A,it)=>A+(it.width||100),0),loading:i(ae),remote:"","row-key":A=>A.id,"onUpdate:sorter":ue,pagination:i(de),class:"sm:h-full","onUpdate:filters":U},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),a(Rs,{visible:i(B),"onUpdate:visible":m[4]||(m[4]=A=>Qe(B)?B.value=A:null),onSubmitted:i(P),"operate-type":i(b),"row-data":i(z)},null,8,["visible","onSubmitted","operate-type","row-data"]),a(Gs,{visable:O.value,"onUpdate:visable":m[5]||(m[5]=A=>O.value=A),id:E.value},null,8,["visable","id"])]),_:1})])}}}),ml=Wt(Hs,[["__scopeId","data-v-3b40784c"]]);export{ml as default};
