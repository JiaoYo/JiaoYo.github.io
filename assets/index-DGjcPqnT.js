import{d as F,a4 as A,$ as _,g as s,L as h,K as v,B as p,h as d,dm as G,I as M,dn as J,r as W,j as C,o as f,e as K,w as o,c as y,i as t,f as H,t as x,be as Q,N as T,bf as X,bg as Y,bh as Z,ai as ee,ad as te,a2 as ae,C as se,E as N,D as ne,F as oe}from"./index-ByfxsQvj.js";import{u as ie}from"./table-Ca-5bYro.js";import{f as le}from"./reportForm-CQTYrTfT.js";import{d as re,e as ce,g as ue}from"./log-Cih33g-1.js";import{f as me}from"./scheduleTask-BTomRokq.js";import{_ as pe}from"./Popconfirm-Bx1fZnQD.js";import{_ as de}from"./TimePicker-Bw31iYnN.js";import"./defineProperty-D9xlJP3p.js";const ge={class:"min-h-500px flex-col-stretch gap-16px overflow-auto lt-sm:overflow-auto"},fe={class:"flex justify-center"},Ue=F({name:"logretrieval_logbackup",__name:"index",setup(_e){const V=A(),{columns:B,columnChecks:ye,data:U,getData:ke,loading:E,mobilePagination:I,searchParams:we,resetSearchParams:be}=ie({apiFn:re,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{key:"fname",title:"文件名称",align:"center",width:240},{key:"dbtime",title:"备份时间",align:"center",width:240},{key:"operate",title:_("common.operate"),align:"center",width:130,render:n=>s("div",{class:"flex-center gap-8px"},[h(s(p,{type:"primary",ghost:!0,size:"small",onClick:()=>$(n.fname)},{default:()=>[d("下载")]}),[[v("no-auth"),"sysmanger.logBackUps.download"]]),s(pe,{onPositiveClick:()=>S(n.fname)},{default:()=>"确定恢复吗?",trigger:()=>s(p,{type:"info",ghost:!0,size:"small"},{default:()=>[d("恢复")]})})])}]});async function $(n){G({url:`${M}/logBackUps/download.do`,method:"post",params:{fname:n},responseType:"blob",headers:{token:J()}}).then(async a=>{var r,u;if(a.data.type=="application/json"){const m=await a.data.text();var l=JSON.parse(m);if(l.code==500)return(r=window.$message)==null?void 0:r.error(l.data)}if(a.data){const m=window.URL.createObjectURL(new Blob([a.data])),c=document.createElement("a");c.href=m,c.setAttribute("download",n),document.body.appendChild(c),c.click()}(u=window.$message)==null||u.success("下载成功")})}const S=async n=>{var r;const{data:a,error:l}=await ce(n);l||(r=window.$message)==null||r.success("恢复成功")},k=()=>({id:"",beanName:"",params:"",cronExpression:"",status:1,remark:""});let e=W({taskInfo:k(),setting:{settingCycle:void 0,settingCycleValue:void 0,settingTime:void 0}});const D={setting:{settingCycle:{type:"number",required:!0,message:"请选择设置周期",trigger:"blur"},settingCycleValue:{type:"number",required:!0,message:"请选择设置周期值",trigger:"blur"},settingTime:{required:!0,message:"请选择设置时间",trigger:"blur"}}},w=C(null),g=C(!1),L=async()=>{g.value=!0;const{data:n,error:a}=await ue();if(!a){console.log(n);const l=Y(n.cronExpression);Object.assign(e.setting,l),e.taskInfo=n}},b=()=>{g.value=!1,e.taskInfo=k()},O=async()=>{var a,l,r,u;await((a=w.value)==null?void 0:a.validate());const n=Z(e.setting.settingCycle==1?{dayOfWeek:e.setting.settingCycleValue,time:e.setting.settingTime}:null,e.setting.settingCycle==2?{dayOfMonth:e.setting.settingCycleValue,time:e.setting.settingTime}:null,e.setting.settingCycle==3?{time:e.setting.settingTime}:null);if((l=e.taskInfo)!=null&&l.id){const{data:m,error:c}=await me({beanName:e.taskInfo.beanName,cronExpression:n,id:e.taskInfo.id,params:e.taskInfo.params,status:e.taskInfo.status,remark:e.taskInfo.remark});c||(u=window.$message)==null||u.success("设置成功")}else{const{data:m,error:c}=await le({beanName:"LogBackUpsTask",cronExpression:n,params:JSON.stringify({cron:n}),remark:""});c||(r=window.$message)==null||r.success("设置成功")}b()};return(n,a)=>{const l=ee,r=te,u=ae,m=se,c=N,j=de,z=ne,R=N,P=oe,q=v("no-auth");return f(),K("div",ge,[s(r,{title:"日志备份",bordered:!1,size:"small",class:"sm:flex-1-hidden"},{"header-extra":o(()=>[h((f(),y(t(p),{type:"primary",ghost:"",onClick:L},{default:o(()=>[d("备份设置 ")]),_:1})),[[q,"sysmanger.logBackUps.task"]])]),default:o(()=>[s(l,{columns:t(B),data:t(U),size:"small","flex-height":!t(V).isMobile,"scroll-x":962,loading:t(E),remote:"","row-key":i=>i.id,pagination:t(I),class:"sm:h-full"},null,8,["columns","data","flex-height","loading","row-key","pagination"])]),_:1}),s(P,{show:g.value,"onUpdate:show":a[5]||(a[5]=i=>g.value=i),title:"日志备份设置",preset:"card",class:"w-400px"},{footer:o(()=>[H("div",fe,[s(R,{justify:"end",size:16},{default:o(()=>[s(t(p),{onClick:b},{default:o(()=>[d(x(t(_)("common.cancel")),1)]),_:1}),s(t(p),{type:"primary",onClick:O},{default:o(()=>[d(x(t(_)("common.confirm")),1)]),_:1})]),_:1})])]),default:o(()=>[s(z,{ref_key:"formRef",ref:w,model:t(e),rules:D,"label-placement":"left","label-width":140,"require-mark-placement":"left"},{default:o(()=>[s(m,{label:"设置周期",path:"setting.settingCycle"},{default:o(()=>[s(c,{justify:"space-between"},{default:o(()=>[s(u,{value:t(e).setting.settingCycle,"onUpdate:value":[a[0]||(a[0]=i=>t(e).setting.settingCycle=i),a[1]||(a[1]=i=>t(e).setting.settingCycleValue=1)],options:[{label:"每周",value:1},{label:"每月",value:2},{label:"每日",value:3}],style:{width:"140px"}},null,8,["value"]),s(m,{label:"",path:"setting.settingCycleValue","show-feedback":!1},{default:o(()=>[t(e).setting.settingCycle==1?(f(),y(u,{key:0,value:t(e).setting.settingCycleValue,"onUpdate:value":a[2]||(a[2]=i=>t(e).setting.settingCycleValue=i),options:t(Q)(),style:{width:"140px"}},null,8,["value","options"])):T("",!0),t(e).setting.settingCycle==2?(f(),y(u,{key:1,value:t(e).setting.settingCycleValue,"onUpdate:value":a[3]||(a[3]=i=>t(e).setting.settingCycleValue=i),options:t(X)(),style:{width:"140px"}},null,8,["value","options"])):T("",!0)]),_:1})]),_:1})]),_:1}),s(m,{label:"设置时间",path:"setting.settingTime"},{default:o(()=>[s(j,{"formatted-value":t(e).setting.settingTime,"onUpdate:formattedValue":a[4]||(a[4]=i=>t(e).setting.settingTime=i)},null,8,["formatted-value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])])}}});export{Ue as default};
