import{_ as Q,l as X}from"./lodash-DBno-G8B.js";import{d as J,n as A,j as v,p as Y,s as ee,o as K,c as te,w as i,g as n,i as b,h as N,t as R,$ as O,F as le,aG as ae,Z as ne,J as oe,B as U,N as W,O as ie,ad as q,a3 as se,r as M,av as H,A as re,e as ue,ai as de,aj as ce,R as pe}from"./index-Cx7KIf91.js";import{_ as fe}from"./round-search-BI_CoZ5E.js";import{_ as me}from"./round-refresh-H8vv-sLt.js";import{a as ve,S as F,t as P}from"./alarm-xCSbUm5g.js";import{_ as ge}from"./DatePicker-DM2-ONEc.js";import{_ as _e}from"./FormItemGridItem-2AG1jRS6.js";import{_ as he}from"./Grid-Cu_AT9np.js";import{_ as ye}from"./originlogInfo.vue_vue_type_script_setup_true_lang--Ct8kg98.js";import{e as be}from"./exportExcel-D6OyA9oJ.js";import{x as we,v as xe}from"./events-Bl0_PjX4.js";import{n as ke}from"./Collection-BfzF2loA.js";import{f as Ie,a as Te}from"./common-DGnRWnxo.js";import{T as Ce}from"./basicconf-B_RGJnZa.js";import"./TimePicker-CYdj8vlz.js";import"./defineProperty-B-HvoKO0.js";import"./collection-B9KVpCwz.js";import"./DescriptionsItem-PsMFyR7M.js";import"./CollapseItem-3iH9t7ZN.js";const Se=J({name:"FormSearch",__name:"form-search",props:A(["eventsTypeBaseInfo","collectorList","logsoudev"],{model:{required:!0},modelModifiers:{}}),emits:A(["search"],["update:model"]),setup(_,{emit:j}){const y=_,m=j;v(0);const{formRef:C,restoreValidation:$}=Y(),l=ee(_,"model");async function E(){await $(),l.value.etypeid=null,l.value.elevel=null,l.value.ectgrid=null,l.value.etypeid=null,l.value.rtime=null,l.value.suject="",l.value.object="",l.value.lcon="",l.value.timeRange=null,ae(()=>{m("search")})}const B=p=>{l.value.elevel=p,f()};async function I(p,o){p&&p.length>0?(l.value.startTime=p[0],l.value.endTime=p[1]):(l.value.startTime=void 0,l.value.endTime=void 0),f()}async function f(){m("search")}const T=Q.debounce(f,1e3,{leading:!0,trailing:!1});return(p,o)=>{const h=ne,a=_e,w=oe,x=ge,k=me,S=U,L=fe,g=W,D=he,V=ie,z=q;return K(),te(z,{bordered:!1,size:"small",class:"card-wrapper"},{default:i(()=>[n(V,{ref_key:"formRef",ref:C,model:l.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:le(b(T),["enter"])},{default:i(()=>[n(D,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:i(()=>[n(a,{span:"24 s:24 m:8 l:6",label:"采集器",path:"logodid"},{default:i(()=>[n(h,{filterable:"",clearable:"",placeholder:"请选择采集器",value:l.value.logodid,"onUpdate:value":[o[0]||(o[0]=s=>l.value.logodid=s),f],options:y.collectorList,disabled:y.logsoudev,"value-field":"id","label-field":"type","reset-menu-on-options-change":!1},null,8,["value","options","disabled"])]),_:1}),n(a,{span:"24 s:24 m:8 l:6",label:"安全级别",path:"leid"},{default:i(()=>[n(h,{filterable:"",clearable:"",placeholder:"请选择安全级别",value:l.value.elevel,"onUpdate:value":[o[1]||(o[1]=s=>l.value.elevel=s),B],options:b(ve),"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),n(a,{span:"24 s:12 m:8 l:6",label:"事件类别",path:"ectgrid"},{default:i(()=>[n(h,{filterable:"",clearable:"",placeholder:"请选择事件类别",value:l.value.ectgrid,"onUpdate:value":[o[2]||(o[2]=s=>l.value.ectgrid=s),f],"value-field":"id","label-field":"pname",options:y.eventsTypeBaseInfo.eventsCategoryDataList},null,8,["value","options"])]),_:1}),n(a,{span:"24 s:12 m:8 l:6",label:"事件类型",path:"etypeid"},{default:i(()=>[n(h,{filterable:"",clearable:"",placeholder:"请选择事件类型",value:l.value.etypeid,"onUpdate:value":[o[3]||(o[3]=s=>l.value.etypeid=s),f],"value-field":"id","label-field":"pname",options:y.eventsTypeBaseInfo.eventsTypeDataList},null,8,["value","options"])]),_:1}),n(a,{span:"24 s:24 m:8 l:6",label:"事件主体",path:"suject"},{default:i(()=>[n(w,{placeholder:"请输入事件主体",value:l.value.suject,"onUpdate:value":o[4]||(o[4]=s=>l.value.suject=s),clearable:"",onClear:f},null,8,["value"])]),_:1}),n(a,{span:"24 s:24 m:8 l:6",label:"事件客体",path:"object"},{default:i(()=>[n(w,{placeholder:"请输入事件客体",value:l.value.object,"onUpdate:value":o[5]||(o[5]=s=>l.value.object=s),clearable:"",onClear:f},null,8,["value"])]),_:1}),n(a,{span:"24 s:24 m:8 l:6",label:"事件内容",path:"lcon"},{default:i(()=>[n(w,{placeholder:"请输入事件内容",value:l.value.lcon,"onUpdate:value":o[6]||(o[6]=s=>l.value.lcon=s),clearable:"",onClear:f},null,8,["value"])]),_:1}),n(a,{span:"24 s:24 m:12 l:8",label:"时间",path:"time"},{default:i(()=>[n(x,{value:l.value.timeRange,"onUpdate:value":o[7]||(o[7]=s=>l.value.timeRange=s),clearable:"",type:"datetimerange","value-format":"yyyy-MM-dd HH:mm:ss",style:{width:"100%"},"onUpdate:formattedValue":I},null,8,["value"])]),_:1}),n(a,{span:"24 s:24 m:8 l:6",label:""},{default:i(()=>[n(g,{class:"w-full"},{default:i(()=>[n(S,{onClick:E},{icon:i(()=>[n(k,{class:"text-icon"})]),default:i(()=>[N(" "+R(b(O)("common.reset")),1)]),_:1}),n(S,{type:"primary",ghost:"",onClick:b(T)},{icon:i(()=>[n(L,{class:"text-icon"})]),default:i(()=>[N(" "+R(b(O)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),Le={class:"min-h-500px flex-col-stretch overflow-hidden lt-sm:overflow-auto"};function De(_){return typeof _=="function"||Object.prototype.toString.call(_)==="[object Object]"&&!de(_)}const Ne=J({name:"eventalarm_originlog",__name:"index",props:{logsoudev:{},aip:{}},setup(_){const j=se(),y=v(window.innerHeight-395),m=_,C=v([]);(async()=>{const{data:e,error:t}=await ke({page:1,limit:1e3,_t:new Date().getTime()});if(t)console.error("获取采集器列表失败:",t);else{const d=e;C.value=d.list.map(r=>({...r,id:r.id,type:r.cname}))}})();const l=M({eventsTypeDataList:[],eventsCategoryDataList:[]});async function E(){const{data:e,error:t}=await Ie();t||(l.eventsCategoryDataList=e)}async function B(){const{data:e,error:t}=await Te();t||(l.eventsTypeDataList=e)}E(),B();const I=v(!1),f=v(),T=v(),p=v(!1),o=M({pageId:void 0,limit:100,etypeid:void 0,elevel:void 0,rtime:void 0,startOriginIp:void 0,endOriginIp:void 0,startAimOriginIp:void 0,endAimOriginIp:void 0,startSourceIp:void 0,endSourceIp:void 0,logodid:void 0,user:void 0,target:void 0,fuzzy:void 0,_t:new Date().getTime()}),h=[{title:"序号",key:"index",width:80,align:"center",render:e=>`${e.index}`},{key:"type",title:"采集器名称",align:"center",width:180},{key:"osubject",title:"事件主体",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"oobject",title:"事件客体",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"odescribe",title:"事件描述",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"oresult",title:"事件结果",align:"center",width:180,ellipsis:{tooltip:!0},render:e=>{var t,d;return n(H,{size:"small",type:(t=e.oresult)!=null&&t.includes("成功")?"success":(d=e.oresult)!=null&&d.includes("失败")?"error":"warning"},{default:()=>[e.oresult]})}},{key:"level",title:"安全级别",align:"center",width:120,render:e=>{const t=F[e.level];let d={color:P[e.level],textColor:"#ffffff",borderColor:P[e.level]};return n(H,{size:"small",color:d},De(t)?t:{default:()=>[t]})}},{key:"pname2",title:"事件类别",align:"center",width:120,ellipsis:{tooltip:!0}},{key:"pname1",title:"事件类型",align:"center",width:160},{key:"etime",title:"日志时间",align:"center",width:160},{key:"operate",title:O("common.operate"),align:"center",width:100,fixed:"right",render:e=>n("div",{class:"flex-center gap-8px"},[n(U,{type:"info",ghost:!0,size:"small",onClick:()=>V(e)},{default:()=>[N("详情")]})])}],a=v([]),w=v(0),x=async(e=!1)=>{if(!p.value)p.value=!0;else return;p.value=!0,m.logsoudev&&m.aip&&(k.value=!1,o.logodid=m.logsoudev,o.startAndEndSourceIp=[m.aip,m.aip],o.startSourceIp=m.aip,o.endSourceIp=m.aip);const{data:t,error:d}=await xe(o);d||(w.value=t.length,e?a.value=[...a.value,...t]:a.value=t,a.value=a.value.sort((r,c)=>c.id-r.id).map((r,c)=>(r.index=c+1,r)),p.value=!1)},k=v(!0),S=async()=>{a.value=[],o.pageId=void 0,(t=>Object.keys(t).filter(c=>c!=="limit"&&c!=="_t").some(c=>t[c]!==void 0&&t[c]!==""&&t[c]!==null))(o)?k.value=!1:(k.value=!0,D()),o.pageId=void 0,await x(),L()},L=async()=>{var e,t,d;if(a.value.length<y.value/44&&a.value.length<g.total){if(o.pageId==((e=a.value[a.value.length-1])==null?void 0:e.id))return;o.pageId=((d=(t=a.value)==null?void 0:t[a.value.length-1])==null?void 0:d.id)??void 0,x(!0)}};re(async()=>{await x(),await D(),L()});const g=M({page:1,pageCount:1,pageSize:20,total:0,prefix({startIndex:e,endIndex:t,page:d,pageSize:r,pageCount:c,itemCount:u}){return`已加载${a.value.length}条`+(a.value.length?k.value?` 共计 ${a.value.length>0?u??0:0} 条`:w.value==o.limit?"  预计还有更多":"  没有更多了":"")}});async function D(){const{data:e,error:t}=await we();t||(g.pageCount=20,g.total=Number(e),g.itemCount=Number(e))}const V=e=>{f.value=e.id,T.value=e,I.value=!0};function z(e){Math.abs(e.target.scrollTop+e.target.offsetHeight-e.target.scrollHeight)<=20&&g.total>a.value.length&&s()}const s=X.debounce(()=>{var e;if(((e=a.value)==null?void 0:e.length)<g.total){if(o.pageId==a.value[a.value.length-1].id)return;o.pageId=a.value[a.value.length-1].id,x(!0)}},300);async function Z(){if(!a.value.length)return;const e=JSON.parse(JSON.stringify(a.value));console.log(e);const t=[];e.forEach(r=>{const c={};h.forEach(u=>{if(r.hasOwnProperty(u.key)){const G=u.key=="elevel"?O(Ce[r[u.key]]):u.key=="level"?F[r[u.key]]??null:r[u.key];c[u.title]=G}}),t.push(c)}),be(t,500,[{wpx:120},{wpx:120},{wpx:80},{wpx:100},{wpx:100},{wpx:120},{wpx:100},{wpx:100},{wpx:500}],"原始日志_"+new Date().getTime())}return(e,t)=>{const d=W,r=ce,c=q;return K(),ue("div",Le,[n(Se,{model:o,"onUpdate:model":t[0]||(t[0]=u=>o=u),onSearch:S,eventsTypeBaseInfo:l,collectorList:C.value,class:"mb-16px",logsoudev:m.logsoudev},null,8,["model","eventsTypeBaseInfo","collectorList","logsoudev"]),n(c,{title:"原始日志",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":i(()=>[n(d,null,{default:i(()=>[n(b(U),{type:"primary",size:"small",ghost:"",onClick:Z,title:"导出已加载"},{default:i(()=>[N("导出已加载")]),_:1})]),_:1})]),default:i(()=>[n(r,{columns:h,data:a.value,size:"small","flex-height":!b(j).isMobile,loading:p.value,remote:"","row-key":u=>u.id,"virtual-scroll":"","scroll-x":h.reduce((u,G)=>u+G.width,0),pagination:g,class:"sm:h-full",onScroll:z,"max-height":y.value},null,8,["data","flex-height","loading","row-key","scroll-x","pagination","max-height"])]),_:1}),n(ye,{detailVisible:I.value,"onUpdate:detailVisible":t[1]||(t[1]=u=>I.value=u),detailId:f.value,detailInfo:T.value},null,8,["detailVisible","detailId","detailInfo"])])}}}),Ze=pe(Ne,[["__scopeId","data-v-9ddb2adb"]]);export{Ze as default};
