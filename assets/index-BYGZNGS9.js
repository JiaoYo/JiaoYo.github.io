import{o as d,e as h,f as I,d as G,Z as J,$ as k,g as s,L as C,K as x,B as p,h as g,I as W,H as K,dn as X,r as Z,j as T,w as a,c as f,i as t,t as V,b0 as Q,N,b1 as Y,b2 as ee,b3 as te,a9 as ne,X as se,C as ae,E as B,D as oe,F as ie}from"./index-ClKiVTJI.js";import{u as le}from"./table-CtVha77_.js";import{f as re}from"./reportForm-ClcsYTEU.js";import{d as ce,e as ue}from"./log-NZx6gGJZ.js";import{f as me,a as de}from"./scheduleTask-DXfC0YY8.js";import{_ as pe}from"./Popconfirm-DggMJhcu.js";import{_ as ge}from"./DataTable-W6X70lwR.js";import{_ as _e}from"./TimePicker-nlZsFMPZ.js";import"./Forward-CgMA_ruy.js";import"./defineProperty-CrCCF3kl.js";const fe={class:"inline-block",viewBox:"0 0 24 24",width:"1em",height:"1em"},ye=I("path",{fill:"currentColor",d:"M7 21q-.825 0-1.412-.587T5 19V6H4V4h5V3h6v1h5v2h-1v13q0 .825-.587 1.413T17 21zM17 6H7v13h10zM9 17h2V8H9zm4 0h2V8h-2zM7 6v13z"},null,-1),ke=[ye];function he($,w){return d(),h("svg",fe,[...ke])}const we={name:"material-symbols-delete-outline",render:he},be={class:"min-h-500px flex-col-stretch gap-16px overflow-auto lt-sm:overflow-auto"},ve={class:"flex justify-between"},Ce={key:1},Me=G({name:"logretrieval_logbackup",__name:"index",setup($){const w=J(),{columns:U,columnChecks:xe,data:E,getData:Te,loading:z,mobilePagination:S,searchParams:Ve,resetSearchParams:Ne}=le({apiFn:ce,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{key:"fname",title:"文件名称",align:"center",width:240},{key:"dbtime",title:"备份时间",align:"center",width:240},{key:"operate",title:k("common.operate"),align:"center",width:130,render:o=>s("div",{class:"flex-center gap-8px"},[C(s(p,{type:"primary",ghost:!0,size:"small",onClick:()=>D(o.fname)},{default:()=>[g("下载")]}),[[x("no-auth"),"sysmanger.logBackUps.download"]])])}]});async function D(o){W({url:`${K}/logBackUps/download.do`,method:"post",params:{fname:o},responseType:"blob",headers:{token:X()}}).then(async n=>{var m,c;if(n.data.type=="application/json"){const u=await n.data.text();var i=JSON.parse(u);if(i.code==500)return(m=window.$message)==null?void 0:m.error(i.data)}if(n.data){const u=window.URL.createObjectURL(new Blob([n.data])),r=document.createElement("a");r.href=u,r.setAttribute("download",o),document.body.appendChild(r),r.click()}(c=window.$message)==null||c.success("下载成功")})}const b=()=>({id:"",beanName:"",params:"",cronExpression:"",status:1,remark:""});let e=Z({taskInfo:b(),setting:{settingCycle:void 0,settingCycleValue:void 0,settingTime:void 0}});const O={setting:{settingCycle:{type:"number",required:!0,message:"请选择设置周期",trigger:"blur"},settingCycleValue:{type:"number",required:!0,message:"请选择设置周期值",trigger:"blur"},settingTime:{required:!0,message:"请选择设置时间",trigger:"blur"}}},v=T(null),_=T(!1),L=async()=>{_.value=!0;const{data:o,error:n}=await ue();if(!n){console.log(o);const i=ee(o.cronExpression);Object.assign(e.setting,i),e.taskInfo=o}},y=()=>{_.value=!1,e.taskInfo=b()},M=async()=>{var n,i,m,c;await((n=v.value)==null?void 0:n.validate());const o=te(e.setting.settingCycle==1?{dayOfWeek:e.setting.settingCycleValue,time:e.setting.settingTime}:null,e.setting.settingCycle==2?{dayOfMonth:e.setting.settingCycleValue,time:e.setting.settingTime}:null,e.setting.settingCycle==3?{time:e.setting.settingTime}:null);if((i=e.taskInfo)!=null&&i.id){const{data:u,error:r}=await me({beanName:e.taskInfo.beanName,cronExpression:o,id:e.taskInfo.id,params:e.taskInfo.params,status:e.taskInfo.status,remark:e.taskInfo.remark});r||(c=window.$message)==null||c.success("设置成功")}else{const{data:u,error:r}=await re({beanName:"LogBackUpsTask",cronExpression:o,params:JSON.stringify({cron:o}),remark:""});r||(m=window.$message)==null||m.success("设置成功")}y()},j=async()=>{var i;const{data:o,error:n}=await de([e.taskInfo.id]);n||((i=window.$message)==null||i.success("删除成功"),y())};return(o,n)=>{const i=ge,m=ne,c=se,u=ae,r=B,q=_e,P=oe,R=we,F=B,H=ie,A=x("no-auth");return d(),h("div",be,[s(m,{title:"日志备份",bordered:!1,size:"small",class:"sm:flex-1-hidden"},{"header-extra":a(()=>[C((d(),f(t(p),{type:"primary",ghost:"",onClick:L},{default:a(()=>[g("备份设置 ")]),_:1})),[[A,"sysmanger.logBackUps.task"]])]),default:a(()=>[s(i,{columns:t(U),data:t(E),size:"small","flex-height":!t(w).isMobile,"scroll-x":962,loading:t(z),remote:"","row-key":l=>l.id,pagination:t(S),class:"sm:h-full"},null,8,["columns","data","flex-height","loading","row-key","pagination"])]),_:1}),s(H,{show:_.value,"onUpdate:show":n[5]||(n[5]=l=>_.value=l),title:"日志备份设置",preset:"card",class:"w-400px"},{footer:a(()=>[I("div",ve,[t(e).taskInfo.id?(d(),f(t(pe),{key:0,onPositiveClick:j},{trigger:a(()=>[s(t(p),{secondary:"",circle:"",type:"error"},{default:a(()=>[s(R,{class:"text-icon"})]),_:1})]),default:a(()=>[g(" 确定要删除当前的任务吗？ ")]),_:1})):(d(),h("span",Ce)),s(F,{justify:"end",size:16},{default:a(()=>[s(t(p),{onClick:y},{default:a(()=>[g(V(t(k)("common.cancel")),1)]),_:1}),s(t(p),{type:"primary",onClick:M},{default:a(()=>[g(V(t(k)("common.confirm")),1)]),_:1})]),_:1})])]),default:a(()=>[s(P,{ref_key:"formRef",ref:v,model:t(e),rules:O,"label-placement":"left","label-width":140,"require-mark-placement":"left"},{default:a(()=>[s(u,{label:"设置周期",path:"setting.settingCycle"},{default:a(()=>[s(r,{justify:"space-between"},{default:a(()=>[s(c,{value:t(e).setting.settingCycle,"onUpdate:value":[n[0]||(n[0]=l=>t(e).setting.settingCycle=l),n[1]||(n[1]=l=>t(e).setting.settingCycleValue=1)],options:[{label:"每周",value:1},{label:"每月",value:2},{label:"每日",value:3}],style:{width:"140px"}},null,8,["value"]),s(u,{label:"",path:"setting.settingCycleValue","show-feedback":!1},{default:a(()=>[t(e).setting.settingCycle==1?(d(),f(c,{key:0,value:t(e).setting.settingCycleValue,"onUpdate:value":n[2]||(n[2]=l=>t(e).setting.settingCycleValue=l),options:t(Q)(),style:{width:"140px"}},null,8,["value","options"])):N("",!0),t(e).setting.settingCycle==2?(d(),f(c,{key:1,value:t(e).setting.settingCycleValue,"onUpdate:value":n[3]||(n[3]=l=>t(e).setting.settingCycleValue=l),options:t(Y)(),style:{width:"140px"}},null,8,["value","options"])):N("",!0)]),_:1})]),_:1})]),_:1}),s(u,{label:"设置时间",path:"setting.settingTime"},{default:a(()=>[s(q,{"formatted-value":t(e).setting.settingTime,"onUpdate:formattedValue":n[4]||(n[4]=l=>t(e).setting.settingTime=l)},null,8,["formatted-value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])])}}});export{Me as default};
