import{_ as ie}from"./round-search-D0NIJO1w.js";import{d as ee,r as F,a as U,a2 as te,i as ae,dh as ue,b as M,o as h,e as g,z as N,a5 as ne,a4 as le,g as B,t as W,cm as ce,bn as de,V as me,bs as ve,a6 as se,M as pe,aa as Q,eL as fe,eM as ge,f as m,cA as he,w as C,c as O,h as f,ad as ye,N as be,ac as Z,B as ke,$ as we,U as Fe}from"./index-DMk9ecAg.js";import{d as xe}from"./home-NiN8q0EL.js";import{N as K}from"./RadioButton-VGdYLQdE.js";import{N as G}from"./DatePicker-BTriC2aG.js";const De={class:"map-wrapper",style:{height:"100%",position:"relative"}},Me={class:"map-legend"},Te={class:"legend-list"},_e=["onClick","onContextmenu"],Ce={key:0,class:"visibility-icon"},$e={key:1,class:"solo-icon"},Ee={class:"legend-name"},Ae={class:"visibility-toggle"},Se={key:0,class:"solo-notice"},Oe=ee({__name:"historyMap",props:{trackData:{}},setup(J){const p=F(null);let $=null;const I=J,T=F([]),v=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],t=F({}),y=F(""),E=U(()=>{const e={};return Object.keys(T.value).forEach((o,a)=>{e[o]=v[a%v.length],t.value[o]===void 0&&(t.value[o]=!0)}),e});function x(e){if(y.value){L(e);return}t.value[e]=!t.value[e],i()}function L(e){y.value===e?j():(y.value=e,Object.keys(t.value).forEach(s=>{t.value[s]=s===e}),i())}function j(){y.value="",Object.keys(t.value).forEach(e=>{t.value[e]=!0}),i()}function z(){Object.keys(t.value).forEach(e=>{t.value[e]=!t.value[e]}),y.value="",i()}function R(){Object.keys(t.value).forEach(e=>{t.value[e]=!0}),y.value="",i()}function Y(){Object.keys(t.value).forEach(e=>{t.value[e]=!1}),y.value="",i()}const A=U(()=>{const e=[];return Object.values(T.value).forEach(s=>{e.push(...s)}),e.sort((s,o)=>new Date(s.dbtime).getTime()-new Date(o.dbtime).getTime())}),H=U(()=>{if(A.value.length===0)return[120.370086,30.305716];const e=A.value.map(u=>u.longitude),s=A.value.map(u=>u.latitude),o=(Math.min(...e)+Math.max(...e))/2,a=(Math.min(...s)+Math.max(...s))/2;return console.log(o,a),[o,a]});async function P(){const e="/map-sdk.json",{data:s}=await ve.get(`${e}?_t=${Date.now()}`);return s}function V(e){return new Promise((s,o)=>{if(window.AMap)return s(window.AMap);const a=document.createElement("script");a.src=`https://webapi.amap.com/maps?v=2.0&key=${e}&plugin=AMap.PolylineEditor`,a.defer=!0,a.onload=()=>window.AMap?s(window.AMap):o(new Error("AMapåŠ è½½å¤±è´¥")),a.onerror=()=>o(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(a)})}const k=F({});function n(e,s){const o=s.lng-e.lng,a=s.lat-e.lat;return Math.atan2(a,o)*180/Math.PI}function l(e,s,o,a,u){const b=`
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                background: white; border-radius: 50%; width: 20px; height: 20px; 
                display: flex; align-items: center; justify-content: center; 
                font-size: 10px; font-weight: bold; color: ${a}; border: 2px solid ${a};">
      ${u}
    </div>
  `,d=document.createElement("div");return d.style.cssText=`
    position: relative;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  `,d.innerHTML=b,new e.Marker({position:[s.lng,s.lat],content:d,offset:new e.Pixel(-10,-10)})}function c(e,s,o,a,u){const b=document.createElement("div");return b.className="custom-marker",b.style.transform="translateX(-50%)",b.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${a}; box-shadow: 0 0 10px ${a}, 0 0 20px ${a};">
      <img src="${u||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png"}" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${a};">${o}</div>
  `,new e.Marker({position:[s.lng,s.lat],content:b})}function r(){p.value&&p.value.clearMap(),k.value={}}function i(){!window.AMap||!p.value||Object.keys(k.value).forEach(e=>{const s=t.value[e];(k.value[e]||[]).forEach(a=>{s?a.show():a.hide()})})}function S(e){r();const s={};Object.entries(T.value).forEach(([o,a])=>{s[o]=a.map(u=>({lng:u.longitude,lat:u.latitude,address:u.address,dbtime:u.dbtime,proname:u.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:u.duration||0,userimage:u.userimage}))}),Object.keys(s).forEach(o=>{const a=s[o];console.log(a,"sssasfas fasfadasd");const u=E.value[o];if(a.length===0)return;const b=[];if(a.length>1){const d=new e.Polyline({path:a.map(D=>[D.lng,D.lat]),strokeColor:u,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});d.setMap(p.value),b.push(d)}if(a.forEach((d,D)=>{console.log(o);const w=c(e,d,o,u,a[0].userimage);w.setMap(p.value),b.push(w),w.on("click",()=>{const q=`
          <div style="min-width:200px; padding: 8px;">
            <div style="font-weight: bold; margin-bottom: 8px; color: ${u};">${o}</div>
            <div><b>åœ°ç‚¹ï¼š</b> ${d.address}</div>
            <div><b>æ—¶é—´ï¼š</b> ${d.dbtime}</div>
            <div><b>é¡¹ç›®ï¼š</b> ${d.proname}</div>
            ${d.duration?`<div><b>å·¥æ—¶ï¼š</b> ${d.duration}å°æ—¶</div>`:""}
            <div style="margin-top: 6px; color: #666; font-size: 12px;">ç¬¬${D+1}ä¸ªè½¨è¿¹ç‚¹</div>
          </div>
        `;$.setContent(q),$.open(p.value,w.getPosition())}),w.on("dblclick",()=>{$.open(p.value,w.getPosition()),p.value.setCenter(w.getPosition())})}),a.length>1)for(let d=1;d<a.length;d++){const D=a[d-1],w=a[d],q=(D.lng+w.lng)/2,oe=(D.lat+w.lat)/2,re=n(D,w),X=l(e,{lng:q,lat:oe},re,u,d);X.setMap(p.value),b.push(X)}k.value[o]=b}),i()}async function _(){try{const e=await P(),s=await V(e.AMAP_SDK_KEY);p.value=new s.Map("amap-container",{viewMode:"2D",center:H.value,zoom:5,features:["bg","point"]}),$=new s.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),S(s)}catch(e){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",e)}}return te(()=>I.trackData??[],e=>{console.log(e,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),T.value=e,window.AMap&&p.value&&S(window.AMap)},{immediate:!0,deep:!0}),ae(()=>{_()}),ue(()=>{p.value&&p.value.destroy()}),(e,s)=>(h(),M("div",De,[s[1]||(s[1]=g("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),g("div",Me,[g("div",{class:"legend-header"},[s[0]||(s[0]=g("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),g("div",{class:"legend-actions"},[g("button",{class:"action-btn",onClick:R},"å…¨æ˜¾"),g("button",{class:"action-btn",onClick:Y},"å…¨éš"),g("button",{class:"action-btn",onClick:z},"åé€‰")])]),g("div",Te,[(h(!0),M(ne,null,le(E.value,(o,a)=>(h(),M("div",{key:a,class:de(["legend-item",{"legend-item-hidden":!t.value[a],"legend-item-solo":y.value===a}]),onClick:u=>x(a),onContextmenu:ce(u=>L(a),["prevent"])},[g("div",{class:"legend-color",style:me({backgroundColor:o})},[t.value[a]?N("",!0):(h(),M("span",Ce,"ğŸ‘ï¸â€ğŸ—¨ï¸")),y.value===a?(h(),M("span",$e,"â­")):N("",!0)],4),g("span",Ee,W(a),1),g("span",Ae,W(t.value[a]?"éšè—":"æ˜¾ç¤º"),1)],42,_e))),128))]),y.value?(h(),M("div",Se,[B(" ä»…æ˜¾ç¤º: "+W(y.value)+" ",1),g("button",{class:"cancel-solo-btn",onClick:j},"å–æ¶ˆ")])):N("",!0)])]))}}),Be=se(Oe,[["__scopeId","data-v-73ffd325"]]),Ne={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},je=ee({name:"trajectory_historytrajectory",__name:"index",setup(J){const p=pe();function $(n){const l=new Date(n.getFullYear(),0,1),c=Math.floor((n.getTime()-l.getTime())/(24*60*60*1e3));return Math.ceil((c+1)/7).toString().padStart(2,"0")}function I(n){return n.getFullYear().toString()}function T(){const n=new Date,l=I(n),c=$(n);return`${l}-${c}å‘¨`}const v=F("week"),t=F({dayTime:String(Q(0,null)),monthTime:String(Q(3,null)),weekTime:T(),startTime:null,endTime:null,dates:null}),y=F([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),E=F("table"),x=F({}),L=U(()=>Object.keys(x.value||{}).map(n=>{var l,c;return{key:n,name:n,userimage:(c=(l=x.value[n])==null?void 0:l[0])==null?void 0:c.userimage}})),j=U(()=>{const n=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left",render(c){return m("div",{class:"text-blue-600 flex-col items-center font-medium"},[m(he,{width:"80",height:"80","preview-disabled":!0,src:c.userimage||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png",class:"rounded-md object-cover"},null),m("span",null,[c.name])])}}];let l=[];switch(v.value){case"week":t.value.startTime&&t.value.endTime&&(l=ge(t.value.startTime,t.value.endTime).map(r=>z(r)));break;case"month":t.value.monthTime&&(l=fe(t.value.monthTime).map(r=>z(r)));break;case"day":default:t.value.dayTime&&(l=[z(t.value.dayTime)]);break}return[...n,...l]}),z=n=>({title:R(n),key:n,width:200,align:"center",render:l=>Y(l.name,n)}),R=n=>{const l=new Date(n),c=l.getMonth()+1,r=l.getDate(),i=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][l.getDay()];return`${c}/${r} å‘¨${i}`},Y=(n,l)=>{const r=(x.value[n]||[]).filter(i=>i.daytime===l);return r.length===0?m("div",{class:"text-gray-400 text-sm"},[B("æ— è®°å½•")]):m("div",{class:"text-left space-y-1"},[r.map((i,S)=>m("div",{key:S,class:"p-1 border-b border-gray-100 last:border-b-0"},[m("div",{class:"font-medium text-blue-600"},[i.proname]),m("div",{class:"text-xs text-gray-600"},[B("ğŸ“ "),i.address]),m("div",{class:"text-xs text-gray-500"},[B("ğŸ•’ "),i.dbtime]),m("div",{class:"text-xs text-green-600 font-bold"},[B("â±ï¸ "),i.duration?i.duration+"å°æ—¶":"æ— "])]))])},A=n=>{const l=n.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!l)return null;const c=Number(l[1]),r=Number(l[2]),i=new Date(c,0,1+(r-1)*7),S=i.getDay(),_=new Date(i);S<=4?_.setDate(i.getDate()-i.getDay()+1):_.setDate(i.getDate()+8-i.getDay());const e=new Date(_);e.setDate(_.getDate()+6);const s=o=>{const a=o.getFullYear(),u=String(o.getMonth()+1).padStart(2,"0"),b=String(o.getDate()).padStart(2,"0");return`${a}-${u}-${b}`};return{start:s(_),end:s(e)}},H=n=>{x.value={},v.value=n,V()},P=n=>{V(n),k()},V=n=>{switch(v.value){case"week":if(n){const l=A(n);l&&(t.value.startTime=l.start,t.value.endTime=l.end)}break;case"month":t.value.dates=n||t.value.monthTime;break;case"day":default:t.value.dates=n||t.value.dayTime;break}},k=async()=>{try{const n={};v.value==="week"?(n.startTime=t.value.startTime,n.endTime=t.value.endTime):v.value==="month"?n.dates=t.value.monthTime:n.dates=t.value.dayTime;const{data:l,error:c}=await xe(n);c||(x.value=l)}catch(n){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",n)}};return te([v,()=>t.value.dates],()=>{if(v.value=="week"&&t.value.weekTime){const n=A(t.value.weekTime);n&&(t.value.startTime=n.start,t.value.endTime=n.end),k()}else(v.value=="month"&&t.value.monthTime||v.value=="day"&&t.value.dayTime)&&k()},{immediate:!0}),ae(()=>{t.value.weekTime=T(),k()}),(n,l)=>{const c=ie;return h(),M("div",Ne,[m(f(Fe),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:C(()=>[m(f(be),{align:"center"},{default:C(()=>[l[5]||(l[5]=g("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),m(f(Z),{value:v.value,"onUpdate:value":[l[0]||(l[0]=r=>v.value=r),H],size:"small"},{default:C(()=>[(h(!0),M(ne,null,le(y.value,r=>(h(),O(f(K),{key:r.value,value:r.value,label:r.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),v.value==="day"?(h(),O(f(G),{key:0,size:"small","formatted-value":t.value.dayTime,"onUpdate:formattedValue":[l[1]||(l[1]=r=>t.value.dayTime=r),P],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):N("",!0),v.value==="week"?(h(),O(f(G),{key:1,size:"small","formatted-value":t.value.weekTime,"onUpdate:formattedValue":[l[2]||(l[2]=r=>t.value.weekTime=r),P],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):N("",!0),v.value==="month"?(h(),O(f(G),{key:2,size:"small","formatted-value":t.value.monthTime,"onUpdate:formattedValue":[l[3]||(l[3]=r=>t.value.monthTime=r),P],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):N("",!0),m(f(ke),{type:"primary",onClick:k,size:"small",class:"w-full sm:w-auto"},{icon:C(()=>[m(c,{class:"text-icon"})]),default:C(()=>[B(" "+W(f(we)("common.search")),1)]),_:1}),m(f(Z),{size:"small",value:E.value,"onUpdate:value":l[4]||(l[4]=r=>E.value=r),name:"radiobuttongroup1"},{default:C(()=>[m(f(K),{value:"table",label:"è¡¨æ ¼"}),m(f(K),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[5]})]),default:C(()=>[E.value=="table"?(h(),O(f(ye),{key:0,columns:j.value,data:L.value,size:"small","flex-height":!f(p).isMobile,"scroll-x":j.value.reduce((r,i)=>r+i.width,0),remote:"","row-key":r=>r.key,class:"h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","row-key"])):(h(),O(Be,{key:1,trackData:x.value},null,8,["trackData"]))]),_:1})])}}}),We=se(je,[["__scopeId","data-v-013e44ae"]]);export{We as default};
