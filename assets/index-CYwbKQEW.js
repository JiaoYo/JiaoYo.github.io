import{_ as ue}from"./round-search-vUwoc4so.js";import{d as ae,r as F,a as U,aw as le,i as ne,dL as ce,b as x,o as y,e as h,z as j,aT as oe,aX as se,g as C,t as L,cI as de,aP as me,V as ve,aI as pe,aM as re,M as fe,a$ as ee,eq as ge,f2 as he,f as c,aS as ye,ax as be,w as D,c as O,h as f,ay as we,N as ke,A as Fe,az as _e,aC as te,B as Te,$ as De,U as xe,aH as Me,b4 as Ce,aU as Ee}from"./index-g7h47wCD.js";import{d as Ae}from"./home-DdAxqb5_.js";import{u as $e}from"./usePageData-CSmi2WoD.js";import{N as J}from"./RadioButton-BRBcgfd5.js";import{N as Q}from"./DatePicker-BAOqHlbD.js";const Se={class:"map-wrapper",style:{height:"100%",position:"relative"}},Oe={class:"map-legend"},je={class:"legend-list"},ze=["onClick","onContextmenu"],Ne={key:0,class:"visibility-icon"},Be={key:1,class:"solo-icon"},Pe={class:"legend-name"},Ue={class:"visibility-toggle"},Ve={key:0,class:"solo-notice"},Ie=ae({__name:"historyMap",props:{trackData:{}},setup(E){const d=F(null);let A=null;const W=E,M=F([]),v=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],t=F({}),b=F(""),$=U(()=>{const e={};return Object.keys(M.value).forEach((a,n)=>{e[a]=v[n%v.length],t.value[a]===void 0&&(t.value[a]=!0)}),e});function _(e){if(b.value){V(e);return}t.value[e]=!t.value[e],T()}function V(e){b.value===e?z():(b.value=e,Object.keys(t.value).forEach(l=>{t.value[l]=l===e}),T())}function z(){b.value="",Object.keys(t.value).forEach(e=>{t.value[e]=!0}),T()}function N(){Object.keys(t.value).forEach(e=>{t.value[e]=!t.value[e]}),b.value="",T()}function R(){Object.keys(t.value).forEach(e=>{t.value[e]=!0}),b.value="",T()}function Y(){Object.keys(t.value).forEach(e=>{t.value[e]=!1}),b.value="",T()}const S=U(()=>{const e=[];return Object.values(M.value).forEach(l=>{e.push(...l)}),e.sort((l,a)=>new Date(l.dbtime).getTime()-new Date(a.dbtime).getTime())}),H=U(()=>{if(S.value.length===0)return[120.370086,30.305716];const e=S.value.map(i=>i.longitude),l=S.value.map(i=>i.latitude),a=(Math.min(...e)+Math.max(...e))/2,n=(Math.min(...l)+Math.max(...l))/2;return console.log(a,n),[a,n]});async function B(){const e="/map-sdk.json",{data:l}=await pe.get(`${e}?_t=${Date.now()}`);return l}function I(e){return new Promise((l,a)=>{if(window.AMap)return l(window.AMap);const n=document.createElement("script");n.src=`https://webapi.amap.com/maps?v=2.0&key=${e}&plugin=AMap.PolylineEditor`,n.defer=!0,n.onload=()=>window.AMap?l(window.AMap):a(new Error("AMapåŠ è½½å¤±è´¥")),n.onerror=()=>a(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(n)})}const p=F({});function P(e,l){const a=l.lng-e.lng,n=l.lat-e.lat;return(Math.atan2(-n,a)*180/Math.PI-90+360)%360-175}function Z(e,l,a,n){const i=document.createElement("div");return i.style.cssText=`
    width: 12px;
    height: 18px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 18px solid ${n};
    transform: translate(-50%, -50%) rotate(${a}deg);
    transform-origin: center center;
  `,new e.Marker({position:[l.lng,l.lat],content:i,offset:new e.Pixel(0,0)})}function q(e,l,a,n,i){const r=document.createElement("div");return r.className="custom-marker",r.style.transform="translateX(-50%)",r.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${n}; ">
      <img src="${i||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png"}" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${n};">${a}</div>
  `,new e.Marker({position:[l.lng,l.lat],content:r})}function G(){d.value&&d.value.clearMap(),p.value={}}function T(){!window.AMap||!d.value||Object.keys(p.value).forEach(e=>{const l=t.value[e];(p.value[e]||[]).forEach(n=>{l?n.show():n.hide()})})}function o(e){if(!d.value)return;G();const l={};Object.entries(M.value).forEach(([n,i])=>{l[n]=i.map(r=>({lng:r.longitude,lat:r.latitude,address:r.address,dbtime:r.dbtime,proname:r.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:r.duration||0,userimage:r.userimage,longitude:r.longitude,latitude:r.latitude}))}),Object.keys(l).forEach(n=>{const i=l[n],r=$.value[n];if(i.length===0)return;const w=[];if(i.length>1){const m=new e.Polyline({path:i.map(k=>[k.lng,k.lat]),strokeColor:r,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});m.setMap(d.value),w.push(m)}i.forEach((m,k)=>{const g=q(e,m,n,r,i[0].userimage);g.setMap(d.value),w.push(g),g.on("click",()=>{const K=`
          <div style="min-width:220px; background:#fff; padding:12px 14px; font-size:13px; color:#333; line-height:1.6">
            <div style="font-weight:bold; color:${r}; font-size:15px; margin-bottom:6px; border-bottom:1px solid #f0f0f0; padding-bottom:4px">
              ${n}
            </div>
            <div><b style="color:#555">åœ°ç‚¹ï¼š</b>${m.address}</div>
            <div><b style="color:#555">æ—¶é—´ï¼š</b>${m.dbtime}</div>
            <div><b style="color:#555">é¡¹ç›®ï¼š</b>${m.proname}</div>
            <div><b style="color:#555">ç»çº¬åº¦ï¼š</b><span style="font-size:12px;color:#666">${m.longitude}, ${m.latitude}</span></div>
            ${m.duration?`<div><b style="color:#555">å·¥æ—¶ï¼š</b>${m.duration} å°æ—¶</div>`:""}
          </div>
          <div style="margin-top:8px; text-align:right; font-size:12px; color:#999">ç¬¬ ${k+1} ä¸ªæ‰“å¡ç‚¹</div>
        `;A.setContent(K),A.open(d.value,g.getPosition())}),g.on("dblclick",()=>{A.open(d.value,g.getPosition()),d.value.setCenter(g.getPosition()),d.value.setZoom(14)})});for(let m=1;m<i.length;m++){const k=i[m-1],g=i[m];if(s(k,g))continue;const K={lng:(k.lng+g.lng)/2,lat:(k.lat+g.lat)/2},ie=P(k,g),X=Z(e,K,ie,r);X.isArrow=!0,X.setMap(d.value),w.push(X)}p.value[n]=w});const a=()=>{const i=d.value.getZoom()>=5;Object.values(p.value).forEach(r=>{r.forEach(w=>{w.isArrow&&(i?w.show():w.hide())})})};d.value.on("zoomend",a),a(),Object.keys(p.value).forEach(n=>{(p.value[n]||[]).forEach(r=>{r.isArrow||(t.value[n]?r.show():r.hide())})})}function s(e,l,a=1e-7){return Math.abs(e.lng-l.lng)<a&&Math.abs(e.lat-l.lat)<a}async function u(){try{const e=await B(),l=await I(e.AMAP_SDK_KEY);d.value=new l.Map("amap-container",{viewMode:"2D",center:H.value,zoom:5,features:["bg","point"]}),d.value.on("zoomend",()=>{const n=d.value.getZoom()>=12;Object.values(p.value).forEach(i=>{i.forEach(r=>{r.isArrow&&(n?r.show():r.hide())})})}),A=new l.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),o(l)}catch(e){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",e)}}return le(()=>W.trackData??[],e=>{console.log(e,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),M.value=e,window.AMap&&d.value&&o(window.AMap)},{immediate:!0,deep:!0}),ne(()=>{u()}),ce(()=>{d.value&&d.value.destroy()}),(e,l)=>(y(),x("div",Se,[l[1]||(l[1]=h("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),h("div",Oe,[h("div",{class:"legend-header"},[l[0]||(l[0]=h("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),h("div",{class:"legend-actions"},[h("button",{class:"action-btn",onClick:R},"å…¨æ˜¾"),h("button",{class:"action-btn",onClick:Y},"å…¨éš"),h("button",{class:"action-btn",onClick:N},"åé€‰")])]),h("div",je,[(y(!0),x(oe,null,se($.value,(a,n)=>(y(),x("div",{key:n,class:me(["legend-item",{"legend-item-hidden":!t.value[n],"legend-item-solo":b.value===n}]),onClick:i=>_(n),onContextmenu:de(i=>V(n),["prevent"])},[h("div",{class:"legend-color",style:ve({backgroundColor:a})},[t.value[n]?j("",!0):(y(),x("span",Ne,"ğŸ‘ï¸â€ğŸ—¨ï¸")),b.value===n?(y(),x("span",Be,"â­")):j("",!0)],4),h("span",Pe,L(n),1),h("span",Ue,L(t.value[n]?"éšè—":"æ˜¾ç¤º"),1)],42,ze))),128))]),b.value?(y(),x("div",Ve,[C(" ä»…æ˜¾ç¤º: "+L(b.value)+" ",1),h("button",{class:"cancel-solo-btn",onClick:z},"å–æ¶ˆ")])):j("",!0)])]))}}),Le=re(Ie,[["__scopeId","data-v-c0e27694"]]),We={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Re(E){return typeof E=="function"||Object.prototype.toString.call(E)==="[object Object]"&&!Ee(E)}const Ye=ae({name:"trajectory_historytrajectory",__name:"index",setup(E){const d=fe();function A(o){return o.getFullYear()}function W(o){const s=new Date(o.getFullYear(),0,1),u=(o.getTime()-s.getTime())/864e5,e=s.getDay()||7;return Math.ceil((u+e)/7)}function M(){const o=new Date,s=A(o),u=W(o).toString().padStart(2,"0");return`${s}-${u}å‘¨`}const v=F("week"),t=F({dayTime:String(ee(0,null)),monthTime:String(ee(3,null)),weekTime:M(),startTime:null,endTime:null,dates:null,creater:null}),b=F([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),$=F("table"),_=F({}),V=U(()=>Object.keys(_.value||{}).map(o=>{var s,u;return{key:o,name:o,userimage:(u=(s=_.value[o])==null?void 0:s[0])==null?void 0:u.userimage}})),z=U(()=>{const o=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left",render(u){return c("div",{class:"text-blue-600 flex-col items-center font-medium"},[c(ye,{width:"60",height:"60","preview-disabled":!0,src:u.userimage||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png",class:"rounded-md object-cover"},null),c("span",null,[u.name])])}}];let s=[];switch(v.value){case"week":t.value.startTime&&t.value.endTime&&(s=he(t.value.startTime,t.value.endTime).map(e=>N(e)));break;case"month":t.value.monthTime&&(s=ge(t.value.monthTime).map(e=>N(e)));break;case"day":default:t.value.dayTime&&(s=[N(t.value.dayTime)]);break}return[...o,...s]}),N=o=>({title:R(o),key:o,width:300,align:"center",render:s=>Y(s.name,o)}),R=o=>{const s=new Date(o),u=s.getMonth()+1,e=s.getDate(),l=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][s.getDay()];return`${u}/${e} å‘¨${l}`},Y=(o,s)=>{let u;const l=(_.value[o]||[]).filter(a=>a.daytime===s);return l.length===0?c("div",{class:"text-gray-400 text-sm"},[C("æ— è®°å½•")]):c("div",{class:"text-left space-y-1"},[c(be,{style:"height: 300px;",trigger:"none"},Re(u=l.map((a,n)=>c("div",{key:n,class:"tableItem p-1 border-b border-gray-100 last:border-b-0"},[c("div",null,[C("é¡¹ç›®ï¼š"),c("span",{class:""},[a.proname||"æš‚æ— é¡¹ç›®"])]),c("div",null,[C("åœ°å€ï¼š "),c("span",{class:""},[a.address])]),c("div",null,[C("æ‰“å¡æ—¶é—´ï¼š"),c("span",{class:""},[a.dbtime])]),c("div",null,[C("å·¥æ—¶ï¼š"),c("span",{class:""},[a.duration?a.duration+"å°æ—¶":"æ— "])])])))?u:{default:()=>[u]})])},S=o=>{const s=o.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!s)return null;const u=Number(s[1]),e=Number(s[2]),l=new Date(u,0,1+(e-1)*7),a=l.getDay(),n=new Date(l);a<=4?n.setDate(l.getDate()-l.getDay()+1):n.setDate(l.getDate()+8-l.getDay());const i=new Date(n);i.setDate(n.getDate()+6);const r=w=>{const m=w.getFullYear(),k=String(w.getMonth()+1).padStart(2,"0"),g=String(w.getDate()).padStart(2,"0");return`${m}-${k}-${g}`};return{start:r(n),end:r(i)}},H=o=>{_.value={},v.value=o,I()},B=o=>{I(o),p()},I=o=>{switch(v.value){case"week":if(o){const s=S(o);s&&(t.value.startTime=s.start,t.value.endTime=s.end)}break;case"month":t.value.dates=o||t.value.monthTime;break;case"day":default:t.value.dates=o||t.value.dayTime;break}},p=async()=>{try{const o={};t.value.creater&&(o.creater=t.value.creater),v.value==="week"?(o.startTime=t.value.startTime,o.endTime=t.value.endTime):v.value==="month"?o.dates=t.value.monthTime:o.dates=t.value.dayTime;const{data:s,error:u}=await Ae(o);u||(_.value=s)}catch(o){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",o)}},{pageData:P,getData:Z,nextPage:q}=$e(Ce),G=async o=>{const s=o.currentTarget,u=s.scrollTop;s.scrollTop+s.offsetHeight>=s.scrollHeight&&P.data.length<P.total&&(await q(),await Me(),setTimeout(()=>{s.scrollTop=u}))},T=async o=>{t.value.creater=o,p()};return le([v,()=>t.value.dates],()=>{if(v.value=="week"&&t.value.weekTime){const o=S(t.value.weekTime);o&&(t.value.startTime=o.start,t.value.endTime=o.end),p()}else(v.value=="month"&&t.value.monthTime||v.value=="day"&&t.value.dayTime)&&p()},{immediate:!0}),ne(()=>{t.value.weekTime=M(),Z({usertypes:"2,3"}),p()}),(o,s)=>{const u=_e,e=Fe,l=ue;return y(),x("div",We,[c(f(xe),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:D(()=>[c(f(ke),{align:"center"},{default:D(()=>[s[6]||(s[6]=h("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),c(e,{label:"ç”¨æˆ·",path:"creater","label-placement":"left","show-feedback":!1},{default:D(()=>[c(u,{clearable:"",filterable:"",value:t.value.creater,"onUpdate:value":[s[0]||(s[0]=a=>t.value.creater=a),T],placeholder:"è¯·é€‰æ‹©","label-field":"username",size:"small","value-field":"id",options:f(P).data,onScroll:G},null,8,["value","options"])]),_:1}),c(f(te),{value:v.value,"onUpdate:value":[s[1]||(s[1]=a=>v.value=a),H],size:"small"},{default:D(()=>[(y(!0),x(oe,null,se(b.value,a=>(y(),O(f(J),{key:a.value,value:a.value,label:a.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),v.value==="day"?(y(),O(f(Q),{key:0,size:"small","formatted-value":t.value.dayTime,"onUpdate:formattedValue":[s[2]||(s[2]=a=>t.value.dayTime=a),B],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):j("",!0),v.value==="week"?(y(),O(f(Q),{key:1,size:"small","formatted-value":t.value.weekTime,"onUpdate:formattedValue":[s[3]||(s[3]=a=>t.value.weekTime=a),B],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):j("",!0),v.value==="month"?(y(),O(f(Q),{key:2,size:"small","formatted-value":t.value.monthTime,"onUpdate:formattedValue":[s[4]||(s[4]=a=>t.value.monthTime=a),B],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):j("",!0),c(f(Te),{type:"primary",onClick:p,size:"small",class:"w-full sm:w-auto"},{icon:D(()=>[c(l,{class:"text-icon"})]),default:D(()=>[C(" "+L(f(De)("common.search")),1)]),_:1}),c(f(te),{size:"small",value:$.value,"onUpdate:value":s[5]||(s[5]=a=>$.value=a),name:"radiobuttongroup1"},{default:D(()=>[c(f(J),{value:"table",label:"è¡¨æ ¼"}),c(f(J),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:D(()=>[$.value=="table"?(y(),O(f(we),{key:0,columns:z.value,data:V.value,size:"small","flex-height":!f(d).isMobile,"scroll-x":z.value.reduce((a,n)=>a+n.width,0),remote:"","row-key":a=>a.key,class:"h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","row-key"])):(y(),O(Le,{key:1,trackData:_.value},null,8,["trackData"]))]),_:1})])}}}),Je=re(Ye,[["__scopeId","data-v-c4b69818"]]);export{Je as default};
