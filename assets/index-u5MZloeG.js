import{_ as ce}from"./table-column-setting.vue_vue_type_script_setup_true_lang-BSGgSlEs.js";import{_ as ie}from"./round-search-BwENOchH.js";import{d as re,bw as de,g as o,aQ as w,aT as K,a$ as O,v as ue,ai as pe,j as k,au as he,x as L,F,b1 as $,b2 as J,b3 as W,aD as G,aa as _e,o as me,e as fe,w as p,h as U,i as l,am as ge,A as ye,B as ve,ae as ke,f as M,N as be,z as we,bx as xe,t as Se,ap as H,aj as Te,L as $e,ar as De,O as Ne,ak as ze,as as Ce,a5 as qe,S as Ie}from"./index-DskrvN6Q.js";import{u as Ve,a as Ee}from"./table-BmoG-Cxs.js";import{a as Pe,p as Oe}from"./gather-C6wE7FpE.js";import{h as Q}from"./permission-CfU8jem9.js";import{_ as Ue}from"./InputGroupLabel-D6hukDEQ.js";import{_ as Ae}from"./Tree-BkLtHEe3.js";import{_ as Re}from"./Split-YX8lYtsM.js";const je={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Be={class:"flex flex-col"},Ke=re({name:"configsetting_realtimedata_devicedata",__name:"index",setup(Le){const{columns:Y,columnChecks:D,data:x,getData:b,loading:A,mobilePagination:X,searchParams:f,resetSearchParams:Fe}=Ve({apiFn:de,apiParams:{page:1,pageSize:200,limit:200,tagType:null,chlid:null,devId:null,fuzzy:"",chlType:0,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",align:"center",width:48},{key:"id",title:"序号",align:"center",width:80},{key:"devId",title:"设备名称",align:"center",width:100,render:e=>{var t;return o("span",null,[(t=R.value.find(n=>n.id==e.devId))==null?void 0:t.devName])}},{key:"tagName",title:"测点名称",align:"center"},{key:"tagDesc",title:"物模型标识(测点描述)",align:"center"},{key:"value",title:"测点值",align:"center",width:140,render:e=>{var t;return w("span",{style:{color:e.quality===100?"red":e.quality==49?"#409eff":e.quality==50?"#909399":"#67c23a"}},parseFloat((t=e.value)==null?void 0:t.toFixed(6))||e.value)}},{key:"quality",title:"质量",align:"center",width:120,render:e=>(e.quality==100||e.quality==49||e.quality==0)&&w(K,{style:{background:e.quality===100?"red":e.quality==49?"#409eff":"#67c23a",color:"#fff"}},e.quality==0?"Good":e.quality==49?"人工置数":e.quality==100?"Bad":"")},{key:"dbtime",title:"采集时间",align:"center",minWidth:120,render:e=>{var t,n;return w("span",{title:O(0,+e.dbtime)},e.dbtime?(n=O(2,+e.dbtime))==null?void 0:n.substring(10,(t=O(2,+e.dbtime))==null?void 0:t.length):"")}},{key:"tagType",title:"测点类型",align:"center",width:140,render:e=>o("span",null,[Pe[e.tagType]])},{key:"objAddr",title:"地址",align:"center",width:140}]}),Z=e=>{e===""&&b()};ue(async()=>{await ee(),q(),te()}),pe(()=>{var e,t;(e=N.value)==null||e.close(),(t=T.value)==null||t.close()});const v=k(),R=k([]),ee=async()=>{const{data:e,error:t}=await he();if((e==null?void 0:e.length)==0)return;function n(h){return h.map(i=>{var a;return{label:i.chlName,key:i.id,dev_status:null,children:(a=i.devicePojoList)!=null&&a.length?i.devicePojoList.map(c=>(R.value.push(c),{label:c.devName,dev_status:null,chlType:i.chlType,key:c.id})):[]}})}v.value=n(e),f.chlid=v.value[0].key,f.devId=v.value[0].children[0].key,I.value=[v.value[0].children[0].key],S.value=v.value[0].children[0].label,b()},N=k(null),te=()=>{var c,d,g;if((c=N.value)==null||c.close(),!Q("channel:status:websocket")){(d=window.$message)==null||d.destroyAll(),(g=window.$message)==null||g.warning("暂无权限连接websocket");return}const e=new Date().getTime(),t=L(),n=F(`${t}${e}getchlstatus`),h=$(n),i=$("getchlstatus"),a=new J(W+`/ChannelStatusWebsocket/${i}/${h}/${e}/${t}?token=${G()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});N.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(u=>{let _=[];if(console.log(u,"通道状态websocket接受数据"),!j(u.data))return;_=JSON.parse(u.data).data;const y=JSON.parse(u.data).valid;v.value.forEach(s=>{_.forEach(m=>{var r;m.chl_id==s.key&&(s.dev_status=m.chl_status),m.chl_id==1&&(s.dev_status=1),(r=s.children)==null||r.forEach(E=>{var B;(B=m.devs)==null||B.forEach(P=>{P.dev_id==E.key&&(E.dev_status=P.dev_status),P.dev_id==1&&(E.dev_status=1)})})})}),v.value.forEach(s=>{y.forEach(m=>{s.key==m.id&&(s.chlValid=m.chlValid)})})})},T=k(null),z=k(""),C=k(!0),q=()=>{var c,d,g;if((c=T.value)==null||c.close(),!Q("realtime:data:websocket")){(d=window.$message)==null||d.destroyAll(),(g=window.$message)==null||g.warning("暂无权限连接websocket");return}C.value=!0;const e=new Date().getTime(),t=L(),n=F(`${t}${e}${S.value}`),h=$(n),i=$(S.value),a=new J(W+`/realTimeDataWebsocket/${i}/${h}/${e}/${t}?token=${G()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});T.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(u=>{let _=[];console.log(u,"实时数据websocket接受数据"),j(u.data)&&(_=JSON.parse(u.data).data[S.value],_==null||_.forEach(y=>{x.value.forEach(s=>{y.i==s.id&&(s.quality=y.q,s.value=y.v,s.dbtime=y.t)})}),z.value=oe())})},I=k([]),S=k(""),ae=async(e,t,n)=>{var a,c,d,g,u;I.value=[(a=n.node)==null?void 0:a.key],f.chlType=(c=n.node)==null?void 0:c.chlType;function h(_,y){for(const s of _)if(s.children){for(const m of s.children)if(m.key===y)return s.key}return null}const i=await h(v.value,(d=n.node)==null?void 0:d.key);f.chlid=i,f.devId=(g=n.node)==null?void 0:g.key,S.value=(u=n.node)==null?void 0:u.label,b(),q()},ne=e=>{var t;e&&x.value.length>0?q():(t=T.value)==null||t.close()};_e(()=>f.tagType,e=>{e||b()});const se=({option:e})=>e.key==0?"":e.dev_status!==null?w("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:e.hasOwnProperty("dev_status")&&e.dev_status==1?"#00b42a":e.dev_status==2?"#ff0000":"#ccc"}}):"",le=({option:e})=>!e.chlValid||e.chlValid!==1&&e.chlValid!==2?"":w("span",{style:{color:"#999",fontSize:"12px",marginRight:"10px"}},w(K,{size:"small",type:e.chlValid==1?"success":e.chlValid==2?"error":"info"},e.chlValid==1?"有效":e.chlValid==2?"无效":"")),oe=e=>{const t=new Date,n=t.getFullYear(),h=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),c=String(t.getMinutes()).padStart(2,"0"),d=String(t.getSeconds()).padStart(2,"0");return`${n}-${h}-${i} ${a}:${c}:${d}`},{drawerVisible:Je,operateType:We,editingData:Ge,handleAdd:Me,handleEdit:He,checkedRowKeys:V,onBatchDeleted:Qe,onDeleted:Ye}=Ee(x,b),j=e=>{try{return JSON.parse(e),!0}catch{return!1}};return(e,t)=>{const n=Ue,h=Te,i=$e,a=ie,c=De,d=Ne,g=ce,u=Ae,_=ze,y=Ce,s=Re,m=qe;return me(),fe("div",je,[o(m,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:p(()=>[o(d,{align:"center",wrap:"",justify:"start",class:"lt-sm:w-200px"},{default:p(()=>[o(c,null,{default:p(()=>[o(n,null,{default:p(()=>[U("测点类型")]),_:1}),o(h,{filterable:"",clearable:"",placeholder:"请选择",value:l(f).tagType,"onUpdate:value":t[0]||(t[0]=r=>l(f).tagType=r),options:l(ge)(l(Oe))},null,8,["value","options"]),o(i,{clearable:"",value:l(f).fuzzy,"onUpdate:value":[t[1]||(t[1]=r=>l(f).fuzzy=r),Z],placeholder:"请输入测点名称或描述",style:{width:"150%"},onKeyup:ye(l(b),["enter"])},null,8,["value","onKeyup"]),o(l(ve),{type:"primary",ghost:"",onClick:l(b)},{icon:p(()=>[o(a,{class:ke(["text-icon",{"animate-spin":l(A)}])},null,8,["class"])]),default:p(()=>[U(" 搜索 ")]),_:1},8,["onClick"])]),_:1}),M("div",Be,[o(l(be),{checked:C.value,"onUpdate:checked":[t[2]||(t[2]=r=>C.value=r),ne]},{default:p(()=>[U(" 实时刷新 ")]),_:1},8,["checked"]),we(M("span",{class:"font-size-14px color-blank",style:{"font-weight":"600"}}," 刷新时间："+Se(z.value),513),[[xe,z.value]])])]),_:1})]),"header-extra":p(()=>[o(d,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:p(()=>[o(g,{columns:l(D),"onUpdate:columns":t[3]||(t[3]=r=>H(D)?D.value=r:null)},null,8,["columns"])]),_:1})]),default:p(()=>[o(s,{direction:"horizontal",class:"sm:h-full","default-size":.15,max:.35,min:.1,"resize-trigger-size":6},{1:p(()=>[o(_,{style:{"max-height":"700px"}},{default:p(()=>[o(u,{"block-line":"","default-expand-all":"",data:v.value,"checked-keys":I.value,"expand-on-click":!1,"render-prefix":se,"render-suffix":le,"check-strategy":"child","onUpdate:checkedKeys":ae,checkable:""},null,8,["data","checked-keys"])]),_:1})]),2:p(()=>[o(y,{"checked-row-keys":l(V),"onUpdate:checkedRowKeys":t[4]||(t[4]=r=>H(V)?V.value=r:null),columns:l(Y),data:l(x),size:"small",loading:l(A),remote:"","row-key":r=>r.id,"flex-height":!0,"scroll-x":"",pagination:l(x).length?l(X):void 0,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1})])}}}),ct=Ie(Ke,[["__scopeId","data-v-eca90f0d"]]);export{ct as default};
