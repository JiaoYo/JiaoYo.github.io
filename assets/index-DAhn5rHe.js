import{_ as oe}from"./table-header-operation.vue_vue_type_script_setup_true_lang-GPpnIQnS.js";import{d as q,q as O,v as X,s as Z,o as G,c as J,w as o,g as e,h as z,t as B,i as s,$ as v,M as se,A as re,aj as Q,E as Y,B as E,D as ee,a9 as ae,r as M,x as ie,b as ue,y as me,C as de,X as ce,aa as pe,ab as fe,Z as ge,L as V,K,e as _e,ac as F,ad as ve}from"./index-DvMCw3Rq.js";import{u as he,a as we}from"./table-T3UoskuP.js";import{_ as ye}from"./round-search-CPVQQ3N4.js";import{_ as be}from"./round-refresh-Den4pxAc.js";import{_ as xe}from"./FormItemGridItem-B8AmNpme.js";import{_ as De}from"./Grid-BUt7FBa5.js";import{u as Ne}from"./usePageData-Cbb2Peb0.js";import{a as ke,b as Se,c as Ce,d as Te,e as ze}from"./events-DWT4oJab.js";import{f as Ue,a as Pe}from"./common-DB2ifYfK.js";import{_ as $e}from"./Cascader-aaUb4dMh.js";import{h as H}from"./permission-DNIrq0y6.js";import{_ as Ae}from"./Popconfirm-CJ9s7qbW.js";import{_ as Ie}from"./DataTable-BnT_71C1.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-euck9wG-.js";import"./setting-outlined-DTG_YXIc.js";import"./round-delete-BPVE9jtM.js";import"./refresh-BAOyiUZF.js";import"./Upload-DUayfKBS.js";import"./Progress-CRnql7vs.js";import"./Forward-Cwgm3-FY.js";const Le=q({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:O(["reset","search"],["update:model"]),setup(h,{emit:U}){const r=U,{formRef:y,restoreValidation:b}=X(),t=Z(h,"model");function S(c){t.value.fuzzy=c.replace(/\s/g,"")}function P(c){return!c.startsWith(" ")&&!c.endsWith(" ")}function D(){t.value.fuzzy=null,r("search")}async function $(){await b(),r("reset")}async function l(){var c,i,x,g;if(t.value.mintime&&t.value.maxtime&&t.value.maxtime-t.value.mintime<0)return(c=window.$message)==null||c.destroyAll(),(i=window.$message)==null||i.error("最小限定时间不得大于最大限定时间"),!1;if(t.value.minagg&&t.value.maxagg&&t.value.maxagg-t.value.minagg<0)return(x=window.$message)==null||x.destroyAll(),(g=window.$message)==null||g.error("最小聚合次数不得大于最大聚合次数"),!1;r("search")}return(c,i)=>{const x=re,g=xe,p=Q,w=Y,A=be,I=E,L=ye,R=De,N=ee,C=ae;return G(),J(C,{bordered:!1,size:"small",class:"card-wrapper"},{default:o(()=>[e(N,{ref_key:"formRef",ref:y,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:se(l,["enter"])},{default:o(()=>[e(R,{responsive:"screen","item-responsive":""},{default:o(()=>[e(g,{span:"24 s:12 m:6",label:"策略名称",path:"fuzzy",class:"pr-24px"},{default:o(()=>[e(x,{clearable:"",value:t.value.fuzzy,"onUpdate:value":i[0]||(i[0]=f=>t.value.fuzzy=f),placeholder:"请输入策略名称",onInput:S,"allow-input":P,onClear:D},null,8,["value"])]),_:1}),e(g,{span:"24 s:12 m:7",label:"最大限定时间",class:"pr-24px"},{default:o(()=>[e(w,{wrap:!1,align:"center"},{default:o(()=>[e(p,{value:t.value.mintime,"onUpdate:value":i[1]||(i[1]=f=>t.value.mintime=f),min:0,placeholder:"最小限定时间"},null,8,["value"]),z(" — "),e(p,{value:t.value.maxtime,"onUpdate:value":i[2]||(i[2]=f=>t.value.maxtime=f),min:0,placeholder:"最大限定时间"},null,8,["value"])]),_:1})]),_:1}),e(g,{span:"24 s:12 m:7",label:"最大聚合次数",class:"pr-24px"},{default:o(()=>[e(w,{wrap:!1,align:"center"},{default:o(()=>[e(p,{value:t.value.minagg,"onUpdate:value":i[3]||(i[3]=f=>t.value.minagg=f),min:0,placeholder:"最小聚合次数"},null,8,["value"]),z(" — "),e(p,{value:t.value.maxagg,"onUpdate:value":i[4]||(i[4]=f=>t.value.maxagg=f),min:0,placeholder:"最大聚合次数"},null,8,["value"])]),_:1})]),_:1}),e(g,{span:"24 m:4",class:"pr-24px"},{default:o(()=>[e(w,{class:"w-full"},{default:o(()=>[e(I,{onClick:$},{icon:o(()=>[e(A,{class:"text-icon"})]),default:o(()=>[z(" "+B(s(v)("common.reset")),1)]),_:1}),e(I,{type:"primary",ghost:"",onClick:l},{icon:o(()=>[e(L,{class:"text-icon"})]),default:o(()=>[z(" "+B(s(v)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Re=q({name:"OperateDrawer",__name:"operate-drawer",props:O({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:O(["submitted"],["update:visible"]),setup(h,{emit:U}){const r=h,y=U,b=M({eventsTypeDataList:[]}),t=Z(h,"visible"),{formRef:S,validate:P,restoreValidation:D}=X();ie();const $=ue(()=>({add:"新增聚合策略",edit:"修改聚合策略"})[r.operateType]),l=M(c());function c(){return{etid:null,mrules:null,maxtime:86400,maxagg:2e4,forward:null,sysparam:0}}const i={etid:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},mrules:{type:"array",required:!0,trigger:["blur","change"],message:"不能为空"},maxtime:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},maxagg:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"}};async function x(){const{data:n,error:a}=await Ue();a||(b.eventsTypeDataList=n,g())}async function g(){const{data:n,error:a}=await Pe();a||b.eventsTypeDataList.forEach(u=>{u.children=n.filter(d=>d.pid===u.id)})}const p=M({data:[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}]}),{pageData:w,getData:A,nextPage:I}=Ne(ke),L=async n=>{const a=n.currentTarget;a.scrollTop+a.offsetHeight>=a.scrollHeight&&w.data.length<w.total&&I()};function R(){x(),A(),Object.assign(l,c()),r.operateType==="edit"&&r.rowData&&(r.rowData.mrules=r.rowData.mrules?r.rowData.mrules.split(",").map(Number):[],r.rowData.forward=r.rowData.forward?r.rowData.forward.split(",").map(Number):[],Object.assign(l,r.rowData))}function N(){t.value=!1}async function C(){var n,a,u,d,k,m;if(await P(),r.operateType==="add"){const{data:j,error:T}=await Se([{etid:l.etid,mrules:(n=l.mrules)==null?void 0:n.join(","),maxtime:l.maxtime,maxagg:l.maxagg,forward:(a=l.forward)==null?void 0:a.join(",")}]);T||((u=window.$message)==null||u.success(v("common.addSuccess")),N(),y("submitted"))}else{const{data:j,error:T}=await Ce([{id:r.rowData.id,etid:l.etid,mrules:(d=l.mrules)==null?void 0:d.join(","),maxtime:l.maxtime,maxagg:l.maxagg,forward:(k=l.forward)==null?void 0:k.join(",")}]);T||((m=window.$message)==null||m.success(v("common.updateSuccess")),N(),y("submitted"))}}const f=n=>n.ipaddr+":"+n.fport+" ("+(n.ftype==0?"syslog":"SNMP Trap")+")";return me(t,()=>{t.value&&(R(),D())}),(n,a)=>{const u=$e,d=de,k=ce,m=Q,j=ee,T=E,te=Y,le=pe,ne=fe;return G(),J(ne,{show:t.value,"onUpdate:show":a[5]||(a[5]=_=>t.value=_),"display-directive":"show",width:450},{default:o(()=>[e(le,{title:$.value,"native-scrollbar":!1,closable:""},{footer:o(()=>[e(te,{size:16},{default:o(()=>[e(T,{onClick:N},{default:o(()=>[z(B(s(v)("common.cancel")),1)]),_:1}),e(T,{type:"primary",onClick:C},{default:o(()=>[z(B(s(v)("common.confirm")),1)]),_:1})]),_:1})]),default:o(()=>[e(j,{ref_key:"formRef",ref:S,model:l,rules:i},{default:o(()=>[e(d,{label:"策略名称",path:"etid"},{default:o(()=>[e(u,{value:l.etid,"onUpdate:value":a[0]||(a[0]=_=>l.etid=_),clearable:"","check-strategy":"child",placeholder:"请选择策略名称",options:b.eventsTypeDataList,"show-path":!1,filterable:"","value-field":"id","label-field":"pname"},null,8,["value","options"])]),_:1}),e(d,{label:"匹配规则",path:"mrules"},{default:o(()=>[e(k,{"max-tag-count":2,value:l.mrules,"onUpdate:value":a[1]||(a[1]=_=>l.mrules=_),multiple:"",placeholder:"请选择匹配规则",clearable:"",filterable:"",options:p.data,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),e(d,{label:"最大限定时间",path:"maxtime"},{default:o(()=>[e(m,{value:l.maxtime,"onUpdate:value":a[2]||(a[2]=_=>l.maxtime=_),clearable:"",min:0,placeholder:"请输入最大限定时间(秒)",style:{width:"100%"}},null,8,["value"])]),_:1}),e(d,{label:"最大聚合次数",path:"maxagg"},{default:o(()=>[e(m,{value:l.maxagg,"onUpdate:value":a[3]||(a[3]=_=>l.maxagg=_),clearable:"",min:0,placeholder:"请输入最大聚合次数",style:{width:"100%"}},null,8,["value"])]),_:1}),e(d,{label:"转发类型",path:"forward"},{default:o(()=>[e(k,{"max-tag-count":1,value:l.forward,"onUpdate:value":a[4]||(a[4]=_=>l.forward=_),multiple:"",placeholder:"请选择转发类型",clearable:"","render-label":f,filterable:"","value-field":"id","label-field":"ipaddr",options:s(w).data,"reset-menu-on-options-change":!1,onScroll:L},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),je={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function W(h){return typeof h=="function"||Object.prototype.toString.call(h)==="[object Object]"&&!ve(h)}const oa=q({name:"eventalarm_aggregatepolicy",__name:"index",setup(h){const U=ge(),{columns:r,columnChecks:y,data:b,getData:t,loading:S,mobilePagination:P,searchParams:D,resetSearchParams:$}=he({apiFn:Te,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,mintime:null,maxtime:null,minagg:null,maxagg:null,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48,fixed:"left"},{key:"pname",title:"策略名称",align:"center",width:160,ellipsis:{tooltip:!0}},{key:"maxtime",title:"最大限定时间(秒)",align:"center",width:180},{key:"maxagg",title:"最大聚合次数",align:"center",width:180},{key:"mrules",title:"匹配规则",align:"center",width:160,render:n=>{const a=n.matchingRulesPojos.length>0?n.matchingRulesPojos.map(u=>u.mname).join(", "):"";return e("div",null,[e("span",null,[a])])}},{key:"operate",title:v("common.operate"),align:"center",width:160,fixed:"right",render:n=>{let a;return n.sysparam!=0&&e("div",{class:"flex-center gap-8px"},[V(e(E,{type:"info",ghost:!0,size:"small",onClick:()=>R(n.id)},W(a=v("common.edit"))?a:{default:()=>[a]}),[[K("no-auth"),"aggregate.policy.update"]]),e(Ae,{onPositiveClick:()=>N(n.id)},{default:()=>v("common.confirmDelete"),trigger:()=>{let u;return V(e(E,{type:"error",ghost:!0,size:"small"},W(u=v("common.delete"))?u:{default:()=>[u]}),[[K("no-auth"),"aggregate.policy.delete"]])}})])}}]}),{drawerVisible:l,operateType:c,editingData:i,handleAdd:x,handleEdit:g,checkedRowKeys:p,onBatchDeleted:w,onDeleted:A,closeDrawer:I}=we(b,t);async function L(){console.log(p.value),C(p.value,n=>{w()})}function R(n){g(n)}function N(n){console.log(n),C([n],a=>{A()})}async function C(n,a){const{data:u,error:d}=await ze(n);if(!d)a&&a(u);else return!1}async function f(){}return(n,a)=>{const u=oe,d=Ie,k=ae;return G(),_e("div",je,[e(Le,{model:s(D),"onUpdate:model":a[0]||(a[0]=m=>F(D)?D.value=m:null),onReset:s($),onSearch:s(t)},null,8,["model","onReset","onSearch"]),e(k,{title:"聚合策略",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":o(()=>[e(u,{columns:s(y),"onUpdate:columns":a[1]||(a[1]=m=>F(y)?y.value=m:null),"disabled-delete":s(p).length===0,loading:s(S),onAdd:s(x),onDelete:L,onRefresh:s(t),"is-view-export-button":!0,onExportHandler:f,"is-view-add-button":s(H)("aggregate.policy.insert"),"is-view-delete-button":s(H)("aggregate.policy.delete")},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","is-view-delete-button"])]),default:o(()=>[e(d,{"checked-row-keys":s(p),"onUpdate:checkedRowKeys":a[2]||(a[2]=m=>F(p)?p.value=m:null),columns:s(r),data:s(b),size:"small","flex-height":!s(U).isMobile,"scroll-x":s(r).reduce((m,j)=>m+j.width,0),loading:s(S),remote:"","row-key":m=>m.id,pagination:s(P),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),e(Re,{visible:s(l),"onUpdate:visible":a[3]||(a[3]=m=>F(l)?l.value=m:null),"operate-type":s(c),"row-data":s(i),onSubmitted:s(t)},null,8,["visible","operate-type","row-data","onSubmitted"])]),_:1})])}}});export{oa as default};
