import{d as J,n as B,p as ie,s as q,o as L,c as H,w as n,g as t,i as h,W as oe,aE as se,h as D,t as C,$ as y,F as ue,aF as re,aG as ce,Z as de,B as U,N as W,O as pe,ad as Q,a3 as Z,j as S,ae as fe,r as G,av as F,e as X,ay as me,aj as Y,az as _e,S as ve,ar as ge,P as he,Q as ye,f as ee,ai as te,R as ae}from"./index-BhOJVS27.js";import{f as be,a as xe,b as we,c as ke}from"./audit-events-D7PE56_8.js";import{_ as Se,l as le}from"./lodash-CJ8_w8Qw.js";import{T as j}from"./basicconf-DYRBxwRP.js";import{_ as De}from"./round-search-CqH3eS4c.js";import{_ as Te}from"./round-refresh-CkgqxWk9.js";import{u as Ce}from"./usePageData-DmEOFzyz.js";import{_ as Ne}from"./FormItemGridItem-Dmos8hFe.js";import{_ as Ae}from"./DatePicker-mBsqPNQM.js";import{_ as ze}from"./Grid-tM_jPr8x.js";import{f as Ie}from"./events-yVVFNEDL.js";import{_ as Pe,a as $e}from"./DescriptionsItem-BLG8NKeC.js";import{e as Ve}from"./exportExcel-D6OyA9oJ.js";import"./TimePicker-DV6YlNrn.js";import"./defineProperty-iicF0pfM.js";const Me=J({name:"FormSearch",__name:"form-search",props:B({AuditTypeData:{},AuditPolicyData:{}},{model:{required:!0},modelModifiers:{}}),emits:B(["reset","search"],["update:model"]),setup(_,{emit:P}){const A=_,k=P,{formRef:i,restoreValidation:z}=ie(),c=q(_,"model");Ce(re);async function d(r,l){r&&r.length>0?(c.value.startTime=r[0],c.value.endTime=r[1]):(c.value.startTime=null,c.value.endTime=null),k("search")}async function $(){await z(),c.value.timeRange=null,c.value.atype=null,c.value.ap=null,c.value.startTime=null,c.value.endTime=null,c.value.elevel=null,ce(()=>{k("search")})}async function b(){k("search")}const I=Se.debounce(b,1e3,{leading:!0,trailing:!1});return(r,l)=>{const g=de,s=Ne,x=Ae,T=Te,v=U,w=De,N=W,V=ze,M=pe,o=Q;return L(),H(o,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[t(M,{ref_key:"formRef",ref:i,model:c.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:ue(h(I),["enter"])},{default:n(()=>[t(V,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:n(()=>[t(s,{span:"24 s:12 m:8 l:8",label:"事件等级",path:"elevel"},{default:n(()=>[t(g,{filterable:"",clearable:"",value:c.value.elevel,"onUpdate:value":[l[0]||(l[0]=e=>c.value.elevel=e),b],placeholder:"请选择事件等级",options:h(oe)(h(se))},null,8,["value","options"])]),_:1}),t(s,{span:"24 s:12 m:8 l:8",label:"审计策略",path:"ap"},{default:n(()=>[t(g,{value:c.value.ap,"onUpdate:value":[l[1]||(l[1]=e=>c.value.ap=e),b],placeholder:"请选择审计策略",clearable:"",filterable:"","value-field":"id","label-field":"pname",options:A.AuditPolicyData,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),t(s,{span:"24 s:24 m:16 l:10",label:"产生时间",path:"timeRange"},{default:n(()=>[t(x,{clearable:"",value:c.value.timeRange,"onUpdate:value":l[2]||(l[2]=e=>c.value.timeRange=e),type:"datetimerange","value-format":"yyyy-MM-dd HH:mm:ss",style:{width:"100%"},"onUpdate:formattedValue":d},null,8,["value"])]),_:1}),t(s,{span:"24 s:24 m:8 l:10",label:" "},{default:n(()=>[t(N,{class:"w-full"},{default:n(()=>[t(v,{onClick:$},{icon:n(()=>[t(T,{class:"text-icon"})]),default:n(()=>[D(" "+C(h(y)("common.reset")),1)]),_:1}),t(v,{type:"primary",ghost:"",onClick:h(I)},{icon:n(()=>[t(w,{class:"text-icon"})]),default:n(()=>[D(" "+C(h(y)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),ne=_=>(he("data-v-2fc23756"),_=_(),ye(),_),Oe=ne(()=>ee("span",null,"事件信息",-1)),Ee=ne(()=>ee("span",null,"事件溯源",-1)),Le={key:0,style:{display:"flex","justify-content":"center","align-items":"center",color:"#606266","font-size":"14px",height:"500px"}};function Re(_){return typeof _=="function"||Object.prototype.toString.call(_)==="[object Object]"&&!te(_)}const Ge=J({__name:"detailInfo",props:B({detailInfo:{},AuditTypeData:{},AuditPolicyData:{}},{detailVisible:{default:!1},detailVisibleModifiers:{}}),emits:["update:detailVisible"],setup(_){const P=Z(),A=q(_,"detailVisible"),k=_,i=S();fe(()=>A.value,async l=>{l&&(i.value=k.detailInfo,$())});const z=[{title:"",key:"index",width:50,render:l=>`${l.index}`},{key:"pname1",title:"安全事件名称",align:"center",minWidth:160,ellipsis:{tooltip:!0}},{key:"pname1",title:"安全事件类型",align:"center",width:140},{key:"pname2",title:"安全事件类别",align:"center",width:140},{key:"elevel",title:"事件等级",align:"center",width:120,render:l=>{(l.elevel===void 0||l.elevel===null)&&(l.elevel=1);const g={0:"#8e9dff",1:"#5da8ff",2:"#fedc69",3:"#ff9874",4:"#ff0000"},s=y(j[l.elevel]);let x={color:g[l.elevel],textColor:"#ffffff",borderColor:g[l.elevel]};return t(F,{size:"small",color:x},Re(s)?s:{default:()=>[s]})}},{key:"aggre",title:"聚合数量",align:"center",width:120},{key:"aggrestarttime",title:"聚合开始时间",align:"center",width:180},{key:"type",title:"发生源设备类型",align:"center",width:160}],c=S(!1);let d=G([]);const $=async l=>{var x;if(!c.value)c.value=!0;else return;let{data:g,error:s}=await Ie({pageId:l,auditid:(x=i.value)==null?void 0:x.auditid,limit:20});if(!s){c.value=!1;const T=g==null?void 0:g.sort((v,w)=>w.id-v.id);l?d=[...d,...T]:d=T,d=d.map((v,w)=>(v.index=w+1,v))}};function b(l){var s;Math.abs(l.target.scrollTop+l.target.offsetHeight-l.target.scrollHeight)<=20&&((s=i.value)==null?void 0:s.eco)>d.length&&I()}const I=le.debounce(()=>{$(d[d.length-1].id)},300),r=G({page:1,pageCount:1,pageSize:20,total:0,prefix({startIndex:l,endIndex:g,page:s,pageSize:x,pageCount:T,itemCount:v}){var w,N;return`已加载${d.length}条 共${(d.length>((w=i.value)==null?void 0:w.eco)?d.length:(N=i.value)==null?void 0:N.eco)||0}条`}});return(l,g)=>{const s=Pe,x=$e,T=W,v=me,w=Y,N=_e,V=ve,M=ge;return L(),H(M,{show:A.value,"onUpdate:show":g[0]||(g[0]=o=>A.value=o),title:"事件详情",preset:"card",class:"w-1200px"},{default:n(()=>[t(V,{class:"max-h-600px pr-20px"},{default:n(()=>[t(N,{type:"line",animated:""},{default:n(()=>[t(v,{name:"1"},{tab:n(()=>[Oe]),default:n(()=>[t(T,{vertical:"",size:12},{default:n(()=>[t(x,{"label-placement":"left",bordered:"",column:2,"label-style":{width:"160px"}},{default:n(()=>[t(s,{label:"审计事件名称"},{default:n(()=>{var o;return[D(C((o=i.value)==null?void 0:o.aename),1)]}),_:1}),t(s,{label:"审计类型"},{default:n(()=>{var o,e;return[D(C(((o=k.AuditTypeData.find(a=>{var u;return a.id===((u=i.value)==null?void 0:u.atype)}))==null?void 0:o.atypename)||((e=i.value)==null?void 0:e.atype)||""),1)]}),_:1}),t(s,{label:"审计策略"},{default:n(()=>{var o,e;return[D(C(((o=k.AuditPolicyData.find(a=>{var u;return a.id===((u=i.value)==null?void 0:u.ap)}))==null?void 0:o.pname)||((e=i.value)==null?void 0:e.ap)||""),1)]}),_:1}),t(s,{label:"事件等级"},{default:n(()=>{var o,e,a,u,p,f,m,O,R,E;return[t(h(F),{size:"small",color:{textColor:"#ffffff",borderColor:((o=i.value)==null?void 0:o.alevel)===0?"#8e9dff":((e=i.value)==null?void 0:e.alevel)===1?"#5da8ff":((a=i.value)==null?void 0:a.alevel)===2?"#fedc69":((u=i.value)==null?void 0:u.alevel)===3?"#ff9874":((p=i.value)==null?void 0:p.alevel)===4?"#ff0000":"#5da8ff",color:((f=i.value)==null?void 0:f.alevel)===0?"#8e9dff":((m=i.value)==null?void 0:m.alevel)===1?"#5da8ff":((O=i.value)==null?void 0:O.alevel)===2?"#fedc69":((R=i.value)==null?void 0:R.alevel)===3?"#ff9874":((E=i.value)==null?void 0:E.alevel)===4?"#ff0000":"#5da8ff"}},{default:n(()=>{var K;return[D(C(h(y)(h(j)[(K=i.value)==null?void 0:K.alevel])),1)]}),_:1},8,["color"])]}),_:1}),t(s,{label:"产生时间"},{default:n(()=>{var o;return[D(C((o=i.value)==null?void 0:o.dbtime),1)]}),_:1}),t(s,{label:"更新时间"},{default:n(()=>{var o;return[D(C((o=i.value)==null?void 0:o.uptime),1)]}),_:1}),t(s,{label:"事件总数"},{default:n(()=>{var o;return[D(C((o=i.value)==null?void 0:o.eco),1)]}),_:1})]),_:1})]),_:1})]),_:1}),t(v,{name:"2"},{tab:n(()=>[Ee]),default:n(()=>[h(d).length==0?(L(),X("div",Le," 暂无安全事件信息 ")):(L(),H(w,{key:1,style:{height:"500px"},columns:z,remote:"",data:h(d),size:"small","scroll-x":762,"row-key":o=>o.id,"virtual-scroll":"",loading:c.value,"flex-height":!h(P).isMobile,pagination:r,onScroll:b},null,8,["data","row-key","loading","flex-height","pagination"]))]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])}}}),je=ae(Ge,[["__scopeId","data-v-2fc23756"]]),Be={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function He(_){return typeof _=="function"||Object.prototype.toString.call(_)==="[object Object]"&&!te(_)}const Ue=J({name:"audit_event",__name:"index",setup(_){const P=S(window.innerHeight-395),A=Z(),k=S(!1),i=S(),z=S([]);(async()=>{const{data:e,error:a}=await be({page:1,limit:1e3});a||(z.value=JSON.parse(JSON.stringify(e)).list)})();const d=S([]);(async()=>{const{data:e,error:a}=await xe({page:1,limit:1e3});a||(d.value=JSON.parse(JSON.stringify(e)).list)})();const b=G({limit:100,pageId:void 0,elevel:void 0,atype:void 0,uid:void 0,suditPolicy:void 0,startTime:void 0,endTime:void 0,fuzzy:void 0,_t:new Date().getTime()}),I=[{title:"",key:"index",width:80,align:"center",render:e=>`${e.index}`},{key:"aename",title:y("page.audit.event.eventName"),align:"center",minWidth:160,ellipsis:!0,resizable:!0},{key:"dbtime",title:y("page.audit.event.createTime"),align:"center",width:220,resizable:!0},{key:"uptime",title:y("page.audit.event.updateTime"),align:"center",width:220,resizable:!0},{key:"ap",title:y("page.audit.event.strategy"),align:"center",width:220,render:e=>{var u;const a=(u=d.value.find(p=>p.id===e.ap))==null?void 0:u.pname;return t("span",null,[a||e.ap])},resizable:!0},{key:"alevel",title:y("page.audit.event.eventRanK"),align:"center",width:220,render:e=>{(e.alevel===void 0||e.alevel===null)&&(e.alevel=0);const a={0:"#8e9dff",1:"#5da8ff",2:"#fedc69",3:"#ff9874",4:"#ff0000"},u=y(j[e.alevel]);let p={color:a[e.alevel],textColor:"#ffffff",borderColor:a[e.alevel]};return t(F,{size:"small",color:p},He(u)?u:{default:()=>[u]})},resizable:!0},{key:"eco",title:y("page.audit.event.eventCount"),align:"center",width:220,resizable:!0},{key:"operate",title:y("common.operate"),align:"center",width:220,fixed:"right",render:e=>t("div",{class:"flex-center gap-8px"},[t(U,{type:"primary",ghost:!0,size:"small",onClick:()=>M(e)},{default:()=>[D("详情")]})])}],r=S([]),l=S(!1),g=S(0),s=async(e=!1)=>{if(!l.value)l.value=!0;else return;l.value=!0;const{data:a,error:u}=await we(b);u||(g.value=a.length,e?r.value=[...r.value,...a]:r.value=a,r.value=r.value.sort((p,f)=>f.id-p.id).map((p,f)=>(p.index=f+1,p)),l.value=!1)};s();const x=S(!0),T=()=>{r.value=[],b.pageId=void 0,(a=>Object.keys(a).filter(f=>f!=="limit"&&f!=="_t").some(f=>a[f]!==void 0&&a[f]!==""&&a[f]!==null))(b)?x.value=!1:(x.value=!0,w()),s()},v=G({page:1,pageCount:1,pageSize:20,total:0,prefix({startIndex:e,endIndex:a,page:u,pageSize:p,pageCount:f,itemCount:m}){return`已加载${r.value.length}条`+(r.value.length?x.value?` 共计 ${r.value.length>0?m??0:0} 条`:g.value==b.limit?"  预计还有更多":"  没有更多了":"")}});async function w(){const{data:e,error:a}=await ke();a||(v.pageCount=20,v.total=Number(e),v.itemCount=Number(e))}w();function N(e){var u;Math.abs(e.target.scrollTop+e.target.offsetHeight-e.target.scrollHeight)<=20&&v.total>((u=r.value)==null?void 0:u.length)&&V()}const V=le.debounce(()=>{var e;((e=r.value)==null?void 0:e.length)<v.total&&(b.pageId=r.value[r.value.length-1].id,s(!0))},300);async function M(e){i.value=e,k.value=!0}async function o(){if(!r.value.length)return;const e=JSON.parse(JSON.stringify(r.value)),a=[];e.forEach(p=>{const f={};I.forEach(m=>{var O;if(p.hasOwnProperty(m.key)){const R=m.key=="alevel"?p[m.key]!=null?y(j[p[m.key]]):"":m.key=="ap"?(O=d.value.find(E=>E.id===E[m.key]))==null?void 0:O.pname:p[m.key];f[m.title]=R}}),a.push(f)}),Ve(a,500,[{wpx:100},{wpx:100},{wpx:100},{wpx:100},{wpx:100},{wpx:100},{wpx:50}],"审计事件_"+new Date().getTime())}return(e,a)=>{const u=W,p=Y,f=Q;return L(),X("div",Be,[t(Me,{model:b,"onUpdate:model":a[0]||(a[0]=m=>b=m),onSearch:T,AuditTypeData:z.value,AuditPolicyData:d.value},null,8,["model","AuditTypeData","AuditPolicyData"]),t(f,{title:h(y)("page.audit.event.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":n(()=>[t(u,null,{default:n(()=>[t(h(U),{type:"primary",size:"small",ghost:"",onClick:o,title:"导出已加载"},{default:n(()=>[D("导出已加载")]),_:1})]),_:1})]),default:n(()=>[t(p,{columns:I,data:r.value,size:"small","virtual-scroll":"","flex-height":!h(A).isMobile,loading:l.value,remote:"","row-key":m=>m.id,"max-height":P.value,pagination:v,onScroll:N,class:"sm:h-full","scroll-x":""},null,8,["data","flex-height","loading","row-key","max-height","pagination"]),t(je,{"detail-visible":k.value,"onUpdate:detailVisible":a[1]||(a[1]=m=>k.value=m),"detail-info":i.value,AuditTypeData:z.value,AuditPolicyData:d.value},null,8,["detail-visible","detail-info","AuditTypeData","AuditPolicyData"])]),_:1},8,["title"])])}}}),ot=ae(Ue,[["__scopeId","data-v-1f48bfb0"]]);export{ot as default};
