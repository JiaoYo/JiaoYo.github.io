import{_ as Re}from"./table-header-operation.vue_vue_type_script_setup_true_lang-CYXPffdN.js";import{d as ae,n as ee,s as de,p as me,q as ze,j as Q,b as $e,$ as s,r as Pe,ae as Ae,D as W,o as T,c as M,w as l,g as t,h as k,t as $,i as n,E as I,f as le,e as ce,am as Oe,W as te,aY as Ve,ao as je,G as X,aE as Me,aZ as Fe,a_ as re,J as fe,K as Be,as as Ee,N as _e,aq as Ge,Z as ye,ap as Ie,O as ge,B as Z,af as qe,ag as He,a$ as Ke,F as We,ad as ve,a3 as Ze,av as ie,b0 as Je,b1 as Ye,ah as H,ai as Qe,aj as Xe}from"./index-CTE4RAgR.js";import{f as et,l as tt,m as at,n as lt,o as nt}from"./audit-events-CEnuoXbP.js";import{u as ot,a as st}from"./table-C3L7m_zy.js";import{u as ue}from"./usePageData-Ch8DbpGj.js";import{a as rt}from"./events-H_0aDo8p.js";import{f as it,a as ut}from"./common-DzirPM2L.js";import{_ as pt}from"./TimePicker-BtyvcOYh.js";import{_ as dt}from"./Cascader-B7Wxx2Sd.js";import{_ as mt}from"./DatePicker-ClU2Dh7U.js";import{_ as ct}from"./round-search-BNMS_ksz.js";import{_ as ft}from"./round-refresh-BKeT2tG8.js";import{_ as _t}from"./lodash-D1iG1f7x.js";import{_ as yt}from"./FormItemGridItem-JyiYwovC.js";import{_ as gt}from"./Grid-dhU6i2aZ.js";import{h as pe}from"./permission-0Malggk5.js";import{T as vt}from"./basicconf-BOrZ8pgN.js";import{_ as ht}from"./Popconfirm-Doe4SR64.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-QC-wxysk.js";import"./setting-outlined-XwLU2CjG.js";import"./export-CETv0EdR.js";import"./refresh-DLW7RuNx.js";import"./round-delete-BMMSb3GD.js";import"./round-plus-CxGLMXGF.js";import"./Upload-JNwWpAgi.js";import"./Progress-DQ0D9Z9p.js";import"./defineProperty-DxPKGhc9.js";const bt={class:"w-100%"},wt=le("span",null,"至",-1),kt=le("span",null,"至",-1),Dt=ae({name:"OperateDrawer",__name:"operate-drawer",props:ee({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:ee(["submitted"],["update:visible"]),setup(D,{emit:F}){const p=D,N=F,h=de(D,"visible"),{formRef:c,validate:P,restoreValidation:B}=me(),{defaultRequiredRule:v}=ze(),U=Q([]),A=$e(()=>({add:s("page.audit.strategy.addTitle"),edit:s("page.audit.strategy.editTitle")})[p.operateType]),e=Pe(O());function O(){return{pname:"",aetype:0,psort:0,pcontent:null,efftime:0,starttime:null,endtime:null,aename:"",alevel:0,atype:null,pdesc:"",forsys:"",status:0,ptype:1,weekstart:void 0,weekend:void 0}}const C={pname:v,starttime:v,pcontent:{type:"array",required:!0,trigger:["change","blur"],message:"请选择事件"},endtime:v,weekstart:{type:"number",required:!0,trigger:["change","blur"],message:"请选择星期"},weekend:{type:"number",required:!0,trigger:["change","blur"],message:"请选择星期"},time:v,efftime:{type:"number",required:!0,trigger:"change",message:"请选择审计类型"},atype:{type:"number",required:!0,trigger:"change",message:"请选择审计类型"}},V=()=>["星期一","星期二","星期三","星期四","星期五","星期六","星期天"].map((a,_)=>({label:a,value:_+1}));async function b(){await q(),await G(),await m(),Object.assign(e,O()),p.operateType==="edit"&&p.rowData&&(p.rowData.pcontent=p.rowData.pcontent?p.rowData.pcontent.split(",").map(Number):[],p.rowData.starttime=p.rowData.starttime?p.rowData.starttime:void 0,p.rowData.endtime=p.rowData.endtime?p.rowData.endtime:void 0,p.rowData.forsys=p.rowData.forsys?p.rowData.forsys.split(",").map(Number):[],Object.assign(e,p.rowData),f.value=[e.starttime,e.endtime])}function x(){h.value=!1}const S=Q([]);async function q(){const{data:i,error:a}=await it();a||(S.value=i,i.forEach(_=>{U.value.push(_.id)}),await E())}async function E(){const{data:i,error:a}=await ut();if(!a){let _=S.value.concat(i);S.value=Fe(_)}}const{pageData:L,getData:G,nextPage:j}=ue(et),r=async i=>{const a=i.currentTarget;a.scrollTop+a.offsetHeight>=a.scrollHeight&&L.data.length<L.total&&j()},{pageData:u,getData:m,nextPage:R}=ue(rt),J=async i=>{const a=i.currentTarget;a.scrollTop+a.offsetHeight>=a.scrollHeight&&u.data.length<u.total&&R()},f=Q(null);async function he(i,a){e.starttime=re(1,a[0]),e.endtime=re(1,a[1])}async function be(i,a){console.log(e.pcontent)}async function we(){var a,_,d,g;await P();let i=[];if(e.pcontent&&e.pcontent.length>0&&(i=e.pcontent.filter(y=>!U.value.includes(y))),e.efftime!=1&&(e.weekstart=null,e.weekend=null),p.operateType==="add"){const{data:y,error:w}=await tt([{pname:e.pname,aetype:e.aetype,psort:e.psort,pcontent:i.length>0?i.join(","):"",efftime:e.efftime,starttime:e.starttime,endtime:e.endtime,aename:e.aename,alevel:e.alevel,atype:e.atype,pdesc:e.pdesc,forsys:e.forsys.length>0?(a=e.forsys)==null?void 0:a.join(","):"",status:e.status,ptype:e.ptype,weekstart:e.weekstart,weekend:e.weekend}]);w||((_=window.$message)==null||_.success(s("common.addSuccess")),x(),N("submitted"))}else{const{data:y,error:w}=await at([{id:p.rowData.id,pname:e.pname,aetype:e.aetype,psort:e.psort,pcontent:i.length>0?i.join(","):"",efftime:e.efftime,starttime:e.starttime,endtime:e.endtime,aename:e.aename,alevel:e.alevel,atype:e.atype,pdesc:e.pdesc,forsys:e.forsys.length>0?(d=e.forsys)==null?void 0:d.join(","):"",status:e.status,ptype:e.ptype,weekstart:e.weekstart,weekend:e.weekend}]);w||((g=window.$message)==null||g.success(s("common.updateSuccess")),x(),N("submitted"))}}Ae(h,()=>{h.value&&(b(),B())});const ke=i=>{var g;function a(y){const[w,Y,z]=y.split(":").map(Number);return w*3600+Y*60+z}const _=a(e.starttime),d=a(i);if(_>d)return e.endtime=null,(g=window.$message)==null?void 0:g.warning("开始时间不能大于结束时间，请您重新选择")},De=i=>{var a;e.efftime=i,f.value=null,(a=c.value)==null||a.restoreValidation()},Ne=i=>(e.weekstart&&e.weekstart>i.value&&(i.disabled=!0),i.label);return(i,a)=>{const _=fe,d=Be,g=Ee,y=_e,w=Ge,Y=dt,z=ye,ne=pt,xe=mt,Se=Ie,Te=ge,oe=Z,Ue=qe,Ce=He,se=W("no-space");return T(),M(Ce,{show:h.value,"onUpdate:show":a[17]||(a[17]=o=>h.value=o),"display-directive":"show",width:560},{default:l(()=>[t(Ue,{title:A.value,"native-scrollbar":!1,closable:""},{footer:l(()=>[t(y,{size:16},{default:l(()=>[t(oe,{onClick:x},{default:l(()=>[k($(n(s)("common.cancel")),1)]),_:1}),t(oe,{type:"primary",onClick:we},{default:l(()=>[k($(n(s)("common.confirm")),1)]),_:1})]),_:1})]),default:l(()=>[t(Te,{ref_key:"formRef",ref:c,model:e,rules:C},{default:l(()=>[t(d,{label:n(s)("page.audit.strategy.name"),path:"pname"},{default:l(()=>[I(t(_,{clearable:"",value:e.pname,"onUpdate:value":a[0]||(a[0]=o=>e.pname=o),placeholder:n(s)("page.audit.strategy.form.name")},null,8,["value","placeholder"]),[[se]])]),_:1},8,["label"]),t(d,{label:n(s)("page.audit.strategy.eventType"),path:"aetype"},{default:l(()=>[t(w,{value:e.aetype,"onUpdate:value":a[1]||(a[1]=o=>e.aetype=o)},{default:l(()=>[t(y,null,{default:l(()=>[t(g,{value:0},{default:l(()=>[k(" 安全事件")]),_:1})]),_:1})]),_:1},8,["value"])]),_:1},8,["label"]),t(d,{label:"事件",path:"pcontent"},{default:l(()=>[t(Y,{value:e.pcontent,"onUpdate:value":[a[2]||(a[2]=o=>e.pcontent=o),be],multiple:"",cascade:"",clearable:"",placeholder:"请选择事件","max-tag-count":1,options:S.value,"show-path":!1,filterable:"","value-field":"id","label-field":"pname","check-strategy":"child"},null,8,["value","options"])]),_:1}),t(d,{label:n(s)("page.audit.strategy.efftime"),path:"efftime","show-feedback":!1},{default:l(()=>[le("div",bt,[t(w,{value:e.efftime,"onUpdate:value":[a[3]||(a[3]=o=>e.efftime=o),De]},{default:l(()=>[t(y,null,{default:l(()=>[(T(!0),ce(je,null,Oe(n(te)(n(Ve)),(o,Le)=>(T(),M(g,{value:o.value,key:Le},{default:l(()=>[k($(o.label),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["value"]),e.efftime===1?(T(),M(y,{key:0,align:"center",justify:"space-between",class:"mt--15px"},{default:l(()=>[t(d,{path:"weekstart"},{default:l(()=>[t(z,{filterable:"",value:e.weekstart,"onUpdate:value":a[4]||(a[4]=o=>e.weekstart=o),placeholder:"请选择星期",options:V(),style:{width:"230px"}},null,8,["value","options"])]),_:1}),wt,t(d,{path:"weekend"},{default:l(()=>[t(z,{filterable:"",value:e.weekend,"onUpdate:value":a[5]||(a[5]=o=>e.weekend=o),placeholder:"请选择星期",options:V(),"render-label":Ne,style:{width:"230px"}},null,8,["value","options"])]),_:1})]),_:1})):X("",!0),e.efftime===0||e.efftime===1?(T(),M(y,{key:1,align:"center",justify:"space-between",class:"mt--15px"},{default:l(()=>[t(d,{path:"starttime"},{default:l(()=>[t(ne,{"formatted-value":e.starttime,"onUpdate:formattedValue":a[6]||(a[6]=o=>e.starttime=o),type:"time",format:"HH:mm:ss",clearable:"",style:{width:"230px"}},null,8,["formatted-value"])]),_:1}),kt,t(d,{path:"endtime"},{default:l(()=>[t(ne,{"formatted-value":e.endtime,"onUpdate:formattedValue":[a[7]||(a[7]=o=>e.endtime=o),ke],type:"time",format:"HH:mm:ss",clearable:"",style:{width:"230px"}},null,8,["formatted-value"])]),_:1})]),_:1})):X("",!0),e.efftime===2?(T(),M(y,{key:2,align:"center",class:"mt--15px w-100%","item-style":{width:"100%"}},{default:l(()=>[t(d,{path:"time"},{default:l(()=>[t(xe,{"formatted-value":f.value,"onUpdate:formattedValue":[a[8]||(a[8]=o=>f.value=o),he],type:"datetimerange","date-format":"yyyy-MM-dd hh:mm:ss",style:{width:"100%"}},null,8,["formatted-value"])]),_:1})]),_:1})):X("",!0)])]),_:1},8,["label"]),t(d,{label:n(s)("page.audit.strategy.eventname"),path:"aename"},{default:l(()=>[I(t(_,{value:e.aename,"onUpdate:value":a[9]||(a[9]=o=>e.aename=o),placeholder:n(s)("page.audit.strategy.form.eventname")},null,8,["value","placeholder"]),[[se]])]),_:1},8,["label"]),t(d,{label:n(s)("page.audit.strategy.eventLevel"),path:"alevel"},{default:l(()=>[t(z,{filterable:"",value:e.alevel,"onUpdate:value":a[10]||(a[10]=o=>e.alevel=o),placeholder:"请选择审计事件级别",options:n(te)(n(Me)),style:{width:"100%"}},null,8,["value","options"])]),_:1},8,["label"]),t(d,{label:n(s)("page.audit.strategy.type"),path:"atype"},{default:l(()=>[t(z,{value:e.atype,"onUpdate:value":a[11]||(a[11]=o=>e.atype=o),placeholder:"请选择审计类型",clearable:"",filterable:"","value-field":"id","label-field":"atypename",options:n(L).data,"reset-menu-on-options-change":!1,onScroll:r},null,8,["value","options"])]),_:1},8,["label"]),t(d,{label:"转发策略",path:"forsys"},{default:l(()=>[t(z,{value:e.forsys,"onUpdate:value":a[12]||(a[12]=o=>e.forsys=o),multiple:"",placeholder:"请选择转发策略",clearable:"",filterable:"","label-field":"ipaddr","value-field":"id",options:n(u).data,"reset-menu-on-options-change":!1,onScroll:J},null,8,["value","options"])]),_:1}),t(d,{label:n(s)("page.audit.strategy.describe"),path:"pdesc"},{default:l(()=>[t(_,{value:e.pdesc,"onUpdate:value":a[13]||(a[13]=o=>e.pdesc=o),placeholder:n(s)("page.audit.strategy.form.describe"),type:"textarea"},null,8,["value","placeholder"])]),_:1},8,["label"]),t(d,{label:n(s)("page.audit.strategy.status"),path:"status"},{default:l(()=>[t(w,{value:e.status,"onUpdate:value":a[14]||(a[14]=o=>e.status=o)},{default:l(()=>[t(y,null,{default:l(()=>[t(g,{value:0},{default:l(()=>[k("开启")]),_:1}),t(g,{value:1},{default:l(()=>[k("禁用")]),_:1})]),_:1})]),_:1},8,["value"])]),_:1},8,["label"]),t(d,{label:n(s)("page.audit.strategy.form.built"),path:"ptype"},{default:l(()=>[t(w,{value:e.ptype,"onUpdate:value":a[15]||(a[15]=o=>e.ptype=o)},{default:l(()=>[t(y,null,{default:l(()=>[t(g,{value:0},{default:l(()=>[k($(n(s)("common.yesOrNo.yes")),1)]),_:1}),t(g,{value:1},{default:l(()=>[k($(n(s)("common.yesOrNo.no")),1)]),_:1})]),_:1})]),_:1},8,["value"])]),_:1},8,["label"]),t(d,{label:n(s)("page.audit.type.sort"),path:"psort"},{default:l(()=>[t(Se,{min:0,value:e.psort,"onUpdate:value":a[16]||(a[16]=o=>e.psort=o),placeholder:n(s)("page.audit.strategy.form.sort"),style:{width:"100%"}},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),Nt=ae({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:ee(["reset","search"],["update:model"]),setup(D,{emit:F}){const p=F,{formRef:N,restoreValidation:h}=me(),c=de(D,"model");function P(){c.value.fuzzy="",p("search")}async function B(){await h(),p("reset")}async function v(){p("search")}const U=_t.debounce(v,1e3,{leading:!0,trailing:!1});return(A,e)=>{const O=fe,C=yt,V=ye,b=ft,x=Z,S=ct,q=_e,E=gt,L=ge,G=ve,j=W("no-space");return T(),M(G,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[t(L,{ref_key:"formRef",ref:N,model:c.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:We(n(U),["enter"])},{default:l(()=>[t(E,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:l(()=>[t(C,{span:"24 s:12 m:8 l:6",label:n(s)("page.audit.strategy.name"),path:"fuzzy"},{default:l(()=>[I(t(O,{clearable:"",value:c.value.fuzzy,"onUpdate:value":e[0]||(e[0]=r=>c.value.fuzzy=r),placeholder:n(s)("page.audit.strategy.form.name"),onClear:P},null,8,["value","placeholder"]),[[j]])]),_:1},8,["label"]),t(C,{span:"24 s:12 m:8 l:6",label:"使用状态",path:"status"},{default:l(()=>[t(V,{filterable:"",clearable:"",value:c.value.status,"onUpdate:value":[e[1]||(e[1]=r=>c.value.status=r),v],placeholder:"请选择使用状态",options:n(te)(n(Ke))},null,8,["value","options"])]),_:1}),t(C,{span:"24 s:12 m:8 l:6"},{default:l(()=>[t(q,{class:"w-full"},{default:l(()=>[t(x,{onClick:B},{icon:l(()=>[t(b,{class:"text-icon"})]),default:l(()=>[k(" "+$(n(s)("common.reset")),1)]),_:1}),t(x,{type:"primary",ghost:"",onClick:n(U)},{icon:l(()=>[t(S,{class:"text-icon"})]),default:l(()=>[k(" "+$(n(s)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),xt={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function K(D){return typeof D=="function"||Object.prototype.toString.call(D)==="[object Object]"&&!Qe(D)}const Xt=ae({name:"audit_strategy",__name:"index",setup(D){const F=Ze(),{columns:p,columnChecks:N,data:h,getData:c,loading:P,mobilePagination:B,searchParams:v,resetSearchParams:U}=ot({apiFn:lt,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,fuzzy:null,status:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48,fixed:"left"},{key:"pname",title:s("page.audit.strategy.name"),align:"center",minWidth:160,ellipsis:{tooltip:!0}},{key:"alevel",title:s("page.audit.strategy.eventLevel"),align:"center",minWidth:180,render:r=>{(r.alevel===void 0||r.alevel===null)&&(r.alevel=0);const u={0:"#8e9dff",1:"#5da8ff",2:"#fedc69",3:"#ff9874",4:"#ff0000"},m=s(vt[r.alevel]);let R={color:u[r.alevel],textColor:"#ffffff",borderColor:u[r.alevel]};return t(ie,{size:"small",color:R},K(m)?m:{default:()=>[m]})}},{key:"pdesc",title:s("page.audit.strategy.describe"),align:"center",minWidth:160,ellipsis:{tooltip:!0}},{key:"ptype",title:s("page.audit.strategy.built"),align:"center",width:120,render:r=>{const u={0:"primary",1:"error"},m=s(Je[r.ptype]);return t(ie,{type:u[r.ptype]},K(m)?m:{default:()=>[m]})}},{key:"status",title:s("page.audit.strategy.status"),align:"center",width:120,render:r=>t(Ye,{disabled:!0,value:r.status,checkedValue:0,uncheckedValue:1},null)},{key:"operate",title:s("common.operate"),align:"center",width:130,render:r=>{let u;return r.ptype!=0?t("div",{class:"flex-center gap-8px"},[I(t(Z,{type:"primary",ghost:!0,size:"small",onClick:()=>G(r.id)},K(u=s("common.edit"))?u:{default:()=>[u]}),[[W("no-auth"),"sys.audit.policy.update"]]),t(ht,{onPositiveClick:()=>L(r.id)},{default:()=>s("common.confirmDelete"),trigger:()=>{let m;return I(t(Z,{type:"error",ghost:!0,size:"small"},K(m=s("common.delete"))?m:{default:()=>[m]}),[[W("no-auth"),"sys.audit.policy.delete"]])}})]):null}}]}),{drawerVisible:A,operateType:e,editingData:O,handleAdd:C,handleEdit:V,checkedRowKeys:b,onBatchDeleted:x,onDeleted:S,closeDrawer:q}=st(h,c);async function E(){console.log(b.value),j(b.value,r=>{x()})}function L(r){console.log(r),j([r],u=>{S()})}function G(r){V(r)}async function j(r,u){const{data:m,error:R}=await nt(r);if(!R)u&&u(m);else return!1}return(r,u)=>{const m=Re,R=Xe,J=ve;return T(),ce("div",xt,[t(Nt,{model:n(v),"onUpdate:model":u[0]||(u[0]=f=>H(v)?v.value=f:null),onReset:n(U),onSearch:n(c)},null,8,["model","onReset","onSearch"]),t(J,{title:n(s)("page.audit.strategy.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":l(()=>[t(m,{columns:n(N),"onUpdate:columns":u[1]||(u[1]=f=>H(N)?N.value=f:null),"disabled-delete":n(b).length===0,loading:n(P),onAdd:n(C),onDelete:E,onRefresh:n(c),"is-view-add-button":n(pe)("sys.audit.policy.insert"),"is-view-delete-button":n(pe)("sys.audit.policy.delete")},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","is-view-delete-button"])]),default:l(()=>[t(R,{"checked-row-keys":n(b),"onUpdate:checkedRowKeys":u[2]||(u[2]=f=>H(b)?b.value=f:null),columns:n(p),data:n(h),size:"small","flex-height":!n(F).isMobile,"scroll-x":962,loading:n(P),remote:"","row-key":f=>f.id,pagination:n(B),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),t(Dt,{visible:n(A),"onUpdate:visible":u[3]||(u[3]=f=>H(A)?A.value=f:null),"operate-type":n(e),"row-data":n(O),onSubmitted:n(c)},null,8,["visible","operate-type","row-data","onSubmitted"])]),_:1},8,["title"])])}}});export{Xt as default};
