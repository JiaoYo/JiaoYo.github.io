import{_ as te}from"./table-column-setting.vue_vue_type_script_setup_true_lang-BkM6p6rf.js";import{_ as ae}from"./round-search-DDZcq3P-.js";import{d as ne,bp as se,g as l,aK as T,aN as le,aV as P,v as oe,ae as ce,j as y,ap as ie,x as A,F as B,aX as $,aY as L,E as j,az as F,a6 as re,o as ue,e as de,w as p,h as U,i as s,ai as pe,A as _e,B as me,aa as he,f as J,J as fe,z as ge,bq as ye,t as ve,al as V,af as ke,H as be,an as we,K as xe,ag as Se,a1 as Te,O as $e}from"./index-Ds_IqQ0j.js";import{u as De,a as Ne}from"./table-BlKtJUuU.js";import{a as ze,p as qe}from"./gather-Ix4yTn97.js";import{_ as Ce}from"./InputGroupLabel-BbIjzWVI.js";import{_ as Ie}from"./Tree-BnRepe-1.js";import{_ as Ee}from"./DataTable-CE2c7PdC.js";import{_ as Pe}from"./Split-BxJx2vl_.js";import"./RadioGroup-vBakrLi8.js";import"./Forward-BqE5Ptny.js";const Ue={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ke={class:"flex flex-col"},Oe=ne({name:"configsetting_realtimedata_devicedata",__name:"index",setup(Re){const{columns:W,columnChecks:D,data:w,getData:v,loading:K,mobilePagination:G,searchParams:h,resetSearchParams:Ae}=De({apiFn:se,apiParams:{page:1,pageSize:200,limit:200,tagType:null,chlid:null,devId:null,fuzzy:"",chlType:0,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",align:"center",width:48},{key:"id",title:"序号",align:"center",width:80},{key:"devId",title:"设备名称",align:"center",width:100,render:e=>{var t;return l("span",null,[(t=O.value.find(n=>n.id==e.devId))==null?void 0:t.devName])}},{key:"tagName",title:"测点名称",align:"center"},{key:"tagDesc",title:"物模型标识(测点描述)",align:"center"},{key:"value",title:"测点值",align:"center",width:140,render:e=>{var t;return T("span",{style:{color:e.quality===100?"red":e.quality==49?"#409eff":e.quality==50?"#909399":"#67c23a"}},parseFloat((t=e.value)==null?void 0:t.toFixed(6))||e.value)}},{key:"quality",title:"质量",align:"center",width:120,render:e=>(e.quality==100||e.quality==49||e.quality==0)&&T(le,{style:{background:e.quality===100?"red":e.quality==49?"#409eff":"#67c23a",color:"#fff"}},e.quality==0?"Good":e.quality==49?"人工置数":e.quality==100?"Bad":"")},{key:"dbtime",title:"采集时间",align:"center",minWidth:120,render:e=>{var t,n;return T("span",{title:P(0,+e.dbtime)},e.dbtime?(n=P(2,+e.dbtime))==null?void 0:n.substring(10,(t=P(2,+e.dbtime))==null?void 0:t.length):"")}},{key:"tagType",title:"测点类型",align:"center",width:140,render:e=>l("span",null,[ze[e.tagType]])},{key:"objAddr",title:"地址",align:"center",width:140}]}),H=e=>{e===""&&v()};oe(async()=>{await M(),C(),Y()}),ce(()=>{var e;(e=N.value)==null||e.close(),S.value.close()});const g=y(),O=y([]),M=async()=>{const{data:e,error:t}=await ie();if((e==null?void 0:e.length)==0)return;function n(m){return m.map(o=>{var a;return{label:o.chlName,key:o.id,dev_status:null,children:(a=o.devicePojoList)!=null&&a.length?o.devicePojoList.map(c=>(O.value.push(c),{label:c.devName,dev_status:null,chlType:o.chlType,key:c.id})):[]}})}g.value=n(e),h.chlid=g.value[0].key,h.devId=g.value[0].children[0].key,I.value=[g.value[0].children[0].key],x.value=g.value[0].children[0].label,v()},N=y(null),Y=()=>{var c;(c=N.value)==null||c.close();const e=new Date().getTime(),t=A(),n=B(`${t}${e}getchlstatus`),m=$(n),o=$("getchlstatus"),a=new L(j.replace("https","wss")+`/ChannelStatusWebsocket/${o}/${m}/${e}/${t}?token=${F()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});N.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(i=>{let _=[];console.log(i,"通道状态websocket接受数据"),R(i.data)&&(_=JSON.parse(i.data).data,g.value.forEach(u=>{_.forEach(d=>{var k;d.chl_id==u.key&&(u.dev_status=d.chl_status),d.chl_id==1&&(u.dev_status=1),(k=u.children)==null||k.forEach(f=>{var b;(b=d.devs)==null||b.forEach(r=>{r.dev_id==f.key&&(f.dev_status=r.dev_status),r.dev_id==1&&(f.dev_status=1)})})})}))})},S=y(null),z=y(""),q=y(!0),C=()=>{var c;(c=S.value)==null||c.close(),q.value=!0;const e=new Date().getTime(),t=A(),n=B(`${t}${e}${x.value}`),m=$(n),o=$(x.value);console.log(o,"params");const a=new L(j.replace("https","wss")+`/realTimeDataWebsocket/${o}/${m}/${e}/${t}?token=${F()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});S.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(i=>{let _=[];console.log(i,"实时数据websocket接受数据"),R(i.data)&&(_=JSON.parse(i.data).data[x.value],_==null||_.forEach(u=>{w.value.forEach(d=>{u.i==d.id&&(d.quality=u.q,d.value=u.v,d.dbtime=u.t)})}),z.value=ee())})},I=y([]),x=y(""),X=async(e,t,n)=>{var a,c,i,_,u;I.value=[(a=n.node)==null?void 0:a.key],h.chlType=(c=n.node)==null?void 0:c.chlType;function m(d,k){for(const f of d)if(f.children){for(const b of f.children)if(b.key===k)return f.key}return null}const o=await m(g.value,(i=n.node)==null?void 0:i.key);h.chlid=o,h.devId=(_=n.node)==null?void 0:_.key,x.value=(u=n.node)==null?void 0:u.label,v(),C()},Q=e=>{e&&w.value.length>0?C():S.value.close()};re(()=>h.tagType,e=>{e||v()});const Z=({option:e})=>e.key==0?"":e.dev_status!==null?T("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:e.hasOwnProperty("dev_status")&&e.dev_status==1?"#00b42a":e.dev_status==2?"#ff0000":"#ccc"}}):"",ee=e=>{const t=new Date,n=t.getFullYear(),m=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),c=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0");return`${n}-${m}-${o} ${a}:${c}:${i}`},{drawerVisible:Be,operateType:Le,editingData:je,handleAdd:Fe,handleEdit:Je,checkedRowKeys:E,onBatchDeleted:Ve,onDeleted:We}=Ne(w,v),R=e=>{try{return JSON.parse(e),!0}catch{return!1}};return(e,t)=>{const n=Ce,m=ke,o=be,a=ae,c=we,i=xe,_=te,u=Ie,d=Se,k=Ee,f=Pe,b=Te;return ue(),de("div",Ue,[l(b,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:p(()=>[l(i,{align:"center",wrap:"",justify:"start",class:"lt-sm:w-200px"},{default:p(()=>[l(c,null,{default:p(()=>[l(n,null,{default:p(()=>[U("测点类型")]),_:1}),l(m,{filterable:"",clearable:"",placeholder:"请选择",value:s(h).tagType,"onUpdate:value":t[0]||(t[0]=r=>s(h).tagType=r),options:s(pe)(s(qe))},null,8,["value","options"]),l(o,{clearable:"",value:s(h).fuzzy,"onUpdate:value":[t[1]||(t[1]=r=>s(h).fuzzy=r),H],placeholder:"请输入测点名称或描述",style:{width:"150%"},onKeyup:_e(s(v),["enter"])},null,8,["value","onKeyup"]),l(s(me),{type:"primary",ghost:"",onClick:s(v)},{icon:p(()=>[l(a,{class:he(["text-icon",{"animate-spin":s(K)}])},null,8,["class"])]),default:p(()=>[U(" 搜索 ")]),_:1},8,["onClick"])]),_:1}),J("div",Ke,[l(s(fe),{checked:q.value,"onUpdate:checked":[t[2]||(t[2]=r=>q.value=r),Q]},{default:p(()=>[U(" 实时刷新 ")]),_:1},8,["checked"]),ge(J("span",{class:"font-size-14px color-blank",style:{"font-weight":"600"}}," 刷新时间："+ve(z.value),513),[[ye,z.value]])])]),_:1})]),"header-extra":p(()=>[l(i,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:p(()=>[l(_,{columns:s(D),"onUpdate:columns":t[3]||(t[3]=r=>V(D)?D.value=r:null)},null,8,["columns"])]),_:1})]),default:p(()=>[l(f,{direction:"horizontal",class:"sm:h-full","default-size":.15,max:.35,min:.1,"resize-trigger-size":6},{1:p(()=>[l(d,{style:{"max-height":"700px"}},{default:p(()=>[l(u,{"block-line":"","default-expand-all":"",data:g.value,"checked-keys":I.value,"expand-on-click":!1,"render-prefix":Z,"check-strategy":"child","onUpdate:checkedKeys":X,checkable:""},null,8,["data","checked-keys"])]),_:1})]),2:p(()=>[l(k,{"checked-row-keys":s(E),"onUpdate:checkedRowKeys":t[4]||(t[4]=r=>V(E)?E.value=r:null),columns:s(W),data:s(w),size:"small",loading:s(K),remote:"","row-key":r=>r.id,"flex-height":!0,"scroll-x":"",pagination:s(w).length?s(G):void 0,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1})])}}}),st=$e(Oe,[["__scopeId","data-v-7ee7b2ea"]]);export{st as default};
