import{_ as Ia}from"./table-column-setting.vue_vue_type_script_setup_true_lang-DtGc5Ytf.js";import{_ as Ht}from"./round-delete-tdauvCgt.js";import{_ as $a}from"./round-add-CmnuyzV1.js";import{d as it,aG as tt,z as Wt,C as Ue,s as h,A as Xt,$ as F,n as r,G as W,b3 as at,B as v,cD as Aa,ct as La,cB as ja,cC as Nt,b9 as Ut,aF as Te,aa as Tt,f as a,g,cW as Na,cv as Ua,cV as Ta,cS as Ea,a as Oa,aI as _t,aE as st,bZ as Zt,b as et,o as I,a2 as Et,bj as Ba,w as n,bh as Ra,L as Qt,K as Yt,c as B,F as ge,h as i,bi as Je,e as U,R as Ma,cM as Ot,a3 as Va,I as ce,aJ as lt,t as M,a9 as ea,cU as ta,cI as aa,dW as Ja,aK as Bt,aL as nt,dL as sa,d$ as Rt,e0 as qa,e1 as Mt,e2 as Ga,cs as Ka,e3 as Ha,e4 as Wa,cT as Xa,dN as Vt,dI as Jt,aP as vt,dX as Za,cZ as Qa,c$ as Ya,dM as es,cE as ts,cL as as,dO as ss,dJ as ls,dK as ns,aR as is,dH as os,dP as rs,e5 as us,be as ds,a7 as bt,aO as Ve,V as la,aT as cs,X as ps,W as fs,i as ms,b4 as gs,E as Qe,aU as Ye,cR as vs,H as Me,aV as hs,aM as ys,e6 as _s,aX as bs,cu as ks,aZ as xs}from"./index-CYktWG4g.js";import{u as yt,a as Cs}from"./table-5HkGqXjJ.js";import{_ as Ss}from"./round-plus-DbKPFX6F.js";import{_ as ws,a as Ds,A as zs}from"./index-zWHFpEWu.js";import{g as kt,h as Fs,i as na,p as qt,f as Ps}from"./business-Dita21DL.js";import{u as Gt}from"./usePageData-B3dmJo7x.js";import{h as ht}from"./permission-B_M-ULh7.js";import{N as Ce}from"./Popconfirm-CztqIDpP.js";import{N as Is}from"./Cascader-CiR9C1FW.js";import{_ as ia}from"./Grid-yccwcNrM.js";import{_ as oa}from"./FormItemGridItem-CEINFz71.js";import{_ as $s}from"./round-search-DE64LlxI.js";import{_ as As}from"./round-refresh-BIWjpXWE.js";import{_ as Ls}from"./DatePicker-DtsJbsvC.js";import{_ as js}from"./RadioButton-Dh1hBWEB.js";const Ns={class:"w-100%"},Us={class:"flex"},Ts={style:{display:"flex","flex-direction":"column",width:"100%"}},Es={class:"flex items-center"},Os={class:"w-100%"},Bs={class:"w-100px"},Rs={style:{display:"flex","flex-direction":"column"}},Ms={style:{display:"flex","flex-direction":"column"}},Vs={style:{display:"flex","flex-direction":"column"}},Js=it({name:"OperateDrawer",__name:"operate-drawer",props:tt({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:tt(["submitted"],["update:visible"]),setup(X,{emit:oe}){const y=Wt(),ae=oe,V=Ue({contactList:[],debuggedDevieceList:[]}),f=X,u=Ue(pe());function pe(){return{proname:"",dispatchIds:[],contractIds:[],proaddr:"",cpdbtime:null,prosite:"",longitude:120.373885,latitude:30.303899,period:void 0,dtype:void 0,dispatch:"",status:1}}const A=h(0),re=h(void 0);async function ve(){D.value=[{longitude:120.373885,latitude:30.303899,addr:""}],Object.assign(u,pe()),Sa(),f.operateType==="edit"&&f.rowData&&(await Promise.all([Da(),Ee(),de(),C(),$e(),Xe()]),Object.assign(u,f.rowData),A.value=u.period,re.value=u.status,await It(),At(u.proaddr||u.prosite),_a())}const{formRef:T,validate:J,restoreValidation:k}=Xt(),P={proname:{type:"string",required:!0,trigger:["blur","change"],message:"请输入项目名称"},status:{type:"number",required:!0,trigger:["blur","change"],message:"请选择项目状态"},contractIds:{type:"array",required:!0,trigger:["blur","change"],message:"请选择合同"},dtype:{type:"number",required:!0,trigger:["blur","change"],message:"请选择调试类型"},period:{type:"number",required:!0,trigger:["blur","change"],message:"请输入周期"},prosite:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请选择项目地点"},cpdbtime:{type:"string",required:!0,trigger:["blur","change"],message:"请选择时间"}},_=h([]),L=Ue({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",pageSizes:[20],prefix:()=>`共 ${_.value.length} 条`,onChange:e=>{L.page=e,C()},onUpdatePageSize:e=>{L.pageSize=e,L.page=1,C()}}),E=[{title:"对接方",key:"docker",align:"center",width:150,render(e,t){return e.setStatus?r(W,{value:e.docker,placeholder:"请输入",onUpdateValue(l){_.value[t].docker=l}}):r("div",{},e.docker)}},{title:"姓名",key:"pname",align:"center",width:100,render(e,t){return e.setStatus?r(W,{value:e.pname,placeholder:"请输入姓名",onUpdateValue(l){_.value[t].pname=l}}):r("div",{},e.pname)}},{title:"联系方式",key:"pcontact",align:"center",width:150,render(e,t){return e.setStatus?r(W,{value:e.pcontact,placeholder:"请输入联系方式",onUpdateValue(l){_.value[t].pcontact=l}}):r("div",{},e.pcontact)}},{title:"备注",key:"proposition",align:"center",width:150,render(e,t){return e.setStatus?r(W,{value:e.proposition,placeholder:"请输入备注",onUpdateValue(l){_.value[t].proposition=l}}):r("div",{},e.proposition)}},{title:"操作人",width:100,key:"username",align:"center"},{title:"操作时间",key:"dbtime",width:180,align:"center",render:e=>e.dbtime?at(1,e.dbtime):""},{key:"operate",title:F("common.operate"),align:"center",width:160,fixed:"right",render(e,t){return r("div",{class:"flex-center gap-8px"},[e.setStatus?[r(v,{type:"primary",ghost:!0,size:"small",onClick:()=>Se(e)},{default:()=>"保存"}),r(v,{type:"default",ghost:!0,size:"small",onClick:()=>se(e,t)},{default:()=>"取消"}),r(Ce,{onPositiveClick:()=>{f.operateType==="edit"&&e.id?Aa(e.id).then(()=>{var l;_.value.splice(t,1),(l=window.$message)==null||l.success("删除成功")}):_.value.splice(t,1)}},{default:()=>F("common.confirmDelete"),trigger:()=>r(v,{type:"error",ghost:!0,size:"small"},{default:()=>F("common.delete")})})]:r(v,{type:"primary",ghost:!0,size:"small",onClick:()=>q(e)},{default:()=>"编辑"})])}}],C=async()=>{var t;const{data:e}=await La({page:L.page,limit:L.pageSize,pid:(t=f.rowData)==null?void 0:t.id});_.value=e==null?void 0:e.list,_.value.forEach(l=>{l.setStatus=!1}),V.contactList=JSON.parse(JSON.stringify(_.value))},q=e=>{_.value.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus},se=(e,t)=>{e.setStatus=!e.setStatus,e.id?_.value=JSON.parse(JSON.stringify(V.contactList)):_.value.splice(t,1)},Se=async e=>{var t,l,o,d,p;if(!e.pname){(t=window.$message)==null||t.warning("请输入联系人姓名");return}if(!e.pcontact){(l=window.$message)==null||l.warning("请输入联系方式");return}if(f.operateType==="edit")if(e.id){const{data:z,error:x}=await ja([e]);x||((o=window.$message)==null||o.success("修改成功"),C(),e.setStatus=!e.setStatus)}else{const{data:z,error:x}=await Nt([{...e,pid:(d=f.rowData)==null?void 0:d.id}]);x||((p=window.$message)==null||p.success("添加成功"),C(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function we(){var e;((e=_.value[0])!=null&&e.pname||_.value.length==0)&&_.value.unshift({pname:"",pcontact:"",proposition:"",setStatus:!0})}const O=e=>{var t;u.contractIds=e,R.value=We.data.filter(l=>e.includes(l.id)).map(l=>({value:l.id,label:l.contractname,isLeaf:!1})),De((t=R.value[0])==null?void 0:t.id)},R=h([]),Ee=async()=>{var l;const{data:e,error:t}=await ta({page:1,limit:100,id:f.rowData.id});R.value=e==null?void 0:e.list.map(o=>({value:o.id,label:o.contractname,isLeaf:!1})),De((l=e==null?void 0:e.list[0])==null?void 0:l.id)},j=h([]),he=h(),{pageData:le,getData:ot}=Gt(aa),De=async e=>{await ot({pids:e}),he.value=[],j.value=Array.from(new Set([...j.value,...le.data])),he.value=le.data.map(t=>({label:t.devname,value:t.id}))},rt=async e=>{var t;await De(e.value),e.children=(t=he.value)==null?void 0:t.map(l=>({label:l.label,value:l.value,isLeaf:!0}))},S=h([]),Z=Ue({page:1,pageSize:20,itemCount:0,showSizePicker:!0,fuzzy:"",pageSizes:[10,20],prefix:()=>`共 ${Z.itemCount} 条`,onChange:e=>{Z.page=e,de()},onUpdatePageSize:e=>{Z.pageSize=e,Z.page=1,de()}}),G=h(),Oe=[{title:"绑定合同设备",key:"cid",width:300,align:"center",render(e,t){var l,o;return e.setStatus?r(Is,{style:"width: 270px",value:e.cid,filterable:!0,placeholder:"请选择合同设备",options:R.value,checkStrategy:"child",showPath:!1,remote:!0,renderSuffix:d=>d.option.hidden?null:d.node,renderLabel:d=>d.hidden?null:d.label,onLoad:rt,onUpdateValue(d){var z;S.value[t].cid=Number(d)||0;const p=(z=j.value)==null?void 0:z.find(x=>x.id==d);e.devname=(p==null?void 0:p.devname)||"",e.devnum=(p==null?void 0:p.devcount)||"",e.notes=(p==null?void 0:p.notes)||"",G.value=(p==null?void 0:p.devcount)||0,e.etype=(p==null?void 0:p.devtype)||0,e.devmanu=(p==null?void 0:p.devmanu)||"",e.devmodel=(p==null?void 0:p.devmodel)||"",e.devunit=(p==null?void 0:p.devunit)||""}}):r("div",{},e.devname2||((o=(l=he.value)==null?void 0:l.find(d=>d.value==e.cid))==null?void 0:o.label))}},{title:"设备名称",key:"devname",width:200,align:"center",render(e,t){return e.setStatus?r(W,{value:e.devname,placeholder:"请输入",onUpdateValue(l){S.value[t].devname=l}}):r("div",{},e.devname)}},{title:"型号",key:"devmodel",width:220,align:"center",render(e,t){return r("div",{},e.devmodel)}},{title:"设备单位",key:"devunit",width:120,align:"center",render(e,t){return r("div",{},e.devunit)}},{title:"数量",key:"devnum",width:100,align:"center",render(e,t){return e.setStatus?r(Ut,{value:e.devnum,placeholder:"请输入",max:G.value,onUpdateValue(l){S.value[t].devnum=l}}):r("div",{},e.devnum)}},{title:"是否为我司设备",key:"etype",width:260,align:"center",render(e,t){return r("div",{},e.etype==0?"是":"否")}},{title:"设备厂家",key:"devmanu",width:200,align:"center",render(e,t){return r("div",{},e.devmanu)}},{title:"清点状态",key:"status",width:120,align:"center",render(e,t){return e.setStatus&&e.id?r(Te,{value:e.status,filterable:!0,placeholder:"请选择状态",options:[{label:"未清点",value:0},{label:"正常",value:1},{label:"增补",value:2},{label:"退货",value:3},{label:"换货",value:4}],onUpdateValue(l){S.value[t].status=Number(l)||0}}):r("div",{},e.status===0?"未清点":e.status===1?"正常":e.status===2?"增补":e.status===3?"退货":"换货")}},{title:"备注",key:"notes",width:200,align:"center",render(e,t){return r("div",{},e.notes)}},{title:"文件",key:"re1",width:160,align:"center",render(e,t){return e.setStatus?r(v,{type:"primary",ghost:!0,size:"small",onClick:()=>fe(e,"debuggedDevieceList",t)},{default:()=>"上传文件"}):r(Tt,{trigger:"hover"},{trigger:()=>r("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const l=[{alias:e.re1,file:e.fl1},{alias:e.re2,file:e.fl2},{alias:e.re3,file:e.fl3},{alias:e.re4,file:e.fl4}].filter(o=>o.alias||o.file);return l.length===0?r("div",{style:"padding: 10px; color: #999;"},"暂无文件"):r("div",{style:"padding: 10px;"},[r("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[r("thead",[r("tr",[r("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),r("th",{style:"text-align:center; padding: 4px 8px;"},"文件"),r("th",{style:"text-align:center; padding: 4px 8px;"},"操作")])]),r("tbody",l.map((o,d)=>{var p;return r("tr",[r("td",{style:"text-align:center; padding: 4px 8px;"},o.alias||"-"),r("td",{style:"text-align:center; padding: 4px 8px;"},((p=o.file)==null?void 0:p.split("?")[1])||"-"),r("td",{style:"text-align:center; padding: 4px 8px;"},r(v,{type:"primary",ghost:!0,size:"small",onClick:()=>xt({url:o.file})},{default:()=>"下载"}))])}))])])}})}},{title:"操作信息",key:"dbtime",width:180,align:"center",render(e,t){return r(Tt,{trigger:"hover"},{trigger:()=>r("div",{style:"color: #1890ff;cursor: pointer;"},e.dbtime?at(1,e.dbtime):""),default:()=>r("div",{style:"padding: 10px;"},a("div",null,[a("div",null,[g("操作人："),e.username]),a("div",null,[g("操作时间："),e.dbtime]),a("div",null,[g("清点人："),e.dusername]),a("div",null,[g("清点时间："),e.ddbtime])]))})}},{key:"operate",title:F("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return r("div",{class:"flex-center gap-8px"},[e.setStatus?[r(v,{type:"primary",ghost:!0,size:"small",onClick:()=>ct(e)},{default:()=>"保存"}),r(v,{type:"default",ghost:!0,size:"small",onClick:()=>dt(e,t)},{default:()=>"取消"}),ht("project:Equipment:delete")&&r(Ce,{onPositiveClick:async()=>{var l;if(e.id){const{data:o,error:d}=await Na(e.id);o&&(S.value.splice(t,1),(l=window.$message)==null||l.success("删除成功"))}else S.value.splice(t,1)}},{default:()=>F("common.confirmDelete"),trigger:()=>r(v,{type:"error",ghost:!0,size:"small"},{default:()=>F("common.delete")})})]:ht("project:Equipment:update")&&r(v,{type:"primary",ghost:!0,size:"small",onClick:()=>ut(e)},{default:()=>"编辑"})])}}],N=h([]),s=h(!1),c=h(""),Q=h(),fe=(e,t,l)=>{N.value=[],s.value=!0,c.value=t,Q.value=l,e.re1&&N.value.push({id:"",name:e.re1,url:e.fl1,status:"uploading",setStatus:!1,progress:0}),e.re2&&N.value.push({id:"",name:e.re2,url:e.fl2,status:"uploading",setStatus:!1,progress:0}),e.re3&&N.value.push({id:"",name:e.re3,url:e.fl3,status:"uploading",setStatus:!1,progress:0}),e.re4&&N.value.push({id:"",name:e.re4,url:e.fl4,status:"uploading",setStatus:!1,progress:0})},ue=async()=>{var t,l;let e=!0;for(let o=0;o<N.value.length;o++){const d=N.value[o];if(!d.url){(t=window.$message)==null||t.warning(`第${o+1}个文件的文件名称不能为空`),e=!1;break}if(!d.name){(l=window.$message)==null||l.warning(`第${o+1}个文件的文件别名不能为空`),e=!1;break}S.value[Q.value][`re${o+1}`]=d.name,S.value[Q.value][`fl${o+1}`]=d.url}e&&(s.value=!1,c.value="",Q.value=void 0)},de=async()=>{var t;const{data:e}=await Ua({page:Z.page,limit:Z.pageSize,fuzzy:Z.fuzzy,pid:(t=f.rowData)==null?void 0:t.id});S.value=e.list,V.debuggedDevieceList=JSON.parse(JSON.stringify(S.value))},ut=async e=>{var o;console.log(le.data,e.cid,"ssssssssssssssss"),S.value.forEach(d=>{d.setStatus=!1});const{data:t,error:l}=await Ta(e.cid);l||(((o=R.value[R.value.length-1])==null?void 0:o.value)!=t.id&&R.value.push({value:t.id,label:t.devname,disabled:!0,isLeaf:!0,hidden:!0}),G.value=t.devcount||0),e.setStatus=!e.setStatus},dt=(e,t)=>{e.setStatus=!e.setStatus,e.id?S.value=JSON.parse(JSON.stringify(V.debuggedDevieceList)):S.value.splice(t,1)},ct=async e=>{var t,l,o,d,p;if(!e.cid){(t=window.$message)==null||t.warning("请选择合同设备");return}if(!e.devname){(l=window.$message)==null||l.warning("设备名称不能为空");return}if(!e.devmodel){(o=window.$message)==null||o.warning("设备型号不能为空");return}if(!e.devnum){(d=window.$message)==null||d.warning("设备数量不能为空");return}if(e.id){const{data:z,error:x}=await Ea([e]);x||((p=window.$message)==null||p.success("修改成功"),de(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function pt(){var e;((e=S.value[0])!=null&&e.devname||S.value.length==0)&&S.value.unshift({status:void 0,devmanu:"",etype:0,devname:"",devmodel:"",devnum:0,notes:"",setStatus:!0})}const ft=()=>{s.value=!1},qe=h({}),b=h([]);async function $e(){var t;b.value=[];const{data:e}=await Ja({page:1,limit:100,pid:(t=f.rowData)==null?void 0:t.id});e.list.forEach(l=>{l.sort==1&&b.value.push({id:l.id,name:l.filename,url:l.file,status:"finished",creator:l.username,dbtime:l.dbtime})}),b.value.reverse(),qe.value=JSON.parse(JSON.stringify(e))}const ra=[{title:"文件别名",key:"name",align:"center",width:200,render(e){return e.setStatus?r(W,{value:e.name,onUpdateValue:t=>{e.name=t}}):r("div",{},e.name)}},{title:"文件名称",key:"filename",align:"center",width:200,render(e){return e.setStatus&&!e.url?r("div",{style:"display: flex; justify-content: center; align-items: center;"},[r(Bt,{action:"#",showFileList:!1,customRequest:async({file:l,onFinish:o,onError:d})=>{var p,z;try{e.status=!0;const{data:x,error:K}=await us(l.file,ne=>{e.progress=ne});x&&(e.url=x,e.status=!1)}catch(x){console.error(x),(z=(p=window.$message)==null?void 0:p.error)==null||z.call(p,"文件上传出错"),e.status=!1}}},{default:()=>r(v,{type:"info",size:"small",ghost:!0,loading:e.status},{default:()=>"上传文件"})}),e.progress?r(nt,{type:"line",percentage:e.progress,indicatorPlacement:"inside",processing:!0}):null]):e.setStatus&&e.url&&!e.id?a("span",null,[e.url.split("?")[1],g(" "),a("span",{onClick:()=>{e.url="",e.progress=0},style:"color: red;cursor: pointer;font-size: 12px;"},[g("删除")])]):r("div",{},e.url.split("?")[1])}},{title:"上传人",key:"creator",align:"center",width:100,render(e){return r("div",{},e.creator)}},{title:"上传时间",key:"dbtime",align:"center",width:200,render(e){return r("div",{},e.dbtime?e.dbtime:"")}},{title:"操作",key:"actions",align:"center",width:180,render(e){return r(ce,{justify:"center"},[!e.setStatus&&e.id&&r(v,{type:"info",size:"small",ghost:!0,onClick:()=>{xt(e)}},{default:()=>"下载"}),e.setStatus&&r(v,{type:"info",size:"small",ghost:!0,onClick:()=>{pa(e)}},{default:()=>"保存"}),e.setStatus&&r(v,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"取消"}),!e.setStatus&&r(v,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"编辑"}),ht("project:File:delete")&&(y.userInfo.usertype==0||y.userInfo.usertype==2)&&r(Ce,{onPositiveClick:async()=>{var t;if(e.id){const{data:l,error:o}=await ls(e.url),{data:d,error:p}=await ns(e.id);p||(t=window.$message)==null||t.success("删除成功")}else b.value=b.value.filter(l=>l!==e)}},{default:()=>F("common.confirmDelete"),trigger:()=>r(v,{type:"error",ghost:!0,size:"small"},{default:()=>F("common.delete")})})])}}],ua=[{title:"文件名称",key:"filename",align:"center",render(e){if(!e.url){const t=async({file:o,onFinish:d,onError:p})=>{var z,x;try{e.status=!0;const K=await is(o.file,o.name,"",ne=>{e.progress=ne});K&&(e.url=K,e.name=o.name,e.status=!1)}catch(K){console.error(K),(x=(z=window.$message)==null?void 0:z.error)==null||x.call(z,"文件上传出错"),e.status=!1}};async function l(o){var d;return o.file.file.size>100*1024*1024?((d=window.$message)==null||d.error("文件大小不能超过100M"),!1):!0}return r("div",{style:"display: flex; justify-content: center; align-items: center;"},[r(Bt,{action:"#",showFileList:!1,customRequest:t,onBeforeUpload:l},{default:()=>r(v,{type:"info",size:"small",ghost:!0,loading:e.status},{default:()=>"上传文件"})}),e.progress?r(nt,{type:"line",percentage:e.progress,indicatorPlacement:"inside",processing:!0}):null])}return e.url&&!e.id?a("span",null,[e.url.split("?")[1],g(" "),a("span",{onClick:()=>{e.url="",e.progress=0,e.status=!1},style:"color: red;cursor: pointer;font-size: 12px;"},[g("删除")])]):r("div",{},e.url.split("?")[1])}},{title:"文件别名",key:"name",align:"center",render(e){return r(W,{value:e.name,onUpdateValue:t=>{e.name=t}})}},{title:"操作",key:"actions",align:"center",width:100,render(e){return r(ce,{justify:"center"},[r(v,{type:"error",size:"small",ghost:!0,onClick:()=>{N.value=N.value.filter(t=>t!==e)}},{default:()=>"删除"})])}}];async function xt(e){if(e!=null&&e.url)try{const l=await(await fetch(e.url.split("?")[0],{mode:"cors"})).blob(),o=URL.createObjectURL(l),d=document.createElement("a");d.href=o,d.download=e.url.split("?")[1],d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(o)}catch(t){console.error("下载失败:",t)}}const da=()=>{var e,t;if(N.value.length>=4)return(t=(e=window.$message)==null?void 0:e.warning)==null?void 0:t.call(e,"最多上传4个文件");N.value.push({id:"",name:"",url:"",status:!1,setStatus:!0,progress:0})},ca=()=>{b.value.push({id:"",name:"",url:"",status:!1,setStatus:!0})},pa=async e=>{var t,l,o,d,p,z,x,K,ne,Pe,Ie,ke;if(!e.name){(l=(t=window.$message)==null?void 0:t.warning)==null||l.call(t,"请输入文件别名");return}if(!e.url){(d=(o=window.$message)==null?void 0:o.warning)==null||d.call(o,"请上传文件");return}if((p=f.rowData)!=null&&p.id){const{data:Y,error:m}=await Jt([{pid:(z=f.rowData)==null?void 0:z.id,filename:e.name,file:e.url,sort:1}]);if(m)return(x=window.$message)==null?void 0:x.error("保存文件记录失败");(K=window.$message)==null||K.destroyAll(),e.setStatus=!e.setStatus,$e(),(ne=window.$message)==null||ne.success("保存成功")}else if(e.id){const{data:Y,error:m}=await os([{id:e.id,filename:e.name}]);if(m)return(Pe=window.$message)==null?void 0:Pe.error("保存文件记录失败");(Ie=window.$message)==null||Ie.destroyAll(),e.setStatus=!e.setStatus,(ke=window.$message)==null||ke.success("编辑成功")}else e.setStatus=!e.setStatus},fa=Oa(()=>({add:"新增项目",edit:"修改项目"})[f.operateType]),Ae=_t(X,"visible");st(Ae,()=>{Ae.value&&(ve(),setTimeout(()=>{const e=document.querySelector(".n-scrollbar-content");e==null||e.scrollTo(0,0)},300),k())});function ma(e){e||ze()}function ze(){Ae.value=!1}async function Ct(){var e;await J(),(e=window.$dialog)==null||e.info({title:"提示",content:"确定提交吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await ga()}})}async function ga(){var e,t,l,o,d,p,z,x,K,ne,Pe,Ie,ke;if(f.operateType==="edit"){const Y=JSON.parse(JSON.stringify(u));A.value==Y.period&&delete Y.period,re.value==Y.status&&delete Y.status;const{data:m,error:ee}=await sa([Y]);if(!ee){let H=function(me,ie){const te=me.filter(xe=>!ie.includes(xe)),je=ie.filter(xe=>!me.includes(xe));return{toDelete:te,toAdd:je}};if((e=u.dispatchIds)!=null&&e.length&&((t=u.dispatchIds)==null?void 0:t.length)>0){const{toDelete:me,toAdd:ie}=H(Ft.value,u.dispatchIds);if(ie.length>0){const te=ie.map(Ze=>({pid:u.id,did:Ze})),{data:je,error:xe}=await Rt(te)}if(me.length>0){const{data:te,error:je}=await qa(me.join(","))}}if((l=u.contractIds)!=null&&l.length&&((o=u.contractIds)==null?void 0:o.length)>0){const{toDelete:me,toAdd:ie}=H(Lt.value,u.contractIds);if(ie.length>0){const te=ie.map(Ze=>({pid:u.id,did:Ze})),{data:je,error:xe}=await Mt(te)}if(me.length>0){const{data:te,error:je}=await Ga(me.join(","))}}ze(),ae("submitted"),(d=window.$message)==null||d.success("修改成功")}}else{const Y=Ka(),{data:m,error:ee}=await Ha([{...u,uuid:Y}]);if(!ee){const{data:H,error:me}=await Wa(Y);if(H){let ie=function($,Ne,jt){return $.map(Re=>({...Re,pid:Ne}))};if(u.dispatchIds&&u.dispatchIds.length>0){const $=[];(p=u.dispatchIds)==null||p.forEach(Re=>{$.push({pid:H,did:Re})});const{data:Ne,error:jt}=await Rt($)}if(u.contractIds&&u.contractIds.length>0){const $=[];(z=u.contractIds)==null||z.forEach(async Re=>{$.push({proid:H,conid:Re})});const{data:Ne,error:jt}=await Mt($)}const te=[];if(_.value.length>0){const $=ie(_.value,H);te.push(Nt($))}if(S.value.length>0){const $=ie(S.value,H);te.push(Xa($))}if(D.value.length>0&&te.push(Vt(D.value)),(await Promise.allSettled(te)).forEach(($,Ne)=>{$.status==="fulfilled"?console.log(`第 ${Ne+1} 个请求成功`,$.value):console.error(`第 ${Ne+1} 个请求失败`,$.reason)}),!b.value.length){(x=window.$message)==null||x.destroyAll(),(K=window.$message)==null||K.success("操作成功"),ze(),ae("submitted");return}const xe=[];b.value.forEach($=>{xe.push({pid:H,filename:$.name,file:$.url,sort:1})});const{data:Ze,error:Pa}=await Jt(xe);Pa&&((ne=window.$message)==null||ne.error("保存文件记录失败")),(Pe=window.$message)==null||Pe.destroyAll(),(Ie=window.$message)==null||Ie.success("操作成功"),ze(),ae("submitted")}}ze(),ae("submitted"),(ke=window.$message)==null||ke.success("添加成功")}}const Fe=h(!1),mt=h();let Le=null,St=null,Ge=null,wt=null,ye=null;const _e=Ue({longitude:0,latitude:0});let Be;const Ke=h(!1),be=h(""),He=h([]);async function va(){window._AMapSecurityConfig={securityJsCode:y.userInfo.sdksecret},mt.value&&(ye=await zs.load({key:y.userInfo.sdkkey,version:"2.0",plugins:["AMap.Scale","AMap.PlaceSearch","AMap.AutoComplete","AMap.Geocoder","AMap.Geolocation"]}),Le=new ye.Map(mt.value,{zoom:18,center:[w.value>0?D.value[w.value-1].longitude:u.longitude,w.value>0?D.value[w.value-1].latitude:u.latitude],viewMode:"3D",resizeEnable:!0}),St=new ye.Geocoder,new ye.PlaceSearch({city:"全国",pageSize:50}),wt=new ye.AutoComplete({city:"全国"}),gt(ye,{lng:w.value>0?D.value[w.value-1].longitude:u.longitude,lat:w.value>0?D.value[w.value-1].latitude:u.latitude}),Le.on("click",e=>{const{lng:t,lat:l}=e.lnglat;Be=2,_e.latitude=l,_e.longitude=t,gt(ye,{lng:t,lat:l})}),vt(()=>window.dispatchEvent(new Event("resize"))))}const Dt=Zt.debounce(async e=>{if(!Ke.value||!e.trim()){He.value=[];return}wt.search(e,(t,l)=>{var o;console.log(l,"result"),t=="complete"&&l.info=="OK"&&((o=l==null?void 0:l.tips)!=null&&o.length)?He.value=l.tips.map(d=>({label:`${d.name}（${d.district||d.address||"无详细地址"}）`,value:`${d.location.lng}_${d.location.lat}`,raw:d})):He.value=[]})},300);st(be,e=>{Dt(e)});function ha(e,t){if(console.log(e,t,"option"),!e)return;const[l,o]=e.split("_").map(Number);!l||!o||(Le.setCenter([l,o]),Be=1,gt(ye,{lng:l,lat:o}),_e.longitude=l,_e.latitude=o)}const w=h(0);function zt(e){e?w.value=e:w.value=0,Fe.value=!0,Ke.value=!1,Be=void 0,vt(async()=>{await va(),setTimeout(()=>{Ke.value=!0;const t=document.querySelector(".n-auto-complete input");t==null||t.blur()},500)})}function gt(e,t){Ge&&Le.remove(Ge),Ge=new e.Marker({position:[t.lng,t.lat],map:Le}),Le.add(Ge),St.getAddress(t,(l,o)=>{l==="complete"&&o.regeocode&&(console.log("result",o),console.log("formattedAddress",o.regeocode.formattedAddress),t.latitude=t.lat,t.longitude=t.lng,Be==1||(Be==2?be.value=o.regeocode.formattedAddress:be.value=w.value>0?D.value[w.value-1].addr||o.regeocode.formattedAddress:u.prosite||o.regeocode.formattedAddress))})}function ya(e,t){if(!t)return null;const l=t.replace(/省|市|特别行政区|自治区|壮族|回族|维吾尔/g,"").trim(),o=e.find(d=>t.includes(d.name)||d.name.includes(l));return o?o.id:null}const Ft=h([]),_a=async()=>{const{data:e,error:t}=await Za({page:1,limit:100,pid:f.rowData.id});u.dispatchIds=e==null?void 0:e.list.map(l=>l.did),Ft.value=JSON.parse(JSON.stringify(u.dispatchIds))},Pt=h([]),It=async()=>{const{data:e,error:t}=await Qa();e&&(Pt.value=e)},$t=h([]),At=async e=>{let t=ya(Pt.value,e);const{data:l,error:o}=await Ya({page:1,limit:100,province:t});$t.value=l.list},ba=async()=>{var e,t,l;if(w.value==0)u.latitude=_e.latitude,u.longitude=_e.longitude,u.prosite=be.value,await It(),At(be.value);else if(D.value[w.value-1].addr=be.value,D.value[w.value-1].latitude=_e.latitude,D.value[w.value-1].longitude=_e.longitude,f.operateType=="edit"){let o=D.value[w.value-1];if(D.value[w.value-1].id){const{data:d,error:p}=await es([o]);d&&((e=window.$message)==null||e.success("修改位置成功"),Fe.value=!1,w.value=0,Xe())}else{o.pid=(t=f.rowData)==null?void 0:t.id;const{data:d,error:p}=await Vt([o]);d&&((l=window.$message)==null||l.success("添加位置成功"),Fe.value=!1,w.value=0,Xe())}}Fe.value=!1,w.value=0};function ka(){Fe.value=!1}const{pageData:We,getData:xa,nextPage:Ca}=Gt(ts),Sa=async()=>{await xa({limit:100})},wa=async e=>{const t=e.currentTarget,l=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&We.data.length<We.total&&(await Ca(),await vt(),setTimeout(()=>{t.scrollTop=l}))},Lt=h([]),Da=async()=>{var l;const{data:e,error:t}=await as({page:1,limit:100,proid:(l=f.rowData)==null?void 0:l.id});u.contractIds=e==null?void 0:e.list.map(o=>o.conid),Lt.value=JSON.parse(JSON.stringify(u.contractIds))},D=h([{longitude:120.373885,latitude:30.303899,addr:""}]),za=h([]),Xe=async()=>{var l;const{data:e,error:t}=await ss({pid:(l=f.rowData)==null?void 0:l.id,page:1,limit:99});D.value=e.list.length==0?[{longitude:120.373885,latitude:30.303899,addr:""}]:e.list,za.value=JSON.parse(JSON.stringify(D.value))},Fa=async e=>{var t;if(e.id){const{data:l,error:o}=await rs(e.id);l&&((t=window.$message)==null||t.success("删除成功"),Xe())}else D.value.splice(D.value.indexOf(e),1)};return(e,t)=>{const l=oa,o=ws,d=Ma,p=Ss,z=Ht,x=lt,K=ia,ne=Qt,Pe=Ra,Ie=Ba,ke=ea,Y=Ds;return I(),et(Et,null,[a(Ie,{show:Ae.value,"onUpdate:show":[t[13]||(t[13]=m=>Ae.value=m),ma],"display-directive":"show",width:1100,onMaskClick:t[14]||(t[14]=m=>Ae.value=!0),onEsc:ze},{default:n(()=>[a(Pe,{title:fa.value,"native-scrollbar":!1,closable:""},{footer:n(()=>[a(i(ce),{size:16,justify:"end"},{default:n(()=>[a(i(v),{onClick:ze},{default:n(()=>[g(M(i(F)("common.cancel")),1)]),_:1}),a(i(v),{type:"primary",onClick:Ct},{default:n(()=>[g(M(i(F)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[a(ne,{ref_key:"formRef",ref:T,model:u,rules:P,onKeyup:Yt(Ct,["enter"])},{default:n(()=>[a(K,{responsive:"screen","item-responsive":"","x-gap":"15"},{default:n(()=>[a(l,{span:"24 s:12 m:12",label:"项目名称",path:"proname"},{default:n(()=>[a(i(W),{clearable:"",value:u.proname,"onUpdate:value":t[0]||(t[0]=m=>u.proname=m),placeholder:"请输入项目名称"},null,8,["value"])]),_:1}),f.operateType==="add"?(I(),B(l,{key:0,span:"24 s:12 m:12",label:"绑定合同",path:"contractIds"},{default:n(()=>[a(i(Te),{filterable:"",multiple:"",value:u.contractIds,"onUpdate:value":[t[1]||(t[1]=m=>u.contractIds=m),O],placeholder:"请选择合同","label-field":"contractname","value-field":"id",options:i(We).data,onScroll:wa},null,8,["value","options"])]),_:1})):ge("",!0),f.operateType==="edit"?(I(),B(l,{key:1,span:"24 s:12 m:12",label:"项目状态",path:"status"},{default:n(()=>[a(i(Te),{filterable:"",value:u.status,"onUpdate:value":t[2]||(t[2]=m=>u.status=m),placeholder:"请选择项目状态",options:i(Je)(i(y).userInfo.usertype==0||i(y).userInfo.usertype==2?i(kt):i(Fs))},null,8,["value","options"])]),_:1})):ge("",!0),a(l,{span:"24 s:12 m:12",label:"周期（天）",path:"period"},{default:n(()=>[a(i(Ut),{clearable:"",value:u.period,"onUpdate:value":t[3]||(t[3]=m=>u.period=m),style:{width:"100%"},placeholder:"请输入周期"},null,8,["value"])]),_:1}),a(l,{span:"24 s:12 m:12",label:"调试类型",path:"dtype"},{default:n(()=>[a(i(Te),{filterable:"",value:u.dtype,"onUpdate:value":t[4]||(t[4]=m=>u.dtype=m),placeholder:"请选择调试类型",options:i(Je)(i(na))},null,8,["value","options"])]),_:1}),a(l,{span:"24 s:12 m:12",label:"项目默认地点",path:"prosite"},{default:n(()=>[U("div",Ns,[U("div",Us,[a(d,{onClick:t[6]||(t[6]=m=>zt())},{default:n(()=>[a(i(W),{value:u.prosite,"onUpdate:value":t[5]||(t[5]=m=>u.prosite=m),placeholder:"请选择项目地点"},null,8,["value"]),a(i(v),null,{icon:n(()=>[a(o,{class:"text-icon"})]),_:1})]),_:1})])])]),_:1}),a(l,{span:"24 s:12 m:12",label:"项目详细地址",path:"proaddr"},{default:n(()=>[a(i(W),{type:"textarea",rows:1,clearable:"",value:u.proaddr,"onUpdate:value":t[7]||(t[7]=m=>u.proaddr=m),placeholder:"请输入项目详细地址"},null,8,["value"])]),_:1}),D.value.length?(I(),B(l,{key:2,span:"24 s:12 m:24",label:"",path:""},{default:n(()=>[U("div",Ts,[U("div",Es,[U("span",{class:"mr-10px",onClick:t[8]||(t[8]=Ot(()=>{},["stop"]))},"其他地址"),a(i(v),{size:"small",ghost:"",type:"primary",onMousedown:t[9]||(t[9]=Ot(()=>{},["stop"])),onClick:t[10]||(t[10]=m=>D.value.push({latitude:30.303899,longitude:120.373885,addr:""}))},{icon:n(()=>[a(p,{class:"text-icon"})]),default:n(()=>[t[18]||(t[18]=g(" 添加 "))]),_:1,__:[18]})]),U("div",Os,[(I(!0),et(Et,null,Va(D.value,(m,ee)=>(I(),et("div",{class:"flex px-50px items-center mt-10px w-100%",key:m.latitude},[U("span",Bs,"项目地址"+M(ee+1),1),a(d,{onClick:H=>zt(ee+1)},{default:n(()=>[a(i(W),{readonly:"",value:m.addr,"onUpdate:value":H=>m.addr=H,placeholder:"请选择项目地址"+(ee+1)},null,8,["value","onUpdate:value","placeholder"]),a(i(v),null,{icon:n(()=>[a(o,{class:"text-icon"})]),_:1})]),_:2},1032,["onClick"]),D.value.length>1?(I(),B(i(Ce),{key:0,onPositiveClick:H=>Fa(m)},{trigger:n(()=>[a(i(v),{size:"small",ghost:"",type:"error",class:"ml-10px"},{icon:n(()=>[a(z,{class:"text-icon"})]),default:n(()=>[t[19]||(t[19]=g(" "+M("删除")))]),_:1,__:[19]})]),default:n(()=>[g(" 确定要删除项目地址"+M(ee+1)+"吗？ ",1)]),_:2},1032,["onPositiveClick"])):ge("",!0)]))),128))])])]),_:1})):ge("",!0),a(l,{span:"24 s:12 m:12",label:"调度名称",path:"dispatch"},{default:n(()=>[a(i(W),{clearable:"",value:u.dispatch,"onUpdate:value":t[11]||(t[11]=m=>u.dispatch=m),placeholder:"请输入调度名称"},null,8,["value"])]),_:1}),a(l,{span:"24 s:12 m:12",label:"选择调度",path:"dispatchIds"},{default:n(()=>[a(i(Te),{filterable:"",multiple:"",value:u.dispatchIds,"onUpdate:value":t[12]||(t[12]=m=>u.dispatchIds=m),placeholder:"请选择调度","label-field":"dname","value-field":"id",options:$t.value},null,8,["value","options"])]),_:1}),a(l,{span:"24 s:12 m:24",path:"contactList"},{default:n(()=>[U("div",Rs,[a(i(ce),{align:"center",style:{"margin-bottom":"10px"}},{default:n(()=>[t[21]||(t[21]=U("span",null,"项目联系人",-1)),a(i(v),{size:"small",ghost:"",type:"primary",onClick:we},{icon:n(()=>[a(p,{class:"text-icon"})]),default:n(()=>[t[20]||(t[20]=g(" 添加项目联系人 "))]),_:1,__:[20]})]),_:1,__:[21]}),_.value.length>0?(I(),B(x,{key:0,columns:E,"paginate-single-page":!1,data:_.value,pagination:L,"max-height":350,"scroll-x":E.reduce((m,ee)=>m+ee.width,0)},null,8,["data","pagination","scroll-x"])):ge("",!0)])]),_:1}),a(l,{span:"24 s:12 m:24",path:"debuggedDevieceList"},{default:n(()=>[U("div",Ms,[a(i(ce),{align:"center",style:{"margin-bottom":"10px"}},{default:n(()=>[t[23]||(t[23]=U("span",null,"待调试设备",-1)),a(i(v),{size:"small",ghost:"",type:"primary",onClick:pt},{icon:n(()=>[a(p,{class:"text-icon"})]),default:n(()=>[t[22]||(t[22]=g(" 添加待调试设备 "))]),_:1,__:[22]})]),_:1,__:[23]}),S.value.length>0?(I(),B(x,{key:0,style:{width:"1050px"},columns:Oe,data:S.value,size:"small","scroll-x":Oe.reduce((m,ee)=>m+ee.width,0),"row-key":m=>m.id,"max-height":350,pagination:Z.pageSize==1?!1:Z,remote:"","paginate-single-page":!1},null,8,["data","scroll-x","row-key","pagination"])):ge("",!0)])]),_:1}),a(l,{span:"24 s:12 m:24"},{default:n(()=>[U("div",Vs,[a(i(ce),{align:"center",style:{"margin-bottom":"10px"}},{default:n(()=>[t[25]||(t[25]=U("span",null,"图纸",-1)),a(i(v),{size:"small",ghost:"",type:"primary",onClick:ca},{icon:n(()=>[a(p,{class:"text-icon"})]),default:n(()=>[t[24]||(t[24]=g(" 添加图纸 "))]),_:1,__:[24]})]),_:1,__:[25]}),b.value.length>0?(I(),B(x,{key:0,columns:ra,data:b.value,size:"small","scroll-x":702,"row-key":m=>m.id,"max-height":350},null,8,["data","row-key"])):ge("",!0)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"]),a(ke,{show:s.value,"onUpdate:show":t[15]||(t[15]=m=>s.value=m),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:n(()=>[g(M(c.value=="debuggedDevieceList"?"待调试设备":c.value=="debuggedBusinessList"?"待调试业务":c.value=="needsList"?"客户需求变更":c.value=="developBusinessList"?"需要开发":"")+" 文件列表 ",1)]),footer:n(()=>[a(i(ce),{justify:"end"},{default:n(()=>[a(i(v),{size:"small",class:"mt-16px",onClick:ft},{default:n(()=>[g(M(i(F)("common.cancel")),1)]),_:1}),a(i(v),{type:"primary",size:"small",class:"mt-16px",onClick:ue},{default:n(()=>[g(M(i(F)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[a(i(v),{size:"small",ghost:"",type:"primary",onClick:da},{icon:n(()=>[a(p,{class:"text-icon"})]),default:n(()=>[t[26]||(t[26]=g(" 添加 "))]),_:1,__:[26]}),a(x,{columns:ua,"paginate-single-page":!1,data:N.value,"max-height":350},null,8,["data"])]),_:1},8,["show"]),a(ke,{show:Fe.value,"onUpdate:show":t[17]||(t[17]=m=>Fe.value=m),title:"选择项目位置",preset:"card",class:"w-800px"},{footer:n(()=>[a(i(ce),{justify:"end",size:16},{default:n(()=>[a(i(v),{onClick:ka},{default:n(()=>[g(M(i(F)("common.cancel")),1)]),_:1}),a(i(v),{type:"primary",onClick:ba},{default:n(()=>[g(M(i(F)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[Ke.value?(I(),B(Y,{key:0,value:be.value,"onUpdate:value":[t[16]||(t[16]=m=>be.value=m),i(Dt)],options:He.value,placeholder:"请输入地点关键字",clearable:"",onSelect:ha},null,8,["value","options","onUpdate:value"])):ge("",!0),U("div",{ref_key:"domRef",ref:mt,class:"h-full w-full",style:{width:"100%",height:"500px","margin-top":"10px"}},null,512)]),_:1},8,["show"])],64)}}}),qs=it({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:tt(["reset","search"],["update:model"]),setup(X,{emit:oe}){ds();const y=oe,{formRef:ae,restoreValidation:V}=Xt(),f=_t(X,"model"),u={当日:()=>{const k=new Date().getTime();return[k,k]},本周:()=>{const k=new Date().getTime();return[k-24*60*60*1e3*7,k]},上月:()=>{const k=new Date().getTime();return[k-24*60*60*1e3*30,k]},近一年:()=>{const k=new Date().getTime();return[k-24*60*60*1e3*365,k]},近三年:()=>{const k=new Date().getTime();return[k-24*60*60*1e3*365*3,k]}};function pe(){f.value.fuzzy="",y("search")}async function A(k,P){if(!k){f.value.startTime=void 0,f.value.endTime=void 0,y("search");return}f.value.startTime=String(at(1,P[0])),f.value.endTime=String(at(1,P[1])),y("search")}async function re(){f.value.startTime=void 0,f.value.endTime=void 0,f.value.startAndTimeRange=null,f.value.fuzzy="",f.value.status=null,f.value.ptype=null,f.value.dtype=null,await V(),y("reset")}const ve=Zt.debounce(k=>{y("search")},1e3,{leading:!0,trailing:!1}),T=k=>{f.value.fuzzy=k,ve(k)};async function J(){y("search")}return(k,P)=>{const _=W,L=oa,E=Te,C=Ls,q=As,se=v,Se=$s,we=ce,O=ia,R=Qt,Ee=bt;return I(),B(Ee,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[a(R,{ref_key:"formRef",ref:ae,model:f.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Yt(J,["enter"])},{default:n(()=>[a(O,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:n(()=>[a(L,{span:"24 s:12 m:6",label:"项目/客户",path:"fuzzy"},{default:n(()=>[a(_,{clearable:"",value:f.value.fuzzy,"onUpdate:value":P[0]||(P[0]=j=>f.value.fuzzy=j),placeholder:"请输入项目名称或客户名称",onClear:pe,onInput:T},null,8,["value"])]),_:1}),a(L,{span:"24 s:12 m:6",label:"项目状态",path:"status"},{default:n(()=>[a(E,{clearable:"",filterable:"",value:f.value.status,"onUpdate:value":[P[1]||(P[1]=j=>f.value.status=j),J],placeholder:"请选择项目状态",options:i(Je)(i(kt)).sort((j,he)=>j.value-he.value)},null,8,["value","options"])]),_:1}),a(L,{span:"24 s:12 m:6",label:"进度状态",path:"ptype"},{default:n(()=>[a(E,{clearable:"",filterable:"",value:f.value.ptype,"onUpdate:value":[P[2]||(P[2]=j=>f.value.ptype=j),J],placeholder:"请选择进度状态",options:[{label:"正常",value:0},{label:"已延期",value:1}]},null,8,["value"])]),_:1}),a(L,{span:"24 s:12 m:6",label:"调试类型",path:"dtype"},{default:n(()=>[a(E,{clearable:"",filterable:"",value:f.value.dtype,"onUpdate:value":[P[3]||(P[3]=j=>f.value.dtype=j),J],placeholder:"请选择调试类型",options:i(Je)(i(na))},null,8,["value","options"])]),_:1}),a(L,{span:"24 s:12 m:8",label:"起止时间"},{default:n(()=>[a(C,{value:f.value.startAndTimeRange,"onUpdate:value":P[4]||(P[4]=j=>f.value.startAndTimeRange=j),type:"datetimerange",clearable:"",shortcuts:u,"onUpdate:formattedValue":A},null,8,["value"])]),_:1}),a(L,{span:"24  s:12 m:6",class:"pr-24px"},{default:n(()=>[a(we,{class:"w-full"},{default:n(()=>[a(se,{onClick:re},{icon:n(()=>[a(q,{class:"text-icon"})]),default:n(()=>[g(" "+M(i(F)("common.reset")),1)]),_:1}),a(se,{type:"primary",ghost:"",onClick:J},{icon:n(()=>[a(Se,{class:"text-icon"})]),default:n(()=>[g(" "+M(i(F)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Gs={class:"min-h-500px flex gap-16px"},Ks={class:"flex items-center justify-end gap-16px"},Hs=it({__name:"relatedContractLook",props:tt({id:{}},{visable:{type:Boolean},visableModifiers:{}}),emits:["update:visable"],setup(X){const oe=X,y=_t(X,"visable"),{columns:ae,data:V,getData:f,loading:u,mobilePagination:pe,searchParams:A}=yt({apiFn:ta,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,id:oe.id,_t:new Date().getTime()},columns:()=>[{key:"contractname",title:"合同",width:200,render:C=>a("div",{class:_.pids==C.id?"bg-#f1f1f1 cursor-pointer p-5px":"cursor-pointer p-5px",onClick:()=>L(C.id)},[a("div",{class:"flex"},[a("div",{class:"w-60px inline-block"},[g("名称：")]),C.contractname]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[g("编号：")]),g(" "),C.contractnum]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[g("联系人：")]),C.businesscon]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[g("联系方式：")]),C.businessinfo]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[g("注意事项：")]),C.precautions]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[g("备注：")]),C.notes])])}]}),{columns:re,data:ve,getData:T,loading:J,pagination:k,mobilePagination:P,searchParams:_}=yt({apiFn:aa,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,pids:oe.id,_t:new Date().getTime()},columns:()=>[{key:"devname",title:"设备名称",align:"center",width:200,ellipsis:{tooltip:!0}},{key:"devcount",title:"数量",align:"center",width:120},{key:"devmodel",title:"规格型号",align:"center",width:120,ellipsis:{tooltip:!0}},{key:"devunit",title:"单位",align:"center",width:120},{key:"devtype",title:"是否为我司设备",align:"center",width:120,render:C=>C.devtype==0?a(Ve,{type:"success"},{default:()=>[g("是")]}):a(Ve,{type:"info"},{default:()=>[g("否")]})},{key:"devmanu",title:"设备厂家",align:"center",width:120},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"创建人",align:"center",width:120},{key:"dbtime",title:"创建时间",align:"center",width:180}]}),L=C=>{_.pids=C,T()},E=()=>{y.value=!1};return st(()=>y.value,async C=>{var q;C&&(A.id=oe.id,ve.value=[],k.itemCount=0,await f(),_.pids=(q=V.value[0])==null?void 0:q.id,_.pids&&T())}),(C,q)=>{const se=lt,Se=bt,we=ea;return I(),B(we,{show:y.value,"onUpdate:show":q[0]||(q[0]=O=>y.value=O),preset:"card",class:"w-1400px",title:"项目关联的合同"},{footer:n(()=>[U("div",Ks,[a(i(v),{type:"primary",size:"small",onClick:E},{default:n(()=>q[1]||(q[1]=[g(" 关闭 ")])),_:1,__:[1]})])]),default:n(()=>[U("div",Gs,[a(se,{class:"left",columns:i(ae),data:i(V),"paginate-single-page":!1,size:"small",remote:"",loading:i(u),pagination:i(pe),"row-key":O=>O.id,"max-height":600},null,8,["columns","data","loading","pagination","row-key"]),a(Se,{bordered:!1,size:"small",title:"设备",class:"w-1100px"},{default:n(()=>[a(se,{style:{width:"100%"},columns:i(re),data:i(ve),size:"small","max-height":600,loading:i(J),remote:"","scroll-x":i(re).reduce((O,R)=>O+(R.width||100),0),"paginate-single-page":!1,pagination:i(P),"row-key":O=>O.id},null,8,["columns","data","loading","scroll-x","pagination","row-key"])]),_:1})])]),_:1},8,["show"])}}}),Ws=la(Hs,[["__scopeId","data-v-a53f455a"]]),Xs={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Kt(X){return typeof X=="function"||Object.prototype.toString.call(X)==="[object Object]"&&!xs(X)}const Zs=it({name:"projectmanagement_projectlist",__name:"index",setup(X){const oe=cs(),y=Wt(),ae=ps(),V=fs(),{columns:f,columnChecks:u,data:pe,getData:A,loading:re,mobilePagination:ve,searchParams:T}=yt({showTotal:!0,apiFn:ks,apiParams:{page:1,pageSize:20,limit:20,status:null,startAndTimeRange:null,startTime:null,endTime:null,creater:void 0,fuzzy:"",sort:void 0,_t:new Date().getTime()},immediate:!1,columns:()=>[{type:"selection",align:"center",width:48},{key:"proname",title:"项目名称",align:"center",width:240,render:s=>a("div",{class:"cursor-pointer",onClick:()=>De(s)},[s.proname])},{key:"progess",title:"项目进度",align:"center",width:140,sorter:!0,render:s=>a(nt,{type:"line",showIndicator:!0,percentage:s.progess,"indicator-placement":"inside",processing:!0,color:"#1890ff"},null)},{key:"status",title:"项目状态",align:"center",width:120,defaultFilterOptionValue:null,filterOptions:Je(kt),filter:!0,filterMultiple:!1,render:s=>{if(s.status===null)return null;const c=F(qt[s.status]);return a("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",color:s.status==-1?"#a27ff9":s.status===0?"#9ca3af":s.status===1?"#3b82f6":s.status===2?"#facc15":"#22c55e",borderRadius:"50%"}},[a("span",{style:{width:"10px",height:"10px",marginRight:"5px",backgroundColor:s.status==-1?"#a27ff9":s.status===0?"#9ca3af":s.status===1?"#3b82f6":s.status===2?"#facc15":"#22c55e",borderRadius:"50%"}},null),a("span",null,[c])])}},{key:"cpdbtime",title:"预计完成日期",align:"center",width:120,ellipsis:{tooltip:!0}},{key:"period",title:"周期",align:"center",width:100,render:s=>a("div",null,[s.period,g("天")])},{key:"ptype",title:"状态",align:"center",width:80,render:s=>a(Ve,{type:s.ptype===0?"success":"error"},{default:()=>[s.ptype===0?"正常":"已延期"]})},{key:"dtype",title:"调试类型",align:"center",width:100,render:s=>{if(s.dtype===null)return null;const c=F(Ps[s.dtype]);return a(Ve,{type:s.dtype==0?"warning":s.dtype==1?"success":"info"},Kt(c)?c:{default:()=>[c]})}},{key:"debugs",title:"统计数量信息",align:"center",width:160,render(s){const c=(Q,fe,ue)=>{const de=ue>0;return r("div",{style:`
                    cursor: ${de?"pointer":"default"};
                    color: ${de?"#1890ff":"#999"};
                    font-size:13px;
                  `,onClick:()=>de&&rt(fe,s)},`${Q}：${ue}`)};return r("div",{style:"display:flex; flex-direction:column; gap:1px;"},[c("调试任务","business",s.debugs),c("项目总结","projectsummary",s.summarys),c("日报数量","daylog",s.dailys)])}},{key:"username",title:"创建信息",align:"left",width:200,render(s){return a("div",{style:"display:flex; flex-direction:column; font-size:13px; gap:3px; line-height:1.4;"},[a("div",null,[a("span",{style:"color:#666"},[g("创建人：")]),a("span",{style:"font-weight:500"},[s.username||"-"])]),a("div",null,[a("span",{style:"color:#666"},[g("时间：")]),a("span",{style:" font-weight:500"},[s.dbtime||"-"])])])}},{key:"operate",title:F("common.operate"),align:"center",width:320,fixed:"right",render:s=>{let c;return a("div",{class:"flex justify-end gap-8px"},[s.status==-1&&(y.userInfo.usertype==0||y.userInfo.usertype==4||y.userInfo.id==1021||y.userInfo.id==1023)&&a(Ce,{onPositiveClick:()=>se(s,0)},{default:()=>"确定核准该项目吗？",trigger:()=>a(v,{color:"#a43cf9",ghost:!0,size:"small"},{default:()=>["核准"]})}),s.status==0&&(y.userInfo.usertype==0||y.userInfo.usertype==2)&&a(Ce,{onPositiveClick:()=>se(s,1)},{default:()=>"确定启动该项目吗？",trigger:()=>Me(a(v,{type:"success",ghost:!0,size:"small"},{default:()=>["启动"]}),[[Qe("no-auth"),"project:Info:update"]])}),s.status==2&&(y.userInfo.usertype==0||y.userInfo.usertype==2)&&a(Ce,{onPositiveClick:()=>se(s,3)},{default:()=>"是否确认执行审核操作？",trigger:()=>Me(a(v,{type:"warning",ghost:!0,size:"small"},{default:()=>["审核"]}),[[Qe("no-auth"),"project:Info:update"]])}),a(v,{type:"primary",ghost:!0,size:"small",onClick:()=>De(s)},{default:()=>["详情"]}),a(v,{type:"primary",ghost:!0,size:"small",onClick:()=>Ee(s)},{default:()=>["关联合同"]}),Me(a(v,{type:"primary",ghost:!0,size:"small",onClick:()=>Se(s.id)},Kt(c=F("common.edit"))?c:{default:()=>[c]}),[[Qe("no-auth"),"project:Info:update"]])])}}]}),{drawerVisible:J,operateType:k,editingData:P,handleAdd:_,handleEdit:L,checkedRowKeys:E,onBatchDeleted:C}=Cs(pe,A);async function q(){console.log(E.value),we(E.value.join(","),s=>{C()})}const se=async(s,c)=>{var ue;const{data:Q,error:fe}=await sa([{id:s.id,status:c}]);fe||((ue=window.$message)==null||ue.success("操作成功"),A(),c==3&&window.dispatchEvent(new CustomEvent("clearReview",{detail:{id:s.pid,type:"prj"}})))};function Se(s){L(s)}async function we(s,c){const{data:Q,error:fe}=await _s(s);if(!fe)c&&c(Q);else return!1}const O=h(!1),R=h(0),Ee=s=>{O.value=!0,R.value=s.id},j=s=>{T.status=s.status,A()},he=s=>{console.log(s),s.columnKey=="progess"&&(T.sort=s.order=="ascend"?0:s.order=="descend"?1:void 0,A())},le=h(1),ot=s=>{le.value=s,s==0?A():N()},De=s=>{ae.push("/projectmanagement/orderdetail?prjId="+s.id),y.setProjectInfo({pid:s.id,pname:s.proname})},rt=(s,c)=>{ae.push(`/projectmanagement/${s}?prjId=`+c.id+"&pname="+c.proname),y.setProjectInfo({pid:c.id,pname:c.proname})},S=()=>{A()};ms(()=>{V.query.pname?(le.value=0,T.fuzzy=V.query.pname,T.status=2,S(),A()):N()}),st(()=>V.query.pname,s=>{s&&(T.fuzzy=s,A())});const Z=[{key:"proname",width:260,title(){return a("div",{class:"font-size-16px font-bold"},[g("近期项目")])},ellipsis:{tooltip:!0},render:s=>a(bs,{placement:"top",trigger:"hover"},{trigger:()=>a("div",{class:"cursor-pointer text-ellipsis overflow-hidden whitespace-nowrap font-bold",onClick:()=>De(s),style:"max-width: 280px;"},[s.proname||"-"]),default:()=>s.proname||"-"})},{key:"progess",title:"项目进度",align:"center",width:120,render:s=>a(nt,{type:"line",showIndicator:!0,percentage:s.progess,"indicator-placement":"inside",processing:!0,color:s.progess==100?"#22C55E":"#1890ff"},null)},{title:"最后打卡人",key:"clockinusername",align:"center",width:100},{title:"最后打卡时间",key:"lastclockintime",align:"center",width:180},{key:"clockincounts",title:"打卡信息",align:"left",width:200,render(s){return a("div",{style:"display:flex; flex-direction:column; gap:3px; line-height:1.4;"},[a("div",null,[a("span",{style:"color:#666"},[g("打卡人数：")]),a("span",{style:"font-weight:500"},[s.clockincounts!=null?s.clockincounts+"人":"-"])]),a("div",null,[a("span",{style:"color:#666"},[g("打卡人：")]),a("span",{style:" font-weight:500"},[s.clockinusers||"-"])])])}},{key:"status",title:"项目状态",align:"center",width:100,render:s=>{if(s.status===null)return null;const c=F(qt[s.status]);return a("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",color:s.status===0?"#9ca3af":s.status===1?"#3B82F6":s.status===2?"#f1c40f":"#2ecc71",borderRadius:"50%"}},[a("span",{style:{width:"10px",height:"10px",marginRight:"5px",backgroundColor:s.status===0?"#9ca3af":s.status===1?"#3B82F6":s.status===2?"#f1c40f":"#2ecc71",borderRadius:"50%"}},null),a("span",null,[c])])}},{key:"debugname",title:"调试任务信息",align:"left",width:260,render(s){return a("div",{style:"display:flex; flex-direction:column; gap:3px; line-height:1.4;"},[a("div",null,[a("span",{style:"color:#666"},[g("任务名称：")]),a("span",{style:"font-weight:500"},[s.debugname||"-"])]),a("div",null,[a("span",{style:"color:#666"},[g("状态：")]),a(Ve,{size:"small",color:{color:s.debugstatus==-1?"rgba(251, 146, 60, 0.15)":s.debugstatus==0?"rgba(156, 163, 175, 0.15)":s.debugstatus==1?"rgba(59, 130, 246, 0.15)":s.debugstatus==2?"rgba(250, 204, 21, 0.15)":"rgba(16, 185, 129, 0.15)",textColor:s.debugstatus==-1?"#FB923C":s.debugstatus==0?"#9CA3AF":s.debugstatus==1?"#3B82F6":s.debugstatus==2?"#FACC15":"#10B981",borderColor:s.debugstatus==-1?"#FB923C":s.debugstatus==0?"#9CA3AF":s.debugstatus==1?"#3B82F6":s.debugstatus==2?"#FACC15":"#10B981"}},{default:()=>[s.debugstatus==-1?"申请中":s.debugstatus==0?"待调试":s.debugstatus==1?"开始调试":s.debugstatus==2?"待审核":"审核完成"]})])])}},{key:"username",title:"调试信息",align:"left",width:230,render(s){return a("div",{style:"display:flex; flex-direction:column; gap:3px; line-height:1.4;"},[a("div",null,[a("span",{style:"color:#666"},[g("时间：")]),a("span",{style:" font-weight:500"},[s.dbdbtime||"-"])]),a("div",null,[a("span",{style:"color:#666"},[g("调试人：")]),a("span",{style:"font-weight:500"},[s.username||"-"])])])}},{title:"任务审核时间",key:"ckdbtime",width:180}],G=Ue({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",itemCount:0,pageSizes:[10,20],prefix:()=>`共 ${G.itemCount} 条`,onChange:s=>{G.page=s,N()},onUpdatePageSize:s=>{G.pageSize=s,G.page=1,N()}}),Oe=h([]),N=async()=>{const{data:s,error:c}=await gs({page:G.page,limit:G.pageSize});c||(Oe.value=s.list,G.itemCount=s.total)};return(s,c)=>{const Q=js,fe=ys,ue=ce,de=$a,ut=Ht,dt=Ia,ct=lt,pt=lt,ft=bt,qe=Qe("no-auth");return I(),et("div",Xs,[le.value==0?(I(),B(qs,{key:0,model:i(T),"onUpdate:model":c[0]||(c[0]=b=>Ye(T)?T.value=b:null),onReset:S,onSearch:i(A)},null,8,["model","onSearch"])):ge("",!0),a(ft,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},vs({header:n(()=>[a(ue,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:n(()=>[c[6]||(c[6]=U("div",null,"项目列表",-1)),a(fe,{size:"small",value:le.value,"onUpdate:value":[c[1]||(c[1]=b=>le.value=b),ot],name:"radiobuttongroup1"},{default:n(()=>[a(Q,{value:0,label:"默认"}),a(Q,{value:1,label:"近期项目"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:n(()=>[le.value==0?(I(),B(ct,{key:0,"checked-row-keys":i(E),"onUpdate:checkedRowKeys":c[3]||(c[3]=b=>Ye(E)?E.value=b:null),columns:i(f),data:i(pe),size:"small","flex-height":!i(oe).isMobile,"scroll-x":i(f).reduce((b,$e)=>b+($e.width||100),0),loading:i(re),remote:"","row-key":b=>b.id,"onUpdate:sorter":he,pagination:i(ve),class:"sm:h-full","onUpdate:filters":j},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"])):(I(),B(pt,{key:1,ref:"tableContainer",class:"sm:h-full",remote:"",pagination:G.pageSize==1?!1:G,"scroll-x":Z.reduce((b,$e)=>b+($e.width||100),0),columns:Z,data:Oe.value,bordered:!1,"flex-height":!i(oe).isMobile},null,8,["pagination","scroll-x","data","flex-height"])),a(Js,{visible:i(J),"onUpdate:visible":c[4]||(c[4]=b=>Ye(J)?J.value=b:null),onSubmitted:i(A),"operate-type":i(k),"row-data":i(P)},null,8,["visible","onSubmitted","operate-type","row-data"]),a(Ws,{visable:O.value,"onUpdate:visable":c[5]||(c[5]=b=>O.value=b),id:R.value},null,8,["visable","id"])]),_:2},[le.value==0?{name:"header-extra",fn:n(()=>[a(ue,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:n(()=>[Me((I(),B(i(v),{onClick:i(_),size:"small",ghost:"",type:"primary"},{icon:n(()=>[a(de,{class:"text-icon"})]),default:n(()=>[c[7]||(c[7]=g(" "+M("新增项目")))]),_:1,__:[7]},8,["onClick"])),[[qe,"project:Info:insert"]]),a(i(Ce),{onPositiveClick:q},{trigger:n(()=>[Me((I(),B(i(v),{size:"small",ghost:"",type:"error",disabled:i(E).length==0},{icon:n(()=>[a(ut,{class:hs(["text-icon",{"animate-spin":i(re)}])},null,8,["class"])]),default:n(()=>[c[8]||(c[8]=g(" "+M("批量删除")))]),_:1,__:[8]},8,["disabled"])),[[qe,"project:Info:delete"]])]),default:n(()=>[c[9]||(c[9]=g(" 确定要删除选中的合同吗？ "))]),_:1,__:[9]}),a(dt,{columns:i(u),"onUpdate:columns":c[2]||(c[2]=b=>Ye(u)?u.value=b:null),ctype:2},null,8,["columns"])]),_:1})]),key:"0"}:void 0]),1024)])}}}),hl=la(Zs,[["__scopeId","data-v-59cf1b7c"]]);export{hl as default};
