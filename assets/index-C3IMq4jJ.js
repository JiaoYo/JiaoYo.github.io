import{_ as oe}from"./table-header-operation.vue_vue_type_script_setup_true_lang-B5PmJxYc.js";import{d as V,q as O,s as Q,x as J,o as q,c as X,w as n,g as e,h as I,t as B,i as l,$ as v,H as se,ar as Y,P as Z,L as re,B as M,Q as ee,af as ae,r as E,v as ie,b as ue,ag as me,M as de,a1 as ce,ah as pe,ai as fe,a5 as ge,aC as _e,ax as ve,G as H,F as K,e as be,aj as j,ak as he,al as ye}from"./index-Cgb71mqb.js";import{u as we,a as xe}from"./table-DUp9v1h7.js";import{_ as De}from"./round-search-DeE_ikB1.js";import{_ as Ne}from"./round-refresh-Bw_0alcG.js";import{_ as ke}from"./lodash-QtyeoWto.js";import{_ as Se}from"./FormItemGridItem-64x8y8yI.js";import{_ as Te}from"./Grid-D7pzHEmG.js";import{u as Ce}from"./usePageData-BDxgPF40.js";import{a as ze,b as Ie,c as Pe,d as Ue,e as $e}from"./events-DgHsWO-t.js";import{f as Le,a as Re}from"./common-B2FyG6gR.js";import{_ as Ae}from"./Cascader-WW4BmF7F.js";import{h as W}from"./permission-DpWY0cFs.js";import{_ as Fe}from"./Popconfirm-DsSfsIAu.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-B4YgRvgK.js";import"./setting-outlined-DsAz0L7e.js";import"./export-0y2r5k2W.js";import"./refresh-BZbDUj0j.js";import"./round-delete-B-LVfY3a.js";import"./round-plus-C4DYpm9e.js";import"./Upload-Bp48tY3s.js";import"./Progress-B3vt-8jU.js";const je=V({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:O(["reset","search"],["update:model"]),setup(y,{emit:P}){const u=P,{formRef:k,restoreValidation:w}=Q(),t=J(y,"model");function D(p){t.value.fuzzy=p.replace(/\s/g,"")}function C(p){return!p.startsWith(" ")&&!p.endsWith(" ")}function U(){t.value.fuzzy=null,u("search")}async function S(){await w(),u("reset")}async function o(){var p,m,f,b;if(t.value.mintime&&t.value.maxtime&&t.value.maxtime-t.value.mintime<0)return(p=window.$message)==null||p.destroyAll(),(m=window.$message)==null||m.error("最小限定时间不得大于最大限定时间"),!1;if(t.value.minagg&&t.value.maxagg&&t.value.maxagg-t.value.minagg<0)return(f=window.$message)==null||f.destroyAll(),(b=window.$message)==null||b.error("最小聚合次数不得大于最大聚合次数"),!1;u("search")}const x=ke.throttle(o,1e3,{trailing:!1});return(p,m)=>{const f=Y,b=Z,c=Se,$=re,L=Ne,R=M,A=De,T=Te,F=ee,z=ae;return q(),X(z,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[e(F,{ref_key:"formRef",ref:k,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:se(l(x),["enter"])},{default:n(()=>[e(T,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:n(()=>[e(c,{span:"24 s:24 m:12 l:10",label:"最大限定时间"},{default:n(()=>[e(b,{wrap:!1,align:"center",class:"w-100%"},{default:n(()=>[e(f,{value:t.value.mintime,"onUpdate:value":m[0]||(m[0]=s=>t.value.mintime=s),min:0,placeholder:"最小限定时间"},null,8,["value"]),I(" — "),e(f,{value:t.value.maxtime,"onUpdate:value":m[1]||(m[1]=s=>t.value.maxtime=s),min:0,placeholder:"最大限定时间"},null,8,["value"])]),_:1})]),_:1}),e(c,{span:"224 s:24 m:12 l:10",label:"最大聚合次数"},{default:n(()=>[e(b,{wrap:!1,align:"center"},{default:n(()=>[e(f,{value:t.value.minagg,"onUpdate:value":m[2]||(m[2]=s=>t.value.minagg=s),min:0,placeholder:"最小聚合次数"},null,8,["value"]),I(" — "),e(f,{value:t.value.maxagg,"onUpdate:value":m[3]||(m[3]=s=>t.value.maxagg=s),min:0,placeholder:"最大聚合次数"},null,8,["value"])]),_:1})]),_:1}),e(c,{span:"24 s:12 m:8 l:6",label:"策略名称",path:"fuzzy"},{default:n(()=>[e($,{clearable:"",value:t.value.fuzzy,"onUpdate:value":m[4]||(m[4]=s=>t.value.fuzzy=s),placeholder:"请输入策略名称",onInput:D,"allow-input":C,onClear:U},null,8,["value"])]),_:1}),e(c,{span:"24 s:12 m:8 l:6"},{default:n(()=>[e(b,{class:"w-full"},{default:n(()=>[e(R,{onClick:S},{icon:n(()=>[e(L,{class:"text-icon"})]),default:n(()=>[I(" "+B(l(v)("common.reset")),1)]),_:1}),e(R,{type:"primary",ghost:"",onClick:l(x)},{icon:n(()=>[e(A,{class:"text-icon"})]),default:n(()=>[I(" "+B(l(v)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),Be=V({name:"OperateDrawer",__name:"operate-drawer",props:O({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:O(["submitted"],["update:visible"]),setup(y,{emit:P}){const u=y,k=P,w=E({eventsTypeDataList:[]}),t=J(y,"visible"),{formRef:D,validate:C,restoreValidation:U}=Q();ie();const S=ue(()=>({add:"新增聚合策略",edit:"修改聚合策略"})[u.operateType]),o=E(x());function x(){return{etid:null,mrules:null,maxtime:86400,maxagg:2e4,forward:null,sysparam:0}}const p={etid:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},mrules:{type:"array",required:!0,trigger:["blur","change"],message:"不能为空"},maxtime:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},maxagg:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"}};async function m(){const{data:s,error:a}=await Le();a||(w.eventsTypeDataList=s,f())}async function f(){const{data:s,error:a}=await Re();a||w.eventsTypeDataList.forEach(r=>{r.children=s.filter(i=>i.pid===r.id)})}const b=E({data:[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}]}),{pageData:c,getData:$,nextPage:L}=Ce(ze),R=async s=>{const a=s.currentTarget;a.scrollTop+a.offsetHeight>=a.scrollHeight&&c.data.length<c.total&&L()};function A(){m(),$(),Object.assign(o,x()),u.operateType==="edit"&&u.rowData&&(u.rowData.mrules=u.rowData.mrules?u.rowData.mrules.split(",").map(Number):[],u.rowData.forward=u.rowData.forward?u.rowData.forward.split(",").map(Number):[],Object.assign(o,u.rowData))}function T(){t.value=!1}async function F(){var s,a,r,i,g,h;if(await C(),u.operateType==="add"){const{data:d,error:N}=await Ie([{etid:o.etid,mrules:(s=o.mrules)==null?void 0:s.join(","),maxtime:o.maxtime,maxagg:o.maxagg,forward:(a=o.forward)==null?void 0:a.join(",")}]);N||((r=window.$message)==null||r.success(v("common.addSuccess")),T(),k("submitted"))}else{const{data:d,error:N}=await Pe([{id:u.rowData.id,etid:o.etid,mrules:(i=o.mrules)==null?void 0:i.join(","),maxtime:o.maxtime,maxagg:o.maxagg,forward:(g=o.forward)==null?void 0:g.join(",")}]);N||((h=window.$message)==null||h.success(v("common.updateSuccess")),T(),k("submitted"))}}const z=s=>s.ipaddr+":"+s.fport+" ("+(s.ftype==0?"syslog":"SNMP Trap")+")";return me(t,()=>{t.value&&(A(),U())}),(s,a)=>{const r=Ae,i=de,g=ce,h=Y,d=ee,N=M,te=Z,le=pe,ne=fe;return q(),X(ne,{show:t.value,"onUpdate:show":a[5]||(a[5]=_=>t.value=_),"display-directive":"show",width:450},{default:n(()=>[e(le,{title:S.value,"native-scrollbar":!1,closable:""},{footer:n(()=>[e(te,{size:16},{default:n(()=>[e(N,{onClick:T},{default:n(()=>[I(B(l(v)("common.cancel")),1)]),_:1}),e(N,{type:"primary",onClick:F},{default:n(()=>[I(B(l(v)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[e(d,{ref_key:"formRef",ref:D,model:o,rules:p},{default:n(()=>[e(i,{label:"策略名称",path:"etid"},{default:n(()=>[e(r,{value:o.etid,"onUpdate:value":a[0]||(a[0]=_=>o.etid=_),clearable:"",disabled:s.operateType==="edit","check-strategy":"child",placeholder:"请选择策略名称",options:w.eventsTypeDataList,"show-path":!1,filterable:"","value-field":"id","label-field":"pname"},null,8,["value","disabled","options"])]),_:1}),e(i,{label:"匹配规则",path:"mrules"},{default:n(()=>[e(g,{"max-tag-count":2,value:o.mrules,"onUpdate:value":a[1]||(a[1]=_=>o.mrules=_),multiple:"",placeholder:"请选择匹配规则",clearable:"",filterable:"",options:b.data,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),e(i,{label:"最大限定时间(秒)",path:"maxtime"},{default:n(()=>[e(h,{value:o.maxtime,"onUpdate:value":a[2]||(a[2]=_=>o.maxtime=_),clearable:"",min:10,placeholder:"请输入最大限定时间(秒)",style:{width:"100%"}},null,8,["value"])]),_:1}),e(i,{label:"最大聚合次数",path:"maxagg"},{default:n(()=>[e(h,{value:o.maxagg,"onUpdate:value":a[3]||(a[3]=_=>o.maxagg=_),clearable:"",min:2,placeholder:"请输入最大聚合次数",style:{width:"100%"}},null,8,["value"])]),_:1}),e(i,{label:"转发类型",path:"forward"},{default:n(()=>[e(g,{"max-tag-count":1,value:o.forward,"onUpdate:value":a[4]||(a[4]=_=>o.forward=_),multiple:"",placeholder:"请选择转发类型",clearable:"","render-label":z,filterable:"","value-field":"id","label-field":"ipaddr",options:l(c).data,"reset-menu-on-options-change":!1,onScroll:R},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),Me={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function G(y){return typeof y=="function"||Object.prototype.toString.call(y)==="[object Object]"&&!he(y)}const ua=V({name:"eventalarm_aggregatepolicy",__name:"index",setup(y){const P=ge(),u=[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}],{columns:k,columnChecks:w,data:t,getData:D,loading:C,mobilePagination:U,searchParams:S,resetSearchParams:o}=we({apiFn:Ue,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,mintime:null,maxtime:null,minagg:null,maxagg:null,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48,fixed:"left"},{key:"pname",title:"策略名称",align:"center",width:160,ellipsis:{tooltip:!0}},{key:"maxtime",title:"最大限定时间(秒)",align:"center",width:180},{key:"maxagg",title:"最大聚合次数",align:"center",width:180},{key:"mrules",title:"匹配规则",align:"center",width:160,render:a=>{const i=(a.mrules?a.mrules.split(","):[]).map(g=>{const h=u.find(d=>d.value===parseInt(g));return h?h.label:""});return e("div",null,[e("span",null,[i.join(", ")])])}},{key:"sysparam",title:"系统内置",align:"center",width:240,render:a=>{a.sysparam==null&&(a.sysparam=0);const r={0:"success",1:"info"},i=v(_e[a.sysparam]);return e(ve,{size:"small",type:r[a.sysparam]},G(i)?i:{default:()=>[i]})}},{key:"operate",title:v("common.operate"),align:"center",width:160,fixed:"right",render:a=>{let r;return e("div",{class:"flex-center gap-8px"},[H(e(M,{type:"info",ghost:!0,size:"small",onClick:()=>T(a.id)},G(r=v("common.edit"))?r:{default:()=>[r]}),[[K("no-auth"),"aggregate.policy.update"]]),a.sysparam!=0&&e(Fe,{onPositiveClick:()=>F(a.id)},{default:()=>v("common.confirmDelete"),trigger:()=>{let i;return H(e(M,{type:"error",ghost:!0,size:"small"},G(i=v("common.delete"))?i:{default:()=>[i]}),[[K("no-auth"),"aggregate.policy.delete"]])}})])}}]}),{drawerVisible:x,operateType:p,editingData:m,handleAdd:f,handleEdit:b,checkedRowKeys:c,onBatchDeleted:$,onDeleted:L,closeDrawer:R}=xe(t,D);async function A(){console.log(c.value),z(c.value,a=>{$()})}function T(a){b(a)}function F(a){console.log(a),z([a],r=>{L()})}async function z(a,r){const{data:i,error:g}=await $e(a);if(!g)r&&r(i);else return!1}async function s(){}return(a,r)=>{const i=oe,g=ye,h=ae;return q(),be("div",Me,[e(je,{model:l(S),"onUpdate:model":r[0]||(r[0]=d=>j(S)?S.value=d:null),onReset:l(o),onSearch:l(D)},null,8,["model","onReset","onSearch"]),e(h,{title:"聚合策略",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":n(()=>[e(i,{columns:l(w),"onUpdate:columns":r[1]||(r[1]=d=>j(w)?w.value=d:null),"disabled-delete":l(c).length===0,loading:l(C),onAdd:l(f),onDelete:A,onRefresh:l(D),"is-view-export-button":!0,onExportHandler:s,"is-view-add-button":l(W)("aggregate.policy.insert"),"is-view-delete-button":l(W)("aggregate.policy.delete")},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","is-view-delete-button"])]),default:n(()=>[e(g,{"checked-row-keys":l(c),"onUpdate:checkedRowKeys":r[2]||(r[2]=d=>j(c)?c.value=d:null),columns:l(k),data:l(t),size:"small","flex-height":!l(P).isMobile,"scroll-x":l(k).reduce((d,N)=>d+N.width,0),loading:l(C),remote:"","row-key":d=>d.id,pagination:l(U),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),e(Be,{visible:l(x),"onUpdate:visible":r[3]||(r[3]=d=>j(x)?x.value=d:null),"operate-type":l(p),"row-data":l(m),onSubmitted:l(D)},null,8,["visible","operate-type","row-data","onSubmitted"])]),_:1})])}}});export{ua as default};
