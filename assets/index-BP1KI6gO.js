import{_ as Oe}from"./table-header-operation.vue_vue_type_script_setup_true_lang-sZrXAUWR.js";import{d as se,q as ae,s as ue,v as ge,x as _e,b as $e,$ as s,r as we,j as R,y as ye,K as j,o as K,c as L,w as r,g as t,h as T,t as M,i as a,M as ve,L as z,N as le,U as ie,V as he,aT as x,A as de,C as be,X as ke,D as me,B as P,E as oe,aa as je,ab as ze,a9 as De,dq as pe,f as Me,F as Ue,aK as Be,am as te,Z as Ve,dr as qe,ar as Fe,e as Ie,ac as ee,ad as Ae,dt as Ke,S as Ee}from"./index-BthjjP8Z.js";import{h as Ge,i as He,j as Je,e as Le,k as Xe,f as Ze,l as ce,m as Qe}from"./system-manage-CPf3BLDX.js";import{u as We,a as Ye}from"./table-DgUtF0JO.js";import{U as et}from"./common-Cfy7P7FO.js";import{h as tt}from"./basic-config-BmghMmeP.js";import{_ as at}from"./DatePicker-BrYVrpW-.js";import{_ as st}from"./TimePicker-DSpzDHN4.js";import{_ as ot}from"./round-search-D0y4Bi99.js";import{_ as nt}from"./round-refresh-7YBMJmxM.js";import{_ as rt}from"./FormItemGridItem-Cf_xNcQf.js";import{_ as lt}from"./Grid-CrjQrgB8.js";import{_ as it}from"./Tree-DoRhc68t.js";import{h as fe}from"./permission-DgnWzPLf.js";import{_ as ut}from"./Popconfirm-DUBjdYuJ.js";import{_ as dt}from"./DataTable-DVNKf1bg.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-P1qKwD6q.js";import"./setting-outlined-CB-n0fXZ.js";import"./round-delete-imzaxX0A.js";import"./refresh-516o5uee.js";import"./Upload-CXW3Rb5a.js";import"./Progress-CegqNBwu.js";import"./Forward-B9_DMOnd.js";import"./defineProperty-DR7dqcYo.js";const mt=se({name:"UserOperateDrawer",__name:"user-operate-drawer",props:ae({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:ae(["submitted"],["update:visible"]),setup(h,{emit:b}){const i=h,D=b,v=ue(h,"visible"),{formRef:f,validate:U,restoreValidation:B}=ge(),{createConfirmPwdRule:S,defaultRequiredRule:E,formRules:k}=_e(),g=$e(()=>({add:s("page.manage.user.addUser"),edit:s("page.manage.user.editUser")})[i.operateType]),e=we(_());function _(){return{username:"",usertype:void 0,oripwd:"",password:"",confirmPassword:"",superadmin:1,starttime:void 0,endtime:void 0,effstarttime:void 0,effendtime:void 0,udesc:"",status:0}}const d=R(null);async function w(m,u){e.starttime=x(1,u[0]),e.endtime=x(1,u[1])}const V={username:E,usertype:{type:"number",required:!0,trigger:["blur","change"],message:s("page.manage.user.form.usertype")},password:k.pwd,confirmPassword:[{required:!0,message:s("form.confirmPwd.required")},{asyncValidator:(m,u)=>u.trim()!==""&&u!==e.password?Promise.reject(m.message):Promise.resolve(),message:s("form.confirmPwd.invalid"),trigger:"input"}],time:{required:!0,message:"请选择起止日期",asyncValidator:(m,u)=>{var N;return console.log(d.value,"asdasdasd"),((N=d.value)==null?void 0:N.length)>1?Promise.resolve():Promise.reject(m.message)},trigger:["blur","change"]},effstarttime:{type:"number",required:!0,message:s("page.manage.user.form.effstarttime"),trigger:["blur","change"]},effendtime:{type:"number",required:!0,message:s("page.manage.user.form.effendtime"),trigger:["blur","change"]}};function q(){if(X(),d.value=null,Object.assign(e,_()),i.operateType==="edit"&&i.rowData){const m=JSON.parse(JSON.stringify(i.rowData));i.rowData.starttime=i.rowData.starttime?R(x(5,i.rowData.starttime)).value:void 0,i.rowData.endtime=i.rowData.endtime?R(x(5,i.rowData.endtime)).value:void 0,i.rowData.effstarttime=i.rowData.effstarttime&&m.starttime?R(x(5,m.starttime.substring(0,10)+" "+i.rowData.effstarttime)).value:void 0,i.rowData.effendtime=i.rowData.effendtime&&m.endtime?R(x(5,m.endtime.substring(0,10)+" "+i.rowData.effendtime)).value:void 0,d.value=i.rowData.starttime&&i.rowData.endtime?[new Date(i.rowData.starttime).getTime(),new Date(i.rowData.endtime).getTime()]:null,Object.assign(e,i.rowData)}}const O=R({}),X=async()=>{const{data:m,error:u}=await tt();u||(O.value=m)};function F(){v.value=!1}async function G(){var I,C,c,H,A;if(await U(),e.effstarttime&&!e.effendtime)return(I=window.$message)==null?void 0:I.error("有效结束时间不能为空");if(e.effendtime&&!e.effstarttime)return(C=window.$message)==null?void 0:C.error("有效开始时间不能为空");if(e.effstarttime&&e.effendtime&&e.effstarttime>e.effendtime)return(c=window.$message)==null?void 0:c.error("开始时间不能大于结束时间");let m=e.starttime?x(1,e.starttime):null,u=e.endtime?x(1,e.endtime):null,N=e.effstarttime?x(7,e.effstarttime):null,y=e.effendtime?x(7,e.effendtime):null;if(i.operateType==="add"){const{data:Z,error:$}=await Ge(e.username,e.usertype,e.password,m,u,N,y,e.status,e.superadmin,e.udesc);$||((H=window.$message)==null||H.success(s("common.addSuccess")),F(),D("submitted"))}else{const{data:Z,error:$}=await He(i.rowData.id,e.username,e.usertype,e.oripwd,e.password,m,u,N,y,e.status,e.superadmin,e.udesc);$||((A=window.$message)==null||A.success(s("common.updateSuccess")),F(),D("submitted"))}}return ye(v,()=>{v.value&&(q(),B())}),(m,u)=>{const N=de,y=be,I=ke,C=at,c=st,H=me,A=P,Z=oe,$=je,Y=ze,Q=j("no-space");return K(),L(Y,{show:v.value,"onUpdate:show":u[9]||(u[9]=J=>v.value=J),"display-directive":"show",width:500},{default:r(()=>[t($,{title:g.value,"native-scrollbar":!1,closable:""},{footer:r(()=>[t(Z,{size:16},{default:r(()=>[t(A,{onClick:F},{default:r(()=>[T(M(a(s)("common.cancel")),1)]),_:1}),t(A,{type:"primary",onClick:G},{default:r(()=>[T(M(a(s)("common.confirm")),1)]),_:1})]),_:1})]),default:r(()=>[t(H,{ref_key:"formRef",ref:f,model:e,rules:V,onKeyup:ve(G,["enter"])},{default:r(()=>{var J,o,n;return[t(y,{label:a(s)("page.manage.user.username"),path:"username"},{default:r(()=>[z(t(N,{value:e.username,"onUpdate:value":u[0]||(u[0]=l=>e.username=l),disabled:i.operateType==="edit",placeholder:a(s)("page.manage.user.form.username")},null,8,["value","disabled","placeholder"]),[[Q]])]),_:1},8,["label"]),i.operateType==="add"?(K(),L(y,{key:0,label:a(s)("page.login.common.password"),path:"password"},{default:r(()=>[t(N,{value:e.password,"onUpdate:value":u[1]||(u[1]=l=>e.password=l),type:"password","show-password-on":"click",minlength:6,maxlength:18,placeholder:a(s)("page.login.common.passwordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"])):le("",!0),i.operateType==="add"?(K(),L(y,{key:1,label:a(s)("page.login.common.confirmPassword"),path:"confirmPassword"},{default:r(()=>[t(N,{value:e.confirmPassword,"onUpdate:value":u[2]||(u[2]=l=>e.confirmPassword=l),type:"password","show-password-on":"click",minlength:6,maxlength:18,placeholder:a(s)("page.login.common.confirmPasswordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"])):le("",!0),i.operateType!=="edit"?(K(),L(y,{key:2,label:a(s)("page.manage.user.usertype"),path:"usertype"},{default:r(()=>[t(I,{filterable:"",value:e.usertype,"onUpdate:value":u[3]||(u[3]=l=>e.usertype=l),placeholder:a(s)("page.manage.user.form.usertype"),options:a(ie)(a(he)),style:{width:"100%"}},null,8,["value","placeholder","options"])]),_:1},8,["label"])):le("",!0),t(y,{label:"起止日期",path:((J=O.value)==null?void 0:J.aceffective)==1?"time":""},{default:r(()=>[t(C,{value:d.value,"onUpdate:value":u[4]||(u[4]=l=>d.value=l),type:"datetimerange","value-format":"yyyy-MM-dd hh:mm:ss","onUpdate:formattedValue":w,style:{width:"100%"}},null,8,["value"])]),_:1},8,["path"]),t(y,{label:a(s)("page.manage.user.effstarttime"),path:((o=O.value)==null?void 0:o.aceffective)==1?"effstarttime":""},{default:r(()=>[t(c,{value:e.effstarttime,"onUpdate:value":u[5]||(u[5]=l=>e.effstarttime=l),format:"HH:mm",style:{width:"100%"}},null,8,["value"])]),_:1},8,["label","path"]),t(y,{label:a(s)("page.manage.user.effendtime"),path:((n=O.value)==null?void 0:n.aceffective)==1?"effendtime":""},{default:r(()=>[t(c,{value:e.effendtime,"onUpdate:value":u[6]||(u[6]=l=>e.effendtime=l),format:"HH:mm",style:{width:"100%"}},null,8,["value"])]),_:1},8,["label","path"]),t(y,{label:a(s)("page.manage.user.udesc"),path:"udesc"},{default:r(()=>[t(N,{value:e.udesc,"onUpdate:value":u[7]||(u[7]=l=>e.udesc=l),placeholder:a(s)("page.manage.user.form.udesc")},null,8,["value","placeholder"])]),_:1},8,["label"]),t(y,{label:a(s)("page.manage.user.status"),path:"status"},{default:r(()=>[t(I,{value:e.status,"onUpdate:value":u[8]||(u[8]=l=>e.status=l),placeholder:a(s)("page.manage.user.form.status"),options:a(ie)(a(et)),style:{width:"100%"}},null,8,["value","placeholder","options"])]),_:1},8,["label"])]}),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),pt=se({name:"UserSearch",__name:"user-search",props:{model:{required:!0},modelModifiers:{}},emits:ae(["reset","search"],["update:model"]),setup(h,{emit:b}){const i=b,{formRef:D,restoreValidation:v}=ge(),f=ue(h,"model");function U(){f.value.fuzzy="",i("search")}async function B(){await v(),i("reset")}async function S(){i("search")}return(E,k)=>{const g=ke,e=rt,_=de,d=nt,w=P,V=ot,q=oe,O=lt,X=me,F=De,G=j("no-space");return K(),L(F,{bordered:!1,size:"small",class:"card-wrapper"},{default:r(()=>[t(X,{ref_key:"formRef",ref:D,model:f.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:ve(S,["enter"])},{default:r(()=>[t(O,{responsive:"screen","item-responsive":""},{default:r(()=>[t(e,{span:"24 s:12 m:6",label:a(s)("page.manage.user.usertype"),path:"usertype",class:"pr-24px"},{default:r(()=>[t(g,{filterable:"",clearable:"",value:f.value.usertype,"onUpdate:value":[k[0]||(k[0]=m=>f.value.usertype=m),S],placeholder:a(s)("page.manage.user.form.usertype"),options:a(ie)(a(he))},null,8,["value","placeholder","options"])]),_:1},8,["label"]),t(e,{span:"24 s:12 m:6",label:a(s)("page.manage.user.username"),path:"username",class:"pr-24px"},{default:r(()=>[z(t(_,{clearable:"",value:f.value.fuzzy,"onUpdate:value":k[1]||(k[1]=m=>f.value.fuzzy=m),placeholder:a(s)("page.manage.user.form.username"),onClear:U},null,8,["value","placeholder"]),[[G]])]),_:1},8,["label"]),t(e,{span:"24 m:12",class:"pr-24px"},{default:r(()=>[t(q,{class:"w-full"},{default:r(()=>[t(w,{onClick:B},{icon:r(()=>[t(d,{class:"text-icon"})]),default:r(()=>[T(" "+M(a(s)("common.reset")),1)]),_:1}),t(w,{type:"primary",ghost:"",onClick:S},{icon:r(()=>[t(V,{class:"text-icon"})]),default:r(()=>[T(" "+M(a(s)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),ct=Me("div",{class:"flex"},"设置用户角色",-1),ft=se({name:"assignRoles",__name:"assign-roles",props:ae({rowObj:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:["update:visible"],setup(h){const b=h,i=ue(h,"visible");function D(){i.value=!1}const v=pe([]),f=async()=>{const{error:g,data:e}=await Le();if(!g){const _=JSON.parse(JSON.stringify(e));v.value=_.list.map(d=>(d.rtype!=b.rowObj.usertype&&(d.disabled=!0),d.suffix=()=>Be(te,{text:!0,type:d.rtype==0?"success":d.rtype==1?"warning":"info",size:"small"},{default:()=>d.rtype==0?"管理员":d.rtype==1?"操作员":"审计员"}),d))}},U=pe([]);async function B(){if(b.rowObj.id){const{data:g,error:e}=await Xe(b.rowObj.id);e||(U.value=[g.roleId])}}const S=async(g,e,_)=>{var d;U.value=[(d=_.node)==null?void 0:d.id]};async function E(){var g,e,_;if(b.rowObj.id){const{data:d,error:w}=await Je(b.rowObj.id,U.value.join(","));w||((g=window.$message)==null||g.destroyAll(),(_=(e=window.$message)==null?void 0:e.success)==null||_.call(e,s("common.modifySuccess")),D())}}function k(){b.rowObj.id&&(f(),B())}return ye(i,g=>{g&&k()}),(g,e)=>{const _=it,d=P,w=oe,V=Ue;return K(),L(V,{show:i.value,"onUpdate:show":e[0]||(e[0]=q=>i.value=q),preset:"card",class:"w-480px"},{header:r(()=>[ct]),footer:r(()=>[t(w,{justify:"end"},{default:r(()=>[t(d,{size:"small",class:"mt-16px",onClick:D},{default:r(()=>[T(M(a(s)("common.cancel")),1)]),_:1}),t(d,{type:"primary",size:"small",class:"mt-16px",onClick:E},{default:r(()=>[T(M(a(s)("common.confirm")),1)]),_:1})]),_:1})]),default:r(()=>[t(_,{cascade:"","checked-keys":U.value,data:v.value,checkable:"","expand-on-click":"","virtual-scroll":"","block-line":"","label-field":"name","key-field":"id","children-field":"children","onUpdate:checkedKeys":S},null,8,["checked-keys","data"])]),_:1},8,["show"])}}}),gt={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function W(h){return typeof h=="function"||Object.prototype.toString.call(h)==="[object Object]"&&!Ae(h)}const Ft=se({name:"manage_user",__name:"index",setup(h){const b=Ve(),{columns:i,columnChecks:D,data:v,getData:f,loading:U,mobilePagination:B,searchParams:S,resetSearchParams:E}=We({apiFn:Ze,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,usertype:null,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"username",title:s("page.manage.user.username"),align:"center",width:200},{key:"usertype",title:s("page.manage.user.usertype"),align:"center",width:140,render:o=>{o.usertype===void 0&&(o.usertype=0);const n={0:"primary",1:"primary",2:"primary"},l=s(qe[o.usertype]);return t(te,{type:n[o.usertype]},W(l)?l:{default:()=>[l]})}},{key:"superadmin",title:"是否为根用户",align:"center",width:140,render:o=>{const n={0:"primary",1:"error"},l=s(Fe[o.superadmin]);return t(te,{type:n[o.superadmin]},W(l)?l:{default:()=>[l]})}},{key:"udesc",title:"用户描述",align:"center",width:180,ellipsis:!0},{key:"createdate",title:s("page.manage.user.createDate"),align:"center",width:180},{key:"status",title:s("page.manage.user.status"),align:"center",width:100,render:o=>{o.status===null&&(o.status=0);const n={0:"success",1:"error",2:"warning"},l=o.status==0?"正常":o.status==1?"异常":"锁定";return t(te,{type:n[o.status]},W(l)?l:{default:()=>[l]})}},{key:"operate",title:s("common.operate"),align:"center",width:400,fixed:"right",render:o=>{let n;return o.superadmin!=0?t("div",{class:"flex-center gap-8px"},[z(t(P,{type:"primary",ghost:!0,size:"small",onClick:()=>u(o.id)},W(n=s("common.edit"))?n:{default:()=>[n]}),[[j("no-auth"),"sys:user:update"]]),z(t(P,{type:"primary",ghost:!0,size:"small",onClick:()=>J(o)},{default:()=>["分配角色"]}),[[j("no-auth"),"sys:user:updateRoleUser"]]),o.status==0&&z(t(P,{type:"primary",ghost:!0,size:"small",onClick:()=>G(o.id)},{default:()=>["锁定"]}),[[j("no-auth"),"sys:user:update"]]),o.status==2&&z(t(P,{type:"primary",ghost:!0,size:"small",onClick:()=>F(o.id)},{default:()=>["解锁"]}),[[j("no-auth"),"sys:user:update"]]),z(t(P,{type:"primary",ghost:!0,size:"small",onClick:()=>A(o)},{default:()=>["修改密码"]}),[[j("no-auth"),"sys:user:update"]]),t(ut,{onPositiveClick:()=>m(o.id)},{default:()=>s("common.confirmDelete"),trigger:()=>{let l;return z(t(P,{type:"error",ghost:!0,size:"small"},W(l=s("common.delete"))?l:{default:()=>[l]}),[[j("no-auth"),"sys:user:delete"]])}})]):t("span",{class:"c-#a4b0be"},[T("系统用户不允许操作")])}}]}),{drawerVisible:k,operateType:g,editingData:e,handleAdd:_,handleEdit:d,checkedRowKeys:w,onBatchDeleted:V,onDeleted:q,closeDrawer:O}=Ye(v,f);async function X(){console.log(w.value),$(w.value,o=>{V()})}const F=async o=>{var n;await ce({id:o,status:0}),(n=window.$message)==null||n.success("解锁成功"),f()},G=async o=>{var n;await ce({id:o,status:2}),(n=window.$message)==null||n.success("锁定成功"),f()};function m(o){console.log(o),$([o],n=>{q()})}function u(o){d(o)}const{createConfirmPwdRule:N,defaultRequiredRule:y,patternRules:I}=_e(),C=R(!1),c=we({username:"",password:"",confirmPassword:"",id:null}),H={password:[y,I.password],confirmPassword:[{required:!0,message:s("form.confirmPwd.required")},{asyncValidator:(o,n)=>n.trim()!==""&&n!==c.password?Promise.reject(o.message):Promise.resolve(),message:s("form.confirmPwd.invalid"),trigger:"input"}]},A=o=>{C.value=!0,c.id=o.id,c.username=o.username},Z=async()=>{var l;if(!c.id)return;const{data:o,error:n}=await Ke(c.id,c.password);n||((l=window.$message)==null||l.success("修改成功"),C.value=!1)};async function $(o,n){const l=await Qe(o);console.log("data",l),n&&n(l)}const Y=R(),Q=R(!1),J=o=>{Y.value=o,Q.value=!0};return(o,n)=>{const l=Oe,Ne=dt,ne=de,re=be,Pe=me,Se=Ee,xe=oe,Ce=Ue,Re=De;return K(),Ie("div",gt,[t(pt,{model:a(S),"onUpdate:model":n[0]||(n[0]=p=>ee(S)?S.value=p:null),onReset:a(E),onSearch:a(f)},null,8,["model","onReset","onSearch"]),t(Re,{title:a(s)("page.manage.user.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":r(()=>[t(l,{columns:a(D),"onUpdate:columns":n[1]||(n[1]=p=>ee(D)?D.value=p:null),"disabled-delete":a(w).length===0,loading:a(U),onAdd:a(_),onDelete:X,onRefresh:a(f),"is-view-add-button":a(fe)("sys:user:insert"),"is-view-delete-button":a(fe)("sys:user:delete")},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","is-view-delete-button"])]),default:r(()=>[t(Ne,{"checked-row-keys":a(w),"onUpdate:checkedRowKeys":n[2]||(n[2]=p=>ee(w)?w.value=p:null),columns:a(i),data:a(v),size:"small","flex-height":!a(b).isMobile,"scroll-x":a(i).reduce((p,Te)=>p+Te.width,0),loading:a(U),remote:"","row-key":p=>p.id,pagination:a(B),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),t(mt,{visible:a(k),"onUpdate:visible":n[3]||(n[3]=p=>ee(k)?k.value=p:null),"operate-type":a(g),"row-data":a(e),onSubmitted:a(f)},null,8,["visible","operate-type","row-data","onSubmitted"]),t(ft,{rowObj:Y.value,visible:Q.value,"onUpdate:visible":n[4]||(n[4]=p=>Q.value=p)},null,8,["rowObj","visible"]),t(Ce,{show:C.value,"onUpdate:show":n[8]||(n[8]=p=>C.value=p),title:a(s)("common.updatePassword"),preset:"card",class:"w-620px"},{footer:r(()=>[t(xe,{justify:"end",size:16},{default:r(()=>[t(a(P),{onClick:a(O)},{default:r(()=>[T(M(a(s)("common.cancel")),1)]),_:1},8,["onClick"]),t(a(P),{type:"primary",onClick:Z},{default:r(()=>[T(M(a(s)("common.confirm")),1)]),_:1})]),_:1})]),default:r(()=>[t(Se,{class:"max-h-480px pr-20px"},{default:r(()=>[t(Pe,{ref:"formRef",model:c,rules:H,"label-placement":"left","label-width":100,"require-mark-placement":"left"},{default:r(()=>[t(re,{label:a(s)("page.manage.user.username"),path:"username"},{default:r(()=>[t(ne,{readonly:"",value:c.username,"onUpdate:value":n[5]||(n[5]=p=>c.username=p),placeholder:a(s)("page.manage.user.form.username")},null,8,["value","placeholder"])]),_:1},8,["label"]),t(re,{label:a(s)("page.login.common.password"),path:"password"},{default:r(()=>[t(ne,{type:"password","show-password-on":"click",clearable:"",value:c.password,"onUpdate:value":n[6]||(n[6]=p=>c.password=p),placeholder:a(s)("page.login.common.passwordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"]),t(re,{label:a(s)("page.login.common.confirmPassword"),path:"confirmPassword"},{default:r(()=>[t(ne,{type:"password","show-password-on":"click",clearable:"",value:c.confirmPassword,"onUpdate:value":n[7]||(n[7]=p=>c.confirmPassword=p),placeholder:a(s)("page.login.common.confirmPasswordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])]),_:1},8,["title"])])}}});export{Ft as default};
