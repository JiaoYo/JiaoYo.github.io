import{_ as oe}from"./table-header-operation.vue_vue_type_script_setup_true_lang-4uJD7G6W.js";import{d as q,q as O,v as Y,s as J,o as G,c as Q,w as n,g as e,h as P,t as j,i as o,$ as h,N as se,A as re,ak as X,E as Z,B as E,D as ee,aa as ae,r as M,x as ie,b as ue,y as me,C as de,Y as ce,ab as pe,ac as fe,a0 as ge,M as V,L as H,e as _e,ad as B,ae as ve}from"./index-Cw03N3Zb.js";import{u as be,a as he}from"./table-pW7AL8c6.js";import{_ as we}from"./round-search-CjX6C_4m.js";import{_ as ye}from"./round-refresh-1h-Gpja5.js";import{_ as xe}from"./FormItemGridItem-SvsLsq5T.js";import{_ as De}from"./Grid--xFJOl9N.js";import{u as Ne}from"./usePageData-DoHF0ocL.js";import{a as ke,b as Se,c as Ce,d as Te,e as ze}from"./events-DsZa0Xdn.js";import{f as Ie,a as Pe}from"./common-V6hv81G8.js";import{_ as Ue}from"./Cascader-DGlMpFhY.js";import{h as K}from"./permission-CPsCMacX.js";import{_ as $e}from"./Popconfirm-B2thSO6u.js";import{_ as Ae}from"./DataTable-Cl633dKI.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-7Piq3qDV.js";import"./setting-outlined-BCm9xmub.js";import"./round-delete-DyFqyA58.js";import"./refresh-ITAUszw8.js";import"./round-plus-CnpkLCwp.js";import"./Upload-B9graKKF.js";import"./Progress-Bo8SvBah.js";import"./Forward-CjRKdAIx.js";const Le=q({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:O(["reset","search"],["update:model"]),setup(w,{emit:U}){const i=U,{formRef:S,restoreValidation:y}=Y(),t=J(w,"model");function x(c){t.value.fuzzy=c.replace(/\s/g,"")}function z(c){return!c.startsWith(" ")&&!c.endsWith(" ")}function $(){t.value.fuzzy=null,i("search")}async function C(){await y(),i("reset")}async function l(){var c,u,D,g;if(t.value.mintime&&t.value.maxtime&&t.value.maxtime-t.value.mintime<0)return(c=window.$message)==null||c.destroyAll(),(u=window.$message)==null||u.error("最小限定时间不得大于最大限定时间"),!1;if(t.value.minagg&&t.value.maxagg&&t.value.maxagg-t.value.minagg<0)return(D=window.$message)==null||D.destroyAll(),(g=window.$message)==null||g.error("最小聚合次数不得大于最大聚合次数"),!1;i("search")}return(c,u)=>{const D=re,g=xe,N=X,p=Z,A=ye,I=E,F=we,L=De,T=ee,R=ae;return G(),Q(R,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[e(T,{ref_key:"formRef",ref:S,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:se(l,["enter"])},{default:n(()=>[e(L,{responsive:"screen","item-responsive":""},{default:n(()=>[e(g,{span:"24 s:12 m:6",label:"策略名称",path:"fuzzy",class:"pr-24px"},{default:n(()=>[e(D,{clearable:"",value:t.value.fuzzy,"onUpdate:value":u[0]||(u[0]=f=>t.value.fuzzy=f),placeholder:"请输入策略名称",onInput:x,"allow-input":z,onClear:$},null,8,["value"])]),_:1}),e(g,{span:"24 s:12 m:7",label:"最大限定时间",class:"pr-24px"},{default:n(()=>[e(p,{wrap:!1,align:"center"},{default:n(()=>[e(N,{value:t.value.mintime,"onUpdate:value":u[1]||(u[1]=f=>t.value.mintime=f),min:0,placeholder:"最小限定时间"},null,8,["value"]),P(" — "),e(N,{value:t.value.maxtime,"onUpdate:value":u[2]||(u[2]=f=>t.value.maxtime=f),min:0,placeholder:"最大限定时间"},null,8,["value"])]),_:1})]),_:1}),e(g,{span:"24 s:12 m:7",label:"最大聚合次数",class:"pr-24px"},{default:n(()=>[e(p,{wrap:!1,align:"center"},{default:n(()=>[e(N,{value:t.value.minagg,"onUpdate:value":u[3]||(u[3]=f=>t.value.minagg=f),min:0,placeholder:"最小聚合次数"},null,8,["value"]),P(" — "),e(N,{value:t.value.maxagg,"onUpdate:value":u[4]||(u[4]=f=>t.value.maxagg=f),min:0,placeholder:"最大聚合次数"},null,8,["value"])]),_:1})]),_:1}),e(g,{span:"24 m:4",class:"pr-24px"},{default:n(()=>[e(p,{class:"w-full"},{default:n(()=>[e(I,{onClick:C},{icon:n(()=>[e(A,{class:"text-icon"})]),default:n(()=>[P(" "+j(o(h)("common.reset")),1)]),_:1}),e(I,{type:"primary",ghost:"",onClick:l},{icon:n(()=>[e(F,{class:"text-icon"})]),default:n(()=>[P(" "+j(o(h)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Re=q({name:"OperateDrawer",__name:"operate-drawer",props:O({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:O(["submitted"],["update:visible"]),setup(w,{emit:U}){const i=w,S=U,y=M({eventsTypeDataList:[]}),t=J(w,"visible"),{formRef:x,validate:z,restoreValidation:$}=Y();ie();const C=ue(()=>({add:"新增聚合策略",edit:"修改聚合策略"})[i.operateType]),l=M(c());function c(){return{etid:null,mrules:null,maxtime:86400,maxagg:2e4,forward:null,sysparam:0}}const u={etid:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},mrules:{type:"array",required:!0,trigger:["blur","change"],message:"不能为空"},maxtime:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},maxagg:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"}};async function D(){const{data:d,error:a}=await Ie();a||(y.eventsTypeDataList=d,g())}async function g(){const{data:d,error:a}=await Pe();a||y.eventsTypeDataList.forEach(s=>{s.children=d.filter(r=>r.pid===s.id)})}const N=M({data:[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}]}),{pageData:p,getData:A,nextPage:I}=Ne(ke),F=async d=>{const a=d.currentTarget;a.scrollTop+a.offsetHeight>=a.scrollHeight&&p.data.length<p.total&&I()};function L(){D(),A(),Object.assign(l,c()),i.operateType==="edit"&&i.rowData&&(i.rowData.mrules=i.rowData.mrules?i.rowData.mrules.split(",").map(Number):[],i.rowData.forward=i.rowData.forward?i.rowData.forward.split(",").map(Number):[],Object.assign(l,i.rowData))}function T(){t.value=!1}async function R(){var d,a,s,r,_,b;if(await z(),i.operateType==="add"){const{data:m,error:k}=await Se([{etid:l.etid,mrules:(d=l.mrules)==null?void 0:d.join(","),maxtime:l.maxtime,maxagg:l.maxagg,forward:(a=l.forward)==null?void 0:a.join(",")}]);k||((s=window.$message)==null||s.success(h("common.addSuccess")),T(),S("submitted"))}else{const{data:m,error:k}=await Ce([{id:i.rowData.id,etid:l.etid,mrules:(r=l.mrules)==null?void 0:r.join(","),maxtime:l.maxtime,maxagg:l.maxagg,forward:(_=l.forward)==null?void 0:_.join(",")}]);k||((b=window.$message)==null||b.success(h("common.updateSuccess")),T(),S("submitted"))}}const f=d=>d.ipaddr+":"+d.fport+" ("+(d.ftype==0?"syslog":"SNMP Trap")+")";return me(t,()=>{t.value&&(L(),$())}),(d,a)=>{const s=Ue,r=de,_=ce,b=X,m=ee,k=E,te=Z,le=pe,ne=fe;return G(),Q(ne,{show:t.value,"onUpdate:show":a[5]||(a[5]=v=>t.value=v),"display-directive":"show",width:450},{default:n(()=>[e(le,{title:C.value,"native-scrollbar":!1,closable:""},{footer:n(()=>[e(te,{size:16},{default:n(()=>[e(k,{onClick:T},{default:n(()=>[P(j(o(h)("common.cancel")),1)]),_:1}),e(k,{type:"primary",onClick:R},{default:n(()=>[P(j(o(h)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[e(m,{ref_key:"formRef",ref:x,model:l,rules:u},{default:n(()=>[e(r,{label:"策略名称",path:"etid"},{default:n(()=>[e(s,{value:l.etid,"onUpdate:value":a[0]||(a[0]=v=>l.etid=v),clearable:"","check-strategy":"child",placeholder:"请选择策略名称",options:y.eventsTypeDataList,"show-path":!1,filterable:"","value-field":"id","label-field":"pname"},null,8,["value","options"])]),_:1}),e(r,{label:"匹配规则",path:"mrules"},{default:n(()=>[e(_,{"max-tag-count":2,value:l.mrules,"onUpdate:value":a[1]||(a[1]=v=>l.mrules=v),multiple:"",placeholder:"请选择匹配规则",clearable:"",filterable:"",options:N.data,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),e(r,{label:"最大限定时间",path:"maxtime"},{default:n(()=>[e(b,{value:l.maxtime,"onUpdate:value":a[2]||(a[2]=v=>l.maxtime=v),clearable:"",min:0,placeholder:"请输入最大限定时间(秒)",style:{width:"100%"}},null,8,["value"])]),_:1}),e(r,{label:"最大聚合次数",path:"maxagg"},{default:n(()=>[e(b,{value:l.maxagg,"onUpdate:value":a[3]||(a[3]=v=>l.maxagg=v),clearable:"",min:0,placeholder:"请输入最大聚合次数",style:{width:"100%"}},null,8,["value"])]),_:1}),e(r,{label:"转发类型",path:"forward"},{default:n(()=>[e(_,{"max-tag-count":1,value:l.forward,"onUpdate:value":a[4]||(a[4]=v=>l.forward=v),multiple:"",placeholder:"请选择转发类型",clearable:"","render-label":f,filterable:"","value-field":"id","label-field":"ipaddr",options:o(p).data,"reset-menu-on-options-change":!1,onScroll:F},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),Fe={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function W(w){return typeof w=="function"||Object.prototype.toString.call(w)==="[object Object]"&&!ve(w)}const sa=q({name:"eventalarm_aggregatepolicy",__name:"index",setup(w){const U=ge(),i=[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}],{columns:S,columnChecks:y,data:t,getData:x,loading:z,mobilePagination:$,searchParams:C,resetSearchParams:l}=be({apiFn:Te,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,mintime:null,maxtime:null,minagg:null,maxagg:null,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48,fixed:"left"},{key:"pname",title:"策略名称",align:"center",width:160,ellipsis:{tooltip:!0}},{key:"maxtime",title:"最大限定时间(秒)",align:"center",width:180},{key:"maxagg",title:"最大聚合次数",align:"center",width:180},{key:"mrules",title:"匹配规则",align:"center",width:160,render:a=>{const r=(a.mrules?a.mrules.split(","):[]).map(_=>{const b=i.find(m=>m.value===parseInt(_));return b?b.label:""});return e("div",null,[e("span",null,[r.join(", ")])])}},{key:"operate",title:h("common.operate"),align:"center",width:160,fixed:"right",render:a=>{let s;return a.sysparam!=0&&e("div",{class:"flex-center gap-8px"},[V(e(E,{type:"info",ghost:!0,size:"small",onClick:()=>T(a.id)},W(s=h("common.edit"))?s:{default:()=>[s]}),[[H("no-auth"),"aggregate.policy.update"]]),e($e,{onPositiveClick:()=>R(a.id)},{default:()=>h("common.confirmDelete"),trigger:()=>{let r;return V(e(E,{type:"error",ghost:!0,size:"small"},W(r=h("common.delete"))?r:{default:()=>[r]}),[[H("no-auth"),"aggregate.policy.delete"]])}})])}}]}),{drawerVisible:c,operateType:u,editingData:D,handleAdd:g,handleEdit:N,checkedRowKeys:p,onBatchDeleted:A,onDeleted:I,closeDrawer:F}=he(t,x);async function L(){console.log(p.value),f(p.value,a=>{A()})}function T(a){N(a)}function R(a){console.log(a),f([a],s=>{I()})}async function f(a,s){const{data:r,error:_}=await ze(a);if(!_)s&&s(r);else return!1}async function d(){}return(a,s)=>{const r=oe,_=Ae,b=ae;return G(),_e("div",Fe,[e(Le,{model:o(C),"onUpdate:model":s[0]||(s[0]=m=>B(C)?C.value=m:null),onReset:o(l),onSearch:o(x)},null,8,["model","onReset","onSearch"]),e(b,{title:"聚合策略",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":n(()=>[e(r,{columns:o(y),"onUpdate:columns":s[1]||(s[1]=m=>B(y)?y.value=m:null),"disabled-delete":o(p).length===0,loading:o(z),onAdd:o(g),onDelete:L,onRefresh:o(x),"is-view-export-button":!0,onExportHandler:d,"is-view-add-button":o(K)("aggregate.policy.insert"),"is-view-delete-button":o(K)("aggregate.policy.delete")},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","is-view-delete-button"])]),default:n(()=>[e(_,{"checked-row-keys":o(p),"onUpdate:checkedRowKeys":s[2]||(s[2]=m=>B(p)?p.value=m:null),columns:o(S),data:o(t),size:"small","flex-height":!o(U).isMobile,"scroll-x":o(S).reduce((m,k)=>m+k.width,0),loading:o(z),remote:"","row-key":m=>m.id,pagination:o($),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),e(Re,{visible:o(c),"onUpdate:visible":s[3]||(s[3]=m=>B(c)?c.value=m:null),"operate-type":o(u),"row-data":o(D),onSubmitted:o(x)},null,8,["visible","operate-type","row-data","onSubmitted"])]),_:1})])}}});export{sa as default};
