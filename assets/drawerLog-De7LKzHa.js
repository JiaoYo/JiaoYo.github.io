import{d as Y,av as G,z as Z,C as re,D as ee,aK as te,s as $,A as ie,a as ce,at as ae,au as J,d8 as de,c as z,o as g,w as a,f as s,M as ne,G as E,e as i,N as oe,h as t,ay as ue,H as C,t as u,J as pe,B as V,g as D,$ as X,a4 as me,cC as fe,aE as ve,f5 as _e,f6 as ge,X as be,f7 as ye,F as we,bo as he,b as q,aM as x,b3 as xe,I as Q,L as Ce,da as ze,aP as De,a$ as ke,bq as je,f8 as Ne,f9 as Se,W as Pe}from"./index-9Ko_9_TI.js";import{u as Te}from"./usePageData-BWaYhHgw.js";import{_ as $e,a as Me}from"./text-DaVxhp6G.js";import{N as Be}from"./Popconfirm-Cg-J5jDB.js";const Ie={class:"mt-10px"},We=Y({name:"OperateDrawer",__name:"operate-drawer",props:G({operateType:{},rowData:{},pid:{},pname:{},showtype:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:G(["submitted"],["update:visible"]),setup(k,{emit:A}){Z();const n=A,b=re("pname"),c=k,e=ee(M());function M(){return{id:"",content1:"",content2:"",content3:"",content4:"",content5:"",pid:null,charctras:0}}const w={pid:{type:"number",required:!0,message:"请选择项目",trigger:"blur"},content1:{required:!0,message:"请输入前期准备阶段描述",trigger:"blur"},content2:{required:!0,message:"请输入遇到问题及对项目的影响",trigger:"blur"},content3:{required:!0,message:"请输入经验教训与改进方案或措施",trigger:"blur"}},{pageData:v,getData:h,nextPage:j}=Te(fe),N=async l=>{const r=l.currentTarget,_=r.scrollTop;r.scrollTop+r.offsetHeight>=r.scrollHeight&&v.data.length<v.total&&(await j(),await ve(),setTimeout(()=>{r.scrollTop=_}))},B=async l=>{m.value=!0,l?e.pid=l:e.value.pid=null},K=async()=>{var l;if(await h({fuzzy:c.pname?c.pname:b!=null&&b.value?b==null?void 0:b.value:"",page:1}),v.data.length==0)return(l=window.$message)==null?void 0:l.warning("没有项目")},d=te.debounce(async l=>{await h({fuzzy:l,page:1})},300),o=$(!1),m=$(!1),y=l=>{if(e.pid=null,o.value=!0,m.value=!1,!l){L();return}d(l)},I=async()=>{o.value&&!m.value&&(await h({page:1}),o.value=!1)},L=()=>{h({page:1})};async function O(){Object.assign(e,M()),await K(),c.pid&&(v.data.forEach(l=>{l.id==c.pid&&(l.disabled=!0)}),e.pid=c.pid),c.operateType==="edit"&&c.rowData&&Object.assign(e,c.rowData)}const{formRef:R,validate:U,restoreValidation:f}=ie(),W=ce(()=>({add:"新增项目总结",edit:"修改项目总结"})[c.operateType]),S=ae(k,"visible"),H=()=>{S.value=!1},F=$(!1),se=async()=>{var l,r,_;if(!F.value)try{if(await U(),F.value=!0,e.charctras<30)return(l=window.$message)==null?void 0:l.warning("字数不能少于30字,请继续填写");if(c.operateType==="edit"){const{data:P,error:T}=await _e([{...e}]);T||((r=window.$message)==null||r.success("修改成功"),n("submitted"),H())}else{const{data:P,error:T}=await ge([{pid:e.pid,content1:e.content1,content2:e.content2,content3:e.content3,content4:e.content4,content5:e.content5,charctras:e.charctras}]);T||((_=window.$message)==null||_.success("添加成功"),n("submitted"),H())}}catch(P){console.error("Error saving project summary:",P)}finally{F.value=!1}};return J(S,()=>{S.value&&(O(),setTimeout(()=>{const l=document.querySelector(".n-scrollbar-content");l==null||l.scrollTo(0,0)},300),f())}),J(()=>[e.content1,e.content2,e.content3,e.content4,e.content5],()=>{e.charctras=de(e.content1+e.content2+e.content3+e.content4+e.content5)},{immediate:!0}),(l,r)=>{const _=oe,P=ne,T=pe,le=me;return g(),z(le,{show:S.value,"onUpdate:show":r[6]||(r[6]=p=>S.value=p),title:W.value,preset:"card",class:"w-570px","mask-closable":!1,draggable:!0},{footer:a(()=>[s(T,{justify:"end"},{default:a(()=>[s(t(V),{size:"small",class:"mt-16px",onClick:H},{default:a(()=>[D(u(t(X)("common.cancel")),1)]),_:1}),s(t(V),{type:"primary",size:"small",class:"mt-16px",loading:F.value,onClick:se},{default:a(()=>[D(u(t(X)("common.confirm")),1)]),_:1},8,["loading"])]),_:1})]),default:a(()=>[s(P,{ref_key:"formRef",ref:R,model:e,rules:w},{default:a(()=>[c.operateType==="add"&&c.showtype!=="detail"?(g(),z(_,{key:0,label:"项目",path:"pid","label-placement":"left"},{default:a(()=>[s(t(ue),{clearable:"",filterable:"",value:e.pid,"onUpdate:value":[r[0]||(r[0]=p=>e.pid=p),B],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:L,onSearch:y,onBlur:I,options:t(v).data,onScroll:N},null,8,["value","options"])]),_:1})):E("",!0),s(_,{label:"前期准备阶段描述",path:"content1"},{default:a(()=>[s(t(C),{clearable:"",type:"textarea",value:e.content1,"onUpdate:value":r[1]||(r[1]=p=>e.content1=p),placeholder:"请输入前期准备阶段描述"},null,8,["value"])]),_:1}),s(_,{label:"遇到问题及对项目的影响",path:"content2"},{default:a(()=>[s(t(C),{clearable:"",type:"textarea",value:e.content2,"onUpdate:value":r[2]||(r[2]=p=>e.content2=p),placeholder:"请输入遇到问题及对项目的影响"},null,8,["value"])]),_:1}),s(_,{label:"经验教训与改进方案或措施",path:"content3"},{default:a(()=>[s(t(C),{clearable:"",type:"textarea",value:e.content3,"onUpdate:value":r[3]||(r[3]=p=>e.content3=p),placeholder:"请输入经验教训与改进方案或措施"},null,8,["value"])]),_:1}),s(_,{label:"项目完工确认描述(对于进度延期需具体说明原因及改进措施)",path:"content4"},{default:a(()=>[s(t(C),{clearable:"",type:"textarea",value:e.content4,"onUpdate:value":r[4]||(r[4]=p=>e.content4=p),placeholder:"项目完工确认描述(对于进度延期需具体说明原因及改进措施)"},null,8,["value"])]),_:1}),s(_,{label:"此次项目对你帮助最大的人，具体描述一下对你的帮助",path:"content5"},{default:a(()=>[s(t(C),{clearable:"",type:"textarea",value:e.content5,"onUpdate:value":r[5]||(r[5]=p=>e.content5=p),placeholder:"请输入此次项目对你帮助最大的人，具体描述一下对你的帮助"},null,8,["value"])]),_:1}),i("div",Ie,"字数："+u(e.charctras),1)]),_:1},8,["model"])]),_:1},8,["show","title"])}}}),Le={class:"font-size-12px c-#a19f9d my-5px"},Ue={key:0},Fe={class:"mt-4 border-t pt-3"},qe={class:"flex items-start gap-2 mb-3"},Ee={class:"ml-2 flex-1"},Ve={class:"flex items-center"},Ae={class:"font-medium font-size-16px font-bold"},Ke={class:"text-gray-600 mt-1"},Oe=Y({name:"drawerLog",__name:"drawerLog",props:G({rowData:{},showtype:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:["update:visible"],setup(k){const A=Z();be();let n=ee({id:"",content1:"",content2:"",content3:"",content4:"",content5:"",username:"",contractname:"",charctras:0,num:0});const b=k,c={id:99,name:"张三",avatar:"https://cdn-icons-png.flaticon.com/128/3135/3135715.png"},e=$({});async function M(){w.value=[],Object.assign(n,b.rowData),N()}const w=$([]),v=ae(k,"visible");J(v,()=>{v.value?M():(w.value=[],n.id=void 0)});function h(d){d||j()}function j(){v.value=!1}const N=async()=>{const{data:d,error:o}=await Ne({page:1,limit:100,pid:n.id});d&&(w.value=d.list)},B=te.debounce(async()=>{var y;const d=e.value[n.id];if(!(d!=null&&d.trim()))return(y=window.$message)==null?void 0:y.warning("请输入评论内容");const{data:o,error:m}=await ye([{pid:n.id,content:d}]);o&&(e.value[n.id]="",n.num++,N())},1e3,{leading:!0,trailing:!1}),K=async d=>{var y;const{data:o,error:m}=await Se(d.id);o&&(N(),n.num--,(y=window.$message)==null||y.success("删除成功"))};return(d,o)=>{const m=oe,y=ne,I=$e,L=Me,O=he,R=je,U=we("no-auth");return g(),z(R,{show:v.value,"onUpdate:show":[o[1]||(o[1]=f=>v.value=f),h],"display-directive":"show",width:600,onMaskClick:j,onEsc:j},{default:a(()=>[s(O,{title:t(n).username+"的项目总结","native-scrollbar":!1,closable:""},{default:a(()=>[s(y,{ref:"formRef",model:t(n),"show-feedback":!1},{default:a(()=>[b.showtype!=="detail"?(g(),z(m,{key:0,label:"",path:"contractname"},{label:a(()=>o[2]||(o[2]=[i("div",{class:"font-size-16px font-bold"},"项目名称",-1)])),default:a(()=>[i("span",{class:x(["preview-text",{textstyle:t(n).proname}])},u(t(n).proname),3)]),_:1})):E("",!0),s(m,{label:"前期准备阶段描述",path:"content1"},{label:a(()=>o[3]||(o[3]=[i("div",{class:"font-size-16px font-bold"},"前期准备阶段描述",-1)])),default:a(()=>[i("span",{class:x(["preview-text",{textstyle:t(n).content1}])},u(t(n).content1),3)]),_:1}),s(m,{label:"遇到问题及对项目的影响",path:"content2"},{label:a(()=>o[4]||(o[4]=[i("div",{class:"font-size-16px font-bold"},"遇到问题及对项目的影响",-1)])),default:a(()=>[i("span",{class:x(["preview-text",{textstyle:t(n).content2}])},u(t(n).content2),3)]),_:1}),s(m,{label:"经验教训与改进方案或措施",path:"content3"},{label:a(()=>o[5]||(o[5]=[i("div",{class:"font-size-16px font-bold"},"经验教训与改进方案或措施",-1)])),default:a(()=>[i("span",{class:x(["preview-text",{textstyle:t(n).content3}])},u(t(n).content3),3)]),_:1}),s(m,{label:"项目完工确认描述(对于进度延期需具体说明原因及改进措施)",path:"content4"},{label:a(()=>o[6]||(o[6]=[i("div",{class:"font-size-16px font-bold"},"项目完工确认描述(对于进度延期需具体说明原因及改进措施)",-1)])),default:a(()=>[i("span",{class:x(["preview-text",{textstyle:t(n).content4}])},u(t(n).content4),3)]),_:1}),s(m,{label:"此次项目对你帮助最大的人，具体描述一下对你的帮助",path:"content5"},{label:a(()=>o[7]||(o[7]=[i("div",{class:"font-size-16px font-bold"},"此次项目对你帮助最大的人，具体描述一下对你的帮助",-1)])),default:a(()=>[i("span",{class:x(["preview-text",{textstyle:t(n).content5}])},u(t(n).content5),3)]),_:1}),i("div",Le,"字符数："+u(t(n).charctras),1)]),_:1},8,["model"]),t(n).num?(g(),q("div",Ue,u(t(n).num)+"评论",1)):E("",!0),s(xe,{name:"fade"},{default:a(()=>[i("div",Fe,[Q((g(),q("div",qe,[i("div",null,[s(I,{size:"small",src:c.avatar},null,8,["src"])]),s(t(C),{type:"textarea",id:`comment-input-${t(n).id}`,value:e.value[t(n).id],"onUpdate:value":o[0]||(o[0]=f=>e.value[t(n).id]=f),placeholder:"善语结善缘，恶语伤人心...",autosize:"",onKeydown:Ce(ze(t(B),["exact","prevent"]),["enter"])},null,8,["id","value","onKeydown"]),s(t(V),{type:"primary",ghost:"",onClick:t(B)},{default:a(()=>o[8]||(o[8]=[D("发送")])),_:1,__:[8]},8,["onClick"])])),[[U,"project:Summary:Comment:insert"]]),(g(!0),q(De,null,ke(w.value,f=>(g(),q("div",{key:f.id,class:"flex mb-3"},[s(I,{size:"small",src:c.avatar},null,8,["src"]),i("div",Ee,[i("div",Ve,[i("span",Ae,u(f.username),1),s(L,{depth:"3",style:{"font-size":"12px","margin-left":"20px"}},{default:a(()=>[D(u(f.dbtime),1)]),_:2},1024),t(A).userInfo.id==f.creater?(g(),z(t(Be),{key:0,onPositiveClick:W=>K(f)},{trigger:a(()=>[Q((g(),z(t(V),{quaternary:"",type:"error",size:"small"},{default:a(()=>o[9]||(o[9]=[D(" 删除 ")])),_:1,__:[9]})),[[U,"project:Summary:Comment:delete"]])]),default:a(()=>[o[10]||(o[10]=D(" 确定删除吗？ "))]),_:2,__:[10]},1032,["onPositiveClick"])):E("",!0)]),i("div",Ke,u(f.content),1)])]))),128))])]),_:1})]),_:1},8,["title"])]),_:1},8,["show"])}}}),Xe=Pe(Oe,[["__scopeId","data-v-9dd3e715"]]);export{We as _,Xe as d};
