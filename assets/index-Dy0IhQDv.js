import{_ as da,a as ca,V as Ma,b as Ia,c as Oa,d as qa,e as Ra,f as Ha,g as Ja}from"./index-CBUjBoEq.js";import{_ as pa}from"./round-plus-5BsdOVlT.js";import{aY as pe,R as fa,b as q,o as T,e as I,d as _t,z as kt,s as h,F as yt,aP as nt,c as ke,G as W,f as s,I as st,t as se,w as p,g as j,h as S,B as z,ax as ot,a4 as xt,M as ga,N as zt,H as re,aA as Ot,J as Ve,az as ht,$ as ae,aN as Ga,n as a,aG as Qe,dm as Ka,W as va,av as vt,A as Gt,a as Kt,at as Wt,au as Yt,ay as Ee,K as ia,a5 as gt,aT as Ge,cz as ma,aU as ya,aE as et,bh as ha,cZ as ba,cQ as _a,fe as ka,cC as Wa,aK as sa,i as xa,d4 as Ya,dq as Xa,D as dt,bq as Za,S as Qa,ff as el,aJ as tl,X as al,Y as ll,dy as nl,d0 as il,cE as oa,dB as sl,da as Ut,a2 as ol,b0 as ra,b4 as rl,aM as ul,a7 as qt,dD as dl,a3 as cl}from"./index-DCPTYPg6.js";import{u as Ke}from"./usePageData-BUYwLNSk.js";import{h as Ze}from"./permission-dOyevU_s.js";import{N as ct}from"./Popconfirm-BQoV-jsN.js";import{_ as bt}from"./DatePicker-BbdERBWx.js";import{N as Rt}from"./Cascader-B6wrRyBj.js";import{_ as pl,a as fl,A as gl}from"./index-BBwUXFe4.js";import{g as vl}from"./business-lhu-rMxc.js";import{_ as ml}from"./Grid-p0WIMYG_.js";import{_ as yl}from"./FormItemGridItem-C8JcVRRJ.js";function Wn(w){return pe({url:"/projectForm/getPage.do",method:"get",params:w})}function hl(w){return pe({url:"/projectForm/insert.do",method:"post",data:w})}function bl(w){return pe({url:"/projectForm/update.do",method:"put",data:w})}function Yn(w){return pe({url:"/projectForm/delete.do",method:"delete",params:{arrIds:w}})}function _l(w){return pe({url:"/projectForm/getById.do",method:"get",params:{id:w}})}function kl(w){return pe({url:"/projectForm/getIdByProId.do",method:"get",params:{proId:w}})}function xl(w){return pe({url:"/projectForm/getProjectPage.do",method:"get",params:w})}function Ht(w){return pe({url:"/projectFormContact/getPage.do",method:"get",params:w})}function Ll(w){return pe({url:"/projectFormContact/insert.do",method:"post",data:w})}function Sl(w){return pe({url:"/projectFormContact/update.do",method:"put",data:w})}function Dl(w){return pe({url:"/projectFormContact/delete.do",method:"delete",params:{arrIds:w}})}function Jt(w){return pe({url:"/projectFormEquipment/getPage.do",method:"get",params:w})}function La(w){return pe({url:"/projectFormEquipment/insert.do",method:"post",data:w})}function Cl(w){return pe({url:"/projectFormEquipment/update.do",method:"put",data:w})}function wl(w){return console.log(w),pe({url:"/projectFormEquipment/delete.do",method:"delete",params:{arrIds:w}})}function Fl(w){return pe({url:"/projectFormDebug/getPage.do",method:"get",params:w})}function Sa(w){return pe({url:"/projectFormDebug/insert.do",method:"post",data:w})}function $l(w){return pe({url:"/projectFormDebug/update.do",method:"put",data:w})}function Tl(w){return pe({url:"/projectFormDebug/delete.do",method:"delete",params:{arrIds:w}})}function Ul(w){return pe({url:"/projectFormFile/getPage.do",method:"get",params:w})}function zl(w){return pe({url:"/projectFormFile/insert.do",method:"post",data:w})}function jl(w){return pe({url:"/projectFormFile/update.do",method:"put",data:w})}function Pl(w){return pe({url:"/projectFormFile/delete.do",method:"delete",params:{arrIds:w}})}const Bl={class:"inline-block",viewBox:"0 0 24 24",width:"1em",height:"1em"};function Nl(w,Ue){return T(),q("svg",Bl,Ue[0]||(Ue[0]=[I("path",{fill:"currentColor",d:"M21 7v14H3V3h14zm-2 .85L16.15 5H5v14h14zM12 18q1.25 0 2.125-.875T15 15t-.875-2.125T12 12t-2.125.875T9 15t.875 2.125T12 18m-6-8h9V6H6zM5 7.85V19V5z"},null,-1)]))}const El=fa({name:"material-symbols-save-outline-sharp",render:Nl}),Vl={class:"inline-block",viewBox:"0 0 14 14",width:"1em",height:"1em"};function Al(w,Ue){return T(),q("svg",Vl,Ue[0]||(Ue[0]=[I("path",{fill:"currentColor","fill-rule":"evenodd",d:"M6.545.998a1 1 0 0 0 0 2h2.728a2.638 2.638 0 0 1 0 5.275H4.817V6.545a1 1 0 0 0-1.707-.707L.384 8.564a1 1 0 0 0-.22 1.09q.073.18.218.327l2.728 2.728a1 1 0 0 0 1.707-.707v-1.729h4.456a4.638 4.638 0 1 0 0-9.275z","clip-rule":"evenodd"},null,-1)]))}const Ml=fa({name:"streamline-return2-solid",render:Al}),Il={class:"flex items-center justify-between"},Ol={class:"flex items-center"},ql={style:{margin:"10px 0","font-weight":"bolder",width:"140px"}},Rl={key:0,class:"font-size-12px c-#ffa502 ml-10px"},Hl={key:0},Jl={style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},Gl={key:0},Kl={style:{display:"flex","justify-content":"space-between"}},Wl={key:3},Yl=["src"],Xl=_t({__name:"fileList",props:{pid:{},data:{},fileType:{},typename:{},operateType:{}},emits:["getData","myClick","submittedData","removeData"],setup(w,{emit:Ue}){const le=w,Y=kt(),Ce=Ue,y=[{title:"文件别名",key:"name",align:"center",width:200,ellipsis:{tooltip:!0}},{title:"文件名称",key:"filename",align:"center",width:200,ellipsis:{tooltip:!0}},{title:"上传人",key:"creator",align:"center",width:100},{title:"上传时间",key:"dbtime",align:"center",width:200},{title:"操作",key:"actions",align:"center",width:180,render(r,c){return a(Ve,{justify:"center"},[r.id&&a(z,{type:"info",size:"small",ghost:!0,onClick:()=>{tt(r)}},{default:()=>"查看"}),r.id&&a(z,{type:"info",size:"small",ghost:!0,onClick:()=>{He(r)}},{default:()=>"下载"}),r.id&&Ze("project:form:File:update")&&a(z,{type:"info",size:"small",ghost:!0,onClick:()=>{A(r)}},{default:()=>"编辑"}),Ze("project:form:File:delete")&&Y.userInfo.usertype==0&&a(ct,{onPositiveClick:async()=>{var f;if(r.id){const{data:C,error:l}=await Ka(r.url),{data:u,error:g}=await Pl(r.id);g||((f=window.$message)==null||f.success("删除成功"),Ce("getData"))}else Ce("removeData",{index:c,fileType:le.fileType})}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})])}}];async function Fe(r){var c;return r.file.file.size>100*1024*1024?((c=window.$message)==null||c.error("文件大小不能超过100M"),!1):!0}const X=h(!1),N=h(null),te=h({fileName:"",file:null,id:void 0}),Oe={fileName:[{required:!0,message:"请输入文件别名",trigger:["blur","change"]}]},v=h(0),We=()=>{Ce("myClick"),R.value=[],X.value=!0,v.value=0,te.value.id=void 0,te.value.fileName="",te.value.file=null},qe=async()=>{var r,c,f,C;try{if(await((r=N.value)==null?void 0:r.validate()),te.value.id){const{data:l,error:u}=await jl([{id:te.value.id,filename:te.value.fileName}]);if(u)return(c=window.$message)==null?void 0:c.error("保存文件记录失败");(f=window.$message)==null||f.destroyAll(),(C=window.$message)==null||C.success("编辑成功"),Ce("getData"),xe.value=!1;return}}catch{xe.value=!1}};async function He(r){if(r!=null&&r.url)try{const f=await(await fetch(r.url,{mode:"cors"})).blob(),C=URL.createObjectURL(f),l=document.createElement("a");l.href=C,l.download=r.filename,l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(C)}catch(c){console.error("下载失败:",c)}}const Je=()=>{console.log("渲染完成")},he=r=>{console.log(r,"渲染失败")},d=h(!1),ue=h(""),Z=h([]),G=h(""),Ae=h("预览文件"),be=h(!1),$e=h(0),tt=r=>{var f,C;if(!(r!=null&&r.url))return;const c=(f=r.filename.split(".").pop())==null?void 0:f.toLowerCase();if(ue.value=r.url,Ae.value=r.filename,["xls","xlsx"].includes(c))G.value="xls";else if(["doc","docx"].includes(c))G.value="doc";else if(["pdf"].includes(c))G.value="pdf";else if(["png","jpg","jpeg","gif","bmp"].includes(c)){G.value="img",Z.value=le.data.map(u=>{var g;return["png","jpg","jpeg","gif","bmp"].includes((g=u.filename.split(".").pop())==null?void 0:g.toLowerCase())?u.url:""}).filter(u=>u!=="");const l=Z.value.findIndex(u=>u===r.url);$e.value=l,be.value=!0;return}else if(["mp4"].includes(c))G.value="mp4";else{(C=window.$message)==null||C.warning("暂不支持该文件类型预览");return}d.value=!0},Te=h(45),we=()=>{Te.value==45?Te.value=350:Te.value=45},xe=h(!1);function A(r){te.value.id=r.id,te.value.fileName=r.name,xe.value=!0}const ze=()=>{xe.value=!1};function Me(r){return r.replace(/\.[^/.]+$/,"")}const ye=[{title:"文件名称",key:"filename",align:"center",render(r){if(!r.name){const c=async({file:C,onFinish:l,onError:u})=>{var g,F;try{r.status=!0;const D=await Qe(C.file,C.name,"",U=>{r.progress=U});D&&(r.url=D,r.name=C.name,r.status=!1)}catch(D){console.error(D),(F=(g=window.$message)==null?void 0:g.error)==null||F.call(g,"文件上传出错"),r.status=!1}};async function f(C){var l;return C.file.file.size>100*1024*1024?((l=window.$message)==null||l.error("文件大小不能超过100M"),!1):!0}return a("div",{style:"display: flex; justify-content: center; align-items: center;"},[a(ht,{action:"#",showFileList:!1,customRequest:c,onBeforeUpload:f},{default:()=>a(z,{type:"info",size:"small",ghost:!0,loading:r.status},{default:()=>"上传文件"})}),r.progress?a(Ot,{type:"line",percentage:r.progress,indicatorPlacement:"inside",processing:!0}):null])}return a("div",{},r.name)}},{title:"文件别名",key:"filename",align:"center",render(r){return a(re,{value:r.filename??Me(r.name)??"",onUpdateValue:c=>{r.filename=c}})}},{title:"操作",key:"actions",align:"center",width:100,render(r){return a(Ve,{justify:"center"},[a(z,{type:"error",size:"small",ghost:!0,onClick:()=>{R.value=R.value.filter(c=>c!==r)}},{default:()=>"删除"})])}}],R=h([]),me=h(0),Pe=h(!1),n=async()=>{var r,c,f,C,l,u,g,F;for(let D=0;D<R.value.length;D++){const U=R.value[D];if(!U.name||U.name.toString().trim()===""){(r=window.$message)==null||r.warning(`第 ${D+1} 个文件的文件名称不能为空`);return}if(!U.filename||U.filename.toString().trim()===""){(c=window.$message)==null||c.warning(`第 ${D+1} 个文件的文件别名不能为空`);return}}try{if(Pe.value=!0,le.operateType==="edit"){const D=R.value.length;for(let V=0;V<D;V++){me.value=V;const H=R.value[V];H.indexText=`${V+1}/${D}`,H.progress=0,H.status="uploading";try{H.url=await Qe(H.file,H.name,"",fe=>{H.progress=fe}),H.progress=100,H.status="done"}catch{H.status="error",(C=(f=window.$message)==null?void 0:f.error)==null||C.call(f,`第 ${V+1} 个文件上传失败，请重试`);return}}const U=R.value.map(V=>({file:V.url,filename:V.filename,pid:le.pid,sort:le.fileType})),{error:x}=await zl(U);if(x){(u=(l=window.$message)==null?void 0:l.error)==null||u.call(l,"保存文件记录失败");return}Ce("getData"),(g=window.$message)==null||g.destroyAll(),(F=window.$message)==null||F.success("上传成功"),X.value=!1}else{const D=R.value.map(U=>({file:U.file,filename:U.name,name:U.filename,sort:le.fileType}));Ce("submittedData",{row:D,fileType:le.fileType}),X.value=!1}}finally{Pe.value=!1}},m=()=>{X.value=!1};function _(r){r.fileList.forEach(c=>{c.filename||(c.filename=Me(c.name))}),R.value=r.fileList}return(r,c)=>{const f=pa,C=da,l=ca,u=zt,g=ga,F=xt,D=Ga,U=yt("no-auth");return T(),q(nt,null,[I("div",Il,[I("div",Ol,[I("h2",ql,se(le.typename),1),st((T(),ke(S(z),{size:"small",ghost:"",type:"primary",onClick:We},{icon:p(()=>[s(f,{class:"text-icon"})]),default:p(()=>[j(" 新增"+se(le.typename),1)]),_:1})),[[U,"project:form:File:insert"]]),le.fileType==4?(T(),q("span",Rl,"照片数不少于6张")):W("",!0)]),le.data.length>0?(T(),q("div",Hl,"共"+se(le.data.length)+"条",1)):W("",!0)]),le.data.length>0?(T(),ke(S(ot),{key:0,columns:y,data:le.data,size:"small","scroll-x":702,"row-key":x=>x.id,"max-height":Te.value},null,8,["data","row-key","max-height"])):W("",!0),I("div",Jl,[Te.value==45&&le.data.length>1?(T(),q("span",{key:0,onClick:we},[c[7]||(c[7]=j(" 更多 ")),s(C,{class:"font-size-20px"})])):W("",!0),Te.value==350&&le.data.length>1?(T(),q("span",{key:1,onClick:we},[c[8]||(c[8]=j(" 收起 ")),s(l,{class:"font-size-20px"})])):W("",!0)]),s(F,{show:xe.value,"onUpdate:show":c[1]||(c[1]=x=>xe.value=x),title:(te.value.id?"编辑":"新增")+le.typename,preset:"card",class:"w-700px"},{default:p(()=>[s(g,{ref_key:"formRef",ref:N,model:te.value,rules:Oe,"label-width":"auto",style:{width:"100%"}},{default:p(()=>[s(u,{label:"文件别名",path:"fileName"},{default:p(()=>[s(S(re),{value:te.value.fileName,"onUpdate:value":c[0]||(c[0]=x=>te.value.fileName=x),placeholder:"请输入"},null,8,["value"])]),_:1}),v.value?(T(),ke(S(Ot),{key:0,type:"line",percentage:v.value,color:v.value==100?"#18a058":"#2080f0","indicator-placement":"inside",processing:""},null,8,["percentage","color"])):W("",!0),s(u,null,{default:p(()=>[s(S(Ve),{justify:"center",style:{width:"100%"}},{default:p(()=>[s(S(z),{type:"primary",onClick:qe},{default:p(()=>c[9]||(c[9]=[j(se("确认"))])),_:1,__:[9]}),s(S(z),{onClick:ze},{default:p(()=>c[10]||(c[10]=[j("取消")])),_:1,__:[10]})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),s(F,{show:X.value,"onUpdate:show":c[3]||(c[3]=x=>X.value=x),title:(te.value.id?"编辑":"新增")+le.typename,preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{footer:p(()=>[s(S(Ve),{justify:"end"},{default:p(()=>[s(S(z),{size:"small",class:"mt-16px",onClick:m},{default:p(()=>[j(se(S(ae)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",size:"small",class:"mt-16px",onClick:n},{default:p(()=>[j(se(S(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(S(ht),{ref:"uploadRef",action:void 0,class:"mb-10px","file-list":R.value,"onUpdate:fileList":c[2]||(c[2]=x=>R.value=x),"auto-upload":!1,onBeforeUpload:Fe,multiple:!0,onChange:_,"show-file-list":!1},{default:p(()=>[s(S(z),{size:"small",ghost:"",type:"primary"},{default:p(()=>c[11]||(c[11]=[j("选择文件")])),_:1,__:[11]})]),_:1},8,["file-list"]),s(S(ot),{columns:ye,"paginate-single-page":!1,data:R.value,"max-height":350},null,8,["data"]),R.value[me.value]&&Pe.value?(T(),q("div",Gl,[I("div",Kl,[I("span",null,se(R.value[me.value].filename||R.value[me.value].name),1),I("span",null,se(R.value[me.value].indexText),1)]),s(S(Ot),{percentage:R.value[me.value].progress,status:R.value[me.value].status==="error"?"error":"success","show-indicator":""},null,8,["percentage","status"])])):W("",!0)]),_:1},8,["show","title"]),s(F,{show:d.value,"onUpdate:show":c[4]||(c[4]=x=>d.value=x),title:Ae.value,preset:"card",style:{width:"80%"}},{default:p(()=>[G.value.includes("xls")?(T(),ke(S(Ma),{key:0,options:{xls:!0,minColLength:0,minRowLength:0,widthOffset:20,heightOffset:5},src:ue.value,style:{height:"80vh"},onRendered:Je,onError:he},null,8,["src"])):W("",!0),G.value.includes("doc")?(T(),ke(S(Ia),{key:1,src:ue.value,style:{height:"80vh"},onRendered:Je,onError:he},null,8,["src"])):W("",!0),G.value.includes("pdf")?(T(),ke(S(Oa),{key:2,src:ue.value,style:{height:"80vh"},onRendered:Je,onError:he},null,8,["src"])):W("",!0),G.value.includes("mp4")?(T(),q("div",Wl,[I("video",{src:ue.value,controls:"",style:{width:"100%",height:"80vh"}},null,8,Yl)])):W("",!0)]),_:1},8,["show","title"]),s(D,{show:be.value,"onUpdate:show":c[5]||(c[5]=x=>be.value=x),"src-list":Z.value,current:$e.value,"onUpdate:current":c[6]||(c[6]=x=>$e.value=x)},null,8,["show","src-list","current"])],64)}}}),ua=va(Xl,[["__scopeId","data-v-107f314e"]]),Zl=_t({name:"businessModal",__name:"businessModal",props:vt({pid:{},operateType:{},debuggedDevieceList:{},contactList:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:vt(["submitted","submittedData"],["update:visible"]),setup(w,{emit:Ue}){const le=Ue;kt();const Y=w;async function Ce(){N(),Je(),Z(),Te(),A.value=[],xe.value=!0,we.value=!0,ye.value=[]}Gt();const y=Kt(()=>"新增待调试业务"),Fe=Wt(w,"visible");Yt(Fe,()=>{Fe.value&&Ce()});const{pageData:X,getData:N,nextPage:te}=Ke(ma),Oe=async l=>{const u=l.currentTarget;u.scrollTop+u.offsetHeight>=u.scrollHeight&&X.data.length<X.total&&te()},{pageData:v,getData:We,nextPage:qe}=Ke(Ht),He=async l=>{const u=l.currentTarget;u.scrollTop+u.offsetHeight>=u.scrollHeight&&v.data.length<v.total&&(qe(),v.data=v.data.map(g=>({...g,value:g.docker+"&id="+g.id})))},Je=async()=>{await We({pid:Y.pid}),v.data=v.data.map(l=>({...l,value:l.docker+"&id="+l.id}))},{pageData:he,getData:d,nextPage:ue}=Ke(ya),Z=async()=>{await d({usertypes:"2,3"})},G=async l=>{const u=l.currentTarget;u.scrollTop+u.offsetHeight>=u.scrollHeight&&he.data.length<he.total&&ue()},{pageData:Ae,getData:be,nextPage:$e}=Ke(Jt),tt=async l=>{const u=l.currentTarget,g=u.scrollTop;u.scrollTop+u.offsetHeight>=u.scrollHeight&&X.data.length<X.total&&(await $e(),await et(),setTimeout(()=>{u.scrollTop=g}))},Te=async()=>{Y.pid&&await be({pid:Y.pid})},we=h(!0),xe=h(!0),A=h([]),ze=[{title:"权重",key:"dtype",width:180,align:"center",render(l,u){return l.setStatus?a(Ee,{value:l.dtype,filterable:!0,placeholder:"请选择权重",options:X.data,labelField:"tname",valueField:"id",onUpdateValue(g){var F;A.value[u].dtype=Number(g)||0,A.value[u].debugname=((F=X.data.find(D=>D.id==g))==null?void 0:F.tname)||""},onScroll(g){Oe(g)}}):a("div",{},l.tname)}},{title:"业务名称",key:"debugname",width:180,align:"center",render(l,u){return l.setStatus?a(re,{value:l.debugname,placeholder:"请输入业务名称",onUpdateValue(g){A.value[u].debugname=g}}):a("div",{},l.debugname)}},{key:"eqmname",title:"调试设备",align:"center",width:150,render(l,u){return a(Ee,{value:l.eqmid,placeholder:"请选择调试设备",options:Y.operateType=="edit"?Ae.data:Y.debuggedDevieceList,onscroll:tt,labelField:"devname",valueField:Y.operateType=="edit"?"id":"eqmid",clearable:!0,filterable:!0,onUpdateValue(g){A.value[u].eqmid=g}})}},{key:"dbcreater",width:140,align:"center",title:()=>a("div",{style:"display:flex;align-items:center;justify-content:center;gap:6px;"},[a("span",null,"调试人"),a(ia,{size:"small",checked:xe.value,label:"联动",style:"margin-left: 10px;font-size: 12px;",onUpdateChecked:l=>{xe.value=l}})]),render(l,u){return l.setStatus?a(Ee,{value:l.dbcreater,filterable:!0,placeholder:"请选择调试人",options:he.data,labelField:"username",valueField:"id",onUpdateValue(g){xe.value?A.value.forEach((F,D)=>{F.dbcreater=g||0}):A.value[u].dbcreater=g||0},onScroll(g){G(g)}}):a("div",{},l.dbusername)}},{key:"docker",width:140,align:"center",title:()=>a("div",{style:"display:flex;align-items:center;justify-content:center;gap:6px;"},[a("span",null,"对接方"),a(ia,{size:"small",checked:we.value,label:"联动",style:"margin-left: 10px;font-size: 12px;",onUpdateChecked:l=>{we.value=l}})]),render(l,u){var g;return l.setStatus?a(Ee,{value:l.docker,placeholder:"请输入或选择对接方",options:Y.operateType=="edit"?v.data:Y.contactList,onscroll:He,labelField:"docker",valueField:Y.operateType=="edit"?"value":"docker",clearable:!0,filterable:!0,tag:!0,onClear(){l.dockcharge="",l.dockcontact=""},onUpdateValue(F){var D;if(we.value)A.value.forEach((U,x)=>{var H;U.docker=F;let V={};if(Y.operateType=="edit"){const[fe,oe]=(H=l.docker)==null?void 0:H.split("&id=");V=v.data.find(ne=>ne.docker===fe&&ne.id===Number(oe))}else V=Y.contactList.find(fe=>fe.docker==U.docker);console.log(Y.contactList,U.docker,"sss"),V?(U.dockcharge=V.pname,U.dockcontact=V.pcontact):(U.dockcharge="",U.dockcontact="")});else{A.value[u].docker=F;let U={};if(Y.operateType=="edit"){const[x,V]=(D=l.docker)==null?void 0:D.split("&id=");U=v.data.find(H=>H.docker===x&&H.id===Number(V))}else U=Y.contactList.find(x=>x.docker==F);U?(l.dockcharge=U.pname,l.dockcontact=U.pcontact):(l.dockcharge="",l.dockcontact="")}}}):a("div",{},(g=l.docker)==null?void 0:g.split("&id=")[0])}},{title:"对接方负责人",key:"dockcharge",width:100,align:"center",render(l,u){return l.setStatus?a(re,{value:l.dockcharge,placeholder:"请输入对接方负责人",onUpdateValue(g){A.value[u].dockcharge=g}}):a("div",{},l.dockcharge)}},{title:"联系方式",key:"dockcontact",width:120,align:"center",render(l,u){return l.setStatus?a(re,{value:l.dockcontact,placeholder:"请输入联系方式",onUpdateValue(g){A.value[u].dockcontact=g}}):a("div",{},l.dockcontact)}},{title:"文件",key:"re1",width:100,align:"center",render(l,u){return l.setStatus?a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>_(l,u)},{default:()=>"上传文件"}):a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const g=[{alias:l.re1,file:l.fl1},{alias:l.re2,file:l.fl2},{alias:l.re3,file:l.fl3},{alias:l.re4,file:l.fl4}].filter(F=>F.alias||F.file);return g.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件")])]),a("tbody",g.map(F=>{var D;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},F.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((D=F.file)==null?void 0:D.split("?")[1])||"-")])}))])])}})}},{title:"备注",key:"notes",width:200,align:"center",render(l,u){return l.setStatus?a(re,{value:l.notes,placeholder:"请输入备注",onUpdateValue(g){A.value[u].notes=g}}):a("div",{},l.notes)}},{title:"计划开始时间",key:"starttime",width:200,align:"center",render(l,u){return l.setStatus?a(bt,{type:"date",clearable:!0,value:l.starttime,valueFormat:"yyyy-MM-dd",placeholder:"请选择",onUpdateValue(g){A.value[u].starttime=g}}):a("div",Ge(0,l.starttime))}},{title:"计划结束时间",key:"endtime",width:200,align:"center",render:(l,u)=>l.setStatus?a(bt,{type:"date",clearable:!0,valueFormat:"yyyy-MM-dd",value:l.endtime,placeholder:"请选择",onUpdateValue(g){A.value[u].endtime=g}}):Ge(0,l.endtime)},{key:"operate",title:ae("common.operate"),align:"center",width:120,fixed:"right",render(l,u){return a("div",{class:"flex-center gap-8px"},[a(ct,{onPositiveClick:()=>{A.value.splice(u,1),ye.value.splice(u,1)}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})])}}];function Me(){Fe.value=!1}const ye=h([]),R=l=>{A.value=[],l.forEach(u=>{var g;A.value.push({debugname:(g=X.data.find(F=>F.id==u))==null?void 0:g.tname,docker:void 0,dockcharge:"",dockcontact:"",debugresult:0,status:0,notes:"",dbcreater:void 0,dtype:u,setStatus:!0,pid:Y.pid,starttime:null,endtime:null})})},me=h(!1);async function Pe(){var g,F,D,U,x,V,H,fe;const l=["dtype","debugname","docker"],u=A.value.findIndex(oe=>l.some(ne=>!oe[ne]||oe[ne].toString().trim()===""));if(u!==-1){(F=(g=window.$message)==null?void 0:g.error)==null||F.call(g,`第 ${u+1} 行请完整填写必填项（权重、业务名称、对接方）`);return}try{if(me.value=!0,Y.operateType==="edit")for(const ne of A.value){if(!Array.isArray(ne.fileList)||ne.fileList.length===0)continue;const Ie=ne.fileList.filter(Le=>(Le==null?void 0:Le.file)&&typeof Le.file=="object"),ge=Ie.length;for(let Le=0;Le<ge;Le++){const b=Ie[Le];b.indexText=`${Le+1}/${ge}`,b.progress=0,b.status="uploading";try{b.url=await Qe(b.file.file,b.file.name,""),b.progress=100,b.status="done"}catch{b.status="error",(U=(D=window.$message)==null?void 0:D.error)==null||U.call(D,"文件上传失败，请重试");return}}ne.fileList.forEach((Le,b)=>{const k=`re${b+1}`,B=`fl${b+1}`;ne[k]=Le.status==="done"&&Le.name||"",ne[B]=Le.status==="done"&&Le.url||""}),delete ne.fileList}const oe=A.value.map(ne=>{var Ie;return{...ne,starttime:Ge(0,ne.starttime),endtime:Ge(0,ne.endtime),docker:(Ie=ne.docker)==null?void 0:Ie.split("&id=")[0]}});if(Y.operateType==="edit"){const{error:ne}=await Sa(oe);ne||((V=(x=window.$message)==null?void 0:x.success)==null||V.call(x,"添加成功"),Me(),le("submitted"))}else le("submittedData",oe)}catch(oe){console.error(oe),(fe=(H=window.$message)==null?void 0:H.error)==null||fe.call(H,"提交失败，请稍后重试")}finally{me.value=!1}}const n=h(!1),m=h(),_=(l,u)=>{n.value=!0,m.value=u,l.fileList&&l.fileList.length>0?c.value=l.fileList:c.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]},r=[{title:"",key:"",align:"center",width:80,render(l,u){return`附件${u+1}`}},{title:"文件名称",key:"filename",align:"center",render(l){var F;const u=async({file:D,onFinish:U,onError:x})=>{var V,H;try{l.name=D.name,l.file=D}catch(fe){console.error(fe),(H=(V=window.$message)==null?void 0:V.error)==null||H.call(V,"文件上传出错")}};async function g(D){var U;return D.file.file.size>100*1024*1024?((U=window.$message)==null||U.error("文件大小不能超过100M"),!1):!0}return a("div",{style:"display:flex;justify-content:center;align-items:center;"},[l.file||l.url?a("span",{},[a("span",{},((F=l.file)==null?void 0:F.name)||l.url.split("?")[1]||""),a("span",{style:"color:red;cursor:pointer;font-size:12px;margin-left:8px;",onClick:()=>{l.url="",l.file=null}},"删除")]):a(ht,{action:"#",showFileList:!1,customRequest:u,onBeforeUpload:g},{default:()=>a(z,{type:"info",size:"small",ghost:!0,loading:l.status},{default:()=>"上传文件"})})])}},{title:"文件别名",key:"name",align:"center",render(l){return a(re,{value:l.name,clearable:!0,onUpdateValue:u=>{l.name=u}})}}],c=h([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]),f=async()=>{var u,g;let l=!0;if(c.value.forEach((F,D)=>{var V,H;const U=F.name||"",x=((V=F.url)==null?void 0:V.split("?")[1])||((H=F.file)==null?void 0:H.name);(U&&!x||!U&&x)&&(l=!1)}),!l){(g=(u=window.$message)==null?void 0:u.error)==null||g.call(u,"文件名称和文件地址必须同时存在，不能只填一个");return}A.value[m.value].fileList=c.value,l&&(n.value=!1,m.value=void 0)},C=()=>{n.value=!1};return(l,u)=>{const g=zt,F=ot,D=xt,U=yt("loading");return T(),q(nt,null,[s(D,{show:Fe.value,"onUpdate:show":u[1]||(u[1]=x=>Fe.value=x),title:y.value,preset:"card",class:"w-80% h-70vh","mask-closable":!1,draggable:!0},{footer:p(()=>[s(S(Ve),{justify:"end",size:16},{default:p(()=>[s(S(z),{onClick:Me},{default:p(()=>[j(se(S(ae)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",onClick:Pe},{default:p(()=>[j(se(S(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(g,{label:"权重","label-placement":"left"},{default:p(()=>[s(S(Ee),{filterable:"",multiple:"",value:ye.value,"onUpdate:value":[u[0]||(u[0]=x=>ye.value=x),R],tag:"",style:{width:"300px"},placeholder:"请选择权重","label-field":"tname","value-field":"id",options:S(X).data,onScroll:Oe},null,8,["value","options"])]),_:1}),st(s(F,{style:{width:"100%"},columns:ze,data:A.value,size:"small","row-key":x=>x.id,striped:"","scroll-x":ze.reduce((x,V)=>x+V.width,0),"max-height":350},null,8,["data","row-key","scroll-x"]),[[U,me.value]])]),_:1},8,["show","title"]),s(D,{show:n.value,"onUpdate:show":u[2]||(u[2]=x=>n.value=x),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:p(()=>u[3]||(u[3]=[j(" 待调试业务文件列表 ")])),footer:p(()=>[s(S(Ve),{justify:"end"},{default:p(()=>[s(S(z),{size:"small",class:"mt-16px",onClick:C},{default:p(()=>[j(se(S(ae)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",size:"small",class:"mt-16px",onClick:f},{default:p(()=>[j(se(S(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(F,{columns:r,"paginate-single-page":!1,data:c.value,"max-height":350},null,8,["data"])]),_:1},8,["show"])],64)}}}),Ql=_t({name:"deviceModal",__name:"deviceModal",props:vt({pid:{},proid:{},operateType:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:vt(["submitted","submittedData"],["update:visible"]),setup(w,{emit:Ue}){const le=Ue;kt();const Y=w;async function Ce(){X(),ue.value=[],Z.value=[]}const y=Wt(w,"visible");Yt(y,()=>{y.value&&Ce()});const Fe=h([]),X=async()=>{var _,r;const{data:n,error:m}=await ba({page:1,limit:100,id:Y.proid});if(n){if(Fe.value=n==null?void 0:n.list.map(c=>({value:c.id,label:c.contractname,isLeaf:!1})),Fe.value.length==0)return(_=window.$message)==null?void 0:_.error("该项目没有绑定合同！");qe((r=n==null?void 0:n.list[0])==null?void 0:r.id)}},N=h([]),te=h(),{pageData:Oe,getData:v,nextPage:We}=Ke(_a),qe=async n=>{await v({pids:n}),te.value=[],N.value=Array.from(new Set([...N.value,...Oe.data])),te.value=Oe.data.map(m=>({label:m.devname,value:m.id}))},He=async n=>{var m;await qe(n.value),n.children=(m=te.value)==null?void 0:m.map(_=>({label:_.label,value:_.value,isLeaf:!0})),await et(),setTimeout(()=>{const _=document.querySelectorAll(".n-cascader-submenu-wrapper .n-scrollbar");console.log(_[1]),_[1]&&(_[1].removeEventListener("scroll",xe),_[1].addEventListener("scroll",xe))},2e3)};function Je(n,m){const _=n.filter(c=>!m.includes(c)),r=m.filter(c=>!n.includes(c));return{toDelete:_,toAdd:r}}const he=h([]),d=async n=>{const{toDelete:m,toAdd:_}=Je(he.value,n);m.forEach(r=>{const c=Z.value.findIndex(f=>f.cid==r);c!=-1&&Z.value.splice(c,1)}),_.forEach(async r=>{var c,f,C,l,u,g,F,D,U,x,V,H,fe,oe,ne,Ie;Z.value.push({devname:((f=(c=N.value)==null?void 0:c.find(ge=>ge.id==r))==null?void 0:f.devname)||"",devmodel:((l=(C=N.value)==null?void 0:C.find(ge=>ge.id==r))==null?void 0:l.devmodel)||"",devnum:((g=(u=N.value)==null?void 0:u.find(ge=>ge.id==r))==null?void 0:g.devcount)||0,devmanu:((D=(F=N.value)==null?void 0:F.find(ge=>ge.id==r))==null?void 0:D.devmanu)||"",etype:((x=(U=N.value)==null?void 0:U.find(ge=>ge.id==r))==null?void 0:x.etype)||0,status:0,devunit:((H=(V=N.value)==null?void 0:V.find(ge=>ge.id==r))==null?void 0:H.devunit)||"",notes:((oe=(fe=N.value)==null?void 0:fe.find(ge=>ge.id==r))==null?void 0:oe.notes)||"",setStatus:!0,cid:r,pid:Y.pid,install:1,connectionmode:"",devstatus:2,manucontact:"",manuinfo:"",devnumber:((Ie=(ne=N.value)==null?void 0:ne.find(ge=>ge.id==r))==null?void 0:Ie.devcount)||0})}),he.value=n},ue=h([]),Z=h([]),G=[{title:"绑定合同设备",key:"cid",width:300,align:"center",render(n,m){var _,r;return n.setStatus?a(Rt,{style:"width: 270px",value:n.cid,filterable:!0,placeholder:"请选择合同设备",options:Fe.value,checkStrategy:"child",showPath:!1,remote:!0,onLoad:He,onUpdateValue(c){var C;Z.value[m].cid=Number(c)||0;const f=(C=N.value)==null?void 0:C.find(l=>l.id==c);n.devname=(f==null?void 0:f.devname)||"",n.devnum=(f==null?void 0:f.devcount)||"",n.notes=(f==null?void 0:f.notes)||"",n.devnumber=(f==null?void 0:f.devcount)||0,n.etype=(f==null?void 0:f.devtype)||0,n.devmanu=(f==null?void 0:f.devmanu)||"",n.devmodel=((f==null?void 0:f.devmodel.length)>64?f==null?void 0:f.devname:f==null?void 0:f.devmodel)||"",n.devunit=(f==null?void 0:f.devunit)||""}}):a("div",{},n.devname2||((r=(_=te.value)==null?void 0:_.find(c=>c.value==n.cid))==null?void 0:r.label))}},{title:"设备名称",key:"devname",width:200,align:"center",render(n,m){return n.setStatus?a(re,{value:n.devname,placeholder:"请输入",onUpdateValue(_){Z.value[m].devname=_}}):a("div",{},n.devname)}},{title:"型号",key:"devmodel",width:220,align:"center",render(n,m){return a("div",{},n.devmodel)}},{title:"设备单位",key:"devunit",width:120,align:"center",render(n,m){return a("div",{},n.devunit)}},{title:"数量",key:"devnum",width:100,align:"center",render(n,m){return n.setStatus?a(ha,{value:n.devnum,placeholder:"请输入",max:n.devnumber,onUpdateValue(_){Z.value[m].devnum=_}}):a("div",{},n.devnum)}},{title:"是否为我司设备",key:"etype",width:260,align:"center",render(n,m){return a("div",{},n.etype==0?"是":"否")}},{title:"设备厂家",key:"devmanu",width:100,align:"center",render(n,m){return a("div",{},n.devmanu)}},{title:"厂家联系人",key:"manucontact",width:100,align:"center",render(n,m){return n.setStatus?a(re,{value:n.manucontact,placeholder:"请输入",onUpdateValue(_){Z.value[m].manucontact=_}}):a("div",{},n.manucontact)}},{title:"厂家联系方式",key:"manuinfo",width:100,align:"center",render(n,m){return n.setStatus?a(re,{value:n.manuinfo,placeholder:"请输入",onUpdateValue(_){Z.value[m].manuinfo=_}}):a("div",{},n.manuinfo)}},{title:"设备状态",key:"devstatus",width:120,align:"center",render(n,m){return n.setStatus&&n.id?a(Ee,{value:n.devstatus,filterable:!0,placeholder:"请选择",options:[{label:"设备无异常",value:0},{label:"异常",value:1},{label:"未知",value:2}],onUpdateValue(_){Z.value[m].devstatus=Number(_)||0}}):a("div",{},n.devstatus===0?"设备无异常":n.devstatus===1?"异常":"未知")}},{title:"接线方式",key:"connectionmode",width:100,align:"center",render(n,m){return n.setStatus?a(re,{value:n.connectionmode,placeholder:"请输入",onUpdateValue(_){Z.value[m].connectionmode=_}}):a("div",{},n.connectionmode)}},{title:"是否安装就位",key:"install",width:120,align:"center",render(n,m){return n.setStatus&&n.id?a(Ee,{value:n.install,filterable:!0,placeholder:"请选择",options:[{label:"是",value:0},{label:"否",value:1}],onUpdateValue(_){Z.value[m].install=Number(_)||0}}):a("div",{},n.install===0?"是":"否")}},{title:"备注",key:"notes",width:200,align:"center",render(n,m){return a("div",{},n.notes)}},{title:"文件",key:"re1",width:160,align:"center",render(n,m){return n.setStatus?a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>Me(n,m)},{default:()=>"上传文件"}):a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const _=[{alias:n.re1,file:n.fl1},{alias:n.re2,file:n.fl2},{alias:n.re3,file:n.fl3},{alias:n.re4,file:n.fl4}].filter(r=>r.alias||r.file);return _.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件")])]),a("tbody",_.map(r=>{var c;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},r.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((c=r.file)==null?void 0:c.split("?")[1])||"-")])}))])])}})}},{title:"操作信息",key:"dbtime",width:180,align:"center",render(n,m){return a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},n.dbtime?Ge(1,n.dbtime):""),default:()=>a("div",{style:"padding: 10px;"},s("div",null,[s("div",null,[j("操作人："),n.username]),s("div",null,[j("操作时间："),n.dbtime]),s("div",null,[j("清点人："),n.dusername]),s("div",null,[j("清点时间："),n.ddbtime])]))})}},{key:"operate",title:ae("common.operate"),align:"center",width:180,fixed:"right",render(n,m){return a("div",{class:"flex-center gap-8px"},[a(ct,{onPositiveClick:()=>{n.id||(Z.value.splice(m,1),ue.value.splice(m,1))}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})])}}];function Ae(){y.value=!1}const be=h(!1);async function $e(){var _,r,c,f,C,l,u,g;const n=["cid","devname","devnum"],m=Z.value.findIndex(F=>n.some(D=>!F[D]||F[D].toString().trim()===""));if(m!==-1){(r=(_=window.$message)==null?void 0:_.error)==null||r.call(_,`第 ${m+1} 行请完整填写必填项（合同设备、设备名称、数量）`);return}try{if(be.value=!0,Y.operateType==="edit")for(const D of Z.value){if(!Array.isArray(D.fileList)||D.fileList.length===0)continue;const U=D.fileList.filter(x=>(x==null?void 0:x.file)&&typeof x.file=="object");for(const x of U){x.status="uploading";try{x.url=await Qe(x.file.file,x.file.name,""),x.status="done"}catch{x.status="error",(f=(c=window.$message)==null?void 0:c.error)==null||f.call(c,"文件上传失败，请重试");return}}D.fileList.forEach((x,V)=>{const H=`re${V+1}`,fe=`fl${V+1}`;D[H]=x.status==="done"&&x.name||"",D[fe]=x.status==="done"&&x.url||""}),delete D.fileList}const F=Z.value.map(D=>({...D,eqmid:ka()}));if(Y.operateType==="edit"){const{error:D}=await La(F);D||((l=(C=window.$message)==null?void 0:C.success)==null||l.call(C,"添加成功"),Ae(),le("submitted"))}else le("submittedData",F)}catch(F){console.error(F),(g=(u=window.$message)==null?void 0:u.error)==null||g.call(u,"提交失败，请稍后重试")}finally{be.value=!1}}const tt=async n=>{},Te=h(!1),we=h(!0),xe=async n=>{console.log(n);const m=n.target;m.scrollHeight-m.scrollTop-m.clientHeight<10&&!Te.value&&we.value&&(Te.value=!0,We(),te.value=Oe.data.map(r=>({label:r.devname,value:r.id})),Te.value=!1)},A=h(!1),ze=h(),Me=(n,m)=>{A.value=!0,ze.value=m,n.fileList&&n.fileList.length>0?R.value=n.fileList:R.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]},ye=[{title:"",key:"",align:"center",width:80,render(n,m){return`附件${m+1}`}},{title:"文件名称",key:"filename",align:"center",render(n){var r;const m=async({file:c,onFinish:f,onError:C})=>{var l,u;try{n.name=c.name,n.file=c}catch(g){console.error(g),(u=(l=window.$message)==null?void 0:l.error)==null||u.call(l,"文件上传出错")}};async function _(c){var f;return c.file.file.size>100*1024*1024?((f=window.$message)==null||f.error("文件大小不能超过100M"),!1):!0}return a("div",{style:"display:flex;justify-content:center;align-items:center;"},[n.file||n.url?a("span",{},[a("span",{},((r=n.file)==null?void 0:r.name)||n.url.split("?")[1]||""),a("span",{style:"color:red;cursor:pointer;font-size:12px;margin-left:8px;",onClick:()=>{n.url="",n.file=null}},"删除")]):a(ht,{action:"#",showFileList:!1,customRequest:m,onBeforeUpload:_},{default:()=>a(z,{type:"info",size:"small",ghost:!0,loading:n.status},{default:()=>"上传文件"})})])}},{title:"文件别名",key:"name",align:"center",render(n){return a(re,{value:n.name,clearable:!0,onUpdateValue:m=>{n.name=m}})}}],R=h([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]),me=async()=>{var m,_;let n=!0;if(R.value.forEach((r,c)=>{var l,u;const f=r.name||"",C=((l=r.url)==null?void 0:l.split("?")[1])||((u=r.file)==null?void 0:u.name);(f&&!C||!f&&C)&&(n=!1)}),!n){(_=(m=window.$message)==null?void 0:m.error)==null||_.call(m,"文件名称和文件地址必须同时存在，不能只填一个");return}Z.value[ze.value].fileList=R.value,n&&(A.value=!1,ze.value=void 0)},Pe=()=>{A.value=!1};return(n,m)=>{const _=zt,r=ot,c=xt,f=yt("loading");return T(),q(nt,null,[s(c,{show:y.value,"onUpdate:show":m[1]||(m[1]=C=>y.value=C),title:"新增待调试设备",preset:"card",class:"w-80% h-70vh","mask-closable":!1,draggable:!0},{footer:p(()=>[s(S(Ve),{justify:"end",size:16},{default:p(()=>[s(S(z),{onClick:Ae},{default:p(()=>[j(se(S(ae)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",onClick:$e},{default:p(()=>[j(se(S(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(_,{label:"合同设备","label-placement":"left"},{default:p(()=>[s(S(Rt),{value:ue.value,"onUpdate:value":[m[0]||(m[0]=C=>ue.value=C),d],placeholder:"请选择合同设备",options:Fe.value,"check-strategy":"child","show-path":!1,labelKey:"label",remote:"",multiple:"",style:{width:"300px"},"on-load":He,"onUpdate:show":tt},null,8,["value","options"])]),_:1}),st(s(r,{style:{width:"100%"},columns:G,data:Z.value,size:"small","row-key":C=>C.id,striped:"","scroll-x":G.reduce((C,l)=>C+l.width,0),"max-height":350},null,8,["data","row-key","scroll-x"]),[[f,be.value]])]),_:1},8,["show"]),s(c,{show:A.value,"onUpdate:show":m[2]||(m[2]=C=>A.value=C),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:p(()=>m[3]||(m[3]=[j(" 待调试设备文件列表 ")])),footer:p(()=>[s(S(Ve),{justify:"end"},{default:p(()=>[s(S(z),{size:"small",class:"mt-16px",onClick:Pe},{default:p(()=>[j(se(S(ae)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",size:"small",class:"mt-16px",onClick:me},{default:p(()=>[j(se(S(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(r,{columns:ye,"paginate-single-page":!1,data:R.value,"max-height":350},null,8,["data"])]),_:1},8,["show"])],64)}}}),en={class:"w-100%"},tn={class:"flex"},an={class:"flex-col w-100%"},ln=2,nn=_t({__name:"prjDetail",props:vt({operateType:{}},{prjInfo:{default:()=>({id:void 0,proname:void 0,proaddr:"",prosite:"",longitude:120.373885,latitude:30.303899,proid:null,dtype:null,dispatch:"",status:0,plantime:null,region:null,provice:null})},prjInfoModifiers:{}}),emits:vt(["submit","changePrj"],["update:prjInfo"]),setup(w,{expose:Ue,emit:le}){const Y=kt(),Ce=w,y=Wt(w,"prjInfo"),Fe=le,X=h([]),{pageData:N,getData:te,nextPage:Oe}=Ke(Y.userInfo.usertype==1?xl:Wa),v=async b=>{const k=b.currentTarget,B=k.scrollTop;k.scrollTop+k.offsetHeight>=k.scrollHeight&&N.data.length<N.total&&(await Oe(),X.value=N.data,await et(),setTimeout(()=>{k.scrollTop=B}))},We=sa.debounce(async b=>{await te({page:1,fuzzy:b}),X.value=N.data},300),qe=h(!1),He=h(!1),Je=b=>{if(y.value.proid=null,qe.value=!0,He.value=!1,!b){d();return}We(b)},he=async()=>{qe.value&&!He.value&&(await te({page:1}),X.value=N.data,qe.value=!1)},d=async()=>{await te({page:1}),X.value=N.data},ue=async b=>{await G(b),Z.value?y.value.proid=null:y.value.proid=b,Fe("changePrj")},Z=h(!1),G=async b=>{var P;Z.value=!1;const{data:k,error:B}=await kl(b);k&&(Z.value=!0,(P=window.$message)==null||P.warning("该项目已存在调试单，请勿重复添加"))},Ae=h({id:void 0,proname:void 0,proaddr:"",prosite:"",longitude:120.373885,latitude:30.303899,proid:null,dtype:null,dispatch:"",status:0,plantime:null,region:null,provice:null});function be(b){return JSON.parse(JSON.stringify(el(b)))}Kt(()=>Ae.value?JSON.stringify(y.value)!==JSON.stringify(Ae.value):!1),xa(async()=>{await te({page:1}),X.value=N.data,xe(),Ce.operateType=="edit"&&R(y.value.provice),et(()=>{Ae.value=be(y.value)})});const $e={status:{type:"number",required:!0,trigger:["blur","change"],message:"请选择提交状态"},dtype:{type:"number",required:!0,trigger:["blur","change"],message:"请选择调试类型"},proid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择项目"},prosite:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请输入项目地址"},proaddr:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请输入项目详细地址"},plantime:{type:"string",required:!0,trigger:["blur","change"],message:"请选择计划调试时间"},provice:{type:"number",required:!0,trigger:["blur","change"],message:"请选择省份"},region:{type:"number",required:!0,trigger:["blur","change"],message:"请选择城市"},dispatch:{type:"string",required:!0,trigger:["blur","change"],message:"请输入调度名称"}},{formRef:tt,validate:Te}=Gt(),we=h([]),xe=async()=>{const{data:b,error:k}=await Ya();b&&(we.value=b)},A=b=>{R(b),y.value.region=null,y.value.proaddr=""},ze=b=>{var B;const k=(B=ye.value.find(P=>P.id===b))==null?void 0:B.name;y.value.region&&y.value.prosite&&y.value.proaddr&&!m?(y.value.prosite="",y.value.proaddr=""):Me(k)};function Me(b){!b||!m||!n||m.getLocation(b,(k,B)=>{var P;if(k==="complete"&&((P=B.geocodes)!=null&&P.length)){const{location:Be,formattedAddress:Ye}=B.geocodes[0],rt=Be.lng,at=Be.lat;n.setZoomAndCenter(14,[rt,at]),C.longitude=rt,C.latitude=at,y.value.latitude=C.latitude,y.value.longitude=C.longitude,oe(f,{lng:rt,lat:at}),y.value.proaddr=Ye,y.value.prosite=Ye,g.value=Ye}})}const ye=h([]),R=async b=>{var P;if(!b)return(P=window.$message)==null?void 0:P.warning("请先选择省份");const{data:k,error:B}=await Xa({province:b});k&&(ye.value=k)},me=h(!1),Pe=h();let n=null,m=null,_=null,r=null,c=null,f=null;const C=dt({longitude:0,latitude:0});let l;const u=h(!1),g=h(""),F=h([]);let D=0;async function U(){try{if(window._AMapSecurityConfig={securityJsCode:Y.userInfo.sdksecret},!Pe.value)return;f=await gl.load({key:Y.userInfo.sdkkey,version:"2.0",plugins:["AMap.Scale","AMap.PlaceSearch","AMap.AutoComplete","AMap.Geocoder","AMap.Geolocation"]}),n=new f.Map(Pe.value,{zoom:18,center:[y.value.longitude,y.value.latitude],viewMode:"3D",resizeEnable:!0}),m=new f.Geocoder,r=new f.PlaceSearch({city:"全国",pageSize:50}),c=new f.AutoComplete({city:"全国"}),oe(f,{lng:y.value.longitude,lat:y.value.latitude}),n.on("click",b=>{const{lng:k,lat:B}=b.lnglat;l=2,C.latitude=B,C.longitude=k,oe(f,{lng:k,lat:B})}),D=0,et(()=>{window.dispatchEvent(new Event("resize"))})}catch(b){console.error("地图加载失败：",b),D<ln?(D++,console.warn(`地图加载失败，正在第 ${D} 次重试...`),setTimeout(()=>{U()},1500)):console.error("地图加载失败，已达到最大重试次数，停止重试")}}const x=sa.debounce(async b=>{if(!u.value||!b.trim()){F.value=[];return}c.search(b,(k,B)=>{var P;console.log(B,"result"),k=="complete"&&B.info=="OK"&&((P=B==null?void 0:B.tips)!=null&&P.length)?F.value=B.tips.map(Be=>({label:`${Be.name}（${Be.district||Be.address||"无详细地址"}）`,value:`${Be.location.lng}_${Be.location.lat}`,raw:Be})):F.value=[]})},300);Yt(g,b=>{x(b)});function V(b,k){if(console.log(b,k,"option"),!b)return;const[B,P]=b.split("_").map(Number);!B||!P||(n.setCenter([B,P]),l=1,oe(f,{lng:B,lat:P}),C.longitude=B,C.latitude=P)}function H(){me.value=!0,u.value=!1,l=void 0,et(async()=>{await U(),setTimeout(()=>{u.value=!0;const b=document.querySelector(".n-auto-complete input");b==null||b.blur(),y.value.region&&!y.value.prosite&&!y.value.prosite&&ze(y.value.region)},500)})}const fe=h({lng:0,lat:0});function oe(b,k){_&&n.remove(_),_=new b.Marker({position:[k.lng,k.lat],map:n}),n.add(_),m.getAddress(k,async(B,P)=>{B==="complete"&&P.regeocode&&(console.log("result",P),console.log("formattedAddress",P.regeocode.formattedAddress),k.latitude=k.lat,k.longitude=k.lng,fe.value=k,l==1?y.value.proaddr=P.regeocode.formattedAddress:l==2?(g.value=P.regeocode.formattedAddress,y.value.proaddr=P.regeocode.formattedAddress,y.value.provice=ne(y.value.proaddr,we.value),await R(y.value.provice),y.value.region=Ie(y.value.proaddr,ye.value)):(g.value=y.value.prosite||P.regeocode.formattedAddress,y.value.proaddr=P.regeocode.formattedAddress,setTimeout(async()=>{y.value.provice=ne(g.value,we.value)||y.value.provice,y.value.provice&&await R(y.value.provice),y.value.region=Ie(g.value,ye.value)},1300)))})}function ne(b,k){let B=null;for(const P of k)if(b.includes(P.name)){B=P.id;break}return B}function Ie(b,k){let B=null;for(const P of k)if(b.includes(P.name)){B=P.id;break}return B}const ge=async()=>{y.value.latitude=C.latitude||fe.value.lat,y.value.longitude=C.longitude||fe.value.lng,y.value.prosite=g.value,me.value=!1};function Le(){me.value=!1}return Ue({validate:Te}),(b,k)=>{const B=Ee,P=yl,Be=bt,Ye=re,rt=pl,at=z,jt=Qa,Pt=ml,Lt=ga,pt=zt,Se=Ve,St=fl,Xe=xt;return T(),q(nt,null,[s(Lt,{ref_key:"formRef",ref:tt,model:y.value,rules:$e,"label-placement":"left","label-width":"120"},{default:p(()=>[s(Pt,{responsive:"screen","item-responsive":"","x-gap":"15"},{default:p(()=>[s(P,{span:"24 s:12 m:9",label:"项目名称",path:"proid"},{default:p(()=>[s(B,{filterable:"",clearable:"",value:y.value.proid,"onUpdate:value":[k[0]||(k[0]=J=>y.value.proid=J),ue],placeholder:"请选择项目","label-field":"proname","value-field":"id",disabled:Ce.operateType=="edit",options:X.value,onScroll:v,onClear:d,onSearch:Je,onBlur:he},null,8,["value","disabled","options"])]),_:1}),s(P,{span:"24 s:12 m:5",label:"计划调试时间",path:"plantime"},{default:p(()=>[s(Be,{"formatted-value":y.value.plantime,"onUpdate:formattedValue":k[1]||(k[1]=J=>y.value.plantime=J),type:"date","value-format":"yyyy-MM-dd",style:{width:"100%"}},null,8,["formatted-value"])]),_:1}),s(P,{span:"24 s:12 m:5",label:"调试类型",path:"dtype"},{default:p(()=>[s(B,{filterable:"",value:y.value.dtype,"onUpdate:value":k[2]||(k[2]=J=>y.value.dtype=J),placeholder:"请选择调试类型",options:S(Za)(S(vl))},null,8,["value","options"])]),_:1}),s(P,{span:"24 s:12 m:5",label:"提交状态",path:"status"},{default:p(()=>[s(B,{filterable:"",disabled:"",value:y.value.status,"onUpdate:value":k[3]||(k[3]=J=>y.value.status=J),placeholder:"请选择提交状态",options:[{label:"未提交",value:0},{label:"已提交",value:1}]},null,8,["value"])]),_:1}),s(P,{span:"24 s:12 m:8",label:"省份",path:"provice"},{default:p(()=>[s(B,{filterable:"",value:y.value.provice,"onUpdate:value":[k[4]||(k[4]=J=>y.value.provice=J),A],placeholder:"请选择省份","label-field":"name","value-field":"id",options:we.value},null,8,["value","options"])]),_:1}),s(P,{span:"24 s:12 m:8",label:"地区",path:"region"},{default:p(()=>[s(B,{filterable:"",value:y.value.region,"onUpdate:value":[k[5]||(k[5]=J=>y.value.region=J),ze],placeholder:"请选择地区","label-field":"name","value-field":"id",options:ye.value},null,8,["value","options"])]),_:1}),s(P,{span:"24 s:12 m:8",label:"调度名称",path:"dispatch"},{default:p(()=>[s(Ye,{clearable:"",value:y.value.dispatch,"onUpdate:value":k[6]||(k[6]=J=>y.value.dispatch=J),placeholder:"请输入调度名称"},null,8,["value"])]),_:1}),s(P,{span:"24 s:12 m:12",label:"项目默认地点",path:"prosite"},{default:p(()=>[I("div",en,[I("div",tn,[s(jt,{onClick:k[8]||(k[8]=J=>H())},{default:p(()=>[s(Ye,{value:y.value.prosite,"onUpdate:value":k[7]||(k[7]=J=>y.value.prosite=J),placeholder:"请选择项目地点"},null,8,["value"]),s(at,null,{icon:p(()=>[s(rt,{class:"text-icon"})]),_:1})]),_:1})])])]),_:1}),s(P,{span:"24 s:12 m:12",label:"项目详细地址",path:"proaddr"},{default:p(()=>[s(Ye,{type:"textarea",rows:1,clearable:"",value:y.value.proaddr,"onUpdate:value":k[9]||(k[9]=J=>y.value.proaddr=J),placeholder:"请输入项目详细地址"},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["model"]),s(Xe,{show:me.value,"onUpdate:show":k[14]||(k[14]=J=>me.value=J),title:"选择项目位置",preset:"card",class:"w-800px"},{footer:p(()=>[s(Se,{justify:"end",size:16},{default:p(()=>[s(at,{onClick:Le},{default:p(()=>[j(se(b.$t("common.cancel")),1)]),_:1}),s(at,{type:"primary",onClick:ge},{default:p(()=>[j(se(b.$t("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(Se,null,{default:p(()=>[s(pt,{label:"省份",path:"provice","label-placement":"left","label-width":"70"},{default:p(()=>[s(B,{filterable:"",value:y.value.provice,"onUpdate:value":[k[10]||(k[10]=J=>y.value.provice=J),A],placeholder:"请选择省份","label-field":"name","value-field":"id",options:we.value},null,8,["value","options"])]),_:1}),s(pt,{label:"地区",path:"region","label-placement":"left","label-width":"70"},{default:p(()=>[s(B,{filterable:"",value:y.value.region,"onUpdate:value":[k[11]||(k[11]=J=>y.value.region=J),ze],placeholder:"请选择地区","label-field":"name","value-field":"id",options:ye.value},null,8,["value","options"])]),_:1})]),_:1}),u.value?(T(),ke(pt,{key:0,label:"项目地址","label-placement":"left"},{default:p(()=>[I("div",an,[s(St,{value:g.value,"onUpdate:value":[k[12]||(k[12]=J=>g.value=J),S(x)],options:F.value,style:{"margin-bottom":"7px"},placeholder:"请输入地点关键字",clearable:"",onSelect:V},null,8,["value","options","onUpdate:value"]),s(Ye,{type:"textarea",rows:2,clearable:"",value:y.value.proaddr,"onUpdate:value":k[13]||(k[13]=J=>y.value.proaddr=J),placeholder:"请输入详细地址"},null,8,["value"])])]),_:1})):W("",!0),I("div",{ref_key:"domRef",ref:Pe,class:"h-full w-full",style:{width:"100%",height:"500px","margin-top":"10px"}},null,512)]),_:1},8,["show"])],64)}}}),sn={class:"flex justify-center items-center"},on={class:"font-size-22px font-bold"},rn={class:"position-absolute right-80px flex items-center gap-x-20px"},un={class:"flex-col-stretch"},dn={class:"timeline-wrapper"},cn={class:"timeline-layout"},pn={class:"timeline"},fn=["id"],gn={class:"timeline-icon"},vn=["onClick"],mn={class:"flex justify-between"},yn=["onClick"],hn={class:"timeline-rows"},bn={key:0,class:"timeline-content",style:{"padding-left":"80px",position:"relative"}},_n={class:"timeline-icon"},kn=["onClick"],xn=["onClick"],Ln=["id"],Sn={style:{display:"flex","align-items":"center",gap:"10px"}},Dn={key:0},Cn={key:1,style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},wn={style:{display:"flex","align-items":"center",gap:"10px"}},Fn={key:0},$n={key:1,style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},Tn={key:0,style:{height:"20px"}},Un={style:{display:"flex","align-items":"center",gap:"10px"}},zn={key:0},jn={key:1,style:{width:"100%",display:"flex","justify-content":"center",cursor:"pointer"}},Pn={key:0,style:{height:"20px"}},Bn=_t({name:"projectmanagement_projectdebuggingformdetail",__name:"index",props:{operateType:{},rowData:{}},emits:["return","submit","returnandSub"],setup(w,{emit:Ue}){const le=kt(),Y=tl(),Ce=h(""),y=al(),Fe=ll(),X=dt({debuggedBusinessList:[],developBusinessList:[],needsList:[]});Gt();const N=w,te=Ue,Oe=()=>{te("return")},v=dt(We());function We(){return{id:void 0,proname:void 0,proaddr:"",prosite:"",longitude:120.373885,latitude:30.303899,proid:null,dtype:null,dispatch:"",status:0,plantime:null,region:null,provice:null}}async function qe(){Object.assign(v,We()),H(),Le(),d.value={projectDetail:{},contactList:[],debuggedBusinessList:[],fileList:[],debuggedDevieceList:[]},N.operateType==="edit"&&N.rowData&&(Object.assign(v,N.rowData),await He(v.proid),ze(),Be()),ue(),setTimeout(()=>{Fe.replace({path:y.path,query:{}})},100)}const He=async e=>{if(!e){d.value={projectDetail:{},contactList:[],debuggedBusinessList:[],fileList:[],debuggedDevieceList:[]};return}it.value=!0;try{const t=await Promise.allSettled([Vt(v.id),Pt(),be(v.id),Xe(v.id),f(v.id)]);ue(),t.forEach((o,i)=>{o.status==="fulfilled"?console.log(`任务 ${i} 成功:`,o):console.warn(`任务 ${i} 失败:`,o.reason)})}catch(t){console.error("意料之外的错误:",t)}finally{it.value=!1}},Je=async()=>{const{data:e,error:t}=await _l(v.id);t||Object.assign(v,e)},he=dt([{id:"phase1",title:"基本信息",show:!0,tables:[]},{id:"phase2",title:"实施信息",show:!0,tables:[]}]),d=h({projectDetail:{},contactList:[],fileList:[],debuggedDevieceList:[],debuggedBusinessList:[]}),ue=()=>{he[0].tables=[{id:1,name:"项目联系人",type:d.value.contactList.length>0?1:0},{id:2,name:"待调试设备",type:d.value.debuggedDevieceList.length>0?1:0},{id:3,name:"图纸",type:d.value.fileList.length>0?1:0}],he[1].tables=[{id:1,name:"待调试业务",type:d.value.debuggedBusinessList.length>0?1:0},{id:2,name:"文件",type:Ne.value.length>0||Ct.value.length>0||wt.value.length>0||Ft.value.length>0||$t.value.length>0?1:0}]},Z=()=>{G.pageSize==1?G.pageSize=20:G.pageSize=1,be(v.id)},G=dt({page:1,pageSize:1,showSizePicker:!0,fuzzy:"",itemCount:0,pageSizes:[10,20],prefix:()=>`共 ${G.itemCount} 条`,onChange:e=>{G.page=e,be(v.id)},onUpdatePageSize:e=>{G.pageSize=e,G.page=1,be(v.id)}}),Ae=[{title:"对接方",key:"docker",align:"center",render(e,t){return e.setStatus?a(re,{value:e.docker,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].docker=o}}):a("div",{},e.docker)}},{title:"姓名",key:"pname",align:"center",render(e,t){return e.setStatus?a(re,{value:e.pname,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].pname=o}}):a("div",{},e.pname)}},{title:"联系方式",key:"pcontact",align:"center",render(e,t){return e.setStatus?a(re,{value:e.pcontact,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].pcontact=o}}):a("div",{},e.pcontact)}},{title:"备注",key:"proposition",align:"center",render(e,t){return e.setStatus?a(re,{value:e.proposition,placeholder:"请输入",onUpdateValue(o){d.value.contactList[t].proposition=o}}):a("div",{},e.proposition)}},{title:"操作人",key:"username",align:"center"},{title:"操作时间",key:"dbtime",align:"center",render:e=>e.dbtime?Ge(1,e.dbtime):""},{key:"operate",title:ae("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return a("div",{class:"flex-center gap-8px"},[e.setStatus?[Ze("project:Form:Contact:insert")&&a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>we(e)},{default:()=>"保存"}),a(z,{type:"default",ghost:!0,size:"small",onClick:()=>Te(e,t)},{default:()=>"取消"}),Ze("project:Form:Contact:delete")&&a(ct,{onPositiveClick:async()=>{var o;if(e.id){const{data:i,error:$}=await Dl(e.id);i&&(d.value.contactList.splice(t,1),(o=window.$message)==null||o.success("删除成功"),be(v.id),v.status=0,ue())}else d.value.contactList.splice(t,1)}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})]:Ze("project:Form:Contact:update")&&a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>tt(e)},{default:()=>"编辑"})])}}],be=async e=>{if(!e)return;const{data:t}=await Ht({page:G.page,limit:G.pageSize,pid:e});d.value.contactList=t==null?void 0:t.list,console.log(t.list,"项目联系人"),G.itemCount=t==null?void 0:t.total,d.value.contactList.forEach(o=>{o.setStatus=!1}),X.contactList=JSON.parse(JSON.stringify(d.value.contactList)),$e.value=!1},$e=h(!1),tt=e=>{d.value.contactList.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus,$e.value=!0},Te=(e,t)=>{e.setStatus=!e.setStatus,!e.id&&!$e.value?d.value.contactList.splice(t,1):e.id&&$e.value&&(d.value.contactList=JSON.parse(JSON.stringify(X.contactList)))},we=async e=>{var t,o,i,$,L;if(!e.docker){(t=window.$message)==null||t.warning("请输入对接方");return}if(!e.pname){(o=window.$message)==null||o.warning("请输入联系人姓名");return}if(!e.pcontact){(i=window.$message)==null||i.warning("请输入联系方式");return}if(e.id){const{data:ce,error:K}=await Sl([e]);K||(($=window.$message)==null||$.success("修改成功"),be(v.id),v.status=0,e.setStatus=!e.setStatus)}else if(N.operateType=="edit"){const{data:ce,error:K}=await Ll([{...e,pid:v.id}]);K||((L=window.$message)==null||L.success("添加成功"),be(v.id),e.setStatus=!e.setStatus,v.status=0,ue())}else e.setStatus=!e.setStatus,$e.value=!1;Be()};function xe(){var e;Tt.value.includes("1")||Tt.value.push("1"),((e=d.value.contactList[0])!=null&&e.pname||d.value.contactList.length==0)&&(d.value.contactList.unshift({pname:"",pcontact:"",proposition:"",setStatus:!0}),$e.value=!1)}const A=h([]),ze=async()=>{var o;const{data:e,error:t}=await ba({page:1,limit:100,id:v.proid});A.value=e==null?void 0:e.list.map(i=>({value:i.id,label:i.contractname,isLeaf:!1})),Pe((o=e==null?void 0:e.list[0])==null?void 0:o.id)},Me=h([]),ye=h(),{pageData:R,getData:me}=Ke(_a),Pe=async e=>{await me({pids:e}),ye.value=[],Me.value=Array.from(new Set([...Me.value,...R.data])),ye.value=R.data.map(t=>({label:t.devname,value:t.id}))},n=async e=>{var t;await Pe(e.value),e.children=(t=ye.value)==null?void 0:t.map(o=>({label:o.label,value:o.value,isLeaf:!0}))},m=()=>{_.pageSize==1?_.pageSize=20:_.pageSize=1,f(v.id)},_=dt({page:1,pageSize:1,itemCount:0,showSizePicker:!0,fuzzy:"",pageSizes:[10,20],prefix:()=>`共 ${_.itemCount} 条`,onChange:e=>{_.page=e,f(v.id)},onUpdatePageSize:e=>{_.pageSize=e,_.page=1,f(v.id)}}),r=h(),c=[{title:"绑定合同设备",key:"cid",width:220,align:"center",render(e,t){var o,i;return e.setStatus?a(Rt,{style:"width: 200px",value:e.cid,filterable:!0,placeholder:"请选择合同设备",options:A.value,checkStrategy:"child",showPath:!1,remote:!0,renderSuffix:$=>$.option.hidden?null:$.node,renderLabel:$=>$.hidden?null:$.label,onLoad:n,onUpdateValue($){var ce;d.value.debuggedDevieceList[t].cid=Number($)||0;const L=(ce=Me.value)==null?void 0:ce.find(K=>K.id==$);e.devname=(L==null?void 0:L.devname)||"",e.devnum=(L==null?void 0:L.devcount)||"",e.notes=(L==null?void 0:L.notes)||"",r.value=(L==null?void 0:L.devcount)||0,e.etype=(L==null?void 0:L.devtype)||0,e.devmanu=(L==null?void 0:L.devmanu)||"",e.devmodel=((L==null?void 0:L.devmodel.length)>64?L==null?void 0:L.devname:L==null?void 0:L.devmodel)||"",e.devunit=(L==null?void 0:L.devunit)||""}}):a("div",{},e.devname2||((i=(o=ye.value)==null?void 0:o.find($=>$.value==e.cid))==null?void 0:i.label))}},{title:"设备名称",key:"devname",width:200,align:"center",render(e,t){return e.setStatus?a(re,{value:e.devname,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].devname=o}}):a("div",{},e.devname)}},{title:"型号",key:"devmodel",width:100,align:"center",render(e){return a(nl,{tooltipPlacement:"center",style:{maxWidth:"100px"}},{default:()=>e.devmodel||"",tooltip:()=>a("div",{style:{textAlign:"center",padding:"8px",maxWidth:"600px"}},e.devmodel||"")})}},{title:"设备单位",key:"devunit",width:80,align:"center",render(e,t){return a("div",{},e.devunit)}},{title:"数量",key:"devnum",width:100,align:"center",render(e,t){return e.setStatus?a(ha,{value:e.devnum,placeholder:"请输入",max:r.value,onUpdateValue(o){d.value.debuggedDevieceList[t].devnum=o}}):a("div",{},e.devnum)}},{title:"是否为我司设备",key:"etype",width:120,align:"center",render(e,t){return a("div",{},e.etype==0?"是":"否")}},{title:"设备厂家",key:"devmanu",width:100,align:"center",render(e,t){return a("div",{},e.devmanu)}},{title:"厂家联系人",key:"manucontact",width:100,align:"center",render(e,t){return e.setStatus?a(re,{value:e.manucontact,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].manucontact=o}}):a("div",{},e.manucontact)}},{title:"厂家联系方式",key:"manuinfo",width:100,align:"center",render(e,t){return e.setStatus?a(re,{value:e.manuinfo,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].manuinfo=o}}):a("div",{},e.manuinfo)}},{title:"文件",key:"re1",width:100,align:"center",render(e,t){return e.setStatus?a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>Qt(e,"debuggedDevieceList",t)},{default:()=>"上传文件"}):a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const o=[{alias:e.re1,file:e.fl1},{alias:e.re2,file:e.fl2},{alias:e.re3,file:e.fl3},{alias:e.re4,file:e.fl4}].filter(i=>i.alias||i.file);return o.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件"),a("th",{style:"text-align:center; padding: 4px 8px;"},"操作")])]),a("tbody",o.map((i,$)=>{var L;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},i.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((L=i.file)==null?void 0:L.split("?")[1])||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>ea({url:i.file})},{default:()=>"下载"}))])}))])])}})}},{title:"设备状态",key:"devstatus",width:120,align:"center",render(e,t){return e.setStatus&&e.id?a(Ee,{value:e.devstatus,filterable:!0,placeholder:"请选择",options:[{label:"设备无异常",value:0},{label:"异常",value:1},{label:"未知",value:2}],onUpdateValue(o){d.value.debuggedDevieceList[t].devstatus=Number(o)||0}}):a("div",{},e.devstatus===0?"设备无异常":e.devstatus===1?"异常":"未知")}},{title:"接线方式",key:"connectionmode",width:100,align:"center",render(e,t){return e.setStatus?a(re,{value:e.connectionmode,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].connectionmode=o}}):a("div",{},e.connectionmode)}},{title:"是否安装就位",key:"install",width:120,align:"center",render(e,t){return e.setStatus&&e.id?a(Ee,{value:e.install,filterable:!0,placeholder:"请选择",options:[{label:"是",value:0},{label:"否",value:1}],onUpdateValue(o){d.value.debuggedDevieceList[t].install=Number(o)||0}}):a("div",{},e.install===0?"是":"否")}},{title:"备注",key:"notes",width:100,align:"center",render(e,t){return e.setStatus?a(re,{value:e.notes,placeholder:"请输入",onUpdateValue(o){d.value.debuggedDevieceList[t].notes=o}}):a("div",{},e.notes)}},{title:"操作信息",key:"dbtime",width:180,align:"center",render(e,t){return a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},e.dbtime?Ge(1,e.dbtime):""),default:()=>a("div",{style:"padding: 10px;"},s("div",null,[s("div",null,[j("操作人："),e.username]),s("div",null,[j("操作时间："),e.dbtime]),s("div",null,[j("清点人："),e.dusername]),s("div",null,[j("清点时间："),e.ddbtime])]))})}},{key:"operate",title:ae("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return a("div",{class:"flex-center gap-8px"},[e.setStatus?[a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>g(e)},{default:()=>"保存"}),a(z,{type:"default",ghost:!0,size:"small",onClick:()=>u(e,t)},{default:()=>"取消"}),Ze("project:Form:Equipment:delete")&&a(ct,{onPositiveClick:async()=>{var o,i;if(e.id){const{data:$,error:L}=await wl(e.id);$&&(d.value.debuggedDevieceList.splice(t,1),(o=window.$message)==null||o.success("删除成功"),v.status=0,f(v.id),ue())}else{if(d.value.debuggedBusinessList.some(L=>L.eqmid==e.eqmid))return(i=window.$message)==null?void 0:i.error("该设备在待调试业务中已绑定，请先解除绑定后在删除！");d.value.debuggedDevieceList.splice(t,1)}}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})]:Ze("project:Form:Equipment:update")&&a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>l(e)},{default:()=>"编辑"})])}}],f=async e=>{if(!e)return;const{data:t}=await Jt({page:_.page,limit:_.pageSize,fuzzy:_.fuzzy,pid:e});d.value.debuggedDevieceList=t.list,_.itemCount=t.total,d.value.debuggedDevieceList.forEach(o=>{o.setStatus=!1}),X.debuggedDevieceList=JSON.parse(JSON.stringify(d.value.debuggedDevieceList)),C.value=!1,ue()},C=h(!1),l=async e=>{console.log(R.data,e.cid,"ssssssssssssssss"),d.value.debuggedDevieceList.forEach(i=>{i.setStatus=!1});const{data:t,error:o}=await il(e.cid);o||(A.value[A.value.length-1].value!=t.id&&A.value.push({value:t.id,label:t.devname,disabled:!0,isLeaf:!0,hidden:!0}),r.value=t.devcount||0),C.value=!0,e.setStatus=!e.setStatus},u=(e,t)=>{e.setStatus=!e.setStatus,!e.id&&!C.value?d.value.debuggedDevieceList.splice(t,1):e.id&&C.value&&(d.value.debuggedDevieceList=JSON.parse(JSON.stringify(X.debuggedDevieceList)))},g=async e=>{var t,o,i,$,L,ce,K;if(!e.cid){(t=window.$message)==null||t.warning("请选择合同设备");return}if(!e.devname){(o=window.$message)==null||o.warning("设备名称不能为空");return}if(!e.devmodel){(i=window.$message)==null||i.warning("设备型号不能为空");return}if(!e.devnum){($=window.$message)==null||$.warning("设备数量不能为空");return}if(((L=e.fileList)==null?void 0:L.length)>0&&N.operateType=="edit"){const de=e.fileList.filter(E=>E.file),De=de.length;for(let E=0;E<De;E++){const O=de[E];O.indexText=`${E+1}/${De}`,O.progress=0,O.status="uploading";try{O.url=await Qe(O.file.file,O.file.name,""),O.progress=100,O.status="done"}catch{O.status="error"}}e.fileList.forEach((E,O)=>{e[`re${O+1}`]=E.name||"",e[`fl${O+1}`]=E.url||""}),delete e.fileList}if(e.id&&N.operateType=="edit"){const{data:de,error:De}=await Cl([e]);De||((ce=window.$message)==null||ce.success("修改成功"),f(v.id),v.status=0,e.setStatus=!e.setStatus)}else if(N.operateType=="edit"){const{data:de,error:De}=await La([{...e,pid:v.id}]);De||((K=window.$message)==null||K.success("添加成功"),f(v.id),v.status=0,e.setStatus=!e.setStatus,ue())}else e.id?e.id:ka(),e.setStatus=!e.setStatus,C.value=!1},F=h(!1);function D(){F.value=!0}const{pageData:U,getData:x,nextPage:V}=Ke(ya),H=async()=>{await x({usertypes:"2,3"})},fe=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&U.data.length<U.total&&(await V(),await et(),setTimeout(()=>{t.scrollTop=o}))},{pageData:oe,getData:ne,nextPage:Ie}=Ke(ma),ge=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&oe.data.length<oe.total&&(await Ie(),await et(),setTimeout(()=>{t.scrollTop=o}))},Le=async()=>{await ne(),oe.data=oe.data.map(e=>(e.name=`${e.weight}  `+e.tname,e))},{pageData:b,getData:k,nextPage:B}=Ke(Ht),P=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&b.data.length<b.total&&(await B(),b.data=b.data.map(i=>({...i,value:i.docker+"&id="+i.id})),await et(),setTimeout(()=>{t.scrollTop=o}))},Be=async()=>{await k({pid:v.id}),b.data=b.data.map(e=>({...e,value:e.docker+"&id="+e.id}))},{pageData:Ye,getData:rt,nextPage:at}=Ke(Jt),jt=async e=>{const t=e.currentTarget,o=t.scrollTop;t.scrollTop+t.offsetHeight>=t.scrollHeight&&oe.data.length<oe.total&&(await at(),await et(),setTimeout(()=>{t.scrollTop=o}))},Pt=async()=>{v.id&&await rt({pid:v.id})},Lt=h(),pt=[{title:"权重",key:"dtype",width:180,align:"center",render(e,t){var o;return e.setStatus?a(Ee,{value:e.dtype,filterable:!0,placeholder:"请选择权重",options:oe.data,labelField:"tname",valueField:"id",onUpdateValue(i){var $;d.value.debuggedBusinessList[t].dtype=Number(i)||0,d.value.debuggedBusinessList[t].debugname=(($=oe.data.find(L=>L.id==i))==null?void 0:$.tname)||""},onScroll(i){ge(i)}}):a("div",{},e.tname||((o=oe.data.find(i=>i.id==e.dtype))==null?void 0:o.tname))}},{title:"业务名称",key:"debugname",width:180,align:"center",render(e,t){return e.setStatus?a(re,{value:e.debugname,placeholder:"请输入业务名称",onUpdateValue(o){d.value.debuggedBusinessList[t].debugname=o}}):a("div",{},e.debugname)}},{key:"eqmname",title:"调试设备",align:"center",width:150,render(e,t){var o;return e.setStatus?a(Ee,{value:e.eqmid,placeholder:"请选择调试设备",options:N.operateType=="edit"?Ye.data:d.value.debuggedDevieceList,onscroll:jt,labelField:"devname",valueField:"id",clearable:!0,filterable:!0,onUpdateValue(i){d.value.debuggedBusinessList[t].eqmid=i}}):a("div",{},e.eqmname||((o=d.value.debuggedDevieceList.find(i=>i.eqmid==e.eqmid))==null?void 0:o.devname))}},{title:"调试人",key:"dbcreater",width:120,align:"center",render(e,t){var o;return e.setStatus?a(Ee,{value:e.dbcreater,filterable:!0,placeholder:"请选择调试人",options:U.data,labelField:"username",valueField:"id",onUpdateValue(i){d.value.debuggedBusinessList[t].dbcreater=i||0},onScroll(i){fe(i)}}):a("div",{},e.dbusername||((o=U.data.find(i=>i.id==e.dbcreater))==null?void 0:o.username))}},{title:"对接方",key:"docker",width:120,align:"center",render(e,t){var o;return e.setStatus?a(Ee,{value:e.docker,placeholder:"请输入或选择对接方",options:N.operateType=="edit"?b.data:d.value.contactList,onscroll:P,labelField:"docker",valueField:"value",clearable:!0,filterable:!0,tag:!0,onClear(){e.dockcharge="",e.dockcontact=""},onUpdateValue(i){var K;d.value.debuggedBusinessList[t].docker=i;const[$,L]=(K=e.docker)==null?void 0:K.split("&id="),ce=b.data.find(de=>de.docker===$&&de.id===Number(L));ce?(e.dockcharge=ce.pname,e.dockcontact=ce.pcontact):(e.dockcharge="",e.dockcontact="")}}):a("div",{},(o=e.docker)==null?void 0:o.split("&id=")[0])}},{title:"对接方负责人",key:"dockcharge",width:100,align:"center",render(e,t){return e.setStatus?a(re,{value:e.dockcharge,placeholder:"请输入对接方负责人",onUpdateValue(o){d.value.debuggedBusinessList[t].dockcharge=o}}):a("div",{},e.dockcharge)}},{title:"联系方式",key:"dockcontact",width:140,align:"center",render(e,t){return e.setStatus?a(re,{value:e.dockcontact,placeholder:"请输入联系方式",onUpdateValue(o){d.value.debuggedBusinessList[t].dockcontact=o}}):a("div",{},e.dockcontact)}},{title:"文件",key:"re1",width:80,align:"center",render(e,t){return e.setStatus?a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>Qt(e,"debuggedBusinessList",t)},{default:()=>"上传文件"}):a(gt,{trigger:"hover"},{trigger:()=>a("div",{style:"color: #1890ff;cursor: pointer;"},"文件列表"),default:()=>{const o=[{alias:e.re1,file:e.fl1},{alias:e.re2,file:e.fl2},{alias:e.re3,file:e.fl3},{alias:e.re4,file:e.fl4}].filter(i=>i.alias||i.file);return o.length===0?a("div",{style:"padding: 10px; color: #999;"},"暂无文件"):a("div",{style:"padding: 10px;"},[a("table",{class:"n-table n-table--bordered n-table--single-line",style:"width: 100%; border-collapse: collapse;"},[a("thead",[a("tr",[a("th",{style:"text-align:center; padding: 4px 8px;"},"文件别名"),a("th",{style:"text-align:center; padding: 4px 8px;"},"文件"),a("th",{style:"text-align:center; padding: 4px 8px;"},"操作")])]),a("tbody",o.map((i,$)=>{var L;return a("tr",[a("td",{style:"text-align:center; padding: 4px 8px;"},i.alias||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},((L=i.file)==null?void 0:L.split("?")[1])||"-"),a("td",{style:"text-align:center; padding: 4px 8px;"},a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>ea({url:i.file})},{default:()=>"下载"}))])}))])])}})}},{title:"备注",key:"notes",width:120,align:"center",render(e,t){return e.setStatus?a(re,{value:e.notes,placeholder:"请输入备注",onUpdateValue(o){d.value.debuggedBusinessList[t].notes=o}}):a("div",{},e.notes)}},{title:"计划开始时间",key:"starttime",width:140,align:"center",render(e,t){return e.setStatus?a(bt,{type:"date",clearable:!0,value:e.starttime,valueFormat:"yyyy-MM-dd",placeholder:"请选择",onUpdateValue(o){d.value.debuggedBusinessList[t].starttime=o}}):a("div",e.starttime?Ge(0,e.starttime):"")}},{title:"计划结束时间",key:"endtime",width:140,align:"center",render:(e,t)=>e.setStatus?a(bt,{type:"date",clearable:!0,valueFormat:"yyyy-MM-dd",value:e.endtime,placeholder:"请选择",onUpdateValue(o){d.value.debuggedBusinessList[t].endtime=o}}):e.endtime?Ge(0,e.endtime):""},{key:"username",title:"创建信息",align:"left",width:240,render(e){return s("div",{style:"display:flex; flex-direction:column; gap:3px; line-height:1.4;"},[s("div",null,[s("span",{style:"color:#666"},[j("创建人：")]),s("span",null,[e.username||"-"])]),s("div",null,[s("span",{style:"color:#666"},[j("时间：")]),s("span",null,[e.dbtime||"-"])])])}},{key:"operate",title:ae("common.operate"),align:"center",width:280,fixed:"right",render(e,t){return a("div",{class:"flex-center gap-8px"},[e.setStatus?[Ze("project:Form:Debug:insert")&&a(ct,{onPositiveClick:()=>{wa(e)}},{default:()=>"是否确认保存？",trigger:()=>a(z,{type:"info",ghost:!0,size:"small"},{default:()=>"保存"})}),a(z,{type:"default",ghost:!0,size:"small",onClick:()=>Ca(e,t)},{default:()=>"取消"}),Ze("project:Form:Debug:delete")&&a(ct,{onPositiveClick:async()=>{var o;if(e.id){const{data:i,error:$}=await Tl(e.id);i&&(d.value.debuggedBusinessList.splice(t,1),(o=window.$message)==null||o.success("删除成功"),Xe(v.id),v.status=0,ue())}else d.value.debuggedBusinessList.splice(t,1)}},{default:()=>ae("common.confirmDelete"),trigger:()=>a(z,{type:"error",ghost:!0,size:"small"},{default:()=>ae("common.delete")})})]:Ze("project:Form:Debug:update")&&a(z,{type:"primary",ghost:!0,size:"small",onClick:()=>Da(e)},{default:()=>"编辑"})])}}],Se=dt({page:1,pageSize:1,showSizePicker:!0,itemCount:0,creater:"",pageSizes:[10,20],prefix:()=>`共 ${Se.itemCount} 条`,onChange:e=>{Se.page=e,Xe(v.id)},onUpdatePageSize:e=>{Se.pageSize=e,Se.page=1,Xe(v.id)}}),St=()=>{Se.pageSize==1?Se.pageSize=20:Se.pageSize=1,Xe(v.id)},Xe=async e=>{if(!e)return;const{data:t}=await Fl({page:Se.page,limit:Se.pageSize,creater:le.userInfo.id,pid:e});d.value.debuggedBusinessList=t.list,Se.itemCount=t.total,d.value.debuggedBusinessList.forEach(o=>{o.setStatus=!1}),X.debuggedBusinessList=JSON.parse(JSON.stringify(d.value.debuggedBusinessList)),J.value=!1},J=h(!1),Da=e=>{e.starttime=oa(e.starttime),e.endtime=oa(e.endtime),Lt.value=e.status,d.value.debuggedBusinessList.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus,J.value=!0},Ca=(e,t)=>{e.setStatus=!e.setStatus,!e.id&&!J.value?d.value.debuggedBusinessList.splice(t,1):e.id&&J.value&&(d.value.debuggedBusinessList=JSON.parse(JSON.stringify(X.debuggedBusinessList)))},wa=async e=>{var i,$,L,ce,K,de,De,E,O,ve,ie;if(!e.dtype){(i=window.$message)==null||i.warning("请选择权重");return}if(!e.debugname){($=window.$message)==null||$.warning("请输入业务名称");return}if(!e.docker){(L=window.$message)==null||L.warning("请选择或输入对接方");return}if(!e.dockcharge){(ce=window.$message)==null||ce.warning("请输入对接方负责人");return}if(!e.dockcontact){(K=window.$message)==null||K.warning("请输入对接方联系方式");return}if(!e.dbcreater){(de=window.$message)==null||de.warning("请选择调试人");return}const t=Ge(0,e.starttime),o=Ge(0,e.endtime);if(((De=e.fileList)==null?void 0:De.length)>0&&N.operateType=="edit"){const M=e.fileList.filter(Q=>Q.file),je=M.length;for(let Q=0;Q<je;Q++){const _e=M[Q];_e.indexText=`${Q+1}/${je}`,_e.progress=0,_e.status="uploading";try{_e.url=await Qe(_e.file.file,_e.file.name,""),_e.progress=100,_e.status="done"}catch{_e.status="error"}}e.fileList.forEach((Q,_e)=>{e[`re${_e+1}`]=Q.name||"",e[`fl${_e+1}`]=Q.url||""}),delete e.fileList}if(e.id){const M=JSON.parse(JSON.stringify(e));Lt.value==M.status&&delete M.status,M.docker=(E=M.docker)==null?void 0:E.split("&id=")[0];const{data:je,error:Q}=await $l([{...M,starttime:t,endtime:o}]);Q||((O=window.$message)==null||O.success("修改成功"),Xe(v.id),v.status=0,e.setStatus=!e.setStatus)}else if(N.operateType=="edit"){e.docker=(ve=e.docker)==null?void 0:ve.split("&id=")[0];const{data:M,error:je}=await Sa([{...e,starttime:t,endtime:o,pid:v.id}]);je||((ie=window.$message)==null||ie.success("添加成功"),Xe(v.id),e.setStatus=!e.setStatus,v.status=0,ue())}else e.setStatus=!e.setStatus,J.value=!1},Dt=h(!1);function Fa(){Dt.value=!0}const $a=()=>{const e=document.getElementById("__SCROLL_EL_ID__");e==null||e.scrollTo({top:0,behavior:"smooth"})},Xt=e=>{he[e].show=!he[e].show},Bt=e=>{const t=document.getElementById(e);t&&(t.scrollIntoView({behavior:"smooth",block:"start"}),Ce.value=e)},Nt=()=>{const e=[];he.forEach(i=>{i.tables.forEach(($,L)=>e.push(`${i.id}-${L}`))});const t=window.scrollY;let o="";for(const i of e){const $=document.getElementById(i);$&&$.offsetTop-100<=t&&(o=i)}Ce.value=o},Ne=h([]),Ct=h([]),wt=h([]),Ft=h([]),$t=h([]),Et=h([]),Zt=h({});async function Vt(e){const{data:t,error:o}=await Ul({limit:100,page:1,pid:e});o||(d.value.fileList=[],Ne.value=[],Ct.value=[],wt.value=[],Ft.value=[],$t.value=[],Et.value=[],Zt.value=t,console.log("data",Zt.value),t.list.forEach(i=>{i.sort==1&&d.value.fileList.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==2&&Ne.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==3&&Ct.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==4&&wt.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==5&&Ft.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==6&&$t.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime}),i.sort==7&&Et.value.push({id:i.id,name:i.filename,url:i.file.split("?")[0],filename:i.file.split("?")[1],status:"finished",creator:i.username,dbtime:i.dbtime})}),d.value.fileList.reverse(),Ne.value.reverse(),Ct.value.reverse(),wt.value.reverse(),Ft.value.reverse(),$t.value.reverse(),Et.value.reverse(),ue())}const Ta=e=>{const t=e.target,o=document.getElementById("__SCROLL_EL_ID__"),i=document.getElementById("scrollToTop");!o||!i||(t.scrollTop>(o.clientHeight||0)+500?i.classList.add("show"):i.classList.remove("show"))},mt=h(!1),ut=h(""),At=h(),Qt=(e,t,o)=>{lt.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}],mt.value=!0,ut.value=t,At.value=o,e.re1&&(lt.value[0]={name:e.re1,url:e.fl1,file:void 0}),e.re2&&(lt.value[1]={name:e.re2,url:e.fl2,file:void 0}),e.re3&&(lt.value[2]={name:e.re3,url:e.fl3,file:void 0}),e.re4&&(lt.value[3]={name:e.re4,url:e.fl4,file:void 0}),console.log(lt.value)},Ua=[{title:"",key:"",align:"center",render(e,t){return`附件${t+1}`}},{title:"文件名称",key:"filename",align:"center",render(e){var i;const t=async({file:$,onFinish:L,onError:ce})=>{var K,de;try{e.name=$.name,e.file=$}catch(De){console.error(De),(de=(K=window.$message)==null?void 0:K.error)==null||de.call(K,"文件上传出错")}};async function o($){var L;return $.file.file.size>100*1024*1024?((L=window.$message)==null||L.error("文件大小不能超过100M"),!1):!0}return a("div",{style:"display:flex;justify-content:center;align-items:center;"},[e.file||e.url?a("span",{},[a("span",{},((i=e.file)==null?void 0:i.name)||e.url.split("?")[1]||""),a("span",{style:"color:red;cursor:pointer;font-size:12px;margin-left:8px;",onClick:()=>{e.url="",e.file=null,e.name=""}},"删除")]):a(ht,{action:"#",showFileList:!1,customRequest:t,onBeforeUpload:o},{default:()=>a(z,{type:"info",size:"small",ghost:!0,loading:e.status},{default:()=>"上传文件"})})])}},{title:"文件别名",key:"name",align:"center",render(e){return a(re,{value:e.name,clearable:!0,onUpdateValue:t=>{e.name=t}})}}],lt=h([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]);async function ea(e){if(e!=null&&e.url)try{const o=await(await fetch(e.url.split("?")[0],{mode:"cors"})).blob(),i=URL.createObjectURL(o),$=document.createElement("a");$.href=i,$.download=e.url.split("?")[1],$.style.display="none",document.body.appendChild($),$.click(),document.body.removeChild($),URL.revokeObjectURL(i)}catch(t){console.error("下载失败:",t)}}const za=async()=>{var t,o;let e=!0;if(lt.value.forEach((i,$)=>{var K,de;const L=i.name||"",ce=((K=i.url)==null?void 0:K.split("?")[1])||((de=i.file)==null?void 0:de.name);(L&&!ce||!L&&ce)&&(e=!1)}),!e){(o=(t=window.$message)==null?void 0:t.error)==null||o.call(t,"文件名称和文件地址必须同时存在，不能只填一个");return}d.value[ut.value][At.value].fileList=lt.value,e&&(mt.value=!1,ut.value="",At.value=void 0)},ja=()=>{mt.value=!1};xa(async()=>{qe(),y.query.IsScroll&&setTimeout(()=>{Bt("phase2-0")},800),window.addEventListener("scroll",Nt);const e=document.getElementById("__SCROLL_EL_ID__");e&&e.addEventListener("scroll",Ta)}),sl(()=>{window.removeEventListener("scroll",Nt);const e=document.getElementById("__SCROLL_EL_ID__");e&&e.removeEventListener("scroll",Nt)});const Tt=h(["1","2","3"]),Pa=e=>{Tt.value=e},ta=h(["1","2","3","4"]),Ba=e=>{ta.value=e},Na=Kt(()=>({add:"新增项目调试单",edit:"修改项目调试单"})[N.operateType]),Ea=e=>{d.value.debuggedDevieceList=d.value.debuggedDevieceList.concat(e).map(t=>({...t,cid:t.cid*1,setStatus:!1})),F.value=!1},Va=e=>{d.value.debuggedBusinessList=d.value.debuggedBusinessList.concat(e).map(t=>({...t,setStatus:!1})),Dt.value=!1},aa=e=>{e.fileType==2?Ne.value=Ne.value.concat(e.row).map(t=>({...t})):d.value.fileList=d.value.fileList.concat(e.row).map(t=>({...t}))},la=e=>{e.fileType==2?Ne.value.splice(e.index,1):d.value.fileList.splice(e.index,1)},Mt=h();async function Aa(e=0){var t;await Mt.value[0].validate(),(t=window.$dialog)==null||t.info({title:"提示",content:"确定保存并提交吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await na(e)}})}const it=h(!1);async function na(e=0){var t,o,i,$,L,ce;if(!it.value)try{if(await Mt.value[0].validate(),it.value=!0,N.operateType==="edit"){const K=JSON.parse(JSON.stringify(e==1?{...v,status:e}:{...v})),{data:de,error:De}=await bl([K]);De||((t=window.$message)==null||t.success("保存成功"),te("returnandSub"))}else{if(d.value.debuggedDevieceList.length>0)for(const E of d.value.debuggedDevieceList){if(!E.fileList||E.fileList.length===0)continue;const O=E.fileList.filter(ie=>ie.file),ve=O.length;for(let ie=0;ie<ve;ie++){const M=O[ie];M.indexText=`${ie+1}/${ve}`,M.progress=0,M.status="uploading";try{M.url=await Qe(M.file.file,M.file.name,""),M.progress=100,M.status="done"}catch{M.status="error",(i=(o=window.$message)==null?void 0:o.error)==null||i.call(o,"文件上传失败，请重试");return}}E.fileList.forEach((ie,M)=>{const je=`re${M+1}`,Q=`fl${M+1}`;ie.status==="done"?(E[je]=ie.name||"",E[Q]=ie.url||""):(E[je]="",E[Q]="")}),delete E.fileList}if(d.value.debuggedBusinessList.length>0)for(const E of d.value.debuggedBusinessList){if(!E.fileList||E.fileList.length===0)continue;const O=E.fileList.filter(ie=>ie.file),ve=O.length;for(let ie=0;ie<ve;ie++){const M=O[ie];M.indexText=`${ie+1}/${ve}`,M.progress=0,M.status="uploading";try{M.url=await Qe(M.file.file,M.file.name,""),M.progress=100,M.status="done"}catch{M.status="error",(L=($=window.$message)==null?void 0:$.error)==null||L.call($,"文件上传失败，请重试");return}}E.fileList.forEach((ie,M)=>{const je=`re${M+1}`,Q=`fl${M+1}`;ie.status==="done"?(E[je]=ie.name||"",E[Q]=ie.url||""):(E[je]="",E[Q]="")}),delete E.fileList}if(d.value.fileList.length>0){const E=d.value.fileList.length;for(let O=0;O<E;O++){const ve=d.value.fileList[O];if(!(!ve.file||typeof ve.file!="object"))try{ve.url=await Qe(ve.file,ve.name,"",ie=>{})}catch{}}d.value.fileList=d.value.fileList.map(O=>({...O,file:O.url}))}if(Ne.value.length>0){const E=Ne.value.length;for(let O=0;O<E;O++){const ve=Ne.value[O];if(!(!ve.file||typeof ve.file!="object"))try{ve.url=await Qe(ve.file,ve.name,"",ie=>{})}catch{}}Ne.value=Ne.value.map(O=>({...O,file:O.url}))}const K=e==1?{...v,status:e}:{...v},{data:de,error:De}=await hl({projectFormPojo:K,projectFormContactPojoList:d.value.contactList,projectFormDebugPojos:d.value.debuggedBusinessList,projectFormEquipmentPojoList:d.value.debuggedDevieceList,projectFormFilePojos:d.value.fileList.concat(Ne.value)});de&&((ce=window.$message)==null||ce.success(de||"添加成功"),te("returnandSub"))}}catch(K){console.error("提交失败:",K)}finally{it.value=!1}}return(e,t)=>{const o=Ml,i=El,$=ol,L=qa,ce=Ra,K=pa,de=da,De=ca,E=Ja,O=Ha,ve=xt,ie=cl,M=yt("no-auth"),je=yt("loading");return T(),q(nt,null,[s($,{bordered:!1,size:"small",class:"card-wrapper"},{default:p(()=>[I("div",sn,[I("h2",on,se(Na.value),1),I("div",rn,[s(S(z),{ghost:"",type:"primary",onClick:Ut(Oe,["stop"])},{icon:p(()=>[s(o,{class:"text-icon"})]),default:p(()=>[t[16]||(t[16]=j(" 返回 "))]),_:1,__:[16]}),s(S(z),{type:"primary",onClick:t[0]||(t[0]=Q=>na()),loading:it.value},{icon:p(()=>[s(i,{class:"text-icon"})]),default:p(()=>[t[17]||(t[17]=j(" "+se("保存")))]),_:1,__:[17]},8,["loading"]),v.status==0?(T(),ke(S(z),{key:0,type:"primary",onClick:t[1]||(t[1]=Q=>Aa(1)),loading:it.value},{icon:p(()=>[s(i,{class:"text-icon"})]),default:p(()=>[t[18]||(t[18]=j(" "+se("保存并提交")))]),_:1,__:[18]},8,["loading"])):W("",!0)])])]),_:1}),s(ie,{style:{height:"calc(100vh - 182px)"}},{default:p(()=>[st((T(),q("div",un,[I("div",{id:"scrollToTop",onClick:$a,title:"回到顶部"},[s(L,{class:"font-size-30px"})]),s($,{bordered:!1,size:"small",class:"card-wrapper pb-40px"},{default:p(()=>[I("div",dn,[I("div",cn,[I("div",pn,[(T(!0),q(nt,null,ra(he,(Q,_e)=>(T(),q("div",{key:Q.id,class:"timeline-phase"},[I("div",{class:"timeline-row",id:"phase"+(_e+1)},[I("div",gn,[t[19]||(t[19]=I("div",{class:"vertical-line"},null,-1)),I("div",{class:"flashing-icon",onClick:Re=>Xt(_e)},null,8,vn)]),I("div",mn,[I("div",{class:"phase-title",onClick:Re=>Xt(_e)},se(Q.title),9,yn),s(S(Ve))])],8,fn),s(rl,{name:"fade"},{default:p(()=>[st(I("div",hn,[_e===0?(T(),q("div",bn,[s(nn,{ref_for:!0,ref_key:"prjDetailRef",ref:Mt,onSubmit:Je,prjInfo:v,"onUpdate:prjInfo":t[2]||(t[2]=Re=>v=Re),onChangePrj:ze,"operate-type":N.operateType},null,8,["prjInfo","operate-type"])])):W("",!0),(T(!0),q(nt,null,ra(Q.tables,(Re,ft)=>(T(),q("div",{key:`${Q.id}-${ft}`,class:"timeline-row"},[I("div",_n,[t[20]||(t[20]=I("div",{class:"vertical-line"},null,-1)),Re.type==1?(T(),q("div",{key:0,class:ul(["icon",{active:Ce.value===`${Q.id}-${ft}`}]),style:{"font-size":"20px",border:"3px solid #409eff",color:"#409eff"},onClick:ee=>Bt(`${Q.id}-${ft}`)},[s(ce)],10,kn)):(T(),q("div",{key:1,class:"icon",style:{"font-size":"20px",border:"3px solid #ccc",color:"#ccc"},onClick:ee=>Bt(`${Q.id}-${ft}`)}," 一 ",8,xn))]),I("div",{class:"actProgress",style:qt({background:Re.type==1?"#409eff":"#ccc"})},null,4),I("div",{class:"timeline-content",id:`${Q.id}-${ft}`},[_e===0?(T(),q(nt,{key:0},[s(O,{"expanded-names":Tt.value,"onUpdate:expandedNames":Pa,"trigger-areas":["arrow"]},{default:p(()=>[Re.id==1?(T(),ke(E,{key:0,name:"1"},{header:p(()=>[s(S(Ve),{align:"center",justify:"space-between",style:{width:"100%"}},{default:p(()=>[I("div",Sn,[t[22]||(t[22]=I("span",null,"项目联系人",-1)),st((T(),ke(S(z),{size:"small",ghost:"",type:"primary",class:"pos-absolute left-140px",onClick:Ut(xe,["stop"])},{icon:p(()=>[s(K,{class:"text-icon"})]),default:p(()=>[t[21]||(t[21]=j(" 添加项目联系人 "))]),_:1,__:[21]})),[[M,"project:Form:Contact:insert"]])]),G.itemCount>0?(T(),q("div",Dn,"共"+se(G.itemCount)+"条",1)):W("",!0)]),_:1})]),default:p(()=>[d.value.contactList.length>0?(T(),ke(S(ot),{key:0,columns:Ae,data:d.value.contactList,size:"small","scroll-x":702,"row-key":ee=>ee.id,"paginate-single-page":!1,"max-height":350,pagination:G.pageSize==1?!1:G,remote:""},null,8,["data","row-key","pagination"])):W("",!0),G.itemCount>1?(T(),q("div",Cn,[d.value.contactList.length==1?(T(),q("span",{key:0,onClick:Z},[t[23]||(t[23]=j("更多")),s(de,{class:"font-size-20px"})])):(T(),q("span",{key:1,onClick:Z},[t[24]||(t[24]=j("收起")),s(De,{class:"font-size-20px"})]))])):W("",!0)]),_:1})):W("",!0),Re.id==2?(T(),ke(E,{key:1,title:"待调试设备",name:"2"},{header:p(()=>[s(S(Ve),{align:"center",justify:"space-between",style:{width:"100%"}},{default:p(()=>[I("div",wn,[t[26]||(t[26]=I("span",null,"待调试设备",-1)),st((T(),ke(S(z),{size:"small",ghost:"",type:"primary",class:"pos-absolute left-140px",onClick:Ut(D,["stop"])},{icon:p(()=>[s(K,{class:"text-icon"})]),default:p(()=>[t[25]||(t[25]=j(" 添加待调试设备 "))]),_:1,__:[25]})),[[M,"project:Equipment:insert"]])]),_.itemCount>0?(T(),q("div",Fn,"共"+se(_.itemCount)+"条",1)):W("",!0)]),_:1})]),default:p(()=>[s(Ql,{onSubmitted:t[3]||(t[3]=ee=>{f(v.id),v.status=0}),onSubmittedData:t[4]||(t[4]=ee=>Ea(ee)),visible:F.value,"onUpdate:visible":t[5]||(t[5]=ee=>F.value=ee),"operate-type":N.operateType,pid:v.id,proid:v.proid},null,8,["visible","operate-type","pid","proid"]),d.value.debuggedDevieceList.length>0?(T(),ke(S(ot),{key:0,style:qt({width:S(Y).siderCollapse?"calc(100vw - 219px)":"calc(100vw - 375px)"}),columns:c,data:d.value.debuggedDevieceList,size:"small","scroll-x":c.reduce((ee,It)=>ee+It.width,0),"row-key":ee=>ee.id,"max-height":350,pagination:_.pageSize==1?!1:_,remote:"","paginate-single-page":!1},null,8,["style","data","scroll-x","row-key","pagination"])):W("",!0),_.itemCount>1?(T(),q("div",$n,[d.value.debuggedDevieceList.length==1?(T(),q("span",{key:0,onClick:m},[t[27]||(t[27]=j("更多")),s(de,{class:"font-size-20px"})])):(T(),q("span",{key:1,onClick:m},[t[28]||(t[28]=j("收起")),s(De,{class:"font-size-20px"})]))])):W("",!0)]),_:2},1024)):W("",!0),Re.id==3?(T(),ke(E,{key:2,title:"图纸",name:"3"},{default:p(()=>[s(ua,{data:d.value.fileList,onRemoveData:t[6]||(t[6]=ee=>la(ee)),pid:v.id,"operate-type":N.operateType,onGetData:t[7]||(t[7]=ee=>{Vt(v.id),v.status=0}),typename:"图纸",onSubmittedData:t[8]||(t[8]=ee=>aa(ee)),fileType:1},null,8,["data","pid","operate-type"])]),_:1})):W("",!0)]),_:2},1032,["expanded-names"]),Re==4?(T(),q("div",Tn)):W("",!0)],64)):W("",!0),_e===1?(T(),q(nt,{key:1},[s(O,{"expanded-names":ta.value,"onUpdate:expandedNames":Ba,"trigger-areas":["arrow"]},{default:p(()=>[Re.id==1?(T(),ke(E,{key:0,title:"待调试业务",name:"1"},{header:p(()=>[s(S(Ve),{align:"center",justify:"space-between",style:{width:"100%"}},{default:p(()=>[I("div",Un,[t[30]||(t[30]=I("span",null,[j("待调试业务 "),I("span",{class:"c-#f0a020 font-bold"},"※")],-1)),st((T(),ke(S(z),{size:"small",ghost:"",type:"primary",class:"pos-absolute left-140px",onClick:Ut(Fa,["stop"])},{icon:p(()=>[s(K,{class:"text-icon"})]),default:p(()=>[t[29]||(t[29]=j(" 添加待调试业务 "))]),_:1,__:[29]})),[[M,"project:Debug:insert"]])]),Se.itemCount>0?(T(),q("div",zn,"共"+se(Se.itemCount)+"条",1)):W("",!0)]),_:1})]),default:p(()=>[s(Zl,{onSubmitted:t[9]||(t[9]=ee=>{Xe(v.id),v.status=0}),visible:Dt.value,"onUpdate:visible":t[10]||(t[10]=ee=>Dt.value=ee),"operate-type":N.operateType,pid:v.id,contactList:d.value.contactList,debuggedDevieceList:d.value.debuggedDevieceList,onSubmittedData:t[11]||(t[11]=ee=>Va(ee))},null,8,["visible","operate-type","pid","contactList","debuggedDevieceList"]),d.value.debuggedBusinessList.length>0?(T(),ke(S(ot),{key:0,style:qt({width:S(Y).siderCollapse?"calc(100vw - 219px)":"calc(100vw - 375px)"}),columns:pt,data:d.value.debuggedBusinessList,size:"small","row-key":ee=>ee.id,striped:"","scroll-x":pt.reduce((ee,It)=>ee+It.width,0),"paginate-single-page":!1,pagination:Se.pageSize==1?!1:Se,remote:"","max-height":350},null,8,["style","data","row-key","scroll-x","pagination"])):W("",!0),Se.itemCount>1?(T(),q("div",jn,[d.value.debuggedBusinessList.length==1?(T(),q("span",{key:0,onClick:St},[t[31]||(t[31]=j(" 更多 ")),s(de,{class:"font-size-20px"})])):(T(),q("span",{key:1,onClick:St},[t[32]||(t[32]=j(" 收起 ")),s(De,{class:"font-size-20px"})]))])):W("",!0)]),_:1})):W("",!0),Re.id===2?(T(),ke(E,{key:1,title:"文件",name:"2"},{default:p(()=>[s(ua,{data:Ne.value,onRemoveData:t[12]||(t[12]=ee=>la(ee)),pid:v.id,onGetData:t[13]||(t[13]=ee=>{Vt(v.id),v.status=0}),typename:"项目文件",onSubmittedData:t[14]||(t[14]=ee=>aa(ee)),"operate-type":N.operateType,fileType:2},null,8,["data","pid","operate-type"])]),_:1})):W("",!0)]),_:2},1032,["expanded-names"]),ft===2?(T(),q("div",Pn)):W("",!0)],64)):W("",!0)],8,Ln)]))),128))],512),[[dl,Q.show]])]),_:2},1024)]))),128))])])])]),_:1}),s(ve,{show:mt.value,"onUpdate:show":t[15]||(t[15]=Q=>mt.value=Q),preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{header:p(()=>[j(se(ut.value=="debuggedDevieceList"?"待调试设备":ut.value=="debuggedBusinessList"?"待调试业务":ut.value=="needsList"?"客户需求变更":ut.value=="developBusinessList"?"需要开发":"")+" 文件列表 ",1)]),footer:p(()=>[s(S(Ve),{justify:"end"},{default:p(()=>[s(S(z),{size:"small",class:"mt-16px",onClick:ja},{default:p(()=>[j(se(S(ae)("common.cancel")),1)]),_:1}),s(S(z),{type:"primary",size:"small",class:"mt-16px",onClick:za},{default:p(()=>[j(se(S(ae)("common.confirm")),1)]),_:1})]),_:1})]),default:p(()=>[s(S(ot),{columns:Ua,"paginate-single-page":!1,data:lt.value,"max-height":350},null,8,["data"])]),_:1},8,["show"])])),[[je,it.value]])]),_:1})],64)}}}),Nn=va(Bn,[["__scopeId","data-v-2df6c773"]]),Xn=Object.freeze(Object.defineProperty({__proto__:null,default:Nn},Symbol.toStringTag,{value:"Module"}));export{Wn as a,bl as b,Yn as f,Xn as i,Nn as p};
