import{_ as De}from"./table-column-setting.vue_vue_type_script_setup_true_lang-DT7Xw6BF.js";import{_ as Ne}from"./round-delete-f0Ex9oqZ.js";import{_ as Ue}from"./round-add-CR1MGL-O.js";import{d as re,aE as oe,m as fe,r as ze,H as R,bY as se,n as me,a as $e,aG as ge,aC as Pe,d5 as qe,d6 as Be,c as x,o as _,w as l,f as t,a0 as Re,C as ve,h as n,aD as _e,v as F,b as X,s as te,g as w,e as B,t as b,aI as Ie,B as N,aJ as Le,y as ie,$ as M,a1 as Fe,cu as he,aO as ye,aQ as Me,A as Oe,Z as we,aS as Ve,i as Ae,q as ne,aT as ae,aH as Ee,x as le,aU as Ge,d7 as ue,d8 as He,ae as Ke,aY as Ye}from"./index-K-Oe9yen.js";import{u as Je,a as Qe}from"./table-BjKQTj5z.js";import{u as be}from"./usePageData-Cn0zOp5N.js";import{_ as ke}from"./Grid-Iszn1RIZ.js";import{_ as Ce}from"./FormItemGridItem-B3wj0zec.js";import{_ as Ze}from"./round-search-C4uw-VPp.js";import{_ as We}from"./round-refresh-Cm__CFcQ.js";import{N as pe}from"./Popconfirm-CR5sQlbC.js";const Xe={key:0,style:{"margin-left":"20px"}},et={key:0,style:{"margin-left":"20px"}},tt={key:0,style:{"margin-left":"20px"}},at={key:0,style:{"margin-left":"20px"}},lt=re({name:"OperateDrawer",__name:"operate-drawer",props:oe({operateType:{},rowData:{},pid:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:oe(["submitted"],["update:visible"]),setup(z,{emit:K}){const $=fe(),I=K,k=z,e=ze(S());R();function S(){return{pid:void 0,id:"",reqcontent:"",customer:"",cstcontact:"",notes:"",re1:"",re2:"",re3:"",re4:"",fl1:"",fl2:"",fl3:"",fl4:""}}const d=R([]),{pageData:g,getData:h,nextPage:Y}=be(he),O=async o=>{const a=o.currentTarget,c=a.scrollTop;a.scrollTop+a.offsetHeight>=a.scrollHeight&&g.data.length<g.total&&(await Y(),d.value=g.data,await ye(),setTimeout(()=>{a.scrollTop=c}))},J=async()=>{await h({fuzzy:$.userInfo.pname,page:1}),d.value=g.data},Q=se.debounce(async o=>{await h({fuzzy:o,page:1}),d.value=g.data},300),P=R(!1),q=R(!1),U=o=>{if(e.pid=null,P.value=!0,q.value=!1,!o){V();return}Q(o)},Z=async()=>{P.value&&!q.value&&(await h({page:1}),d.value=g.data,P.value=!1)},V=async()=>{await h({page:1}),d.value=g.data},ee=async o=>{e.pid=o,q.value=!0};async function W(){var o;J(),Object.assign(e,S()),e.pid=k.pid?k.pid:(o=d.value[0])==null?void 0:o.id,k.operateType==="edit"&&k.rowData&&Object.assign(e,k.rowData)}const{formRef:G,validate:u,restoreValidation:p}=me(),j={pid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择"},reqcontent:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},customer:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},cstcontact:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"}},f=$e(()=>({add:"新增需求变更",edit:"修改需求变更"})[k.operateType]),s=ge(z,"visible");async function m(o){if(o)try{const c=await(await fetch(o==null?void 0:o.split("?")[0],{mode:"cors"})).blob(),C=URL.createObjectURL(c),D=document.createElement("a");D.href=C,D.download=o==null?void 0:o.split("?")[1],D.style.display="none",document.body.appendChild(D),D.click(),document.body.removeChild(D),URL.revokeObjectURL(C)}catch(a){console.error("下载失败:",a)}}Pe(s,()=>{s.value&&(W(),setTimeout(()=>{const o=document.querySelector(".n-scrollbar-content");o==null||o.scrollTo(0,0)},300),p())});const i=R(0),v=R("");async function L({file:o},a){i.value=0,v.value=a;const c=await Me(o.file,o.name,"",C=>{i.value=C});c&&(e[a]=c,i.value=0)}function A(){s.value=!1}async function E(o){var a;return o.file.file.size>100*1024*1024?((a=window.$message)==null||a.error("文件大小不能超过100M"),!1):!0}const H=se.debounce(async()=>{await T()},1e3,{leading:!0,trailing:!1});async function T(){var o,a;if(await u(),k.operateType==="edit"){const{data:c,error:C}=await qe([e]);C||(A(),I("submitted"),(o=window.$message)==null||o.success("修改成功"))}else{const{data:c,error:C}=await Be([{...e}]);C||(A(),I("submitted"),(a=window.$message)==null||a.success("添加成功"))}}return(o,a)=>{const c=Ce,C=Ie,D=Le,ce=ke,xe=ve,Se=Re,je=ie,Te=Fe;return _(),x(Te,{show:s.value,"onUpdate:show":a[17]||(a[17]=r=>s.value=r),title:f.value,preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{footer:l(()=>[t(je,{justify:"end",size:16},{default:l(()=>[t(n(N),{onClick:A},{default:l(()=>[w(b(n(M)("common.cancel")),1)]),_:1}),t(n(N),{type:"primary",onClick:n(H)},{default:l(()=>[w(b(n(M)("common.confirm")),1)]),_:1},8,["onClick"])]),_:1})]),default:l(()=>[t(Se,{class:"pr-20px"},{default:l(()=>[t(xe,{ref_key:"formRef",ref:G,model:e,rules:j,"label-placement":"left","label-width":120},{default:l(()=>[t(ce,{responsive:"screen","item-responsive":""},{default:l(()=>[t(c,{span:"24 m:12",label:"项目列表",path:"pid"},{default:l(()=>[t(n(_e),{clearable:"",filterable:"",value:e.pid,"onUpdate:value":[a[0]||(a[0]=r=>e.pid=r),ee],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:V,onSearch:U,onBlur:Z,options:d.value,onScroll:O},null,8,["value","options"])]),_:1}),t(c,{span:"24 m:12",label:"需求内容",path:"reqcontent"},{default:l(()=>[t(n(F),{value:e.reqcontent,"onUpdate:value":a[1]||(a[1]=r=>e.reqcontent=r),placeholder:"请输入"},null,8,["value"])]),_:1}),t(c,{span:"24 m:12",label:"客户联系人",path:"customer"},{default:l(()=>[t(n(F),{value:e.customer,"onUpdate:value":a[2]||(a[2]=r=>e.customer=r),placeholder:"请输入"},null,8,["value"])]),_:1}),t(c,{span:"24 m:12",label:"联系方式",path:"cstcontact"},{default:l(()=>[t(n(F),{value:e.cstcontact,"onUpdate:value":a[3]||(a[3]=r=>e.cstcontact=r),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),t(c,{span:"24 m:12",label:"备注",path:"notes"},{default:l(()=>[t(n(F),{value:e.notes,"onUpdate:value":a[4]||(a[4]=r=>e.notes=r),placeholder:"请输入"},null,8,["value"])]),_:1}),t(c,{span:"24 m:24",label:"",path:"notes","show-feedback":!1},{default:l(()=>[t(ce,{responsive:"screen","item-responsive":""},{default:l(()=>[t(c,{span:"24 m:12",label:"附件1",path:"notes"},{default:l(()=>[t(n(F),{value:e.re1,"onUpdate:value":a[5]||(a[5]=r=>e.re1=r),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(c,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var r;return[e.fl1?(_(),X("span",Xe,[w(b((r=e.fl1)==null?void 0:r.split("?")[1])+" ",1),B("span",{class:"cursor-pointer c-#c92a2a",onClick:a[6]||(a[6]=y=>e.fl1="")},"删除"),B("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[7]||(a[7]=y=>m(e.fl1))},"下载")])):(_(),x(C,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":y=>L(y,"fl1"),"show-file-list":!1,onBeforeUpload:E},{default:l(()=>[t(n(N),{loading:i.value>0&&!e.fl1&&v.value=="fl1",size:"small",ghost:"",type:"primary"},{default:l(()=>[w(b(i.value>0&&!e.fl1&&v.value=="fl1"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),i.value&&!e.fl1&&v.value=="fl1"?(_(),x(D,{key:2,type:"line",percentage:i.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):te("",!0)]}),_:1})]),_:1})]),_:1}),t(c,{span:"24 m:12",label:"附件2",path:"notes"},{default:l(()=>[t(n(F),{value:e.re2,"onUpdate:value":a[8]||(a[8]=r=>e.re2=r),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(c,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var r;return[e.fl2?(_(),X("span",et,[w(b((r=e.fl2)==null?void 0:r.split("?")[1])+" ",1),B("span",{class:"cursor-pointer c-#c92a2a",onClick:a[9]||(a[9]=y=>e.fl2="")},"删除"),B("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[10]||(a[10]=y=>m(e.fl2))},"下载")])):(_(),x(C,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":y=>L(y,"fl2"),"show-file-list":!1,onBeforeUpload:E},{default:l(()=>[t(n(N),{loading:i.value>0&&!e.fl2&&v.value=="fl2",size:"small",ghost:"",type:"primary"},{default:l(()=>[w(b(i.value>0&&!e.fl2&&v.value=="fl2"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),i.value&&!e.fl2&&v.value=="fl2"?(_(),x(D,{key:2,type:"line",percentage:i.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):te("",!0)]}),_:1}),t(c,{span:"24 m:12",label:"附件3",path:"notes"},{default:l(()=>[t(n(F),{value:e.re3,"onUpdate:value":a[11]||(a[11]=r=>e.re3=r),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(c,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var r;return[e.fl3?(_(),X("span",tt,[w(b((r=e.fl3)==null?void 0:r.split("?")[1])+" ",1),B("span",{class:"cursor-pointer c-#c92a2a",onClick:a[12]||(a[12]=y=>e.fl3="")},"删除"),B("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[13]||(a[13]=y=>m(e.fl3))},"下载")])):(_(),x(C,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":y=>L(y,"fl3"),"show-file-list":!1,onBeforeUpload:E},{default:l(()=>[t(n(N),{loading:i.value>0&&!e.fl3&&v.value=="fl3",size:"small",ghost:"",type:"primary"},{default:l(()=>[w(b(i.value>0&&!e.fl3&&v.value=="fl3"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),i.value&&!e.fl3&&v.value=="fl3"?(_(),x(D,{key:2,type:"line",percentage:i.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):te("",!0)]}),_:1}),t(c,{span:"24 m:12",label:"附件4",path:"notes"},{default:l(()=>[t(n(F),{value:e.re4,"onUpdate:value":a[14]||(a[14]=r=>e.re4=r),placeholder:"请输入",style:{width:"250px"}},null,8,["value"])]),_:1}),t(c,{span:"24 m:12",label:"",path:"notes"},{default:l(()=>{var r;return[e.fl4?(_(),X("span",at,[w(b((r=e.fl4)==null?void 0:r.split("?")[1])+" ",1),B("span",{class:"cursor-pointer c-#c92a2a",onClick:a[15]||(a[15]=y=>e.fl4="")},"删除"),B("span",{class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:a[16]||(a[16]=y=>m(e.fl4))},"下载")])):(_(),x(C,{key:1,style:{width:"auto","margin-left":"20px"},ref:"uploadRef",action:"#","custom-request":y=>L(y,"fl4"),"show-file-list":!1},{default:l(()=>[t(n(N),{loading:i.value>0&&!e.fl4&&v.value=="fl4",size:"small",ghost:"",type:"primary"},{default:l(()=>[w(b(i.value>0&&!e.fl4&&v.value=="fl4"?"上传中":"选择文件"),1)]),_:1},8,["loading"])]),_:1},8,["custom-request"])),i.value&&!e.fl4&&v.value=="fl4"?(_(),x(D,{key:2,type:"line",percentage:i.value,"indicator-placement":"inside",processing:""},null,8,["percentage"])):te("",!0)]}),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),nt=re({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:oe(["reset","search","clear"],["update:model"]),setup(z,{emit:K}){const $=K,{formRef:I,restoreValidation:k}=me(),e=ge(z,"model"),S=fe(),d=R([]),{pageData:g,getData:h,nextPage:Y}=be(he),O=async u=>{const p=u.currentTarget,j=p.scrollTop;p.scrollTop+p.offsetHeight>=p.scrollHeight&&g.data.length<g.total&&(await Y(),d.value=g.data,await ye(),setTimeout(()=>{p.scrollTop=j}))},J=async u=>{var p;q.value=!0,u?(e.value.pid=u,$("search"),S.setProjectInfo({pname:(p=d.value.find(j=>j.id==u))==null?void 0:p.proname,pid:u})):$("clear")},Q=se.debounce(async u=>{await h({fuzzy:u,page:1}),d.value=g.data},300),P=R(!1),q=R(!1),U=u=>{if(e.value.pid=null,P.value=!0,q.value=!1,!u){V();return}Q(u)},Z=async()=>{P.value&&!q.value&&(await h({page:1}),d.value=g.data,P.value=!1)},V=async()=>{await h({page:1}),d.value=g.data};(async()=>{var u,p;await h({fuzzy:S.userInfo.pname}),d.value=g.data,e.value.pid=S.userInfo.pid?S.userInfo.pid:(u=d.value[0])==null?void 0:u.id,S.setProjectInfo({pid:e.value.pid,pname:(p=d.value.find(j=>j.id==e.value.pid))==null?void 0:p.proname}),$("search")})();async function W(){await k(),e.value.fuzzy="",$("reset")}async function G(){var u,p;e.value.pid?$("search"):((u=window.$message)==null||u.destroyAll(),(p=window.$message)==null||p.warning("请选择项目"))}return(u,p)=>{const j=_e,f=Ce,s=We,m=N,i=Ze,v=ie,L=ke,A=ve,E=we;return _(),x(E,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[t(A,{ref_key:"formRef",ref:I,model:e.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Oe(G,["enter"])},{default:l(()=>[t(L,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:l(()=>[t(f,{span:"24 s:12 m:6",label:"项目列表",path:"PrjId"},{default:l(()=>[t(j,{filterable:"",clearable:"",value:e.value.pid,"onUpdate:value":[p[0]||(p[0]=H=>e.value.pid=H),J],placeholder:"请选择项目","label-field":"proname","value-field":"id",options:d.value,onScroll:O,onClear:V,onSearch:U,onBlur:Z},null,8,["value","options"])]),_:1}),t(f,{span:"24  s:12 m:6",class:"pr-24px"},{default:l(()=>[t(v,{class:"w-full"},{default:l(()=>[t(m,{onClick:W},{icon:l(()=>[t(s,{class:"text-icon"})]),default:l(()=>[w(" "+b(n(M)("common.reset")),1)]),_:1}),t(m,{type:"primary",ghost:"",onClick:G},{icon:l(()=>[t(i,{class:"text-icon"})]),default:l(()=>[w(" "+b(n(M)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),ot={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function de(z){return typeof z=="function"||Object.prototype.toString.call(z)==="[object Object]"&&!Ye(z)}const _t=re({name:"projectmanagement_needchange",__name:"index",setup(z){const K=Ve(),{columns:$,columnChecks:I,data:k,getData:e,loading:S,pagination:d,mobilePagination:g,searchParams:h}=Je({showTotal:!0,immediate:!1,apiFn:He,apiParams:{page:1,pageSize:20,limit:20,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"reqcontent",title:"需求内容",align:"center",width:120},{key:"customer",title:"客户联系人",align:"center",width:120},{key:"cstcontact",title:"联系方式",align:"center",width:120},{key:"cstresult",title:"结果",align:"center",width:120,render(f){return Ke("div",{},f.cstresult==0?"失败":f.cstresult==1?"成功":"")}},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"操作人",align:"center",width:120},{key:"dbtime",title:"操作时间",align:"center",width:120},{key:"operate",title:M("common.operate"),align:"center",width:140,fixed:"right",render:f=>{let s;return t("div",{class:"flex-center gap-8px"},[le(t(N,{type:"primary",ghost:!0,size:"small",onClick:()=>G(f.id)},de(s=M("common.edit"))?s:{default:()=>[s]}),[[ne("no-auth"),"project:Customer:update"]]),t(pe,{onPositiveClick:()=>W(f.id)},{default:()=>M("common.confirmDelete"),trigger:()=>{let m;return le(t(N,{type:"error",ghost:!0,size:"small"},de(m=M("common.delete"))?m:{default:()=>[m]}),[[ne("no-auth"),"project:Customer:delete"]])}})])}}]}),Y=()=>{k.value=[],d.itemCount=0},{drawerVisible:O,operateType:J,editingData:Q,handleAdd:P,handleEdit:q,checkedRowKeys:U,onBatchDeleted:Z,onDeleted:V}=Qe(k,e);Ae(async()=>{});async function ee(){console.log(U.value),u(U.value.join(","),f=>{Z()})}async function W(f){const{data:s,error:m}=await ue(f,h.pid);m||V()}function G(f){q(f)}async function u(f,s){const{data:m,error:i}=await ue(f,h.pid);if(!i)s&&s(m);else return!1}const p=f=>{e()},j=()=>{e()};return(f,s)=>{const m=ie,i=Ue,v=Ne,L=De,A=Ee,E=we,H=ne("no-auth");return _(),X("div",ot,[t(nt,{model:n(h),"onUpdate:model":s[0]||(s[0]=T=>ae(h)?h.value=T:null),onReset:j,onSearch:n(e),onClear:Y},null,8,["model","onSearch"]),t(E,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:l(()=>[t(m,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:l(()=>s[4]||(s[4]=[B("div",null,"需求变更",-1)])),_:1,__:[4]})]),"header-extra":l(()=>[t(m,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:l(()=>[le((_(),x(n(N),{onClick:n(P),size:"small",ghost:"",type:"primary"},{icon:l(()=>[t(i,{class:"text-icon"})]),default:l(()=>[s[5]||(s[5]=w(" "+b("新增")))]),_:1,__:[5]},8,["onClick"])),[[H,"project:Customer:insert"]]),t(n(pe),{onPositiveClick:ee},{trigger:l(()=>[le((_(),x(n(N),{size:"small",ghost:"",type:"error",disabled:n(U).length==0},{icon:l(()=>[t(v,{class:Ge(["text-icon",{"animate-spin":n(S)}])},null,8,["class"])]),default:l(()=>[s[6]||(s[6]=w(" "+b("批量删除")))]),_:1,__:[6]},8,["disabled"])),[[H,"project:Customer:delete"]])]),default:l(()=>[s[7]||(s[7]=w(" 确定要删除选中的吗？ "))]),_:1,__:[7]}),t(L,{columns:n(I),"onUpdate:columns":s[1]||(s[1]=T=>ae(I)?I.value=T:null)},null,8,["columns"])]),_:1})]),default:l(()=>[t(A,{"checked-row-keys":n(U),"onUpdate:checkedRowKeys":s[2]||(s[2]=T=>ae(U)?U.value=T:null),columns:n($),data:n(k),size:"small","flex-height":!n(K).isMobile,loading:n(S),remote:"","row-key":T=>T.id,pagination:n(g),class:"sm:h-full","onUpdate:filters":p},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),t(lt,{visible:n(O),"onUpdate:visible":s[3]||(s[3]=T=>ae(O)?O.value=T:null),onSubmitted:n(e),pid:n(h).pid,"operate-type":n(J),"row-data":n(Q)},null,8,["visible","onSubmitted","pid","operate-type","row-data"])]),_:1})])}}});export{_t as default};
