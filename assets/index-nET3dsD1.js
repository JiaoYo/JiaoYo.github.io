import{_ as de}from"./round-search-Bo3FaEpc.js";import{d as oe,M as me,r as T,a as V,av as se,i as re,dP as ve,b as E,o as w,e as b,y as j,aU as ie,aY as ce,g as B,t as Y,cL as pe,aQ as fe,W as ge,aK as he,X as ue,L as ye,b0 as le,eE as be,f7 as we,f as m,aT as ke,aA as Fe,w as C,c as O,h,aB as Te,N as xe,z as _e,aw as De,aE as ne,B as Me,$ as Ce,U as Ee,aJ as Ae,b5 as $e,aV as Se}from"./index-C1b7XuIM.js";import{d as Oe}from"./home-CucI16Er.js";import{u as Be}from"./usePageData-DJD0HzyT.js";import{N as te}from"./RadioButton-BOXJdfR8.js";import{N as ae}from"./DatePicker-1VWc3FRs.js";const je={class:"map-wrapper",style:{height:"100%",position:"relative"}},ze={class:"map-legend"},Ne={class:"legend-list"},Pe=["onClick","onContextmenu"],Ue={key:0,class:"visibility-icon"},Ve={key:1,class:"solo-icon"},Le={class:"legend-name"},We={class:"visibility-toggle"},Ie={key:0,class:"solo-notice"},Re=oe({__name:"historyMap",props:{trackData:{}},setup($){const Z=me(),u=T(null);let A=null;const L=$,p=T([]),o=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],d=T({}),f=T(""),x=V(()=>{const t={};return Object.keys(p.value).forEach((s,n)=>{t[s]=o[n%o.length],d.value[s]===void 0&&(d.value[s]=!0)}),t});function H(t){if(f.value){z(t);return}d.value[t]=!d.value[t],M()}function z(t){f.value===t?S():(f.value=t,Object.keys(d.value).forEach(e=>{d.value[e]=e===t}),M())}function S(){f.value="",Object.keys(d.value).forEach(t=>{d.value[t]=!0}),M()}function K(){Object.keys(d.value).forEach(t=>{d.value[t]=!d.value[t]}),f.value="",M()}function q(){Object.keys(d.value).forEach(t=>{d.value[t]=!0}),f.value="",M()}function W(){Object.keys(d.value).forEach(t=>{d.value[t]=!1}),f.value="",M()}const N=V(()=>{const t=[];return Object.values(p.value).forEach(e=>{t.push(...e)}),t.sort((e,s)=>new Date(e.dbtime).getTime()-new Date(s.dbtime).getTime())}),P=V(()=>{if(N.value.length===0)return[120.370086,30.305716];const t=N.value.map(i=>i.longitude),e=N.value.map(i=>i.latitude),s=(Math.min(...t)+Math.max(...t))/2,n=(Math.min(...e)+Math.max(...e))/2;return console.log(s,n),[s,n]});async function I(){const t="/map-sdk.json",{data:e}=await he.get(`${t}?_t=${Date.now()}`);return e}function _(t){return new Promise((e,s)=>{if(window.AMap)return e(window.AMap);const n=document.createElement("script");n.src=`https://webapi.amap.com/maps?v=2.0&key=${t}&plugin=AMap.PolylineEditor`,n.defer=!0,n.onload=()=>window.AMap?e(window.AMap):s(new Error("AMapåŠ è½½å¤±è´¥")),n.onerror=()=>s(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(n)})}const k=T({});function G(t,e){const s=e.lng-t.lng,n=e.lat-t.lat;return(Math.atan2(-n,s)*180/Math.PI-90+360)%360-175}function J(t,e,s,n){const i=document.createElement("div");return i.style.cssText=`
    width: 12px;
    height: 18px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 18px solid ${n};
    transform: translate(-50%, -50%) rotate(${s}deg);
    transform-origin: center center;
  `,new t.Marker({position:[e.lng,e.lat],content:i,offset:new t.Pixel(0,0)})}function Q(t,e,s,n,i){const r=document.createElement("div");return r.className="custom-marker",r.style.transform="translate(calc(-50% + 4px),-120%)",r.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${n};box-shadow: 0 0 5px ${n}, 0 0 6px ${n};">
      <img src="${i||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png"}" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${n};">${s}</div>
  `,new t.Marker({position:[e.lng,e.lat],content:r})}function R(){u.value&&u.value.clearMap(),k.value={}}function M(){!window.AMap||!u.value||Object.keys(k.value).forEach(t=>{const e=d.value[t];(k.value[t]||[]).forEach(n=>{e?n.show():n.hide()})})}function a(t){if(!u.value)return;R();const e={};Object.entries(p.value).forEach(([n,i])=>{e[n]=i.map(r=>({lng:r.longitude,lat:r.latitude,address:r.address,dbtime:r.dbtime,proname:r.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:r.duration||0,userimage:r.userimage,longitude:r.longitude,latitude:r.latitude}))}),Object.keys(e).forEach(n=>{const i=e[n],r=x.value[n];if(i.length===0)return;const g=[];if(i.length>1){const v=new t.Polyline({path:i.map(F=>[F.lng,F.lat]),strokeColor:r,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});v.setMap(u.value),g.push(v)}i.forEach((v,F)=>{new t.Marker({position:[v.longitude,v.latitude],content:'<div class="marker-dot"></div>',anchor:"center",offset:new t.Pixel(0,0)}).setMap(u.value);const D=Q(t,v,n,r,i[0].userimage);D.setMap(u.value),g.push(D),D.on("click",()=>{const X=`
          <div style="min-width:220px; background:#fff; padding:12px 14px; font-size:13px; color:#333; line-height:1.6">
            <div style="font-weight:bold; color:${r}; font-size:15px; margin-bottom:6px; border-bottom:1px solid #f0f0f0; padding-bottom:4px">
              ${n}
            </div>
            <div><b style="color:#555">åœ°ç‚¹ï¼š</b>${v.address}</div>
            <div><b style="color:#555">æ—¶é—´ï¼š</b>${v.dbtime}</div>
            <div><b style="color:#555">é¡¹ç›®ï¼š</b>${v.proname}</div>
            <div><b style="color:#555">ç»çº¬åº¦ï¼š</b><span style="font-size:12px;color:#666">${v.longitude}, ${v.latitude}</span></div>

          </div>
          <div style="margin-top:8px; text-align:right; font-size:12px; color:#999">ç¬¬ ${F+1} ä¸ªæ‰“å¡ç‚¹</div>
        `;A.setContent(X),A.setOffset(new t.Pixel(4,-60)),A.open(u.value,D.getPosition())}),D.on("dblclick",()=>{A.open(u.value,D.getPosition()),u.value.setCenter(D.getPosition()),u.value.setZoom(14)})});for(let v=1;v<i.length;v++){const F=i[v-1],U=i[v];if(c(F,U))continue;const D={lng:(F.lng+U.lng)/2,lat:(F.lat+U.lat)/2},X=G(F,U),ee=J(t,D,X,r);ee.isArrow=!0,ee.setMap(u.value),g.push(ee)}Object.keys(e).length==1&&u.value.setFitView(g,!1,[60,60,60,60]),k.value[n]=g});const s=()=>{const i=u.value.getZoom()>=7,r=l(k.value,d.value);Object.values(r).forEach(g=>{g==null||g.forEach(v=>{v.isArrow&&(i?v.show():v.hide())})})};u.value.on("zoomend",s),s(),Object.keys(k.value).forEach(n=>{(k.value[n]||[]).forEach(r=>{r.isArrow||(d.value[n]?r.show():r.hide())})})}function l(t,e){const s={};for(const n in t)e[n]&&(s[n]=t[n]);return s}function c(t,e,s=1e-7){return Math.abs(t.lng-e.lng)<s&&Math.abs(t.lat-e.lat)<s}async function y(){try{const t=await I(),e=await _(t.AMAP_SDK_KEY);u.value=new e.Map("amap-container",{viewMode:"2D",center:P.value,zoom:5,features:["bg","point"]}),Z.themeScheme==="dark"&&u.value.setMapStyle("amap://styles/dark"),e.plugin(["AMap.Scale","AMap.ToolBar"],()=>{u.value.addControl(new e.Scale),u.value.addControl(new e.ToolBar)}),u.value.on("zoomend",()=>{const n=u.value.getZoom()>=12,i=l(k.value,d.value);Object.values(i).forEach(r=>{r.forEach(g=>{g.isArrow&&(n?g.show():g.hide())})})}),A=new e.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),a(e)}catch(t){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",t)}}return se(()=>L.trackData??[],t=>{console.log(t,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),p.value=t,window.AMap&&u.value&&a(window.AMap)},{immediate:!0,deep:!0}),re(()=>{y()}),ve(()=>{u.value&&u.value.destroy()}),(t,e)=>(w(),E("div",je,[e[1]||(e[1]=b("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),b("div",ze,[b("div",{class:"legend-header"},[e[0]||(e[0]=b("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),b("div",{class:"legend-actions"},[b("button",{class:"action-btn",onClick:q},"å…¨æ˜¾"),b("button",{class:"action-btn",onClick:W},"å…¨éš"),b("button",{class:"action-btn",onClick:K},"åé€‰")])]),b("div",Ne,[(w(!0),E(ie,null,ce(x.value,(s,n)=>(w(),E("div",{key:n,class:fe(["legend-item",{"legend-item-hidden":!d.value[n],"legend-item-solo":f.value===n}]),onClick:i=>H(n),onContextmenu:pe(i=>z(n),["prevent"])},[b("div",{class:"legend-color",style:ge({backgroundColor:s})},[d.value[n]?j("",!0):(w(),E("span",Ue,"ğŸ‘ï¸â€ğŸ—¨ï¸")),f.value===n?(w(),E("span",Ve,"â­")):j("",!0)],4),b("span",Le,Y(n),1),b("span",We,Y(d.value[n]?"éšè—":"æ˜¾ç¤º"),1)],42,Pe))),128))]),f.value?(w(),E("div",Ie,[B(" ä»…æ˜¾ç¤º: "+Y(f.value)+" ",1),b("button",{class:"cancel-solo-btn",onClick:S},"å–æ¶ˆ")])):j("",!0)])]))}}),Ye=ue(Re,[["__scopeId","data-v-d0b55314"]]),Ze={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function He($){return typeof $=="function"||Object.prototype.toString.call($)==="[object Object]"&&!Se($)}const Ke=oe({name:"trajectory_historytrajectory",__name:"index",setup($){const Z=ye();function u(a){return a.getFullYear()}function A(a){const l=new Date(a.getFullYear(),0,1),c=(a.getTime()-l.getTime())/864e5,y=l.getDay()||7;return Math.ceil((c+y)/7)}function L(){const a=new Date,l=u(a),c=A(a).toString().padStart(2,"0");return`${l}-${c}å‘¨`}const p=T("week"),o=T({dayTime:String(le(0,null)),monthTime:String(le(3,null)),weekTime:L(),startTime:null,endTime:null,dates:null,creater:null}),d=T([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),f=T("table"),x=T({}),H=V(()=>Object.keys(x.value||{}).map(a=>{var l,c;return{key:a,name:a,userimage:(c=(l=x.value[a])==null?void 0:l[0])==null?void 0:c.userimage}})),z=V(()=>{const a=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left",render(c){return m("div",{class:"text-blue-600 flex-col items-center font-medium"},[m(ke,{width:"60",height:"60","preview-disabled":!0,src:c.userimage||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png",class:"rounded-md object-cover"},null),m("span",null,[c.name])])}}];let l=[];switch(p.value){case"week":o.value.startTime&&o.value.endTime&&(l=we(o.value.startTime,o.value.endTime).map(y=>S(y)));break;case"month":o.value.monthTime&&(l=be(o.value.monthTime).map(y=>S(y)));break;case"day":default:o.value.dayTime&&(l=[S(o.value.dayTime)]);break}return[...a,...l]}),S=a=>({title:K(a),key:a,width:300,align:"center",render:l=>q(l.name,a)}),K=a=>{const l=new Date(a),c=l.getMonth()+1,y=l.getDate(),t=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][l.getDay()];return`${c}/${y} å‘¨${t}`},q=(a,l)=>{let c;const t=(x.value[a]||[]).filter(e=>e.daytime===l);return t.length===0?m("div",{class:"text-gray-400 text-sm"},[B("æ— è®°å½•")]):m("div",{class:"text-left space-y-1"},[m(Fe,{style:"max-height: 250px;",trigger:"none"},He(c=t.map((e,s)=>m("div",{key:s,class:"tableItem p-1 border-b border-gray-100 last:border-b-0"},[m("div",null,[B("é¡¹ç›®ï¼š"),m("span",{class:""},[e.proname||"æš‚æ— é¡¹ç›®"])]),m("div",null,[B("åœ°å€ï¼š "),m("span",{class:""},[e.address])]),m("div",null,[B("æ‰“å¡æ—¶é—´ï¼š"),m("span",{class:""},[e.dbtime])])])))?c:{default:()=>[c]})])},W=a=>{const l=a.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!l)return null;const c=Number(l[1]),y=Number(l[2]),t=new Date(c,0,1+(y-1)*7),e=t.getDay(),s=new Date(t);e<=4?s.setDate(t.getDate()-t.getDay()+1):s.setDate(t.getDate()+8-t.getDay());const n=new Date(s);n.setDate(s.getDate()+6);const i=r=>{const g=r.getFullYear(),v=String(r.getMonth()+1).padStart(2,"0"),F=String(r.getDate()).padStart(2,"0");return`${g}-${v}-${F}`};return{start:i(s),end:i(n)}},N=a=>{x.value={},p.value=a,I()},P=a=>{I(a),_()},I=a=>{switch(p.value){case"week":if(a){const l=W(a);l&&(o.value.startTime=l.start,o.value.endTime=l.end)}break;case"month":o.value.dates=a||o.value.monthTime;break;case"day":default:o.value.dates=a||o.value.dayTime;break}},_=async()=>{try{const a={};o.value.creater&&(a.creater=o.value.creater),p.value==="week"?(a.startTime=o.value.startTime,a.endTime=o.value.endTime):p.value==="month"?a.dates=o.value.monthTime:a.dates=o.value.dayTime;const{data:l,error:c}=await Oe(a);c||(x.value=l)}catch(a){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",a)}},{pageData:k,getData:G,nextPage:J}=Be($e),Q=async a=>{const l=a.currentTarget,c=l.scrollTop;l.scrollTop+l.offsetHeight>=l.scrollHeight&&k.data.length<k.total&&(await J(),await Ae(),setTimeout(()=>{l.scrollTop=c}))},R=T(1),M=async a=>{o.value.creater=a,a||setTimeout(()=>{R.value++},500),_()};return se([p,()=>o.value.dates],()=>{if(p.value=="week"&&o.value.weekTime){const a=W(o.value.weekTime);a&&(o.value.startTime=a.start,o.value.endTime=a.end),_()}else(p.value=="month"&&o.value.monthTime||p.value=="day"&&o.value.dayTime)&&_()},{immediate:!0}),re(()=>{o.value.weekTime=L(),G({usertypes:"2,3"}),_()}),(a,l)=>{const c=De,y=_e,t=de;return w(),E("div",Ze,[m(h(Ee),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:C(()=>[m(h(xe),{align:"center"},{default:C(()=>[l[6]||(l[6]=b("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),m(y,{label:"ç”¨æˆ·",path:"creater","label-placement":"left","show-feedback":!1},{default:C(()=>[m(c,{clearable:"",filterable:"",value:o.value.creater,"onUpdate:value":[l[0]||(l[0]=e=>o.value.creater=e),M],placeholder:"è¯·é€‰æ‹©","label-field":"username",size:"small","value-field":"id",options:h(k).data,onScroll:Q},null,8,["value","options"])]),_:1}),m(h(ne),{value:p.value,"onUpdate:value":[l[1]||(l[1]=e=>p.value=e),N],size:"small"},{default:C(()=>[(w(!0),E(ie,null,ce(d.value,e=>(w(),O(h(te),{key:e.value,value:e.value,label:e.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),p.value==="day"?(w(),O(h(ae),{key:0,size:"small","formatted-value":o.value.dayTime,"onUpdate:formattedValue":[l[2]||(l[2]=e=>o.value.dayTime=e),P],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):j("",!0),p.value==="week"?(w(),O(h(ae),{key:1,size:"small","formatted-value":o.value.weekTime,"onUpdate:formattedValue":[l[3]||(l[3]=e=>o.value.weekTime=e),P],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):j("",!0),p.value==="month"?(w(),O(h(ae),{key:2,size:"small","formatted-value":o.value.monthTime,"onUpdate:formattedValue":[l[4]||(l[4]=e=>o.value.monthTime=e),P],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):j("",!0),m(h(Me),{type:"primary",onClick:_,size:"small",class:"w-full sm:w-auto"},{icon:C(()=>[m(t,{class:"text-icon"})]),default:C(()=>[B(" "+Y(h(Ce)("common.search")),1)]),_:1}),m(h(ne),{size:"small",value:f.value,"onUpdate:value":l[5]||(l[5]=e=>f.value=e),name:"radiobuttongroup1"},{default:C(()=>[m(h(te),{value:"table",label:"è¡¨æ ¼"}),m(h(te),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:C(()=>[f.value=="table"?(w(),O(h(Te),{key:0,columns:z.value,data:H.value,size:"small","flex-height":!h(Z).isMobile,"scroll-x":z.value.reduce((e,s)=>e+s.width,0),remote:"","row-key":e=>e.key,class:"h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","row-key"])):(w(),O(Ye,{trackData:x.value,key:R.value},null,8,["trackData"]))]),_:1})])}}}),tt=ue(Ke,[["__scopeId","data-v-b6785915"]]);export{tt as default};
