import{_ as $e}from"./table-header-operation.vue_vue_type_script_setup_true_lang-LQXhcny6.js";import{d as Y,dF as Ee,j as $,aM as ie,F as pe,bd as me,dG as fe,dH as _e,bb as Z,bX as Ie,aj as re,cn as Ae,r as xe,o as M,e as te,f as E,q as ue,s as Te,v as Re,x as Ue,b as je,y as ze,bl as ve,bk as ye,L as ae,c as J,w as a,g as e,h as p,t as w,i as n,$ as U,M as V,ah as he,V as j,O as Pe,av as Le,H as Be,bn as Ve,aV as Fe,A as Ce,C as ge,bY as Ke,Y as Ge,D as Ne,S as He,B as W,E as De,bm as Se,N as Je,aa as de,a0 as We,ad as ee}from"./index-BAVDbSG0.js";import{e as Ye,g as Qe,f as Xe,h as Ze,i as et,j as be,k as tt}from"./reportForm-BxN-DHwA.js";import{f as at,i as Oe}from"./scheduleTask-B1Ze7-Ao.js";import{u as nt,a as ot}from"./table-KJ4OXJa6.js";import{T as ce,a as qe,S as Me}from"./task-qDBTAl0-.js";import{a as st,b as lt,_ as it}from"./DataTable-BDYCfsCN.js";import{_ as rt}from"./TimePicker-DQ_q4WUT.js";import{_ as ut}from"./round-search-Bcb0t4Jv.js";import{_ as dt}from"./round-refresh-yP8uig6G.js";import{_ as ct}from"./FormItemGridItem-xXViKYEE.js";import{_ as pt}from"./Grid-BDOf_ubP.js";import{h as ke}from"./permission-CLrEu3_U.js";import{_ as mt}from"./Popconfirm-CUDFKPM8.js";import{_ as ft,a as _t}from"./DescriptionsItem-DmDsjMQ-.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-C9U6osR4.js";import"./setting-outlined-D3n2FZ9Z.js";import"./round-delete-DS0ILC9q.js";import"./refresh-C3aYfWsn.js";import"./round-plus-BaLKVTfF.js";import"./Upload-B9yETaen.js";import"./Progress-CaLEcM5E.js";import"./Forward-edmZhOxW.js";import"./defineProperty-CaBVv32k.js";const vt=Y({name:"ModalEnvironment",props:Object.assign(Object.assign({},Ee),{internalKey:{type:String,required:!0},onInternalAfterLeave:{type:Function,required:!0}}),setup(m){const y=$(!0);function c(){const{onInternalAfterLeave:o,internalKey:f,onAfterLeave:t}=m;o&&o(f),t&&t()}function i(){const{onPositiveClick:o}=m;o?Promise.resolve(o()).then(f=>{f!==!1&&u()}):u()}function g(){const{onNegativeClick:o}=m;o?Promise.resolve(o()).then(f=>{f!==!1&&u()}):u()}function v(){const{onClose:o}=m;o?Promise.resolve(o()).then(f=>{f!==!1&&u()}):u()}function N(o){const{onMaskClick:f,maskClosable:t}=m;f&&(f(o),t&&u())}function D(){const{onEsc:o}=m;o&&o()}function u(){y.value=!1}function x(o){y.value=o}return{show:y,hide:u,handleUpdateShow:x,handleAfterLeave:c,handleCloseClick:v,handleNegativeClick:g,handlePositiveClick:i,handleMaskClick:N,handleEsc:D}},render(){const{handleUpdateShow:m,handleAfterLeave:y,handleMaskClick:c,handleEsc:i,show:g}=this;return ie(pe,Object.assign({},this.$props,{show:g,onUpdateShow:m,onMaskClick:c,onEsc:i,onAfterLeave:y,internalAppear:!0,internalModal:!0}))}}),we=me("n-modal-provider"),yt=me("n-modal-api"),ht=me("n-modal-reactive-list"),gt={to:[String,Object]},bt=Y({name:"ModalProvider",props:gt,setup(){const m=fe(64),y=_e(),c=$([]),i={};function g(u={}){const x=Ae(),o=xe(Object.assign(Object.assign({},u),{key:x,destroy:()=>{var f;(f=i[`n-modal-${x}`])===null||f===void 0||f.hide()}}));return c.value.push(o),o}function v(u){const{value:x}=c;x.splice(x.findIndex(o=>o.key===u),1)}function N(){Object.values(i).forEach(u=>{u==null||u.hide()})}const D={create:g,destroyAll:N};return Z(yt,D),Z(we,{clickedRef:fe(64),clickedPositionRef:_e()}),Z(ht,c),Z(we,{clickedRef:m,clickedPositionRef:y}),Object.assign(Object.assign({},D),{modalList:c,modalInstRefs:i,handleAfterLeave:v})},render(){var m,y;return ie(re,null,[this.modalList.map(c=>{var i;return ie(vt,Ie(c,["destroy"],{to:(i=c.to)!==null&&i!==void 0?i:this.to,ref:g=>{g===null?delete this.modalInstRefs[`n-modal-${c.key}`]:this.modalInstRefs[`n-modal-${c.key}`]=g},internalKey:c.key,onInternalAfterLeave:this.handleAfterLeave}))}),(y=(m=this.$slots).default)===null||y===void 0?void 0:y.call(m)])}}),kt={class:"inline-block",viewBox:"0 0 24 24",width:"1em",height:"1em"},wt=E("path",{fill:"currentColor",d:"M12 22q-3.475-.875-5.738-3.988T4 11.1V5l8-3l8 3v6.1q0 3.8-2.262 6.913T12 22m0-2.1q2.6-.825 4.3-3.3t1.7-5.5V6.375l-6-2.25l-6 2.25V11.1q0 3.025 1.7 5.5t4.3 3.3m0-2.9q.425 0 .738-.312t.312-.738t-.312-.737T12 14.9t-.737.313t-.313.737t.313.738T12 17m.025-3.1q.3 0 .538-.225t.237-.525q.025-.175.075-.337t.15-.313q.175-.25.388-.45t.412-.4q.425-.425.738-.95t.312-1.15q0-1.125-.862-1.838T12 7q-.8 0-1.475.375T9.45 8.425q-.15.275-.037.55t.412.4q.275.125.55-.012T10.85 9q.225-.275.513-.412T12 8.45q.55 0 .963.325t.412.825q0 .425-.262.788t-.588.662q-.275.275-.55.538t-.475.587q-.125.2-.175.45t-.05.5q0 .325.212.55t.538.225"},null,-1),xt=[wt];function Tt(m,y){return M(),te("svg",kt,[...xt])}const Rt={name:"material-symbols-shield-question-outline-rounded",render:Tt},Ct=E("span",null,[p("报表统计的周期为： "),E("span",{class:"c-#1890ff"},"前一天"),p(" / "),E("span",{class:"c-#1890ff"},"上周周一至周日"),p(" / "),E("span",{class:"c-#1890ff"},"上个月"),p(" / "),E("span",{class:"c-#1890ff"},"上周周日至周六")],-1),Nt=Y({name:"TaskModal",__name:"task_modal",props:ue({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:ue(["submitted"],["update:visible"]),setup(m,{expose:y,emit:c}){const i=m,g=c,v=Te(m,"visible"),{formRef:N,validate:D,restoreValidation:u}=Re(),{defaultRequiredRule:x,patternRules:o}=Ue(),f=je(()=>({add:"新增任务",edit:"编辑任务"})[i.operateType]),t=xe(z());function z(){return{id:void 0,rname:"",rtype:0,ttype:0,starttime:void 0,endtime:void 0,excute:1,stype:0,recipient:"",rdesc:"",tid:void 0}}const P={rname:x,starttime:x,cron:x,rtype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择实例"},ttype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择任务类型"},stype:{type:"number",required:!0,trigger:["input","blur"],message:"请选择发送类型"},recipient:{required:!0,validator:Le,trigger:["input","change","blur","password-input"]}},S=$(""),F=async()=>{var R,k;const{data:h,error:l}=await Oe((R=i.rowData)==null?void 0:R.tid);if(!l){const T=Se(h==null?void 0:h.cronExpression);S.value=(k=JSON.parse(h==null?void 0:h.params))==null?void 0:k.uuid,t.starttime=T==null?void 0:T.settingTime}};function K(){Object.assign(t,z()),O.value=Be(),i.operateType==="edit"&&i.rowData&&(i.rowData.starttime=i.rowData.starttime.substring(11,19),Object.assign(t,i.rowData),F())}function L(){v.value=!1}const O=$(""),I=async h=>{const{data:l,error:R}=await Xe({beanName:"ReportTask",remark:O.value,cronExpression:h,params:JSON.stringify({rtype:t.rtype,ttype:t.ttype,uuid:O.value})});return R?!1:(await b(),!0)},b=async()=>{const{data:h,error:l}=await Ze({uuid:O.value});t.tid=h};async function ne(){var l,R;await D();const h=Ve(t.ttype==1||t.ttype==3?{dayOfWeek:t.excute,time:t.starttime}:null,t.ttype==2?{dayOfMonth:t.excute,time:t.starttime}:null,t.ttype==0?{time:t.starttime}:null);if(i.operateType==="add"){if(!await I(h))return!1}else{const{data:k,error:T}=await at({id:t.tid,cronExpression:h,beanName:"ReportTask",status:1,params:JSON.stringify({rtype:t.rtype,ttype:t.ttype,uuid:S.value})});if(T)return!1}if(t.ttype==0&&delete t.excute,i.operateType==="add"){const{data:k,error:T}=await Ye({...t,starttime:Fe(1,new Date)});T||((l=window.$message)==null||l.success(U("common.addSuccess")),L(),g("submitted"))}else{delete t.starttime;const{data:k,error:T}=await Qe({...t});T||((R=window.$message)==null||R.success(U("common.updateSuccess")),L(),g("submitted"))}}const Q=h=>{t.excute=1};return ze(v,()=>{v.value&&(K(),u())}),y({monthOption:ve,weekOption:ye}),(h,l)=>{const R=Ce,k=ge,T=lt,G=st,_=Ke,r=Ge,C=rt,A=ge,q=Ne,oe=He,X=W,se=De,le=pe,d=ae("no-space");return M(),J(le,{show:v.value,"onUpdate:show":l[8]||(l[8]=s=>v.value=s),title:f.value,preset:"card",class:"w-600px"},{footer:a(()=>[e(se,{justify:"end",size:16},{default:a(()=>[e(X,{onClick:L},{default:a(()=>[p(w(n(U)("common.cancel")),1)]),_:1}),e(X,{type:"primary",onClick:ne},{default:a(()=>[p(w(n(U)("common.confirm")),1)]),_:1})]),_:1})]),default:a(()=>[e(oe,{class:"max-h-520px pr-20px"},{default:a(()=>[e(q,{ref_key:"formRef",ref:N,model:t,rules:P,"label-placement":"left","label-width":110,"require-mark-placement":"left"},{default:a(()=>[e(k,{label:"任务名称",path:"rname"},{default:a(()=>[V(e(R,{value:t.rname,"onUpdate:value":l[0]||(l[0]=s=>t.rname=s),placeholder:"请输入任务名称",clearable:""},null,8,["value"]),[[d]])]),_:1}),e(k,{label:"实例选择",path:"rtype"},{default:a(()=>[e(G,{value:t.rtype,"onUpdate:value":l[1]||(l[1]=s=>t.rtype=s),name:"radiogroup"},{default:a(()=>[(M(!0),te(re,null,he(n(j)(n(ce)),(s,B)=>(M(),J(T,{key:B,value:s.value},{default:a(()=>[p(w(s.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),e(k,{label:"任务类型",path:"ttype"},{label:a(()=>[p(" 任务类型 "),e(_,{trigger:"hover",placement:"top-start"},{trigger:a(()=>[e(n(Rt),{class:"text-xl cursor-pointer c-#7a7b78"})]),default:a(()=>[Ct]),_:1})]),default:a(()=>[e(G,{value:t.ttype,"onUpdate:value":[l[2]||(l[2]=s=>t.ttype=s),Q],name:"radiogroup"},{default:a(()=>[(M(!0),te(re,null,he(n(j)(n(qe)),(s,B)=>(M(),J(T,{key:B,value:s.value},{default:a(()=>[p(w(s.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),[1,2,3].includes(t.ttype)?(M(),J(k,{key:0,label:t.ttype==2?"每月":"每周",path:"excute"},{default:a(()=>[e(r,{filterable:"",value:t.excute,"onUpdate:value":l[3]||(l[3]=s=>t.excute=s),placeholder:"请选择",options:t.ttype==2?n(ve)():n(ye)(),style:{width:"100%"}},null,8,["value","options"])]),_:1},8,["label"])):Pe("",!0),e(A,{label:"执行时间",path:"starttime"},{default:a(()=>[e(C,{"formatted-value":t.starttime,"onUpdate:formattedValue":l[4]||(l[4]=s=>t.starttime=s),placeholder:"选择执行时间"},null,8,["formatted-value"])]),_:1}),e(k,{label:"收件人",path:"recipient"},{default:a(()=>[V(e(R,{value:t.recipient,"onUpdate:value":l[5]||(l[5]=s=>t.recipient=s),placeholder:"请输入收件人",clearable:""},null,8,["value"]),[[d]])]),_:1}),e(k,{label:"发送类型",path:"stype"},{default:a(()=>[e(r,{filterable:"",value:t.stype,"onUpdate:value":l[6]||(l[6]=s=>t.stype=s),placeholder:"请选择发送类型",options:n(j)(n(Me)),style:{width:"100%"}},null,8,["value","options"])]),_:1}),e(k,{label:"任务描述",path:"rdesc"},{default:a(()=>[V(e(R,{type:"textarea",value:t.rdesc,"onUpdate:value":l[7]||(l[7]=s=>t.rdesc=s),placeholder:"请输入任务描述",clearable:""},null,8,["value"]),[[d]])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Dt=Y({name:"TaskSearch",__name:"task_search",props:{model:{required:!0},modelModifiers:{}},emits:ue(["reset","search"],["update:model"]),setup(m,{emit:y}){const c=y,{formRef:i,restoreValidation:g}=Re(),v=Te(m,"model");function N(){v.value.fuzzy=void 0,c("search")}async function D(){await g(),c("reset")}async function u(){c("search")}return(x,o)=>{const f=Ce,t=ct,z=dt,P=W,S=ut,F=De,K=pt,L=Ne,O=de,I=ae("no-space");return M(),J(O,{bordered:!1,size:"small",class:"card-wrapper"},{default:a(()=>[e(L,{ref_key:"formRef",ref:i,model:v.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Je(u,["enter"])},{default:a(()=>[e(K,{responsive:"screen","item-responsive":""},{default:a(()=>[e(t,{span:"24 s:12 m:6",label:"任务名称",path:"fuzzy",class:"pr-24px"},{default:a(()=>[V(e(f,{value:v.value.fuzzy,"onUpdate:value":o[0]||(o[0]=b=>v.value.fuzzy=b),placeholder:"请输入任务名称关键字",clearable:"",onClear:N},null,8,["value"]),[[I]])]),_:1}),e(t,{span:"24 m:6",class:"pr-24px"},{default:a(()=>[e(F,{class:"w-full"},{default:a(()=>[e(P,{onClick:D},{icon:a(()=>[e(z,{class:"text-icon"})]),default:a(()=>[p(" "+w(n(U)("common.reset")),1)]),_:1}),e(P,{type:"primary",ghost:"",onClick:u},{icon:a(()=>[e(S,{class:"text-icon"})]),default:a(()=>[p(" "+w(n(U)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),St={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ot=E("div",{style:{display:"flex","align-items":"center"}},[E("div",null,"报表任务")],-1),ta=Y({name:"reportmanagement_reporttask",__name:"index",setup(m){const y=We(),{columns:c,columnChecks:i,data:g,getData:v,loading:N,mobilePagination:D,searchParams:u,resetSearchParams:x}=nt({apiFn:et,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"rname",title:"任务名称",align:"center",width:160},{key:"rtype",title:"实例类型",align:"center",width:160,render:_=>{var r;return e("div",null,[(r=j(ce).find(C=>C.value===_.rtype))==null?void 0:r.label])}},{key:"starttime",title:"创建时间",align:"center",width:160},{key:"operate",title:U("common.operate"),align:"center",width:160,render:_=>e("div",{class:"flex-center gap-8px"},[e(bt,null,{default:()=>[e(W,{type:"info",ghost:!0,size:"small",onClick:()=>ne(_.id)},{default:()=>[p("详情")]})]}),V(e(W,{type:"warning",ghost:!0,size:"small",onClick:()=>R(_.id)},{default:()=>[p("修改")]}),[[ae("no-auth"),"sys.report.task.update"]]),e(mt,{onPositiveClick:()=>k(_.id)},{default:()=>"确定要删除改数据吗？",trigger:()=>V(e(W,{type:"error",ghost:!0,size:"small"},{default:()=>[p("删除")]}),[[ae("no-auth"),"sys.report.task.delete"]])})])}]}),{drawerVisible:o,operateType:f,editingData:t,handleAdd:z,handleEdit:P,checkedRowKeys:S,onBatchDeleted:F,onDeleted:K,closeDrawer:L}=ot(g,v),O=$(),I=$(!1),b=$({id:void 0,rname:"",rtype:0,ttype:0,starttime:void 0,endtime:void 0,excute:0,stype:0,recipient:"",rdesc:"",tid:void 0}),ne=async _=>{I.value=!0;const{data:r,error:C}=await be(_);C||(b.value=r,h(r.tid+""))},Q=$(""),h=async _=>{const{data:r,error:C}=await Oe(_);if(!C){const A=Se(r.cronExpression);Q.value=A.settingTime}},l=$();async function R(_){const{data:r,error:C}=await be(_);C||(l.value=r),P(_)}function k(_){G(_,r=>{K()})}async function T(){G(S.value.join(","),_=>{F()})}async function G(_,r){const{data:C,error:A}=await tt(_);A||r&&r(C)}return(_,r)=>{const C=$e,A=it,q=ft,oe=_t,X=de,se=pe,le=de;return M(),te("div",St,[e(Dt,{model:n(u),"onUpdate:model":r[0]||(r[0]=d=>ee(u)?u.value=d:null),onReset:n(x),onSearch:n(v)},null,8,["model","onReset","onSearch"]),e(le,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:a(()=>[Ot]),"header-extra":a(()=>[e(C,{columns:n(i),"onUpdate:columns":r[1]||(r[1]=d=>ee(i)?i.value=d:null),"disabled-delete":n(S).length===0,loading:n(N),onAdd:n(z),onRefresh:n(v),"is-view-add-button":n(ke)("sys.report.task.insert"),isViewDeleteButton:n(ke)("sys.report.task.delete"),onDelete:T},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","isViewDeleteButton"])]),default:a(()=>[e(A,{"checked-row-keys":n(S),"onUpdate:checkedRowKeys":r[2]||(r[2]=d=>ee(S)?S.value=d:null),columns:n(c),data:n(g),size:"small","flex-height":!n(y).isMobile,"scroll-x":962,loading:n(N),remote:"","row-key":d=>d.id,pagination:n(D),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),e(Nt,{ref_key:"TaskModalRef",ref:O,visible:n(o),"onUpdate:visible":r[3]||(r[3]=d=>ee(o)?o.value=d:null),"operate-type":n(f),"row-data":l.value,onSubmitted:n(v)},null,8,["visible","operate-type","row-data","onSubmitted"]),e(se,{show:I.value,"onUpdate:show":r[4]||(r[4]=d=>I.value=d),preset:"card",class:"w-500px",title:"报表任务详情"},{default:a(()=>[e(X,null,{default:a(()=>[e(oe,{"label-placement":"left",column:1,"label-style":{width:"100px",display:"inline-block",textAlign:"right",marginRight:"10px"}},{default:a(()=>[e(q,{label:"任务名称"},{default:a(()=>[p(w(b.value.rname),1)]),_:1}),e(q,{label:"实例"},{default:a(()=>{var d;return[p(w((d=n(j)(n(ce)).find(s=>s.value===b.value.rtype))==null?void 0:d.label),1)]}),_:1}),e(q,{label:"创建时间"},{default:a(()=>[p(w(b.value.starttime),1)]),_:1}),e(q,{label:"任务执行周期"},{default:a(()=>{var d,s,B;return[p(w((d=n(j)(n(qe)).find(H=>H.value===b.value.ttype))==null?void 0:d.label)+" "+w(b.value.ttype==1?(s=O.value.weekOption().find(H=>H.value==b.value.excute))==null?void 0:s.label:b.value.ttype==2?(B=O.value.monthOption().find(H=>H.value==b.value.excute))==null?void 0:B.label:"")+" "+w(Q.value),1)]}),_:1}),e(q,{label:"发送类型"},{default:a(()=>{var d;return[p(w((d=n(j)(n(Me)).find(s=>s.value===b.value.stype))==null?void 0:d.label),1)]}),_:1}),e(q,{label:"收件人"},{default:a(()=>[p(w(b.value.recipient),1)]),_:1}),e(q,{label:"描述"},{default:a(()=>[p(w(b.value.rdesc),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])]),_:1})])}}});export{ta as default};
