import{_ as le}from"./table-column-setting.vue_vue_type_script_setup_true_lang-B_t19Lcg.js";import{_ as oe}from"./round-search-Ce_xNZWD.js";import{d as ce,bx as ie,g as o,aR as T,aU as re,b0 as A,z as de,ak as ue,m as k,av as pe,A as J,J as L,b2 as $,b3 as j,b4 as F,aE as M,ac as _e,o as he,b as me,w as p,h as O,f as l,an as fe,E as ge,B as ye,ag as ve,e as W,Q as ke,D as be,by as we,t as xe,aq as G,al as Se,N as Te,as as $e,R as De,S as Ne,at as ze,a7 as qe,_ as Ce}from"./index-vQQ96wkD.js";import{u as Ie,a as Ee}from"./table-BS1p_ZL1.js";import{a as Pe,p as Ue}from"./gather-wS3N_ZaP.js";import{h as H}from"./permission-uY4Xca4Z.js";import{_ as Ae}from"./InputGroupLabel-B7j5mkRS.js";import{_ as Oe}from"./Tree-CjXLR_6L.js";import{_ as Re}from"./Split-Cy4gN_OB.js";const Ve={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Be={class:"flex flex-col"},Ke=ce({name:"configsetting_realtimedata_devicedata",__name:"index",setup(Je){const{columns:Q,columnChecks:D,data:w,getData:b,loading:R,mobilePagination:Y,searchParams:f,resetSearchParams:Le}=Ie({apiFn:ie,apiParams:{page:1,pageSize:200,limit:200,tagType:null,chlid:null,devId:null,fuzzy:"",chlType:0,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",align:"center",width:48},{key:"id",title:"序号",align:"center",width:80},{key:"devId",title:"设备名称",align:"center",width:100,render:e=>{var t;return o("span",null,[(t=V.value.find(n=>n.id==e.devId))==null?void 0:t.devName])}},{key:"tagName",title:"测点名称",align:"center"},{key:"tagDesc",title:"物模型标识(测点描述)",align:"center"},{key:"value",title:"测点值",align:"center",width:140,render:e=>{var t;return T("span",{style:{color:e.quality===100?"red":e.quality==49?"#409eff":e.quality==50?"#909399":"#67c23a"}},parseFloat((t=e.value)==null?void 0:t.toFixed(6))||e.value)}},{key:"quality",title:"质量",align:"center",width:120,render:e=>(e.quality==100||e.quality==49||e.quality==0)&&T(re,{style:{background:e.quality===100?"red":e.quality==49?"#409eff":"#67c23a",color:"#fff"}},e.quality==0?"Good":e.quality==49?"人工置数":e.quality==100?"Bad":"")},{key:"dbtime",title:"采集时间",align:"center",minWidth:120,render:e=>{var t,n;return T("span",{title:A(0,+e.dbtime)},e.dbtime?(n=A(2,+e.dbtime))==null?void 0:n.substring(10,(t=A(2,+e.dbtime))==null?void 0:t.length):"")}},{key:"tagType",title:"测点类型",align:"center",width:140,render:e=>o("span",null,[Pe[e.tagType]])},{key:"objAddr",title:"地址",align:"center",width:140}]}),X=e=>{e===""&&b()};de(async()=>{await Z(),C(),ee()}),ue(()=>{var e,t;(e=N.value)==null||e.close(),(t=S.value)==null||t.close()});const v=k(),V=k([]),Z=async()=>{const{data:e,error:t}=await pe();if((e==null?void 0:e.length)==0)return;function n(_){return _.map(i=>{var a;return{label:i.chlName,key:i.id,dev_status:null,children:(a=i.devicePojoList)!=null&&a.length?i.devicePojoList.map(c=>(V.value.push(c),{label:c.devName,dev_status:null,chlType:i.chlType,key:c.id})):[]}})}v.value=n(e),f.chlid=v.value[0].key,f.devId=v.value[0].children[0].key,I.value=[v.value[0].children[0].key],x.value=v.value[0].children[0].label,b()},N=k(null),ee=()=>{var c,d,g;if((c=N.value)==null||c.close(),!H("channel:status:websocket")){(d=window.$message)==null||d.destroyAll(),(g=window.$message)==null||g.warning("暂无权限连接websocket");return}const e=new Date().getTime(),t=J(),n=L(`${t}${e}getchlstatus`),_=$(n),i=$("getchlstatus"),a=new j(F+`/ChannelStatusWebsocket/${i}/${_}/${e}/${t}?token=${M()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});N.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(u=>{let h=[];if(console.log(u,"通道状态websocket接受数据"),!B(u.data))return;h=JSON.parse(u.data).data;const y=JSON.parse(u.data).valid;v.value.forEach(s=>{h.forEach(m=>{var r;m.chl_id==s.key&&(s.dev_status=m.chl_status),m.chl_id==1&&(s.dev_status=1),(r=s.children)==null||r.forEach(P=>{var K;(K=m.devs)==null||K.forEach(U=>{U.dev_id==P.key&&(P.dev_status=U.dev_status),U.dev_id==1&&(P.dev_status=1)})})})}),v.value.forEach(s=>{y.forEach(m=>{s.key==m.id&&(s.chlValid=m.chlValid)})})})},S=k(null),z=k(""),q=k(!0),C=()=>{var c,d,g;if((c=S.value)==null||c.close(),!H("realtime:data:websocket")){(d=window.$message)==null||d.destroyAll(),(g=window.$message)==null||g.warning("暂无权限连接websocket");return}q.value=!0;const e=new Date().getTime(),t=J(),n=L(`${t}${e}${x.value}`),_=$(n),i=$(x.value),a=new j(F+`/realTimeDataWebsocket/${i}/${_}/${e}/${t}?token=${M()}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});S.value=a,a.connect(),a.onclose(()=>{}),a.onerror(()=>{}),a.onopen(()=>{}),a.onmessage(u=>{let h=[];console.log(u,"实时数据websocket接受数据"),B(u.data)&&(h=JSON.parse(u.data).data[x.value],h==null||h.forEach(y=>{w.value.forEach(s=>{y.i==s.id&&(s.quality=y.q,s.value=y.v,s.dbtime=y.t)})}),z.value=se())})},I=k([]),x=k(""),te=async(e,t,n)=>{var a,c,d,g,u;I.value=[(a=n.node)==null?void 0:a.key],f.chlType=(c=n.node)==null?void 0:c.chlType;function _(h,y){for(const s of h)if(s.children){for(const m of s.children)if(m.key===y)return s.key}return null}const i=await _(v.value,(d=n.node)==null?void 0:d.key);f.chlid=i,f.devId=(g=n.node)==null?void 0:g.key,x.value=(u=n.node)==null?void 0:u.label,b(),C()},ae=e=>{var t;e&&w.value.length>0?C():(t=S.value)==null||t.close()};_e(()=>f.tagType,e=>{e||b()});const ne=({option:e})=>e.key==0?"":e.dev_status!==null?T("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:e.hasOwnProperty("dev_status")&&e.dev_status==1?"#00b42a":e.dev_status==2?"#ff0000":"#ccc",color:"#ff0000",lineHeight:"12px",textAlign:"center",fontSize:"16px"}},e.chlValid==1?"":e.chlValid==2?"×":""):"",se=e=>{const t=new Date,n=t.getFullYear(),_=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),c=String(t.getMinutes()).padStart(2,"0"),d=String(t.getSeconds()).padStart(2,"0");return`${n}-${_}-${i} ${a}:${c}:${d}`},{drawerVisible:je,operateType:Fe,editingData:Me,handleAdd:We,handleEdit:Ge,checkedRowKeys:E,onBatchDeleted:He,onDeleted:Qe}=Ee(w,b),B=e=>{try{return JSON.parse(e),!0}catch{return!1}};return(e,t)=>{const n=Ae,_=Se,i=Te,a=oe,c=$e,d=De,g=le,u=Oe,h=Ne,y=ze,s=Re,m=qe;return he(),me("div",Ve,[o(m,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:p(()=>[o(d,{align:"center",wrap:"",justify:"start",class:"lt-sm:w-200px"},{default:p(()=>[o(c,null,{default:p(()=>[o(n,null,{default:p(()=>[O("测点类型")]),_:1}),o(_,{filterable:"",clearable:"",placeholder:"请选择",value:l(f).tagType,"onUpdate:value":t[0]||(t[0]=r=>l(f).tagType=r),options:l(fe)(l(Ue))},null,8,["value","options"]),o(i,{clearable:"",value:l(f).fuzzy,"onUpdate:value":[t[1]||(t[1]=r=>l(f).fuzzy=r),X],placeholder:"请输入测点名称或描述",style:{width:"150%"},onKeyup:ge(l(b),["enter"])},null,8,["value","onKeyup"]),o(l(ye),{type:"primary",ghost:"",onClick:l(b)},{icon:p(()=>[o(a,{class:ve(["text-icon",{"animate-spin":l(R)}])},null,8,["class"])]),default:p(()=>[O(" 搜索 ")]),_:1},8,["onClick"])]),_:1}),W("div",Be,[o(l(ke),{checked:q.value,"onUpdate:checked":[t[2]||(t[2]=r=>q.value=r),ae]},{default:p(()=>[O(" 实时刷新 ")]),_:1},8,["checked"]),be(W("span",{class:"font-size-14px color-blank",style:{"font-weight":"600"}}," 刷新时间："+xe(z.value),513),[[we,z.value]])])]),_:1})]),"header-extra":p(()=>[o(d,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:p(()=>[o(g,{columns:l(D),"onUpdate:columns":t[3]||(t[3]=r=>G(D)?D.value=r:null)},null,8,["columns"])]),_:1})]),default:p(()=>[o(s,{direction:"horizontal",class:"sm:h-full","default-size":.15,max:.35,min:.1,"resize-trigger-size":6},{1:p(()=>[o(h,{style:{"max-height":"700px"}},{default:p(()=>[o(u,{"block-line":"","default-expand-all":"",data:v.value,"checked-keys":I.value,"expand-on-click":!1,"render-prefix":ne,"check-strategy":"child","onUpdate:checkedKeys":te,checkable:""},null,8,["data","checked-keys"])]),_:1})]),2:p(()=>[o(y,{"checked-row-keys":l(E),"onUpdate:checkedRowKeys":t[4]||(t[4]=r=>G(E)?E.value=r:null),columns:l(Q),data:l(w),size:"small",loading:l(R),remote:"","row-key":r=>r.id,"flex-height":!0,"scroll-x":"",pagination:l(w).length?l(Y):void 0,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1})])}}}),ot=Ce(Ke,[["__scopeId","data-v-d95741f7"]]);export{ot as default};
