import{_ as Pe}from"./table-column-setting.vue_vue_type_script_setup_true_lang-BL3fEdXs.js";import{_ as Be}from"./round-delete-BJUCXHh8.js";import{_ as Le}from"./round-add-9JBusyZ3.js";import{d as ve,ay as fe,z as we,D as Fe,s as N,aL as ke,A as Ce,a as Ie,aw as xe,ax as Re,c as G,o as z,w as t,f as e,a3 as qe,b as oe,G as ge,M as De,h as o,aM as ze,H as B,aA as Me,b0 as Oe,e as se,t as S,aF as Ve,J as _e,B as L,g as U,$ as F,a4 as Ee,cE as Ne,aG as Se,aK as Ae,db as Ge,dc as Ke,aC as He,L as Je,a2 as je,aN as Qe,i as We,F as me,aO as ce,aD as Xe,I as de,aP as Ye,dd as he,de as Ze,aV as ea}from"./index-DTejdFLI.js";import{u as aa,a as ta}from"./table-5sK02S3E.js";import{u as Te}from"./usePageData-BjjY6agq.js";import{_ as $e}from"./Grid-U7VbogCl.js";import{_ as Ue}from"./FormItemGridItem-OdWiLkIi.js";import{_ as na}from"./round-search-CcVdI1HR.js";import{_ as la}from"./round-refresh-CFg-lT0v.js";import{N as ye}from"./Popconfirm-BmNh5CYH.js";const oa={key:0,style:{"margin-left":"20px"}},sa=["onClick"],ra=["onClick"],ia={key:0},ua={style:{display:"flex","justify-content":"space-between"}},ca=ve({name:"OperateDrawer",__name:"operate-drawer",props:fe({operateType:{},rowData:{},pid:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:fe(["submitted"],["update:visible"]),setup(j,{emit:K}){const x=K,I=we(),w=j,a=Fe(D());function D(){return{pid:void 0,id:"",affectedbusiness:"",devname:"",apidocument:"",uid:void 0,period:"",notes:"",re1:"",re2:"",re3:"",re4:"",fl1:"",fl2:"",fl3:"",fl4:""}}const m=N([]),{pageData:_,getData:g,nextPage:R}=Te(Ne),H=async n=>{const l=n.currentTarget,p=l.scrollTop;l.scrollTop+l.offsetHeight>=l.scrollHeight&&_.data.length<_.total&&(await R(),m.value=_.data,await Se(),setTimeout(()=>{l.scrollTop=p}))},J=async()=>{var n;await g({fuzzy:I.userInfo.pname,page:1}),m.value=_.data,a.pid=w.pid?w.pid:(n=m.value[0])==null?void 0:n.id},Q=ke.debounce(async n=>{await g({fuzzy:n,page:1}),m.value=_.data},300),T=N(!1),y=N(!1),W=n=>{if(a.pid=null,T.value=!0,y.value=!1,!n){q();return}Q(n)},X=async()=>{T.value&&!y.value&&(await g({page:1}),m.value=_.data,T.value=!1)},q=async()=>{await g({page:1}),m.value=_.data},re=async n=>{a.pid=n,y.value=!0};async function Y(){if(J(),Object.assign(a,D()),f.value=[{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}],w.operateType==="edit"&&w.rowData){Object.assign(a,w.rowData),f.value=[];for(let n=1;n<=4;n++){const l=a[`re${n}`],p=a[`fl${n}`];f.value.push({name:l||"",url:p||"",status:p?"finished":"pending"})}}}const{formRef:Z,validate:E,restoreValidation:u}=Ce(),i={pid:{type:"number",required:!0,trigger:["blur","change"],message:"请选择"},affectedbusiness:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},devname:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},apidocument:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},period:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"},uid:{type:"string",required:!0,trigger:["blur","change"],message:"请输入"}},d=Ie(()=>({add:"新增需要开发",edit:"修改需要开发"})[w.operateType]),s=xe(j,"visible");async function b(n){if(n)try{const p=await(await fetch(n==null?void 0:n.split("?")[0],{mode:"cors"})).blob(),O=URL.createObjectURL(p),k=document.createElement("a");k.href=O,k.download=n==null?void 0:n.split("?")[1],k.style.display="none",document.body.appendChild(k),k.click(),document.body.removeChild(k),URL.revokeObjectURL(O)}catch(l){console.error("下载失败:",l)}}Re(s,()=>{s.value&&(Y(),setTimeout(()=>{const n=document.querySelector(".n-scrollbar-content");n==null||n.scrollTo(0,0)},300),u())});const $=N(!1),C=N(0),f=N([{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0},{name:"",url:"",file:void 0}]);async function ee({file:n},l){f.value[l].file=n,f.value[l].name=n.name}function M(){s.value=!1}async function A(n){return!0}const h=N(!1);async function ae(){var n,l,p,O;if(!h.value)try{await E(),h.value=!0;let k=!0;if(f.value.forEach((v,c)=>{var ne,le;const te=`re${c+1}`,r=`fl${c+1}`,V=v.name||"",P=((ne=v.url)==null?void 0:ne.split("?")[1])||((le=v.file)==null?void 0:le.name);(V&&!P||!V&&P)&&(k=!1),v.status==="done"&&(a[te]=V,a[r]=P)}),!k){(l=(n=window.$message)==null?void 0:n.error)==null||l.call(n,"文件名称和文件地址必须同时存在，不能只填一个");return}$.value=!0;const ie=f.value.filter(v=>v.file),ue=ie.length;for(let v=0;v<ue;v++){C.value=v;const c=ie[v];c.indexText=`${v+1}/${ue}`,c.progress=0,c.status="uploading";try{c.url=await Ae(c.file.file,c.file.name,"",te=>{c.progress=te}),c.progress=100,c.status="done"}catch{c.status="error"}}if(f.value.forEach((v,c)=>{a[`re${c+1}`]=v.name||"",a[`fl${c+1}`]=v.url||""}),$.value=!1,w.operateType==="edit"){const{data:v,error:c}=await Ge([a]);c||(M(),x("submitted"),(p=window.$message)==null||p.success("修改成功"))}else{const{data:v,error:c}=await Ke([{...a}]);c||(M(),x("submitted"),(O=window.$message)==null||O.success("添加成功"))}}catch{}finally{h.value=!1}}return(n,l)=>{const p=Ue,O=He,k=$e,ie=De,ue=Ve,v=qe,c=_e,te=Ee;return z(),G(te,{show:s.value,"onUpdate:show":l[7]||(l[7]=r=>s.value=r),title:d.value,preset:"card",class:"w-800px","mask-closable":!1,draggable:!0},{footer:t(()=>[e(c,{justify:"end",size:16},{default:t(()=>[e(o(L),{onClick:M},{default:t(()=>[U(S(o(F)("common.cancel")),1)]),_:1}),e(o(L),{type:"primary",onClick:ae,loading:h.value},{default:t(()=>[U(S(o(F)("common.confirm")),1)]),_:1},8,["loading"])]),_:1})]),default:t(()=>[e(v,{class:"pr-20px"},{default:t(()=>[e(ie,{ref_key:"formRef",ref:Z,model:a,rules:i,"label-placement":"left","label-width":120},{default:t(()=>[e(k,{responsive:"screen","item-responsive":""},{default:t(()=>[e(p,{span:"24 m:12",label:"项目列表",path:"pid"},{default:t(()=>[e(o(ze),{clearable:"",filterable:"",value:a.pid,"onUpdate:value":[l[0]||(l[0]=r=>a.pid=r),re],placeholder:"请选择项目","label-field":"proname","value-field":"id",onClear:q,onSearch:W,onBlur:X,options:m.value,onScroll:H},null,8,["value","options"])]),_:1}),e(p,{span:"24 m:12",label:"影响的业务",path:"affectedbusiness"},{default:t(()=>[e(o(B),{value:a.affectedbusiness,"onUpdate:value":l[1]||(l[1]=r=>a.affectedbusiness=r),placeholder:"请输入"},null,8,["value"])]),_:1}),e(p,{span:"24 m:12",label:"设备名称",path:"devname"},{default:t(()=>[e(o(B),{value:a.devname,"onUpdate:value":l[2]||(l[2]=r=>a.devname=r),placeholder:"请输入"},null,8,["value"])]),_:1}),e(p,{span:"24 m:12",label:"接口文档",path:"apidocument"},{default:t(()=>[e(o(B),{value:a.apidocument,"onUpdate:value":l[3]||(l[3]=r=>a.apidocument=r),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),e(p,{span:"24 m:12",label:"研发对接人",path:"uid"},{default:t(()=>[e(o(B),{value:a.uid,"onUpdate:value":l[4]||(l[4]=r=>a.uid=r),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),e(p,{span:"24 m:12",label:"研发周期",path:"period"},{default:t(()=>[e(o(B),{value:a.period,"onUpdate:value":l[5]||(l[5]=r=>a.period=r),placeholder:"请输入",style:{width:"100%"}},null,8,["value"])]),_:1}),e(p,{span:"24 m:12",label:"备注",path:"notes"},{default:t(()=>[e(o(B),{value:a.notes,"onUpdate:value":l[6]||(l[6]=r=>a.notes=r),placeholder:"请输入"},null,8,["value"])]),_:1}),(z(!0),oe(Me,null,Oe(f.value,(r,V)=>(z(),G(p,{span:"24 m:24",label:"",path:"notes","show-feedback":!1,key:V},{default:t(()=>[e(k,{responsive:"screen","item-responsive":""},{default:t(()=>[e(p,{span:"24 m:12",label:`附件${V+1}`,path:"notes"},{default:t(()=>[e(o(B),{value:r.name,"onUpdate:value":P=>r.name=P,placeholder:"请输入",style:{width:"250px"}},null,8,["value","onUpdate:value"])]),_:2},1032,["label"]),e(p,{span:"24 m:12",label:"",path:"notes"},{default:t(()=>{var P,ne,le;return[(P=r.url)!=null&&P.split("?")[1]||(ne=r.file)!=null&&ne.name?(z(),oe("span",oa,[U(S(((le=r.url)==null?void 0:le.split("?")[1])||r.file.name)+" ",1),se("span",{class:"cursor-pointer c-#c92a2a",onClick:pe=>{r.url="",r.file=void 0,r.name=""}},"删除",8,sa),r.url?(z(),oe("span",{key:0,class:"cursor-pointer c-#1890ff ml-5px inline-block",onClick:pe=>b(r.url)},"下载",8,ra)):ge("",!0)])):(z(),G(O,{key:1,style:{width:"auto","margin-left":"20px"},ref_for:!0,ref:"uploadRef",action:"#","custom-request":pe=>ee(pe,V),"show-file-list":!1,onBeforeUpload:A},{default:t(()=>[e(o(L),{size:"small",ghost:"",type:"primary"},{default:t(()=>l[8]||(l[8]=[U(S("选择文件"))])),_:1,__:[8]})]),_:2},1032,["custom-request"]))]}),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1},8,["model"]),f.value[C.value]&&$.value?(z(),oe("div",ia,[se("div",ua,[se("span",null,S(f.value[C.value].filename||f.value[C.value].name),1),se("span",null,S(f.value[C.value].indexText),1)]),e(ue,{percentage:f.value[C.value].progress,status:f.value[C.value].status==="error"?"error":"success","show-indicator":""},null,8,["percentage","status"])])):ge("",!0)]),_:1})]),_:1},8,["show","title"])}}}),da=ve({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:fe(["reset","search","clear"],["update:model"]),setup(j,{emit:K}){const x=K,{formRef:I,restoreValidation:w}=Ce(),a=xe(j,"model"),D=we(),m=N([]),{pageData:_,getData:g,nextPage:R}=Te(Ne),H=async u=>{const i=u.currentTarget,d=i.scrollTop;i.scrollTop+i.offsetHeight>=i.scrollHeight&&_.data.length<_.total&&(await R(),m.value=_.data,await Se(),setTimeout(()=>{i.scrollTop=d}))},J=async u=>{var i;y.value=!0,u?(a.value.pid=u,x("search"),D.setProjectInfo({pname:(i=m.value.find(d=>d.id==u))==null?void 0:i.proname,pid:u})):x("clear")},Q=ke.debounce(async u=>{await g({fuzzy:u,page:1}),m.value=_.data},300),T=N(!1),y=N(!1),W=u=>{if(a.value.pid=null,T.value=!0,y.value=!1,!u){q();return}Q(u)},X=async()=>{T.value&&!y.value&&(await g({page:1}),m.value=_.data,T.value=!1)},q=async()=>{await g({page:1}),m.value=_.data};(async()=>{var u,i;await g({fuzzy:D.userInfo.pname}),m.value=_.data,a.value.pid=D.userInfo.pid?D.userInfo.pid:(u=m.value[0])==null?void 0:u.id,a.value.pid&&(D.setProjectInfo({pid:a.value.pid,pname:(i=m.value.find(d=>d.id==a.value.pid))==null?void 0:i.proname}),x("search"))})();async function Y(){await w(),a.value.fuzzy="",x("reset")}const Z=()=>{a.value.fuzzy="",x("search")};async function E(){var u,i;a.value.pid?x("search"):((u=window.$message)==null||u.destroyAll(),(i=window.$message)==null||i.warning("请选择项目"))}return(u,i)=>{const d=ze,s=Ue,b=B,$=la,C=L,f=na,ee=_e,M=$e,A=De,h=je;return z(),G(h,{bordered:!1,size:"small",class:"card-wrapper"},{default:t(()=>[e(A,{ref_key:"formRef",ref:I,model:a.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Je(E,["enter"])},{default:t(()=>[e(M,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:t(()=>[e(s,{span:"24 s:12 m:6",label:"项目列表",path:"PrjId"},{default:t(()=>[e(d,{filterable:"",clearable:"",value:a.value.pid,"onUpdate:value":[i[0]||(i[0]=ae=>a.value.pid=ae),J],placeholder:"请选择项目","label-field":"proname","value-field":"id",options:m.value,onScroll:H,onClear:q,onSearch:W,onBlur:X},null,8,["value","options"])]),_:1}),e(s,{span:"24 s:12 m:6",label:"设备名称",path:"fuzzy"},{default:t(()=>[e(b,{value:a.value.fuzzy,"onUpdate:value":i[1]||(i[1]=ae=>a.value.fuzzy=ae),placeholder:"请输入",clearable:"",onClear:Z},null,8,["value"])]),_:1}),e(s,{span:"24  s:12 m:6",class:"pr-24px"},{default:t(()=>[e(ee,{class:"w-full"},{default:t(()=>[e(C,{onClick:Y},{icon:t(()=>[e($,{class:"text-icon"})]),default:t(()=>[U(" "+S(o(F)("common.reset")),1)]),_:1}),e(C,{type:"primary",ghost:"",onClick:E},{icon:t(()=>[e(f,{class:"text-icon"})]),default:t(()=>[U(" "+S(o(F)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),pa={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function be(j){return typeof j=="function"||Object.prototype.toString.call(j)==="[object Object]"&&!ea(j)}const xa=ve({name:"projectmanagement_need",__name:"index",setup(j){const K=Qe(),{columns:x,columnChecks:I,data:w,getData:a,loading:D,pagination:m,mobilePagination:_,searchParams:g}=aa({showTotal:!0,immediate:!1,apiFn:Ze,apiParams:{page:1,pageSize:20,limit:20,fuzzy:"",_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"affectedbusiness",title:"影响的业务",align:"center",width:120},{key:"devname",title:"设备名称",align:"center",width:120},{key:"apidocument",title:"接口文档",align:"center",width:120},{key:"uid",title:"研发对接人",align:"center",width:120},{key:"period",title:"研发周期",align:"center",width:120},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"操作人",align:"center",width:120},{key:"dbtime",title:"操作时间",align:"center",width:120},{key:"operate",title:F("common.operate"),align:"center",width:140,fixed:"right",render:d=>{let s;return e("div",{class:"flex-center gap-8px"},[de(e(L,{type:"primary",ghost:!0,size:"small",onClick:()=>Y(d.id)},be(s=F("common.edit"))?s:{default:()=>[s]}),[[me("no-auth"),"project:Development:update"]]),e(ye,{onPositiveClick:()=>re(d.id)},{default:()=>F("common.confirmDelete"),trigger:()=>{let b;return de(e(L,{type:"error",ghost:!0,size:"small"},be(b=F("common.delete"))?b:{default:()=>[b]}),[[me("no-auth"),"project:Development:delete"]])}})])}}]}),{drawerVisible:R,operateType:H,editingData:J,handleAdd:Q,handleEdit:T,checkedRowKeys:y,onBatchDeleted:W,onDeleted:X}=ta(w,a);We(async()=>{});async function q(){console.log(y.value),Z(y.value.join(","),d=>{W()})}async function re(d){const{data:s,error:b}=await he(d,g.pid);b||X()}function Y(d){T(d)}async function Z(d,s){const{data:b,error:$}=await he(d,g.pid);if(!$)s&&s(b);else return!1}const E=d=>{a()},u=()=>{w.value=[],m.itemCount=0},i=()=>{a()};return(d,s)=>{const b=_e,$=Le,C=Be,f=Pe,ee=Xe,M=je,A=me("no-auth");return z(),oe("div",pa,[e(da,{model:o(g),"onUpdate:model":s[0]||(s[0]=h=>ce(g)?g.value=h:null),onReset:i,onSearch:o(a),onClear:u},null,8,["model","onSearch"]),e(M,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:t(()=>[e(b,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:t(()=>s[4]||(s[4]=[se("div",null,"需要开发",-1)])),_:1,__:[4]})]),"header-extra":t(()=>[e(b,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:t(()=>[de((z(),G(o(L),{onClick:o(Q),size:"small",ghost:"",type:"primary"},{icon:t(()=>[e($,{class:"text-icon"})]),default:t(()=>[s[5]||(s[5]=U(" "+S("新增")))]),_:1,__:[5]},8,["onClick"])),[[A,"project:Development:insert"]]),e(o(ye),{onPositiveClick:q},{trigger:t(()=>[de((z(),G(o(L),{size:"small",ghost:"",type:"error",disabled:o(y).length==0},{icon:t(()=>[e(C,{class:Ye(["text-icon",{"animate-spin":o(D)}])},null,8,["class"])]),default:t(()=>[s[6]||(s[6]=U(" "+S("批量删除")))]),_:1,__:[6]},8,["disabled"])),[[A,"project:Development:delete"]])]),default:t(()=>[s[7]||(s[7]=U(" 确定要删除选中的吗？ "))]),_:1,__:[7]}),e(f,{columns:o(I),"onUpdate:columns":s[1]||(s[1]=h=>ce(I)?I.value=h:null),ctype:12},null,8,["columns"])]),_:1})]),default:t(()=>[e(ee,{"checked-row-keys":o(y),"onUpdate:checkedRowKeys":s[2]||(s[2]=h=>ce(y)?y.value=h:null),columns:o(x),data:o(w),size:"small","flex-height":!o(K).isMobile,loading:o(D),remote:"","row-key":h=>h.id,pagination:o(_),class:"sm:h-full","onUpdate:filters":E},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),e(ca,{visible:o(R),"onUpdate:visible":s[3]||(s[3]=h=>ce(R)?R.value=h:null),onSubmitted:o(a),pid:o(g).pid,"operate-type":o(H),"row-data":o(J)},null,8,["visible","onSubmitted","pid","operate-type","row-data"])]),_:1})])}}});export{xa as default};
