import{_ as ue}from"./round-search-D79Yigrq.js";import{d as le,r as F,a as U,at as ne,i as oe,dQ as de,b as D,o as b,e as y,z as j,aT as se,aX as re,g as O,t as L,cK as me,aP as ve,V as pe,aJ as fe,av as ie,M as ge,a$ as te,eE as he,f7 as ye,f as d,aS as be,az as we,w as x,c as S,h as g,aA as ke,N as Fe,A as Te,au as _e,aD as ae,B as xe,$ as De,U as Me,aI as Ce,b4 as Ae,aU as Ee}from"./index-CZIEjqom.js";import{d as $e}from"./home-Cxg9O4z3.js";import{u as Se}from"./usePageData-B4neAonl.js";import{N as Q}from"./RadioButton-Bq-ZCJId.js";import{N as ee}from"./DatePicker-DTVdJWoE.js";const Oe={class:"map-wrapper",style:{height:"100%",position:"relative"}},je={class:"map-legend"},Be={class:"legend-list"},ze=["onClick","onContextmenu"],Ne={key:0,class:"visibility-icon"},Pe={key:1,class:"solo-icon"},Ue={class:"legend-name"},Ve={class:"visibility-toggle"},Ie={key:0,class:"solo-notice"},We=le({__name:"historyMap",props:{trackData:{}},setup(C){const u=F(null);let A=null;const R=C,M=F([]),v=["#FF6B9D","#6BCF7F","#4A90E2","#FFD166","#7B68EE","#00D4AA","#FF8C42","#BA68C8","#4ECDC4","#FFA726","#42B883","#FF5252","#536DFE","#00E5FF","#69F0AE","#FF4081","#18FFFF","#B388FF","#76FF03","#FF9100","#EA80FC","#84FFFF","#CCFF90","#FF9E80","#80D8FF","#FFFF8D","#A7FFEB","#FF80AB","#8C9EFF","#B9F6CA"],a=F({}),w=F(""),E=U(()=>{const e={};return Object.keys(M.value).forEach((n,l)=>{e[n]=v[l%v.length],a.value[n]===void 0&&(a.value[n]=!0)}),e});function _(e){if(w.value){V(e);return}a.value[e]=!a.value[e],T()}function V(e){w.value===e?B():(w.value=e,Object.keys(a.value).forEach(t=>{a.value[t]=t===e}),T())}function B(){w.value="",Object.keys(a.value).forEach(e=>{a.value[e]=!0}),T()}function z(){Object.keys(a.value).forEach(e=>{a.value[e]=!a.value[e]}),w.value="",T()}function Y(){Object.keys(a.value).forEach(e=>{a.value[e]=!0}),w.value="",T()}function Z(){Object.keys(a.value).forEach(e=>{a.value[e]=!1}),w.value="",T()}const $=U(()=>{const e=[];return Object.values(M.value).forEach(t=>{e.push(...t)}),e.sort((t,n)=>new Date(t.dbtime).getTime()-new Date(n.dbtime).getTime())}),H=U(()=>{if($.value.length===0)return[120.370086,30.305716];const e=$.value.map(i=>i.longitude),t=$.value.map(i=>i.latitude),n=(Math.min(...e)+Math.max(...e))/2,l=(Math.min(...t)+Math.max(...t))/2;return console.log(n,l),[n,l]});async function N(){const e="/map-sdk.json",{data:t}=await fe.get(`${e}?_t=${Date.now()}`);return t}function I(e){return new Promise((t,n)=>{if(window.AMap)return t(window.AMap);const l=document.createElement("script");l.src=`https://webapi.amap.com/maps?v=2.0&key=${e}&plugin=AMap.PolylineEditor`,l.defer=!0,l.onload=()=>window.AMap?t(window.AMap):n(new Error("AMapåŠ è½½å¤±è´¥")),l.onerror=()=>n(new Error("AMapè„šæœ¬åŠ è½½é”™è¯¯")),document.head.appendChild(l)})}const f=F({});function P(e,t){const n=t.lng-e.lng,l=t.lat-e.lat;return(Math.atan2(-l,n)*180/Math.PI-90+360)%360-175}function K(e,t,n,l){const i=document.createElement("div");return i.style.cssText=`
    width: 12px;
    height: 18px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 18px solid ${l};
    transform: translate(-50%, -50%) rotate(${n}deg);
    transform-origin: center center;
  `,new e.Marker({position:[t.lng,t.lat],content:i,offset:new e.Pixel(0,0)})}function q(e,t,n,l,i){const r=document.createElement("div");return r.className="custom-marker",r.style.transform="translateX(-50%)",r.innerHTML=`
    <div class="avatar-wrapper" style="border-color: ${l};box-shadow: 0 0 5px ${l}, 0 0 6px ${l};">
      <img src="${i||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png"}" class="marker-avatar" />
    </div>
    <div class="marker-name" style="color: ${l};">${n}</div>
  `,new e.Marker({position:[t.lng,t.lat],content:r})}function G(){u.value&&u.value.clearMap(),f.value={}}function T(){!window.AMap||!u.value||Object.keys(f.value).forEach(e=>{const t=a.value[e];(f.value[e]||[]).forEach(l=>{t?l.show():l.hide()})})}function W(e){if(!u.value)return;G();const t={};Object.entries(M.value).forEach(([l,i])=>{t[l]=i.map(r=>({lng:r.longitude,lat:r.latitude,address:r.address,dbtime:r.dbtime,proname:r.proname||"æœªæŒ‡å®šé¡¹ç›®",duration:r.duration||0,userimage:r.userimage,longitude:r.longitude,latitude:r.latitude}))}),Object.keys(t).forEach(l=>{const i=t[l],r=E.value[l];if(i.length===0)return;const p=[];if(i.length>1){const m=new e.Polyline({path:i.map(k=>[k.lng,k.lat]),strokeColor:r,strokeWeight:4,strokeOpacity:.7,strokeStyle:"solid",lineJoin:"round",lineCap:"round",isOutline:!0,outlineColor:"#FFFFFF",borderWeight:2});m.setMap(u.value),p.push(m)}i.forEach((m,k)=>{const h=q(e,m,l,r,i[0].userimage);h.setMap(u.value),p.push(h),h.on("click",()=>{const J=`
          <div style="min-width:220px; background:#fff; padding:12px 14px; font-size:13px; color:#333; line-height:1.6">
            <div style="font-weight:bold; color:${r}; font-size:15px; margin-bottom:6px; border-bottom:1px solid #f0f0f0; padding-bottom:4px">
              ${l}
            </div>
            <div><b style="color:#555">åœ°ç‚¹ï¼š</b>${m.address}</div>
            <div><b style="color:#555">æ—¶é—´ï¼š</b>${m.dbtime}</div>
            <div><b style="color:#555">é¡¹ç›®ï¼š</b>${m.proname}</div>
            <div><b style="color:#555">ç»çº¬åº¦ï¼š</b><span style="font-size:12px;color:#666">${m.longitude}, ${m.latitude}</span></div>

          </div>
          <div style="margin-top:8px; text-align:right; font-size:12px; color:#999">ç¬¬ ${k+1} ä¸ªæ‰“å¡ç‚¹</div>
        `;A.setContent(J),A.open(u.value,h.getPosition())}),h.on("dblclick",()=>{A.open(u.value,h.getPosition()),u.value.setCenter(h.getPosition()),u.value.setZoom(14)})});for(let m=1;m<i.length;m++){const k=i[m-1],h=i[m];if(s(k,h))continue;const J={lng:(k.lng+h.lng)/2,lat:(k.lat+h.lat)/2},ce=P(k,h),X=K(e,J,ce,r);X.isArrow=!0,X.setMap(u.value),p.push(X)}Object.keys(t).length==1&&u.value.setFitView(p,!1,[60,60,60,60]),f.value[l]=p});const n=()=>{const i=u.value.getZoom()>=7,r=o(f.value,a.value);Object.values(r).forEach(p=>{p==null||p.forEach(m=>{m.isArrow&&(i?m.show():m.hide())})})};u.value.on("zoomend",n),n(),Object.keys(f.value).forEach(l=>{(f.value[l]||[]).forEach(r=>{r.isArrow||(a.value[l]?r.show():r.hide())})})}function o(e,t){const n={};for(const l in e)t[l]&&(n[l]=e[l]);return n}function s(e,t,n=1e-7){return Math.abs(e.lng-t.lng)<n&&Math.abs(e.lat-t.lat)<n}async function c(){try{const e=await N(),t=await I(e.AMAP_SDK_KEY);u.value=new t.Map("amap-container",{viewMode:"2D",center:H.value,zoom:5,features:["bg","point"]}),t.plugin(["AMap.Scale","AMap.ToolBar"],()=>{u.value.addControl(new t.Scale),u.value.addControl(new t.ToolBar)}),u.value.on("zoomend",()=>{const l=u.value.getZoom()>=12,i=o(f.value,a.value);Object.values(i).forEach(r=>{r.forEach(p=>{p.isArrow&&(l?p.show():p.hide())})})}),A=new t.InfoWindow({anchor:"bottom-center",closeWhenClickMap:!0}),W(t)}catch(e){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",e)}}return ne(()=>R.trackData??[],e=>{console.log(e,"så¤„ç†æ•°æ®æˆ–æ¸²æŸ“å†…å®¹"),M.value=e,window.AMap&&u.value&&W(window.AMap)},{immediate:!0,deep:!0}),oe(()=>{c()}),de(()=>{u.value&&u.value.destroy()}),(e,t)=>(b(),D("div",Oe,[t[1]||(t[1]=y("div",{id:"amap-container",style:{width:"100%",height:"100%","border-radius":"8px"}},null,-1)),y("div",je,[y("div",{class:"legend-header"},[t[0]||(t[0]=y("div",{class:"legend-title"},"äººå‘˜è½¨è¿¹",-1)),y("div",{class:"legend-actions"},[y("button",{class:"action-btn",onClick:Y},"å…¨æ˜¾"),y("button",{class:"action-btn",onClick:Z},"å…¨éš"),y("button",{class:"action-btn",onClick:z},"åé€‰")])]),y("div",Be,[(b(!0),D(se,null,re(E.value,(n,l)=>(b(),D("div",{key:l,class:ve(["legend-item",{"legend-item-hidden":!a.value[l],"legend-item-solo":w.value===l}]),onClick:i=>_(l),onContextmenu:me(i=>V(l),["prevent"])},[y("div",{class:"legend-color",style:pe({backgroundColor:n})},[a.value[l]?j("",!0):(b(),D("span",Ne,"ğŸ‘ï¸â€ğŸ—¨ï¸")),w.value===l?(b(),D("span",Pe,"â­")):j("",!0)],4),y("span",Ue,L(l),1),y("span",Ve,L(a.value[l]?"éšè—":"æ˜¾ç¤º"),1)],42,ze))),128))]),w.value?(b(),D("div",Ie,[O(" ä»…æ˜¾ç¤º: "+L(w.value)+" ",1),y("button",{class:"cancel-solo-btn",onClick:B},"å–æ¶ˆ")])):j("",!0)])]))}}),Le=ie(We,[["__scopeId","data-v-0d98a82c"]]),Re={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Ye(C){return typeof C=="function"||Object.prototype.toString.call(C)==="[object Object]"&&!Ee(C)}const Ze=le({name:"trajectory_historytrajectory",__name:"index",setup(C){const u=ge();function A(o){return o.getFullYear()}function R(o){const s=new Date(o.getFullYear(),0,1),c=(o.getTime()-s.getTime())/864e5,e=s.getDay()||7;return Math.ceil((c+e)/7)}function M(){const o=new Date,s=A(o),c=R(o).toString().padStart(2,"0");return`${s}-${c}å‘¨`}const v=F("week"),a=F({dayTime:String(te(0,null)),monthTime:String(te(3,null)),weekTime:M(),startTime:null,endTime:null,dates:null,creater:null}),w=F([{label:"æ—¥",value:"day"},{label:"å‘¨",value:"week"},{label:"æœˆ",value:"month"}]),E=F("table"),_=F({}),V=U(()=>Object.keys(_.value||{}).map(o=>{var s,c;return{key:o,name:o,userimage:(c=(s=_.value[o])==null?void 0:s[0])==null?void 0:c.userimage}})),B=U(()=>{const o=[{title:"ç”¨æˆ·å",key:"name",width:120,align:"center",fixed:"left",render(c){return d("div",{class:"text-blue-600 flex-col items-center font-medium"},[d(be,{width:"60",height:"60","preview-disabled":!0,src:c.userimage||"https://pictures.linkqi.cn/work-project/image/656c9f43-e1b0-42a5-a480-d8695aaba7823098852561625908631.png",class:"rounded-md object-cover"},null),d("span",null,[c.name])])}}];let s=[];switch(v.value){case"week":a.value.startTime&&a.value.endTime&&(s=ye(a.value.startTime,a.value.endTime).map(e=>z(e)));break;case"month":a.value.monthTime&&(s=he(a.value.monthTime).map(e=>z(e)));break;case"day":default:a.value.dayTime&&(s=[z(a.value.dayTime)]);break}return[...o,...s]}),z=o=>({title:Y(o),key:o,width:300,align:"center",render:s=>Z(s.name,o)}),Y=o=>{const s=new Date(o),c=s.getMonth()+1,e=s.getDate(),t=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][s.getDay()];return`${c}/${e} å‘¨${t}`},Z=(o,s)=>{let c;const t=(_.value[o]||[]).filter(n=>n.daytime===s);return t.length===0?d("div",{class:"text-gray-400 text-sm"},[O("æ— è®°å½•")]):d("div",{class:"text-left space-y-1"},[d(we,{style:"max-height: 250px;",trigger:"none"},Ye(c=t.map((n,l)=>d("div",{key:l,class:"tableItem p-1 border-b border-gray-100 last:border-b-0"},[d("div",null,[O("é¡¹ç›®ï¼š"),d("span",{class:""},[n.proname||"æš‚æ— é¡¹ç›®"])]),d("div",null,[O("åœ°å€ï¼š "),d("span",{class:""},[n.address])]),d("div",null,[O("æ‰“å¡æ—¶é—´ï¼š"),d("span",{class:""},[n.dbtime])])])))?c:{default:()=>[c]})])},$=o=>{const s=o.match(/^(\d{4})-(\d{1,2})å‘¨$/);if(!s)return null;const c=Number(s[1]),e=Number(s[2]),t=new Date(c,0,1+(e-1)*7),n=t.getDay(),l=new Date(t);n<=4?l.setDate(t.getDate()-t.getDay()+1):l.setDate(t.getDate()+8-t.getDay());const i=new Date(l);i.setDate(l.getDate()+6);const r=p=>{const m=p.getFullYear(),k=String(p.getMonth()+1).padStart(2,"0"),h=String(p.getDate()).padStart(2,"0");return`${m}-${k}-${h}`};return{start:r(l),end:r(i)}},H=o=>{_.value={},v.value=o,I()},N=o=>{I(o),f()},I=o=>{switch(v.value){case"week":if(o){const s=$(o);s&&(a.value.startTime=s.start,a.value.endTime=s.end)}break;case"month":a.value.dates=o||a.value.monthTime;break;case"day":default:a.value.dates=o||a.value.dayTime;break}},f=async()=>{try{const o={};a.value.creater&&(o.creater=a.value.creater),v.value==="week"?(o.startTime=a.value.startTime,o.endTime=a.value.endTime):v.value==="month"?o.dates=a.value.monthTime:o.dates=a.value.dayTime;const{data:s,error:c}=await $e(o);c||(_.value=s)}catch(o){console.error("æœç´¢å†å²è½¨è¿¹å¤±è´¥:",o)}},{pageData:P,getData:K,nextPage:q}=Se(Ae),G=async o=>{const s=o.currentTarget,c=s.scrollTop;s.scrollTop+s.offsetHeight>=s.scrollHeight&&P.data.length<P.total&&(await q(),await Ce(),setTimeout(()=>{s.scrollTop=c}))},T=F(1),W=async o=>{a.value.creater=o,o||setTimeout(()=>{T.value++},500),f()};return ne([v,()=>a.value.dates],()=>{if(v.value=="week"&&a.value.weekTime){const o=$(a.value.weekTime);o&&(a.value.startTime=o.start,a.value.endTime=o.end),f()}else(v.value=="month"&&a.value.monthTime||v.value=="day"&&a.value.dayTime)&&f()},{immediate:!0}),oe(()=>{a.value.weekTime=M(),K({usertypes:"2,3"}),f()}),(o,s)=>{const c=_e,e=Te,t=ue;return b(),D("div",Re,[d(g(Me),{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper h-full"},{header:x(()=>[d(g(Fe),{align:"center"},{default:x(()=>[s[6]||(s[6]=y("div",{class:"font-semibold"},"å†å²è½¨è¿¹æ•°æ®",-1)),d(e,{label:"ç”¨æˆ·",path:"creater","label-placement":"left","show-feedback":!1},{default:x(()=>[d(c,{clearable:"",filterable:"",value:a.value.creater,"onUpdate:value":[s[0]||(s[0]=n=>a.value.creater=n),W],placeholder:"è¯·é€‰æ‹©","label-field":"username",size:"small","value-field":"id",options:g(P).data,onScroll:G},null,8,["value","options"])]),_:1}),d(g(ae),{value:v.value,"onUpdate:value":[s[1]||(s[1]=n=>v.value=n),H],size:"small"},{default:x(()=>[(b(!0),D(se,null,re(w.value,n=>(b(),S(g(Q),{key:n.value,value:n.value,label:n.label},null,8,["value","label"]))),128))]),_:1},8,["value"]),v.value==="day"?(b(),S(g(ee),{key:0,size:"small","formatted-value":a.value.dayTime,"onUpdate:formattedValue":[s[2]||(s[2]=n=>a.value.dayTime=n),N],type:"date","value-format":"yyyy-MM-dd",style:{width:"140px"}},null,8,["formatted-value"])):j("",!0),v.value==="week"?(b(),S(g(ee),{key:1,size:"small","formatted-value":a.value.weekTime,"onUpdate:formattedValue":[s[3]||(s[3]=n=>a.value.weekTime=n),N],type:"week",style:{width:"140px"}},null,8,["formatted-value"])):j("",!0),v.value==="month"?(b(),S(g(ee),{key:2,size:"small","formatted-value":a.value.monthTime,"onUpdate:formattedValue":[s[4]||(s[4]=n=>a.value.monthTime=n),N],type:"month","value-format":"yyyy-MM",style:{width:"140px"}},null,8,["formatted-value"])):j("",!0),d(g(xe),{type:"primary",onClick:f,size:"small",class:"w-full sm:w-auto"},{icon:x(()=>[d(t,{class:"text-icon"})]),default:x(()=>[O(" "+L(g(De)("common.search")),1)]),_:1}),d(g(ae),{size:"small",value:E.value,"onUpdate:value":s[5]||(s[5]=n=>E.value=n),name:"radiobuttongroup1"},{default:x(()=>[d(g(Q),{value:"table",label:"è¡¨æ ¼"}),d(g(Q),{value:"map",label:"åœ°å›¾"})]),_:1},8,["value"])]),_:1,__:[6]})]),default:x(()=>[E.value=="table"?(b(),S(g(ke),{key:0,columns:B.value,data:V.value,size:"small","flex-height":!g(u).isMobile,"scroll-x":B.value.reduce((n,l)=>n+l.width,0),remote:"","row-key":n=>n.key,class:"h-full",striped:""},null,8,["columns","data","flex-height","scroll-x","row-key"])):(b(),S(Le,{trackData:_.value,key:T.value},null,8,["trackData"]))]),_:1})])}}}),Qe=ie(Ze,[["__scopeId","data-v-b6785915"]]);export{Qe as default};
