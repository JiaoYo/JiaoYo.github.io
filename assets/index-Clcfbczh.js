import{_ as Jt}from"./table-column-setting.vue_vue_type_script_setup_true_lang-CvfnQZYV.js";import{_ as qt}from"./round-delete-BZWJW45s.js";import{_ as Gt}from"./round-add-GrHQV5ws.js";import{d as Le,aq as $e,p as _t,s as Ae,r as I,q as bt,$ as x,W as u,A as F,B as m,an as ct,at as ye,a as Kt,ar as Ze,a1 as St,b as kt,o as ae,a5 as Ht,f as a,aw as Wt,w as l,as as Xt,F as wt,E as Ct,c as _e,y as Xe,h as s,au as Ie,am as Yt,e as X,N as ie,g as _,av as et,t as re,b6 as Dt,a2 as Qt,bp as Zt,bZ as ea,U as tt,a8 as pt,ab as Fe,ac as ta,L as aa,c0 as na,bY as sa,i as la,x as Pe,az as Ue,C as we,bl as oa,aa as ia,aC as ra}from"./index-3FI-9vFh.js";import{i as ua,j as da,g as ca,h as mt,w as pa,x as ma,u as fa,v as ft,Q as xt,R as gt,S as ga,T as vt,U as va,V as ha,W as ya,M as ht,O as _a,A as ba,C as Sa,k as ka,L as wa,a as Ca,N as Da,s as xa,o as za,X as yt,f as Na}from"./project-BpdyYAbX.js";import{u as Qe,a as Pa}from"./table-Dxi-UXTP.js";import{_ as Ia}from"./round-plus-CuFcWbnF.js";import{_ as ja,a as Ta,A as Aa}from"./index-3S-Z4f-E.js";import{f as at,g as Ua,h as zt,p as $a,d as Fa}from"./business-pP3NmV4b.js";import{u as La}from"./usePageData-BOF278ji.js";import{v as Oa}from"./v4-FuVw324d.js";import{N as Ce}from"./Popconfirm-D6sEyWfL.js";import{_ as Nt}from"./Grid-BYxpeW0k.js";import{_ as Pt}from"./FormItemGridItem-CvZHCSgb.js";import{N as Ea}from"./Upload-DfcVQ94T.js";import{_ as Ma}from"./round-search-Ckx7Z4LK.js";import{_ as Ra}from"./round-refresh-8pNylQuL.js";import{N as Va}from"./DatePicker-B-9-ouS5.js";import{N as Ba}from"./RadioButton-DfIS8vq6.js";import{N as Ja}from"./Progress-C7S5sdaN.js";import"./utils-9s3IW4K-.js";const qa={style:{display:"flex","flex-direction":"column"}},Ga={style:{display:"flex","flex-direction":"column"}},Ka={style:{display:"flex","flex-direction":"column"}},Ha=Le({name:"OperateDrawer",__name:"operate-drawer",props:$e({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:$e(["submitted"],["update:visible"]),setup(L,{emit:Y}){const S=_t(),q=Y,O=Ae({contactList:[],debuggedDevieceList:[]}),r=L,o=Ae(Q());function Q(){return{proname:"",dispatchIds:[],contractIds:[],proaddr:"",cpdbtime:null,prosite:"",longitude:120.373885,latitude:30.303899,period:void 0,dtype:void 0,dispatch:"",status:1}}const T=I(0),G=I(void 0);async function R(){Object.assign(o,Q()),Mt(),r.operateType==="edit"&&r.rowData&&(Object.assign(o,r.rowData),T.value=o.period,G.value=o.status,await it(),ut(o.proaddr||o.prosite),Ft())}const{formRef:f,validate:k,restoreValidation:ue}=bt(),A={proname:{type:"string",required:!0,trigger:["blur","change"],message:"请输入项目名称"},status:{type:"number",required:!0,trigger:["blur","change"],message:"请选择项目状态"},contractIds:{type:"array",required:!0,trigger:["blur","change"],message:"请选择合同"},dtype:{type:"number",required:!0,trigger:["blur","change"],message:"请选择调试类型"},period:{type:"number",required:!0,trigger:["blur","change"],message:"请输入周期"},prosite:{type:"string",required:!0,trigger:["blur","change","focus"],message:"请选择项目地点"},cpdbtime:{type:"string",required:!0,trigger:["blur","change"],message:"请选择时间"}},h=I([]),E=Ae({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",pageSizes:[20],prefix:()=>`共 ${h.value.length} 条`,onChange:e=>{E.page=e,z()},onUpdatePageSize:e=>{E.pageSize=e,E.page=1,z()}}),y=[{title:"姓名",key:"pname",align:"center",render(e,t){return e.setStatus?u(F,{value:e.pname,placeholder:"请输入姓名",onUpdateValue(n){h.value[t].pname=n}}):u("div",{},e.pname)}},{title:"联系方式",key:"pcontact",align:"center",render(e,t){return e.setStatus?u(F,{value:e.pcontact,placeholder:"请输入联系方式",onUpdateValue(n){h.value[t].pcontact=n}}):u("div",{},e.pcontact)}},{title:"备注",key:"proposition",align:"center",render(e,t){return e.setStatus?u(F,{value:e.proposition,placeholder:"请输入备注",onUpdateValue(n){h.value[t].proposition=n}}):u("div",{},e.proposition)}},{key:"operate",title:x("common.operate"),align:"center",minWidth:120,fixed:"right",render(e,t){return u("div",{class:"flex-center gap-8px"},[e.setStatus?[u(m,{type:"primary",ghost:!0,size:"small",onClick:()=>ce(e)},{default:()=>"保存"}),u(m,{type:"default",ghost:!0,size:"small",onClick:()=>de(e,t)},{default:()=>"取消"}),u(Ce,{onPositiveClick:()=>{r.operateType==="edit"&&e.id?ua(e.id).then(()=>{var n;h.value.splice(t,1),(n=window.$message)==null||n.success("删除成功")}):h.value.splice(t,1)}},{default:()=>x("common.confirmDelete"),trigger:()=>u(m,{type:"error",ghost:!0,size:"small"},{default:()=>x("common.delete")})})]:u(m,{type:"primary",ghost:!0,size:"small",onClick:()=>ne(e)},{default:()=>"编辑"})])}}],z=async()=>{var t;const{data:e}=await da({page:E.page,limit:E.pageSize,pid:(t=r.rowData)==null?void 0:t.id});h.value=e==null?void 0:e.list,h.value.forEach(n=>{n.setStatus=!1}),O.contactList=JSON.parse(JSON.stringify(h.value))},ne=e=>{h.value.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus},de=(e,t)=>{e.setStatus=!e.setStatus,e.id?h.value=JSON.parse(JSON.stringify(O.contactList)):h.value.splice(t,1)},ce=async e=>{var t,n,p,g,b;if(!e.pname){(t=window.$message)==null||t.warning("请输入联系人姓名");return}if(!e.pcontact){(n=window.$message)==null||n.warning("请输入联系方式");return}if(r.operateType==="edit")if(e.id){const{data:P,error:C}=await ca([e]);C||((p=window.$message)==null||p.success("修改成功"),z(),e.setStatus=!e.setStatus)}else{const{data:P,error:C}=await mt([{...e,pid:(g=r.rowData)==null?void 0:g.id}]);C||((b=window.$message)==null||b.success("添加成功"),z(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function U(){var e;((e=h.value[0])!=null&&e.pname||h.value.length==0)&&h.value.unshift({pname:"",pcontact:"",proposition:"",setStatus:!0})}const v=I([]),w=Ae({page:1,pageSize:20,showSizePicker:!0,fuzzy:"",pageSizes:[20],prefix:()=>`共 ${v.value.length} 条`,onChange:e=>{w.page=e,pe()},onUpdatePageSize:e=>{w.pageSize=e,w.page=1,pe()}}),De=[{title:"设备名称",key:"devname",align:"center",render(e,t){return e.setStatus?u(F,{value:e.devname,placeholder:"请输入设备名称",onUpdateValue(n){v.value[t].devname=n}}):u("div",{},e.devname)}},{title:"型号",key:"devmodel",align:"center",render(e,t){return e.setStatus?u(F,{value:e.devmodel,placeholder:"请输入型号",onUpdateValue(n){v.value[t].devmodel=n}}):u("div",{},e.devmodel)}},{title:"数量",key:"devnum",align:"center",render(e,t){return e.setStatus?u(ct,{value:e.devnum,placeholder:"请输入数量",onUpdateValue(n){v.value[t].devnum=Number(n)||0}}):u("div",{},e.devnum)}},{title:"是否为我司设备",key:"etype",align:"center",render(e,t){return e.setStatus?u(ye,{value:e.etype,options:[{label:"是",value:0},{label:"否",value:1}],onUpdateValue(n){v.value[t].etype=n}}):u("div",{},e.etype===0?"是":"否")}},{title:"设备厂家",key:"devmanu",align:"center",render(e,t){return e.setStatus?u(F,{value:e.devmanu,placeholder:"请输入设备厂家",onUpdateValue(n){v.value[t].devmanu=n}}):u("div",{},e.devmanu)}},{title:"备注",key:"notes",align:"center",render(e,t){return e.setStatus?u(F,{value:e.notes,placeholder:"请输入备注",onUpdateValue(n){v.value[t].notes=n}}):u("div",{},e.notes)}},{title:"清点状态",key:"status",align:"center",render(e,t){return e.setStatus?u(ye,{value:e.status,options:[{label:"未清点",value:0},{label:"正常",value:1},{label:"增补",value:2},{label:"退货",value:3},{label:"换货",value:4}],onUpdateValue(n){v.value[t].status=n}}):u("div",{},e.status===0?"未清点":e.status===1?"正常":e.status===2?"增补":e.status===3?"退货":"换货")}},{key:"operate",title:x("common.operate"),align:"center",width:180,fixed:"right",render(e,t){return u("div",{class:"flex-center gap-8px"},[e.setStatus?[u(m,{type:"primary",ghost:!0,size:"small",onClick:()=>be(e)},{default:()=>"保存"}),u(m,{type:"default",ghost:!0,size:"small",onClick:()=>Ee(e,t)},{default:()=>"取消"}),u(Ce,{onPositiveClick:()=>{r.operateType==="edit"&&e.id?pa(e.id).then(()=>{var n;v.value.splice(t,1),(n=window.$message)==null||n.success("删除成功")}):v.value.splice(t,1)}},{default:()=>x("common.confirmDelete"),trigger:()=>u(m,{type:"error",ghost:!0,size:"small"},{default:()=>x("common.delete")})})]:u(m,{type:"primary",ghost:!0,size:"small",onClick:()=>Oe(e)},{default:()=>"编辑"})])}}],pe=async()=>{var t;const{data:e}=await ma({page:w.page,limit:w.pageSize,fuzzy:w.fuzzy,pid:(t=r.rowData)==null?void 0:t.id});v.value=e.list,O.debuggedDevieceList=JSON.parse(JSON.stringify(v.value))},Oe=e=>{v.value.forEach(t=>{t.setStatus=!1}),e.setStatus=!e.setStatus},Ee=(e,t)=>{e.setStatus=!e.setStatus,e.id?v.value=JSON.parse(JSON.stringify(O.debuggedDevieceList)):v.value.splice(t,1)},be=async e=>{var n,p,g,b,P,C;if(!e.devname){(n=window.$message)==null||n.warning("设备名称不能为空");return}if(!e.devmodel){(p=window.$message)==null||p.warning("设备型号不能为空");return}if(!e.devnum){(g=window.$message)==null||g.warning("设备数量不能为空");return}const t=e.dcreater*1;if(r.operateType==="edit")if(e.id){const{data:M,error:j}=await fa([{...e,dcreater:t}]);j||((b=window.$message)==null||b.success("修改成功"),pe(),e.setStatus=!e.setStatus)}else{const{data:M,error:j}=await ft([{...e,pid:(P=r.rowData)==null?void 0:P.id,dcreater:t}]);j||((C=window.$message)==null||C.success("添加成功"),pe(),e.setStatus=!e.setStatus)}else e.setStatus=!e.setStatus};function Me(){var e;((e=v.value[0])!=null&&e.devname||v.value.length==0)&&v.value.unshift({status:void 0,devmanu:"",etype:0,devname:"",devmodel:"",devnum:0,notes:"",setStatus:!0})}const Re=I({}),V=I([]);async function i(){var t;V.value=[];const{data:e}=await Da({page:1,limit:100,pid:(t=r.rowData)==null?void 0:t.id});e.list.forEach(n=>{n.sort==1&&V.value.push({id:n.id,name:n.filename,url:n.file,status:"finished",creator:n.username,dbtime:n.dbtime})}),V.value.reverse(),Re.value=JSON.parse(JSON.stringify(e))}const d=[{title:"文件别名",key:"name",align:"center",width:200,render(e){return e.setStatus?u(F,{value:e.name,onUpdateValue:t=>{e.name=t}}):u("div",{},e.name)}},{title:"文件名称",key:"filename",align:"center",width:200,render(e){return e.setStatus&&!e.url?u(Ea,{action:"#",showFileList:!1,customRequest:async({file:n,onFinish:p,onError:g})=>{var b,P,C,M;try{const j=new FormData;j.append("multipartFile",n.file);const{data:W,error:Z}=await Ca(j);if(Z){(P=(b=window.$message)==null?void 0:b.error)==null||P.call(b,"文件上传失败");return}W&&(e.url=W)}catch(j){console.error(j),(M=(C=window.$message)==null?void 0:C.error)==null||M.call(C,"文件上传出错")}}},{default:()=>u(m,{type:"info",size:"small",ghost:!0},{default:()=>"上传文件"})}):e.setStatus&&e.url&&!e.id?a("span",null,[e.url.split("?")[1],_(" "),a("span",{onClick:()=>e.url=""},[_("X")])]):u("div",{},e.url.split("?")[1])}},{title:"上传人",key:"creator",align:"center",width:100,render(e){return u("div",{},e.creator)}},{title:"上传时间",key:"dbtime",align:"center",width:200,render(e){return u("div",{},e.dbtime?e.dbtime:"")}},{title:"操作",key:"actions",align:"center",width:180,render(e){return u(ie,{justify:"center"},[!e.setStatus&&e.id&&u(m,{type:"info",size:"small",ghost:!0,onClick:()=>{$(e)}},{default:()=>"下载"}),e.setStatus&&u(m,{type:"info",size:"small",ghost:!0,onClick:()=>{fe(e)}},{default:()=>"保存"}),e.setStatus&&u(m,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"取消"}),!e.setStatus&&u(m,{type:"info",size:"small",ghost:!0,onClick:()=>{e.setStatus=!e.setStatus}},{default:()=>"编辑"})])}}];async function $(e){if(e!=null&&e.url)try{const n=await(await fetch(e.url.split("?")[0],{mode:"cors"})).blob(),p=URL.createObjectURL(n),g=document.createElement("a");g.href=p,g.download=e.url.split("?")[1],g.style.display="none",document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(p)}catch(t){console.error("下载失败:",t)}}const me=()=>{V.value.push({id:"",name:"",url:"",status:"uploading",setStatus:!0})},fe=async e=>{var t,n,p,g,b,P,C,M,j,W,Z,he;if(!e.name){(n=(t=window.$message)==null?void 0:t.warning)==null||n.call(t,"请输入文件别名");return}if(!e.url){(g=(p=window.$message)==null?void 0:p.warning)==null||g.call(p,"请上传文件");return}if((b=r.rowData)!=null&&b.id){const{data:c,error:ze}=await ht([{pid:(P=r.rowData)==null?void 0:P.id,filename:e.name,file:e.url,sort:1}]);if(ze)return(C=window.$message)==null?void 0:C.error("保存文件记录失败");(M=window.$message)==null||M.destroyAll(),e.setStatus=!e.setStatus,i(),(j=window.$message)==null||j.success("保存成功")}else if(e.id){const{data:c,error:ze}=await wa([{id:e.id,filename:e.name}]);if(ze)return(W=window.$message)==null?void 0:W.error("保存文件记录失败");(Z=window.$message)==null||Z.destroyAll(),e.setStatus=!e.setStatus,(he=window.$message)==null||he.success("编辑成功")}else e.setStatus=!e.setStatus},Ve=Kt(()=>({add:"新增项目",edit:"修改项目"})[r.operateType]),ge=Ze(L,"visible");St(ge,()=>{ge.value&&(R(),setTimeout(()=>{const e=document.querySelector(".n-scrollbar-content");e==null||e.scrollTo(0,0)},300),ue())});function Be(e){e||K()}function K(){ge.value=!1}function Je(){ve.value=!1}async function xe(){var e;await k(),(e=window.$dialog)==null||e.info({title:"提示",content:"确定提交吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await N()}})}async function N(){var e,t,n,p,g,b,P,C,M,j,W,Z,he;if(r.operateType==="edit"){const c=JSON.parse(JSON.stringify(o));T.value==c.period&&delete c.period,G.value==c.status&&delete c.status;const{data:ze,error:We}=await xt([c]);if(!We){let ee=function(te,B){const J=te.filter(oe=>!B.includes(oe)),Se=B.filter(oe=>!te.includes(oe));return{toDelete:J,toAdd:Se}};if((e=o.dispatchIds)!=null&&e.length&&((t=o.dispatchIds)==null?void 0:t.length)>0){const{toDelete:te,toAdd:B}=ee(lt.value,o.dispatchIds);if(B.length>0){const J=B.map(Te=>({pid:o.id,did:Te})),{data:Se,error:oe}=await gt(J)}if(te.length>0){const{data:J,error:Se}=await ga(te.join(","))}}if((n=o.contractIds)!=null&&n.length&&((p=o.contractIds)==null?void 0:p.length)>0){const{toDelete:te,toAdd:B}=ee(Vt.value,o.contractIds);if(B.length>0){const J=B.map(Te=>({pid:o.id,did:Te})),{data:Se,error:oe}=await vt(J)}if(te.length>0){const{data:J,error:Se}=await va(te.join(","))}}K(),q("submitted"),(g=window.$message)==null||g.success("修改成功")}}else{const c=Oa(),{data:ze,error:We}=await ha([{...o,uuid:c}]);if(!We){const{data:ee,error:te}=await ya(c);if(ee){let B=function(D,ke,dt){return D.map(Ne=>({...Ne,pid:ke}))};if(o.dispatchIds&&o.dispatchIds.length>0){const D=[];(b=o.dispatchIds)==null||b.forEach(async Ne=>{D.push({pid:ee,did:Ne})});const{data:ke,error:dt}=await gt(D)}if(o.contractIds&&o.contractIds.length>0){const D=[];(P=o.contractIds)==null||P.forEach(async Ne=>{D.push({proid:ee,conid:Ne})});const{data:ke,error:dt}=await vt(D)}const J=[];if(h.value.length>0){const D=B(h.value,ee);J.push(mt(D))}if(v.value.length>0){const D=B(v.value,ee);J.push(ft(D))}if((await Promise.allSettled(J)).forEach((D,ke)=>{D.status==="fulfilled"?console.log(`第 ${ke+1} 个请求成功`,D.value):console.error(`第 ${ke+1} 个请求失败`,D.reason)}),!V.value.length){(C=window.$message)==null||C.destroyAll(),(M=window.$message)==null||M.success("操作成功"),K(),q("submitted");return}const oe=[];V.value.forEach(D=>{oe.push({pid:ee,filename:D.name,file:D.url,sort:1})});const{data:Te,error:Bt}=await ht(oe);Bt&&((j=window.$message)==null||j.error("保存文件记录失败")),(W=window.$message)==null||W.destroyAll(),(Z=window.$message)==null||Z.success("操作成功"),K(),q("submitted")}}K(),q("submitted"),(he=window.$message)==null||he.success("添加成功")}}const ve=I(!1),qe=I();async function It(){const e="/map-sdk.json";try{return(await Zt.get(`${e}?_t=${Date.now()}`)).data}catch(t){throw console.error("获取地图 SDK 配置失败:",t),t}}let se=null,nt=null,je=null,st=null,H=null;const le=I(""),Ge=I([]);async function jt(){const e=await It();if(window._AMapSecurityConfig={securityJsCode:e.AMAP_SDK_SECRET},!!qe.value)try{H=await Aa.load({key:e.AMAP_SDK_KEY,version:"2.0",plugins:["AMap.Scale","AMap.PlaceSearch","AMap.AutoComplete","AMap.Lnglat","AMap.Geocoder","AMap.Geolocation"]}),se=new H.Map(qe.value,{zoom:18,center:[o.longitude,o.latitude],viewMode:"3D",resizeEnable:!0});const t=new H.Geolocation({enableHighAccuracy:!0,timeout:1e4,position:"RT",buttonOffset:new H.Pixel(10,20),zoomToAccuracy:!0});se.addControl(t),se.addControl(new H.Scale),nt=new H.Geocoder,st=new H.PlaceSearch({pageSize:50}),se.on("click",n=>{console.log("e",n);const p=n.lnglat.lng,g=n.lnglat.lat;Ke(H,{lng:p,lat:g})}),Ke(H,{lng:o.longitude,lat:o.latitude})}catch(t){console.error("地图加载失败:",t)}}function Tt(){le.value.trim()&&st.search(le.value,(e,t)=>{if(console.log(e,t),Ge.value=[],e==="complete"&&t.info==="OK"){const n=t.poiList.pois;n.length>0&&n.forEach(p=>{const{address:g,location:b}=p;Ge.value.push({label:g,value:b.lng+"_"+b.lat})})}else console.log("搜索失败或无结果")})}function At(){ve.value=!0,Qt(()=>{jt()})}function Ut(e){console.log("key",le.value),console.log("val",e);let t=e.split("_")[0],n=e.split("_")[1];se.setCenter([t,n]),Ke(H,{lng:t,lat:n})}function Ke(e,t){je&&se.remove(je),je=new e.Marker({position:[t.lng,t.lat],map:se}),se.add(je),nt.getAddress(t,(n,p)=>{n==="complete"&&p.regeocode&&(console.log("result",p),console.log("formattedAddress",p.regeocode.formattedAddress),o.latitude=t.lat,o.longitude=t.lng,le.value=p.regeocode.formattedAddress)})}function $t(e,t){if(!t)return null;const n=t.replace(/省|市|特别行政区|自治区|壮族|回族|维吾尔/g,"").trim(),p=e.find(g=>t.includes(g.name)||g.name.includes(n));return p?p.id:null}const lt=I([]),Ft=async()=>{const{data:e,error:t}=await _a({page:1,limit:100,pid:r.rowData.id});o.dispatchIds=e==null?void 0:e.list.map(n=>n.did),lt.value=JSON.parse(JSON.stringify(o.dispatchIds))},ot=I([]),it=async()=>{const{data:e,error:t}=await ba();e&&(ot.value=e)},rt=I([]),ut=async e=>{let t=$t(ot.value,e);const{data:n,error:p}=await Sa({page:1,limit:100,province:t});rt.value=n.list},Lt=async()=>{await it(),o.prosite=le.value,ut(le.value),ve.value=!1},{pageData:He,getData:Ot,nextPage:Et}=La(ka),Mt=async()=>{await Ot({limit:100})},Rt=async e=>{const t=e.currentTarget;t.scrollTop+t.offsetHeight>=t.scrollHeight&&He.data.length<He.total&&Et()},Vt=I([]);return(e,t)=>{const n=Pt,p=ja,g=Yt,b=Ia,P=et,C=Nt,M=wt,j=Xt,W=Wt,Z=Ta,he=Dt;return ae(),kt(Ht,null,[a(W,{show:ge.value,"onUpdate:show":[t[9]||(t[9]=c=>ge.value=c),Be],"display-directive":"show",width:1100,onMaskClick:K,onEsc:K},{default:l(()=>[a(j,{title:Ve.value,"native-scrollbar":!1,closable:""},{footer:l(()=>[a(s(ie),{size:16,justify:"end"},{default:l(()=>[a(s(m),{onClick:K},{default:l(()=>[_(re(s(x)("common.cancel")),1)]),_:1}),a(s(m),{type:"primary",onClick:xe},{default:l(()=>[_(re(s(x)("common.confirm")),1)]),_:1})]),_:1})]),default:l(()=>[a(M,{ref_key:"formRef",ref:f,model:o,rules:A,onKeyup:Ct(xe,["enter"])},{default:l(()=>[a(C,{responsive:"screen","item-responsive":"","x-gap":"15"},{default:l(()=>[a(n,{span:"24 s:12 m:12",label:"项目名称",path:"proname"},{default:l(()=>[a(s(F),{clearable:"",value:o.proname,"onUpdate:value":t[0]||(t[0]=c=>o.proname=c),placeholder:"请输入项目名称"},null,8,["value"])]),_:1}),r.operateType==="add"?(ae(),_e(n,{key:0,span:"24 s:12 m:12",label:"绑定合同",path:"contractIds"},{default:l(()=>[a(s(ye),{filterable:"",multiple:"",value:o.contractIds,"onUpdate:value":t[1]||(t[1]=c=>o.contractIds=c),placeholder:"请选择合同","label-field":"contractname","value-field":"id",options:s(He).data,onScroll:Rt},null,8,["value","options"])]),_:1})):Xe("",!0),r.operateType==="edit"?(ae(),_e(n,{key:1,span:"24 s:12 m:12",label:"项目状态",path:"status"},{default:l(()=>[a(s(ye),{filterable:"",value:o.status,"onUpdate:value":t[2]||(t[2]=c=>o.status=c),placeholder:"请选择项目状态",options:s(Ie)(s(S).userInfo.usertype==0||s(S).userInfo.usertype==2?s(at):s(Ua))},null,8,["value","options"])]),_:1})):Xe("",!0),a(n,{span:"24 s:12 m:12",label:"调度名称",path:"dispatch"},{default:l(()=>[a(s(F),{clearable:"",value:o.dispatch,"onUpdate:value":t[3]||(t[3]=c=>o.dispatch=c),placeholder:"请输入调度名称"},null,8,["value"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"调试类型",path:"dtype"},{default:l(()=>[a(s(ye),{filterable:"",value:o.dtype,"onUpdate:value":t[4]||(t[4]=c=>o.dtype=c),placeholder:"请选择调试类型",options:s(Ie)(s(zt))},null,8,["value","options"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"周期（天）",path:"period"},{default:l(()=>[a(s(ct),{clearable:"",value:o.period,"onUpdate:value":t[5]||(t[5]=c=>o.period=c),style:{width:"100%"},placeholder:"请输入周期"},null,8,["value"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"项目地点",path:"prosite"},{default:l(()=>[a(g,{onClick:At},{default:l(()=>[a(s(F),{value:o.prosite,"onUpdate:value":t[6]||(t[6]=c=>o.prosite=c),placeholder:"请输入项目地点"},null,8,["value"]),a(s(m),null,{icon:l(()=>[a(p,{class:"text-icon"})]),_:1})]),_:1})]),_:1}),a(n,{span:"24 s:12 m:12",label:"选择调度",path:"dispatchIds"},{default:l(()=>[a(s(ye),{filterable:"",multiple:"",value:o.dispatchIds,"onUpdate:value":t[7]||(t[7]=c=>o.dispatchIds=c),placeholder:"请选择所属项目","label-field":"dname","value-field":"id",options:rt.value},null,8,["value","options"])]),_:1}),a(n,{span:"24 s:12 m:12",label:"项目详细地址",path:"proaddr"},{default:l(()=>[a(s(F),{type:"textarea",rows:1,clearable:"",value:o.proaddr,"onUpdate:value":t[8]||(t[8]=c=>o.proaddr=c),placeholder:"请输入项目详细地址"},null,8,["value"])]),_:1}),a(n,{span:"24 s:12 m:24",path:"contactList"},{default:l(()=>[X("div",qa,[a(s(ie),{align:"center",style:{"margin-bottom":"10px"}},{default:l(()=>[t[13]||(t[13]=X("span",null,"项目联系人",-1)),a(s(m),{size:"small",ghost:"",type:"primary",onClick:U},{icon:l(()=>[a(b,{class:"text-icon"})]),default:l(()=>[t[12]||(t[12]=_(" 添加项目联系人 "))]),_:1,__:[12]})]),_:1,__:[13]}),a(P,{columns:y,"paginate-single-page":!1,data:h.value,pagination:E,"max-height":350},null,8,["data","pagination"])])]),_:1}),a(n,{span:"24 s:12 m:24",path:"debuggedDevieceList"},{default:l(()=>[X("div",Ga,[a(s(ie),{align:"center",style:{"margin-bottom":"10px"}},{default:l(()=>[t[15]||(t[15]=X("span",null,"待调试设备",-1)),a(s(m),{size:"small",ghost:"",type:"primary",onClick:Me},{icon:l(()=>[a(b,{class:"text-icon"})]),default:l(()=>[t[14]||(t[14]=_(" 添加待调试设备 "))]),_:1,__:[14]})]),_:1,__:[15]}),a(P,{columns:De,"paginate-single-page":!1,data:v.value,pagination:w,"max-height":350},null,8,["data","pagination"])])]),_:1}),a(n,{span:"24 s:12 m:24"},{default:l(()=>[X("div",Ka,[a(s(ie),{align:"center",style:{"margin-bottom":"10px"}},{default:l(()=>[t[17]||(t[17]=X("span",null,"图纸",-1)),a(s(m),{size:"small",ghost:"",type:"primary",onClick:me},{icon:l(()=>[a(b,{class:"text-icon"})]),default:l(()=>[t[16]||(t[16]=_(" 添加图纸 "))]),_:1,__:[16]})]),_:1,__:[17]}),V.value.length>0?(ae(),_e(P,{key:0,columns:d,data:V.value,size:"small","scroll-x":702,"row-key":c=>c.id,"max-height":350},null,8,["data","row-key"])):Xe("",!0)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"]),a(he,{show:ve.value,"onUpdate:show":t[11]||(t[11]=c=>ve.value=c),title:"选择项目位置",preset:"card",class:"w-800px"},{footer:l(()=>[a(s(ie),{justify:"end",size:16},{default:l(()=>[a(s(m),{onClick:Je},{default:l(()=>[_(re(s(x)("common.cancel")),1)]),_:1}),a(s(m),{type:"primary",onClick:Lt},{default:l(()=>[_(re(s(x)("common.confirm")),1)]),_:1})]),_:1})]),default:l(()=>[a(Z,{value:le.value,"onUpdate:value":[t[10]||(t[10]=c=>le.value=c),Tt],options:Ge.value,placeholder:"请输入地点关键字",clearable:"",onSelect:Ut},null,8,["value","options"]),X("div",{ref_key:"domRef",ref:qe,class:"h-full w-full",style:{width:"100%",height:"500px","margin-top":"10px"}},null,512)]),_:1},8,["show"])],64)}}}),Wa=Le({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:$e(["reset","search"],["update:model"]),setup(L,{emit:Y}){ea();const S=Y,{formRef:q,restoreValidation:O}=bt(),r=Ze(L,"model"),o={当日:()=>{const f=new Date().getTime();return[f,f]},本周:()=>{const f=new Date().getTime();return[f-24*60*60*1e3*7,f]},上月:()=>{const f=new Date().getTime();return[f-24*60*60*1e3*30,f]},近一年:()=>{const f=new Date().getTime();return[f-24*60*60*1e3*365,f]},近三年:()=>{const f=new Date().getTime();return[f-24*60*60*1e3*365*3,f]}};function Q(){r.value.fuzzy="",S("search")}async function T(f,k){if(!f){r.value.startTime=void 0,r.value.endTime=void 0,S("search");return}r.value.startTime=String(pt(1,k[0])),r.value.endTime=String(pt(1,k[1])),S("search")}async function G(){r.value.startTime=void 0,r.value.endTime=void 0,r.value.startAndTimeRange=null,r.value.fuzzy="",r.value.status=null,r.value.ptype=null,r.value.dtype=null,await O(),S("reset")}async function R(){S("search")}return(f,k)=>{const ue=F,A=Pt,h=ye,E=Va,y=Ra,z=m,ne=Ma,de=ie,ce=Nt,U=wt,v=tt;return ae(),_e(v,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[a(U,{ref_key:"formRef",ref:q,model:r.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:Ct(R,["enter"])},{default:l(()=>[a(ce,{responsive:"screen","item-responsive":"","x-gap":16,"y-gap":16},{default:l(()=>[a(A,{span:"24 s:12 m:6",label:"项目名称",path:"fuzzy"},{default:l(()=>[a(ue,{clearable:"",value:r.value.fuzzy,"onUpdate:value":k[0]||(k[0]=w=>r.value.fuzzy=w),placeholder:"请输入项目名称",onClear:Q},null,8,["value"])]),_:1}),a(A,{span:"24 s:12 m:6",label:"项目状态",path:"status"},{default:l(()=>[a(h,{clearable:"",filterable:"",value:r.value.status,"onUpdate:value":[k[1]||(k[1]=w=>r.value.status=w),R],placeholder:"请选择项目状态",options:s(Ie)(s(at))},null,8,["value","options"])]),_:1}),a(A,{span:"24 s:12 m:6",label:"进度状态",path:"ptype"},{default:l(()=>[a(h,{clearable:"",filterable:"",value:r.value.ptype,"onUpdate:value":[k[2]||(k[2]=w=>r.value.ptype=w),R],placeholder:"请选择进度状态",options:[{label:"正常",value:0},{label:"已延期",value:1}]},null,8,["value"])]),_:1}),a(A,{span:"24 s:12 m:6",label:"调试类型",path:"dtype"},{default:l(()=>[a(h,{clearable:"",filterable:"",value:r.value.dtype,"onUpdate:value":[k[3]||(k[3]=w=>r.value.dtype=w),R],placeholder:"请选择调试类型",options:s(Ie)(s(zt))},null,8,["value","options"])]),_:1}),a(A,{span:"24 s:12 m:8",label:"起止时间"},{default:l(()=>[a(E,{value:r.value.startAndTimeRange,"onUpdate:value":k[4]||(k[4]=w=>r.value.startAndTimeRange=w),type:"datetimerange",clearable:"",shortcuts:o,"onUpdate:formattedValue":T},null,8,["value"])]),_:1}),a(A,{span:"24  s:12 m:6",class:"pr-24px"},{default:l(()=>[a(de,{class:"w-full"},{default:l(()=>[a(z,{onClick:G},{icon:l(()=>[a(y,{class:"text-icon"})]),default:l(()=>[_(" "+re(s(x)("common.reset")),1)]),_:1}),a(z,{type:"primary",ghost:"",onClick:R},{icon:l(()=>[a(ne,{class:"text-icon"})]),default:l(()=>[_(" "+re(s(x)("common.search")),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),Xa={class:"min-h-500px flex gap-16px"},Ya={class:"flex items-center justify-end gap-16px"},Qa=Le({__name:"relatedContractLook",props:$e({id:{}},{visable:{type:Boolean},visableModifiers:{}}),emits:["update:visable"],setup(L){const Y=L,S=Ze(L,"visable"),{columns:q,data:O,getData:r,loading:o,mobilePagination:Q,searchParams:T}=Qe({apiFn:xa,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,id:Y.id,_t:new Date().getTime()},columns:()=>[{key:"contractname",title:"合同",width:200,render:y=>a("div",{class:A.pids==y.id?"bg-#f1f1f1 cursor-pointer p-5px":"cursor-pointer p-5px",onClick:()=>h(y.id)},[a("div",{class:"flex"},[a("div",{class:"w-60px inline-block"},[_("名称：")]),y.contractname]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("编号：")]),_(" "),y.contractnum]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("联系人：")]),y.businesscon]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("联系方式：")]),y.businessinfo]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("注意事项：")]),y.precautions]),a("div",{class:"font-size-12px c-#7d7575 flex"},[a("div",{class:"w-60px inline-block"},[_("备注：")]),y.notes])])}]}),{columns:G,data:R,getData:f,loading:k,mobilePagination:ue,searchParams:A}=Qe({apiFn:za,immediate:!1,apiParams:{page:1,pageSize:20,limit:20,pids:Y.id,_t:new Date().getTime()},columns:()=>[{key:"devname",title:"设备名称",align:"center",width:200,ellipsis:{tooltip:!0}},{key:"devcount",title:"数量",align:"center",width:120},{key:"devmodel",title:"规格型号",align:"center",width:120,ellipsis:{tooltip:!0}},{key:"devunit",title:"单位",align:"center",width:120},{key:"devtype",title:"是否为我司设备",align:"center",width:120,render:y=>y.devtype==0?a(Fe,{type:"success"},{default:()=>[_("是")]}):a(Fe,{type:"info"},{default:()=>[_("否")]})},{key:"devmanu",title:"设备厂家",align:"center",width:120},{key:"notes",title:"备注",align:"center",width:120},{key:"username",title:"创建人",align:"center",width:120},{key:"dbtime",title:"创建时间",align:"center",width:180}]}),h=y=>{A.pids=y,f()},E=()=>{S.value=!1};return St(()=>S.value,async y=>{var z;y&&(T.id=Y.id,await r(),A.pids=(z=O.value[0])==null?void 0:z.id,A.pids&&f())}),(y,z)=>{const ne=et,de=tt,ce=Dt;return ae(),_e(ce,{show:S.value,"onUpdate:show":z[0]||(z[0]=U=>S.value=U),preset:"card",class:"w-1400px",title:"项目关联的合同"},{footer:l(()=>[X("div",Ya,[a(s(m),{type:"primary",size:"small",onClick:E},{default:l(()=>z[1]||(z[1]=[_(" 关闭 ")])),_:1,__:[1]})])]),default:l(()=>[X("div",Xa,[a(ne,{class:"left",columns:s(q),data:s(O),"paginate-single-page":!1,size:"small",remote:"",loading:s(o),pagination:s(Q),"row-key":U=>U.id,"max-height":600},null,8,["columns","data","loading","pagination","row-key"]),a(de,{bordered:!1,size:"small",title:"设备",class:"w-1100px"},{default:l(()=>[a(ne,{style:{width:"100%"},columns:s(G),data:s(R),size:"small","max-height":600,loading:s(k),remote:"","scroll-x":s(G).reduce((U,v)=>U+(v.width||100),0),"paginate-single-page":!1,pagination:s(ue),"row-key":U=>U.id},null,8,["columns","data","loading","scroll-x","pagination","row-key"])]),_:1})])]),_:1},8,["show"])}}}),Za=ta(Qa,[["__scopeId","data-v-24e63d5c"]]),en={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Ye(L){return typeof L=="function"||Object.prototype.toString.call(L)==="[object Object]"&&!ra(L)}const Cn=Le({name:"projectmanagement_projectlist",__name:"index",setup(L){const Y=aa(),S=_t(),q=na(),O=sa(),{columns:r,columnChecks:o,data:Q,getData:T,loading:G,mobilePagination:R,searchParams:f}=Qe({showTotal:!0,apiFn:Na,apiParams:{page:1,pageSize:20,limit:20,status:null,startAndTimeRange:null,startTime:null,endTime:null,creater:void 0,fuzzy:"",_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48},{key:"proname",title:"项目名称",align:"center",width:240},{key:"progess",title:"项目进度",align:"center",width:140,render:i=>a(Ja,{type:"line",showIndicator:!0,percentage:i.progess,"indicator-placement":"inside",processing:!0,color:"#1890ff"},null)},{key:"status",title:"项目状态",align:"center",width:120,defaultFilterOptionValue:null,filterOptions:Ie(at),filter:!0,filterMultiple:!1,render:i=>{if(i.status===null)return null;const d=x($a[i.status]);return a("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",color:i.status===0?"#3498db":i.status===1?"#f39c12":i.status===2?"#f1c40f":"#2ecc71",borderRadius:"50%"}},[a("span",{style:{width:"10px",height:"10px",marginRight:"5px",backgroundColor:i.status===0?"#3498db":i.status===1?"#f39c12":i.status===2?"#f1c40f":"#2ecc71",borderRadius:"50%"}},null),a("span",null,[d])])}},{key:"cpdbtime",title:"预计完成日期",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"period",title:"周期",align:"center",width:100,render:i=>a("div",null,[i.period,_("天")])},{key:"ptype",title:"状态",align:"center",width:100,render:i=>a(Fe,{type:i.ptype===0?"success":"warning"},{default:()=>[i.ptype===0?"正常":"已延期"]})},{key:"dtype",title:"调试类型",align:"center",width:100,render:i=>{if(i.status===null)return null;const d=x(Fa[i.dtype]);return a(Fe,{type:"info"},Ye(d)?d:{default:()=>[d]})}},{key:"username",title:"创建人",align:"center",width:100,ellipsis:{tooltip:!0}},{key:"dbtime",title:"创建时间",align:"center",width:180},{key:"operate",title:x("common.operate"),align:"center",width:320,fixed:"right",render:i=>{let d;return a("div",{class:"flex-center gap-8px"},[i.status==0&&(S.userInfo.usertype==0||S.userInfo.usertype==2||S.userInfo.usertype==3)&&a(Ce,{onPositiveClick:()=>U(i,1)},{default:()=>"确定启动项目吗？",trigger:()=>we(a(m,{type:"success",ghost:!0,size:"small"},{default:()=>["启动"]}),[[Pe("no-auth"),"project:Info:update"]])}),i.status==2&&(S.userInfo.usertype==0||S.userInfo.usertype==2)&&a(Ce,{onPositiveClick:()=>U(i,3)},{default:()=>"是否确认执行审核操作？",trigger:()=>we(a(m,{type:"warning",ghost:!0,size:"small"},{default:()=>["审核"]}),[[Pe("no-auth"),"project:Info:update"]])}),a(m,{type:"primary",ghost:!0,size:"small",onClick:()=>Re(i)},{default:()=>["详情"]}),a(m,{type:"primary",ghost:!0,size:"small",onClick:()=>Oe(i)},{default:()=>["关联合同"]}),we(a(m,{type:"primary",ghost:!0,size:"small",onClick:()=>v(i.id)},Ye(d=x("common.edit"))?d:{default:()=>[d]}),[[Pe("no-auth"),"project:Info:update"]]),a(Ce,{onPositiveClick:()=>ce(i.id)},{default:()=>x("common.confirmDelete"),trigger:()=>{let $;return we(a(m,{type:"error",ghost:!0,size:"small"},Ye($=x("common.delete"))?$:{default:()=>[$]}),[[Pe("no-auth"),"project:Info:delete"]])}})])}}]}),{drawerVisible:k,operateType:ue,editingData:A,handleAdd:h,handleEdit:E,checkedRowKeys:y,onBatchDeleted:z,onDeleted:ne}=Pa(Q,T);async function de(){console.log(y.value),w(y.value.join(","),i=>{z()})}async function ce(i){const{data:d,error:$}=await yt(i);$||ne()}const U=async(i,d)=>{var fe;const{data:$,error:me}=await xt([{id:i.id,status:d}]);me||((fe=window.$message)==null||fe.success("操作成功"),T())};function v(i){E(i)}async function w(i,d){const{data:$,error:me}=await yt(i);if(!me)d&&d($);else return!1}const De=I(!1),pe=I(0),Oe=i=>{De.value=!0,pe.value=i.id},Ee=i=>{f.status=i.status,T()},be=I(-1),Me=i=>{i>0?(be.value=i,f.creater=JSON.parse(JSON.stringify(i)),T()):(f.creater=void 0,be.value=-1,T())},Re=i=>{q.push("/projectmanagement/orderdetail?prjId="+i.id),S.setProjectInfo({pid:i.id,pname:i.proname})},V=()=>{T()};return la(()=>{O.query.pname&&(f.fuzzy=O.query.pname,V())}),(i,d)=>{const $=Ba,me=ia,fe=ie,Ve=Gt,ge=qt,Be=Jt,K=et,Je=tt,xe=Pe("no-auth");return ae(),kt("div",en,[a(Wa,{model:s(f),"onUpdate:model":d[0]||(d[0]=N=>Ue(f)?f.value=N:null),onReset:V,onSearch:s(T)},null,8,["model","onSearch"]),a(Je,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:l(()=>[a(fe,{align:"center",wrap:"",class:"lt-sm:w-200px"},{default:l(()=>[d[6]||(d[6]=X("div",null,"项目列表",-1)),a(me,{size:"small",value:be.value,"onUpdate:value":[d[1]||(d[1]=N=>be.value=N),Me],name:"radiobuttongroup1"},{default:l(()=>[a($,{value:-1,label:"默认"}),a($,{value:s(S).userInfo.id,label:"我创建的"},null,8,["value"])]),_:1},8,["value"])]),_:1,__:[6]})]),"header-extra":l(()=>[a(fe,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:l(()=>[we((ae(),_e(s(m),{onClick:s(h),size:"small",ghost:"",type:"primary"},{icon:l(()=>[a(Ve,{class:"text-icon"})]),default:l(()=>[d[7]||(d[7]=_(" "+re("新增项目")))]),_:1,__:[7]},8,["onClick"])),[[xe,"project:Info:insert"]]),a(s(Ce),{onPositiveClick:de},{trigger:l(()=>[we((ae(),_e(s(m),{size:"small",ghost:"",type:"error",disabled:s(y).length==0},{icon:l(()=>[a(ge,{class:oa(["text-icon",{"animate-spin":s(G)}])},null,8,["class"])]),default:l(()=>[d[8]||(d[8]=_(" "+re("批量删除")))]),_:1,__:[8]},8,["disabled"])),[[xe,"project:Info:delete"]])]),default:l(()=>[d[9]||(d[9]=_(" 确定要删除选中的合同吗？ "))]),_:1,__:[9]}),a(Be,{columns:s(o),"onUpdate:columns":d[2]||(d[2]=N=>Ue(o)?o.value=N:null)},null,8,["columns"])]),_:1})]),default:l(()=>[a(K,{"checked-row-keys":s(y),"onUpdate:checkedRowKeys":d[3]||(d[3]=N=>Ue(y)?y.value=N:null),columns:s(r),data:s(Q),size:"small","flex-height":!s(Y).isMobile,"scroll-x":s(r).reduce((N,ve)=>N+(ve.width||100),0),loading:s(G),remote:"","row-key":N=>N.id,pagination:s(R),class:"sm:h-full","onUpdate:filters":Ee},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),a(Ha,{visible:s(k),"onUpdate:visible":d[4]||(d[4]=N=>Ue(k)?k.value=N:null),onSubmitted:s(T),"operate-type":s(ue),"row-data":s(A)},null,8,["visible","onSubmitted","operate-type","row-data"]),a(Za,{visable:De.value,"onUpdate:visable":d[5]||(d[5]=N=>De.value=N),id:pe.value},null,8,["visable","id"])]),_:1})])}}});export{Cn as default};
