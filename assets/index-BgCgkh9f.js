import{d as Q,n as K,p as le,s as te,o as Z,c as ae,w as l,g as a,h as n,t as u,i as m,$ as j,F as ne,aG as oe,aw as Y,ax as se,Z as ie,J as de,B as V,N as X,O as re,ad as ee,a3 as ue,j as I,r as G,av as q,A as pe,e as ce,ai as me,aj as fe,S as ge,ar as _e,P as ve,Q as he,f as be,R as ye}from"./index-DWmUnTBE.js";import{_ as xe,l as Ie}from"./lodash--WT9fVpN.js";import{_ as Ce}from"./round-search-u8SOTxtR.js";import{_ as we}from"./round-refresh-Dein9Tgk.js";import{_ as Le}from"./Cascader-5ZDJUcLW.js";import{_ as Ee}from"./FormItemGridItem-Drh-13oN.js";import{_ as Se}from"./DatePicker-BZxjatQZ.js";import{_ as ke}from"./Grid-OpRdRyXq.js";import{x as Ne,y as Te}from"./events-wMiDXEVi.js";import{n as Ae}from"./Collection-3xqUeI_u.js";import{e as Re}from"./exportExcel-D6OyA9oJ.js";import{S as J,t as U}from"./alarm-D5H_kqfB.js";import{_ as De,a as Oe}from"./DescriptionsItem-DRQRb9Gn.js";import"./TimePicker-BMnBackT.js";import"./defineProperty-QI1KHt9F.js";const Me={0:"KERN",1:"USER",2:"MAIL",3:"DAEMON",4:"AUTH",5:"SYSYLOG",6:"LPR",7:"NEWS",8:"UUCP",9:"CRON",10:"AUTHPRIV",11:"FTP",12:"RESERVED_12",13:"RESERVED_13",14:"RESERVED_14",15:"RESERVED_15",16:"LOCAL0",17:"LOCAL1",18:"LOCAL2",19:"LOCAL3",20:"LOCAL4",21:"LOCAL5",22:"LOCAL6",23:"LOCAL7"},Pe={0:"EMERGENCY",1:"ALERT",2:"CRITICAL",3:"ERROR",4:"WARNING",5:"NOTICE",6:"INFO",7:"DEBUG"},W={logModel:Me,logLevel:Pe},$e=Q({name:"FormSearch",__name:"form-search",props:K(["collectorList","logsoudev"],{model:{required:!0},modelModifiers:{}}),emits:K(["search"],["update:model"]),setup(f,{emit:v}){const R=c=>Object.entries(c).map(([p,y])=>({label:y,value:p})),k={logLevel:R(W.logLevel),logModel:R(W.logModel)},C=f,z=v,{formRef:L,restoreValidation:E}=le(),e=te(f,"model");async function r(c,p){c&&c.length>0?(e.value.startTime=c[0],e.value.endTime=c[1]):(e.value.startTime=void 0,e.value.endTime=void 0),s()}async function N(){await E(),e.value.lsid=null,e.value.leid=null,e.value.lmid=null,e.value.timeRange=null,e.value.startAndEndIp=null,oe(()=>{z("search")})}const S=()=>{e.value.startAndEndIp=null,s()};async function s(){var c,p,y,_;if(e.value.startAndEndIp&&e.value.startAndEndIp.length>0?(e.value.startIp=e.value.startAndEndIp[0]||null,e.value.endIp=e.value.startAndEndIp[1]||null):(e.value.startIp=void 0,e.value.endIp=void 0),e.value.startIp&&!Y(e.value.startIp)||e.value.endIp&&!Y(e.value.endIp))return(c=window.$message)==null||c.destroyAll(),(p=window.$message)==null||p.error("请输入正确的IP地址"),!1;if(e.value.startIp&&e.value.endIp&&se(e.value.startIp,e.value.endIp)>0)return(y=window.$message)==null||y.destroyAll(),(_=window.$message)==null||_.error("起始IP不能大于终止IP"),!1;z("search")}const T=xe.debounce(s,1e3,{leading:!0,trailing:!1});return(c,p)=>{const y=Le,_=Ee,w=ie,B=Se,D=de,H=we,O=V,x=Ce,F=X,t=ke,i=re,g=ee;return Z(),ae(g,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[a(i,{ref_key:"formRef",ref:L,model:e.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:ne(m(T),["enter"])},{default:l(()=>[a(t,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:l(()=>[a(_,{span:"24 s:24 m:8 l:8",label:"采集器",path:"lsid"},{default:l(()=>[a(y,{value:e.value.lsid,"onUpdate:value":[p[0]||(p[0]=d=>e.value.lsid=d),s],placeholder:"请选择采集器",options:C.collectorList,disabled:C.logsoudev,"check-strategy":"child","children-field":"data","value-field":"id","label-field":"type",clearable:"",style:{width:"100%"},"show-path":!1},null,8,["value","options","disabled"])]),_:1}),a(_,{span:"24 s:24 m:8 l:8",label:"级别",path:"leid"},{default:l(()=>[a(w,{filterable:"",clearable:"",placeholder:"请选择级别",value:e.value.leid,"onUpdate:value":[p[1]||(p[1]=d=>e.value.leid=d),s],options:k.logLevel,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),a(_,{span:"24 s:24 m:8 l:8",label:"日志模块",path:"lmid"},{default:l(()=>[a(w,{filterable:"",clearable:"",placeholder:"请选择日志模块",value:e.value.lmid,"onUpdate:value":[p[2]||(p[2]=d=>e.value.lmid=d),s],options:k.logModel,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),a(_,{span:"24 s:24 m:12 l:8",label:"时间",path:"time"},{default:l(()=>[a(B,{value:e.value.timeRange,"onUpdate:value":p[3]||(p[3]=d=>e.value.timeRange=d),clearable:"",type:"datetimerange","value-format":"yyyy-MM-dd HH:mm:ss",style:{width:"100%"},"onUpdate:formattedValue":r},null,8,["value"])]),_:1}),a(_,{s:"",span:"24 s:24 m:12 l:8",label:"IP",path:"startAndEndIp"},{default:l(()=>[a(D,{pair:"",separator:"-",placeholder:["发生源起始IP","发生源终止IP"],clearable:"",value:e.value.startAndEndIp,"onUpdate:value":p[4]||(p[4]=d=>e.value.startAndEndIp=d),disabled:C.logsoudev,onClear:S},null,8,["value","disabled"])]),_:1}),a(_,{span:"24 s:24 m:8 l:8",label:" "},{default:l(()=>[a(F,{class:"w-full"},{default:l(()=>[a(O,{onClick:N},{icon:l(()=>[a(H,{class:"text-icon"})]),default:l(()=>[n(" "+u(m(j)("common.reset")),1)]),_:1}),a(O,{type:"primary",ghost:"",onClick:m(T)},{icon:l(()=>[a(x,{class:"text-icon"})]),default:l(()=>[n(" "+u(m(j)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),Ge=f=>(ve("data-v-32d6c2a5"),f=f(),he(),f),Ue={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ve=Ge(()=>be("hr",{style:{"border-color":"#ccc","margin-bottom":"20px"}},null,-1));function je(f){return typeof f=="function"||Object.prototype.toString.call(f)==="[object Object]"&&!me(f)}const ze=Q({name:"eventalarm_generallog",__name:"index",props:{logsoudev:{},aip:{}},setup(f){const v=f,R=ue(),k=I(window.innerHeight-395),C=I([]);(async()=>{const{data:t,error:i}=await Ae({page:1,limit:1e3,_t:new Date().getTime()});if(i)console.error("获取采集器列表失败:",i);else{const g=t;C.value=g.list.map(d=>({...d,id:d.id,type:d.cname}))}})();const L=I(!1),E=W,e=G({lsid:void 0,lsdn:"",rdbtime:"",lmid:void 0,leid:void 0,ltext:"",aname:"",procid:"",msgid:"",dbtime:"",hname:"",lcon:"",ip:"",lsip:"",priority:"",type:"",version:"",logtype:void 0,index:0,gsubject:"",gdescribe:"",gresult:"",level:0,eids:"",epids:""}),r=G({pageId:void 0,pageSize:100,lsid:void 0,leid:void 0,lmid:void 0,startTime:void 0,endTime:void 0,startIp:void 0,endIp:void 0,_t:new Date().getTime()}),N=G([{title:"序号",key:"index",width:80,align:"center",render:t=>`${t.index}`},{key:"type",title:"采集器名称",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"gsubject",title:"事件主体",align:"center",width:160,ellipsis:{tooltip:!0}},{key:"gdescribe",title:"事件描述",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"gresult",title:"事件结果",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"level",title:"安全级别",align:"center",width:140,render:t=>{const i=J[t.level];let g={color:U[t.level],textColor:"#ffffff",borderColor:U[t.level]};return a(q,{size:"small",color:g},je(i)?i:{default:()=>[i]})}},{key:"epids",title:"事件类别",align:"center",width:120},{key:"eids",title:"事件类型",align:"center",width:120},{key:"hname",title:"主机名称",align:"center",width:180,ellipsis:{tooltip:!0}},{key:"rdbtime",title:"接收时间",align:"center",width:160,render:t=>t.rdbtime},{key:"operate",title:j("common.operate"),align:"center",width:120,fixed:"right",render:t=>a("div",{class:"flex-center gap-8px"},[a(V,{type:"info",ghost:!0,size:"small",onClick:()=>y(t)},{default:()=>[n("详情")]})])}]),S=I(!1),s=I([]),T=I(0),c=async(t=!1)=>{if(!S.value)S.value=!0;else return;v.logsoudev&&v.aip&&(w.value=!1,r.lsid=v.logsoudev,r.startAndEndIp=[v.aip,v.aip],r.startIp=v.aip,r.endIp=v.aip);const{data:i,error:g}=await Ne(r);g||(T.value=i.length,t?s.value=[...s.value,...i]:s.value=i,s.value=s.value.sort((d,b)=>b.id-d.id).map((d,b)=>(d.index=b+1,d)),S.value=!1)},p=async()=>{const{data:t,error:i}=await Te({_t:new Date().getTime()});x.total=Number(t),x.itemCount=Number(t)};function y(t){e.lsid=t.lsid,e.lsdn=t.lsdn,e.rdbtime=t.rdbtime,e.lmid=t.lmid,e.leid=t.leid,e.ltext=t.ltext,e.aname=t.aname,e.procid=t.procid,e.msgid=t.msgid,e.dbtime=t.dbtime,e.hname=t.hname,e.lcon=t.lcon,e.ip=t.ip,e.lsip=t.lsip,e.priority=t.priority,e.type=t.type,e.version=t.version,e.logtype=t.logtype,e.gsubject=t.gsubject,e.gdescribe=t.gdescribe,e.gresult=t.gresult,e.level=t.level,L.value=!0}const _=I(),w=I(!0),B=async()=>{s.value=[],r.lsid||r.leid||r.lmid||r.startIp||r.endIp||r.startTime||r.endTime?w.value=!1:(w.value=!0,p()),r.pageId=void 0,await c(),D()},D=async()=>{var t,i;if(s.value.length<k.value/44&&s.value.length<x.total){if(r.pageId==s.value[s.value.length-1].id)return;r.pageId=((i=(t=s.value)==null?void 0:t[s.value.length-1])==null?void 0:i.id)??void 0,c(!0)}};pe(async()=>{await c(),await p(),D()});function H(t){Math.abs(t.target.scrollTop+t.target.offsetHeight-t.target.scrollHeight)<=20&&x.total>s.value.length&&O()}const O=Ie.debounce(()=>{var t,i;if(s.value.length<x.total){if(r.pageId==s.value[s.value.length-1].id)return;r.pageId=((i=(t=s.value)==null?void 0:t[s.value.length-1])==null?void 0:i.id)??void 0,c(!0)}},300),x=G({page:1,pageCount:1,pageSize:20,total:0,prefix({startIndex:t,endIndex:i,page:g,pageSize:d,pageCount:b,itemCount:o}){return`已加载${s.value.length}条`+(s.value.length?w.value?` 共计 ${s.value.length>0?o??0:0} 条`:T.value==r.pageSize?"  预计还有更多":"  没有更多了":"")}});async function F(){if(!s.value.length)return;const t=JSON.parse(JSON.stringify(s.value)),i=[];t.forEach(d=>{const b={};N.forEach(o=>{var M,P,$;if(d.hasOwnProperty(o.key)){const h=o.key==="lmid"?((M=E.logModel)==null?void 0:M[d[o.key]])??null:o.key==="leid"?((P=E.logLevel)==null?void 0:P[d[o.key]])??null:o.key==="lsid"?($=C.value.map(A=>A.data).flat(2).find(A=>A.id==d[o.key]))==null?void 0:$.type:o.key==="level"?J[d[o.key]]??null:o.key=="ltext"?d.ltext+d.lcon:d[o.key];b[o.title]=h}}),i.push(b)}),Re(i,500,[{wpx:120},{wpx:120},{wpx:160},{wpx:80},{wpx:80},{wpx:100},{wpx:100},{wpx:100},{wpx:400}],"通用日志_"+new Date().getTime())}return(t,i)=>{const g=X,d=fe,b=ee,o=De,M=Oe,P=ge,$=_e;return Z(),ce("div",Ue,[a($e,{model:r,"onUpdate:model":i[0]||(i[0]=h=>r=h),onSearch:B,collectorList:C.value,logsoudev:v.logsoudev},null,8,["model","collectorList","logsoudev"]),a(b,{title:"通用日志",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":l(()=>[a(g,null,{default:l(()=>[a(m(V),{type:"primary",size:"small",ghost:"",onClick:F,title:"导出已加载"},{default:l(()=>[n("导出已加载")]),_:1})]),_:1})]),default:l(()=>[a(d,{ref_key:"tableContainerRef",ref:_,columns:N,data:s.value,size:"small","flex-height":!m(R).isMobile,"scroll-x":N.reduce((h,A)=>h+A.width,0),loading:S.value,remote:"","row-key":h=>h.index,showTotal:"","max-height":k.value,"virtual-scroll":"",pagination:x,class:"sm:h-full",onScroll:H},null,8,["columns","data","flex-height","scroll-x","loading","row-key","max-height","pagination"])]),_:1}),a($,{show:L.value,"onUpdate:show":i[2]||(i[2]=h=>L.value=h),title:"日志详情",preset:"card",class:"w-800px"},{footer:l(()=>[a(g,{justify:"end",size:16},{default:l(()=>[a(m(V),{type:"primary",onClick:i[1]||(i[1]=h=>{L.value=!1})},{default:l(()=>[n(u(m(j)("common.confirm")),1)]),_:1})]),_:1})]),default:l(()=>[Ve,a(P,{class:"h-480px pr-20px"},{default:l(()=>[a(M,{"label-placement":"left","label-style":{width:"120px"},bordered:"",column:1},{default:l(()=>[a(o,null,{label:l(()=>[n(" 采集器名称 ")]),default:l(()=>[n(" "+u(e.type),1)]),_:1}),a(o,null,{label:l(()=>[n(" 事件主体 ")]),default:l(()=>[n(" "+u(e.gsubject),1)]),_:1}),a(o,null,{label:l(()=>[n(" 事件描述 ")]),default:l(()=>[n(" "+u(e.gdescribe),1)]),_:1}),a(o,null,{label:l(()=>[n(" 事件结果 ")]),default:l(()=>[n(" "+u(e.gresult),1)]),_:1}),a(o,null,{label:l(()=>[n(" 安全级别 ")]),default:l(()=>[a(m(q),{size:"small",color:{color:m(U)[e.level],textColor:"#ffffff",borderColor:m(U)[e.level]}},{default:l(()=>[n(u(m(J)[e.level]),1)]),_:1},8,["color"])]),_:1}),a(o,null,{label:l(()=>[n(" 事件类别 ")]),default:l(()=>[n(" "+u(e.epids),1)]),_:1}),a(o,null,{label:l(()=>[n(" 事件类型 ")]),default:l(()=>[n(" "+u(e.eids),1)]),_:1}),a(o,null,{label:l(()=>[n(" 接收时间 ")]),default:l(()=>[n(" "+u(e.rdbtime),1)]),_:1}),a(o,null,{label:l(()=>[n(" 模块 ")]),default:l(()=>[n(" "+u(m(E).logModel[e.lmid]),1)]),_:1}),a(o,null,{label:l(()=>[n(" 级别 ")]),default:l(()=>[n(" "+u(m(E).logLevel[e.leid]),1)]),_:1}),a(o,null,{label:l(()=>[n(" 应用名称 ")]),default:l(()=>[n(" "+u(e.aname),1)]),_:1}),a(o,null,{label:l(()=>[n(" PROCID ")]),default:l(()=>[n(" "+u(e.procid),1)]),_:1}),a(o,null,{label:l(()=>[n(" MSGID ")]),default:l(()=>[n(" "+u(e.msgid||"--"),1)]),_:1}),a(o,null,{label:l(()=>[n(" 日志时间 ")]),default:l(()=>[n(" "+u(e.dbtime),1)]),_:1}),a(o,null,{label:l(()=>[n(" 主机名称 ")]),default:l(()=>[n(" "+u(e.hname),1)]),_:1}),a(o,null,{label:l(()=>[n(" 结构数据 ")]),default:l(()=>[n(" -- ")]),_:1}),a(o,null,{label:l(()=>[n(" 日志内容 ")]),default:l(()=>[n(" "+u(e.lcon),1)]),_:1}),a(o,{span:2},{label:l(()=>[n(" 日志原文 ")]),default:l(()=>[n(" "+u(e.logtype?e.ltext:e.ltext+(e.lcon?e.lcon:"")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])])}}}),nl=ye(ze,[["__scopeId","data-v-32d6c2a5"]]);export{nl as default};
