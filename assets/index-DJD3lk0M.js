import{_ as oe}from"./table-header-operation.vue_vue_type_script_setup_true_lang-DQ2Pwvgi.js";import{d as q,n as V,p as J,s as Z,o as G,c as Q,w as n,g as e,h as I,t as B,i as l,$ as v,F as se,ap as X,N as Y,J as re,B as E,O as ee,ad as ae,r as M,q as ie,b as ue,ae as me,K as de,Z as ce,af as pe,ag as fe,a3 as ge,aA as _e,av as ve,E as K,D as H,e as be,ah as j,ai as ye,aj as he}from"./index-BcwJAI2q.js";import{u as we,a as xe}from"./table-D33xm8uu.js";import{_ as De}from"./round-search-A0B-hsZK.js";import{_ as Ne}from"./round-refresh-BT4eYGbi.js";import{_ as ke}from"./lodash-DfU1tBZO.js";import{_ as Se}from"./FormItemGridItem-D5iCQy7z.js";import{_ as Te}from"./Grid-CMuoBycw.js";import{u as Ce}from"./usePageData-D8exo6b9.js";import{a as ze,b as Ie,c as Ue,d as Pe,e as $e}from"./events-BCdtKF2C.js";import{f as Ae,a as Re}from"./common-BQGs6Sbh.js";import{_ as Fe}from"./Cascader-CavAyo_G.js";import{h as W}from"./permission-BEBvEhDN.js";import{_ as Le}from"./Popconfirm-MBwapZUM.js";import"./table-column-setting.vue_vue_type_script_setup_true_lang-B5_PnLN6.js";import"./setting-outlined-CbkMSlAj.js";import"./export-Dag_eicx.js";import"./refresh-BeWxBXlv.js";import"./round-delete-C_yyfWSE.js";import"./round-plus-C0Sj_6Y9.js";import"./Upload-Ca09Vwkf.js";import"./Progress-BnzXG0Bo.js";const je=q({name:"FormSearch",__name:"form-search",props:{model:{required:!0},modelModifiers:{}},emits:V(["reset","search"],["update:model"]),setup(h,{emit:U}){const u=U,{formRef:k,restoreValidation:w}=J(),t=Z(h,"model");function D(p){t.value.fuzzy=p.replace(/\s/g,"")}function C(p){return!p.startsWith(" ")&&!p.endsWith(" ")}function P(){t.value.fuzzy=null,u("search")}async function S(){await w(),u("reset")}async function o(){var p,m,f,b;if(t.value.mintime&&t.value.maxtime&&t.value.maxtime-t.value.mintime<0)return(p=window.$message)==null||p.destroyAll(),(m=window.$message)==null||m.error("最小限定时间不得大于最大限定时间"),!1;if(t.value.minagg&&t.value.maxagg&&t.value.maxagg-t.value.minagg<0)return(f=window.$message)==null||f.destroyAll(),(b=window.$message)==null||b.error("最小聚合次数不得大于最大聚合次数"),!1;u("search")}const x=ke.debounce(o,1e3,{leading:!0,trailing:!1});return(p,m)=>{const f=X,b=Y,c=Se,$=re,A=Ne,R=E,F=De,T=Te,L=ee,z=ae;return G(),Q(z,{bordered:!1,size:"small",class:"card-wrapper"},{default:n(()=>[e(L,{ref_key:"formRef",ref:k,model:t.value,"label-placement":"left","label-width":100,"show-feedback":!1,onKeyup:se(l(x),["enter"])},{default:n(()=>[e(T,{responsive:"screen","item-responsive":"","x-gap":12,"y-gap":12},{default:n(()=>[e(c,{span:"24 s:24 m:12 l:10",label:"最大限定时间"},{default:n(()=>[e(b,{wrap:!1,align:"center",class:"w-100%"},{default:n(()=>[e(f,{value:t.value.mintime,"onUpdate:value":m[0]||(m[0]=s=>t.value.mintime=s),min:0,placeholder:"最小限定时间"},null,8,["value"]),I(" — "),e(f,{value:t.value.maxtime,"onUpdate:value":m[1]||(m[1]=s=>t.value.maxtime=s),min:0,placeholder:"最大限定时间"},null,8,["value"])]),_:1})]),_:1}),e(c,{span:"224 s:24 m:12 l:10",label:"最大聚合次数"},{default:n(()=>[e(b,{wrap:!1,align:"center"},{default:n(()=>[e(f,{value:t.value.minagg,"onUpdate:value":m[2]||(m[2]=s=>t.value.minagg=s),min:0,placeholder:"最小聚合次数"},null,8,["value"]),I(" — "),e(f,{value:t.value.maxagg,"onUpdate:value":m[3]||(m[3]=s=>t.value.maxagg=s),min:0,placeholder:"最大聚合次数"},null,8,["value"])]),_:1})]),_:1}),e(c,{span:"24 s:12 m:8 l:6",label:"策略名称",path:"fuzzy"},{default:n(()=>[e($,{clearable:"",value:t.value.fuzzy,"onUpdate:value":m[4]||(m[4]=s=>t.value.fuzzy=s),placeholder:"请输入策略名称",onInput:D,"allow-input":C,onClear:P},null,8,["value"])]),_:1}),e(c,{span:"24 s:12 m:8 l:6"},{default:n(()=>[e(b,{class:"w-full"},{default:n(()=>[e(R,{onClick:S},{icon:n(()=>[e(A,{class:"text-icon"})]),default:n(()=>[I(" "+B(l(v)("common.reset")),1)]),_:1}),e(R,{type:"primary",ghost:"",onClick:l(x)},{icon:n(()=>[e(F,{class:"text-icon"})]),default:n(()=>[I(" "+B(l(v)("common.search")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","onKeyup"])]),_:1})}}}),Be=q({name:"OperateDrawer",__name:"operate-drawer",props:V({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:V(["submitted"],["update:visible"]),setup(h,{emit:U}){const u=h,k=U,w=M({eventsTypeDataList:[]}),t=Z(h,"visible"),{formRef:D,validate:C,restoreValidation:P}=J();ie();const S=ue(()=>({add:"新增聚合策略",edit:"修改聚合策略"})[u.operateType]),o=M(x());function x(){return{etid:null,mrules:null,maxtime:86400,maxagg:2e4,forward:null,sysparam:0}}const p={etid:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},mrules:{type:"array",required:!0,trigger:["blur","change"],message:"不能为空"},maxtime:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"},maxagg:{type:"number",required:!0,trigger:["blur","change"],message:"不能为空"}};async function m(){const{data:s,error:a}=await Ae();a||(w.eventsTypeDataList=s,f())}async function f(){const{data:s,error:a}=await Re();a||w.eventsTypeDataList.forEach(r=>{r.children=s.filter(i=>i.pid===r.id)})}const b=M({data:[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}]}),{pageData:c,getData:$,nextPage:A}=Ce(ze),R=async s=>{const a=s.currentTarget;a.scrollTop+a.offsetHeight>=a.scrollHeight&&c.data.length<c.total&&A()};function F(){m(),$(),Object.assign(o,x()),u.operateType==="edit"&&u.rowData&&(u.rowData.mrules=u.rowData.mrules?u.rowData.mrules.split(",").map(Number):[],u.rowData.forward=u.rowData.forward?u.rowData.forward.split(",").map(Number):[],Object.assign(o,u.rowData))}function T(){t.value=!1}async function L(){var s,a,r,i,g,y;if(await C(),u.operateType==="add"){const{data:d,error:N}=await Ie([{etid:o.etid,mrules:(s=o.mrules)==null?void 0:s.join(","),maxtime:o.maxtime,maxagg:o.maxagg,forward:(a=o.forward)==null?void 0:a.join(",")}]);N||((r=window.$message)==null||r.success(v("common.addSuccess")),T(),k("submitted"))}else{const{data:d,error:N}=await Ue([{id:u.rowData.id,etid:o.etid,mrules:(i=o.mrules)==null?void 0:i.join(","),maxtime:o.maxtime,maxagg:o.maxagg,forward:(g=o.forward)==null?void 0:g.join(",")}]);N||((y=window.$message)==null||y.success(v("common.updateSuccess")),T(),k("submitted"))}}const z=s=>s.ipaddr+":"+s.fport+" ("+(s.ftype==0?"syslog":"SNMP Trap")+")";return me(t,()=>{t.value&&(F(),P())}),(s,a)=>{const r=Fe,i=de,g=ce,y=X,d=ee,N=E,te=Y,le=pe,ne=fe;return G(),Q(ne,{show:t.value,"onUpdate:show":a[5]||(a[5]=_=>t.value=_),"display-directive":"show",width:450},{default:n(()=>[e(le,{title:S.value,"native-scrollbar":!1,closable:""},{footer:n(()=>[e(te,{size:16},{default:n(()=>[e(N,{onClick:T},{default:n(()=>[I(B(l(v)("common.cancel")),1)]),_:1}),e(N,{type:"primary",onClick:L},{default:n(()=>[I(B(l(v)("common.confirm")),1)]),_:1})]),_:1})]),default:n(()=>[e(d,{ref_key:"formRef",ref:D,model:o,rules:p},{default:n(()=>[e(i,{label:"策略名称",path:"etid"},{default:n(()=>[e(r,{value:o.etid,"onUpdate:value":a[0]||(a[0]=_=>o.etid=_),clearable:"",disabled:s.operateType==="edit","check-strategy":"child",placeholder:"请选择策略名称",options:w.eventsTypeDataList,"show-path":!1,filterable:"","value-field":"id","label-field":"pname"},null,8,["value","disabled","options"])]),_:1}),e(i,{label:"匹配规则",path:"mrules"},{default:n(()=>[e(g,{"max-tag-count":2,value:o.mrules,"onUpdate:value":a[1]||(a[1]=_=>o.mrules=_),multiple:"",placeholder:"请选择匹配规则",clearable:"",filterable:"",options:b.data,"reset-menu-on-options-change":!1},null,8,["value","options"])]),_:1}),e(i,{label:"最大限定时间(秒)",path:"maxtime"},{default:n(()=>[e(y,{value:o.maxtime,"onUpdate:value":a[2]||(a[2]=_=>o.maxtime=_),clearable:"",min:10,placeholder:"请输入最大限定时间(秒)",style:{width:"100%"}},null,8,["value"])]),_:1}),e(i,{label:"最大聚合次数",path:"maxagg"},{default:n(()=>[e(y,{value:o.maxagg,"onUpdate:value":a[3]||(a[3]=_=>o.maxagg=_),clearable:"",min:2,placeholder:"请输入最大聚合次数",style:{width:"100%"}},null,8,["value"])]),_:1}),e(i,{label:"转发类型",path:"forward"},{default:n(()=>[e(g,{"max-tag-count":1,value:o.forward,"onUpdate:value":a[4]||(a[4]=_=>o.forward=_),multiple:"",placeholder:"请选择转发类型",clearable:"","render-label":z,filterable:"","value-field":"id","label-field":"ipaddr",options:l(c).data,"reset-menu-on-options-change":!1,onScroll:R},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),Ee={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function O(h){return typeof h=="function"||Object.prototype.toString.call(h)==="[object Object]"&&!ye(h)}const ua=q({name:"eventalarm_aggregatepolicy",__name:"index",setup(h){const U=ge(),u=[{label:"事件等级",value:1},{label:"事件类型",value:2},{label:"设备种类",value:3},{label:"设备类型",value:4},{label:"日志编号",value:5},{label:"协议",value:6},{label:"源IP",value:7},{label:"发生源IP",value:8},{label:"源端口",value:9},{label:"目的IP",value:10},{label:"事件名称",value:11},{label:"目的端口",value:12}],{columns:k,columnChecks:w,data:t,getData:D,loading:C,mobilePagination:P,searchParams:S,resetSearchParams:o}=we({apiFn:Pe,immediate:!0,apiParams:{page:1,pageSize:20,limit:20,mintime:null,maxtime:null,minagg:null,maxagg:null,fuzzy:null,_t:new Date().getTime()},columns:()=>[{type:"selection",align:"center",width:48,fixed:"left"},{key:"pname",title:"策略名称",align:"center",width:160,ellipsis:{tooltip:!0}},{key:"maxtime",title:"最大限定时间(秒)",align:"center",width:180},{key:"maxagg",title:"最大聚合次数",align:"center",width:180},{key:"mrules",title:"匹配规则",align:"center",width:160,render:a=>{const i=(a.mrules?a.mrules.split(","):[]).map(g=>{const y=u.find(d=>d.value===parseInt(g));return y?y.label:""});return e("div",null,[e("span",null,[i.join(", ")])])}},{key:"sysparam",title:"系统内置",align:"center",width:240,render:a=>{a.sysparam==null&&(a.sysparam=0);const r={0:"success",1:"info"},i=v(_e[a.sysparam]);return e(ve,{size:"small",type:r[a.sysparam]},O(i)?i:{default:()=>[i]})}},{key:"operate",title:v("common.operate"),align:"center",width:160,fixed:"right",render:a=>{let r;return e("div",{class:"flex-center gap-8px"},[K(e(E,{type:"info",ghost:!0,size:"small",onClick:()=>T(a.id)},O(r=v("common.edit"))?r:{default:()=>[r]}),[[H("no-auth"),"aggregate.policy.update"]]),a.sysparam!=0&&e(Le,{onPositiveClick:()=>L(a.id)},{default:()=>v("common.confirmDelete"),trigger:()=>{let i;return K(e(E,{type:"error",ghost:!0,size:"small"},O(i=v("common.delete"))?i:{default:()=>[i]}),[[H("no-auth"),"aggregate.policy.delete"]])}})])}}]}),{drawerVisible:x,operateType:p,editingData:m,handleAdd:f,handleEdit:b,checkedRowKeys:c,onBatchDeleted:$,onDeleted:A,closeDrawer:R}=xe(t,D);async function F(){console.log(c.value),z(c.value,a=>{$()})}function T(a){b(a)}function L(a){console.log(a),z([a],r=>{A()})}async function z(a,r){const{data:i,error:g}=await $e(a);if(!g)r&&r(i);else return!1}async function s(){}return(a,r)=>{const i=oe,g=he,y=ae;return G(),be("div",Ee,[e(je,{model:l(S),"onUpdate:model":r[0]||(r[0]=d=>j(S)?S.value=d:null),onReset:l(o),onSearch:l(D)},null,8,["model","onReset","onSearch"]),e(y,{title:"聚合策略",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":n(()=>[e(i,{columns:l(w),"onUpdate:columns":r[1]||(r[1]=d=>j(w)?w.value=d:null),"disabled-delete":l(c).length===0,loading:l(C),onAdd:l(f),onDelete:F,onRefresh:l(D),"is-view-export-button":!1,onExportHandler:s,"is-view-add-button":l(W)("aggregate.policy.insert"),"is-view-delete-button":l(W)("aggregate.policy.delete")},null,8,["columns","disabled-delete","loading","onAdd","onRefresh","is-view-add-button","is-view-delete-button"])]),default:n(()=>[e(g,{"checked-row-keys":l(c),"onUpdate:checkedRowKeys":r[2]||(r[2]=d=>j(c)?c.value=d:null),columns:l(k),data:l(t),size:"small","flex-height":!l(U).isMobile,"scroll-x":l(k).reduce((d,N)=>d+N.width,0),loading:l(C),remote:"","row-key":d=>d.id,pagination:l(P),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","scroll-x","loading","row-key","pagination"]),e(Be,{visible:l(x),"onUpdate:visible":r[3]||(r[3]=d=>j(x)?x.value=d:null),"operate-type":l(p),"row-data":l(m),onSubmitted:l(D)},null,8,["visible","operate-type","row-data","onSubmitted"])]),_:1})])}}});export{ua as default};
