import{d as e,n as a,I as t,p as s,gP as i,b as n,gQ as l,W as o,Q as r,fX as u,fU as c,gR as d,L as v,e as m,o as f,f as p,i as h,g,h as x,B as y,a9 as k,F as I,j as b,s as w,t as U,G as C,X as N,w as _,a as q,Y as B,_ as E}from"./index-BxLtnPqY.js";import{g as R}from"./user-BsjaHGO1.js";import{L as j,f as D,a as L,U as T}from"./Usermessages-CJ5rTKw8.js";const z={class:"webchat"},V={class:"setting"},W=["src","title"],A={class:"left"},F={class:"search"},M={class:"userList"},P=["onClick"],Q={class:"userinfo"},X={class:"infoTop"},G={class:"nickname"},H={key:0,class:"text"},K={key:1,class:"text"},S={class:"right"},Y={class:"top"},J={class:"footer"},O={class:"btn"},Z={key:0},$=E(e({name:"WebChatIndex",__name:"index",setup(e){const E=a(),$=t(),ee=s(),ae=i("https://60.205.130.133:8888/webchat",{reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});ae.on("connect",(()=>{})),ae.io.on("reconnect_attempt",(e=>{})),ae.io.on("reconnect",(()=>{}));const te=n(!1),se=n([{}]),ie=n({});ae.on("message",(e=>{const{userInfo:a}=$;if(e.toName===a.nickname&&ee.isNotifications&&l(e),"聊天室"===e.toName)ne.value[e.toId].push(e);else{const t=a.id===e.formId?e.toId:e.formId;e.toName!==a.nickname&&e.formName!==a.nickname||ne.value[t].push(e)}oe()})),ae.on("message1",(e=>{ne.value[ie.value.id][ne.value[ie.value.id].length-1].id=e})),ae.on("withdrawMessageAll",(e=>{ae.emit("historyData",$.userInfo.id)}));const ne=n({});o((async()=>{await(async()=>{const e=(await R({page:1,size:100})).data.list.filter((e=>e.nickname!==$.userInfo.nickname));e.forEach((e=>{e.type="user",e.text=""})),e.unshift({nickname:"聊天室",id:"001",type:"room",text:"",avatar:"https://p26-passport.byteacctimg.com/img/user-avatar/9df05ee4be63fc38375bdfeb9931fa6f~50x50.awebp"}),se.value=e,E.currentRoute.value.query.id||E.push({path:"/webChat/index",query:{id:e[0].id}})})(),ae.emit("join",$.userInfo.id),ae.emit("historyData",$.userInfo.id),ae.on("historyData",((e,a)=>{se.value.forEach((t=>{if("聊天室"==t.nickname)return a.map((e=>{e.formId==t.id&&(e.formName=t.nickname,e.formUrl=t.avatar)})),void(ne.value[t.id]=[...a]);ne.value[t.id]=e.filter((e=>(e.formId==t.id&&(e.formUrl=t.avatar),e.toId==t.id||e.formId==t.id)))}))})),setTimeout((()=>{oe()}),200)}));const le=n(),oe=()=>{r((()=>{le.value&&(le.value.content.scrollTop=le.value.content.scrollHeight)}))},re=e=>{(""==e.target.id||"rightBox"!=e.target.id&&"rightBoxbtn"!=e.target.id)&&ue.value&&(ue.value=!1)};u((()=>{document.removeEventListener("click",re)}));const ue=n(!1),ce=()=>{ue.value=!0};c((()=>{E.push({query:{id:de.value}}),oe(),document.addEventListener("click",re)}));const de=n("");d(((e,a,t)=>{de.value=E.currentRoute.value.query.id,t()})),v((()=>E.currentRoute.value.query.id),(e=>{ie.value=se.value.filter((a=>a.id==e))[0]?se.value.filter((a=>a.id==e))[0]:se.value[0],oe()}),{immediate:!0});const ve=()=>{if(""==ie.value.text.trim())return B.warning("发送内容不能为空");if(ae.emit("chatMessage",$.userInfo,ie.value,ie.value.text,ie.value.type),"user"==ie.value.type){const e={formName:$.userInfo.nickname,formId:$.userInfo.id,formUrl:$.userInfo.avatar,toUrl:ie.value.avatar,toId:ie.value.id,toName:ie.value.nickname,message:ie.value.text,createTime:new Date,type:ie.value.type,status:0};ne.value[ie.value.id].push(e)}se.value.forEach((e=>{e.id==ie.value.id&&(e.text="")})),ie.value.text="",oe()},me=e=>{ne.value[ie.value.id].forEach((a=>{a.id==e&&(a.status=1)})),ae.emit("withdraw",e)},fe=e=>{ie.value.text=e};return(e,a)=>{const t=m("a-input"),s=m("a-avatar"),i=m("icon-more"),n=m("a-textarea"),l=m("a-button");return f(),p("div",z,[h("div",V,[h("img",{src:g($).userInfo.avatar,alt:"",title:g($).userInfo.nickname},null,8,W)]),h("div",A,[h("div",F,[x(t,{placeholder:"搜索联系人",onFocus:a[0]||(a[0]=e=>te.value=!0),onBlur:a[1]||(a[1]=e=>te.value=!1),"allow-clear":""})]),y(h("div",M,[(f(!0),p(I,null,b(se.value,(e=>(f(),p("div",{class:"userItem",key:e.id,onClick:a=>(e=>{ie.value=e,E.push({query:{id:e.id}}),oe()})(e),style:w({backgroundColor:e.id==g(E).currentRoute.value.query.id?"#e0dcdc":""})},[x(s,{size:40,imageUrl:e.avatar},null,8,["imageUrl"]),h("div",Q,[h("div",X,[h("span",G,U(e.nickname),1),h("span",null,U(g(j)(e.id,ne.value)),1)]),g(D)(e.id,se.value)&&e.id!==ie.value.id?(f(),p("span",H,[a[4]||(a[4]=h("span",{class:"draft"},"[草稿]",-1)),C(" "+U(g(D)(e.id,se.value)),1)])):(f(),p("span",K,U(g(L)(e.id,ne.value)),1))])],12,P)))),128))],512),[[k,!te.value]])]),h("div",S,[h("div",Y,[h("span",null,U(ie.value.nickname),1),x(i,{onClick:ce,id:"rightBoxbtn"})]),x(T,{ref_key:"userRef",ref:le,messages:ne.value[ie.value.id],onReEdit:fe,onWithdraw:me},null,8,["messages"]),h("div",J,[x(n,{placeholder:"说点什么把",modelValue:ie.value.text,"onUpdate:modelValue":a[2]||(a[2]=e=>ie.value.text=e),onKeypress:N(ve,["enter"])},null,8,["modelValue"]),h("div",O,[x(l,{onClick:ve},{default:_((()=>a[5]||(a[5]=[C("发送")]))),_:1})])])]),h("div",{class:"rightBox",id:"rightBox",style:w({width:ue.value?"200px":"0px",right:ue.value?"-200px":"0px",border:ue.value?"1px solid #ccc":"none",boxSizing:ue.value?"border-box":"content-box"})},[ue.value?(f(),p("div",Z,[h("span",{onClick:a[3]||(a[3]=e=>ue.value=!1)},"111")])):q("",!0)],4)])}}}),[["__scopeId","data-v-717529ab"]]);export{$ as default};
