import{_ as Y}from"./table-column-setting.vue_vue_type_script_setup_true_lang-BK40fshd.js";import{_ as Z}from"./round-search-BXiE8_rT.js";import{d as ee,bp as te,f as r,aA as S,aD as ae,bq as A,s as ne,bj as le,i as f,ad as se,bk as R,bl as U,an as W,a2 as oe,o as ce,b as ie,w as u,g as P,h as s,a3 as re,y as de,B as ue,a8 as pe,e as B,D as _e,x as me,br as he,t as fe,a9 as K,a4 as ge,A as ye,ab as ve,E as ke,ax as be,X as we,I as xe}from"./index-CikIHrS9.js";import{u as Se,a as Te}from"./table-zZpDQDxt.js";import{a as De,p as $e}from"./gather-DA62DHaW.js";import{_ as Ne}from"./InputGroupLabel-DGR_kA8i.js";import{_ as qe}from"./Tree-DUiLba8c.js";import{_ as ze}from"./DataTable-3XIZO1ar.js";import{_ as Ce}from"./Split-Cq5x6Dg_.js";import"./RadioGroup-BXqgiCu1.js";import"./Forward-D3gQX6Y3.js";const Ie={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ae={class:"flex flex-col"},Pe=ee({name:"configsetting_realtimedata_devicedata",__name:"index",setup(Ee){const{columns:j,columnChecks:T,data:b,getData:g,loading:E,mobilePagination:F,searchParams:_,resetSearchParams:Le}=Se({apiFn:te,apiParams:{page:1,pageSize:200,limit:200,tagType:null,chlid:null,devId:null,fuzzy:"",chlType:0,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",align:"center",width:48},{key:"id",title:"序号",align:"center",width:80},{key:"devId",title:"设备名称",align:"center",width:100,render:e=>{var t;return r("span",null,[(t=L.value.find(a=>a.id==e.devId))==null?void 0:t.devName])}},{key:"tagName",title:"测点名称",align:"center",width:140},{key:"tagDesc",title:"物模型标识(测点描述)",align:"center",width:180},{key:"value",title:"测点值",align:"center",width:140,render:e=>S("span",{style:{color:e.quality===100?"red":e.quality==49?"#409eff":e.quality==50?"#909399":"#67c23a"}},e.value?parseFloat(e.value.toFixed(6)):"")},{key:"quality",title:"质量",align:"center",width:120,render:e=>(e.quality==100||e.quality==49||e.quality==0)&&S(ae,{style:{background:e.quality===100?"red":e.quality==49?"#409eff":"#67c23a",color:"#fff"}},e.quality==0?"Good":e.quality==49?"人工置数":e.quality==100?"Bad":"")},{key:"dbtime",title:"采集时间",align:"center",minWidth:120,render:e=>{var t,a;return S("span",{title:A(0,+e.dbtime)},e.dbtime?(a=A(1,+e.dbtime))==null?void 0:a.substring(10,(t=A(1,+e.dbtime))==null?void 0:t.length):"")}},{key:"tagType",title:"测点类型",align:"center",width:140,render:e=>r("span",null,[De[e.tagType]])},{key:"objAddr",title:"地址",align:"center",width:140}]}),J=e=>{e===""&&g()};ne(async()=>{await M(),q(),V()}),le(()=>{var e;(e=D.value)==null||e.close(),w.value.close()});const h=f(),L=f([]),M=async()=>{const{data:e,error:t}=await se();if((e==null?void 0:e.length)==0)return;function a(n){return n.map(o=>{var c;return{label:o.chlName,key:o.id,dev_status:null,children:(c=o.devicePojoList)!=null&&c.length?o.devicePojoList.map(l=>(L.value.push(l),{label:l.devName,dev_status:null,chlType:o.chlType,key:l.id})):[]}})}h.value=a(e),_.chlid=h.value[0].key,_.devId=h.value[0].children[0].key,z.value=[h.value[0].children[0].key],x.value=h.value[0].children[0].label,g()},D=f(null),V=()=>{var o;(o=D.value)==null||o.close();const e=new R;let t="";e.appendAsciiStr("$Link+Qi^123987WWg#getchlstatus"),t=e.end();const a=new Date().getTime(),n=new U(W+`/ChannelStatusWebsocket/getchlstatus/${t}/${a}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});D.value=n,n.connect(),n.onclose(()=>{}),n.onerror(()=>{}),n.onopen(()=>{}),n.onmessage(c=>{let l=[];console.log(c,"通道状态websocket接受数据"),O(c.data)&&(l=JSON.parse(c.data).data,h.value.forEach(i=>{l.forEach(d=>{var y;d.chl_id==i.key&&(i.dev_status=d.chl_status),d.chl_id==1&&(i.dev_status=1),(y=i.children)==null||y.forEach(v=>{var k;(k=d.devs)==null||k.forEach(m=>{m.dev_id==v.key&&(v.dev_status=m.dev_status),m.dev_id==1&&(v.dev_status=1)})})})}))})},w=f(null),$=f(""),N=f(!0),q=()=>{var o;(o=w.value)==null||o.close(),N.value=!0;const e=new R;let t="";const a=new Date().getTime();e.appendAsciiStr("$Link+Qi^123987WWg#"+a),t=e.end();const n=new U(W+`/realTimeDataWebsocket/${x.value}/${t}/${a}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});w.value=n,n.connect(),n.onclose(()=>{}),n.onerror(()=>{}),n.onopen(()=>{}),n.onmessage(c=>{let l=[];console.log(c,"实时数据websocket接受数据"),O(c.data)&&(l=JSON.parse(c.data).data[x.value],l==null||l.forEach(i=>{b.value.forEach(d=>{i.i==d.id&&(d.quality=i.q,d.value=i.v,d.dbtime=i.t)})}),$.value=X())})},z=f([0]),x=f(""),G=async(e,t,a)=>{var c,l,i,d,y;z.value=[(c=a.node)==null?void 0:c.key],_.chlType=(l=a.node)==null?void 0:l.chlType;function n(v,k){for(const m of v)if(m.children){for(const I of m.children)if(I.key===k)return m.key}return null}const o=await n(h.value,(i=a.node)==null?void 0:i.key);_.chlid=o,_.devId=(d=a.node)==null?void 0:d.key,x.value=(y=a.node)==null?void 0:y.label,g(),q()},Q=e=>{e&&b.value.length>0?q():w.value.close()};oe(()=>_.tagType,e=>{e||g()});const H=({option:e})=>e.key==0?"":e.dev_status!==null?S("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:e.hasOwnProperty("dev_status")&&e.dev_status==1?"#00b42a":e.dev_status==2?"#ff0000":"#ccc"}}):"",X=e=>{const t=new Date,a=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),c=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0");return`${a}-${n}-${o} ${c}:${l}:${i}`},{drawerVisible:Oe,operateType:Re,editingData:Ue,handleAdd:We,handleEdit:Be,checkedRowKeys:C,onBatchDeleted:Ke,onDeleted:je}=Te(b,g),O=e=>{try{return JSON.parse(e),!0}catch{return!1}};return(e,t)=>{const a=Ne,n=ge,o=ye,c=Z,l=ve,i=ke,d=Y,y=qe,v=be,k=ze,m=Ce,I=we;return ce(),ie("div",Ie,[r(I,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:u(()=>[r(i,{align:"center",wrap:"",justify:"start",class:"lt-sm:w-200px"},{default:u(()=>[r(l,null,{default:u(()=>[r(a,null,{default:u(()=>[P("测点类型")]),_:1}),r(n,{filterable:"",clearable:"",placeholder:"请选择",value:s(_).tagType,"onUpdate:value":t[0]||(t[0]=p=>s(_).tagType=p),options:s(re)(s($e))},null,8,["value","options"]),r(o,{clearable:"",value:s(_).fuzzy,"onUpdate:value":[t[1]||(t[1]=p=>s(_).fuzzy=p),J],placeholder:"请输入测点名称或描述",style:{width:"150%"},onKeyup:de(s(g),["enter"])},null,8,["value","onKeyup"]),r(s(ue),{type:"primary",ghost:"",onClick:s(g)},{icon:u(()=>[r(c,{class:pe(["text-icon",{"animate-spin":s(E)}])},null,8,["class"])]),default:u(()=>[P(" 搜索 ")]),_:1},8,["onClick"])]),_:1}),B("div",Ae,[r(s(_e),{checked:N.value,"onUpdate:checked":[t[2]||(t[2]=p=>N.value=p),Q]},{default:u(()=>[P(" 实时刷新 ")]),_:1},8,["checked"]),me(B("span",{class:"font-size-14px color-blank",style:{"font-weight":"600"}}," 刷新时间："+fe($.value),513),[[he,$.value]])])]),_:1})]),"header-extra":u(()=>[r(i,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:u(()=>[r(d,{columns:s(T),"onUpdate:columns":t[3]||(t[3]=p=>K(T)?T.value=p:null)},null,8,["columns"])]),_:1})]),default:u(()=>[r(m,{direction:"horizontal",class:"sm:h-full","default-size":.15,max:.35,min:.1,"resize-trigger-size":6},{1:u(()=>[r(v,{style:{"max-height":"700px"}},{default:u(()=>[r(y,{"block-line":"","default-expand-all":"",data:h.value,"checked-keys":z.value,"expand-on-click":!1,"render-prefix":H,"check-strategy":"child","onUpdate:checkedKeys":G,checkable:""},null,8,["data","checked-keys"])]),_:1})]),2:u(()=>[r(k,{"checked-row-keys":s(C),"onUpdate:checkedRowKeys":t[4]||(t[4]=p=>K(C)?C.value=p:null),columns:s(j),data:s(b),size:"small",loading:s(E),remote:"","row-key":p=>p.id,"flex-height":!0,"scroll-x":"",pagination:s(b).length?s(F):void 0,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1})])}}}),tt=xe(Pe,[["__scopeId","data-v-c1dc70fb"]]);export{tt as default};
