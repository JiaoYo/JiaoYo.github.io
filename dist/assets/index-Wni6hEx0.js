import{_ as ee}from"./table-column-setting.vue_vue_type_script_setup_true_lang-CUOEVEOG.js";import{_ as te}from"./round-search-hnCStK2c.js";import{d as ae,a8 as ne,bl as le,f as r,aF as D,aI as se,bd as T,s as oe,be as ce,bm as E,i as g,ag as ie,bg as W,bh as B,aq as K,a2 as re,a9 as de,o as ue,b as pe,w as p,g as A,h as s,a3 as _e,y as me,B as he,aa as ge,e as j,D as fe,x as ye,bn as ve,t as ke,ab as F,a4 as be,A as we,ad as Te,E as xe,aC as Se,ae as De,X as $e,I as Ne}from"./index-C4Xe5hxh.js";import{a as Ce,p as qe}from"./gather-CjQLIZz1.js";import{_ as ze}from"./InputGroupLabel-CkZYP9r6.js";import{_ as Ie}from"./Tree-BfoTj944.js";import{_ as Pe}from"./Split-pNN5zkJd.js";const Ee={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ae={class:"flex flex-col"},Le=ae({name:"configsetting_realtimedata_devicedata",__name:"index",setup(Oe){const{columns:M,columnChecks:$,data:b,getData:f,loading:L,mobilePagination:J,searchParams:_,resetSearchParams:Re}=ne({apiFn:le,apiParams:{page:1,pageSize:200,limit:200,tagType:null,chlid:null,devId:null,fuzzy:"",chlType:0,_t:new Date().getTime()},immediate:!1,showTotal:!0,columns:()=>[{type:"selection",align:"center",width:48},{key:"id",title:"序号",align:"center",width:80},{key:"devId",title:"设备名称",align:"center",width:100,render:e=>{var t;return r("span",null,[(t=O.value.find(a=>a.id==e.devId))==null?void 0:t.devName])}},{key:"tagName",title:"测点名称",align:"center"},{key:"tagDesc",title:"物模型标识(测点描述)",align:"center"},{key:"value",title:"测点值",align:"center",width:140,render:e=>{var t;return D("span",{style:{color:e.quality===100?"red":e.quality==49?"#409eff":e.quality==50?"#909399":"#67c23a"}},parseFloat((t=e.value)==null?void 0:t.toFixed(6))||e.value)}},{key:"quality",title:"质量",align:"center",width:120,render:e=>(e.quality==100||e.quality==49||e.quality==0)&&D(se,{style:{background:e.quality===100?"red":e.quality==49?"#409eff":"#67c23a",color:"#fff"}},e.quality==0?"Good":e.quality==49?"人工置数":e.quality==100?"Bad":"")},{key:"dbtime",title:"采集时间",align:"center",minWidth:120,render:e=>{var t,a;return D("span",{title:T(0,+e.dbtime)},e.dbtime?(a=T(2,+e.dbtime))==null?void 0:a.substring(10,(t=T(2,+e.dbtime))==null?void 0:t.length):"")}},{key:"tagType",title:"测点类型",align:"center",width:140,render:e=>r("span",null,[Ce[e.tagType]])},{key:"objAddr",title:"地址",align:"center",width:140}]}),V=e=>{e===""&&f()};oe(async()=>{await G(),z(),Q()}),ce(()=>{var e;(e=N.value)==null||e.close(),x.value.close(),E({startTime:"",endTime:""})});const m=g(),O=g([]),G=async()=>{const{data:e,error:t}=await ie();if((e==null?void 0:e.length)==0)return;function a(n){return n.map(o=>{var c;return{label:o.chlName,key:o.id,dev_status:null,children:(c=o.devicePojoList)!=null&&c.length?o.devicePojoList.map(l=>(O.value.push(l),{label:l.devName,dev_status:null,chlType:o.chlType,key:l.id})):[]}})}m.value=a(e),_.chlid=m.value[0].key,_.devId=m.value[0].children[0].key,I.value=[m.value[0].children[0].key],S.value=m.value[0].children[0].label,U(),f()},N=g(null),Q=()=>{var o;(o=N.value)==null||o.close();const e=new W;let t="";e.appendAsciiStr("$Link+Qi^123987WWg#getchlstatus"),t=e.end();const a=new Date().getTime(),n=new B(K.replace("https","wss")+`/ChannelStatusWebsocket/getchlstatus/${t}/${a}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});N.value=n,n.connect(),n.onclose(()=>{}),n.onerror(()=>{}),n.onopen(()=>{}),n.onmessage(c=>{let l=[];console.log(c,"通道状态websocket接受数据"),R(c.data)&&(l=JSON.parse(c.data).data,m.value.forEach(i=>{l.forEach(d=>{var y;d.chl_id==i.key&&(i.dev_status=d.chl_status),d.chl_id==1&&(i.dev_status=1),(y=i.children)==null||y.forEach(h=>{var k;(k=d.devs)==null||k.forEach(v=>{v.dev_id==h.key&&(h.dev_status=v.dev_status),v.dev_id==1&&(h.dev_status=1)})})})}))})},x=g(null),C=g(""),q=g(!0),z=()=>{var o;(o=x.value)==null||o.close(),q.value=!0;const e=new W;let t="";const a=new Date().getTime();e.appendAsciiStr("$Link+Qi^123987WWg#"+a),t=e.end();const n=new B(K.replace("https","wss")+`/realTimeDataWebsocket/${S.value}/${t}/${a}`,{maxReconnectAttempts:3,heartbeatInterval:1e3*30});x.value=n,n.connect(),n.onclose(()=>{}),n.onerror(()=>{}),n.onopen(()=>{}),n.onmessage(c=>{let l=[];console.log(c,"实时数据websocket接受数据"),R(c.data)&&(l=JSON.parse(c.data).data[S.value],l==null||l.forEach(i=>{b.value.forEach(d=>{i.i==d.id&&(d.quality=i.q,d.value=i.v,d.dbtime=i.t)})}),C.value=Z())})},I=g([]),S=g(""),H=async(e,t,a)=>{var c,l,i,d,y,h;I.value=[(c=a.node)==null?void 0:c.key],((l=a.node)==null?void 0:l.label)=="系统设备"?U():E({startTime:"",endTime:""}),_.chlType=(i=a.node)==null?void 0:i.chlType;function n(k,v){for(const w of k)if(w.children){for(const u of w.children)if(u.key===v)return w.key}return null}const o=await n(m.value,(d=a.node)==null?void 0:d.key);_.chlid=o,_.devId=(y=a.node)==null?void 0:y.key,S.value=(h=a.node)==null?void 0:h.label,f(),z()},X=e=>{e&&b.value.length>0?z():x.value.close()};re(()=>_.tagType,e=>{e||f()});const Y=({option:e})=>e.key==0?"":e.dev_status!==null?D("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:e.hasOwnProperty("dev_status")&&e.dev_status==1?"#00b42a":e.dev_status==2?"#ff0000":"#ccc"}}):"",Z=e=>{const t=new Date,a=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),c=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0");return`${a}-${n}-${o} ${c}:${l}:${i}`},{drawerVisible:Ue,operateType:We,editingData:Be,handleAdd:Ke,handleEdit:je,checkedRowKeys:P,onBatchDeleted:Fe,onDeleted:Me}=de(b,f),R=e=>{try{return JSON.parse(e),!0}catch{return!1}},U=async()=>{E({startTime:T(1,new Date().getTime()-18e5),endTime:T(1,new Date().getTime())})};return(e,t)=>{const a=ze,n=be,o=we,c=te,l=Te,i=xe,d=ee,y=Ie,h=Se,k=De,v=Pe,w=$e;return ue(),pe("div",Ee,[r(w,{bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{header:p(()=>[r(i,{align:"center",wrap:"",justify:"start",class:"lt-sm:w-200px"},{default:p(()=>[r(l,null,{default:p(()=>[r(a,null,{default:p(()=>[A("测点类型")]),_:1}),r(n,{filterable:"",clearable:"",placeholder:"请选择",value:s(_).tagType,"onUpdate:value":t[0]||(t[0]=u=>s(_).tagType=u),options:s(_e)(s(qe))},null,8,["value","options"]),r(o,{clearable:"",value:s(_).fuzzy,"onUpdate:value":[t[1]||(t[1]=u=>s(_).fuzzy=u),V],placeholder:"请输入测点名称或描述",style:{width:"150%"},onKeyup:me(s(f),["enter"])},null,8,["value","onKeyup"]),r(s(he),{type:"primary",ghost:"",onClick:s(f)},{icon:p(()=>[r(c,{class:ge(["text-icon",{"animate-spin":s(L)}])},null,8,["class"])]),default:p(()=>[A(" 搜索 ")]),_:1},8,["onClick"])]),_:1}),j("div",Ae,[r(s(fe),{checked:q.value,"onUpdate:checked":[t[2]||(t[2]=u=>q.value=u),X]},{default:p(()=>[A(" 实时刷新 ")]),_:1},8,["checked"]),ye(j("span",{class:"font-size-14px color-blank",style:{"font-weight":"600"}}," 刷新时间："+ke(C.value),513),[[ve,C.value]])])]),_:1})]),"header-extra":p(()=>[r(i,{align:"center",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:p(()=>[r(d,{columns:s($),"onUpdate:columns":t[3]||(t[3]=u=>F($)?$.value=u:null)},null,8,["columns"])]),_:1})]),default:p(()=>[r(v,{direction:"horizontal",class:"sm:h-full","default-size":.15,max:.35,min:.1,"resize-trigger-size":6},{1:p(()=>[r(h,{style:{"max-height":"700px"}},{default:p(()=>[r(y,{"block-line":"","default-expand-all":"",data:m.value,"checked-keys":I.value,"expand-on-click":!1,"render-prefix":Y,"check-strategy":"child","onUpdate:checkedKeys":H,checkable:""},null,8,["data","checked-keys"])]),_:1})]),2:p(()=>[r(k,{"checked-row-keys":s(P),"onUpdate:checkedRowKeys":t[4]||(t[4]=u=>F(P)?P.value=u:null),columns:s(M),data:s(b),size:"small",loading:s(L),remote:"","row-key":u=>u.id,"flex-height":!0,"scroll-x":"",pagination:s(b).length?s(J):void 0,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","loading","row-key","pagination"])]),_:1})]),_:1})])}}}),Ze=Ne(Le,[["__scopeId","data-v-b44ac740"]]);export{Ze as default};
